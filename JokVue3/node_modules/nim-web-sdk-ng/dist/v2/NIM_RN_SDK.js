/**
 * 
 *   Version: 10.7.0
 * 
 *   Git Hash: 1665c89d5f347a8fd51942c2432cf76f4cdb6b3a
 * 
 *   Created At: 2024/12/27 16:21:00
 * 
 *   Target: NIM_RN_SDK.js
 *   
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react-native")):"function"==typeof define&&define.amd?define(["exports","react-native"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).NIM={},e.reactNative)}(this,(function(e,t){"use strict";var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e){var t={exports:{}};return e(t,t.exports),t.exports}var n,a,check=function(e){return e&&e.Math==Math&&e},i=check("object"==typeof globalThis&&globalThis)||check("object"==typeof window&&window)||check("object"==typeof self&&self)||check("object"==typeof r&&r)||function(){return this}()||Function("return this")(),fails=function(e){try{return!!e()}catch(e){return!0}},o=!fails((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),s=Function.prototype,c=s.apply,l=s.call,d="object"==typeof Reflect&&Reflect.apply||(o?l.bind(c):function(){return l.apply(c,arguments)}),u=Function.prototype,p=u.bind,m=u.call,h=o&&p.bind(m,m),g=o?function(e){return e&&h(e)}:function(e){return e&&function(){return m.apply(e,arguments)}},isCallable=function(e){return"function"==typeof e},v=!fails((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),f=Function.prototype.call,y=o?f.bind(f):function(){return f.apply(f,arguments)},M={}.propertyIsEnumerable,I=Object.getOwnPropertyDescriptor,S={f:I&&!M.call({1:2},1)?function propertyIsEnumerable(e){var t=I(this,e);return!!t&&t.enumerable}:M},createPropertyDescriptor=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},T=g({}.toString),C=g("".slice),classofRaw=function(e){return C(T(e),8,-1)},b=Object,E=g("".split),R=fails((function(){return!b("z").propertyIsEnumerable(0)}))?function(e){return"String"==classofRaw(e)?E(e,""):b(e)}:b,isNullOrUndefined=function(e){return null==e},k=TypeError,requireObjectCoercible=function(e){if(isNullOrUndefined(e))throw k("Can't call method on "+e);return e},toIndexedObject=function(e){return R(requireObjectCoercible(e))},w="object"==typeof document&&document.all,A=void 0===w&&void 0!==w?function(e){return"object"==typeof e?null!==e:isCallable(e)||e===w}:function(e){return"object"==typeof e?null!==e:isCallable(e)},N={},aFunction=function(e){return isCallable(e)?e:void 0},getBuiltIn=function(e,t){return arguments.length<2?aFunction(N[e])||aFunction(i[e]):N[e]&&N[e][t]||i[e]&&i[e][t]},x=g({}.isPrototypeOf),O=getBuiltIn("navigator","userAgent")||"",P=i.process,L=i.Deno,V=P&&P.versions||L&&L.version,U=V&&V.v8;U&&(a=(n=U.split("."))[0]>0&&n[0]<4?1:+(n[0]+n[1])),!a&&O&&(!(n=O.match(/Edge\/(\d+)/))||n[1]>=74)&&(n=O.match(/Chrome\/(\d+)/))&&(a=+n[1]);var D=a,q=!!Object.getOwnPropertySymbols&&!fails((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&D&&D<41})),B=q&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,G=Object,H=B?function(e){return"symbol"==typeof e}:function(e){var t=getBuiltIn("Symbol");return isCallable(t)&&x(t.prototype,G(e))},j=String,tryToString=function(e){try{return j(e)}catch(e){return"Object"}},$=TypeError,aCallable=function(e){if(isCallable(e))return e;throw $(tryToString(e)+" is not a function")},getMethod=function(e,t){var r=e[t];return isNullOrUndefined(r)?void 0:aCallable(r)},z=TypeError,W=Object.defineProperty,K="__core-js_shared__",Y=i[K]||function(e,t){try{W(i,e,{value:t,configurable:!0,writable:!0})}catch(r){i[e]=t}return t}(K,{}),Q=createCommonjsModule((function(e){(e.exports=function(e,t){return Y[e]||(Y[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.25.0",mode:"pure",copyright:"Â© 2014-2022 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.25.0/LICENSE",source:"https://github.com/zloirock/core-js"})})),J=Object,toObject=function(e){return J(requireObjectCoercible(e))},X=g({}.hasOwnProperty),Z=Object.hasOwn||function hasOwn(e,t){return X(toObject(e),t)},ee=0,te=Math.random(),re=g(1..toString),uid=function(e){return"Symbol("+(void 0===e?"":e)+")_"+re(++ee+te,36)},ne=Q("wks"),ae=i.Symbol,ie=ae&&ae.for,oe=B?ae:ae&&ae.withoutSetter||uid,wellKnownSymbol=function(e){if(!Z(ne,e)||!q&&"string"!=typeof ne[e]){var t="Symbol."+e;q&&Z(ae,e)?ne[e]=ae[e]:ne[e]=B&&ie?ie(t):oe(t)}return ne[e]},se=TypeError,ce=wellKnownSymbol("toPrimitive"),toPrimitive=function(e,t){if(!A(e)||H(e))return e;var r,n=getMethod(e,ce);if(n){if(void 0===t&&(t="default"),r=y(n,e,t),!A(r)||H(r))return r;throw se("Can't convert object to primitive value")}return void 0===t&&(t="number"),function(e,t){var r,n;if("string"===t&&isCallable(r=e.toString)&&!A(n=y(r,e)))return n;if(isCallable(r=e.valueOf)&&!A(n=y(r,e)))return n;if("string"!==t&&isCallable(r=e.toString)&&!A(n=y(r,e)))return n;throw z("Can't convert object to primitive value")}(e,t)},toPropertyKey=function(e){var t=toPrimitive(e,"string");return H(t)?t:t+""},le=i.document,de=A(le)&&A(le.createElement),documentCreateElement=function(e){return de?le.createElement(e):{}},ue=!v&&!fails((function(){return 7!=Object.defineProperty(documentCreateElement("div"),"a",{get:function(){return 7}}).a})),pe=Object.getOwnPropertyDescriptor,me={f:v?pe:function getOwnPropertyDescriptor(e,t){if(e=toIndexedObject(e),t=toPropertyKey(t),ue)try{return pe(e,t)}catch(e){}if(Z(e,t))return createPropertyDescriptor(!y(S.f,e,t),e[t])}},he=/#|\.prototype\./,isForced=function(e,t){var r=ve[ge(e)];return r==ye||r!=fe&&(isCallable(t)?fails(t):!!t)},ge=isForced.normalize=function(e){return String(e).replace(he,".").toLowerCase()},ve=isForced.data={},fe=isForced.NATIVE="N",ye=isForced.POLYFILL="P",_e=isForced,Me=g(g.bind),functionBindContext=function(e,t){return aCallable(e),void 0===t?e:o?Me(e,t):function(){return e.apply(t,arguments)}},Ie=v&&fails((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),Se=String,Te=TypeError,anObject=function(e){if(A(e))return e;throw Te(Se(e)+" is not an object")},Ce=TypeError,be=Object.defineProperty,Ee=Object.getOwnPropertyDescriptor,Re="enumerable",ke="configurable",we="writable",Ae={f:v?Ie?function defineProperty(e,t,r){if(anObject(e),t=toPropertyKey(t),anObject(r),"function"==typeof e&&"prototype"===t&&"value"in r&&we in r&&!r.writable){var n=Ee(e,t);n&&n.writable&&(e[t]=r.value,r={configurable:ke in r?r.configurable:n.configurable,enumerable:Re in r?r.enumerable:n.enumerable,writable:!1})}return be(e,t,r)}:be:function defineProperty(e,t,r){if(anObject(e),t=toPropertyKey(t),anObject(r),ue)try{return be(e,t,r)}catch(e){}if("get"in r||"set"in r)throw Ce("Accessors not supported");return"value"in r&&(e[t]=r.value),e}},Ne=v?function(e,t,r){return Ae.f(e,t,createPropertyDescriptor(1,r))}:function(e,t,r){return e[t]=r,e},xe=me.f,wrapConstructor=function(e){var Wrapper=function(t,r,n){if(this instanceof Wrapper){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,r)}return new e(t,r,n)}return d(e,this,arguments)};return Wrapper.prototype=e.prototype,Wrapper},_export=function(e,t){var r,n,a,o,s,c,l,d,u=e.target,p=e.global,m=e.stat,h=e.proto,v=p?i:m?i[u]:(i[u]||{}).prototype,f=p?N:N[u]||Ne(N,u,{})[u],y=f.prototype;for(a in t)r=!_e(p?a:u+(m?".":"#")+a,e.forced)&&v&&Z(v,a),s=f[a],r&&(c=e.dontCallGetSet?(d=xe(v,a))&&d.value:v[a]),o=r&&c?c:t[a],r&&typeof s==typeof o||(l=e.bind&&r?functionBindContext(o,i):e.wrap&&r?wrapConstructor(o):h&&isCallable(o)?g(o):o,(e.sham||o&&o.sham||s&&s.sham)&&Ne(l,"sham",!0),Ne(f,a,l),h&&(Z(N,n=u+"Prototype")||Ne(N,n,{}),Ne(N[n],a,o),e.real&&y&&!y[a]&&Ne(y,a,o)))},Oe=Ae.f;_export({target:"Object",stat:!0,forced:Object.defineProperty!==Oe,sham:!v},{defineProperty:Oe});var Pe,Le=createCommonjsModule((function(e){var t=N.Object,r=e.exports=function defineProperty(e,r,n){return t.defineProperty(e,r,n)};t.defineProperty.sham&&(r.sham=!0)})),Ve=Le,Ue=getDefaultExportFromCjs(createCommonjsModule((function(e){function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Ve(e,n.key,n)}}e.exports=function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Ve(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports.default=e.exports}))),De=getDefaultExportFromCjs(createCommonjsModule((function(e){e.exports=function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e.exports.__esModule=!0,e.exports.default=e.exports}))),qe=Math.ceil,Be=Math.floor,Fe=Math.trunc||function trunc(e){var t=+e;return(t>0?Be:qe)(t)},toIntegerOrInfinity=function(e){var t=+e;return t!=t||0===t?0:Fe(t)},Ge=Math.max,He=Math.min,toAbsoluteIndex=function(e,t){var r=toIntegerOrInfinity(e);return r<0?Ge(r+t,0):He(r,t)},je=Math.min,toLength=function(e){return e>0?je(toIntegerOrInfinity(e),9007199254740991):0},lengthOfArrayLike=function(e){return toLength(e.length)},createMethod$5=function(e){return function(t,r,n){var a,i=toIndexedObject(t),o=lengthOfArrayLike(i),s=toAbsoluteIndex(n,o);if(e&&r!=r){for(;o>s;)if((a=i[s++])!=a)return!0}else for(;o>s;s++)if((e||s in i)&&i[s]===r)return e||s||0;return!e&&-1}},$e={includes:createMethod$5(!0),indexOf:createMethod$5(!1)},ze={},We=$e.indexOf,Ke=g([].push),objectKeysInternal=function(e,t){var r,n=toIndexedObject(e),a=0,i=[];for(r in n)!Z(ze,r)&&Z(n,r)&&Ke(i,r);for(;t.length>a;)Z(n,r=t[a++])&&(~We(i,r)||Ke(i,r));return i},Ye=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Qe=Object.keys||function keys(e){return objectKeysInternal(e,Ye)},Je=v&&!Ie?Object.defineProperties:function defineProperties(e,t){anObject(e);for(var r,n=toIndexedObject(t),a=Qe(t),i=a.length,o=0;i>o;)Ae.f(e,r=a[o++],n[r]);return e},Xe={f:Je},Ze=getBuiltIn("document","documentElement"),et=Q("keys"),sharedKey=function(e){return et[e]||(et[e]=uid(e))},rt=sharedKey("IE_PROTO"),EmptyConstructor=function(){},scriptTag=function(e){return"<script>"+e+"</"+"script>"},NullProtoObjectViaActiveX=function(e){e.write(scriptTag("")),e.close();var t=e.parentWindow.Object;return e=null,t},NullProtoObject=function(){try{Pe=new ActiveXObject("htmlfile")}catch(e){}var e,t;NullProtoObject="undefined"!=typeof document?document.domain&&Pe?NullProtoObjectViaActiveX(Pe):((t=documentCreateElement("iframe")).style.display="none",Ze.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(scriptTag("document.F=Object")),e.close(),e.F):NullProtoObjectViaActiveX(Pe);for(var r=Ye.length;r--;)delete NullProtoObject.prototype[Ye[r]];return NullProtoObject()};ze[rt]=!0;var nt=Object.create||function create(e,t){var r;return null!==e?(EmptyConstructor.prototype=anObject(e),r=new EmptyConstructor,EmptyConstructor.prototype=null,r[rt]=e):r=NullProtoObject(),void 0===t?r:Xe.f(r,t)};_export({target:"Object",stat:!0,sham:!v},{create:nt});var at=N.Object,it=function create(e,t){return at.create(e,t)},ot=String,st=TypeError,ct=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{(e=g(Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set))(r,[]),t=r instanceof Array}catch(e){}return function setPrototypeOf(r,n){return anObject(r),function(e){if("object"==typeof e||isCallable(e))return e;throw st("Can't set "+ot(e)+" as a prototype")}(n),t?e(r,n):r.__proto__=n,r}}():void 0);_export({target:"Object",stat:!0},{setPrototypeOf:ct});var lt=N.Object.setPrototypeOf,dt=g([].slice),ut=Function,pt=g([].concat),mt=g([].join),ht={},construct$8=function(e,t,r){if(!Z(ht,t)){for(var n=[],a=0;a<t;a++)n[a]="a["+a+"]";ht[t]=ut("C,a","return new C("+mt(n,",")+")")}return ht[t](e,r)},gt=o?ut.bind:function bind(e){var t=aCallable(this),r=t.prototype,n=dt(arguments,1),a=function bound(){var r=pt(n,dt(arguments));return this instanceof a?construct$8(t,r.length,r):t.apply(e,r)};return A(r)&&(a.prototype=r),a};_export({target:"Function",proto:!0,forced:Function.bind!==gt},{bind:gt});var entryVirtual=function(e){return N[e+"Prototype"]},vt=entryVirtual("Function").bind,ft=Function.prototype,bind$1=function(e){var t=e.bind;return e===ft||x(ft,e)&&t===ft.bind?vt:t},yt=createCommonjsModule((function(e){function _setPrototypeOf(t,r){var n;return e.exports=_setPrototypeOf=lt?bind$1(n=lt).call(n):function _setPrototypeOf(e,t){return e.__proto__=t,e},e.exports.__esModule=!0,e.exports.default=e.exports,_setPrototypeOf(t,r)}e.exports=_setPrototypeOf,e.exports.__esModule=!0,e.exports.default=e.exports})),_t=getDefaultExportFromCjs(createCommonjsModule((function(e){e.exports=function _inheritsLoose(e,t){e.prototype=it(t.prototype),e.prototype.constructor=e,yt(e,t)},e.exports.__esModule=!0,e.exports.default=e.exports})));_export({target:"Number",stat:!0,nonConfigurable:!0,nonWritable:!0},{MAX_SAFE_INTEGER:9007199254740991});var Mt=9007199254740991,It={f:Object.getOwnPropertySymbols},St=Object.assign,Tt=Object.defineProperty,Ct=g([].concat),bt=!St||fails((function(){if(v&&1!==St({b:1},St(Tt({},"a",{enumerable:!0,get:function(){Tt(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},r=Symbol(),n="abcdefghijklmnopqrst";return e[r]=7,n.split("").forEach((function(e){t[e]=e})),7!=St({},e)[r]||Qe(St({},t)).join("")!=n}))?function assign(e,t){for(var r=toObject(e),n=arguments.length,a=1,i=It.f,o=S.f;n>a;)for(var s,c=R(arguments[a++]),l=i?Ct(Qe(c),i(c)):Qe(c),d=l.length,u=0;d>u;)s=l[u++],v&&!y(o,c,s)||(r[s]=c[s]);return r}:St;_export({target:"Object",stat:!0,arity:2,forced:Object.assign!==bt},{assign:bt});var Et=N.Object.assign,Rt=fails((function(){Qe(1)}));_export({target:"Object",stat:!0,forced:Rt},{keys:function keys(e){return Qe(toObject(e))}});var kt,wt,At,Nt=N.Object.keys,xt={},Ot=i.WeakMap,Pt=isCallable(Ot)&&/native code/.test(String(Ot)),Lt="Object already initialized",Vt=i.TypeError,Ut=i.WeakMap;if(Pt||Y.state){var Dt=Y.state||(Y.state=new Ut),qt=g(Dt.get),Bt=g(Dt.has),Ft=g(Dt.set);kt=function(e,t){if(Bt(Dt,e))throw Vt(Lt);return t.facade=e,Ft(Dt,e,t),t},wt=function(e){return qt(Dt,e)||{}},At=function(e){return Bt(Dt,e)}}else{var Gt=sharedKey("state");ze[Gt]=!0,kt=function(e,t){if(Z(e,Gt))throw Vt(Lt);return t.facade=e,Ne(e,Gt,t),t},wt=function(e){return Z(e,Gt)?e[Gt]:{}},At=function(e){return Z(e,Gt)}}var Ht,jt,$t,zt={set:kt,get:wt,has:At,enforce:function(e){return At(e)?wt(e):kt(e,{})},getterFor:function(e){return function(t){var r;if(!A(t)||(r=wt(t)).type!==e)throw Vt("Incompatible receiver, "+e+" required");return r}}},Wt=Function.prototype,Kt=v&&Object.getOwnPropertyDescriptor,Yt=Z(Wt,"name"),Qt={EXISTS:Yt,PROPER:Yt&&"something"===function something(){}.name,CONFIGURABLE:Yt&&(!v||v&&Kt(Wt,"name").configurable)},Jt=!fails((function(){function F(){}return F.prototype.constructor=null,Object.getPrototypeOf(new F)!==F.prototype})),Xt=sharedKey("IE_PROTO"),Zt=Object,er=Zt.prototype,tr=Jt?Zt.getPrototypeOf:function(e){var t=toObject(e);if(Z(t,Xt))return t[Xt];var r=t.constructor;return isCallable(r)&&t instanceof r?r.prototype:t instanceof Zt?er:null},defineBuiltIn=function(e,t,r,n){return n&&n.enumerable?e[t]=r:Ne(e,t,r),e},rr=wellKnownSymbol("iterator"),nr=!1;[].keys&&("next"in($t=[].keys())?(jt=tr(tr($t)))!==Object.prototype&&(Ht=jt):nr=!0);var ar=!A(Ht)||fails((function(){var e={};return Ht[rr].call(e)!==e}));Ht=ar?{}:nt(Ht),isCallable(Ht[rr])||defineBuiltIn(Ht,rr,(function(){return this}));var ir={IteratorPrototype:Ht,BUGGY_SAFARI_ITERATORS:nr},or={};or[wellKnownSymbol("toStringTag")]="z";var sr="[object z]"===String(or),cr=wellKnownSymbol("toStringTag"),lr=Object,dr="Arguments"==classofRaw(function(){return arguments}()),ur=sr?classofRaw:function(e){var t,r,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=lr(e),cr))?r:dr?classofRaw(t):"Object"==(n=classofRaw(t))&&isCallable(t.callee)?"Arguments":n},pr=sr?{}.toString:function toString(){return"[object "+ur(this)+"]"},mr=Ae.f,hr=wellKnownSymbol("toStringTag"),setToStringTag=function(e,t,r,n){if(e){var a=r?e:e.prototype;Z(a,hr)||mr(a,hr,{configurable:!0,value:t}),n&&!sr&&Ne(a,"toString",pr)}},gr=ir.IteratorPrototype,returnThis$1=function(){return this},vr=Qt.PROPER,fr=ir.BUGGY_SAFARI_ITERATORS,yr=wellKnownSymbol("iterator"),_r="keys",Mr="values",Ir="entries",returnThis=function(){return this},iteratorDefine=function(e,t,r,n,a,i,o){!function(e,t,r,n){var a=t+" Iterator";e.prototype=nt(gr,{next:createPropertyDescriptor(+!n,r)}),setToStringTag(e,a,!1,!0),xt[a]=returnThis$1}(r,t,n);var s,c,l,getIterationMethod=function(e){if(e===a&&h)return h;if(!fr&&e in p)return p[e];switch(e){case _r:return function keys(){return new r(this,e)};case Mr:return function values(){return new r(this,e)};case Ir:return function entries(){return new r(this,e)}}return function(){return new r(this)}},d=t+" Iterator",u=!1,p=e.prototype,m=p[yr]||p["@@iterator"]||a&&p[a],h=!fr&&m||getIterationMethod(a),g="Array"==t&&p.entries||m;if(g&&(s=tr(g.call(new e)))!==Object.prototype&&s.next&&(setToStringTag(s,d,!0,!0),xt[d]=returnThis),vr&&a==Mr&&m&&m.name!==Mr&&(u=!0,h=function values(){return y(m,this)}),a)if(c={values:getIterationMethod(Mr),keys:i?h:getIterationMethod(_r),entries:getIterationMethod(Ir)},o)for(l in c)(fr||u||!(l in p))&&defineBuiltIn(p,l,c[l]);else _export({target:t,proto:!0,forced:fr||u},c);return o&&p[yr]!==h&&defineBuiltIn(p,yr,h,{name:a}),xt[t]=h,c};Ae.f;var Sr="Array Iterator",Tr=zt.set,Cr=zt.getterFor(Sr);iteratorDefine(Array,"Array",(function(e,t){Tr(this,{type:Sr,target:toIndexedObject(e),index:0,kind:t})}),(function(){var e=Cr(this),t=e.target,r=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==r?{value:n,done:!1}:"values"==r?{value:t[n],done:!1}:{value:[n,t[n]],done:!1}}),"values"),xt.Arguments=xt.Array;var br=wellKnownSymbol("toStringTag");for(var Er in{CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0}){var Rr=i[Er],kr=Rr&&Rr.prototype;kr&&ur(kr)!==br&&Ne(kr,br,Er),xt[Er]=xt.Array}var wr=Array.isArray||function isArray(e){return"Array"==classofRaw(e)},Ar=g(Function.toString);isCallable(Y.inspectSource)||(Y.inspectSource=function(e){return Ar(e)});var Nr=Y.inspectSource,noop=function(){},xr=[],Or=getBuiltIn("Reflect","construct"),Pr=/^\s*(?:class|function)\b/,Lr=g(Pr.exec),Vr=!Pr.exec(noop),Ur=function isConstructor(e){if(!isCallable(e))return!1;try{return Or(noop,xr,e),!0}catch(e){return!1}},Dr=function isConstructor(e){if(!isCallable(e))return!1;switch(ur(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return Vr||!!Lr(Pr,Nr(e))}catch(e){return!0}};Dr.sham=!0;var qr=!Or||fails((function(){var e;return Ur(Ur.call)||!Ur(Object)||!Ur((function(){e=!0}))||e}))?Dr:Ur,Br=wellKnownSymbol("species"),Fr=Array,arraySpeciesCreate=function(e,t){return new(function(e){var t;return wr(e)&&(t=e.constructor,(qr(t)&&(t===Fr||wr(t.prototype))||A(t)&&null===(t=t[Br]))&&(t=void 0)),void 0===t?Fr:t}(e))(0===t?0:t)},Gr=g([].push),createMethod$4=function(e){var t=1==e,r=2==e,n=3==e,a=4==e,i=6==e,o=7==e,s=5==e||i;return function(c,l,d,u){for(var p,m,h=toObject(c),g=R(h),v=functionBindContext(l,d),f=lengthOfArrayLike(g),y=0,M=u||arraySpeciesCreate,I=t?M(c,f):r||o?M(c,0):void 0;f>y;y++)if((s||y in g)&&(m=v(p=g[y],y,h),e))if(t)I[y]=m;else if(m)switch(e){case 3:return!0;case 5:return p;case 6:return y;case 2:Gr(I,p)}else switch(e){case 4:return!1;case 7:Gr(I,p)}return i?-1:n||a?a:I}},Hr={forEach:createMethod$4(0),map:createMethod$4(1),filter:createMethod$4(2),some:createMethod$4(3),every:createMethod$4(4),find:createMethod$4(5),findIndex:createMethod$4(6),filterReject:createMethod$4(7)},arrayMethodIsStrict=function(e,t){var r=[][e];return!!r&&fails((function(){r.call(null,t||function(){return 1},1)}))},jr=Hr.forEach,$r=arrayMethodIsStrict("forEach")?[].forEach:function forEach(e){return jr(this,e,arguments.length>1?arguments[1]:void 0)};_export({target:"Array",proto:!0,forced:[].forEach!=$r},{forEach:$r});var zr=entryVirtual("Array").forEach,Wr=Array.prototype,Kr={DOMTokenList:!0,NodeList:!0},forEach$1=function(e){var t=e.forEach;return e===Wr||x(Wr,e)&&t===Wr.forEach||Z(Kr,ur(e))?zr:t},Yr=Hr.findIndex,Qr="findIndex",Jr=!0;Qr in[]&&Array(1).findIndex((function(){Jr=!1})),_export({target:"Array",proto:!0,forced:Jr},{findIndex:function findIndex(e){return Yr(this,e,arguments.length>1?arguments[1]:void 0)}});var Xr=entryVirtual("Array").findIndex,Zr=Array.prototype,findIndex$1=function(e){var t=e.findIndex;return e===Zr||x(Zr,e)&&t===Zr.findIndex?Xr:t},en=TypeError,tn=Object.getOwnPropertyDescriptor,rn=v&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(e){return e instanceof TypeError}}()?function(e,t){if(wr(e)&&!tn(e,"length").writable)throw en("Cannot set read only .length");return e.length=t}:function(e,t){return e.length=t},nn=TypeError,doesNotExceedSafeInteger=function(e){if(e>9007199254740991)throw nn("Maximum allowed index exceeded");return e},createProperty=function(e,t,r){var n=toPropertyKey(t);n in e?Ae.f(e,n,createPropertyDescriptor(0,r)):e[n]=r},an=TypeError,deletePropertyOrThrow=function(e,t){if(!delete e[t])throw an("Cannot delete property "+tryToString(t)+" of "+tryToString(e))},sn=wellKnownSymbol("species"),arrayMethodHasSpeciesSupport=function(e){return D>=51||!fails((function(){var t=[];return(t.constructor={})[sn]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},cn=arrayMethodHasSpeciesSupport("splice"),ln=Math.max,dn=Math.min;_export({target:"Array",proto:!0,forced:!cn},{splice:function splice(e,t){var r,n,a,i,o,s,c=toObject(this),l=lengthOfArrayLike(c),d=toAbsoluteIndex(e,l),u=arguments.length;for(0===u?r=n=0:1===u?(r=0,n=l-d):(r=u-2,n=dn(ln(toIntegerOrInfinity(t),0),l-d)),doesNotExceedSafeInteger(l+r-n),a=arraySpeciesCreate(c,n),i=0;i<n;i++)(o=d+i)in c&&createProperty(a,i,c[o]);if(a.length=n,r<n){for(i=d;i<l-n;i++)s=i+r,(o=i+n)in c?c[s]=c[o]:deletePropertyOrThrow(c,s);for(i=l;i>l-n+r;i--)deletePropertyOrThrow(c,i-1)}else if(r>n)for(i=l-n;i>d;i--)s=i+r-1,(o=i+n-1)in c?c[s]=c[o]:deletePropertyOrThrow(c,s);for(i=0;i<r;i++)c[i+d]=arguments[i+2];return rn(c,l-n+r),a}});var un=entryVirtual("Array").splice,pn=Array.prototype,splice=function(e){var t=e.splice;return e===pn||x(pn,e)&&t===pn.splice?un:t},mn=getBuiltIn("JSON","stringify"),hn=g(/./.exec),gn=g("".charAt),vn=g("".charCodeAt),fn=g("".replace),yn=g(1..toString),_n=/[\uD800-\uDFFF]/g,Mn=/^[\uD800-\uDBFF]$/,In=/^[\uDC00-\uDFFF]$/,Sn=!q||fails((function(){var e=getBuiltIn("Symbol")();return"[null]"!=mn([e])||"{}"!=mn({a:e})||"{}"!=mn(Object(e))})),Tn=fails((function(){return'"\\udf06\\ud834"'!==mn("\udf06\ud834")||'"\\udead"'!==mn("\udead")})),stringifyWithSymbolsFix=function(e,t){var r=dt(arguments),n=t;if((A(t)||void 0!==e)&&!H(e))return wr(t)||(t=function(e,t){if(isCallable(n)&&(t=y(n,this,e,t)),!H(t))return t}),r[1]=t,d(mn,null,r)},fixIllFormed=function(e,t,r){var n=gn(r,t-1),a=gn(r,t+1);return hn(Mn,e)&&!hn(In,a)||hn(In,e)&&!hn(Mn,n)?"\\u"+yn(vn(e,0),16):e};mn&&_export({target:"JSON",stat:!0,arity:3,forced:Sn||Tn},{stringify:function stringify(e,t,r){var n=dt(arguments),a=d(Sn?stringifyWithSymbolsFix:mn,null,n);return Tn&&"string"==typeof a?fn(a,_n,fixIllFormed):a}}),N.JSON||(N.JSON={stringify:JSON.stringify});var Cn=function stringify(e,t,r){return d(N.JSON.stringify,null,arguments)},bn=Cn;_export({target:"Array",stat:!0},{isArray:wr});var En=N.Array.isArray,Rn=Ye.concat("length","prototype"),kn={f:Object.getOwnPropertyNames||function getOwnPropertyNames(e){return objectKeysInternal(e,Rn)}},wn=g([].concat),An=getBuiltIn("Reflect","ownKeys")||function ownKeys(e){var t=kn.f(anObject(e)),r=It.f;return r?wn(t,r(e)):t},Nn=Error,xn=g("".replace),On=String(Nn("zxcasd").stack),Pn=/\n\s*at [^:]*:[^\n]*/,Ln=Pn.test(On),errorStackClear=function(e,t){if(Ln&&"string"==typeof e&&!Nn.prepareStackTrace)for(;t--;)e=xn(e,Pn,"");return e},installErrorCause=function(e,t){A(t)&&"cause"in t&&Ne(e,"cause",t.cause)},Vn=wellKnownSymbol("iterator"),Un=Array.prototype,isArrayIteratorMethod=function(e){return void 0!==e&&(xt.Array===e||Un[Vn]===e)},Dn=wellKnownSymbol("iterator"),getIteratorMethod$5=function(e){if(!isNullOrUndefined(e))return getMethod(e,Dn)||getMethod(e,"@@iterator")||xt[ur(e)]},qn=TypeError,getIterator=function(e,t){var r=arguments.length<2?getIteratorMethod$5(e):t;if(aCallable(r))return anObject(y(r,e));throw qn(tryToString(e)+" is not iterable")},iteratorClose=function(e,t,r){var n,a;anObject(e);try{if(!(n=getMethod(e,"return"))){if("throw"===t)throw r;return r}n=y(n,e)}catch(e){a=!0,n=e}if("throw"===t)throw r;if(a)throw n;return anObject(n),r},Bn=TypeError,Result=function(e,t){this.stopped=e,this.result=t},Fn=Result.prototype,iterate=function(e,t,r){var n,a,i,o,s,c,l,d=r&&r.that,u=!(!r||!r.AS_ENTRIES),p=!(!r||!r.IS_RECORD),m=!(!r||!r.IS_ITERATOR),h=!(!r||!r.INTERRUPTED),g=functionBindContext(t,d),stop=function(e){return n&&iteratorClose(n,"normal",e),new Result(!0,e)},callFn=function(e){return u?(anObject(e),h?g(e[0],e[1],stop):g(e[0],e[1])):h?g(e,stop):g(e)};if(p)n=e.iterator;else if(m)n=e;else{if(!(a=getIteratorMethod$5(e)))throw Bn(tryToString(e)+" is not iterable");if(isArrayIteratorMethod(a)){for(i=0,o=lengthOfArrayLike(e);o>i;i++)if((s=callFn(e[i]))&&x(Fn,s))return s;return new Result(!1)}n=getIterator(e,a)}for(c=p?e.next:n.next;!(l=y(c,n)).done;){try{s=callFn(l.value)}catch(e){iteratorClose(n,"throw",e)}if("object"==typeof s&&s&&x(Fn,s))return s}return new Result(!1)},Gn=String,toString=function(e){if("Symbol"===ur(e))throw TypeError("Cannot convert a Symbol value to a string");return Gn(e)},normalizeStringArgument=function(e,t){return void 0===e?arguments.length<2?"":t:toString(e)},Hn=!fails((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",createPropertyDescriptor(1,7)),7!==e.stack)})),jn=wellKnownSymbol("toStringTag"),$n=Error,zn=[].push,Wn=function AggregateError(e,t){var r,n=arguments.length>2?arguments[2]:void 0,a=x(Kn,this);ct?r=ct($n(),a?tr(this):Kn):(r=a?this:nt(Kn),Ne(r,jn,"Error")),void 0!==t&&Ne(r,"message",normalizeStringArgument(t)),Hn&&Ne(r,"stack",errorStackClear(r.stack,1)),installErrorCause(r,n);var i=[];return iterate(e,zn,{that:i}),Ne(r,"errors",i),r};ct?ct(Wn,$n):function(e,t,r){for(var n=An(t),a=Ae.f,i=me.f,o=0;o<n.length;o++){var s=n[o];Z(e,s)||r&&Z(r,s)||a(e,s,i(t,s))}}(Wn,$n,{name:!0});var Kn=Wn.prototype=nt($n.prototype,{constructor:createPropertyDescriptor(1,Wn),message:createPropertyDescriptor(1,""),name:createPropertyDescriptor(1,"AggregateError")});_export({global:!0,constructor:!0,arity:2},{AggregateError:Wn});var Yn,Qn,Jn,Xn,Zn="process"==classofRaw(i.process),ea=wellKnownSymbol("species"),setSpecies=function(e){var t=getBuiltIn(e),r=Ae.f;v&&t&&!t[ea]&&r(t,ea,{configurable:!0,get:function(){return this}})},ta=TypeError,anInstance=function(e,t){if(x(t,e))return e;throw ta("Incorrect invocation")},ra=TypeError,aConstructor=function(e){if(qr(e))return e;throw ra(tryToString(e)+" is not a constructor")},na=wellKnownSymbol("species"),speciesConstructor=function(e,t){var r,n=anObject(e).constructor;return void 0===n||isNullOrUndefined(r=anObject(n)[na])?t:aConstructor(r)},aa=TypeError,validateArgumentsLength=function(e,t){if(e<t)throw aa("Not enough arguments");return e},ia=/(?:ipad|iphone|ipod).*applewebkit/i.test(O),oa=i.setImmediate,sa=i.clearImmediate,ca=i.process,la=i.Dispatch,da=i.Function,ua=i.MessageChannel,pa=i.String,ma=0,ha={},ga="onreadystatechange";try{Yn=i.location}catch(e){}var run=function(e){if(Z(ha,e)){var t=ha[e];delete ha[e],t()}},runner=function(e){return function(){run(e)}},listener=function(e){run(e.data)},post=function(e){i.postMessage(pa(e),Yn.protocol+"//"+Yn.host)};oa&&sa||(oa=function setImmediate(e){validateArgumentsLength(arguments.length,1);var t=isCallable(e)?e:da(e),r=dt(arguments,1);return ha[++ma]=function(){d(t,void 0,r)},Qn(ma),ma},sa=function clearImmediate(e){delete ha[e]},Zn?Qn=function(e){ca.nextTick(runner(e))}:la&&la.now?Qn=function(e){la.now(runner(e))}:ua&&!ia?(Xn=(Jn=new ua).port2,Jn.port1.onmessage=listener,Qn=functionBindContext(Xn.postMessage,Xn)):i.addEventListener&&isCallable(i.postMessage)&&!i.importScripts&&Yn&&"file:"!==Yn.protocol&&!fails(post)?(Qn=post,i.addEventListener("message",listener,!1)):Qn=ga in documentCreateElement("script")?function(e){Ze.appendChild(documentCreateElement("script")).onreadystatechange=function(){Ze.removeChild(this),run(e)}}:function(e){setTimeout(runner(e),0)});var va,fa,ya,_a,Ma,Ia,Sa,Ta,Ca={set:oa,clear:sa},ba=/ipad|iphone|ipod/i.test(O)&&void 0!==i.Pebble,Ea=/web0s(?!.*chrome)/i.test(O),Ra=me.f,ka=Ca.set,wa=i.MutationObserver||i.WebKitMutationObserver,Aa=i.document,Na=i.process,xa=i.Promise,Oa=Ra(i,"queueMicrotask"),Pa=Oa&&Oa.value;Pa||(va=function(){var e,t;for(Zn&&(e=Na.domain)&&e.exit();fa;){t=fa.fn,fa=fa.next;try{t()}catch(e){throw fa?_a():ya=void 0,e}}ya=void 0,e&&e.enter()},ia||Zn||Ea||!wa||!Aa?!ba&&xa&&xa.resolve?((Sa=xa.resolve(void 0)).constructor=xa,Ta=functionBindContext(Sa.then,Sa),_a=function(){Ta(va)}):Zn?_a=function(){Na.nextTick(va)}:(ka=functionBindContext(ka,i),_a=function(){ka(va)}):(Ma=!0,Ia=Aa.createTextNode(""),new wa(va).observe(Ia,{characterData:!0}),_a=function(){Ia.data=Ma=!Ma}));var La=Pa||function(e){var t={fn:e,next:void 0};ya&&(ya.next=t),fa||(fa=t,_a()),ya=t},perform=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},Queue=function(){this.head=null,this.tail=null};Queue.prototype={add:function(e){var t={item:e,next:null};this.head?this.tail.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return this.head=e.next,this.tail===e&&(this.tail=null),e.item}};var Va,Ua,Da=Queue,qa=i.Promise,Ba="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,Fa=!Ba&&!Zn&&"object"==typeof window&&"object"==typeof document,Ga=qa&&qa.prototype,Ha=wellKnownSymbol("species"),ja=!1,$a=isCallable(i.PromiseRejectionEvent),za=_e("Promise",(function(){var e=Nr(qa),t=e!==String(qa);if(!t&&66===D)return!0;if(!Ga.catch||!Ga.finally)return!0;if(!D||D<51||!/native code/.test(e)){var r=new qa((function(e){e(1)})),FakePromise=function(e){e((function(){}),(function(){}))};if((r.constructor={})[Ha]=FakePromise,!(ja=r.then((function(){}))instanceof FakePromise))return!0}return!t&&(Fa||Ba)&&!$a})),Wa={CONSTRUCTOR:za,REJECTION_EVENT:$a,SUBCLASSING:ja},Ka=TypeError,PromiseCapability=function(e){var t,r;this.promise=new e((function(e,n){if(void 0!==t||void 0!==r)throw Ka("Bad Promise constructor");t=e,r=n})),this.resolve=aCallable(t),this.reject=aCallable(r)},Ya={f:function(e){return new PromiseCapability(e)}},Qa=Ca.set,Ja="Promise",Xa=Wa.CONSTRUCTOR,Za=Wa.REJECTION_EVENT,ei=zt.getterFor(Ja),ti=zt.set,ri=qa&&qa.prototype,ni=qa,ai=ri,oi=i.TypeError,si=i.document,ci=i.process,li=Ya.f,di=li,ui=!!(si&&si.createEvent&&i.dispatchEvent),pi="unhandledrejection",isThenable=function(e){var t;return!(!A(e)||!isCallable(t=e.then))&&t},callReaction=function(e,t){var r,n,a,i=t.value,o=1==t.state,s=o?e.ok:e.fail,c=e.resolve,l=e.reject,d=e.domain;try{s?(o||(2===t.rejection&&onHandleUnhandled(t),t.rejection=1),!0===s?r=i:(d&&d.enter(),r=s(i),d&&(d.exit(),a=!0)),r===e.promise?l(oi("Promise-chain cycle")):(n=isThenable(r))?y(n,r,c,l):c(r)):l(i)}catch(e){d&&!a&&d.exit(),l(e)}},notify=function(e,t){e.notified||(e.notified=!0,La((function(){for(var r,n=e.reactions;r=n.get();)callReaction(r,e);e.notified=!1,t&&!e.rejection&&onUnhandled(e)})))},dispatchEvent=function(e,t,r){var n,a;ui?((n=si.createEvent("Event")).promise=t,n.reason=r,n.initEvent(e,!1,!0),i.dispatchEvent(n)):n={promise:t,reason:r},!Za&&(a=i["on"+e])?a(n):e===pi&&function(e,t){var r=i.console;r&&r.error&&(1==arguments.length?r.error(e):r.error(e,t))}("Unhandled promise rejection",r)},onUnhandled=function(e){y(Qa,i,(function(){var t,r=e.facade,n=e.value;if(isUnhandled(e)&&(t=perform((function(){Zn?ci.emit("unhandledRejection",n,r):dispatchEvent(pi,r,n)})),e.rejection=Zn||isUnhandled(e)?2:1,t.error))throw t.value}))},isUnhandled=function(e){return 1!==e.rejection&&!e.parent},onHandleUnhandled=function(e){y(Qa,i,(function(){var t=e.facade;Zn?ci.emit("rejectionHandled",t):dispatchEvent("rejectionhandled",t,e.value)}))},bind=function(e,t,r){return function(n){e(t,n,r)}},internalReject=function(e,t,r){e.done||(e.done=!0,r&&(e=r),e.value=t,e.state=2,notify(e,!0))},internalResolve=function(e,t,r){if(!e.done){e.done=!0,r&&(e=r);try{if(e.facade===t)throw oi("Promise can't be resolved itself");var n=isThenable(t);n?La((function(){var r={done:!1};try{y(n,t,bind(internalResolve,r,e),bind(internalReject,r,e))}catch(t){internalReject(r,t,e)}})):(e.value=t,e.state=1,notify(e,!1))}catch(t){internalReject({done:!1},t,e)}}};Xa&&(ai=(ni=function Promise(e){anInstance(this,ai),aCallable(e),y(Va,this);var t=ei(this);try{e(bind(internalResolve,t),bind(internalReject,t))}catch(e){internalReject(t,e)}}).prototype,(Va=function Promise(e){ti(this,{type:Ja,done:!1,notified:!1,parent:!1,reactions:new Da,rejection:!1,state:0,value:void 0})}).prototype=defineBuiltIn(ai,"then",(function then(e,t){var r=ei(this),n=li(speciesConstructor(this,ni));return r.parent=!0,n.ok=!isCallable(e)||e,n.fail=isCallable(t)&&t,n.domain=Zn?ci.domain:void 0,0==r.state?r.reactions.add(n):La((function(){callReaction(n,r)})),n.promise})),Ua=function(){var e=new Va,t=ei(e);this.promise=e,this.resolve=bind(internalResolve,t),this.reject=bind(internalReject,t)},Ya.f=li=function(e){return e===ni||undefined===e?new Ua(e):di(e)}),_export({global:!0,constructor:!0,wrap:!0,forced:Xa},{Promise:ni}),setToStringTag(ni,Ja,!1,!0),setSpecies(Ja);var mi=wellKnownSymbol("iterator"),hi=!1;try{var gi=0,vi={next:function(){return{done:!!gi++}},return:function(){hi=!0}};vi[mi]=function(){return this},Array.from(vi,(function(){throw 2}))}catch(e){}var checkCorrectnessOfIteration=function(e,t){if(!t&&!hi)return!1;var r=!1;try{var n={};n[mi]=function(){return{next:function(){return{done:r=!0}}}},e(n)}catch(e){}return r},fi=Wa.CONSTRUCTOR||!checkCorrectnessOfIteration((function(e){qa.all(e).then(void 0,(function(){}))}));_export({target:"Promise",stat:!0,forced:fi},{all:function all(e){var t=this,r=Ya.f(t),n=r.resolve,a=r.reject,i=perform((function(){var r=aCallable(t.resolve),i=[],o=0,s=1;iterate(e,(function(e){var c=o++,l=!1;s++,y(r,t,e).then((function(e){l||(l=!0,i[c]=e,--s||n(i))}),a)})),--s||n(i)}));return i.error&&a(i.value),r.promise}});var yi=Wa.CONSTRUCTOR;qa&&qa.prototype,_export({target:"Promise",proto:!0,forced:yi,real:!0},{catch:function(e){return this.then(void 0,e)}}),_export({target:"Promise",stat:!0,forced:fi},{race:function race(e){var t=this,r=Ya.f(t),n=r.reject,a=perform((function(){var a=aCallable(t.resolve);iterate(e,(function(e){y(a,t,e).then(r.resolve,n)}))}));return a.error&&n(a.value),r.promise}}),_export({target:"Promise",stat:!0,forced:Wa.CONSTRUCTOR},{reject:function reject(e){var t=Ya.f(this);return y(t.reject,void 0,e),t.promise}});var promiseResolve=function(e,t){if(anObject(e),A(t)&&t.constructor===e)return t;var r=Ya.f(e);return(0,r.resolve)(t),r.promise},_i=Wa.CONSTRUCTOR,Mi=getBuiltIn("Promise"),Ii=!_i;_export({target:"Promise",stat:!0,forced:!0},{resolve:function resolve(e){return promiseResolve(Ii&&this===Mi?qa:this,e)}}),_export({target:"Promise",stat:!0},{allSettled:function allSettled(e){var t=this,r=Ya.f(t),n=r.resolve,a=r.reject,i=perform((function(){var r=aCallable(t.resolve),a=[],i=0,o=1;iterate(e,(function(e){var s=i++,c=!1;o++,y(r,t,e).then((function(e){c||(c=!0,a[s]={status:"fulfilled",value:e},--o||n(a))}),(function(e){c||(c=!0,a[s]={status:"rejected",reason:e},--o||n(a))}))})),--o||n(a)}));return i.error&&a(i.value),r.promise}});var Si="No one promise resolved";_export({target:"Promise",stat:!0},{any:function any(e){var t=this,r=getBuiltIn("AggregateError"),n=Ya.f(t),a=n.resolve,i=n.reject,o=perform((function(){var n=aCallable(t.resolve),o=[],s=0,c=1,l=!1;iterate(e,(function(e){var d=s++,u=!1;c++,y(n,t,e).then((function(e){u||l||(l=!0,a(e))}),(function(e){u||l||(u=!0,o[d]=e,--c||i(new r(o,Si)))}))})),--c||i(new r(o,Si))}));return o.error&&i(o.value),n.promise}});var Ti=qa&&qa.prototype,Ci=!!qa&&fails((function(){Ti.finally.call({then:function(){}},(function(){}))}));_export({target:"Promise",proto:!0,real:!0,forced:Ci},{finally:function(e){var t=speciesConstructor(this,getBuiltIn("Promise")),r=isCallable(e);return this.then(r?function(r){return promiseResolve(t,e()).then((function(){return r}))}:e,r?function(r){return promiseResolve(t,e()).then((function(){throw r}))}:e)}});var bi=g("".charAt),Ei=g("".charCodeAt),Ri=g("".slice),createMethod$3=function(e){return function(t,r){var n,a,i=toString(requireObjectCoercible(t)),o=toIntegerOrInfinity(r),s=i.length;return o<0||o>=s?e?"":void 0:(n=Ei(i,o))<55296||n>56319||o+1===s||(a=Ei(i,o+1))<56320||a>57343?e?bi(i,o):n:e?Ri(i,o,o+2):a-56320+(n-55296<<10)+65536}},ki={codeAt:createMethod$3(!1),charAt:createMethod$3(!0)},wi=ki.charAt,Ai="String Iterator",Ni=zt.set,xi=zt.getterFor(Ai);iteratorDefine(String,"String",(function(e){Ni(this,{type:Ai,string:toString(e),index:0})}),(function next(){var e,t=xi(this),r=t.string,n=t.index;return n>=r.length?{value:void 0,done:!0}:(e=wi(r,n),t.index+=e.length,{value:e,done:!1})}));var Oi=N.Promise;_export({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=Ya.f(this),r=perform(e);return(r.error?t.reject:t.resolve)(r.value),t.promise}});var Pi=Oi,Li=S.f,Vi=g(Li),Ui=g([].push),createMethod$2=function(e){return function(t){for(var r,n=toIndexedObject(t),a=Qe(n),i=a.length,o=0,s=[];i>o;)r=a[o++],v&&!Vi(n,r)||Ui(s,e?[r,n[r]]:n[r]);return s}},Di={entries:createMethod$2(!0),values:createMethod$2(!1)},qi=Di.values;_export({target:"Object",stat:!0},{values:function values(e){return qi(e)}});var Bi=N.Object.values,Fi=Date,Gi=g(Fi.prototype.getTime);_export({target:"Date",stat:!0},{now:function now(){return Gi(new Fi)}});var Hi=N.Date.now,ji=wellKnownSymbol("isConcatSpreadable"),$i=D>=51||!fails((function(){var e=[];return e[ji]=!1,e.concat()[0]!==e})),zi=arrayMethodHasSpeciesSupport("concat"),isConcatSpreadable=function(e){if(!A(e))return!1;var t=e[ji];return void 0!==t?!!t:wr(e)};_export({target:"Array",proto:!0,arity:1,forced:!$i||!zi},{concat:function concat(e){var t,r,n,a,i,o=toObject(this),s=arraySpeciesCreate(o,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(isConcatSpreadable(i=-1===t?o:arguments[t]))for(a=lengthOfArrayLike(i),doesNotExceedSafeInteger(c+a),r=0;r<a;r++,c++)r in i&&createProperty(s,c,i[r]);else doesNotExceedSafeInteger(c+1),createProperty(s,c++,i);return s.length=c,s}});var Wi=entryVirtual("Array").concat,Ki=Array.prototype,concat=function(e){var t=e.concat;return e===Ki||x(Ki,e)&&t===Ki.concat?Wi:t},Yi=/MSIE .\./.test(O),Qi=i.Function,wrap$1=function(e){return Yi?function(t,r){var n=validateArgumentsLength(arguments.length,1)>2,a=isCallable(t)?t:Qi(t),i=n?dt(arguments,2):void 0;return e(n?function(){d(a,this,i)}:a,r)}:e},Ji={setTimeout:wrap$1(i.setTimeout),setInterval:wrap$1(i.setInterval)},Xi=Ji.setInterval;_export({global:!0,bind:!0,forced:i.setInterval!==Xi},{setInterval:Xi});var Zi=Ji.setTimeout;_export({global:!0,bind:!0,forced:i.setTimeout!==Zi},{setTimeout:Zi});var eo=N.setTimeout,to=createCommonjsModule((function(e){var t=Object.prototype.hasOwnProperty,r="~";function Events(){}function EE(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function addListener(e,t,n,a,i){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new EE(n,a||e,i),s=r?r+t:t;return e._events[s]?e._events[s].fn?e._events[s]=[e._events[s],o]:e._events[s].push(o):(e._events[s]=o,e._eventsCount++),e}function clearEvent(e,t){0==--e._eventsCount?e._events=new Events:delete e._events[t]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),(new Events).__proto__||(r=!1)),EventEmitter.prototype.eventNames=function eventNames(){var e,n,a=[];if(0===this._eventsCount)return a;for(n in e=this._events)t.call(e,n)&&a.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(e)):a},EventEmitter.prototype.listeners=function listeners(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var a=0,i=n.length,o=new Array(i);a<i;a++)o[a]=n[a].fn;return o},EventEmitter.prototype.listenerCount=function listenerCount(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},EventEmitter.prototype.emit=function emit(e,t,n,a,i,o){var s=r?r+e:e;if(!this._events[s])return!1;var c,l,d=this._events[s],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,n),!0;case 4:return d.fn.call(d.context,t,n,a),!0;case 5:return d.fn.call(d.context,t,n,a,i),!0;case 6:return d.fn.call(d.context,t,n,a,i,o),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c)}else{var p,m=d.length;for(l=0;l<m;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,n);break;case 4:d[l].fn.call(d[l].context,t,n,a);break;default:if(!c)for(p=1,c=new Array(u-1);p<u;p++)c[p-1]=arguments[p];d[l].fn.apply(d[l].context,c)}}return!0},EventEmitter.prototype.on=function on(e,t,r){return addListener(this,e,t,r,!1)},EventEmitter.prototype.once=function once(e,t,r){return addListener(this,e,t,r,!0)},EventEmitter.prototype.removeListener=function removeListener(e,t,n,a){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return clearEvent(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||a&&!o.once||n&&o.context!==n||clearEvent(this,i);else{for(var s=0,c=[],l=o.length;s<l;s++)(o[s].fn!==t||a&&!o[s].once||n&&o[s].context!==n)&&c.push(o[s]);c.length?this._events[i]=1===c.length?c[0]:c:clearEvent(this,i)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(e){var t;return e?(t=r?r+e:e,this._events[t]&&clearEvent(this,t)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=r,EventEmitter.EventEmitter=EventEmitter,e.exports=EventEmitter}));_export({global:!0},{globalThis:i});var ro=i,no=Array,ao=Math.max,arraySliceSimple=function(e,t,r){for(var n=lengthOfArrayLike(e),a=toAbsoluteIndex(t,n),i=toAbsoluteIndex(void 0===r?n:r,n),o=no(ao(i-a,0)),s=0;a<i;a++,s++)createProperty(o,s,e[a]);return o.length=s,o},io=kn.f,oo="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],so={f:function getOwnPropertyNames(e){return oo&&"Window"==classofRaw(e)?function(e){try{return io(e)}catch(e){return arraySliceSimple(oo)}}(e):io(toIndexedObject(e))}},co={f:wellKnownSymbol},lo=Ae.f,wellKnownSymbolDefine=function(e){var t=N.Symbol||(N.Symbol={});Z(t,e)||lo(t,e,{value:co.f(e)})},symbolDefineToPrimitive=function(){var e=getBuiltIn("Symbol"),t=e&&e.prototype,r=t&&t.valueOf,n=wellKnownSymbol("toPrimitive");t&&!t[n]&&defineBuiltIn(t,n,(function(e){return y(r,this)}),{arity:1})},uo=Hr.forEach,po=sharedKey("hidden"),mo="Symbol",ho=zt.set,go=zt.getterFor(mo),vo=Object.prototype,fo=i.Symbol,yo=fo&&fo.prototype,_o=i.TypeError,Mo=i.QObject,Io=me.f,So=Ae.f,To=so.f,Co=S.f,bo=g([].push),Eo=Q("symbols"),Ro=Q("op-symbols"),ko=Q("wks"),wo=!Mo||!Mo.prototype||!Mo.prototype.findChild,Ao=v&&fails((function(){return 7!=nt(So({},"a",{get:function(){return So(this,"a",{value:7}).a}})).a}))?function(e,t,r){var n=Io(vo,t);n&&delete vo[t],So(e,t,r),n&&e!==vo&&So(vo,t,n)}:So,wrap=function(e,t){var r=Eo[e]=nt(yo);return ho(r,{type:mo,tag:e,description:t}),v||(r.description=t),r},No=function defineProperty(e,t,r){e===vo&&No(Ro,t,r),anObject(e);var n=toPropertyKey(t);return anObject(r),Z(Eo,n)?(r.enumerable?(Z(e,po)&&e[po][n]&&(e[po][n]=!1),r=nt(r,{enumerable:createPropertyDescriptor(0,!1)})):(Z(e,po)||So(e,po,createPropertyDescriptor(1,{})),e[po][n]=!0),Ao(e,n,r)):So(e,n,r)},xo=function defineProperties(e,t){anObject(e);var r=toIndexedObject(t),n=Qe(r).concat($getOwnPropertySymbols(r));return uo(n,(function(t){v&&!y(Oo,r,t)||No(e,t,r[t])})),e},Oo=function propertyIsEnumerable(e){var t=toPropertyKey(e),r=y(Co,this,t);return!(this===vo&&Z(Eo,t)&&!Z(Ro,t))&&(!(r||!Z(this,t)||!Z(Eo,t)||Z(this,po)&&this[po][t])||r)},Po=function getOwnPropertyDescriptor(e,t){var r=toIndexedObject(e),n=toPropertyKey(t);if(r!==vo||!Z(Eo,n)||Z(Ro,n)){var a=Io(r,n);return!a||!Z(Eo,n)||Z(r,po)&&r[po][n]||(a.enumerable=!0),a}},Lo=function getOwnPropertyNames(e){var t=To(toIndexedObject(e)),r=[];return uo(t,(function(e){Z(Eo,e)||Z(ze,e)||bo(r,e)})),r},$getOwnPropertySymbols=function(e){var t=e===vo,r=To(t?Ro:toIndexedObject(e)),n=[];return uo(r,(function(e){!Z(Eo,e)||t&&!Z(vo,e)||bo(n,Eo[e])})),n};q||(fo=function Symbol(){if(x(yo,this))throw _o("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?toString(arguments[0]):void 0,t=uid(e),setter=function(e){this===vo&&y(setter,Ro,e),Z(this,po)&&Z(this[po],t)&&(this[po][t]=!1),Ao(this,t,createPropertyDescriptor(1,e))};return v&&wo&&Ao(vo,t,{configurable:!0,set:setter}),wrap(t,e)},yo=fo.prototype,defineBuiltIn(yo,"toString",(function toString(){return go(this).tag})),defineBuiltIn(fo,"withoutSetter",(function(e){return wrap(uid(e),e)})),S.f=Oo,Ae.f=No,Xe.f=xo,me.f=Po,kn.f=so.f=Lo,It.f=$getOwnPropertySymbols,co.f=function(e){return wrap(wellKnownSymbol(e),e)},v&&So(yo,"description",{configurable:!0,get:function description(){return go(this).description}})),_export({global:!0,constructor:!0,wrap:!0,forced:!q,sham:!q},{Symbol:fo}),uo(Qe(ko),(function(e){wellKnownSymbolDefine(e)})),_export({target:mo,stat:!0,forced:!q},{useSetter:function(){wo=!0},useSimple:function(){wo=!1}}),_export({target:"Object",stat:!0,forced:!q,sham:!v},{create:function create(e,t){return void 0===t?nt(e):xo(nt(e),t)},defineProperty:No,defineProperties:xo,getOwnPropertyDescriptor:Po}),_export({target:"Object",stat:!0,forced:!q},{getOwnPropertyNames:Lo}),symbolDefineToPrimitive(),setToStringTag(fo,mo),ze[po]=!0;var Vo=q&&!!Symbol.for&&!!Symbol.keyFor,Uo=Q("string-to-symbol-registry"),Do=Q("symbol-to-string-registry");_export({target:"Symbol",stat:!0,forced:!Vo},{for:function(e){var t=toString(e);if(Z(Uo,t))return Uo[t];var r=getBuiltIn("Symbol")(t);return Uo[t]=r,Do[r]=t,r}});var qo=Q("symbol-to-string-registry");_export({target:"Symbol",stat:!0,forced:!Vo},{keyFor:function keyFor(e){if(!H(e))throw TypeError(tryToString(e)+" is not a symbol");if(Z(qo,e))return qo[e]}});var Bo=!q||fails((function(){It.f(1)}));_export({target:"Object",stat:!0,forced:Bo},{getOwnPropertySymbols:function getOwnPropertySymbols(e){var t=It.f;return t?t(toObject(e)):[]}}),wellKnownSymbolDefine("asyncIterator"),wellKnownSymbolDefine("hasInstance"),wellKnownSymbolDefine("isConcatSpreadable"),wellKnownSymbolDefine("iterator"),wellKnownSymbolDefine("match"),wellKnownSymbolDefine("matchAll"),wellKnownSymbolDefine("replace"),wellKnownSymbolDefine("search"),wellKnownSymbolDefine("species"),wellKnownSymbolDefine("split"),wellKnownSymbolDefine("toPrimitive"),symbolDefineToPrimitive(),wellKnownSymbolDefine("toStringTag"),setToStringTag(getBuiltIn("Symbol"),"Symbol"),wellKnownSymbolDefine("unscopables"),setToStringTag(i.JSON,"JSON",!0);var Fo=N.Symbol;wellKnownSymbolDefine("asyncDispose"),wellKnownSymbolDefine("dispose"),wellKnownSymbolDefine("matcher"),wellKnownSymbolDefine("metadataKey"),wellKnownSymbolDefine("observable"),wellKnownSymbolDefine("metadata"),wellKnownSymbolDefine("patternMatch"),wellKnownSymbolDefine("replaceAll");var Go=Fo,Ho=fails((function(){tr(1)}));_export({target:"Object",stat:!0,forced:Ho,sham:!Jt},{getPrototypeOf:function getPrototypeOf(e){return tr(toObject(e))}});var jo=N.Object.getPrototypeOf,$o=g([].reverse),zo=[1,2];_export({target:"Array",proto:!0,forced:String(zo)===String(zo.reverse())},{reverse:function reverse(){return wr(this)&&(this.length=this.length),$o(this)}});var Wo=entryVirtual("Array").reverse,Ko=Array.prototype,reverse$1=function(e){var t=e.reverse;return e===Ko||x(Ko,e)&&t===Ko.reverse?Wo:t},Yo=arrayMethodHasSpeciesSupport("slice"),Qo=wellKnownSymbol("species"),Jo=Array,Xo=Math.max;_export({target:"Array",proto:!0,forced:!Yo},{slice:function slice(e,t){var r,n,a,i=toIndexedObject(this),o=lengthOfArrayLike(i),s=toAbsoluteIndex(e,o),c=toAbsoluteIndex(void 0===t?o:t,o);if(wr(i)&&(r=i.constructor,(qr(r)&&(r===Jo||wr(r.prototype))||A(r)&&null===(r=r[Qo]))&&(r=void 0),r===Jo||void 0===r))return dt(i,s,c);for(n=new(void 0===r?Jo:r)(Xo(c-s,0)),a=0;s<c;s++,a++)s in i&&createProperty(n,a,i[s]);return n.length=a,n}});var Zo=entryVirtual("Array").slice,es=Array.prototype,slice=function(e){var t=e.slice;return e===es||x(es,e)&&t===es.slice?Zo:t},ts=co.f("iterator"),rs=$e.includes,ns=fails((function(){return!Array(1).includes()}));_export({target:"Array",proto:!0,forced:ns},{includes:function includes(e){return rs(this,e,arguments.length>1?arguments[1]:void 0)}});var as=entryVirtual("Array").includes,is=wellKnownSymbol("match"),os=TypeError,notARegexp=function(e){if(function(e){var t;return A(e)&&(void 0!==(t=e[is])?!!t:"RegExp"==classofRaw(e))}(e))throw os("The method doesn't accept regular expressions");return e},ss=wellKnownSymbol("match"),correctIsRegexpLogic=function(e){var t=/./;try{"/./"[e](t)}catch(r){try{return t[ss]=!1,"/./"[e](t)}catch(e){}}return!1},cs=g("".indexOf);_export({target:"String",proto:!0,forced:!correctIsRegexpLogic("includes")},{includes:function includes(e){return!!~cs(toString(requireObjectCoercible(this)),toString(notARegexp(e)),arguments.length>1?arguments[1]:void 0)}});var ls=entryVirtual("String").includes,ds=Array.prototype,us=String.prototype,includes=function(e){var t=e.includes;return e===ds||x(ds,e)&&t===ds.includes?as:"string"==typeof e||e===us||x(us,e)&&t===us.includes?ls:t},ps=Hr.map,ms=arrayMethodHasSpeciesSupport("map");_export({target:"Array",proto:!0,forced:!ms},{map:function map(e){return ps(this,e,arguments.length>1?arguments[1]:void 0)}});var hs=entryVirtual("Array").map,gs=Array.prototype,map$6=function(e){var t=e.map;return e===gs||x(gs,e)&&t===gs.map?hs:t},vs=Hr.filter,fs=arrayMethodHasSpeciesSupport("filter");_export({target:"Array",proto:!0,forced:!fs},{filter:function filter(e){return vs(this,e,arguments.length>1?arguments[1]:void 0)}});var ys=entryVirtual("Array").filter,_s=Array.prototype,filter=function(e){var t=e.filter;return e===_s||x(_s,e)&&t===_s.filter?ys:t},Ms=createCommonjsModule((function(e,t){e.exports=function(){function _regeneratorRuntime(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */
_regeneratorRuntime=function _regeneratorRuntime(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Go?Go:{},a=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function define(e,t,r){return Ve(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{define({},"")}catch(e){define=function define(e,t,r){return e[t]=r}}function wrap(e,t,r,n){var a=t&&t.prototype instanceof Generator?t:Generator,i=it(a.prototype),o=new Context(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(a,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw i;return doneResult()}for(r.method=a,r.arg=i;;){var o=r.delegate;if(o){var c=maybeInvokeDelegate(o,r);if(c){if(c===s)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var l=tryCatch(e,t,r);if("normal"===l.type){if(n=r.done?"completed":"suspendedYield",l.arg===s)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(n="completed",r.method="throw",r.arg=l.arg)}}}(e,r,o),i}function tryCatch(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=wrap;var s={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var c={};define(c,a,(function(){return this}));var l=jo&&jo(jo(values([])));l&&l!==t&&r.call(l,a)&&(c=l);var d=GeneratorFunctionPrototype.prototype=Generator.prototype=it(c);function defineIteratorMethods(e){var t;forEach$1(t=["next","throw","return"]).call(t,(function(t){define(e,t,(function(e){return this._invoke(t,e)}))}))}function AsyncIterator(e,t){function invoke(n,a,i,o){var s=tryCatch(e[n],e,a);if("throw"!==s.type){var c=s.arg,l=c.value;return l&&"object"==typeof l&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){invoke("next",e,i,o)}),(function(e){invoke("throw",e,i,o)})):t.resolve(l).then((function(e){c.value=e,i(c)}),(function(e){return invoke("throw",e,i,o)}))}o(s.arg)}var n;this._invoke=function(e,r){function callInvokeWithMethodAndArg(){return new t((function(t,n){invoke(e,r,t,n)}))}return n=n?n.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,maybeInvokeDelegate(e,t),"throw"===t.method))return s;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return s}var n=tryCatch(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,s;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,s):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,s)}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}],forEach$1(e).call(e,pushTryEntry,this),this.reset(!0)}function values(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function next(){for(;++n<e.length;)if(r.call(e,n))return next.value=e[n],next.done=!1,next;return next.value=void 0,next.done=!0,next};return i.next=i}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(d,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return lt?lt(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,define(e,o,"GeneratorFunction")),e.prototype=it(d),e},e.awrap=function(e){return{__await:e}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,i,(function(){return this})),e.AsyncIterator=AsyncIterator,e.async=function(t,r,n,a,i){void 0===i&&(i=Pi);var o=new AsyncIterator(wrap(t,r,n,a),i);return e.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},defineIteratorMethods(d),define(d,o,"Generator"),define(d,a,(function(){return this})),define(d,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return reverse$1(t).call(t),function next(){for(;t.length;){var r=t.pop();if(r in e)return next.value=r,next.done=!1,next}return next.done=!0,next}},e.values=values,Context.prototype={constructor:Context,reset:function reset(e){var t;if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,forEach$1(t=this.tryEntries).call(t,resetTryEntry),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+slice(n).call(n,1))&&(this[n]=void 0)},stop:function stop(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function dispatchException(e){if(this.done)throw e;var t=this;function handle(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n],i=a.completion;if("root"===a.tryLoc)return handle("end");if(a.tryLoc<=this.prev){var o=r.call(a,"catchLoc"),s=r.call(a,"finallyLoc");if(o&&s){if(this.prev<a.catchLoc)return handle(a.catchLoc,!0);if(this.prev<a.finallyLoc)return handle(a.finallyLoc)}else if(o){if(this.prev<a.catchLoc)return handle(a.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return handle(a.finallyLoc)}}}},abrupt:function abrupt(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,s):this.complete(o)},complete:function complete(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),s},finish:function finish(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),s}},catch:function _catch(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;resetTryEntry(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(e,t,r){return this.delegate={iterator:values(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),s}},e}function _typeof(e){return _typeof="function"==typeof Go&&"symbol"==typeof ts?function(e){return typeof e}:function(e){return e&&"function"==typeof Go&&e.constructor===Go&&e!==Go.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Ve(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Ve(e,"prototype",{writable:!1}),e}function __awaiter(e,t,r,n){function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}return new(r||(r=Pi))((function(r,a){function fulfilled(e){try{step(n.next(e))}catch(e){a(e)}}function rejected(e){try{step(n.throw(e))}catch(e){a(e)}}function step(e){e.done?r(e.value):adopt(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))}var e={isDataReportEnable:!0,maxSize:100,msgListMaxSize:1e3,cacheMaxSize:1e3,maxDelay:3e5,maxInterval:3e4,minInterval:1e4,timeout:5e3,autoStart:!0,loginFailIgnoreInterval:72e5},t=12,r=8e3,n=function emptyFn(){},a=function(){function Reporter(t){_classCallCheck(this,Reporter),this.isUploadEnable=!0,this.serverAllowUpload=!1,this.initConfigLoaded=!1,this.loading=!1,this.isDestroyed=!1,this.reportConfig=e,this.configPath="dispatcher/req",this.dataReportPath="statics/report/common/form",this.traceMsgCache={},this.reqRetryCount=0,this.highPriorityMsgList=[],this.msgList=[],this.lowPriorityMsgList=[],this.cacheMsgList=[],this.lastReportTime=Hi(),this.timer=null,this.endedAsyncMsgByModule={},this.lastFailLogin={},this.setConfig(t),this.reportConfig.isDataReportEnable&&this.reportConfig.autoStart&&this.initUploadConfig()}return _createClass(Reporter,[{key:"setConfig",value:function setConfig(e){var t=Et({},this.reportConfig.common,e.common);this.reportConfig=Et({},this.reportConfig,e),this.reportConfig.common=t,this.reportConfig.common.sdk_type||(this.reportConfig.common.sdk_type="im")}},{key:"reportImmediately",value:function reportImmediately(e,t){var r=this;this.reportConfig.isDataReportEnable&&this.reportConfig.request(e,Et({dataType:"json",method:"POST",timeout:this.reportConfig.timeout},t)).catch((function(e){var t,n;null===(n=null===(t=r.reportConfig)||void 0===t?void 0:t.logger)||void 0===n||n.warn("Reporter immediately upload failed",e)}))}},{key:"report",value:function report(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(n.priority||(n.priority=this.getEventPriority(t,r)),this.reportConfig.isDataReportEnable&&t){if("login"===t&&!1===r.succeed&&r.process_id){var a=this.lastFailLogin[r.process_id]||0;if(r.start_time-a<e.loginFailIgnoreInterval)return;this.lastFailLogin[r.process_id]=r.start_time}var i=Hi();"HIGH"===n.priority?this.highPriorityMsgList.push({module:t,msg:r,createTime:i}):"NORMAL"===n.priority?this.msgList.push({module:t,msg:r,createTime:i}):"LOW"===n.priority&&this.lowPriorityMsgList.push({module:t,msg:r,createTime:i}),this.highPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.highPriorityMsgList.shift(),this.msgList.length>this.reportConfig.msgListMaxSize&&this.msgList.shift(),this.lowPriorityMsgList.length>this.reportConfig.msgListMaxSize&&this.lowPriorityMsgList.shift(),this.doReport()}}},{key:"reportTraceStart",value:function reportTraceStart(e,t){if(this.reportConfig.isDataReportEnable&&e&&!this.traceMsgCache[e]){var r=Et(Et({start_time:Hi()},t),{extension:[]});this.traceMsgCache[e]=r}}},{key:"reportTraceUpdate",value:function reportTraceUpdate(e){}},{key:"reportTraceUpdateV2",value:function reportTraceUpdateV2(e,t,r){var n,a=this;if(this.reportConfig.isDataReportEnable&&this.traceMsgCache[e]){var i=this.traceMsgCache[e].extension,o=i.length,s=(new Date).getTime();0===o?t.duration=s-this.traceMsgCache[e].start_time:i[o-1].end_time?t.duration=s-i[o-1].end_time:t.duration=s-this.traceMsgCache[e].start_time,i.push(Et({end_time:s},t));var c=i.length-1;(null==r?void 0:r.asyncParams)&&((n=this.traceMsgCache[e]).asyncPromiseArray||(n.asyncPromiseArray=[]),this.traceMsgCache[e].asyncPromiseArray.push(r.asyncParams.then((function(t){a.traceMsgCache[e]&&a.traceMsgCache[e].extension[c]&&Et(a.traceMsgCache[e].extension[c],t)}))))}}},{key:"reportTraceEnd",value:function reportTraceEnd(e){var t,r,n=this,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reportConfig.isDataReportEnable&&this.traceMsgCache[e])if("nos"!==e||!1===a){"boolean"==typeof a?this.traceMsgCache[e].succeed=!!a:this.traceMsgCache[e].state=a,this.traceMsgCache[e].duration=Hi()-this.traceMsgCache[e].start_time,forEach$1(t=this.traceMsgCache[e].extension).call(t,(function(e){delete e.end_time}));var i=this.traceMsgCache[e];if(this.traceMsgCache[e]=null,i.asyncPromiseArray){(r=this.endedAsyncMsgByModule)[e]||(r[e]=[]),this.endedAsyncMsgByModule[e].push(i);var o=function asyncCallback(){var t;n.endedAsyncMsgByModule[e]&&includes(t=n.endedAsyncMsgByModule[e]).call(t,i)&&(delete i.asyncPromiseArray,n.report(e,i,{priority:n.getEventPriority(e,i)}))};Pi.all(i.asyncPromiseArray).then(o).catch(o)}else this.report(e,i,{priority:this.getEventPriority(e,i)})}else this.traceMsgCache[e]=null}},{key:"getEventPriority",value:function getEventPriority(e,t){if("exceptions"===e){if(0===t.action)return"HIGH";if(2===t.action)return"HIGH";if(1===t.action&&0!==t.exception_service)return"HIGH"}else{if("msgReceive"===e)return"LOW";if("nim_api_trace"===e)return"LOW"}return"NORMAL"}},{key:"reportTraceCancel",value:function reportTraceCancel(e){this.reportConfig.isDataReportEnable&&(this.endedAsyncMsgByModule[e]=[],this.traceMsgCache[e]=null)}},{key:"pause",value:function pause(){this.reportConfig.isDataReportEnable&&(this.isUploadEnable=!1)}},{key:"restore",value:function restore(){this.reportConfig.isDataReportEnable&&(this.isUploadEnable=!0,this.initConfigLoaded||this.initUploadConfig())}},{key:"destroy",value:function destroy(){var e,t=this;this.reportConfig.isDataReportEnable&&(forEach$1(e=Nt(this.traceMsgCache)).call(e,(function(e){t.reportTraceEnd(e,1)})),null!==this.timer&&clearTimeout(this.timer),this.setConfig=n,this.report=n,this.reportTraceStart=n,this.reportTraceUpdate=n,this.reportTraceEnd=n,this.pause=n,this.restore=n,this.destroy=n,this.reqRetryCount=0,this.cacheMsgList=[],this.traceMsgCache={},this.lowPriorityMsgList=[],this.msgList=[],this.highPriorityMsgList=[],this.reportConfig={},this.isDestroyed=!0)}},{key:"initUploadConfig",value:function initUploadConfig(){var e,n;return __awaiter(this,void 0,void 0,_regeneratorRuntime().mark((function _callee(){var a,i,o,s,c,l=this;return _regeneratorRuntime().wrap((function _callee$(d){for(var u;;)switch(d.prev=d.next){case 0:if(!this.loading){d.next=2;break}return d.abrupt("return");case 2:this.loading=!0,a=this.reportConfig.common||{},i=map$6(u=this.reportConfig.compassDataEndpoint.split(",")).call(u,(function(e){var t;return concat(t="".concat(e,"/")).call(t,l.configPath)})),o=_regeneratorRuntime().mark((function _loop(o){return _regeneratorRuntime().wrap((function _loop$(s){for(;;)switch(s.prev=s.next){case 0:if(!l.initConfigLoaded&&!l.isDestroyed){s.next=2;break}return s.abrupt("return","break");case 2:return s.prev=2,s.next=5,l.reportConfig.request(i[o],{method:"GET",dataType:"json",params:{deviceId:a.dev_id,sdkVer:a.sdk_ver,platform:a.platform,appkey:a.app_key},timeout:l.reportConfig.timeout}).then((function(e){var t,r;if(!l.isDestroyed){if(200===e.status&&e.data&&200===e.data.code){l.initConfigLoaded=!0;var n=e.data.data||{};l.reportConfig.maxSize=n.maxSize>1e3?1e3:n.maxSize,l.reportConfig.maxInterval=n.maxInterval>1e4?1e4:n.maxInterval,l.reportConfig.maxInterval=n.maxInterval<10?10:n.maxInterval,l.reportConfig.minInterval=n.minInterval<2?2:n.minInterval,l.reportConfig.maxDelay=n.maxDelay||300,l.reportConfig.maxInterval=1e3*l.reportConfig.maxInterval,l.reportConfig.minInterval=1e3*l.reportConfig.minInterval,l.reportConfig.maxDelay=1e3*l.reportConfig.maxDelay,n.endpoint?l.dataReportEndpoint=n.endpoint:l.dataReportEndpoint=i[o],l.serverAllowUpload=!0,l.loading=!1,l.reportHeartBeat()}else 200===e.status&&(l.initConfigLoaded=!0);null===(r=null===(t=l.reportConfig)||void 0===t?void 0:t.logger)||void 0===r||r.log("Get reporter upload config success")}})).catch((function(e){var n,a;l.isDestroyed||(l.loading=!1,null===(a=null===(n=l.reportConfig)||void 0===n?void 0:n.logger)||void 0===a||a.error("Get reporter upload config failed",e),l.reqRetryCount<t&&(l.reqRetryCount++,eo((function(){l.isDestroyed||l.initUploadConfig()}),r)))}));case 5:s.next=14;break;case 7:if(s.prev=7,s.t0=s.catch(2),!l.isDestroyed){s.next=11;break}return s.abrupt("return",{v:void 0});case 11:l.loading=!1,null===(n=null===(e=l.reportConfig)||void 0===e?void 0:e.logger)||void 0===n||n.error("Exec reporter request failed",s.t0),l.reqRetryCount<t&&(l.reqRetryCount++,eo((function(){l.isDestroyed||l.initUploadConfig()}),r));case 14:case"end":return s.stop()}}),_loop,null,[[2,7]])})),s=0;case 7:if(!(s<i.length)){d.next=17;break}return d.delegateYield(o(s),"t0",9);case 9:if("break"!==(c=d.t0)){d.next=12;break}return d.abrupt("break",17);case 12:if("object"!==_typeof(c)){d.next=14;break}return d.abrupt("return",c.v);case 14:s++,d.next=7;break;case 17:case"end":return d.stop()}}),_callee,this)})))}},{key:"reportHeartBeat",value:function reportHeartBeat(){var e=this;this.isDestroyed||(this.timer=eo((function(){e.reportHeartBeat()}),this.reportConfig.minInterval),this.doReport())}},{key:"doReport",value:function doReport(){if(!this.isDestroyed){var e=this.highPriorityMsgList.length+this.msgList.length+this.lowPriorityMsgList.length+this.cacheMsgList.length>2*this.reportConfig.maxSize?this.reportConfig.minInterval:this.reportConfig.maxInterval;Hi()-this.lastReportTime>=e&&this.upload()}}},{key:"getUploadMsg",value:function getUploadMsg(){var e,t,r,n,a,i,o=this,s={},c=Hi();this.highPriorityMsgList=filter(e=this.highPriorityMsgList).call(e,(function(e){return c-e.createTime<o.reportConfig.maxDelay})),this.msgList=filter(t=this.msgList).call(t,(function(e){return c-e.createTime<o.reportConfig.maxDelay})),this.lowPriorityMsgList=filter(r=this.lowPriorityMsgList).call(r,(function(e){return c-e.createTime<o.reportConfig.maxDelay})),this.cacheMsgList=filter(n=this.cacheMsgList).call(n,(function(e){return c-e.createTime<o.reportConfig.maxDelay}));var l=slice(a=this.highPriorityMsgList).call(a,0,this.reportConfig.maxSize);if(this.highPriorityMsgList=slice(i=this.highPriorityMsgList).call(i,l.length),l.length<this.reportConfig.maxSize){var d,u,p=this.reportConfig.maxSize-l.length;l=concat(l).call(l,slice(d=this.msgList).call(d,0,p)),this.msgList=slice(u=this.msgList).call(u,p)}if(l.length<this.reportConfig.maxSize){var m,h,g=this.reportConfig.maxSize-l.length;l=concat(l).call(l,slice(m=this.lowPriorityMsgList).call(m,0,g)),this.lowPriorityMsgList=slice(h=this.lowPriorityMsgList).call(h,g)}if(l.length<this.reportConfig.maxSize){var v,f,y=this.reportConfig.maxSize-l.length;l=concat(l).call(l,slice(v=this.cacheMsgList).call(v,0,y)),this.cacheMsgList=slice(f=this.cacheMsgList).call(f,y)}return forEach$1(l).call(l,(function(e){s[e.module]?s[e.module].push(e.msg):s[e.module]=[e.msg]})),{uploadMsgArr:l,uploadMsg:s}}},{key:"upload",value:function upload(){var e,t,r=this;if(this.isUploadEnable&&this.serverAllowUpload&&!(this.lastReportTime&&Hi()-this.lastReportTime<this.reportConfig.minInterval)){var n=this.getUploadMsg(),a=n.uploadMsgArr,i=n.uploadMsg;if(a.length){this.lastReportTime=Hi();try{var o,s=concat(o="".concat(this.dataReportEndpoint,"/")).call(o,this.dataReportPath);this.reportConfig.request(s,{dataType:"json",method:"POST",data:{common:this.reportConfig.common,event:i},headers:{sdktype:"im"},timeout:this.reportConfig.timeout}).catch((function(e){var t,n,i,o;r.cacheMsgList=slice(t=concat(n=r.cacheMsgList).call(n,a)).call(t,0,r.reportConfig.cacheMaxSize),null===(o=null===(i=r.reportConfig)||void 0===i?void 0:i.logger)||void 0===o||o.warn("Reporter upload failed",e)}))}catch(r){null===(t=null===(e=this.reportConfig)||void 0===e?void 0:e.logger)||void 0===t||t.warn("Exec reporter request failed",r)}clearTimeout(this.timer),this.reportHeartBeat()}}}}]),Reporter}();return a}()})),Is=entryVirtual("Array").values,Ss=Array.prototype,Ts={DOMTokenList:!0,NodeList:!0},values=function(e){var t=e.values;return e===Ss||x(Ss,e)&&t===Ss.values||Z(Ts,ur(e))?Is:t},Cs=$e.indexOf,bs=g([].indexOf),Es=!!bs&&1/bs([1],1,-0)<0,Rs=arrayMethodIsStrict("indexOf");_export({target:"Array",proto:!0,forced:Es||!Rs},{indexOf:function indexOf(e){var t=arguments.length>1?arguments[1]:void 0;return Es?bs(this,e,t)||0:Cs(this,e,t)}});var ks=entryVirtual("Array").indexOf,ws=Array.prototype,indexOf=function(e){var t=e.indexOf;return e===ws||x(ws,e)&&t===ws.indexOf?ks:t},As=Hr.every,Ns=arrayMethodIsStrict("every");_export({target:"Array",proto:!0,forced:!Ns},{every:function every(e){return As(this,e,arguments.length>1?arguments[1]:void 0)}});var xs=entryVirtual("Array").every,Os=Array.prototype,every=function(e){var t=e.every;return e===Os||x(Os,e)&&t===Os.every?xs:t};var Ps=fails((function(){if("function"==typeof ArrayBuffer){var e=new ArrayBuffer(8);Object.isExtensible(e)&&Object.defineProperty(e,"a",{value:8})}})),Ls=Object.isExtensible,Vs=fails((function(){Ls(1)}))||Ps?function isExtensible(e){return!!A(e)&&((!Ps||"ArrayBuffer"!=classofRaw(e))&&(!Ls||Ls(e)))}:Ls,Us=!fails((function(){return Object.isExtensible(Object.preventExtensions({}))})),Ds=createCommonjsModule((function(e){var t=Ae.f,r=!1,n=uid("meta"),a=0,setMetadata=function(e){t(e,n,{value:{objectID:"O"+a++,weakData:{}}})},i=e.exports={enable:function(){i.enable=function(){},r=!0;var e=kn.f,t=g([].splice),a={};a[n]=1,e(a).length&&(kn.f=function(r){for(var a=e(r),i=0,o=a.length;i<o;i++)if(a[i]===n){t(a,i,1);break}return a},_export({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:so.f}))},fastKey:function(e,t){if(!A(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!Z(e,n)){if(!Vs(e))return"F";if(!t)return"E";setMetadata(e)}return e[n].objectID},getWeakData:function(e,t){if(!Z(e,n)){if(!Vs(e))return!0;if(!t)return!1;setMetadata(e)}return e[n].weakData},onFreeze:function(e){return Us&&r&&Vs(e)&&!Z(e,n)&&setMetadata(e),e}};ze[n]=!0})),qs=Ae.f,Bs=Hr.forEach,Fs=zt.set,Gs=zt.getterFor,collection=function(e,t,r){var n,a=-1!==e.indexOf("Map"),o=-1!==e.indexOf("Weak"),s=a?"set":"add",c=i[e],l=c&&c.prototype,d={};if(v&&isCallable(c)&&(o||l.forEach&&!fails((function(){(new c).entries().next()})))){var u=(n=t((function(t,r){Fs(anInstance(t,u),{type:e,collection:new c}),null!=r&&iterate(r,t[s],{that:t,AS_ENTRIES:a})}))).prototype,p=Gs(e);Bs(["add","clear","delete","forEach","get","has","set","keys","values","entries"],(function(e){var t="add"==e||"set"==e;!(e in l)||o&&"clear"==e||Ne(u,e,(function(r,n){var a=p(this).collection;if(!t&&o&&!A(r))return"get"==e&&void 0;var i=a[e](0===r?0:r,n);return t?this:i}))})),o||qs(u,"size",{configurable:!0,get:function(){return p(this).collection.size}})}else n=r.getConstructor(t,e,a,s),Ds.enable();return setToStringTag(n,e,!1,!0),d[e]=n,_export({global:!0,forced:!0},d),o||r.setStrong(n,e,a),n},defineBuiltIns=function(e,t,r){for(var n in t)r&&r.unsafe&&e[n]?e[n]=t[n]:defineBuiltIn(e,n,t[n],r);return e},Hs=Ae.f,js=Ds.fastKey,$s=zt.set,zs=zt.getterFor,Ws={getConstructor:function(e,t,r,n){var a=e((function(e,a){anInstance(e,i),$s(e,{type:t,index:nt(null),first:void 0,last:void 0,size:0}),v||(e.size=0),isNullOrUndefined(a)||iterate(a,e[n],{that:e,AS_ENTRIES:r})})),i=a.prototype,o=zs(t),define=function(e,t,r){var n,a,i=o(e),s=getEntry(e,t);return s?s.value=r:(i.last=s={index:a=js(t,!0),key:t,value:r,previous:n=i.last,next:void 0,removed:!1},i.first||(i.first=s),n&&(n.next=s),v?i.size++:e.size++,"F"!==a&&(i.index[a]=s)),e},getEntry=function(e,t){var r,n=o(e),a=js(t);if("F"!==a)return n.index[a];for(r=n.first;r;r=r.next)if(r.key==t)return r};return defineBuiltIns(i,{clear:function clear(){for(var e=o(this),t=e.index,r=e.first;r;)r.removed=!0,r.previous&&(r.previous=r.previous.next=void 0),delete t[r.index],r=r.next;e.first=e.last=void 0,v?e.size=0:this.size=0},delete:function(e){var t=this,r=o(t),n=getEntry(t,e);if(n){var a=n.next,i=n.previous;delete r.index[n.index],n.removed=!0,i&&(i.next=a),a&&(a.previous=i),r.first==n&&(r.first=a),r.last==n&&(r.last=i),v?r.size--:t.size--}return!!n},forEach:function forEach(e){for(var t,r=o(this),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);t=t?t.next:r.first;)for(n(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function has(e){return!!getEntry(this,e)}}),defineBuiltIns(i,r?{get:function get(e){var t=getEntry(this,e);return t&&t.value},set:function set(e,t){return define(this,0===e?0:e,t)}}:{add:function add(e){return define(this,e=0===e?0:e,e)}}),v&&Hs(i,"size",{get:function(){return o(this).size}}),a},setStrong:function(e,t,r){var n=t+" Iterator",a=zs(t),i=zs(n);iteratorDefine(e,t,(function(e,t){$s(this,{type:n,target:e,state:a(e),kind:t,last:void 0})}),(function(){for(var e=i(this),t=e.kind,r=e.last;r&&r.removed;)r=r.previous;return e.target&&(e.last=r=r?r.next:e.state.first)?"keys"==t?{value:r.key,done:!1}:"values"==t?{value:r.value,done:!1}:{value:[r.key,r.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),r?"entries":"values",!r,!0),setSpecies(t)}};collection("Map",(function(e){return function Map(){return e(this,arguments.length?arguments[0]:void 0)}}),Ws);var Ks=N.Map,Ys=[].push,Qs=function from(e){var t,r,n,a,i=arguments.length,o=i>1?arguments[1]:void 0;return aConstructor(this),(t=void 0!==o)&&aCallable(o),isNullOrUndefined(e)?new this:(r=[],t?(n=0,a=functionBindContext(o,i>2?arguments[2]:void 0),iterate(e,(function(e){y(Ys,r,a(e,n++))}))):iterate(e,Ys,{that:r}),new this(r))};_export({target:"Map",stat:!0,forced:!0},{from:Qs});var Js=function of(){return new this(dt(arguments))};_export({target:"Map",stat:!0,forced:!0},{of:Js});var Xs=function deleteAll(){for(var e,t=anObject(this),r=aCallable(t.delete),n=!0,a=0,i=arguments.length;a<i;a++)e=y(r,t,arguments[a]),n=n&&e;return!!n};_export({target:"Map",proto:!0,real:!0,forced:!0},{deleteAll:Xs});_export({target:"Map",proto:!0,real:!0,forced:!0},{emplace:function emplace(e,t){var r,n,a=anObject(this),i=aCallable(a.get),o=aCallable(a.has),s=aCallable(a.set);return y(o,a,e)?(r=y(i,a,e),"update"in t&&(r=t.update(r,e,a),y(s,a,e,r)),r):(n=t.insert(e,a),y(s,a,e,n),n)}});var Zs=getIterator;_export({target:"Map",proto:!0,real:!0,forced:!0},{every:function every(e){var t=anObject(this),r=Zs(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);return!iterate(r,(function(e,r,a){if(!n(r,e,t))return a()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),_export({target:"Map",proto:!0,real:!0,forced:!0},{filter:function filter(e){var t=anObject(this),r=Zs(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0),a=new(speciesConstructor(t,getBuiltIn("Map"))),i=aCallable(a.set);return iterate(r,(function(e,r){n(r,e,t)&&y(i,a,e,r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),a}}),_export({target:"Map",proto:!0,real:!0,forced:!0},{find:function find(e){var t=anObject(this),r=Zs(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);return iterate(r,(function(e,r,a){if(n(r,e,t))return a(r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}}),_export({target:"Map",proto:!0,real:!0,forced:!0},{findKey:function findKey(e){var t=anObject(this),r=Zs(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);return iterate(r,(function(e,r,a){if(n(r,e,t))return a(e)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}});var ec=g([].push);_export({target:"Map",stat:!0,forced:!0},{groupBy:function groupBy(e,t){aCallable(t);var r=getIterator(e),n=new this,a=aCallable(n.has),i=aCallable(n.get),o=aCallable(n.set);return iterate(r,(function(e){var r=t(e);y(a,n,r)?ec(y(i,n,r),e):y(o,n,r,[e])}),{IS_ITERATOR:!0}),n}});_export({target:"Map",proto:!0,real:!0,forced:!0},{includes:function includes(e){return iterate(Zs(anObject(this)),(function(t,r,n){if((a=r)===(i=e)||a!=a&&i!=i)return n();var a,i}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),_export({target:"Map",stat:!0,forced:!0},{keyBy:function keyBy(e,t){var r=new this;aCallable(t);var n=aCallable(r.set);return iterate(e,(function(e){y(n,r,t(e),e)})),r}}),_export({target:"Map",proto:!0,real:!0,forced:!0},{keyOf:function keyOf(e){return iterate(Zs(anObject(this)),(function(t,r,n){if(r===e)return n(t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).result}}),_export({target:"Map",proto:!0,real:!0,forced:!0},{mapKeys:function mapKeys(e){var t=anObject(this),r=Zs(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0),a=new(speciesConstructor(t,getBuiltIn("Map"))),i=aCallable(a.set);return iterate(r,(function(e,r){y(i,a,n(r,e,t),r)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),a}}),_export({target:"Map",proto:!0,real:!0,forced:!0},{mapValues:function mapValues(e){var t=anObject(this),r=Zs(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0),a=new(speciesConstructor(t,getBuiltIn("Map"))),i=aCallable(a.set);return iterate(r,(function(e,r){y(i,a,e,n(r,e,t))}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),a}}),_export({target:"Map",proto:!0,real:!0,arity:1,forced:!0},{merge:function merge(e){for(var t=anObject(this),r=aCallable(t.set),n=arguments.length,a=0;a<n;)iterate(arguments[a++],r,{that:t,AS_ENTRIES:!0});return t}});var tc=TypeError;_export({target:"Map",proto:!0,real:!0,forced:!0},{reduce:function reduce(e){var t=anObject(this),r=Zs(t),n=arguments.length<2,a=n?void 0:arguments[1];if(aCallable(e),iterate(r,(function(r,i){n?(n=!1,a=i):a=e(a,i,r,t)}),{AS_ENTRIES:!0,IS_ITERATOR:!0}),n)throw tc("Reduce of empty map with no initial value");return a}}),_export({target:"Map",proto:!0,real:!0,forced:!0},{some:function some(e){var t=anObject(this),r=Zs(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);return iterate(r,(function(e,r,a){if(n(r,e,t))return a()}),{AS_ENTRIES:!0,IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}});var rc=TypeError;_export({target:"Map",proto:!0,real:!0,forced:!0},{update:function update(e,t){var r=anObject(this),n=aCallable(r.get),a=aCallable(r.has),i=aCallable(r.set),o=arguments.length;aCallable(t);var s=y(a,r,e);if(!s&&o<3)throw rc("Updating absent value");var c=s?y(n,r,e):aCallable(o>2?arguments[2]:void 0)(e,r);return y(i,r,e,t(c,e,r)),r}});var nc=TypeError,ac=function upsert(e,t){var r,n=anObject(this),a=aCallable(n.get),i=aCallable(n.has),o=aCallable(n.set),s=arguments.length>2?arguments[2]:void 0;if(!isCallable(t)&&!isCallable(s))throw nc("At least one callback required");return y(i,n,e)?(r=y(a,n,e),isCallable(t)&&(r=t(r),y(o,n,e,r))):isCallable(s)&&(r=s(),y(o,n,e,r)),r};_export({target:"Map",proto:!0,real:!0,forced:!0},{upsert:ac}),_export({target:"Map",proto:!0,real:!0,name:"upsert",forced:!0},{updateOrInsert:ac});var ic=Ks,oc=createCommonjsModule((function(e){function _getPrototypeOf(t){var r;return e.exports=_getPrototypeOf=lt?bind$1(r=jo).call(r):function _getPrototypeOf(e){return e.__proto__||jo(e)},e.exports.__esModule=!0,e.exports.default=e.exports,_getPrototypeOf(t)}e.exports=_getPrototypeOf,e.exports.__esModule=!0,e.exports.default=e.exports})),sc=createCommonjsModule((function(e){e.exports=function _isNativeFunction(e){var t;return-1!==indexOf(t=Function.toString.call(e)).call(t,"[native code]")},e.exports.__esModule=!0,e.exports.default=e.exports})),cc=getBuiltIn("Reflect","construct"),lc=Object.prototype,dc=[].push,uc=fails((function(){function F(){}return!(cc((function(){}),[],F)instanceof F)})),pc=!fails((function(){cc((function(){}))})),mc=uc||pc;_export({target:"Reflect",stat:!0,forced:mc,sham:mc},{construct:function construct(e,t){aConstructor(e),anObject(t);var r=arguments.length<3?e:aConstructor(arguments[2]);if(pc&&!uc)return cc(e,t,r);if(e==r){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var n=[null];return d(dc,n,t),new(d(gt,e,n))}var a=r.prototype,i=nt(A(a)?a:lc),o=d(e,i,t);return A(o)?o:i}});var hc=N.Reflect.construct,gc=createCommonjsModule((function(e){e.exports=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!hc)return!1;if(hc.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(hc(Boolean,[],(function(){}))),!0}catch(e){return!1}},e.exports.__esModule=!0,e.exports.default=e.exports})),vc=createCommonjsModule((function(e){function _construct(t,r,n){var a;gc()?(e.exports=_construct=bind$1(a=hc).call(a),e.exports.__esModule=!0,e.exports.default=e.exports):(e.exports=_construct=function _construct(e,t,r){var n=[null];n.push.apply(n,t);var a=new(bind$1(Function).apply(e,n));return r&&yt(a,r.prototype),a},e.exports.__esModule=!0,e.exports.default=e.exports);return _construct.apply(null,arguments)}e.exports=_construct,e.exports.__esModule=!0,e.exports.default=e.exports})),fc=createCommonjsModule((function(e){function _wrapNativeSuper(t){var r="function"==typeof ic?new ic:void 0;return e.exports=_wrapNativeSuper=function _wrapNativeSuper(e){if(null===e||!sc(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,Wrapper)}function Wrapper(){return vc(e,arguments,oc(this).constructor)}return Wrapper.prototype=it(e.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),yt(Wrapper,e)},e.exports.__esModule=!0,e.exports.default=e.exports,_wrapNativeSuper(t)}e.exports=_wrapNativeSuper,e.exports.__esModule=!0,e.exports.default=e.exports})),yc=getDefaultExportFromCjs(fc),_c=TypeError,createMethod$1=function(e){return function(t,r,n,a){aCallable(r);var i=toObject(t),o=R(i),s=lengthOfArrayLike(i),c=e?s-1:0,l=e?-1:1;if(n<2)for(;;){if(c in o){a=o[c],c+=l;break}if(c+=l,e?c<0:s<=c)throw _c("Reduce of empty array with no initial value")}for(;e?c>=0:s>c;c+=l)c in o&&(a=r(a,o[c],c,i));return a}},Mc={left:createMethod$1(!1),right:createMethod$1(!0)}.left,Ic=arrayMethodIsStrict("reduce");_export({target:"Array",proto:!0,forced:!Ic||!Zn&&D>79&&D<83},{reduce:function reduce(e){var t=arguments.length;return Mc(this,e,t,t>1?arguments[1]:void 0)}});var Sc,Tc,Cc,bc,Ec,Rc,kc,wc,Ac,Nc,xc,Oc,Pc,Lc,Vc,Uc,Dc,qc,Bc,Fc,Gc,Hc,jc,$c,zc,Wc,Kc,Yc,Qc,Jc,Xc,Zc,el,tl,rl,nl,al,il,ol,sl,cl,ll,dl,ul,pl,ml,hl,gl=entryVirtual("Array").reduce,vl=Array.prototype,reduce=function(e){var t=e.reduce;return e===vl||x(vl,e)&&t===vl.reduce?gl:t};!function(e){e[e.V2NIM_DATA_SYNC_TYPE_LEVEL_FULL=0]="V2NIM_DATA_SYNC_TYPE_LEVEL_FULL",e[e.V2NIM_DATA_SYNC_TYPE_LEVEL_BASIC=1]="V2NIM_DATA_SYNC_TYPE_LEVEL_BASIC"}(Sc||(Sc={})),function(e){e[e.V2NIM_DATA_SYNC_TYPE_MAIN=1]="V2NIM_DATA_SYNC_TYPE_MAIN",e[e.V2NIM_DATA_SYNC_TYPE_TEAM_MEMBER=2]="V2NIM_DATA_SYNC_TYPE_TEAM_MEMBER",e[e.V2NIM_DATA_SYNC_TYPE_SUPER_TEAM_MEMBER=3]="V2NIM_DATA_SYNC_TYPE_SUPER_TEAM_MEMBER"}(Tc||(Tc={})),function(e){e[e.V2NIM_DATA_SYNC_STATE_WAITING=1]="V2NIM_DATA_SYNC_STATE_WAITING",e[e.V2NIM_DATA_SYNC_STATE_SYNCING=2]="V2NIM_DATA_SYNC_STATE_SYNCING",e[e.V2NIM_DATA_SYNC_STATE_COMPLETED=3]="V2NIM_DATA_SYNC_STATE_COMPLETED"}(Cc||(Cc={})),function(e){e[e.V2NIM_CONVERSATION_TYPE_UNKNOWN=0]="V2NIM_CONVERSATION_TYPE_UNKNOWN",e[e.V2NIM_CONVERSATION_TYPE_P2P=1]="V2NIM_CONVERSATION_TYPE_P2P",e[e.V2NIM_CONVERSATION_TYPE_TEAM=2]="V2NIM_CONVERSATION_TYPE_TEAM",e[e.V2NIM_CONVERSATION_TYPE_SUPER_TEAM=3]="V2NIM_CONVERSATION_TYPE_SUPER_TEAM"}(bc||(bc={})),function(e){e[e.V2NIM_MESSAGE_STATUS_DEFAULT=0]="V2NIM_MESSAGE_STATUS_DEFAULT",e[e.V2NIM_MESSAGE_STATUS_REVOKE=1]="V2NIM_MESSAGE_STATUS_REVOKE",e[e.V2NIM_MESSAGE_STATUS_BACKFILL=2]="V2NIM_MESSAGE_STATUS_BACKFILL"}(Ec||(Ec={})),function(e){e[e.V2NIM_FRIEND_MODE_TYPE_ADD=1]="V2NIM_FRIEND_MODE_TYPE_ADD",e[e.V2NIM_FRIEND_MODE_TYPE_APPLY=2]="V2NIM_FRIEND_MODE_TYPE_APPLY"}(Rc||(Rc={})),function(e){e[e.V2NIM_FRIEND_ADD_APPLICATION_TYPE_RECEIVED=1]="V2NIM_FRIEND_ADD_APPLICATION_TYPE_RECEIVED",e[e.V2NIM_FRIEND_ADD_APPLICATION_TYPE_REJECTED=2]="V2NIM_FRIEND_ADD_APPLICATION_TYPE_REJECTED"}(kc||(kc={})),function(e){e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT=0]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_INIT",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED=1]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_AGREED",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED=2]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_REJECTED",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED=3]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_EXPIRED",e[e.V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD=4]="V2NIM_FRIEND_ADD_APPLICATION_STATUS_DIRECT_ADD"}(wc||(wc={})),function(e){e[e.V2NIM_FRIEND_DELETION_TYPE_BY_SELF=1]="V2NIM_FRIEND_DELETION_TYPE_BY_SELF",e[e.V2NIM_FRIEND_DELETION_TYPE_BY_PEER=2]="V2NIM_FRIEND_DELETION_TYPE_BY_PEER"}(Ac||(Ac={})),function(e){e[e.V2NIM_FRIEND_VERIFY_TYPE_ADD=1]="V2NIM_FRIEND_VERIFY_TYPE_ADD",e[e.V2NIM_FRIEND_VERIFY_TYPE_APPLY=2]="V2NIM_FRIEND_VERIFY_TYPE_APPLY",e[e.V2NIM_FRIEND_VERIFY_TYPE_ACCEPT=3]="V2NIM_FRIEND_VERIFY_TYPE_ACCEPT",e[e.V2NIM_FRIEND_VERIFY_TYPE_REJECT=4]="V2NIM_FRIEND_VERIFY_TYPE_REJECT"}(Nc||(Nc={})),function(e){e[e.V2NIM_LOGIN_AUTH_TYPE_DEFAULT=0]="V2NIM_LOGIN_AUTH_TYPE_DEFAULT",e[e.V2NIM_LOGIN_AUTH_TYPE_DYNAMIC_TOKEN=1]="V2NIM_LOGIN_AUTH_TYPE_DYNAMIC_TOKEN",e[e.V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY=2]="V2NIM_LOGIN_AUTH_TYPE_THIRD_PARTY"}(xc||(xc={})),function(e){e[e.V2NIM_LOGIN_STATUS_LOGOUT=0]="V2NIM_LOGIN_STATUS_LOGOUT",e[e.V2NIM_LOGIN_STATUS_LOGINED=1]="V2NIM_LOGIN_STATUS_LOGINED",e[e.V2NIM_LOGIN_STATUS_LOGINING=2]="V2NIM_LOGIN_STATUS_LOGINING",e[e.V2NIM_LOGIN_STATUS_UNLOGIN=3]="V2NIM_LOGIN_STATUS_UNLOGIN"}(Oc||(Oc={})),function(e){e[e.V2NIM_LOGIN_CLIENT_TYPE_UNKNOWN=0]="V2NIM_LOGIN_CLIENT_TYPE_UNKNOWN",e[e.V2NIM_LOGIN_CLIENT_TYPE_ANDROID=1]="V2NIM_LOGIN_CLIENT_TYPE_ANDROID",e[e.V2NIM_LOGIN_CLIENT_TYPE_IOS=2]="V2NIM_LOGIN_CLIENT_TYPE_IOS",e[e.V2NIM_LOGIN_CLIENT_TYPE_PC=4]="V2NIM_LOGIN_CLIENT_TYPE_PC",e[e.V2NIM_LOGIN_CLIENT_TYPE_WP=8]="V2NIM_LOGIN_CLIENT_TYPE_WP",e[e.V2NIM_LOGIN_CLIENT_TYPE_WEB=16]="V2NIM_LOGIN_CLIENT_TYPE_WEB",e[e.V2NIM_LOGIN_CLIENT_TYPE_RESTFUL=32]="V2NIM_LOGIN_CLIENT_TYPE_RESTFUL",e[e.V2NIM_LOGIN_CLIENT_TYPE_MAC_OS=64]="V2NIM_LOGIN_CLIENT_TYPE_MAC_OS",e[e.V2NIM_LOGIN_CLIENT_TYPE_HARMONY_OS=65]="V2NIM_LOGIN_CLIENT_TYPE_HARMONY_OS"}(Pc||(Pc={})),function(e){e[e.V2NIM_KICKED_OFFLINE_REASON_CLIENT_EXCLUSIVE=1]="V2NIM_KICKED_OFFLINE_REASON_CLIENT_EXCLUSIVE",e[e.V2NIM_KICKED_OFFLINE_REASON_SERVER=2]="V2NIM_KICKED_OFFLINE_REASON_SERVER",e[e.V2NIM_KICKED_OFFLINE_REASON_CLIENT=3]="V2NIM_KICKED_OFFLINE_REASON_CLIENT",e[e.V2NIM_KICKED_OFFLINE_REASON_CLIENT_QUIETLY=4]="V2NIM_KICKED_OFFLINE_REASON_CLIENT_QUIETLY"}(Lc||(Lc={})),function(e){e[e.V2NIM_LOGIN_CLIENT_CHANGE_LIST=1]="V2NIM_LOGIN_CLIENT_CHANGE_LIST",e[e.V2NIM_LOGIN_CLIENT_CHANGE_LOGIN=2]="V2NIM_LOGIN_CLIENT_CHANGE_LOGIN",e[e.V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT=3]="V2NIM_LOGIN_CLIENT_CHANGE_LOGOUT"}(Vc||(Vc={})),function(e){e[e.V2NIM_CONNECT_STATUS_DISCONNECTED=0]="V2NIM_CONNECT_STATUS_DISCONNECTED",e[e.V2NIM_CONNECT_STATUS_CONNECTED=1]="V2NIM_CONNECT_STATUS_CONNECTED",e[e.V2NIM_CONNECT_STATUS_CONNECTING=2]="V2NIM_CONNECT_STATUS_CONNECTING",e[e.V2NIM_CONNECT_STATUS_WAITING=3]="V2NIM_CONNECT_STATUS_WAITING"}(Uc||(Uc={})),function(e){e[e.V2NIM_MESSAGE_AI_STATUS_UNKNOW=0]="V2NIM_MESSAGE_AI_STATUS_UNKNOW",e[e.V2NIM_MESSAGE_AI_STATUS_AT=1]="V2NIM_MESSAGE_AI_STATUS_AT",e[e.V2NIM_MESSAGE_AI_STATUS_RESPONSE=2]="V2NIM_MESSAGE_AI_STATUS_RESPONSE"}(Dc||(Dc={})),function(e){e[e.V2NIM_MESSAGE_TYPE_INVALID=-1]="V2NIM_MESSAGE_TYPE_INVALID",e[e.V2NIM_MESSAGE_TYPE_TEXT=0]="V2NIM_MESSAGE_TYPE_TEXT",e[e.V2NIM_MESSAGE_TYPE_IMAGE=1]="V2NIM_MESSAGE_TYPE_IMAGE",e[e.V2NIM_MESSAGE_TYPE_AUDIO=2]="V2NIM_MESSAGE_TYPE_AUDIO",e[e.V2NIM_MESSAGE_TYPE_VIDEO=3]="V2NIM_MESSAGE_TYPE_VIDEO",e[e.V2NIM_MESSAGE_TYPE_LOCATION=4]="V2NIM_MESSAGE_TYPE_LOCATION",e[e.V2NIM_MESSAGE_TYPE_NOTIFICATION=5]="V2NIM_MESSAGE_TYPE_NOTIFICATION",e[e.V2NIM_MESSAGE_TYPE_FILE=6]="V2NIM_MESSAGE_TYPE_FILE",e[e.V2NIM_MESSAGE_TYPE_AVCHAT=7]="V2NIM_MESSAGE_TYPE_AVCHAT",e[e.V2NIM_MESSAGE_TYPE_TIPS=10]="V2NIM_MESSAGE_TYPE_TIPS",e[e.V2NIM_MESSAGE_TYPE_ROBOT=11]="V2NIM_MESSAGE_TYPE_ROBOT",e[e.V2NIM_MESSAGE_TYPE_CALL=12]="V2NIM_MESSAGE_TYPE_CALL",e[e.V2NIM_MESSAGE_TYPE_CUSTOM=100]="V2NIM_MESSAGE_TYPE_CUSTOM"}(qc||(qc={})),function(e){e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED=-1]="V2NIM_MESSAGE_NOTIFICATION_TYPE_UNDEFINED",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE=0]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK=1]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_KICK",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE=2]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_LEAVE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO=3]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_UPDATE_TINFO",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS=4]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_DISMISS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS=5]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_APPLY_PASS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER=6]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_OWNER_TRANSFER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER=7]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_ADD_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER=8]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_REMOVE_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT=9]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_INVITE_ACCEPT",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER=10]="V2NIM_MESSAGE_NOTIFICATION_TYPE_TEAM_BANNED_TEAM_MEMBER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE=401]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK=402]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_KICK",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE=403]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_LEAVE",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO=404]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_UPDATE_TINFO",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS=405]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_DISMISS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS=410]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_APPLY_PASS",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER=406]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_OWNER_TRANSFER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER=407]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_ADD_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER=408]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_REMOVE_MANAGER",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT=411]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_INVITE_ACCEPT",e[e.V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER=409]="V2NIM_MESSAGE_NOTIFICATION_TYPE_SUPER_TEAM_BANNED_TEAM_MEMBER"}(Bc||(Bc={})),function(e){e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN=0]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UNKNOWN",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS=1]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_SUCCESS",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED=2]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_FAILED",e[e.V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING=3]="V2NIM_MESSAGE_ATTACHMENT_UPLOAD_STATE_UPLOADING"}(Fc||(Fc={})),function(e){e[e.V2NIM_MESSAGE_SENDING_STATE_UNKNOWN=0]="V2NIM_MESSAGE_SENDING_STATE_UNKNOWN",e[e.V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED=1]="V2NIM_MESSAGE_SENDING_STATE_SUCCEEDED",e[e.V2NIM_MESSAGE_SENDING_STATE_FAILED=2]="V2NIM_MESSAGE_SENDING_STATE_FAILED",e[e.V2NIM_MESSAGE_SENDING_STATE_SENDING=3]="V2NIM_MESSAGE_SENDING_STATE_SENDING"}(Gc||(Gc={})),function(e){e[e.V2NIM_QUERY_DIRECTION_DESC=0]="V2NIM_QUERY_DIRECTION_DESC",e[e.V2NIM_QUERY_DIRECTION_ASC=1]="V2NIM_QUERY_DIRECTION_ASC"}(Hc||(Hc={})),function(e){e[e.V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED=0]="V2NIM_MESSAGE_REVOKE_TYPE_UNDEFINED",e[e.V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY=1]="V2NIM_MESSAGE_REVOKE_TYPE_P2P_BOTHWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY=2]="V2NIM_MESSAGE_REVOKE_TYPE_TEAM_BOTHWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY=3]="V2NIM_MESSAGE_REVOKE_TYPE_SUPERTEAM_BOTHWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY=4]="V2NIM_MESSAGE_REVOKE_TYPE_P2P_ONEWAY",e[e.V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY=5]="V2NIM_MESSAGE_REVOKE_TYPE_TEAM_ONEWAY"}(jc||(jc={})),function(e){e[e.V2NIM_MESSAGE_PIN_STATE_NOT_PINNED=0]="V2NIM_MESSAGE_PIN_STATE_NOT_PINNED",e[e.V2NIM_MESSAGE_PIN_STATE_PINNED=1]="V2NIM_MESSAGE_PIN_STATE_PINNED",e[e.V2NIM_MESSAGE_PIN_STATE_UPDATED=2]="V2NIM_MESSAGE_PIN_STATE_UPDATED"}($c||($c={})),function(e){e[e.V2NIM_QUICK_COMMENT_STATE_ADD=1]="V2NIM_QUICK_COMMENT_STATE_ADD",e[e.V2NIM_QUICK_COMMENT_STATE_REMOVE=2]="V2NIM_QUICK_COMMENT_STATE_REMOVE"}(zc||(zc={})),function(e){e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_NONE=0]="V2NIM_CLIENT_ANTISPAM_OPERATE_NONE",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE=1]="V2NIM_CLIENT_ANTISPAM_OPERATE_REPLACE",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD=2]="V2NIM_CLIENT_ANTISPAM_OPERATE_CLIENT_SHIELD",e[e.V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD=3]="V2NIM_CLIENT_ANTISPAM_OPERATE_SERVER_SHIELD"}(Wc||(Wc={})),function(e){e[e.V2NIM_SORT_ORDER_DESC=0]="V2NIM_SORT_ORDER_DESC",e[e.V2NIM_SORT_ORDER_ASC=1]="V2NIM_SORT_ORDER_ASC"}(Kc||(Kc={})),function(e){e[e.P2P_DELETE_MSG=7]="P2P_DELETE_MSG",e[e.TEAM_DELETE_MSG=8]="TEAM_DELETE_MSG",e[e.SUPERTEAM_DELETE_MSG=12]="SUPERTEAM_DELETE_MSG",e[e.P2P_ONE_WAY_DELETE_MSG=13]="P2P_ONE_WAY_DELETE_MSG",e[e.TEAM_ONE_WAY_DELETE_MSG=14]="TEAM_ONE_WAY_DELETE_MSG",e[e.CUSTOM_P2P_MSG=100]="CUSTOM_P2P_MSG",e[e.CUSTOM_TEAM_MSG=101]="CUSTOM_TEAM_MSG",e[e.CUSTOM_SUPERTEAM_MSG=103]="CUSTOM_SUPERTEAM_MSG"}(Yc||(Yc={})),function(e){e[e.V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF=0]="V2NIM_TEAM_MESSAGE_MUTE_MODE_OFF",e[e.V2NIM_TEAM_MESSAGE_MUTE_MODE_ON=1]="V2NIM_TEAM_MESSAGE_MUTE_MODE_ON",e[e.V2NIM_TEAM_MESSAGE_MUTE_MODE_NORMAL_ON=2]="V2NIM_TEAM_MESSAGE_MUTE_MODE_NORMAL_ON"}(Qc||(Qc={})),function(e){e[e.V2NIM_P2P_MESSAGE_MUTE_MODE_OFF=0]="V2NIM_P2P_MESSAGE_MUTE_MODE_OFF",e[e.V2NIM_P2P_MESSAGE_MUTE_MODE_ON=1]="V2NIM_P2P_MESSAGE_MUTE_MODE_ON"}(Jc||(Jc={})),function(e){e[e.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_ALL=0]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_ALL",e[e.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_NORMAL=1]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_NORMAL",e[e.V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_MANAGER=2]="V2NIM_TEAM_MEMBER_ROLE_QUERY_TYPE_MANAGER"}(Xc||(Xc={})),function(e){e[e.V2NIM_TEAM_TYPE_INVALID=0]="V2NIM_TEAM_TYPE_INVALID",e[e.V2NIM_TEAM_TYPE_ADVANCED=1]="V2NIM_TEAM_TYPE_ADVANCED",e[e.V2NIM_TEAM_TYPE_SUPER=2]="V2NIM_TEAM_TYPE_SUPER"}(Zc||(Zc={})),function(e){e[e.V2NIM_TEAM_JOIN_MODE_FREE=0]="V2NIM_TEAM_JOIN_MODE_FREE",e[e.V2NIM_TEAM_JOIN_MODE_APPLY=1]="V2NIM_TEAM_JOIN_MODE_APPLY",e[e.V2NIM_TEAM_JOIN_MODE_INVITE=2]="V2NIM_TEAM_JOIN_MODE_INVITE"}(el||(el={})),function(e){e[e.V2NIM_TEAM_AGREE_MODE_AUTH=0]="V2NIM_TEAM_AGREE_MODE_AUTH",e[e.V2NIM_TEAM_AGREE_MODE_NO_AUTH=1]="V2NIM_TEAM_AGREE_MODE_NO_AUTH"}(tl||(tl={})),function(e){e[e.V2NIM_TEAM_INVITE_MODE_MANAGER=0]="V2NIM_TEAM_INVITE_MODE_MANAGER",e[e.V2NIM_TEAM_INVITE_MODE_ALL=1]="V2NIM_TEAM_INVITE_MODE_ALL"}(rl||(rl={})),function(e){e[e.V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER=0]="V2NIM_TEAM_UPDATE_INFO_MODE_MANAGER",e[e.V2NIM_TEAM_UPDATE_INFO_MODE_ALL=1]="V2NIM_TEAM_UPDATE_INFO_MODE_ALL"}(nl||(nl={})),function(e){e[e.V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN=0]="V2NIM_TEAM_CHAT_BANNED_MODE_UNBAN",e[e.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL=1]="V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_NORMAL",e[e.V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_ALL=2]="V2NIM_TEAM_CHAT_BANNED_MODE_BANNED_ALL"}(al||(al={})),function(e){e[e.V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER=0]="V2NIM_TEAM_UPDATE_EXTENSION_MODE_MANAGER",e[e.V2NIM_TEAM_UPDATE_EXTENSION_MODE_ALL=1]="V2NIM_TEAM_UPDATE_EXTENSION_MODE_ALL"}(il||(il={})),function(e){e[e.V2NIM_TEAM_MEMBER_ROLE_NORMAL=0]="V2NIM_TEAM_MEMBER_ROLE_NORMAL",e[e.V2NIM_TEAM_MEMBER_ROLE_OWNER=1]="V2NIM_TEAM_MEMBER_ROLE_OWNER",e[e.V2NIM_TEAM_MEMBER_ROLE_MANAGER=2]="V2NIM_TEAM_MEMBER_ROLE_MANAGER"}(ol||(ol={})),function(e){e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION=0]="V2NIM_TEAM_JOIN_ACTION_TYPE_APPLICATION",e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION=1]="V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_APPLICATION",e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION=2]="V2NIM_TEAM_JOIN_ACTION_TYPE_INVITATION",e[e.V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION=3]="V2NIM_TEAM_JOIN_ACTION_TYPE_REJECT_INVITATION"}(sl||(sl={})),function(e){e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_INIT=0]="V2NIM_TEAM_JOIN_ACTION_STATUS_INIT",e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED=1]="V2NIM_TEAM_JOIN_ACTION_STATUS_AGREED",e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED=2]="V2NIM_TEAM_JOIN_ACTION_STATUS_REJECTED",e[e.V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED=3]="V2NIM_TEAM_JOIN_ACTION_STATUS_EXPIRED"}(cl||(cl={})),function(e){e[e.teamApply=0]="teamApply",e[e.teamApplyReject=1]="teamApplyReject",e[e.teamInvite=2]="teamInvite",e[e.teamInviteReject=3]="teamInviteReject",e[e.tlistUpdate=4]="tlistUpdate",e[e.superTeamApply=15]="superTeamApply",e[e.superTeamApplyReject=16]="superTeamApplyReject",e[e.superTeamInvite=17]="superTeamInvite",e[e.superTeamInviteReject=18]="superTeamInviteReject"}(ll||(ll={})),function(e){e[e.V2NIM_AI_MODEL_TYPE_UNKNOW=0]="V2NIM_AI_MODEL_TYPE_UNKNOW",e[e.V2NIM_AI_MODEL_TYPE_QWEN=1]="V2NIM_AI_MODEL_TYPE_QWEN",e[e.V2NIM_AI_MODEL_TYPE_AZURE=2]="V2NIM_AI_MODEL_TYPE_AZURE",e[e.V2NIM_AI_MODEL_TYPE_PRIVATE=3]="V2NIM_AI_MODEL_TYPE_PRIVATE"}(dl||(dl={})),function(e){e.V2NIM_AI_MODEL_ROLE_TYPE_SYSTEM="system",e.V2NIM_AI_MODEL_ROLE_TYPE_USER="user",e.V2NIM_AI_MODEL_ROLE_TYPE_ASSISTANT="assistant"}(ul||(ul={})),function(e){e[e.V2NIM_SIGNALLING_EVENT_TYPE_UNKNOWN=0]="V2NIM_SIGNALLING_EVENT_TYPE_UNKNOWN",e[e.V2NIM_SIGNALLING_EVENT_TYPE_CLOSE=1]="V2NIM_SIGNALLING_EVENT_TYPE_CLOSE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_JOIN=2]="V2NIM_SIGNALLING_EVENT_TYPE_JOIN",e[e.V2NIM_SIGNALLING_EVENT_TYPE_INVITE=3]="V2NIM_SIGNALLING_EVENT_TYPE_INVITE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE=4]="V2NIM_SIGNALLING_EVENT_TYPE_CANCEL_INVITE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_REJECT=5]="V2NIM_SIGNALLING_EVENT_TYPE_REJECT",e[e.V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT=6]="V2NIM_SIGNALLING_EVENT_TYPE_ACCEPT",e[e.V2NIM_SIGNALLING_EVENT_TYPE_LEAVE=7]="V2NIM_SIGNALLING_EVENT_TYPE_LEAVE",e[e.V2NIM_SIGNALLING_EVENT_TYPE_CONTROL=8]="V2NIM_SIGNALLING_EVENT_TYPE_CONTROL"}(pl||(pl={})),function(e){e[e.V2NIM_SIGNALLING_CHANNEL_TYPE_AUDIO=1]="V2NIM_SIGNALLING_CHANNEL_TYPE_AUDIO",e[e.V2NIM_SIGNALLING_CHANNEL_TYPE_VIDEO=2]="V2NIM_SIGNALLING_CHANNEL_TYPE_VIDEO",e[e.V2NIM_SIGNALLING_CHANNEL_TYPE_CUSTOM=3]="V2NIM_SIGNALLING_CHANNEL_TYPE_CUSTOM"}(ml||(ml={})),function(e){e[e.V2NIM_USER_STATUS_TYPE_UNKNOWN=0]="V2NIM_USER_STATUS_TYPE_UNKNOWN",e[e.V2NIM_USER_STATUS_TYPE_LOGIN=1]="V2NIM_USER_STATUS_TYPE_LOGIN",e[e.V2NIM_USER_STATUS_TYPE_LOGOUT=2]="V2NIM_USER_STATUS_TYPE_LOGOUT",e[e.V2NIM_USER_STATUS_TYPE_DISCONNECT=3]="V2NIM_USER_STATUS_TYPE_DISCONNECT"}(hl||(hl={}));var fl={V2NIM_ERROR_CODE_UNKNOWN:{code:0,message:"unknown error"},V2NIM_ERROR_CODE_SUCCESS:{code:200,message:"success"},V2NIM_ERROR_CODE_HANDSHAKE:{code:201,message:"handshake error"},V2NIM_ERROR_CODE_REQUEST_TEMPERARY_FORBIDDEN:{code:398,message:"request temprary forbidden"},V2NIM_ERROR_CODE_SERVER_UNIT_ERROR:{code:399,message:"server unit error"},V2NIM_ERROR_CODE_FORBIDDEN:{code:403,message:"forbidden"},V2NIM_ERROR_CODE_NOT_FOUND:{code:404,message:"not found"},V2NIM_ERROR_CODE_PARAMETER_ERROR:{code:414,message:"parameter error"},V2NIM_ERROR_CODE_RATE_LIMIT_REACHED:{code:416,message:"rate limit reached"},V2NIM_ERROR_CODE_MULTI_LOGIN_FORBIDDEN:{code:417,message:"multi login forbidden"},V2NIM_ERROR_CODE_SERVER_INTERNAL_ERROR:{code:500,message:"server internal error"},V2NIM_ERROR_CODE_SERVER_BUSY:{code:503,message:"server busy"},V2NIM_ERROR_CODE_APP_UNREACHABLE:{code:511,message:"app server unreachable"},V2NIM_ERROR_CODE_SERVICE_UNAVAILABLE:{code:514,message:"service unavailable"},V2NIM_ERROR_CODE_PROTOCOL_BLACKHOLE_FILTERED:{code:599,message:"protocol filtered by blackhole rule"},V2NIM_ERROR_CODE_NO_PERMISSION:{code:997,message:"appid has no permission to call the protocol"},V2NIM_ERROR_CODE_UNPACK_ERROR:{code:998,message:"unpack error"},V2NIM_ERROR_CODE_PACK_ERROR:{code:999,message:"pack error"},V2NIM_ERROR_CODE_IM_DISABLED:{code:101301,message:"IM disabled"},V2NIM_ERROR_CODE_SERVICE_ADDRESS_INVALID:{code:101302,message:"service address invalid"},V2NIM_ERROR_CODE_APPKEY_NOT_EXIST:{code:101303,message:"appkey not exist"},V2NIM_ERROR_CODE_BUNDLEID_CHECK_FAILED:{code:101304,message:"bundleid check failed"},V2NIM_ERROR_CODE_APPKEY_BLOCKED:{code:101403,message:"appkey blocked"},V2NIM_ERROR_CODE_INVALID_TOKEN:{code:102302,message:"invalid token"},V2NIM_ERROR_CODE_ROBOT_NOT_ALLOWED:{code:102303,message:"robot not allowed"},V2NIM_ERROR_CODE_ACCOUNT_NOT_EXIST:{code:102404,message:"account not exist"},V2NIM_ERROR_CODE_ACCOUNT_CHAT_BANNED:{code:102421,message:"account chat banned"},V2NIM_ERROR_CODE_ACCOUNT_BANNED:{code:102422,message:"account banned"},V2NIM_ERROR_CODE_ACCOUNT_IN_BLOCK_LIST:{code:102426,message:"account in block list"},V2NIM_ERROR_CODE_USER_PROFILE_NOT_EXIST:{code:103404,message:"user profile not exist"},V2NIM_ERROR_CODE_USER_PROFILE_HIT_ANTISPAM:{code:103451,message:"user profile hit antispam"},V2NIM_ERROR_CODE_PEER_FRIEND_LIMIT:{code:104301,message:"peer friend limit"},V2NIM_ERROR_CODE_FRIEND_APPLICATION_NOT_EXIST:{code:104302,message:"friend application not exist"},V2NIM_ERROR_CODE_FRIEND_NOT_EXIST:{code:104404,message:"friend not exist"},V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST:{code:104405,message:"friend already exist"},V2NIM_ERROR_CODE_SELF_FRIEND_OPERATION_NOT_ALLOWED:{code:104429,message:"self friend operation not allowed"},V2NIM_ERROR_CODE_FRIEND_LIMIT:{code:104435,message:"friend limit"},V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT:{code:104449,message:"friend operation rate limit"},V2NIM_ERROR_CODE_FRIEND_HIT_ANTISPAM:{code:104451,message:"friend hit antispam"},V2NIM_ERROR_CODE_SELF_MUTE_OPERATION_NOT_ALLOWED:{code:105429,message:"self mute operation not allowed"},V2NIM_ERROR_CODE_MUTE_LIST_LIMIT:{code:105435,message:"mute list limit"},V2NIM_ERROR_CODE_SELF_BLOCK_LIST_OPERATION_NOT_ALLOWED:{code:106429,message:"self block list operation not allowed"},V2NIM_ERROR_CODE_BLOCK_LIST_LIMIT:{code:106435,message:"block list limit"},V2NIM_ERROR_CODE_REVOKE_THIRD_PARTY_MESSAGE_NOT_ALLOWED:{code:107301,message:"revoke third party message not allowed"},V2NIM_ERROR_CODE_SHORT_TO_LONG_URL_FAILED:{code:107307,message:"short to long URL failed"},V2NIM_ERROR_CODE_URL_INVALID:{code:107308,message:"URL invalid"},V2NIM_ERROR_CODE_DURATION_OUT_OF_RANGE:{code:107309,message:"duration out of range"},V2NIM_ERROR_CODE_GET_FILE_META_INFO_FAILED:{code:107310,message:"get file meta info failed"},V2NIM_ERROR_CODE_AUDIO_FILE_SIZE_LIMIT:{code:107311,message:"audio file size limit"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_TIMEOUT:{code:107312,message:"voice to text timeout"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_FAILED:{code:107313,message:"voice to text failed"},V2NIM_ERROR_CODE_REVOKE_EXCEED_TIME_LIMIT:{code:107314,message:"revoke message exceed time limit"},V2NIM_ERROR_CODE_REVOKE_MESSAGE_NOT_ALLOWED:{code:107315,message:"revoke specific message not allowed"},V2NIM_ERROR_CODE_FORCE_PUSH_LIST_LIMIT:{code:107316,message:"force push list limit"},V2NIM_ERROR_CODE_TEAM_MESSAGE_RECEIPT_RATE_LIMIT:{code:107317,message:"team message receipt rate limit"},V2NIM_ERROR_CODE_SNAPSHOT_NOT_EXIST:{code:107318,message:"snapshot not exist"},V2NIM_ERROR_CODE_PIN_LIMIT:{code:107319,message:"pin limit"},V2NIM_ERROR_CODE_PIN_NOT_EXIST:{code:107320,message:"pin not exist"},V2NIM_ERROR_CODE_QUICK_COMMENT_LIMIT:{code:107321,message:"quick comment limit"},V2NIM_ERROR_CODE_PIN_ALREADY_EXIST:{code:107322,message:"pin already exist"},V2NIM_ERROR_CODE_VOICE_TO_TEXT_FUNCTION_DISABLED:{code:107333,message:"voice to text function disabled"},V2NIM_ERROR_CODE_CLOUD_SEARCH_FUNCTION_DISABLED:{code:107334,message:"cloud search function disabled"},V2NIM_ERROR_CODE_ONE_WAY_DELETE_FUNCTION_DISABLED:{code:107335,message:"one-way delete function disabled"},V2NIM_ERRPR_CODE_ONEWAY_DELETION_NOT_ALLOW_FOR_TARGET_MESSAGES:{code:107338,message:"one-way deletion is not allowed for target messages"},V2NIM_ERRPR_CODE_SENDER_CANNOT_INCLUDED_IN_TARGET_LIST:{code:107339,message:"The message sender cannot be included in the target list"},V2NIM_ERROR_CODE_ROBOT_CANNOT_SEND_TARGET_MESSAGE:{code:107340,message:"Robot can not send target message"},V2NIM_ERROR_CODE_PIN_TARGET_MESSAGE_NOT_ALLOWED:{code:107345,message:"Pin target message is not allowed"},V2NIM_ERROR_CODE_TARGET_MESSAGE_NOT_ALLOWED_REPLY:{code:107346,message:"Target message not allowed reply"},V2NIM_ERROR_CODE_TARGET_MESSAGE_NOT_ALLOWED_QUICK_COMMENT:{code:107347,message:"Target message not allowed quick comment"},V2NIM_ERROR_CODE_REVOKE_MESSAGE_TO_SELF_NOT_ALLOWED:{code:107429,message:"revoke message to self not allowed"},V2NIM_ERROR_CODE_APP_CHAT_BANNED:{code:107410,message:"app chat banned"},V2NIM_ERROR_CODE_QUICK_COMMENT_FUNCTION_DISABLED:{code:107326,message:"quick comment function disabled"},V2NIM_ERROR_CODE_PIN_FUNCTION_DISABLED:{code:107327,message:"PIN function disabled"},V2NIM_ERROR_CODE_TEAM_READ_RECEIPT_FUNCTION_DISABLED:{code:107324,message:"read receipt for team messages function disabled"},V2NIM_ERROR_CODE_P2P_READ_RECEIPT_FUNCTION_DISABLED:{code:107325,message:"read receipt for p2p messages function disabled"},V2NIM_ERROR_CODE_RATE_LIMIT_FOR_MESSAGING_REACHED:{code:107323,message:"rate limit for messaging reached"},V2NIM_ERROR_CODE_MESSAGE_HIT_ANTISPAM:{code:107451,message:"message hit antispam"},V2NIM_ERROR_CODE_MESSAGE_NOT_EXIST:{code:107404,message:"message not exist"},V2NIM_ERROR_CODE_UNSENDING_MESSAGE_EXPIRED:{code:107406,message:"unsending message expired"},V2NIM_ERROR_CODE_TEAM_MARK_READ_FAILED:{code:107302,message:"sending message failed for marking message read failed for too many team members"},V2NIM_ERROR_CODE_SENDER_OR_MANAGER_PERMISSION_ONLY_REVOKE:{code:107303,message:"only sender or manager can revoke message"},V2NIM_ERROR_CODE_DELETE_SELF_MESSAGE_NOT_ALLOWED:{code:107328,message:"delete self message not allowed"},V2NIM_ERROR_CODE_NOT_CHATBOT_ACCOUNT:{code:107329,message:"is not chatbot account"},V2NIM_ERROR_CODE_MESSAGE_SENSE_REQUIRED:{code:107330,message:"sender or receiver must sense message"},V2NIM_ERROR_CODE_HIGH_PRIORITY_MESSAGE_RATE_LIMIT:{code:107304,message:"rate limit of high-priority messages exceeded"},ACK_MESSAGE_BE_HIGH_PRIORITY:{code:107305,message:"ack message should be high-priority"},V2NIM_ERROR_CODE_DUPLICATE_CLIENT_MESSAGE_ID:{code:107306,message:"duplicate client message ID"},V2NIM_ERROR_CODE_INVALID_TIME_RANGE:{code:107439,message:"invalid time range"},V2NIM_ERROR_CODE_NOT_ADVANCED_TEAM:{code:108302,message:"not advanced team"},V2NIM_ERROR_CODE_TEAM_MANAGER_LIMIT:{code:108303,message:"team manager limit"},V2NIM_ERROR_CODE_JOINED_TEAM_LIMIT:{code:108305,message:"joined team limit"},V2NIM_ERROR_CODE_TEAM_NORMAL_MEMBER_CHAT_BANNED:{code:108306,message:"team normal member chat banned"},V2NIM_ERROR_CODE_INVITED_ACCOUNT_NOT_FRIEND:{code:108307,message:"invited account not friend"},V2NIM_ERROR_CODE_REJECT_ALL_TEAM_APPLICATIONS:{code:108308,message:"reject all team applications"},V2NIM_ERROR_CODE_TARGETING_MESSAGE_FOR_TEAM_DISABLED:{code:108318,message:"Targeting messages for group chat is disabled"},V2NIM_ERROR_CODE_INCLUSIVE_AS_FALSE_NOT_ALLOWED_FOR_SUPER_TEAM:{code:108319,message:'Setting "inclusive" to false for super teams is not allowed'},V2NIM_ERROR_CODE_CANNOT_MAKE_SUPER_TEAM_MESSAGE_VISIBLE_TO_NEW_MEMBERS:{code:108320,message:"Cannot make super team targeted messages visible to new members"},V2NIM_ERROR_CODE_CANNOT_ALLOW_TARGETED_MESSAGES_INCLUSIVE_TO_NEW_MEMBERS:{code:108321,message:"Cannot allow targeted messages inclusive to new members"},V2NIM_ERROR_CODE_TEAM_NOT_EXIST:{code:108404,message:"team not exist"},V2NIM_ERROR_CODE_TEAM_ALREADY_CHAT_BANNED:{code:108420,message:"team already chat banned"},V2NIM_ERROR_CODE_ALL_TEAM_MEMBER_CHAT_BANNED:{code:108423,message:"all team member chat banned"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_LIMIT:{code:108434,message:"extended super team limit"},V2NIM_ERROR_CODE_CREATED_TEAM_LIMIT:{code:108435,message:"created team limit"},V2NIM_ERROR_CODE_TEAM_INVITATION_LIMIT:{code:108437,message:"team invitation limit"},V2NIM_ERROR_CODE_TEAM_HIT_ANTISPAM:{code:108451,message:"team hit antispam"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_LIMIT_NOT_CONFIGURED:{code:108304,message:"extended super team limit not configured"},V2NIM_ERROR_CODE_SUPER_TEAM_SERVICE_DISABLED:{code:108311,message:"super team service disabled"},V2NIM_ERROR_CODE_TEAM_READ_RECEIPT_RECORD_NOT_FOUND:{code:108301,message:"read receipt record for the team message not found"},V2NIM_ERROR_CODE_NOT_MANAGER:{code:108430,message:"unable to assign owner manager"},V2NIM_ERROR_CODE_ONLINE_MEMBER_COUNT_DISABLED:{code:108406,message:"number of online users service disabled"},V2NIM_ERROR_CODE_TRANSFER_DISABLED:{code:108310,message:"unable to transfer the ownership to owner"},V2NIM_ERROR_CODE_CREATE_TEAM_DISABLED:{code:108309,message:"unable to create team with more than %s people"},V2NIM_ERROR_CODE_EXTENDED_SUPER_TEAM_CREATE_FAILED:{code:108313,message:"/ extended super team creation failedï¼use open api to create the team"},V2NIM_ERROR_CODE_TEAM_MESSAGE_READ_RECEIPT_DISABLED:{code:108312,message:"read receipt for team messages function disabled"},V2NIM_ERROR_CODE_RETRY:{code:108449,message:"an error occurred, try again"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_NOT_TEAM_MEMBER:{code:109301,message:"list of chat banned users contains non team members"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_OPERATOR:{code:109303,message:"list of chat banned users contains the operator"},V2NIM_ERROR_CODE_CHAT_BAN_LIST_CONTAIN_TEAM_OWNER:{code:109304,message:"list of chat banned users contains the team owner"},V2NIM_ERROR_CODE_OPERATION_ON_TEAM_MANAGER_NOT_ALLOWED:{code:109305,message:"operation on team manager not allowed"},V2NIM_ERROR_CODE_NO_TEAM_INVITE_PERMISSION:{code:109306,message:"no team invite permission"},V2NIM_ERROR_CODE_TEAM_OWNER_QUIT_NOT_ALLOWED:{code:109307,message:"team owner quit not allowed"},V2NIM_ERROR_CODE_TEAM_OWNER_IN_KICK_LIST:{code:109308,message:"list of kicked user contains the team owner"},V2NIM_ERROR_CODE_INVITE_ROBOT_ACCOUNT_NOT_ALLOWED:{code:109309,message:"invite robot account not allowed"},V2NIM_ERROR_CODE_KICK_OPERATOR_NOT_ALLOWED:{code:109310,message:"kick operator not allowed"},V2NIM_ERROR_CODE_TEAM_MEMBER_ALREADY_EXIST:{code:109311,message:"team member already exist"},V2NIM_ERROR_CODE_TEAM_INVITATION_OR_APPLICATION_NOT_EXIST:{code:109313,message:"team invitation or application not exist"},V2NIM_ERROR_CODE_OPERATION_ON_TEAM_OWNER_NOT_ALLOWED:{code:109314,message:"operation on team owner not allowed"},V2NIM_ERROR_CODE_FORCED_PUSH_LIST_INCLUDES_NON_TARGETED_ACCOUNTS:{code:109318,message:"The forced push list includes non-targeted accounts"},V2NIM_ERROR_CODE_TEAM_MEMBER_NOT_EXIST:{code:109404,message:"team member not exist"},V2NIM_ERROR_CODE_TEAM_MEMBER_CHAT_BANNED:{code:109424,message:"team member chat banned"},V2NIM_ERROR_CODE_TEAM_OWNER_OPERATION_PERMISSION_REQUIRED:{code:109427,message:"team owner operation permission required"},V2NIM_ERROR_CODE_TEAM_OWNER_OR_MANAGER_OPERATION_PERMISSION_REQUIRED:{code:109432,message:"team owner or manager operation permission required"},V2NIM_ERROR_CODE_TEAM_MEMBER_CONCURRENT_OPERATION_FAILED:{code:109449,message:"team member concurrent operation failed"},V2NIM_ERROR_CODE_TEAM_MEMBER_HIT_ANTISPAM:{code:109451,message:"team member hit antispam"},V2NIM_ERROR_CODE_CONVERSATION_AND_ACCOUNT_MISMATCH:{code:110302,message:"conversation and account mismatch"},V2NIM_ERROR_CODE_CONVERSATION_STICK_TOP_LIMIT:{code:110303,message:"conversation stick top limit"},V2NIM_ERROR_CODE_CONVERSATION_BELONGED_GROUP_LIMIT:{code:110304,message:"conversation belonged group limit"},V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST:{code:110404,message:"conversation not exist"},V2NIM_ERROR_CODE_CHATROOM_LINK_UNAVAILABLE:{code:113304,message:"chatroom link unavailable"},V2NIM_ERROR_CODE_IM_CONNECTION_ABNORMAL:{code:113305,message:"IM connection abnormal"},V2NIM_ERROR_CODE_CHATROOM_NOT_EXIST:{code:113404,message:"chatroom not exist"},V2NIM_ERROR_CODE_CHATROOM_CLOSED:{code:113406,message:"chatroom closed"},V2NIM_ERROR_CODE_CHATROOM_REPEATED_OPERATION:{code:113409,message:"chatroom repeated operation"},V2NIM_ERROR_CODE_CHATROOM_DISABLED:{code:113410,message:"chatroom disabled"},V2NIM_ERROR_CODE_ALL_CHATROOM_MEMBER_CHAT_BANNED:{code:113423,message:"all chatroom member chat banned"},V2NIM_ERROR_CODE_CHATROOM_HIT_ANTISPAM:{code:113451,message:"chatroom hit antispam"},V2NIM_ERROR_CODE_ANONYMOUS_MEMBER_FORBIDDEN:{code:114303,message:"anonymous member forbidden"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_NOT_EXIST:{code:114404,message:"chatroom member not exist"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_REPEATED_OPERATION:{code:114405,message:"chatroom member repeated operation"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_CHAT_BANNED:{code:114421,message:"chatroom member chat banned"},V2NIM_ERROR_CODE_ACCOUNT_IN_CHATROOM_BLOCK_LIST:{code:114426,message:"account in chatroom block list"},V2NIM_ERROR_CODE_CHATROOM_OWNER_OPERATION_PERMISSION_REQUIRED:{code:114427,message:"chatroom owner operation permission required"},V2NIM_ERROR_CODE_SELF_IN_CHATROOM_MEMBER_OPERATION_LIST:{code:114429,message:"self in chatroom member operation list"},V2NIM_ERROR_CODE_CHATROOM_OWNER_OR_MANAGER_OPERATION_PERMISSION_REQUIRED:{code:114432,message:"chatroom owner or manager operation permission required"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_LIMIT:{code:114437,message:"chatroom member limit"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_CONCURRENT_OPERATION_FAILED:{code:114449,message:"chatroom member concurrent operation failed"},V2NIM_ERROR_CODE_CHATROOM_MEMBER_HIT_ANTISPAM:{code:114451,message:"chatroom member hit antispam"},V2NIM_ERROR_CODE_CONVERSATION_GROUP_NOT_EXIST:{code:116404,message:"conversation group not exist"},V2NIM_ERROR_CODE_CONVERSATION_GROUP_LIMIT:{code:116435,message:"conversation group limit"},V2NIM_ERROR_CODE_CONVERSATIONS_IN_GROUP_LIMIT:{code:116437,message:"conversations in group limit"},V2NIM_ERROR_CODE_COLLECTION_LIMIT:{code:189301,message:"collection limit"},V2NIM_ERROR_CODE_COLLECTION_NOT_EXIST:{code:189302,message:"collection not exist"},V2NIM_ERROR_CODE_COLLECTION_CONCURRENT_OPERATION_FAILED:{code:189449,message:"collection concurrent operation failed"},V2NIM_ERROR_CODE_INTERNAL:{code:190001,message:"internal error"},V2NIM_ERROR_CODE_ILLEGAL_STATE:{code:190002,message:"illegal state"},V2NIM_ERROR_CODE_MISUSE:{code:191001,message:"misuse"},V2NIM_ERROR_CODE_CANCELLED:{code:191002,message:"operation cancelled"},V2NIM_ERROR_CODE_CALLBACK_FAILED:{code:191003,message:"callback failed"},V2NIM_ERROR_CODE_INVALID_PARAMETER:{code:191004,message:"invalid parameter"},V2NIM_ERROR_CODE_TIMEOUT:{code:191005,message:"timeout"},V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST:{code:191006,message:"resource not exist"},V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST:{code:191007,message:"resource already exist"},V2NIM_ERROR_CODE_CONNECT_FAILED:{code:192001,message:"connect failed"},V2NIM_ERROR_CODE_CONNECT_TIMEOUT:{code:192002,message:"connect timeout"},V2NIM_ERROR_CODE_DISCONNECT:{code:192003,message:"disconnect"},V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT:{code:192004,message:"protocol timeout"},V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED:{code:192005,message:"protocol send failed"},V2NIM_ERROR_CODE_REQUEST_FAILED:{code:192006,message:"request failed"},V2NIM_ERROR_CODE_FILE_NOT_FOUND:{code:194001,message:"file not found"},V2NIM_ERROR_CODE_FILE_CREATE_FAILED:{code:194002,message:"file create failed"},V2NIM_ERROR_CODE_FILE_OPEN_FAILED:{code:194003,message:"file open failed"},V2NIM_ERROR_CODE_FILE_WRITE_FAILED:{code:194004,message:"file write failed"},V2NIM_ERROR_CODE_FILE_READ_FAILED:{code:194005,message:"file read failed"},V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:{code:194006,message:"file upload failed"},V2NIM_ERROR_CODE_FILE_DOWNLOAD_FAILED:{code:194007,message:"file download failed"},V2NIM_ERROR_CODE_CLIENT_ANTISPAM:{code:195001,message:"client anti-spam"},V2NIM_ERROR_CODE_SERVER_ANTISPAM:{code:195002,message:"server anti-spam"}},yl=Nt(fl),_l=reduce(yl).call(yl,(function(e,t){var r=fl[t];return e[t]=r.code,e}),{}),Ml=reduce(yl).call(yl,(function(e,t){var r=fl[t];return e[r.code]=r.message,e}),{}),Il=Object.freeze({__proto__:null,V2NIMErrorCode:_l,V2NIMErrorDesc:Ml,get V2NIMDataSyncLevel(){return Sc},get V2NIMDataSyncType(){return Tc},get V2NIMDataSyncState(){return Cc},get V2NIMConversationType(){return bc},get V2NIMLastMessageState(){return Ec},get V2NIMFriendAddMode(){return Rc},get V2NIMFriendAddApplicationType(){return kc},get V2NIMFriendAddApplicationStatus(){return wc},get V2NIMFriendDeletionType(){return Ac},get V2NIMFriendVerifyType(){return Nc},get V2NIMLoginAuthType(){return xc},get V2NIMLoginStatus(){return Oc},get V2NIMLoginClientType(){return Pc},get V2NIMKickedOfflineReason(){return Lc},get V2NIMLoginClientChange(){return Vc},get V2NIMConnectStatus(){return Uc},get V2NIMMessageType(){return qc},get V2NIMMessageNotificationType(){return Bc},get V2NIMMessageAttachmentUploadState(){return Fc},get V2NIMMessageSendingState(){return Gc},get V2NIMQueryDirection(){return Hc},get V2NIMMessageRevokeType(){return jc},get V2NIMMessagePinState(){return $c},get V2NIMMessageQuickCommentType(){return zc},get V2NIMClientAntispamOperateType(){return Wc},get V2NIMSortOrder(){return Kc},get V2NIMSystemMessageType(){return Yc},get V2NIMTeamMessageMuteMode(){return Qc},get V2NIMP2PMessageMuteMode(){return Jc},get V2NIMTeamMemberRoleQueryType(){return Xc},get V2NIMTeamType(){return Zc},get V2NIMTeamJoinMode(){return el},get V2NIMTeamAgreeMode(){return tl},get V2NIMTeamInviteMode(){return rl},get V2NIMTeamUpdateInfoMode(){return nl},get V2NIMTeamChatBannedMode(){return al},get V2NIMTeamUpdateExtensionMode(){return il},get V2NIMTeamJoinActionType(){return sl},get V2NIMTeamJoinActionStatus(){return cl},get V2NIMTeamNotificationType(){return ll},get V2NIMTeamMemberRole(){return ol},get V2NIMAIModelRoleType(){return ul},get V2NIMAIModelType(){return dl},get V2NIMSignallingChannelType(){return ml},get V2NIMSignallingEventType(){return pl},get V2NIMUserStatusType(){return hl}}),Sl=function(e){function V2NIMErrorImpl(t){var r;return(r=e.call(this,t.desc)||this).name="V2NIMError",r.code=t.code||0,r.desc=t.desc||Ml[r.code]||kl[r.code]||"",r.message=r.desc,r.detail=t.detail||{},r}return _t(V2NIMErrorImpl,e),V2NIMErrorImpl.prototype.toString=function toString(){var e,t=this.name+"\n code: "+this.code+'\n message: "'+this.message+'"\n detail: '+(this.detail?bn(this.detail):"");return(null===(e=null==this?void 0:this.detail)||void 0===e?void 0:e.rawError)&&(t+="\n rawError: "+this.detail.rawError.message),t},V2NIMErrorImpl}(yc(Error));var Tl=function(e){function ValidateError(t,r,n){var a;return void 0===r&&(r={}),(a=e.call(this,{code:_l.V2NIM_ERROR_CODE_PARAMETER_ERROR,detail:{reason:t,rules:n,data:r}})||this).name="validateError",a.message=a.message+"\n"+bn(a.detail,null,2),a.data=r,a.rules=n,a}return _t(ValidateError,e),ValidateError}(Sl),Cl=function(e){function ValidateErrorV2(t){var r,n,a,i;return(r=e.call(this,{code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:null===(n=t.detail)||void 0===n?void 0:n.reason,rules:null===(a=t.detail)||void 0===a?void 0:a.rules,data:null===(i=t.detail)||void 0===i?void 0:i.data}})||this).name="ValidateErrorV2",r}return _t(ValidateErrorV2,e),ValidateErrorV2}(Sl),bl=function(e){function FormatError(t,r,n){var a;return(a=e.call(this,{code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:t,key:r,rules:n}})||this).name="formatError",a}return _t(FormatError,e),FormatError}(Sl),El=function(e){function UploadError(t){var r;return(r=e.call(this,Et({code:400},t))||this).desc=r.desc||"upload file error",r.message=r.desc,r.name="uploadError",r}return _t(UploadError,e),UploadError}(Sl),Rl=function(e){function CustomError(t,r,n){var a;return void 0===r&&(r={}),void 0===n&&(n=400),(a=e.call(this,{code:n,desc:t,detail:r})||this).name="customError",a.data=r,a}return _t(CustomError,e),CustomError}(Sl),kl={200:null,406:null,808:null,810:null,302:"The user name or password is incorrect.",405:"Parameter length too long",408:"Client request timed out",415:"Client network unavailable",422:"Account disabled",508:"Expiration date",509:"Invalid",7101:"Be pulled black",700:"Partial failure of batch operation",801:"The number of people in the team has reached the upper limit",802:"No permission",803:"The team does not exist or has not changed",804:"The user is not in the team",805:"Team type mismatch",806:"The number of teams created has reached the limit",807:"Team member not valid",809:"Already in the team",811:"The number of accounts in the forced push list exceeds the limit",812:"The team is muted",813:"Due to the limited number of team, some pull people successfully",814:"Disable team message read service",815:"Maximum number of team administrators",816:"Batch operation partial failure",9102:"Channel failure",9103:"This call has been answered / rejected at another end",10201:"Signaling: target NIM client is offline",10202:"Signaling: push is unreachable",10404:"Signaling: channel not exists",10405:"Signaling: channel already exists",10406:"Signaling: member of channel not exists",10407:"Signaling: member of channel already exists",10408:"Signaling: the invitation request does not exist or has expired",10409:"Signaling: the invitation request has been rejected",10410:"Signaling: the invitation request has been accepted",10414:"Signaling: request parameter error",10417:"Signaling: uid conflict",10419:"Signaling: the number of members of channel exceed the limit",10420:"Signaling: member is already in the channel on other client",10700:"Signaling: phased success",13002:"Abnormal chatroom status",13003:"In the blacklist",13004:"In the mute list",13006:"All members are muted, and only the administrator can speak"};function difference(e,t){return t=t||[],filter(e=e||[]).call(e,(function(e){return-1===indexOf(t).call(t,e)}))}function replacer(e,t){return t instanceof RegExp?"__REGEXP "+t.toString():t}function validate(e,t,r,n){var a;void 0===t&&(t={}),void 0===n&&(n=!1);var i={};return forEach$1(a=Nt(e)).call(a,(function(a){var o=e[a].type,s=r?"In "+r+", ":"";if(null==t){var c=s+"param is null or undefined";throw n?new Cl({detail:{reason:c,data:{key:a},rules:"required"}}):new Tl(c,{key:a},"required")}if(void 0===t[a]){if(!1===e[a].required)return void(i[a]=t[a]);var l=s+"param '"+a+"' is required";throw n?new Cl({detail:{reason:l,data:{key:a},rules:"required"}}):new Tl(l,{key:a},"required")}var d=wl[o];if(d&&!d(t,a,e[a],n)){var u=s+"param '"+a+"' unexpected",p={key:a,value:t[a]};throw n?new Cl({detail:{reason:u,data:p,rules:bn(e[a],replacer)}}):new Tl(u,p,bn(e[a],replacer))}i[a]=t[a]})),i}var wl={string:function string(e,t,r){var n=r.allowEmpty,a=r.max,i=r.min,o=r.regExp,s=e[t];return"string"==typeof s&&((!1!==n||""!==s)&&(!("number"==typeof a&&s.length>a)&&(!("number"==typeof i&&s.length<i)&&!(function isRegExp(e){return"[object RegExp]"===Object.prototype.toString.call(e)}(o)&&!o.test(s)))))},number:function number(e,t,r){var n=r.min,a=r.max,i=e[t];return"number"==typeof i&&(!("number"==typeof n&&i<n)&&!("number"==typeof a&&i>a))},boolean:function boolean(e,t){return"boolean"==typeof e[t]},file:function file(e,t){return!0},enum:function _enum(e,t,r){var n=values(r),a=e[t];return!n||indexOf(n).call(n,a)>-1},jsonstr:function jsonstr(e,t){try{var r=JSON.parse(e[t]);return"object"==typeof r&&null!==r}catch(e){return!1}},func:function func(e,t){return"function"==typeof e[t]},array:function array(e,t,r,n){void 0===n&&(n=!1);var a=r.itemType,i=r.rules,o=r.min,s=r.max,c=values(r),l=e[t];return!!En(l)&&(!("number"==typeof s&&l.length>s)&&(!("number"==typeof o&&l.length<o)&&(!(a&&"enum"!==a&&!every(l).call(l,(function(e){return typeof e===a})))&&(("enum"!==a||!c||!difference(l,c).length)&&(i&&forEach$1(l).call(l,(function(e,r){return validate(i,e,t+"["+r+"]",n)})),!0)))))},object:function object(e,t,r,n){void 0===n&&(n=!1);var a=r.rules,i=r.allowEmpty,o=e[t];if("object"!=typeof o||null===o)return!1;if(a){var s=Nt(a),c=Nt(o),l=filter(c).call(c,(function(e){return indexOf(s).call(s,e)>-1}));if(!1===i&&0===l.length)return!1;validate(a,o,t,n)}return!0}};function validateConversationId(e,t){if(!e)throw new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE});validate({conversationId:{type:"string",allowEmpty:!1,regExp:new RegExp("^"+e+"\\|[1-3]\\|")}},{conversationId:t},"",!0)}var callWithSafeIterationClosing=function(e,t,r,n){try{return n?t(anObject(r)[0],r[1]):t(r)}catch(t){iteratorClose(e,"throw",t)}},Al=Array,Nl=!checkCorrectnessOfIteration((function(e){Array.from(e)}));_export({target:"Array",stat:!0,forced:Nl},{from:function from(e){var t=toObject(e),r=qr(this),n=arguments.length,a=n>1?arguments[1]:void 0,i=void 0!==a;i&&(a=functionBindContext(a,n>2?arguments[2]:void 0));var o,s,c,l,d,u,p=getIteratorMethod$5(t),m=0;if(!p||this===Al&&isArrayIteratorMethod(p))for(o=lengthOfArrayLike(t),s=r?new this(o):Al(o);o>m;m++)u=i?a(t[m],m):t[m],createProperty(s,m,u);else for(d=(l=getIterator(t,p)).next,s=r?new this:[];!(c=y(d,l)).done;m++)u=i?callWithSafeIterationClosing(l,a,[c.value,m],!0):c.value,createProperty(s,m,u);return s.length=m,s}});var xl=N.Array.from,Ol=getIteratorMethod$5;function _createForOfIteratorHelperLoose$b(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$b(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$b(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$b(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$b(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var Pl=function(){function TimerManager(){this.timerList=[],this.id=1,this.timer=null,this.timeout=0}var e=TimerManager.prototype;return e.addTimer=function addTimer(e,t,r){void 0===t&&(t=0),void 0===r&&(r=1);var n=(new Date).getTime(),a=this.id;return this.timerList.push({id:a,loop:r,count:0,timeout:n+t,interval:t,callback:e}),this.id++,this.checkTimer(n),a},e.checkTimer=function checkTimer(e){if(void 0===e&&(e=(new Date).getTime()),this.removeFinished(),0!==this.timerList.length||null==this.timer){for(var t,r,n=0,a=_createForOfIteratorHelperLoose$b(this.timerList);!(t=a()).done;){var i=t.value;(0===n||n>i.timeout)&&(n=i.timeout)}if(0!==this.timerList.length)if(null===this.timer||n<this.timeout||this.timeout<e)this.timer=eo(bind$1(r=this.nowTime).call(r,this),n-e),this.timeout=n}},e.nowTime=function nowTime(){for(var e,nowTime=(new Date).getTime(),t=_createForOfIteratorHelperLoose$b(this.timerList);!(e=t()).done;){var r=e.value;nowTime>=r.timeout&&(r.callback(),r.count++,r.timeout=nowTime+r.interval)}this.clerTime(),this.checkTimer(nowTime)},e.clerTime=function clerTime(){null!==this.timer&&(clearTimeout(this.timer),this.timer=null)},e.deleteTimer=function deleteTimer(e){for(var t=this.timerList.length-1;t>=0;t--){var r;if(this.timerList[t].id===e)splice(r=this.timerList).call(r,t,1)}},e.removeFinished=function removeFinished(){for(var e=this.timerList.length-1;e>=0;e--){var t,r=this.timerList[e];if(r.loop>=0&&r.count>=r.loop)splice(t=this.timerList).call(t,e,1)}},e.destroy=function destroy(){this.clerTime(),this.timerList=[],this.id=1,this.timer=null},TimerManager}(),Ll=createCommonjsModule((function(e){function _typeof(t){return e.exports=_typeof="function"==typeof Go&&"symbol"==typeof ts?function(e){return typeof e}:function(e){return e&&"function"==typeof Go&&e.constructor===Go&&e!==Go.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,_typeof(t)}e.exports=_typeof,e.exports.__esModule=!0,e.exports.default=e.exports})),Vl=createCommonjsModule((function(e){var t=Ll.default;function _regeneratorRuntime(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */
e.exports=_regeneratorRuntime=function _regeneratorRuntime(){return r},e.exports.__esModule=!0,e.exports.default=e.exports;var r={},n=Object.prototype,a=n.hasOwnProperty,i="function"==typeof Go?Go:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function define(e,t,r){return Ve(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{define({},"")}catch(e){define=function define(e,t,r){return e[t]=r}}function wrap(e,t,r,n){var a=t&&t.prototype instanceof Generator?t:Generator,i=it(a.prototype),o=new Context(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(a,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw i;return doneResult()}for(r.method=a,r.arg=i;;){var o=r.delegate;if(o){var s=maybeInvokeDelegate(o,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=tryCatch(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(e,r,o),i}function tryCatch(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}r.wrap=wrap;var l={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var d={};define(d,o,(function(){return this}));var u=jo&&jo(jo(values([])));u&&u!==n&&a.call(u,o)&&(d=u);var p=GeneratorFunctionPrototype.prototype=Generator.prototype=it(d);function defineIteratorMethods(e){var t;forEach$1(t=["next","throw","return"]).call(t,(function(t){define(e,t,(function(e){return this._invoke(t,e)}))}))}function AsyncIterator(e,r){function invoke(n,i,o,s){var c=tryCatch(e[n],e,i);if("throw"!==c.type){var l=c.arg,d=l.value;return d&&"object"==t(d)&&a.call(d,"__await")?r.resolve(d.__await).then((function(e){invoke("next",e,o,s)}),(function(e){invoke("throw",e,o,s)})):r.resolve(d).then((function(e){l.value=e,o(l)}),(function(e){return invoke("throw",e,o,s)}))}s(c.arg)}var n;this._invoke=function(e,t){function callInvokeWithMethodAndArg(){return new r((function(r,n){invoke(e,t,r,n)}))}return n=n?n.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,maybeInvokeDelegate(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=tryCatch(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var a=n.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}],forEach$1(e).call(e,pushTryEntry,this),this.reset(!0)}function values(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,n=function next(){for(;++r<e.length;)if(a.call(e,r))return next.value=e[r],next.done=!1,next;return next.value=void 0,next.done=!0,next};return n.next=n}}return{next:doneResult}}function doneResult(){return{value:void 0,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(p,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,c,"GeneratorFunction"),r.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))},r.mark=function(e){return lt?lt(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,define(e,c,"GeneratorFunction")),e.prototype=it(p),e},r.awrap=function(e){return{__await:e}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,s,(function(){return this})),r.AsyncIterator=AsyncIterator,r.async=function(e,t,n,a,i){void 0===i&&(i=Pi);var o=new AsyncIterator(wrap(e,t,n,a),i);return r.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},defineIteratorMethods(p),define(p,c,"Generator"),define(p,o,(function(){return this})),define(p,"toString",(function(){return"[object Generator]"})),r.keys=function(e){var t=[];for(var r in e)t.push(r);return reverse$1(t).call(t),function next(){for(;t.length;){var r=t.pop();if(r in e)return next.value=r,next.done=!1,next}return next.done=!0,next}},r.values=values,Context.prototype={constructor:Context,reset:function reset(e){var t;if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,forEach$1(t=this.tryEntries).call(t,resetTryEntry),!e)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+slice(r).call(r,1))&&(this[r]=void 0)},stop:function stop(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function dispatchException(e){if(this.done)throw e;var t=this;function handle(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r],i=n.completion;if("root"===n.tryLoc)return handle("end");if(n.tryLoc<=this.prev){var o=a.call(n,"catchLoc"),s=a.call(n,"finallyLoc");if(o&&s){if(this.prev<n.catchLoc)return handle(n.catchLoc,!0);if(this.prev<n.finallyLoc)return handle(n.finallyLoc)}else if(o){if(this.prev<n.catchLoc)return handle(n.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return handle(n.finallyLoc)}}}},abrupt:function abrupt(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&a.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,l):this.complete(o)},complete:function complete(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function finish(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),resetTryEntry(r),l}},catch:function _catch(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;resetTryEntry(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function delegateYield(e,t,r){return this.delegate={iterator:values(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},r}e.exports=_regeneratorRuntime,e.exports.__esModule=!0,e.exports.default=e.exports})),Ul=Vl(),Dl=Ul;try{regeneratorRuntime=Ul}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=Ul:Function("r","regeneratorRuntime = r")(Ul)}function __rest(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(n=Object.getOwnPropertySymbols(e);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(r[n[a]]=e[n[a]])}return r}function __awaiter(e,t,r,n){return new(r||(r=Promise))((function(a,i){function fulfilled(e){try{step(n.next(e))}catch(e){i(e)}}function rejected(e){try{step(n.throw(e))}catch(e){i(e)}}function step(e){e.done?a(e.value):function adopt(e){return e instanceof r?e:new r((function(t){t(e)}))}(e.value).then(fulfilled,rejected)}step((n=n.apply(e,t||[])).next())}))}function isPlainObject(e){return null!=e&&"object"==typeof e&&jo(e)==Object.prototype}function merge$1(e,t){var r=isPlainObject(e)||En(e),n=isPlainObject(t)||En(t);if(r&&n){for(var a in t){var i=merge$1(e[a],t[a]);void 0!==i&&(e[a]=i)}return e}return t}var ql={setLogger:function setLogger(e){throw new Error("setLogger not implemented.")},platform:"",WebSocket:function(){function AdapterSocket(e,t){throw this.CONNECTING=0,this.OPEN=1,this.CLOSING=2,this.CLOSED=3,this.binaryType="",new Error("Method not implemented.")}var e=AdapterSocket.prototype;return e.close=function close(e,t){throw new Error("Method not implemented.")},e.send=function send(e){throw new Error("Method not implemented.")},e.onclose=function onclose(e){throw new Error("Method not implemented.")},e.onerror=function onerror(e){throw new Error("Method not implemented.")},e.onmessage=function onmessage(e){throw new Error("Method not implemented.")},e.onopen=function onopen(e){throw new Error("Method not implemented.")},AdapterSocket}(),localStorage:{},request:function request(e,t){throw new Error("request not implemented.")},uploadFile:function uploadFile(e){throw new Error("uploadFile not implemented.")},getSystemInfo:function getSystemInfo(){throw new Error("getSystemInfo not implemented.")},getFileUploadInformation:function getFileUploadInformation(e){throw new Error("getFileUploadInformation not implemented.")},envPayload:{},net:{getNetworkStatus:function getNetworkStatus(){return Pi.resolve({net_type:0,net_connect:!0})},onNetworkStatusChange:function onNetworkStatusChange(e){},offNetworkStatusChange:function offNetworkStatusChange(){}},logStorage:function(){function AdapterLogStorageImpl(e){}var e=AdapterLogStorageImpl.prototype;return e.open=function open(){return Pi.resolve()},e.close=function close(){},e.addLogs=function addLogs(e){return Pi.resolve()},e.extractLogs=function extractLogs(){return Pi.resolve()},AdapterLogStorageImpl}()};var Bl=["error","warn","log","debug"],Fl=function emptyFunc(){},Gl=["off","error","warn","log","debug"],Hl=function(){function Logger(e,t){void 0===t&&(t={}),this.storageArr=[],this.debugLevel="off",this.timer=0,this.strategies={debug:{name:"debg",func:console.log},log:{name:"info",func:console.log},warn:{name:"warn",func:console.warn},error:{name:"erro",func:console.error}},this.debug=Fl,this.log=Fl,this.warn=Fl,this.error=Fl,this.iid=Math.round(1e3*Math.random()),this.debugLevel=includes(Gl).call(Gl,e)?e:"off",t.debugLevel&&(this.debugLevel=includes(Gl).call(Gl,t.debugLevel)?t.debugLevel:this.debugLevel),this.logStorage=!1===t.storageEnable?null:new ql.logStorage(null==t?void 0:t.storageName),this.setOptions(t),this.setLogFunc(this.debugLevel),this.setTimer(),this.open()}var e=Logger.prototype;return e.getDebugMode=function getDebugMode(){return"debug"===this.debugLevel},e.open=function open(e){var t=this;this.logStorage&&this.logStorage.open(e).then((function(){t.log("Logger::open success")})).catch((function(e){t.warn("Logger::open failed",e)}))},e.setOptions=function setOptions(e){if(e&&e.logFunc){var t=e.logFunc;for(var r in t){var n=r,a=t[n];a&&(this.strategies[n].func=a)}}},e.setLogFunc=function setLogFunc(e,t){var r=this;void 0===t&&(t="log");var n=findIndex$1(Bl).call(Bl,(function(t){return t===e})),a=findIndex$1(Bl).call(Bl,(function(e){return e===t}));forEach$1(Bl).call(Bl,(function(e,t){r[e]=function(){if(!(t>n&&t>a)){var r=slice(Array.prototype).call(arguments),i=this.strategies[e],o=this.formatArgs(r,i.name);t<=a&&this.logStorage&&this.prepareSaveLog(o,e),t<=n&&i.func(o)}}}))},e.extractLogs=function extractLogs(){var e;return this.logStorage?null===(e=this.logStorage)||void 0===e?void 0:e.extractLogs():Pi.resolve("")},e.prepareSaveLog=function prepareSaveLog(e,t){this.storageArr.push({text:e,level:t,time:Hi(),iid:this.iid}),this.timer||this.setTimer(),this.storageArr.length>=100&&(this.triggerTimer(),this.storageArr=[])},e.saveLogs=function saveLogs(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e;return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(this.logStorage){t.next=2;break}return t.abrupt("return");case 2:return e=this.storageArr,this.storageArr=[],t.prev=4,t.next=7,this.logStorage.addLogs(e);case 7:t.next=11;break;case 9:t.prev=9,t.t0=t.catch(4);case 11:case"end":return t.stop()}}),_callee,this,[[4,9]])})))},e.clearTimer=function clearTimer(){this.timer&&clearTimeout(this.timer),this.timer=0},e.setTimer=function setTimer(){var e;this.clearTimer(),this.timer=eo(bind$1(e=this.triggerTimer).call(e,this),5e3)},e.triggerTimer=function triggerTimer(){this.clearTimer(),this.saveLogs()},e.formatArgs=function formatArgs(e,t){var r=new Date;return"[NIM "+this.iid+" "+t+" "+(r.getMonth()+1+"-"+r.getDate()+" "+r.getHours()+":"+r.getMinutes()+":"+r.getSeconds()+":"+r.getMilliseconds())+"] "+map$6(e).call(e,(function(e){return e instanceof Sl?e.toString():e instanceof Error?e&&e.message?e.message:e:"object"==typeof e?bn(e):e})).join(" ")},e.destroy=function destroy(){this.debug=Fl,this.log=Fl,this.warn=Fl,this.error=Fl,this.saveLogs(),this.clearTimer(),this.storageArr=[],this.logStorage&&this.logStorage.close()},Logger}(),jl=Math.min,$l=[].lastIndexOf,zl=!!$l&&1/[1].lastIndexOf(1,-0)<0,Wl=arrayMethodIsStrict("lastIndexOf"),Kl=zl||!Wl?function lastIndexOf(e){if(zl)return d($l,this,arguments)||0;var t=toIndexedObject(this),r=lengthOfArrayLike(t),n=r-1;for(arguments.length>1&&(n=jl(n,toIntegerOrInfinity(arguments[1]))),n<0&&(n=r+n);n>=0;n--)if(n in t&&t[n]===e)return n||0;return-1}:$l;_export({target:"Array",proto:!0,forced:Kl!==[].lastIndexOf},{lastIndexOf:Kl});var Yl,Ql=entryVirtual("Array").lastIndexOf,Jl=Array.prototype,lastIndexOf=function(e){var t=e.lastIndexOf;return e===Jl||x(Jl,e)&&t===Jl.lastIndexOf?Ql:t},Xl="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",Zl=g("".replace),ed="["+Xl+"]",td=RegExp("^"+ed+ed+"*"),rd=RegExp(ed+ed+"*$"),createMethod=function(e){return function(t){var r=toString(requireObjectCoercible(t));return 1&e&&(r=Zl(r,td,"")),2&e&&(r=Zl(r,rd,"")),r}},nd={start:createMethod(1),end:createMethod(2),trim:createMethod(3)},ad=Qt.PROPER,id=nd.trim;_export({target:"String",proto:!0,forced:(Yl="trim",fails((function(){return!!Xl[Yl]()||"âÂá "!=="âÂá "[Yl]()||ad&&Xl[Yl].name!==Yl})))},{trim:function trim(){return id(this)}});var od=entryVirtual("String").trim,sd=String.prototype,trim$2=function(e){var t=e.trim;return"string"==typeof e||e===sd||x(sd,e)&&t===sd.trim?od:t};var cd,ld=(cd=function _s4(){return(65536*(1+Math.random())|0).toString(16).substring(1)},function(){return cd()+cd()+cd()+cd()+cd()+cd()+cd()+cd()});function getEnumKeys(e){var t;return filter(t=Nt(e)).call(t,(function(e){return!(+e>=0)}))}function getEnumKeyByEnumValue(e,t){var r,n=filter(r=Nt(e)).call(r,(function(r){return e[r]==t}));return n.length>0?n[0]:void 0}function getAccountFromSessionId(e,t){if(void 0===t&&(t="-"),!e)throw new Rl("No sessionId",{},400);var r=indexOf(e).call(e,t);if(-1===r)throw new Rl("Can not find conjunctions",{},400);var n=slice(e).call(e,0,r);return{accid:slice(e).call(e,r+1),scene:"super_team"===n?"superTeam":n}}function getMiniappEnv(){return"undefined"!=typeof tt&&tt.getSystemInfo?"TT":"undefined"!=typeof swan&&swan.getSystemInfo?"BAIDU":"undefined"!=typeof my&&my.getSystemInfo?"ALI":"undefined"!=typeof wx&&wx.getSystemInfo?"WX":"unknow environment"}function assignOptions(e,t){return function assignWith(e,t,r,n){for(var a in e=e||{},r=r||{},n=n||function(){},t=t||{}){var i=n(e[a],t[a]);e[a]=void 0===i?t[a]:i}for(var o in r){var s=n(e[o],r[o]);e[o]=void 0===s?r[o]:s}return e}({},e,t,(function(e,t){return void 0===t?e:t}))}function emptyFuncWithPromise(){return Pi.resolve()}function emptyFunc(){}function getFileExtension(e){var t=lastIndexOf(e).call(e,"."),r=t>-1?slice(e).call(e,t+1):"";return/^\d+$/.test(trim$2(r).call(r))&&(r=""),r}function findIndexWithinTargetValue(e,t,r){return 0===e.length||e[0][t]<=r?0:e[e.length-1][t]>r?e.length:findIndex$1(e).call(e,(function(n,a){if(e[a-1]&&e[a-1][t]>r&&r>=n[t])return!0}))}var dd=function(){function CoreAdapters(e){this.lastSuccUploadHost="",this.core=e}var e=CoreAdapters.prototype;return e.getFileUploadInformation=function getFileUploadInformation(e){return ql.getFileUploadInformation(e)},e.request=function request(e,t,r){var n=this,a=(new Date).getTime(),i=(null==r?void 0:r.exception_service)||0;return ql.request(e,t).catch((function(r){var o,s,c,l,d=r;throw n.core.reporter.reportTraceStart("exceptions",{user_id:n.core.options.account||(null===(s=null===(o=n.core)||void 0===o?void 0:o.auth)||void 0===s?void 0:s.account),trace_id:null===(l=null===(c=n.core.clientSocket)||void 0===c?void 0:c.socket)||void 0===l?void 0:l.sessionId,start_time:a,action:1,exception_service:i}),n.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof d.code?d.code:0,description:d.message||""+d.code,operation_type:0,target:e,context:t?bn(t):""},{asyncParams:ql.net.getNetworkStatus()}),n.core.reporter.reportTraceEnd("exceptions",1),r}))},e.uploadFile=function uploadFile(e){var t,r,n,a;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var i,o,s,c,l,d,u,p,m,h,g,v,f,y;return Dl.wrap((function _callee$(M){for(;;)switch(M.prev=M.next){case 0:s="BROWSER"===ql.platform,c=s?e.chunkUploadHostBackupList:e.commonUploadHostBackupList,l=s?e.chunkUploadHost:e.commonUploadHost,d=indexOf(c).call(c,l),u=-1===d?concat(i=[l]).call(i,c):concat(o=[l]).call(o,slice(c).call(c,0,d),slice(c).call(c,d+1)),p=Math.max(indexOf(u).call(u,this.lastSuccUploadHost),0),m=null,h=0;case 8:if(!(h<u.length)){M.next=32;break}return g=(new Date).getTime(),v=u[(h+p)%u.length],M.prev=11,M.next=14,ql.uploadFile(Et(Et({},e),s?{chunkUploadHost:v}:{commonUploadHost:v}));case 14:return f=M.sent,this.lastSuccUploadHost=v,M.abrupt("return",f);case 19:if(M.prev=19,M.t0=M.catch(11),this.core.cloudStorage.nos.nosErrorCount--,m=M.t0,y=M.t0,this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(r=null===(t=this.core)||void 0===t?void 0:t.auth)||void 0===r?void 0:r.account),trace_id:null===(a=null===(n=this.core.clientSocket)||void 0===n?void 0:n.socket)||void 0===a?void 0:a.sessionId,start_time:g,action:1,exception_service:3}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof y.code?y.code:0,description:y.message||""+y.code,operation_type:1,target:v},{asyncParams:ql.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1),!M.t0||M.t0.code!==_l.V2NIM_ERROR_CODE_CANCELLED&&10499!==M.t0.errCode){M.next=29;break}throw M.t0;case 29:h++,M.next=8;break;case 32:throw m;case 33:case"end":return M.stop()}}),_callee,this,[[11,19]])})))},CoreAdapters}(),ud="weblink.netease.im:443",pd=["https://lbs.netease.im/lbs/webconf.jsp"],md="https://abt-online.netease.im/v1/api/abt/client/getExperimentInfo",hd="imElite_sdk_abtest_web",gd="https://statistic.live.126.net,https://statistic-overseas.yunxinfw.com",vd=function(){function ABTest(e,t){this.abtInfo={},this.core=e,this.config=assignOptions({isAbtestEnable:!0,abtestUrl:md,abtestProjectKey:hd},t)}var e=ABTest.prototype;return e.setOptions=function setOptions(e){this.config=assignOptions(this.config,e)},e.abtRequest=function abtRequest(){var e,t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:if(this.config.isAbtestEnable){n.next=2;break}return n.abrupt("return");case 2:if(!this.abtInfo.experiments){n.next=4;break}return n.abrupt("return");case 4:if(this.config.abtestUrl){n.next=6;break}return n.abrupt("return");case 6:return n.prev=6,n.next=9,this.core.adapters.request(this.config.abtestUrl,{method:"POST",dataType:"json",headers:{sdktype:"ABTest"},data:{clientInfo:{projectKey:this.config.abtestProjectKey,appKey:this.core.options.appkey,osType:"Web",sdkVersion:"10.7.0",deviceId:this.core.config.deviceId},useLocalCache:!0}},{exception_service:7});case 9:r=n.sent,n.next=15;break;case 12:n.prev=12,n.t0=n.catch(6),this.core.logger.warn("ABTest request failed");case 15:this.abtInfo=(null===(t=null===(e=null==r?void 0:r.data)||void 0===e?void 0:e.data)||void 0===t?void 0:t.abtInfo)||{};case 16:case"end":return n.stop()}}),_callee,this,[[6,12]])})))},ABTest}();function getPromiseWithAbort(e){var t={},r=new Pi((function(e,r){t.abort=r}));return t.promise=Pi.race([e,r]),t}Pi.reject;var fd=function(){function PromiseManager(){this.abortFns=[]}var e=PromiseManager.prototype;return e.add=function add(e){var t=getPromiseWithAbort(e);return this.abortFns.push(t.abort),t.promise},e.clear=function clear(e){var t;forEach$1(t=this.abortFns).call(t,(function(t){return t(e||new Sl({code:_l.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"Aborted"}}))})),this.abortFns=[]},e.destroy=function destroy(){this.clear()},PromiseManager}(),yd=nd.trim,_d=i.parseInt,Md=i.Symbol,Id=Md&&Md.iterator,Sd=/^[+-]?0x/i,Td=g(Sd.exec),Cd=8!==_d(Xl+"08")||22!==_d(Xl+"0x16")||Id&&!fails((function(){_d(Object(Id))}))?function parseInt(e,t){var r=yd(toString(e));return _d(r,t>>>0||(Td(Sd,r)?16:10))}:_d;_export({global:!0,forced:parseInt!=Cd},{parseInt:Cd});var bd=N.parseInt;function get(e,t){if("object"!=typeof e||null===e)return e;for(var r=(t=t||"").split("."),n=0;n<r.length;n++){var a=r[n],i=e[a],o=indexOf(a).call(a,"["),s=indexOf(a).call(a,"]");if(-1!==o&&-1!==s&&o<s){var c=slice(a).call(a,0,o),l=bd(slice(a).call(a,o+1,s));i=e[c],i=En(i)?i[l]:void 0}if(null==i)return i;e=i}return e}var Ed={tolerantRTT:3e3,bestRTT:100,maxChances:5,enable:!0},Rd={timestamp:0,rtt:0,baseClock:0,baseTime:0},kd=function(){function TimeOrigin(e,t,r){void 0===r&&(r="getServerTime"),this.serverOrigin=Rd,this.config=Ed,this.isSettingNTP=!1,this.currentChance=0,this.failedDelay=2e3,this.successDelay=3e5,this.timer=0,this.cmdName="getServerTime",this.core=e,this.logger=e.logger,this.promiseManager=new fd,this.cmdName=r,t&&this.setOptions(t)}var e=TimeOrigin.prototype;return e.setOptions=function setOptions(e){this.config=Et({},Ed,this.config,e)},e.reset=function reset(){this.timer&&clearTimeout(this.timer),this.promiseManager.clear(),this.serverOrigin=Rd,this.currentChance=0},e.setOriginTimetick=function setOriginTimetick(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e,t,r,n,a,i,o,s,c,l;return Dl.wrap((function _callee$(d){for(;;)switch(d.prev=d.next){case 0:if(this.config.enable){d.next=2;break}return d.abrupt("return");case 2:if(!this.isSettingNTP){d.next=4;break}return d.abrupt("return");case 4:if(!(this.currentChance>=this.config.maxChances)){d.next=6;break}return d.abrupt("return");case 6:if(e=get(this.core,"auth.status"),t=get(this.core,"status"),r=get(this.core,"V2NIMLoginService.lifeCycle.loginStatus"),"logined"===e||"logined"===t||1===r){d.next=11;break}return d.abrupt("return");case 11:return this.isSettingNTP=!0,this.currentChance++,this.timer&&clearTimeout(this.timer),this.timer=0,n="TimeOrigin::setOriginTimetick:",a=Hi(),this.core.logger.debug(n+" getServerTime start, times "+this.currentChance),d.prev=18,d.next=21,this.promiseManager.add(this.core.sendCmd(this.cmdName));case 21:o=d.sent,i=get(o,"content.time"),this.isSettingNTP=!1,d.next=33;break;case 26:return d.prev=26,d.t0=d.catch(18),s=d.t0,this.isSettingNTP=!1,this.logger.warn(n+" Calculate Delay time, getServerTime error",s),s.code!==_l.V2NIM_ERROR_CODE_CANCELLED&&(this.timer=eo(bind$1(c=this.setOriginTimetick).call(c,this),this.failedDelay)),d.abrupt("return");case 33:if(i){d.next=37;break}return this.core.logger.warn(n+" Calculate Delay time incorrect format"),this.config.enable=!1,d.abrupt("return");case 37:l=Hi()-a,this.doSet(i,l);case 39:case"end":return d.stop()}}),_callee,this,[[18,26]])})))},e.doSet=function doSet(e,t){var r,n="TimeOrigin::setOriginTimetick:";if(t>this.config.tolerantRTT)this.logger.warn(n+" Denied, cause of exceeding the maximum tolerance range of RTT: "+t),this.timer=eo(bind$1(r=this.setOriginTimetick).call(r,this),this.failedDelay);else if(t>this.config.bestRTT){var a;this.serverOrigin.rtt&&t>=this.serverOrigin.rtt?this.logger.warn(n+" Denied, cause of current.RTT >= serverOrigin.RTT: "+t):(this.setServerOrigin(t,e),this.logger.log(n+" Accept within maximum tolerance range of RTT: "+t+", ntpTimestamp: "+this.serverOrigin.timestamp+", localClock: "+this.serverOrigin.baseClock+", localTime: "+this.serverOrigin.baseTime)),this.timer=eo(bind$1(a=this.setOriginTimetick).call(a,this),this.failedDelay)}else{var i;this.setServerOrigin(t,e),this.logger.debug(n+" Accept within best RTT: "+t+", ntpTimestamp: "+this.serverOrigin.timestamp+", localClock: "+this.serverOrigin.baseClock+", localTime: "+this.serverOrigin.baseTime),this.currentChance=0,this.timer=eo(bind$1(i=this.setOriginTimetick).call(i,this),this.successDelay)}},e.getNTPTime=function getNTPTime(e){if(void 0===e&&(e=this.getTimeNode()),this.checkNodeReliable(e)){var t=Math.floor(e.time-this.serverOrigin.baseTime);return this.serverOrigin.timestamp+t}return Hi()},e.checkNodeReliable=function checkNodeReliable(e){if(void 0===e&&(e=this.getTimeNode()),this.serverOrigin.timestamp){if(0===this.serverOrigin.baseClock)return!0;var t=e.clock-this.serverOrigin.baseClock,r=e.time-this.serverOrigin.baseTime;return Math.abs(r-t)<500}return!1},e.checkPerformance=function checkPerformance(){return"BROWSER"===ql.platform&&!("undefined"==typeof performance||!performance.now)},TimeOrigin.checkPerformance=function checkPerformance(){return"BROWSER"===ql.platform&&!("undefined"==typeof performance||!performance.now)},e.getTimeNode=function getTimeNode(){return{clock:this.checkPerformance()?performance.now():0,time:Hi()}},TimeOrigin.getTimeNode=function getTimeNode(){return{clock:TimeOrigin.checkPerformance()?performance.now():0,time:Hi()}},e.setServerOrigin=function setServerOrigin(e,t){this.serverOrigin={timestamp:t+Math.floor(e/2),rtt:e,baseClock:this.checkPerformance()?performance.now():0,baseTime:Hi()}},TimeOrigin}(),wd={user_id:"",trace_id:"",action:7,exception_service:6,duration:0,start_time:0,state:1,extension:[]},Ad=function(){function ReporterHookLinkKeep(e,t){this.traceData=wd,this.core=e,this.traceData=Et({},wd,t),this.traceData.extension=[]}var e=ReporterHookLinkKeep.prototype;return e.reset=function reset(){this.traceData=Et({},wd),this.traceData.extension=[]},e.start=function start(){var e,t;this.reset(),this.traceData.user_id=this.core.account,this.traceData.trace_id=(null===(t=null===(e=this.core.clientSocket)||void 0===e?void 0:e.socket)||void 0===t?void 0:t.sessionId)||"",this.traceData.start_time=(new Date).getTime()},e.update=function update(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n;return Dl.wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,ql.net.getNetworkStatus();case 2:t=a.sent,r=t.net_type,n=t.net_connect,this.traceData.extension.push(Et({code:0,foreground:!0,foreg_backg_switch:!1,net_type:r,net_connect:n},e));case 6:case"end":return a.stop()}}),_callee,this)})))},e.end=function end(e){var t=this.traceData.extension[0],r=this.traceData.extension[1];if(t&&0===t.operation_type&&r&&1===r.operation_type){var n=t.net_type!==r.net_type||t.net_connect!==r.net_connect;if(e||!n)return this.traceData.duration=(new Date).getTime()-this.traceData.start_time,this.core.reporter.report("exceptions",this.traceData),void this.reset();this.reset()}else this.reset()},ReporterHookLinkKeep}(),Nd={user_id:"",trace_id:"",net_connect:!0,net_type:0,duration:0,start_time:0,history:[],succeed:!1},xd=function(){function ReporterHookLBS(e){this.traceData=Nd,this.core=e,this.reset()}var e=ReporterHookLBS.prototype;return e.reset=function reset(){this.traceData=Et({},Nd),this.traceData.history=[]},e.start=function start(e){this.reset(),this.traceData.user_id=e,this.traceData.start_time=Hi()},e.updateBegin=function updateBegin(e){this.traceData.history.push(Et({head:"",body:"",start_time:Hi(),httpdns:!1,index:0},e))},e.updateComplete=function updateComplete(e){var t;forEach$1(t=this.traceData.history).call(t,(function(t){t.target===e.target&&(Et(t,e),t.duration=Hi()-t.start_time)}))},e.end=function end(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a;return Dl.wrap((function _callee$(i){for(;;)switch(i.prev=i.next){case 0:if(this.traceData.succeed=e,this.traceData.history=filter(t=this.traceData.history).call(t,(function(e){return void 0!==e.code})),0!==this.traceData.history.length){i.next=5;break}return this.reset(),i.abrupt("return");case 5:return this.traceData.duration=Hi()-this.traceData.start_time,i.next=8,ql.net.getNetworkStatus();case 8:r=i.sent,n=r.net_type,a=r.net_connect,this.traceData.net_type=n,this.traceData.net_connect=a,this.core.reporter.report("nim_sdk_lbs_records",this.traceData),this.reset();case 15:case"end":return i.stop()}}),_callee,this)})))},ReporterHookLBS}();function getIsDataReportEnable(e){var t,r,n=!0;return"boolean"==typeof(null===(t=null==e?void 0:e.reporterConfig)||void 0===t?void 0:t.enableCompass)?n=e.reporterConfig.enableCompass:"boolean"==typeof(null===(r=null==e?void 0:e.reporterConfig)||void 0===r?void 0:r.isDataReportEnable)&&(n=e.reporterConfig.isDataReportEnable),n}var Od={user_id:"",trace_id:"",action:0,state:0,duration:0,start_time:0,offset:0,full_size:0,transferred_size:0,operation_type:0,remote_addr:""},Pd="ReporterHook::setMonitorForResources:",Ld=function(){function ReporterHookCloudStorage(e,t){this.traceData=Od,this.core=e,this.traceData=Et({},Od,t)}var e=ReporterHookCloudStorage.prototype;return e.reset=function reset(){this.traceData=Et({},Od)},e.start=function start(){var e,t;this.reset(),this.traceData.user_id=this.core.account,this.traceData.trace_id=(null===(t=null===(e=this.core.clientSocket)||void 0===e?void 0:e.socket)||void 0===t?void 0:t.sessionId)||"",this.traceData.start_time="timeOrigin"in this.core?this.core.timeOrigin.getNTPTime():Hi()},e.update=function update(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(this.traceData.user_id){t.next=2;break}return t.abrupt("return");case 2:this.core.logger.log(Pd+" upload update",e),Et(this.traceData,e);case 4:case"end":return t.stop()}}),_callee,this)})))},e.end=function end(e){this.traceData.user_id&&(this.core.logger.log(Pd+" upload end cause of "+e),this.traceData.state=e,this.traceData.duration=("timeOrigin"in this.core?this.core.timeOrigin.getNTPTime():Hi())-this.traceData.start_time,this.core.reporter.report("nim_sdk_resources",this.traceData),this.traceData=Od)},ReporterHookCloudStorage}(),Vd={},Ud={},Dd={},qd={apiVersion:"v1",debugLevel:"off",needReconnect:!0,reconnectionAttempts:Mt,lbsUrls:pd,linkUrl:ud,abtestUrl:md,isAbtestEnable:!0},Bd=function(e){function NIM(t,r){var n,a,i;if(void 0===r&&(r={}),(i=e.call(this)||this).instanceName="NIM",i.pluginMap={},i.eventBus=new to,i.options={},i.V2NIMConversationIdUtil={},i.V2NIMMessageCreator={},i.V2NIMMessageAttachmentCreator={},i.V2NIMClientAntispamUtil={},i.DataStructureConverter={},i.V2NIMMessageConverter={},i.V2NIMMessageLogUtil={},i.V2NIMMessageExtendUtil={},i.V2NIMStorageUtil={},i.V2NIMNotificationService={},i.V2NIMStorageService={},i.auth={},i.V1NIMLoginService={},i.V2NIMLoginService={},i.clientSocket={},i.V2NIMSyncService={},i.V2NIMConversationService={},i.V2NIMConversationGroupService={},i.V2NIMMessageService={},i.V2NIMTeamService={},i.V2NIMUserService={},i.V2NIMFriendService={},i.V2NIMSettingService={},i.V2NIMAIService={},i.V2NIMSignallingService={},i.V2NIMSubscriptionService={},i.V2NIMPassthroughService={},i.YSFService={},i.offlinePush={},i.sync={},i.msg={},i.msgLog={},i.session={},i.cloudSession={},i.misc={},i.user={},i.friend={},i.systemMessage={},i.team={},i.event={},i.msgExtend={},i.cloudStorage={},i.passThrough={},i.superTeam={},i.plugin={},i.signaling={},i.qchatChannel={},i.qchatMedia={},i.qchatMsg={},i.qchatRole={},i.qchatServer={},i.pluginMap=Dd,i.logger=new Hl(t.debugLevel,r.loggerConfig),r.privateConf){var o=i.getConfigFromPrivate(r.privateConf),s=o.authConfig,c=o.cloudStorageConfig,l=o.reporterConfig;Et(t,s),i.setInitOptions(t),i.otherOptions=Et(Et({},r),{cloudStorageConfig:Et(Et({storageKeyPrefix:"NIM"},r.cloudStorageConfig),c),reporterConfig:Et(Et({},r.reporterConfig),l),V1NIMLoginServiceConfig:Et(Et(Et({},t),r.V1NIMLoginServiceConfig),s),V2NIMLoginServiceConfig:Et(Et({},r.V2NIMLoginServiceConfig),s)})}else i.setInitOptions(t),i.otherOptions=Et(Et({},r),{V1NIMLoginServiceConfig:Et(Et({},t),r.V1NIMLoginServiceConfig),cloudStorageConfig:Et({storageKeyPrefix:"NIM"},r.cloudStorageConfig)});i.timerManager=new Pl,i.timeOrigin=new kd(De(i)),i.adapters=new dd(De(i)),i.abtest=new vd(De(i),Et(Et({isAbtestEnable:i.options.isAbtestEnable,abtestUrl:i.options.abtestUrl},i.otherOptions.abtestConfig),{abtestProjectKey:hd}));var d=ql.getSystemInfo(),u=function getCompassDataEndpoint(e,t){var r,n,a=null===(r=null==t?void 0:t.reporterConfig)||void 0===r?void 0:r.compassDataEndpoint,i=null===(n=null==t?void 0:t.reporterConfig)||void 0===n?void 0:n.reportConfigUrl;if(a)return a;if(i){var o=i.match(/^https:\/\/([^/]+)\/*/);return En(o)&&o.length>=1?"https://"+o[1]:(e.error("Invalid reportConfigUrl: "+i),gd)}return gd}(i.logger,i.otherOptions);i.reporter=new Ms(Et(Et({},u?{compassDataEndpoint:u}:{}),{isDataReportEnable:getIsDataReportEnable(i.otherOptions),common:{app_key:t.appkey,dev_id:"",platform:"Web",sdk_ver:"10.7.0",env:"online",os_name:d.os,os_ver:d.osVer,lib_env:d.libEnv,host_env:d.hostEnv,host_env_ver:d.hostEnvVer,manufactor:d.manufactor,model:d.model,v2:"v1"!==i.options.apiVersion},request:ql.request,logger:i.logger,autoStart:!0})),i.reporterHookLinkKeep=new Ad(De(i)),i.reporterHookCloudStorage=new Ld(De(i)),i.reporterHookLBS=new xd(De(i)),ql.setLogger(i.logger);var p=i.getServiceKeys(Nt(Vd));return forEach$1(p).call(p,(function(e){var t=Vd[e];i[e]=new t(De(i))})),forEach$1(n=Nt(Vd)).call(n,(function(e){i.callSetOptions(e)})),forEach$1(a=Nt(Ud)).call(a,(function(e){var t=Ud[e];void 0!==t&&(i[e]=new t(De(i)))})),NIM.instance=De(i),i.logger.log("NIM init, version:10.7.0, sdk version:100700, appkey:"+t.appkey),i}_t(NIM,e);var t=NIM.prototype;return t.getServiceKeys=function getServiceKeys(e){var t=findIndex$1(e).call(e,(function(e){return"V1NIMLoginService"===e}));if(t>-1){var r=e[t];splice(e).call(e,t,1),"v1"===this.options.apiVersion&&e.unshift(r)}var n=findIndex$1(e).call(e,(function(e){return"V2NIMLoginService"===e}));if(n>-1){var a=e[n];splice(e).call(e,n,1),"v2"===this.options.apiVersion&&e.unshift(a)}var i=findIndex$1(e).call(e,(function(e){return"sync"===e}));if(i>-1){var o=e[i];splice(e).call(e,i,1),"v1"===this.options.apiVersion&&e.push(o)}var s=findIndex$1(e).call(e,(function(e){return"V2NIMSyncService"===e}));if(s>-1){var c=e[s];splice(e).call(e,s,1),"v2"===this.options.apiVersion&&e.push(c)}return e},NIM.getInstance=function getInstance(e,t){if(!NIM.instance){if(e)return new NIM(e,t);throw new Error("Instance not exist, please input options")}if(e){if(NIM.instance.options.account===e.account&&NIM.instance.options.appkey===e.appkey)return NIM.instance.setOptions(e),NIM.instance;throw new Error("Unexpected login")}return NIM.instance},t.setInitOptions=function setInitOptions(e){validate({appkey:{type:"string"},apiVersion:{type:"enum",values:["v1","v2"],required:!1},binaryWebsocket:{type:"boolean",required:!1},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},customClientType:{type:"number",min:1,required:!1},authType:{type:"number",min:0,max:2,required:!1},lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},e),this.options=Et(Et({},qd),e)},t.getConfigFromPrivate=function getConfigFromPrivate(e){return e?{authConfig:JSON.parse(bn({appkey:e.appkey||void 0,lbsUrls:e.weblbsUrl?[e.weblbsUrl]:void 0,linkUrl:e.link_web||void 0})),cloudStorageConfig:JSON.parse(bn({chunkUploadHost:e.nos_uploader||void 0,commonUploadHost:e.nos_uploader||void 0,commonUploadHostBackupList:e.nos_uploader?[e.nos_uploader]:void 0,chunkUploadHostBackupList:e.nos_uploader?[e.nos_uploader]:void 0,uploadReplaceFormat:e.nos_downloader_v2?(e.nosSsl?"https://":"http://")+e.nos_downloader_v2:void 0,downloadUrl:void 0!==e.nos_accelerate?e.nos_accelerate:void 0,downloadHostList:""===e.nos_accelerate_host?[]:"string"==typeof e.nos_accelerate_host?[e.nos_accelerate_host]:En(e.nos_accelerate_host)?e.nos_accelerate_host:void 0})),reporterConfig:JSON.parse(bn({enableCompass:"boolean"==typeof e.enableCompass?e.enableCompass:void 0,compassDataEndpoint:e.compassDataEndpoint||void 0}))}:{authConfig:{},cloudStorageConfig:{},reporterConfig:{}}},t.connect=function connect(e){return void 0===e&&(e={}),this.V1NIMLoginService.login(e)},t.setOptions=function setOptions(e){if("object"==typeof e&&null!==e){if(Object.prototype.hasOwnProperty.call(e,"account")&&e.account!==this.options.account||Object.prototype.hasOwnProperty.call(e,"appkey")&&e.appkey!==this.options.appkey)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions account and appkey is not allowed to reset"}});if(Object.prototype.hasOwnProperty.call(e,"apiVersion")&&e.apiVersion!==this.options.apiVersion)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions apiVersion is not allowed to reset"}});if(Object.prototype.hasOwnProperty.call(e,"binaryWebsocket")&&e.binaryWebsocket!==this.options.binaryWebsocket)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"NIM::setOptions binaryWebsocket is not allowed to reset"}});validate({token:{type:"string",required:!1},needReconnect:{type:"boolean",required:!1},reconnectionAttempts:{type:"number",required:!1},customClientType:{type:"number",min:1,required:!1},authType:{type:"number",min:0,max:2,required:!1},lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},e),this.logger.log("NIM::setOptions options is",e),this.options=Et(Et({},this.options),e),this.V1NIMLoginService.setOptions&&this.V1NIMLoginService.setOptions(this.options)}},t.disconnect=function disconnect(){return this.V1NIMLoginService.logout()},t._disconnect=function _disconnect(){return"v1"===this.options.apiVersion?this.V1NIMLoginService.logout():"v2"===this.options.apiVersion?0===get(this.V2NIMLoginService,"lifeCycle.connectStatus")&&0===get(this.V2NIMLoginService,"lifeCycle.loginStatus")?Pi.resolve():this.V2NIMLoginService.logout():Pi.resolve()},t.destroy=function destroy(){var e=this;return NIM.instance=void 0,this._disconnect().then((function(){e.status="destroyed",e.removeAllListeners(),e.eventBus.removeAllListeners(),e.logger.destroy(),e.reporter.destroy(),e.timerManager.destroy(),e._clearModuleData("destroy"),e._removeAllModuleListeners(),e.connect=emptyFuncWithPromise,e.disconnect=emptyFuncWithPromise,e._disconnect=emptyFuncWithPromise,e.destroy=emptyFuncWithPromise}))},t._clearModuleData=function _clearModuleData(e){void 0===e&&(e="logout");var t=Bi(this);forEach$1(t).call(t,(function(t){t&&"function"==typeof t.reset&&t.reset(e)}))},t._removeAllModuleListeners=function _removeAllModuleListeners(){var e=Bi(this);forEach$1(e).call(e,(function(e){e&&"function"==typeof e.removeAllListeners&&e.removeAllListeners()}))},t.kick=function kick(e){return this.V1NIMLoginService.kick(e)},t.sendCmd=function sendCmd(e,t,r){return this.clientSocket.sendCmd(e,t,r)},t.emit=function emit(t){var r=this;try{for(var n,a,i=Hi(),o=arguments.length,s=new Array(o>1?o-1:0),c=1;c<o;c++)s[c-1]=arguments[c];var l=(n=e.prototype.emit).call.apply(n,concat(a=[this,t]).call(a,s)),d=Hi()-i;return d>=10&&this.logger.warn("Core::emit event: "+t+" process takes: "+d+"ms"),l}catch(e){return this.logger.error("Core::emit event: "+t+". Error: "+e),eo((function(){throw r.logger.error("Core::emit throw error in setTimeout. event: "+t+". Error: "+e),e}),0),!1}},t._registerDep=function _registerDep(e,t){this[t]&&this[t].name||(this[t]=new e(this),this.callSetOptions(t))},t.callSetOptions=function callSetOptions(e){var t=e+"Config",r=e+"Options",n=this.otherOptions[t]||this.otherOptions[r]||{},a=get(this,e+".setOptions");"function"==typeof a&&("cloudStorage"===e&&(n=this.otherOptions[t]||this.otherOptions.serverConfig||{}),a.call(this[e],n))},NIM.registerService=function registerService(e,t){Vd[t]=e},NIM.registerPrivateService=function registerPrivateService(e,t){Ud[t]=e},NIM.registerPlugin=function registerPlugin(e,t){Dd[t]=e},Ue(NIM,[{key:"account",get:function get(){return this.auth.account}},{key:"status",get:function get(){return this.V1NIMLoginService.status},set:function set(e){this.V1NIMLoginService.status=e}},{key:"config",get:function get(){return{timeout:8e3,deviceId:this.auth.deviceId}}}]),NIM}(to);Bd.sdkVersion=100700,Bd.sdkVersionFormat="10.7.0";var Fd=createCommonjsModule((function(e,t){e.exports=function(){function object2String(e){if(e){var t,r="";return forEach$1(t=Nt(e)).call(t,(function(t,n){r+=0===n?"?":"&",r+=t+"="+e[t]})),r}return""}var e=function(e){function V2NIMError(t,r,n,a){var i;return(i=e.call(this,n)||this).source=t,i.code=r,i.desc=n,i.detail=a||{},i}return _t(V2NIMError,e),V2NIMError}(yc(Error));function request(t,r){void 0===r&&(r={dataType:"json",method:"GET",timeout:5e3});var n="text"===r.dataType?"text/plain; charset=UTF-8":"application/json; charset=UTF-8",a="GET"===r.method?object2String(r.params):"";return new Pi((function(i,o){if(window.XMLHttpRequest){var s,c=new XMLHttpRequest;if(c.onreadystatechange=function(){if(4===c.readyState)if(200===c.status){try{s=JSON.parse(c.response||"{}")}catch(e){s=c.response}i({status:c.status,data:s})}else eo((function(){o(new e(1,c.status,"readyState: "+c.readyState+"; statusText: "+c.statusText))}),0)},c.open(r.method,""+t+a),c.timeout=r.timeout||5e3,c.setRequestHeader("Content-Type",n),r.headers)for(var l in r.headers)c.setRequestHeader(l,r.headers[l]);c.ontimeout=function(t){o(new e(1,408,t&&t.message?t.message:"request timeout"))},c.send(bn(r.data))}else o(new e(2,10400,"request no suppout"))}))}return request}()})),Gd={},Hd={clear:function clear(){Gd={}},getItem:function getItem(e){return Gd[e]},setItem:function setItem(e,t){Gd[e]=t},removeItem:function removeItem(e){delete Gd[e]}},jd=nd.trim,$d=g("".charAt),zd=i.parseFloat,Wd=i.Symbol,Kd=Wd&&Wd.iterator,Yd=1/zd(Xl+"-0")!=-1/0||Kd&&!fails((function(){zd(Object(Kd))}))?function parseFloat(e){var t=jd(toString(e)),r=zd(t);return 0===r&&"-"==$d(t,0)?-0:r}:zd;_export({global:!0,forced:parseFloat!=Yd},{parseFloat:Yd});var Qd=N.parseFloat,Jd=Hr.some,Xd=arrayMethodIsStrict("some");_export({target:"Array",proto:!0,forced:!Xd},{some:function some(e){return Jd(this,e,arguments.length>1?arguments[1]:void 0)}});var Zd=entryVirtual("Array").some,eu=Array.prototype,some=function(e){var t=e.some;return e===eu||x(eu,e)&&t===eu.some?Zd:t},tu={debug:function debug(){},log:function log(){},warn:function warn(){},error:function error(){}};function setLogger(e){tu=e}function uploadFileFn(e){var t=function getLogger(){return tu}(),r=e.headers||{};return e.md5&&(r["Content-MD5"]=e.md5),new Pi((function(n,a){var i=new FormData;i.append("file",{uri:e.filePath,type:"multipart/form-data",name:"image.png"}),i.append("Object",decodeURIComponent(e.nosToken.objectName)),i.append("x-nos-token",e.nosToken.token),i.append("x-nos-entity-type","json");var o,s=new XMLHttpRequest;(s.open("POST",e.commonUploadHost+"/"+e.nosToken.bucket,!0),s.setRequestHeader("Content-Type","multipart/form-data"),r)&&forEach$1(o=Nt(r)).call(o,(function(e){s.setRequestHeader(e,r[e])}));s.onreadystatechange=function(){if(4===s.readyState)if(200===s.status)try{var t=JSON.parse(s.response);t.name=e.filePath,t.ext="",n(t)}catch(e){a(new Error("JSON parse failed, status is: "+s.status+", reponse is: "+s.response))}else a(new Sl({code:_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED,detail:{reason:"uploadFile failed. status: "+s.status+", responseText: "+s.responseText}}))},s.onabort=function(){a(new Sl({code:_l.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"uploadFile has been aborted"}}))},s.upload.onprogress=function(t){e.onUploadProgress&&e.onUploadProgress({total:t.total,loaded:t.loaded,percentage:Qd((t.loaded/t.total).toFixed(2)),percentageText:(t.loaded/t.total*100).toFixed(2)+"%"})};try{e.onUploadStart&&e.onUploadStart({abort:function abort(){a(new Sl({code:_l.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"uploadFile has been aborted"}})),s.abort()}})}catch(e){t.error("uploadFile: options.onUploadStart error",e),s.abort(),a(e)}s.send(i)}))}function getFileUploadInformationFn(e){return null}function getSystemInfoFn(){return{os:t.Platform.OS,osVer:"React Native",browser:"React Native",browserVer:"React Native",libEnv:"React Native",hostEnv:"RN",hostEnvEnum:2,hostEnvVer:"React Native",userAgent:"NIM/Web/RN/V10.7.0/{{appkey}}",model:"React Native",manufactor:"React Native"}}var ru={getNetworkStatus:function getNetworkStatus(){return Pi.resolve({net_type:0,net_connect:!0})},onNetworkStatusChange:function onNetworkStatusChange(){},offNetworkStatusChange:function offNetworkStatusChange(){}};function _createForOfIteratorHelperLoose$a(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$a(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$a(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$a(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var nu={},au={};function createCmd(e,t,r,n){var a=nu[e];if(!a)return r.error("createCmd:: can not find cmd config: ",e),null;var i,o={SER:t,SID:a.sid,CID:a.cid,Q:[]};a.params&&n&&forEach$1(i=a.params).call(i,(function(e){var t=n[e.name];if(null!=t){var r=e.type,a=e.reflectMapper,i=e.select;switch(e.type){case"PropertyArray":r="ArrayMable",t=map$6(t).call(t,(function(e){return{t:"Property",v:a?serialize(e,a,i):e}}));break;case"Property":t=a?serialize(t,a,i):t;break;case"Bool":t=t?"true":"false"}o.Q.push({t:r,v:t})}}));return{packet:o,hasPacketResponse:"boolean"!=typeof a.hasPacketResponse||a.hasPacketResponse,hasPacketTimer:"boolean"!=typeof a.hasPacketTimer||a.hasPacketTimer}}function parseCmd(e,t){var r,n;try{n=JSON.parse(e)}catch(r){return void t.error('Parse command error:"'+e+'"')}var a=n.sid+"_"+n.cid,i=n.r;if(includes(r=["4_1","4_2","4_10","4_11"]).call(r,a)){var o=n.r[1].headerPacket;a=o.sid+"_"+o.cid,n.sid=o.sid,n.cid=o.cid,i=n.r[1].body}var s=au[a],c=[];if(s){for(var l,d=_createForOfIteratorHelperLoose$a(s);!(l=d()).done;){var u=l.value;c.push(parseEachCmd(n,u.config,u.cmd,i,t))}return c}t.error("parseCmd:: mapper not exist",a,n.code)}function parseEachCmd(e,t,r,n,a){var i,o={cmd:r,raw:e,error:null,service:null==t?void 0:t.service,content:{},__receiveTimeNode:kd.getTimeNode()};if(!r||!t)return o.notFound=!0,o;(18===t.sid||t.sid>=26&&t.sid<100)&&(e.code=function toReadableCode(e){if("number"!=typeof e||e!=e)throw new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"Read code failed",rawData:""+e}});if(e<0||e>=0&&e<1e3||e>=2e4&&e<=20099)return e;var t=(65535&e)>>9;t-=t<=38?1:2;return 1e5+1e3*t+(511&e)}(e.code));var s,c=function genCmdError(e,t){var r=Ml[e],n=kl[e];return null===n?null:new Sl({code:e,desc:r||n||e,detail:{cmd:t,timetag:Hi()}})}(e.code,r);if(o.error=c,o.error){if(o.error.detail.cmd=r,!(null===(i=null==t?void 0:t.ignoreErrCodes)||void 0===i?void 0:includes(i).call(i,e.code)))return o;a.warn("parseCmd:: ignore error ",o.error),o.error.detail.ignore=!0}t.response&&forEach$1(s=t.response).call(s,(function(e,t){var r=n[t],a=e.type,i=e.name,s=e.reflectMapper;if(void 0!==r)switch(a){case"Property":o.content[i]=s?deserialize(r,s):r;break;case"PropertyArray":o.content[i]=map$6(r).call(r,(function(e){return s?deserialize(e,s):e}));break;case"Int":case"Long":case"Byte":o.content[i]=+r;break;case"Bool":o.content[i]="true"===r||!0===r||1===r;break;default:o.content[i]=r}}));return o}function serialize(e,t,r){var n={};for(var a in e=function flattenObjByMapper(e,t){var r={};for(var n in t){for(var a,i=t[n],o="number"==typeof i?n:i.access?i.access:n,s=e,c=_createForOfIteratorHelperLoose$a(o.split("."));!(a=c()).done;){var l=a.value;if(void 0===s[l]||null===s[l]){s=void 0;break}s=s[l]}void 0!==s&&(r[o]=s)}return r}(e,t),t){var i=t[a],o="number"==typeof i?a:i.access?i.access:a;if(!r||includes(r).call(r,a))if(o in e){if("number"==typeof i)n[i]=e[o];else if("object"==typeof i)if(i.converter){var s=i.converter(e[o],e);void 0!==s&&(n[i.id]=s)}else n[i.id]=e[o]}else"object"==typeof i&&i.def&&("function"==typeof i.def?n[i.id]=i.def(e):n[i.id]=i.def)}return n}function deserialize(e,t){var r={};for(var n in e){var a=t[n];if("string"==typeof a)r[a]=e[n];else if("object"==typeof a&&"prop"in a){var i=a.access?a.access:a.prop;if(a.converter){var o=a.converter(e[n],e);void 0!==o&&(r[i]=o)}else a.type&&"number"===a.type?r[i]=+e[n]:a.type&&"boolean"===a.type?r[i]=!("0"===e[n]||!e[n]):r[i]=e[n]}}for(var s in t){var c=t[s];if(c&&void 0!==c.def){var l=c.access?c.access:c.prop;l in r||("function"==typeof c.def?r[l]=c.def(e):r[l]=c.def)}}return r=function unflattenObj(e){var t={},r=function _loop(r){var n=r.split(".");reduce(n).call(n,(function(t,a,i){return t[a]||(t[a]=isNaN(Number(n[i+1]))?n.length-1==i?e[r]:{}:[])}),t)};for(var n in e)r(n);return t}(r),r}function registerParser(e){for(var t in Et(nu,e.cmdConfig),e.cmdMap){var r=e.cmdMap[t],n=e.cmdConfig[r];if(n)if(En(au[t])){for(var a,i=!1,o=_createForOfIteratorHelperLoose$a(au[t]);!(a=o()).done;){var s=a.value;if(s.cmd===r&&s.config.service===n.service){i=!0;break}}i||au[t].push({config:n,cmd:r})}else au[t]=[{config:n,cmd:r}]}}function invertSerializeMap(e){var t,r={};return forEach$1(t=Nt(e)).call(t,(function(t){r[t]=invertSerializeItem(e[t])})),r}function invertSerializeItem(e){var t={};for(var r in e){var n=e[r];"number"==typeof n?t[n]=r:"object"==typeof n&&(t[n.id]={prop:r,type:n.retType,access:n.retAccess?n.retAccess:n.access?n.access:r,def:n.retDef,converter:n.retConverter})}return t}function boolToInt(e){return e?1:0}function objectToJSONString(e){if(e&&"object"==typeof e)try{return bn(e)}catch(e){return}}function stringToJSONObject(e){if(e&&"string"==typeof e)try{return JSON.parse(e)}catch(e){return}}var iu,ou,su,cu,lu,du={"1_2":"heartbeat","2_3":"login","2_5":"kicked","2_6":"logout","2_7":"nimLoginClientChange","2_8":"kick"},uu={login:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,deviceId:13,appkey:18,account:19,browser:24,clientSession:26,deviceInfo:32,isReactNative:112,token:1e3,customTag:38,customClientType:39,sdkHumanVersion:40,hostEnv:41,userAgent:42,libEnv:44,authType:115,loginExt:116},loginRes:{lastLoginDeviceId:17,customTag:38,connectionId:102,ip:103,port:104,country:106,hasXMPush:111},loginPort:{type:3,os:4,mac:5,deviceId:13,account:19,deviceInfo:32,customTag:38,customClientType:39,connectionId:102,ip:103,port:104,time:109,pushType:110,hasTokenPreviously:111},aosPushInfo:{pushType:110,hasTokenPreviously:111}},pu=invertSerializeMap(uu),mu={login:{sid:2,cid:3,service:"auth",params:[{type:"Property",name:"login",reflectMapper:uu.login}],response:[{type:"Property",name:"loginRes",reflectMapper:pu.loginRes},{type:"PropertyArray",name:"loginPorts",reflectMapper:pu.loginPort},{type:"Property",name:"aosPushInfo",reflectMapper:pu.aosPushInfo}]},logout:{sid:2,cid:6,service:"auth"},heartbeat:{sid:1,cid:2,service:"auth"},kicked:{sid:2,cid:5,service:"auth",response:[{type:"Int",name:"clientType"},{type:"Int",name:"reason"},{type:"String",name:"ext"},{type:"Int",name:"customClientType"}]},nimLoginClientChange:{sid:2,cid:7,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:pu.loginPort}]},kick:{sid:2,cid:8,service:"auth",params:[{type:"StrArray",name:"deviceIds"}],response:[{type:"StrArray",name:"deviceIds"}]}};function format(e,t){if(!isPlainObject(t))return{};var r=JSON.parse(bn(t)),n=doFormat(e,r);return JSON.parse(bn(Et(Et({},r),n)))}function doFormat(e,t){if(!isPlainObject(t))return{};var r={},n=Nt(e);return forEach$1(n).call(n,(function(n){var a=e[n].type;if("string"!=typeof a){var i=doFormat(e[n],t);Nt(i).length>0&&(r[n]=i)}else{var o=e[n],s=o.rawKey||n,c=hu[a](t,s,o);void 0!==c&&(t[s]=void 0,r[n]=c)}})),r}!function(e){e[e.text=0]="text",e[e.image=1]="image",e[e.audio=2]="audio",e[e.video=3]="video",e[e.geo=4]="geo",e[e.notification=5]="notification",e[e.file=6]="file",e[e.tip=10]="tip",e[e.robot=11]="robot",e[e.g2=12]="g2",e[e.custom=100]="custom"}(iu||(iu={})),function(e){e[e.p2p=0]="p2p",e[e.team=1]="team",e[e.superTeam=5]="superTeam"}(ou||(ou={})),function(e){e[e.Android=1]="Android",e[e.iOS=2]="iOS",e[e.PC=4]="PC",e[e.WindowsPhone=8]="WindowsPhone",e[e.Web=16]="Web",e[e.Server=32]="Server",e[e.Mac=64]="Mac",e[e.HarmonyOS=65]="HarmonyOS"}(su||(su={})),function(e){e[e.unread=1]="unread",e[e.read=2]="read",e[e.deleted=3]="deleted",e[e.sending=4]="sending",e[e.sendFailed=5]="sendFailed",e[e.sent=6]="sent",e[e.receipt=7]="receipt",e[e.refused=10]="refused"}(cu||(cu={})),function(e){e[e.default=0]="default",e[e.leave=1]="leave",e[e.roam=2]="roam"}(lu||(lu={}));var hu={number:function number(e,t){if(void 0!==e[t])return+e[t]},string:function string(e,t){if(void 0!==e[t])return e[t]},boolean:function boolean(e,t){return+e[t]>0||0!=+e[t]&&void 0},enum:function _enum(e,t,r){return values(r)[e[t]]},object:function object(e,t){if(void 0!==e[t])try{return JSON.parse(e[t])}catch(e){return{}}}};function formatReverse(e,t){if(!isPlainObject(t))return{};var r=JSON.parse(bn(t)),n=doFormatReverse(e,r);return JSON.parse(bn(Et(Et({},r),n)))}function doFormatReverse(e,t){var r;if(!isPlainObject(t))return reduce(r=Nt(e)).call(r,(function(t,r){return t[e[r].rawKey||r]=void 0,t}),{});var n={},a=Nt(e);return forEach$1(a).call(a,(function(r){var a=e[r].type;if("string"!=typeof a){var i=doFormatReverse(e[r],t[r]);return Et(n,i),void(t[r]=void 0)}var o=e[r],s=o.rawKey||r,c=gu[a](t,r,o);t[s]=void 0,n[s]=c})),n}var gu={number:function number(e,t){return e[t]},string:function string(e,t){return e[t]},boolean:function boolean(e,t){return!0===e[t]?1:!1===e[t]?0:void 0},enum:function _enum(e,t,r){return values(r)[e[t]]},object:function object(e,t){if(void 0!==e[t])try{return bn(e[t])}catch(e){return""}}},vu=gu;function formatMultiPortLoginInfo(e,t){return e&&e.length>0?map$6(e).call(e,(function(e){return Et(Et({},e),{account:e.account,connectionId:e.connectionId,deviceId:e.deviceId,ip:e.ip,mac:e.mac,os:e.os,type:getEnumKeyByEnumValue(su,e.type)||e.type,time:bd(e.time),online:3!==t})})):[]}var fu={1:{reason:"samePlatformKick",message:"The same account is not allowed to multiple login at the same time"},2:{reason:"serverKick",message:"Kicked out by IM server"},3:{reason:"otherPlatformKick",message:"Kicked out by other client of your account"},4:{reason:"silentlyKick",message:"Quietly kicked"}};var yu=Backoff;function Backoff(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}Backoff.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),r=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-r:e+r}return 0|Math.min(e,this.max)},Backoff.prototype.reset=function(){this.attempts=0},Backoff.prototype.setMin=function(e){this.ms=e},Backoff.prototype.setMax=function(e){this.max=e},Backoff.prototype.setJitter=function(e){this.jitter=e};var _u,Mu=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],Iu=["transport not supported","client not handshaken","unauthorized"],Su=["reconnect"],Tu=function(e){function BaseWebsocket(t,r){var n;return(n=e.call(this)||this).url=r,n.websocket=null,n.socketConnectTimer=0,n.core=t,n.url=r,n.status="disconnected",n.logger=t.logger,n.connect(),n}_t(BaseWebsocket,e);var t=BaseWebsocket.prototype;return t.connect=function connect(){var e=this;"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this.core.adapters.request("https://"+this.url+"/socket.io/1/?t="+Hi(),{method:"GET",dataType:"text",timeout:this.core.options.xhrConnectTimeout||8e3},{exception_service:6}).then((function(t){if("connecting"===e.status){var r=t.data.split(":"),n=r[0];return r[1],e.sessionId=n,e.logger.log("imsocket::XHR success. status "+e.status+", "+("connecting"===e.status?"continue websocket connection":"stop websocket connection")),e._createWebsocket("wss://"+e.url+"/socket.io/1/websocket/"+n)}})).catch((function(t){if("connecting"===e.status){var r='imsocket::XHR fail. raw message: "'+(t=t||{}).message+'", code: "'+t.code+'"',n=t.code;n="v2"===get(e.core,"options.apiVersion")?t.code===_l.V2NIM_ERROR_CODE_CONNECT_TIMEOUT?_l.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:_l.V2NIM_ERROR_CODE_CONNECT_FAILED:408===t.code?408:415;var a=new Sl({code:n,detail:{reason:r,rawError:t}});e.logger.error(r),e.status="disconnected",e.emit("handshakeFailed",a)}}))):this.logger.warn("imsocket::socket is connecting or connected",this.status)},t.close=function close(){if(this.status="disconnected",this.websocket){this.logger.log("imsocket:: close websocket");try{this.websocket.send(this.encodePacket({type:"disconnect"}))}catch(e){this.logger.warn("imsocket::attempt to send encodePacket error",e)}try{this.websocket.close()}catch(e){this.logger.warn("imsocket::attempt to close websocket error",e)}this.clean(),this.emit("disconnect",{code:0,reason:"Active close websocket"})}},t.clean=function clean(){this.status="disconnected",clearTimeout(this.socketConnectTimer),this.websocket&&(this.socketUrl=void 0,this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null,this.websocket.onclose=null,this.websocket=null)},t.onConnect=function onConnect(){this.status="connected",this.emit("connect"),clearTimeout(this.socketConnectTimer)},t._createWebsocket=function _createWebsocket(e){var t,r=this;this.socketConnectTimer=eo((function(){r.logger.error("imsocket::Websocket connect timeout. url: ",r.socketUrl),r.emit("handshakeFailed",new Sl({code:"v2"===get(r.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:415,detail:{reason:"imsocket::Websocket connect timeout. url: "+r.socketUrl}}))}),this.core.options.socketConnectTimeout||8e3),this.socketUrl=e,this.websocket=new ql.WebSocket(e),this.websocket.onmessage=bind$1(t=this.onMessage).call(t,this),this.websocket.onclose=function(e){var t=(null==e?void 0:e.reason)||(null==e?void 0:e.message)||(null==e?void 0:e.errMsg)||"websocket.onclose";r.logger.log("imsocket::Websocket onclose done. code is "+(null==e?void 0:e.code)+" and reason is "+t),r.clean(),r.emit("disconnect",{code:(null==e?void 0:e.code)||0,reason:t})},this.websocket.onerror=function(e){r.logger.error("imsocket::Websocket onerror",e),"logined"===r.core.status&&r.core.clientSocket.ping()}},t.onMessage=function onMessage(e){var t,r=this.decodePacket(e.data);if(r)switch(r.type){case"connect":this.onConnect();break;case"disconnect":this.close(),this.emit("disconnect",{code:0,reason:"MessageEvent type disconnect"});break;case"message":case"json":this.emit("message",r.data);break;case"event":r.name&&this.emit(r.name,r.args);break;case"error":"unauthorized"===r.reason?this.emit("connect_failed",r.reason):this.emit("error",r.reason),this.logger.error("imsocket::Websocket connect failed, onmessage type error. url: ",this.socketUrl),clearTimeout(this.socketConnectTimer),this.emit("handshakeFailed",new Sl({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_CONNECT_FAILED:408,detail:{reason:"imsocket::Websocket connect failed, onMessage socket error. url: "+this.socketUrl}}));break;case"heartbeat":null===(t=this.websocket)||void 0===t||t.send(this.encodePacket({type:"heartbeat"}));break;default:this.logger.warn("imsocket::Websocket no handler type",r.type)}},t.encodePacket=function encodePacket(e){var t,r,n=e.type,a=e.id,i=void 0===a?"":a,o=e.endpoint,s=void 0===o?"":o,c=e.ack,l=null;if(!n)return"";switch(n){case"error":t=e.reason?indexOf(Iu).call(Iu,e.reason):"",r=e.advice?indexOf(Su).call(Su,e.advice):"",""===t&&""===r||(l=t+(""!==r?"+"+r:""));break;case"message":""!==e.data&&(l=e.data);break;case"event":t={name:e.name},t=e.args&&e.args.length?{name:e.name,args:e.args}:{name:e.name},l=bn(t);break;case"json":l=bn(e.data);break;case"connect":e.qs&&(l=e.qs);break;case"ack":l=e.ackId+(e.args&&e.args.length?"+"+bn(e.args):"")}var d=[indexOf(Mu).call(Mu,n),i+("data"===c?"+":""),s];return null!=l&&d.push(l),d.join(":")},t.decodePacket=function decodePacket(e){if(e)if("ï¿½"!=e.charAt(0)){var t=e.match(/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/);if(t){var r,n=t[1],a=t[2],i=t[3],o=t[4],s=t[5],c={type:Mu[+n],endpoint:o};switch(a&&(c.id=a,c.ack=!i||"data"),c.type){case"error":r=s.split("+"),c.reason=Iu[+r[0]]||"";break;case"message":c.data=s||"";break;case"connect":c.qs=s||"";break;case"event":try{var l=JSON.parse(s);c.name=l.name,c.args=l.args}catch(e){this.logger.error("imsocket::parseData::type::event error",e)}c.args=c.args||[];break;case"json":try{c.data=JSON.parse(s)}catch(e){this.logger.error("imsocket::parseData::type::json error",e)}break;case"ack":if((r=s.match(/^([0-9]+)(\+)?(.*)/))&&(c.ackId=r[1],c.args=[],r[3]))try{c.args=r[3]?JSON.parse(r[3]):[]}catch(e){this.logger.error("imsocket::parseData::type::ack error",e)}}return c}}else this.logger.error("imsocket::unrecognize dataStr",slice(e).call(e,0,20))},t.send=function send(e){var t,r={data:e,type:"message",endpoint:""};null===(t=this.websocket)||void 0===t||t.send(this.encodePacket(r))},BaseWebsocket}(to);function uniq(e){e=e||[];for(var t=[],r=0;r<e.length;r++)-1===indexOf(t).call(t,e[r])&&t.push(e[r]);return t}function _createForOfIteratorHelperLoose$9(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$9(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$9(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$9(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$9(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(_u||(_u={}));var Cu=function(){function V1ClientSocket(e,t){this.linkUrls=[],this.isAutoReconnect=!1,this.packetTimeout=3e4,this.packetSer=1,this.retryCount=0,this.reconnectTimer=0,this.backoff=new yu({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new ic,this.pingTimer=0,this.hasNetworkListener=!1,this.core=e,t&&(this.auth=t),this.logger=e.logger,this.reporter=e.reporter,this.timerManager=e.timerManager}var e=V1ClientSocket.prototype;return e.setSessionId=function setSessionId(e){},e.connect=function connect(e,t){return void 0===e&&(e={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i,o,s;return Dl.wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:if(validate({linkUrls:{type:"array",itemType:"string",required:!1}},e),/^(unconnected|waitReconnect)$/.test(this.core.status)){c.next=5;break}return r="Core socket status is "+this.core.status+", and would not connect",this.logger.warn(r),c.abrupt("return",Pi.reject(r));case 5:this.core.status="connecting",e.linkUrls&&e.linkUrls.length>0&&(this.linkUrls=concat(n=e.linkUrls).call(n,this.linkUrls),this.linkUrls=uniq(this.linkUrls)),0===this.linkUrls.length&&this.linkUrls.push(ud),a=0;case 9:if(!(a<this.linkUrls.length)){c.next=31;break}return i=this.linkUrls[a],o=(new Date).getTime(),c.prev=12,c.next=15,this.doConnect(i);case 15:return this.core.status="connected",this.logger.log("clientsocketV1::connect success with url: "+i),c.abrupt("return",i);case 20:c.prev=20,c.t0=c.catch(12),s=c.t0,t&&t(s,i),this.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account,start_time:o,action:0,exception_service:6}),this.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof s.code?s.code:0,description:s.message||""+s.code,operation_type:0,target:i},{asyncParams:ql.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),this.logger.warn("clientsocketV1::connect failed with url: "+i,c.t0);case 28:a++,c.next=9;break;case 31:throw 0===this.retryCount?this.doDisconnect(_u.ACTIVE,"SocketHandshakeFailed"):this.doDisconnect(_u.OFFLINE,"ReconnectHadRetryAllLinks"),new Error("clientSocketV1::socket xhr or socket connect failed");case 33:case"end":return c.stop()}}),_callee,this,[[12,20]])})))},e.doConnect=function doConnect(e){var t=this,r=!1;return new Pi((function(n,a){var i;t.socket=new Tu(t.core,e),t.socket.on("connect",(function(){t.logger.log("clientSocketV1::on connect",e),t.core.reporterHookLinkKeep&&(t.core.reporterHookLinkKeep.start(),t.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:e})),r=!0,n()})),t.socket.on("message",bind$1(i=t.onMessage).call(i,t)),t.socket.on("disconnect",(function(n){return __awaiter(t,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:if(this.logger.log("clientSocketV1::socket on disconnect",n),!this.core.reporterHookLinkKeep){t.next=5;break}return t.next=4,this.core.reporterHookLinkKeep.update({code:(null==n?void 0:n.code)||0,description:(null==n?void 0:n.reason)||"socket on disconnect",operation_type:1,target:e});case 4:this.core.reporterHookLinkKeep.end(!1);case 5:r=!0,this.doDisconnect(_u.OFFLINE,"SocketOnDisconnect");case 7:case"end":return t.stop()}}),_callee2,this)})))})),t.socket.on("handshakeFailed",(function(e){r?t.ping():(t.logger.error('clientsocketV1::handshake failed: "'+(e&&e.message)+'"'),t.cleanSocket()),r=!0,a(e)}))}))},e.cleanSocket=function cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)},e.beforeConnect=function beforeConnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer)},e.resetConnectStatus=function resetConnectStatus(){clearTimeout(this.reconnectTimer),this.backoff.reset(),this.retryCount=0,this.initOnlineListener()},e.doDisconnect=function doDisconnect(e,t,r){var n,a,i,o,s;if(this.logger.log("doDisconnect: type "+e+", description "+t),"unconnected"!==this.core.status){var c={1:"close",2:"kicked",3:"broken"}[e]||"";this.markAllCmdInvaild(new Sl({code:415,desc:"Packet timeout due to instance disconnect",detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:c}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket();var l=!this.core.options.needReconnect||this.retryCount>=this.core.options.reconnectionAttempts;if(e===_u.ACTIVE||l)this.logger.log("doDisconnect: emit disconnect, type "+e,l),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(n=this.auth)||void 0===n||n.emit("disconnect"),this.destroyOnlineListener();else if(e===_u.KICKED){this.logger.log("doDisconnect: kicked"),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer);var d="string"==typeof t?{reason:"unknow",message:t}:t;this.core.eventBus.emit("kicked",d),this.core.emit("kicked",d),null===(a=this.auth)||void 0===a||a.emit("kicked",d),this.destroyOnlineListener()}else e===_u.OFFLINE&&this.core.V1NIMLoginService.isManualLoginAttempt?(this.logger.log("doDisconnect: offline in manual login phase. no reconnect"),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.destroyOnlineListener()):e===_u.OFFLINE&&(null===(o=null===(i=this.auth)||void 0===i?void 0:i.authenticator)||void 0===o?void 0:o.checkLoginTerminalCode(null==r?void 0:r.code))?(this.logger.log("doDisconnect: login terminal code "+(null==r?void 0:r.code)+", no reconnect"),this.core.status="unconnected",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.destroyOnlineListener(),this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(s=this.auth)||void 0===s||s.emit("disconnect")):e===_u.OFFLINE?(this.logger.log("doDisconnect: start to reconnect"),this.attempToReconnect()):this.logger.log("doDisconnect: nothing to do")}else this.logger.warn("doDisconnect: already unconnected")},e.attempToReconnect=function attempToReconnect(){var e,t,r=this;if("waitReconnect"!==this.core.status){0===this.retryCount&&(this.core.eventBus.emit("disconnect"),this.core.emit("disconnect"),null===(e=this.auth)||void 0===e||e.emit("disconnect"));var n=this.backoff.duration();this.retryCount++,this.logger.log("willReconnect "+this.retryCount+" "+n),this.core.eventBus.emit("willReconnect",{retryCount:this.retryCount,duration:n}),this.core.emit("willReconnect",{retryCount:this.retryCount,duration:n}),null===(t=this.auth)||void 0===t||t.emit("willReconnect",{retryCount:this.retryCount,duration:n}),this.core.status="waitReconnect",this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=eo((function(){return __awaiter(r,void 0,void 0,Dl.mark((function _callee3(){var e=this;return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:if("waitReconnect"===this.core.status){t.next=3;break}return this.logger.warn("doDisconnect: reconnectTimer status is "+this.core.status+", would not go on reconnecting"),t.abrupt("return");case 3:return t.next=5,ql.net.getNetworkStatus();case 5:!1===t.sent.net_connect?(this.logger.log("doDisconnect: skip this reconnection attempt because network is offline"),this.core.status="connecting",this.retryCount>=this.core.options.reconnectionAttempts?this.doDisconnect(_u.OFFLINE,"MaxReconnectionAttemptExceed"):this.attempToReconnect()):this.core.V1NIMLoginService.login({isAutoReconnect:!0}).catch((function(){e.logger.error("clientsocketV1::attempToReconnect failed "+e.retryCount)}));case 7:case"end":return t.stop()}}),_callee3,this)})))}),n)}else this.logger.warn("doDisconnect: already is waiting reconnect")},e.sendCmd=function sendCmd(e,t,r){var n=this;if("logined"!==this.core.status&&"login"!==e&&"chatroomLogin"!==e&&"qchatLogin"!==e)return this.logger.warn("instance status is "+this.core.status+", so can not sendCmd "+e),Pi.reject({cmd:e,error:{code:"No_connected",message:"Connection not established",timetag:(new Date).getTime()}});if(!this.socket||!this.socket.send)return Pi.reject("No_socket");var a="heartbeat"!==e,i=a?this.packetSer++:0,o=createCmd(e,i,this.logger,t);if(!o){var s="SendCmd "+i+" "+e+" error";return this.logger.error(s),Pi.reject(new Error(s))}var c=o.packet,l=o.hasPacketResponse,d=o.hasPacketTimer,u=bn(c);a&&(this.logger.getDebugMode()?this.logger.debug("clientsocketV1::sendCmd",e,"ser:"+i,u):this.logger.log("clientsocketV1::sendCmd",e,"ser:"+i));var p=(new Date).getTime();return new Pi((function(a,o){l&&n.sendingCmdMap.set(i,{cmd:e,params:t,callback:[a,o],timer:d?eo((function(){var t=new Sl({code:408,desc:"Packet Timeout",detail:{reason:"Packet Timeout",cmd:e,ser:i,timetag:Hi()}});n.markCmdInvalid(i,t,e)}),r&&r.timeout?r.timeout:n.core.config.timeout):null});try{n.socket.send(u),l||a(c)}catch(t){var s=new Sl({code:415,detail:{reason:t&&t.message||"Unable to send packet",cmd:e,ser:i,timetag:Hi(),rawError:t}});n.markCmdInvalid(i,s,e),o(t)}})).catch((function(e){var t,r=[408,415];if(!includes(r).call(r,e.code))return Pi.reject(e);n.reporter.reportTraceStart("exceptions",{user_id:n.core.options.account,trace_id:null===(t=n.socket)||void 0===t?void 0:t.sessionId,start_time:p,action:2,exception_service:6});var a=get(e,"data.disconnect_reason")||"",i=408===e.code?"Send failed due to timeout":"Send failed. Reason unknown";return i=415===e.code?bn({disconnect_reason:a}):i,n.reporter.reportTraceUpdateV2("exceptions",{code:e.code||415,description:i,operation_type:1,target:c.SID+"-"+c.CID,context:""+c.SER},{asyncParams:ql.net.getNetworkStatus()}),n.reporter.reportTraceEnd("exceptions",1),Pi.reject(e)}))},e.onMessage=function onMessage(e){var t=parseCmd(e,this.logger);if(t)for(var r,n=_createForOfIteratorHelperLoose$9(t);!(r=n()).done;){var a=r.value,i=a.raw.ser;if(a.error&&this.logger.error("core:onMessage packet error",a.raw.sid+"_"+a.raw.cid+", ser:"+i+",",a.error),a.notFound)return void this.logger.warn("clientsocketV1::onMessage packet not found",a.raw.sid+"_"+a.raw.cid+", ser:"+i);"heartbeat"!==a.cmd&&(this.logger.getDebugMode()?this.logger.debug("imsocket::recvCmd ser:"+i,a.cmd,a.content):this.logger.log("imsocket::recvCmd ser:"+i,a.cmd)),this.packetHandler(a)}},e.packetHandler=function packetHandler(e){var t,r,n=this;if(e){var a=e.raw.ser,i=this.sendingCmdMap.get(a);if(i&&i.cmd===e.cmd){var o=i.callback,s=i.timer,c=i.params;if(clearTimeout(s),e.params=c,this.sendingCmdMap.delete(a),"heartbeat"===e.cmd)return void o[0]();var l=null===(t=this.core[e.service])||void 0===t?void 0:t.process(e);l&&"function"==typeof l.then?l.then((function(e){o[0](e)})).catch((function(e){o[1](e)})):(this.logger.log("imsocket:: handlerFn without promise",e.service,e.cmd),o[0]())}else{var d=null===(r=this.core[e.service])||void 0===r?void 0:r.process(e);d&&"function"==typeof d.then&&d.catch((function(e){n.logger.error("imsocket::no obj cache, no process handler",e)}))}}},e.markCmdInvalid=function markCmdInvalid(e,t,r){var n=this.sendingCmdMap.get(e);if(n){var a=n.callback,i=n.timer;i&&clearTimeout(i),this.sendingCmdMap.delete(e),this.logger.warn("packet "+e+", "+r+" is invalid:",t),a[1](t)}},e.markAllCmdInvaild=function markAllCmdInvaild(e){var t,r=this;this.logger.log("markAllCmdInvaild",e),forEach$1(t=this.sendingCmdMap).call(t,(function(t){var n=t.callback,a=t.timer,i=t.cmd;r.logger.log('markAllCmdInvaild:: cmd "'+i+'"'),a&&clearTimeout(a),n[1](e)})),this.sendingCmdMap.clear()},e.ping=function ping(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t=this;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return clearTimeout(this.pingTimer),r.prev=1,r.next=4,this.sendCmd("heartbeat");case 4:r.next=18;break;case 6:return r.prev=6,r.t0=r.catch(1),r.next=10,this.testHeartBeat5Timeout();case 10:if(!r.sent){r.next=18;break}if(!this.core.reporterHookLinkKeep){r.next=16;break}return r.next=15,this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(e=this.socket)||void 0===e?void 0:e.url});case 15:this.core.reporterHookLinkKeep.end(!0);case 16:return this.doDisconnect(_u.OFFLINE,"PingError"),r.abrupt("return");case 18:this.pingTimer=eo((function(){t.ping()}),3e4);case 19:case"end":return r.stop()}}),_callee4,this,[[1,6]])})))},e.testHeartBeat5Timeout=function testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var e;return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:clearTimeout(this.pingTimer),e=0;case 2:if(!(e<5)){t.next=15;break}return t.prev=3,t.next=6,this.sendCmd("heartbeat",{},{timeout:3e3});case 6:return t.abrupt("return",!1);case 9:t.prev=9,t.t0=t.catch(3),this.logger.log("clientsocketV1:: test heartbeat "+e+" Timeout");case 12:e++,t.next=2;break;case 15:return t.abrupt("return",!0);case 16:case"end":return t.stop()}}),_callee5,this,[[3,9]])})))},e.initOnlineListener=function initOnlineListener(){var e=this;this.hasNetworkListener||(this.logger.log("clientsocketV1::onlineListener:init"),this.hasNetworkListener=!0,ql.net.onNetworkStatusChange((function(t){e.logger.log("clientsocketV1::onlineListener:network change",t),t.isConnected&&"logined"===e.core.status?e.ping():t.isConnected&&"waitReconnect"===e.core.status?(e.reconnectTimer&&clearTimeout(e.reconnectTimer),e.core.V1NIMLoginService.login({isAutoReconnect:!0}).catch((function(){e.logger.error("clientsocketV1::attempToReconnect failed "+e.retryCount)}))):t.isConnected||e.doDisconnect(_u.OFFLINE,"OfflineListener")})))},e.destroyOnlineListener=function destroyOnlineListener(){this.logger.log("clientsocketV1::onlineListener:destroy"),ql.net.offNetworkStatusChange(),this.hasNetworkListener=!1},e.disconnect=function disconnect(){switch(this.core.status){case"connected":case"logined":case"connecting":case"waitReconnect":return this.doDisconnect(_u.ACTIVE,"UserActiveDisconnect"),Pi.resolve();default:return Pi.resolve()}},V1ClientSocket}(),bu=function(){function V1NIMLoginLbs(e){this.socketLinkUrls=[],this.timer=0,this.failedCount=0,this.core=e,this.auth=e.V1NIMLoginService,this.logger=this.core.logger}var e=V1NIMLoginLbs.prototype;return e.getLbsInfos=function getLbsInfos(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e,t,r,n;return Dl.wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.socketLinkUrls.length>0)){a.next=5;break}return e=this.socketLinkUrls,this.socketLinkUrls=[],this.core.logger.log("V1NIMLoginService::getLbsInfos:use cache link",e),a.abrupt("return",Pi.resolve(e));case 5:return this.core.reporterHookLBS.start(this.core.account),t=uniq(this.auth.config.lbsUrls),a.prev=7,a.next=10,this.ladderLoad(t);case 10:if(200===(r=a.sent).status&&r.data){a.next=14;break}throw this.core.logger.error("V1NIMLoginService::getLbsInfos:error status",r.status,r),new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"V1NIMLoginService::getLbsInfos failed, status "+r.status}});case 14:this.success(r),a.next=25;break;case 17:if(a.prev=17,a.t0=a.catch(7),n=a.t0,this.core.logger.error("V1NIMLoginService::lbs getLbsInfos error, use default link: "+this.auth.config.linkUrl+". error:",a.t0),this.reportForFail(t[0],n.code,n.message),!this.checkTerminator(n.code)){a.next=24;break}throw a.t0;case 24:this.socketLinkUrls=[this.auth.config.linkUrl];case 25:return a.abrupt("return",this.socketLinkUrls);case 26:case"end":return a.stop()}}),_callee,this,[[7,17]])})))},e.checkTerminator=function checkTerminator(e){return e===_l.V2NIM_ERROR_CODE_CANCELLED||e===_l.V2NIM_ERROR_CODE_TIMEOUT},e.generateUrl=function generateUrl(e){return e+(indexOf(e).call(e,"?")>-1?"&":"?")+"k="+this.core.options.appkey+"&id="+this.core.auth.getLoginUser()+"&sv=180&pv=1&networkType=0&lv=1"},e.requstLbs=function requstLbs(e){return this.auth.doLoginStepsManager.add(this.core.adapters.request(this.generateUrl(e),{method:"GET",dataType:"json",timeout:8e3}))},e.setLadderTimer=function setLadderTimer(e,t,r,n){var a=this;this.timer&&clearTimeout(this.timer);var i=e[t];this.timer=eo((function(){i&&(a.setLadderTimer(e,t+1,r,n),a.core.logger.log("V1NIMLoginService::getLbsInfos "+t+":",i),a.reportForLbsStart(i,t),a.requstLbs(i).then((function(e){a.reset(),r(Et(Et({},e),{url:i}))})).catch((function(r){var o;if(a.core.logger.warn("V1NIMLoginService::getLbsInfos "+t+" failed:",r),a.failedCount+=1,a.reportForFailOnce(i,r.code,(null===(o=r.detail)||void 0===o?void 0:o.reason)||r.message),a.failedCount>=e.length||a.checkTerminator(r.code))return a.reset(),void n(r)})))}),2e3)},e.ladderLoad=function ladderLoad(e){var t=this;return new Pi((function(r,n){e.length>1&&t.setLadderTimer(e,1,r,n);var a=e[0];t.core.logger.log("V1NIMLoginService::getLbsInfos 0:",a),t.reportForLbsStart(a,0),t.requstLbs(a).then((function(e){t.reset(),r(Et(Et({},e),{url:a}))})).catch((function(r){var i;t.failedCount+=1,t.core.logger.warn("V1NIMLoginService::getLbsInfos 0 failed:",r),t.reportForFailOnce(a,r.code,(null===(i=r.detail)||void 0===i?void 0:i.reason)||r.message),(t.failedCount>=e.length||t.checkTerminator(r.code))&&(t.reset(),n(r))}))}))},e.success=function success(e){var t,r,n,a,i=e.data,o=[this.auth.config.linkUrl];get(i,"common.link")&&(o=concat(a=get(i,"common.link")).call(a,o));get(i,'common["link.default"]')&&(o=concat(o).call(o,get(i,'common["link.default"]'))),this.socketLinkUrls=o,i["nos-chunk"]&&(this.logger.log("getLbsInfos success. lbs.nos-chunk",i["nos-chunk"]),null===(r=this.core.cloudStorage)||void 0===r||r.setOptions({chunkUploadHost:i["nos-chunk"]})),En(i.nosup)&&i.nosup.length>0&&(this.logger.log("getLbsInfos success. lbs.nosup",i.nosup),null===(n=this.core.cloudStorage)||void 0===n||n.setOptions({commonUploadHostBackupList:i.nosup,commonUploadHost:i.nosup[0]})),this.core.logger.log("V1NIMLoginService::getLbsInfos success, socket link:",slice(t=this.socketLinkUrls).call(t,0),"chunkUploadHost: ",e.data["nos-chunk"]),this.reportForLbsSuccess(e.url,e.data)},e.reportForLbsStart=function reportForLbsStart(e,t){this.core.reporterHookLBS.updateBegin({target:e,index:t})},e.reportForLbsSuccess=function reportForLbsSuccess(e,t){this.core.reporterHookLBS.updateComplete({target:e,code:200,body:bn(t)}),this.core.reporterHookLBS.end(!0),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,code:200,succeed:!0},{asyncParams:ql.net.getNetworkStatus()})},e.reportForFailOnce=function reportForFailOnce(e,t,r){this.core.reporterHookLBS.updateComplete({target:e,code:t,body:r})},e.reportForFail=function reportForFail(e,t,r){this.core.reporterHookLBS.end(!1),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,description:r,code:t,succeed:!1},{asyncParams:ql.net.getNetworkStatus()})},e.reset=function reset(){this.socketLinkUrls=[],this.failedCount=0,clearTimeout(this.timer)},V1NIMLoginLbs}(),Eu=function(){function V1NIMLoginAuthenticator(e){this.core=e}var e=V1NIMLoginAuthenticator.prototype;return e.verifyAuthentication=function verifyAuthentication(e){var t,r,n;return void 0===e&&(e=!1),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){var a,i,o,s,c,l,d,u,p,m,h,g;return Dl.wrap((function _callee$(v){for(;;)switch(v.prev=v.next){case 0:return i=this.core.options,o=ql.getSystemInfo(),s=Et(Et({},i),{appLogin:e?0:1,appkey:i.appkey,account:i.account,token:i.token,deviceId:this.core.auth.deviceId,clientSession:this.core.auth.clientSession,clientType:16,protocolVersion:1,sdkVersion:100700,sdkHumanVersion:"10.7.0",os:o.os,browser:o.browser,userAgent:this.core.options.loginSDKTypeParamCompat?"Native/10.7.0":slice(a=o.userAgent.replace("{{appkey}}",i.appkey)).call(a,0,299),libEnv:this.core.options.loginSDKTypeParamCompat?void 0:o.libEnv,hostEnv:this.core.options.loginSDKTypeParamCompat?0:o.hostEnvEnum}),c=o.os.toLowerCase(),"UNIAPP"!==ql.platform||"ios"!==c&&"android"!==c||(s.isReactNative=1,s.clientType="ios"===c?2:1,l=!!(null===(t=this.core.offlinePush.authConfig)||void 0===t?void 0:t.honorCertificateName),o.pushDeviceInfo&&o.pushDeviceInfo.MANUFACTURER&&(s.deviceInfo=bn(Et({IS_SUPPORT_HONOR:l},o.pushDeviceInfo)))),this.core.logger.log("clientSocketV1::do login ",i.account,null===(n=null===(r=this.core.clientSocket)||void 0===r?void 0:r.socket)||void 0===n?void 0:n.sessionId),v.next=8,this.core.clientSocket.sendCmd("login",{login:s});case 8:if(!(d=v.sent).error){v.next=11;break}throw d.error;case 11:return u=d.content,p=u.loginRes,m=u.loginPorts,h=u.aosPushInfo,g=formatMultiPortLoginInfo(m,2),(g=filter(g).call(g,(function(e){return e.connectionId!==p.connectionId}))).length>0&&this.core.emit("multiPortLogin",g),v.abrupt("return",Et(Et({},p),{aosPushInfo:h}));case 16:case"end":return v.stop()}}),_callee,this)})))},e.checkLoginTerminalCode=function checkLoginTerminalCode(e){if(void 0===e)return!1;var t=[201,302,317,403,404,417,422];return includes(t).call(t,e)},V1NIMLoginAuthenticator}(),Ru=function(e){function V2Service(t,r){var n;return(n=e.call(this)||this).name=t,n.logger=r.logger,n.core=r,n}_t(V2Service,e);var t=V2Service.prototype;return t.checkV2=function checkV2(){var e=this.core.options.apiVersion;if("v2"===e)return!0;throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:'The version "'+e+'" of client is not supported.'}})},t.checkLogin=function checkLogin(){if(1!==this.core.V2NIMLoginService.getLoginStatus())throw new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:"The client is not logged in."}})},t.emit=function emit(t){for(var r=this,n=arguments.length,a=new Array(n>1?n-1:0),i=1;i<n;i++)a[i-1]=arguments[i];this.logger.debug(this.name+"::emit event: '"+t.toString()+"',",void 0!==a[0]?a[0]:"",void 0!==a[1]?a[1]:"",void 0!==a[2]?a[2]:"");try{var o,s,c=(o=e.prototype.emit).call.apply(o,concat(s=[this,t]).call(s,a));return c}catch(e){return eo((function(){throw r.logger.error(r.name+"::emit throw error in setTimeout. event: "+t.toString()+". Error",e),e}),0),!1}},t.process=function process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t){if(e.error)return this.logger.error(e.cmd+"::recvError",e.error),Pi.reject(e.error);try{var r=t.call(this,e);return Pi.resolve(r)}catch(e){return Pi.reject(e)}}var n=get(e,"error.detail.ignore");return e.error&&!n?Pi.reject(e.error):Pi.resolve(e)},V2Service}(to),ku=function(){function Service(e,t){this.name=e,this.core=t,this.name=e,this.logger=t.logger,this.core=t}return Service.prototype.process=function process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t)return t.call(this,e);var r=get(e,"error.detail.ignore");return e.error&&!r?Pi.reject(e.error):Pi.resolve(e)},Service}(),wu={"6_3":"notifylog","6_4":"uploadLog","6_23":"getServerTime","6_31":"notifyDetect","6_32":"uploadDetect"},Au={type:1,params:2,result:3,t1:100,t2:101,t3:102,t4:103,t5:104,t6:105},Nu={notifylog:{sid:6,cid:3,service:"misc"},uploadLog:{sid:6,cid:4,service:"misc",hasPacketResponse:!1,params:[{type:"String",name:"url"},{type:"Property",name:"data",reflectMapper:{type:1,content:2}}]},getServerTime:{sid:6,cid:23,service:"misc",response:[{type:"Long",name:"time"}]},notifyDetect:{sid:6,cid:31,service:"misc",response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Au)}]},uploadDetect:{sid:6,cid:32,service:"misc",hasPacketResponse:!1,params:[{type:"Property",name:"data",reflectMapper:Au}]}},xu={type:{type:"number"},t1:{type:"number"},t2:{type:"number"},t3:{type:"number"},t4:{type:"number"},t5:{type:"number"},t6:{type:"number"}};var Ou=function(e){function MiscService(t){var r;return(r=e.call(this,"misc",t)||this).core=t,registerParser({cmdMap:wu,cmdConfig:Nu}),r.setListener(),r}_t(MiscService,e);var t=MiscService.prototype;return t.setListener=function setListener(){var e=this;this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(function(){e.core.timeOrigin.setOriginTimetick()})),this.core.eventBus.on("logined",(function(){e.core.timeOrigin.setOriginTimetick()}))},t.getServerTime=function getServerTime(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e;return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.core.clientSocket.sendCmd("getServerTime");case 2:return e=t.sent,t.abrupt("return",bd(e.content.time));case 4:case"end":return t.stop()}}),_callee,this)})))},t.notifyDetectHandler=function notifyDetectHandler(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t;return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return n=e.content.data,(t=format(xu,n)).t3=e.__receiveTimeNode.time,t.t4=Hi(),r.prev=3,r.next=6,this.core.clientSocket.sendCmd("uploadDetect",{data:t});case 6:r.next=11;break;case 8:r.prev=8,r.t0=r.catch(3),this.core.logger.warn("misc::notifyDetectHandler:upload failed",r.t0);case 11:case"end":return r.stop()}var n}),_callee2,this,[[3,8]])})))},t.notifylogHandler=function notifylogHandler(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var e,t,r;return Dl.wrap((function _callee3$(n){for(;;)switch(n.prev=n.next){case 0:return e=void 0,n.prev=1,n.next=4,this.core.logger.extractLogs();case 4:e=n.sent,n.next=10;break;case 7:return n.prev=7,n.t0=n.catch(1),n.abrupt("return");case 10:if(e){n.next=12;break}return n.abrupt("return");case 12:if("string"!=typeof e){n.next=14;break}return n.abrupt("return");case 14:return t="",n.prev=15,n.next=18,this.core.cloudStorage.uploadFile({type:"file",file:e});case 18:r=n.sent,t=r.url,n.next=25;break;case 22:return n.prev=22,n.t1=n.catch(15),n.abrupt("return");case 25:if(t){n.next=27;break}return n.abrupt("return");case 27:return t+=(indexOf(t).call(t,"?")>0?"&":"?")+"download="+(new Date).getTime()+"_web.log",n.prev=28,n.next=31,this.core.clientSocket.sendCmd("uploadLog",{url:t});case 31:n.next=36;break;case 33:return n.prev=33,n.t2=n.catch(28),n.abrupt("return");case 36:case"end":return n.stop()}}),_callee3,this,[[1,7],[15,22],[28,33]])})))},MiscService}(ku),Pu={needReconnect:!0,reconnectionAttempts:Mt,lbsUrls:pd,linkUrl:ud,xhrConnectTimeout:8e3,socketConnectTimeout:8e3},Lu=function(e){function V1NIMLoginServiceImpl(t,r){var n;(n=e.call(this,"V1NIMLoginService",t)||this).account="",n.token="",n.deviceId="",n.processId="",n.clientSession="",n.status="unconnected",n.config=Pu,n.isManualLoginAttempt=!1,n.core._registerDep(Ou,"misc"),registerParser({cmdMap:du,cmdConfig:mu}),t.V1NIMLoginService=De(n),r&&n.setOptions(r);var a=new Cu(n.core,De(n));return n.clientSocket=a,"v1"===n.core.options.apiVersion&&(n.core.clientSocket=a,n.core.auth=De(n)),n.lbs=new bu(t),n.authenticator=new Eu(t),n.doLoginStepsManager=new fd,n}_t(V1NIMLoginServiceImpl,e);var t=V1NIMLoginServiceImpl.prototype;return t.reset=function reset(){this.lbs.reset()},t.setOptions=function setOptions(e){e&&Nt(e).length>0?(this.config=assignOptions(this.config,e),this.account=e.account||this.core.options.account,this.token=e.token||this.core.options.token,this.core.options=Et(Et({},this.core.options),this.config)):(this.config=assignOptions(this.core.options,this.config),this.account=this.core.options.account,this.token=this.core.options.token);var t="",r="";this.config.isFixedDeviceId?(t=ql.localStorage.getItem("__NIM_DEVC_ID__")||ld(),r=ql.localStorage.getItem("__NIM_CLIENT_SESSION_ID__")||ld(),ql.localStorage.setItem("__NIM_DEVC_ID__",t),ql.localStorage.setItem("__NIM_CLIENT_SESSION_ID__",r)):(t=ld(),r=ld()),this.deviceId=t,this.clientSession=r,this.core.reporter.setConfig({common:{dev_id:t}})},t.connect=function connect(e){return void 0===e&&(e={}),this.login(e)},t.login=function login(e){return void 0===e&&(e={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return this._checkApiVersion(),e.isAutoReconnect||(this.isManualLoginAttempt=!0,this.processId=ld()),t.next=4,this._connect(e);case 4:return this.core.abtest.abtRequest(),t.prev=5,t.next=8,this.doLogin(e.isAutoReconnect);case 8:this.processId=ld(),this.isManualLoginAttempt=!1,t.next=16;break;case 12:throw t.prev=12,t.t0=t.catch(5),this.isManualLoginAttempt=!1,t.t0;case 16:case"end":return t.stop()}}),_callee,this,[[5,12]])})))},t._connect=function _connect(e){return void 0===e&&(e={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a=this;return Dl.wrap((function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:if(/^(unconnected|waitReconnect)$/.test(this.core.status)){i.next=4;break}return t="NIM status is "+this.core.status+", and would not connect",this.logger.warn(t),i.abrupt("return",Pi.reject(t));case 4:return this.clientSocket.beforeConnect(),this.core.reporter.reportTraceCancel("login"),this.core.reporter.reportTraceStart("login",{user_id:this.core.options.account,action:e.isAutoReconnect?"auto_login":"manual_login",binary_websocket:!1,process_id:this.processId}),this.core.reporter.reportTraceUpdateV2("login",{code:0,description:bn(Et(Et({},this.core.options),{account:"***",token:"***"})),operation_type:"conf_init",succeed:!0,duration:0,target:""},{asyncParams:ql.net.getNetworkStatus()}),i.next=10,this.lbs.getLbsInfos();case 10:return r=i.sent,i.prev=11,i.next=14,this.clientSocket.connect({linkUrls:r,isAutoReconnect:e.isAutoReconnect},(function(e,t){a.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:t,code:e.code||408,description:"ws_handshake_failed:"+e.message,succeed:!1},{asyncParams:ql.net.getNetworkStatus()})}));case 14:(n=i.sent)&&this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:n,code:200,succeed:!0},{asyncParams:ql.net.getNetworkStatus()}),i.next=22;break;case 18:throw i.prev=18,i.t0=i.catch(11),this.core.reporter.reportTraceEnd("login",!1),i.t0;case 22:case"end":return i.stop()}}),_callee2,this,[[11,18]])})))},t.doLogin=function doLogin(e){return void 0===e&&(e=!1),__awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n,a;return Dl.wrap((function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,this.authenticator.verifyAuthentication(e);case 3:t=i.sent,this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:200,succeed:!0},{asyncParams:ql.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("login",!0),this.core.status="logined",i.next=21;break;case 9:if(i.prev=9,i.t0=i.catch(0),r=i.t0,n=get(r,"data.disconnect_reason")||"",a=415===r.code?bn({disconnect_reason:n}):r.message,this.core.logger.warn("nim login:: login failed",i.t0),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"2-3",code:r.code||0,succeed:!1,description:a},{asyncParams:ql.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("login",!1),this.clientSocket.doDisconnect(_u.OFFLINE,this.isManualLoginAttempt?"FailedToInitializeLogin":"ReconnectLoginFailed",i.t0),!this.isManualLoginAttempt){i.next=20;break}throw i.t0;case 20:return i.abrupt("return");case 21:return i.prev=21,i.next=24,this.core.cloudStorage.init();case 24:i.next=29;break;case 26:i.prev=26,i.t1=i.catch(21),this.core.logger.error("NIM:login cloudStorage init failed ",i.t1);case 29:this.core.eventBus.emit("logined",t),this.core.emit("logined",t),this.emit("logined",t),this.core.logger.log("login done"),this.clientSocket.resetConnectStatus(),this.clientSocket.ping();case 35:case"end":return i.stop()}}),_callee3,this,[[0,9],[21,26]])})))},t.disconnect=function disconnect(){return this.logout()},t.logout=function logout(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(e){for(;;)switch(e.prev=e.next){case 0:this._checkApiVersion(),this.doLoginStepsManager.clear(),e.t0=this.status,e.next="logined"===e.t0?5:"connected"===e.t0||"connecting"===e.t0||"waitReconnect"===e.t0?18:"unconnected"===e.t0||"destroyed"===e.t0?21:22;break;case 5:return e.prev=5,e.next=8,this.clientSocket.sendCmd("logout",void 0,{timeout:1e3});case 8:this.clientSocket.doDisconnect(_u.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),e.next=17;break;case 12:e.prev=12,e.t1=e.catch(5),this.logger.error("Instance::disconnect sendCmd:logout error",e.t1),this.clientSocket.doDisconnect(_u.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData();case 17:return e.abrupt("break",22);case 18:return this.clientSocket.doDisconnect(_u.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),e.abrupt("return",Pi.resolve());case 21:return e.abrupt("return",Pi.resolve());case 22:case"end":return e.stop()}}),_callee4,this,[[5,12]])})))},t.kick=function kick(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var r;return Dl.wrap((function _callee5$(n){for(;;)switch(n.prev=n.next){case 0:return this._checkApiVersion(),n.next=3,this.clientSocket.sendCmd("kick",e);case 3:return r=n.sent,n.abrupt("return",null===(t=r.content)||void 0===t?void 0:t.deviceIds);case 5:case"end":return n.stop()}}),_callee5,this)})))},t._checkApiVersion=function _checkApiVersion(){if("v1"!==this.core.options.apiVersion)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:'apiVersion is not "v1"'}})},t.nimLoginClientChangeHandler=function nimLoginClientChangeHandler(e){if(e.error)this.logger.error("nimLoginClientChangeHandler:: error, ",e.error);else{var t=e.content,r=formatMultiPortLoginInfo(t.datas,t.state);r.length>0&&(this.core.emit("multiPortLogin",r),this.emit("multiPortLogin",r))}},t.kickedHandler=function kickedHandler(e){if(e.error)this.logger.error("kickedHandler:: error, ",e.error);else{var t=function formatBeKickedTag$1(e){var t=format({clientType:{type:"enum",values:su},customClientType:{type:"number"}},e),r=fu[t.reason];return Et(t,r=r||{reason:"unknow",message:"Unknown reason"})}(e.content);this.logger.warn("kicked::",t),this.clientSocket.doDisconnect(_u.KICKED,t),this.core._clearModuleData()}},t.getConnectStatus=function getConnectStatus(){switch(this.core.status){case"unconnected":case"destroyed":default:return 0;case"connecting":return 2;case"connected":case"logined":return 1;case"waitReconnect":return 3}},t.getLoginStatus=function getLoginStatus(){switch(this.core.status){case"unconnected":case"destroyed":case"waitReconnect":default:return 0;case"connecting":case"connected":return 2;case"logined":return 1}},t.getLoginUser=function getLoginUser(){return this.core.options.account},t.emit=function emit(t){for(var r,n,a,i,o=this.name+"::emit "+t.toString(),s=arguments.length,c=new Array(s>1?s-1:0),l=1;l<s;l++)c[l-1]=arguments[l];return(r=this.logger).log.apply(r,concat(n=[""+o]).call(n,c)),(a=e.prototype.emit).call.apply(a,concat(i=[this,t]).call(i,c))},V1NIMLoginServiceImpl}(Ru);function formatLoginInfo(e){return format({type:{type:"number"},port:{type:"number"},customClientType:{type:"number"},timestamp:{type:"number"},loginType:{type:"number"}},e)}function invert(e){e=e||{};var t={};for(var r in e)t[e[r]]=r;return t}var Vu={"26_3":"v2Login","26_5":"v2Logout","26_8":"v2KickOffline","26_9":"v2BeKicked","26_10":"v2LoginClientChange","36_1":"v2GetChatroomLinkAddress"},Uu={"1_2":"heartbeat","2_7":"nimLoginClientChange","24_8":"qchatLoginClientChange"},Du={webLoginReqTag:{clientType:3,os:4,sdkVersion:6,appLogin:8,protocolVersion:9,pushTokenName:10,pushToken:11,clientId:13,appkey:18,account:19,browser:24,clientSession:26,deviceInfo:32,isReactNative:112,customTag:38,customClientType:39,sdkHumanVersion:40,hostEnv:41,userAgent:42,libEnv:44,authType:115,thirdPartyExtension:116,token:1e3},mixAuthRepTag:{clientId:1,consid:2,clientIP:3,port:4,type:5,customClientType:6,timestamp:7,customTag:8,os:9,pushType:10,hasTokenPreviously:11,loginType:12},nimAuthRepTag:{type:3,os:4,mac:5,clientId:13,account:19,deviceInfo:32,customTag:38,customClientType:39,consid:102,clientIP:103,port:104,timestamp:109,pushType:110,hasTokenPreviously:111},qchatAuthRepTag:{clientId:8,consid:102,clientIP:103,port:104,type:6,customClientType:13,timestamp:105,os:30,pushType:100,hasTokenPreviously:101}},qu={v2Login:{sid:26,cid:3,service:"auth",params:[{type:"Property",name:"tag",reflectMapper:Du.webLoginReqTag}],response:[{type:"Property",name:"data",reflectMapper:invert(Du.mixAuthRepTag)},{type:"PropertyArray",name:"loginClients",reflectMapper:invert(Du.mixAuthRepTag)}]},v2Logout:{sid:26,cid:5,service:"auth"},v2KickOffline:{sid:26,cid:8,service:"auth",params:[{type:"StrArray",name:"clientIds"}],response:[{type:"StrArray",name:"clientIds"}]},v2BeKicked:{sid:26,cid:9,service:"auth",response:[{type:"Int",name:"clientType"},{type:"Int",name:"reason"},{type:"String",name:"reasonDesc"},{type:"Int",name:"customClientType"}]},v2LoginClientChange:{sid:26,cid:10,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:invert(Du.mixAuthRepTag)}]},v2GetChatroomLinkAddress:{sid:36,cid:1,service:"auth",params:[{type:"Long",name:"roomId"},{type:"Bool",name:"miniProgram"}],response:[{type:"StrArray",name:"linkAddress"}]}},Bu={heartbeat:{sid:1,cid:2,service:"auth"},nimLoginClientChange:{sid:2,cid:7,service:"auth",response:[{type:"Byte",name:"state"},{type:"PropertyArray",name:"datas",reflectMapper:invert(Du.nimAuthRepTag)}]},qchatLoginClientChange:{sid:24,cid:8,service:"auth",response:[{type:"Byte",name:"state"},{type:"Property",name:"data",reflectMapper:invert(Du.qchatAuthRepTag)}]}},Fu=ki.codeAt;_export({target:"String",proto:!0},{codePointAt:function codePointAt(e){return Fu(this,e)}});var Gu=entryVirtual("String").codePointAt,Hu=String.prototype,codePointAt=function(e){var t=e.codePointAt;return"string"==typeof e||e===Hu||x(Hu,e)&&t===Hu.codePointAt?Gu:t},ju=RangeError,$u=String.fromCharCode,zu=String.fromCodePoint,Wu=g([].join),Ku=!!zu&&1!=zu.length;_export({target:"String",stat:!0,arity:1,forced:Ku},{fromCodePoint:function fromCodePoint(e){for(var t,r=[],n=arguments.length,a=0;n>a;){if(t=+arguments[a++],toAbsoluteIndex(t,1114111)!==t)throw ju(t+" is not a valid code point");r[a]=t<65536?$u(t):$u(55296+((t-=65536)>>10),t%1024+56320)}return Wu(r,"")}});var Yu=N.String.fromCodePoint,Qu=function abs(e){var t;if(void 0!==e)return(t=BigNumber(e)).sign=1,t},Ju=function isArray(e){return"[object Array]"===Object.prototype.toString.call(e)},Xu=function isValidType(e){var t;return some(t=["number"==typeof e,"string"==typeof e&&e.length>0,Ju(e)&&e.length>0,e instanceof BigNumber]).call(t,(function(e){return!0===e}))},Zu="Invalid Number",ep="Invalid Number - Division By Zero";function BigNumber(e){var t;if(!(this instanceof BigNumber))return new BigNumber(e);if(this.number=[],this.sign=1,this.rest=0,Xu(e)){if(Ju(e)){for((e.length&&"-"===e[0]||"+"===e[0])&&(this.sign="+"===e[0]?1:-1,e.shift(0)),t=e.length-1;t>=0;t--)if(!this.addDigit(e[t]))return}else for("-"!==(e=e.toString()).charAt(0)&&"+"!==e.charAt(0)||(this.sign="+"===e.charAt(0)?1:-1,e=e.substring(1)),t=e.length-1;t>=0;t--)if(!this.addDigit(bd(e.charAt(t),10)))return}else this.number=Zu}BigNumber.prototype.addDigit=function(e){return function testDigit(e){return/^\d$/.test(e)}(e)?(this.number.push(e),this):(this.number=Zu,!1)},BigNumber.prototype._compare=function(e){var t,r;if(!Xu(e))return null;if(t=BigNumber(e),this.sign!==t.sign)return this.sign;if(this.number.length>t.number.length)return this.sign;if(this.number.length<t.number.length)return-1*this.sign;for(r=this.number.length-1;r>=0;r--){if(this.number[r]>t.number[r])return this.sign;if(this.number[r]<t.number[r])return-1*this.sign}return 0},BigNumber.prototype.gt=function(e){return this._compare(e)>0},BigNumber.prototype.gte=function(e){return this._compare(e)>=0},BigNumber.prototype.equals=function(e){return 0===this._compare(e)},BigNumber.prototype.lte=function(e){return this._compare(e)<=0},BigNumber.prototype.lt=function(e){return this._compare(e)<0},BigNumber.prototype.subtract=function(e){var t;return void 0===e?this:(t=BigNumber(e),this.sign!==t.sign?(this.number=BigNumber._add(this,t),this):(this.sign=this.lt(t)?-1:1,this.number=Qu(this).lt(Qu(t))?BigNumber._subtract(t,this):BigNumber._subtract(this,t),this))},BigNumber._add=function(e,t){var r,n=0,a=Math.max(e.number.length,t.number.length);for(r=0;r<a||n>0;r++)e.number[r]=(n+=(e.number[r]||0)+(t.number[r]||0))%10,n=Math.floor(n/10);return e.number},BigNumber._subtract=function(e,t){var r,n,a=0,i=e.number.length;for(r=0;r<i;r++)e.number[r]-=(t.number[r]||0)+a,e.number[r]+=10*(a=e.number[r]<0?1:0);for(r=0,i=e.number.length-1;0===e.number[i-r]&&i-r>0;)r++;r>0&&splice(n=e.number).call(n,-r);return e.number},BigNumber.prototype.multiply=function(e){if(void 0===e)return this;var t,r,n=BigNumber(e),a=0,i=[];if(this.isZero()||n.isZero())return BigNumber(0);for(this.sign*=n.sign,t=0;t<this.number.length;t++)for(a=0,r=0;r<n.number.length||a>0;r++)i[t+r]=(a+=(i[t+r]||0)+this.number[t]*(n.number[r]||0))%10,a=Math.floor(a/10);return this.number=i,this},BigNumber.prototype.divide=function(e){if(void 0===e)return this;var t,r,n=BigNumber(e),a=[],i=BigNumber(0);if(n.isZero())return this.number=ep,this;if(this.isZero())return this.rest=BigNumber(0),this;if(this.sign*=n.sign,n.sign=1,1===n.number.length&&1===n.number[0])return this.rest=BigNumber(0),this;for(t=this.number.length-1;t>=0;t--)for(i.multiply(10),i.number[0]=this.number[t],a[t]=0;n.lte(i);)a[t]++,i.subtract(n);for(t=0,r=a.length-1;0===a[r-t]&&r-t>0;)t++;return t>0&&splice(a).call(a,-t),this.rest=i,this.number=a,this},BigNumber.prototype.mod=function(e){return this.divide(e).rest},BigNumber.prototype.isZero=function(){var e;for(e=0;e<this.number.length;e++)if(0!==this.number[e])return!1;return!0},BigNumber.prototype.toString=function(){var e,t="";if("string"==typeof this.number)return this.number;for(e=this.number.length-1;e>=0;e--)t+=this.number[e];return this.sign>0?t:"-"+t};var tp=Math.pow(2,32);function varintToBytes(e){for(var t=new Uint8Array(5),r=new DataView(t.buffer),n=0;0!=(4294967168&e);)r.setUint8(n++,127&e|128),e>>>=7;return r.setUint8(n++,127&e),slice(t).call(t,0,n)}function encodeText(e){if("function"==typeof TextEncoder)return(new TextEncoder).encode(e);var t=function textEncoder(e){for(var t=[],r=e.length,n=0;n<r;){var a=codePointAt(e).call(e,n),i=0,o=0;for(a<=127?(i=0,o=0):a<=2047?(i=6,o=192):a<=65535?(i=12,o=224):a<=2097151&&(i=18,o=240),t.push(o|a>>i),i-=6;i>=0;)t.push(128|a>>i&63),i-=6;n+=a>=65536?2:1}return t}(e);return new Uint8Array(t)}function decodeText(e){return"function"==typeof TextDecoder?new TextDecoder("utf-8").decode(e):function textDecoder(e){for(var t="",r=0;r<e.length;){var n=e[r],a=0,i=0;if(n<=127?(a=0,i=255&n):n<=223?(a=1,i=31&n):n<=239?(a=2,i=15&n):n<=244&&(a=3,i=7&n),e.length-r-a>0)for(var o=0;o<a;)i=i<<6|63&(n=e[r+o+1]),o+=1;else i=65533,a=e.length-r;t+=Yu(i),r+=a+1}return t}(e)}var rp=function(){function Unpack(e){this.offset=0,this.buffer=new Uint8Array(e),this.view=new DataView(e)}var e=Unpack.prototype;return e.checkBufferBoundaryAccess=function checkBufferBoundaryAccess(){return this.offset>=this.buffer.byteLength},e.length=function length(){var e;return(null===(e=this.view)||void 0===e?void 0:e.byteLength)||0},e.getBuffer=function getBuffer(){return this.view.buffer},e.getOffset=function getOffset(){return this.offset},e.popRaw=function popRaw(e){try{var t,r=slice(t=this.buffer).call(t,this.offset,this.offset+e);return this.offset+=e,r}catch(e){throw new Error("UnpackException raw "+(e&&e.message))}},e.popByte=function popByte(){try{var e=this.view.getUint8(this.offset);return this.offset+=1,e}catch(e){throw new Error("UnpackException byte "+(e&&e.message))}},e.popVarbin=function popVarbin(){return this.popRaw(this.popVarInt())},e.popString=function popString(){try{return decodeText(this.popVarbin())}catch(e){throw new Error("UnpackException string "+(e&&e.message))}},e.popInt=function popInt(){try{var e=this.view.getUint32(this.offset,!0);return this.offset+=4,e}catch(e){throw new Error("UnpackException int "+(e&&e.message))}},e.popVarInt=function popVarInt(){var e=1,t=0,r=0,n=0;do{if(t+=(127&(r=this.popByte()))*e,e*=128,(n+=1)>5)throw new Error("Variable length quantity is too long")}while(0!=(128&r));return t},e.popLong=function popLong(){try{var e,t=function getBigUint64(e,t){void 0===t&&(t=!1);var r=new DataView(e.buffer),n=t?[4,0]:[0,4],a=n[0],i=n[1],o=r.getUint32(a,t),s=r.getUint32(i,t);return o>0?o*tp+s:s}(slice(e=this.buffer).call(e,this.offset,this.offset+8),!0);return this.offset+=8,Number(t)}catch(e){throw new Error("UnpackException long "+(e&&e.message))}},e.popShort=function popShort(){try{var e=this.view.getUint16(this.offset,!0);return this.offset+=2,e}catch(e){throw new Error("UnpackException short "+(e&&e.message))}},e.popBoolean=function popBoolean(){return this.popByte()>0},e.toString=function toString(){return xl(new Uint8Array(this.buffer)).toString()},e.reset=function reset(){this.offset=0,this.buffer=null,this.view=null},Unpack}(),np=function(){function PacketDecoder(e){this.packetLength=0,this.serviceId=0,this.commandId=0,this.serialId=0,this.tag=0,this.resCode=200,this.innerHeader=null,this.msgId=0,this.bodyArr=[],this.unpack=new rp(e)}var e=PacketDecoder.prototype;return e.reset=function reset(){this.innerHeader=null,this.bodyArr=[],this.unpack.reset()},e.getBodyDetail=function getBodyDetail(){return this.bodyArr.join("")},e.unmarshalHeader=function unmarshalHeader(){var e,t=this._unmarshalHeader();this.packetLength=t.packetLength,this.serviceId=t.serviceId,this.commandId=t.commandId,this.serialId=t.serialId,this.tag=t.tag,this.resCode=t.resCode,4===t.serviceId&&includes(e=[1,2,10,11]).call(e,t.commandId)&&(this.msgId=this.unmarshalLong(),this.innerHeader=this._unmarshalHeader())},e._unmarshalHeader=function _unmarshalHeader(){var e=this.unpack.popVarInt(),t=this.unpack.popByte(),r=this.unpack.popByte(),n=this.unpack.popShort(),a=this.unpack.popByte(),i=200;return this.hasRescode(a)&&(i=this.unpack.popShort()),{packetLength:e,serviceId:t,commandId:r,serialId:n,tag:a,resCode:i}},e.hasRescode=function hasRescode(e){return 0!=((e=e||this.tag)&PacketDecoder.RES_CODE)},e.getHeader=function getHeader(){return{packetLength:this.packetLength,sid:this.serviceId,cid:this.commandId,ser:this.serialId,code:this.resCode}},e.getInnerHeader=function getInnerHeader(){return this.innerHeader?{sid:this.innerHeader.serviceId,cid:this.innerHeader.commandId}:null},e.unmarshalProperty=function unmarshalProperty(){var e=this.unpack.popVarInt(),t={};this.bodyArr.push("\nProperty("+e+") {");for(var r=0;r<e;r++){var n=this.unpack.popVarInt();this.bodyArr.push(n+":");var a=this.unpack.popString();this.bodyArr.push('"'+a.length+" "+this.unpack.getOffset()+'",'),t[n]=a}return this.bodyArr.push("},"),t},e.unmarshalPropertyArray=function unmarshalPropertyArray(){var e=this.unpack.popVarInt(),t=[];this.bodyArr.push("\nPropertyArray("+e+") [");for(var r=0;r<e;r++)t.push(this.unmarshalProperty());return this.bodyArr.push("],"),t},e.unmarshalLong=function unmarshalLong(){var e=this.unpack.popLong();return this.bodyArr.push("\nLong:"+e),e},e.unmarshalLongArray=function unmarshalLongArray(){var e=this.unpack.popVarInt(),t=[];this.bodyArr.push("\nLongArray "+e+":");for(var r=0;r<e;r++){var n=this.unpack.popLong();this.bodyArr.push(n+","),t.push(n)}return t},e.unmarshalStrArray=function unmarshalStrArray(){var e=this.unpack.popVarInt(),t=[];this.bodyArr.push("\nStrArray "+e+":");for(var r=0;r<e;r++){var n=this.unpack.popString();this.bodyArr.push(n+","),t.push(n)}return t},e.unmarshalStrLongMap=function unmarshalStrLongMap(){var e=this.unpack.popVarInt(),t={};this.bodyArr.push("\nStrLongMap "+e+":");for(var r=0;r<e;r++){var n=this.unpack.popString();this.bodyArr.push(n+",");var a=this.unpack.popLong();this.bodyArr.push(a+";"),t[n]=a}return t},e.unmarshalStrStrMap=function unmarshalStrStrMap(){var e=this.unpack.popVarInt(),t={};this.bodyArr.push("\nStrStrMap "+e+":");for(var r=0;r<e;r++){var n=this.unpack.popString();this.bodyArr.push(n+",");var a=this.unpack.popString();this.bodyArr.push(a+";"),t[n]=a}return t},e.unmarshalLongLongMap=function unmarshalLongLongMap(){var e=this.unpack.popVarInt(),t={};this.bodyArr.push("\nStrLongLongMap "+e+":");for(var r=0;r<e;r++){var n=this.unpack.popLong();this.bodyArr.push(n+",");var a=this.unpack.popLong();this.bodyArr.push(a+";"),t[n]=a}return{m_map:t}},e.unmarshalKVArray=function unmarshalKVArray(){var e=this.unpack.popVarInt(),t=[];this.bodyArr.push("\nKVArray "+e+":");for(var r=0;r<e;r++)t.push(this.unmarshalStrStrMap());return t},e.unmarshal=function unmarshal(e){var t,r=this,n=Et(Et({},this.getHeader()),{r:[]});if(this.innerHeader&&(n.r[0]=this.msgId,n.r[1]={body:[],headerPacket:this.getInnerHeader()}),!includes(t=[200,406,808,810,7101]).call(t,n.code))return bn(n);if(this.packetLength>0&&this.packetLength>this.unpack.length())throw new Error("UnpackException packetLength("+this.packetLength+") greater than bufferLength("+this.unpack.length()+")");var a=[];return e&&forEach$1(e).call(e,(function(e){if(!r.unpack.checkBufferBoundaryAccess())switch(e.type){case"PropertyArray":a.push(r.unmarshalPropertyArray());break;case"Property":a.push(r.unmarshalProperty());break;case"Byte":a.push(r.unpack.popByte());break;case"Int":a.push(r.unpack.popInt());break;case"Bool":a.push(r.unpack.popBoolean());break;case"Long":a.push(r.unmarshalLong());break;case"LongArray":a.push(r.unmarshalLongArray());break;case"String":a.push(r.unpack.popString());break;case"StrArray":a.push(r.unmarshalStrArray());break;case"StrStrMap":a.push(r.unmarshalStrStrMap());break;case"StrLongMap":a.push(r.unmarshalStrLongMap());break;case"LongLongMap":a.push(r.unmarshalLongLongMap());break;case"KVArray":a.push(r.unmarshalKVArray())}})),this.innerHeader?n.r[1].body=a:n.r=a,bn(n)},PacketDecoder}();np.RES_CODE=2;var ap=function(){function Pack(){this.offset=0,this.pageSize=1024,this.capacity=1048576,this.buffer=new Uint8Array(this.pageSize),this.view=new DataView(this.buffer.buffer)}var e=Pack.prototype;return e.reset=function reset(){this.offset=0,this.buffer=null,this.view=null},e.size=function size(){return this.offset},e.getBuffer=function getBuffer(){var e;return slice(e=this.buffer).call(e,0,this.offset).buffer},e.ensureCapacity=function ensureCapacity(e){var t=this.offset+e;if(t>this.capacity)throw new Error("PackException over limit");if(t>this.buffer.byteLength){var r=Math.ceil(t/this.pageSize)*this.pageSize,n=new Uint8Array(r);n.set(this.buffer),this.buffer=n,this.view=new DataView(this.buffer.buffer)}},e.putRaw=function putRaw(e){this.ensureCapacity(e.length);try{this.buffer.set(e,this.offset),this.offset+=e.length}catch(e){throw new Error("PackException raw")}},e.putByte=function putByte(e){this.ensureCapacity(1);try{this.view.setUint8(this.offset++,e)}catch(e){throw new Error("PackException byte")}},e.putString=function putString(e){try{var t=encodeText(e);this.putVarbin(t)}catch(e){throw new Error("PackException string")}},e.putInt=function putInt(e){this.ensureCapacity(4);try{this.view.setInt32(this.offset,e,!0),this.offset+=4}catch(e){throw new Error("PackException int")}},e.putVarInt=function putVarInt(e){var t=varintToBytes(e);this.putRaw(t)},e.putBoolean=function putBoolean(e){this.ensureCapacity(1);try{this.view.setUint8(this.offset++,e?1:0)}catch(e){throw new Error("PackException boolean")}},e.putLong=function putLong(e){this.ensureCapacity(8);try{var t=function setBigUint64(e,t){void 0===t&&(t=!1);var r=new Uint8Array(8),n=new DataView(r.buffer),a=Number(e>tp-1?e/tp:0),i=Number(4294967295&e),o=t?[4,0]:[0,4],s=o[0],c=o[1];return n.setUint32(s,a,t),n.setUint32(c,i,t),r}(e,!0);this.buffer.set(t,this.offset),this.offset+=8}catch(e){throw new Error("PackException long")}},e.putStringAsLong=function putStringAsLong(e){this.ensureCapacity(8);try{var t=function setBigUint64ForNumberOverflow(e,t){var r,n;void 0===t&&(t=!1);var a=new Uint8Array(8),i=new DataView(a.buffer),o=reverse$1(r=BigNumber(e).divide(tp).number).call(r).join(""),s=reverse$1(n=BigNumber(e).mod(tp).number).call(n).join(""),c=Number(o),l=Number(s),d=t?[4,0]:[0,4],u=d[0],p=d[1];return i.setUint32(u,c,t),i.setUint32(p,l,t),a}(e,!0);this.buffer.set(t,this.offset),this.offset+=8}catch(e){throw new Error("PackException stringAsLong")}},e.putShort=function putShort(e){this.ensureCapacity(2);try{this.view.setInt16(this.offset,e,!0),this.offset+=2}catch(e){throw new Error("PackException short")}},e.putVarbin=function putVarbin(e){if(!e)return this.ensureCapacity(1),this.putVarInt(0);if(e.byteLength>Math.pow(2,31)-2)throw new Error("PackException varbin. too long");var t=varintToBytes(e.length);this.ensureCapacity(t.length+e.length);try{this.buffer.set(t,this.offset),this.offset+=t.length,this.buffer.set(e,this.offset),this.offset+=e.length}catch(e){throw new Error("PackException varbin")}},Pack}();function isConvertibleToNumber(e){if("number"!=typeof e){if(null==e)return!1;e=Number(e)}if(isNaN(e))throw new Error("Number type conversion error");return!0}function isUndefinedOrNull(e){return null==e}var ip,op=function(){function PacketEncoder(e,t,r){this.pack=new ap,this.packetLength=0,this.serviceId=0,this.commandId=0,this.serialId=0,this.tag=0,this.serviceId=e,this.commandId=t,this.serialId=r}var e=PacketEncoder.prototype;return e.marshalHeader=function marshalHeader(){this.pack.putVarInt(this.packetLength),this.pack.putByte(this.serviceId),this.pack.putByte(this.commandId),this.pack.putShort(this.serialId),this.pack.putByte(this.tag)},e.marshalProperty=function marshalProperty(e){var t=this,r=Nt(e),n=filter(r).call(r,(function(e){return!isUndefinedOrNull(e)}));this.pack.putVarInt(n.length),forEach$1(n).call(n,(function(r){t.pack.putVarInt(Number(r)),En(e[r])||"[object Object]"===Object.prototype.toString.call(e[r])?t.pack.putString(bn(e[r])):t.pack.putString(String(e[r]))}))},e.marshalPropertyArray=function marshalPropertyArray(e){var t=this,r=e.length;this.pack.putVarInt(r),forEach$1(e).call(e,(function(e){t.marshalProperty(null==e?void 0:e.v)}))},e.marshalStrArray=function marshalStrArray(e){var t=this,r=filter(e).call(e,(function(e){return!isUndefinedOrNull(e)})),n=r.length;this.pack.putVarInt(n),forEach$1(r).call(r,(function(e){t.pack.putString(String(e))}))},e.marshalLongArray=function marshalLongArray(e){var t=this,r=filter(e).call(e,(function(e){return isConvertibleToNumber(e)})),n=r.length;this.pack.putVarInt(n),forEach$1(r).call(r,(function(e){t.putLong(e)}))},e.marshalStrStrMap=function marshalStrStrMap(e){var t=this,r=Nt(e),n=filter(r).call(r,(function(t){return!isUndefinedOrNull(e[t])&&!isUndefinedOrNull(t)}));this.pack.putVarInt(n.length),forEach$1(n).call(n,(function(r){t.pack.putString(String(r)),t.pack.putString(String(e[r]))}))},e.marshalStrLongMap=function marshalStrLongMap(e){var t=this,r=Nt(e),n=filter(r).call(r,(function(t){return isConvertibleToNumber(e[t])&&!isUndefinedOrNull(t)}));this.pack.putVarInt(n.length),forEach$1(n).call(n,(function(r){t.pack.putString(String(r)),t.putLong(e[r])}))},e.marshalLongLongMap=function marshalLongLongMap(e){var t=this,r=Nt(e),n=filter(r).call(r,(function(t){var r=Number(t);return isConvertibleToNumber(r)&&isConvertibleToNumber(e[r])}));this.pack.putVarInt(n.length),forEach$1(n).call(n,(function(r){var n=Number(r);t.putLong(n),t.putLong(e[n])}))},e.marshalKVArray=function marshalKVArray(e){var t=this,r=e.length;this.pack.putVarInt(r),forEach$1(e).call(e,(function(e){t.marshalStrStrMap(e)}))},e.putLong=function putLong(e){"string"==typeof e&&e.length>15?this.pack.putStringAsLong(e):this.pack.putLong(Number(e))},e.marshal=function marshal(e,t){var r=this;return this.marshalHeader(),t&&forEach$1(t).call(t,(function(t,n){var a,i=t.type,o=null===(a=e[n])||void 0===a?void 0:a.v;if(!isUndefinedOrNull(o))switch(i){case"PropertyArray":r.marshalPropertyArray(o);break;case"Property":r.marshalProperty(o);break;case"Byte":if(!isConvertibleToNumber(o))return;r.pack.putByte(Number(o));break;case"Int":if(!isConvertibleToNumber(o))return;r.pack.putInt(Number(o));break;case"Bool":"false"===o?o=!1:"true"===o&&(o=!0),r.pack.putBoolean(o);break;case"Long":if(!isConvertibleToNumber(o))return;r.putLong(o);break;case"LongArray":r.marshalLongArray(o);break;case"String":r.pack.putString(String(o));break;case"StrArray":r.marshalStrArray(o);break;case"StrStrMap":r.marshalStrStrMap(o);break;case"StrLongMap":r.marshalStrLongMap(o);break;case"LongLongMap":r.marshalLongLongMap(o);break;case"KVArray":r.marshalKVArray(o)}})),this.pack.getBuffer()},e.reset=function reset(){this.pack.reset()},PacketEncoder}(),sp=function(e){function BaseWebsocket(t,r){var n;return(n=e.call(this)||this).url=r,n.websocket=null,n.socketConnectTimer=0,n.core=t,n.url=r,n.status="disconnected",n.logger=t.logger,n.connect(),n}_t(BaseWebsocket,e);var t=BaseWebsocket.prototype;return t.connect=function connect(){"connecting"!==this.status&&"connected"!==this.status?(this.status="connecting",this._createWebsocket("wss://"+this.url+"/websocket")):this.logger.warn("imsocket::socket is connecting or connected",this.status)},t.close=function close(){if(this.status="disconnected",this.websocket){this.logger.log("imsocket:: close websocket");try{this.websocket.close()}catch(e){this.logger.warn("imsocket::attempt to close websocket error",e)}this.clean(),this.emit("disconnect")}},t.clean=function clean(){this.status="disconnected",clearTimeout(this.socketConnectTimer),this.websocket&&(this.socketUrl=void 0,this.websocket.onmessage=null,this.websocket.onopen=null,this.websocket.onerror=null,this.websocket.onclose=null,this.websocket=null)},t.onConnect=function onConnect(){this.status="connected",this.emit("connect"),clearTimeout(this.socketConnectTimer)},t._createWebsocket=function _createWebsocket(e){var t,r=this;this.socketConnectTimer=eo((function(){r.logger.error("imsocket::Websocket connect timeout. url: ",e),r.emit("connectFailed",new Sl({code:"v2"===get(r.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_CONNECT_TIMEOUT:415,detail:{reason:"imsocket::Websocket connect timeout. url: "+e}}))}),this.core.options.socketConnectTimeout||8e3),this.socketUrl=e,this.websocket=new ql.WebSocket(e),this.websocket.binaryType="arraybuffer",this.websocket.onmessage=bind$1(t=this.onMessage).call(t,this),this.websocket.onclose=function(){r.logger.log("imsocket::Websocket onclose done"),"connected"===r.status?(r.clean(),r.emit("disconnect")):(r.clean(),r.emit("connectFailed",new Sl({code:"v2"===get(r.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_CONNECT_FAILED:414,detail:{reason:"imsocket::Websocket onclose done"}})))},this.websocket.onerror=function(e){r.logger.error("imsocket::Websocket onerror",e),"connected"===r.status?(r.clean(),r.emit("disconnect")):(r.clean(),r.emit("connectFailed",new Sl({code:"v2"===get(r.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_CONNECT_FAILED:414,detail:{reason:"imsocket::Websocket onerror."}})))},this.websocket.onopen=function(){r.onConnect()}},t.onMessage=function onMessage(e){if(e.data){var t=new np(e.data),r={sid:-1,cid:-1,ser:-1,packetLength:-1},n=null;try{t.unmarshalHeader(),r=t.getHeader(),n=t.getInnerHeader()}catch(t){this.reportBinaryError({err:t,sid:n?n.sid:null==r?void 0:r.sid,cid:n?n.cid:null==r?void 0:r.cid,rawBuf:e.data,type:"decode"})}var a=n?n.sid:r.sid,i=n?n.cid:r.cid,o=a+"_"+i,s=au[o];if(s&&s.length>0){var c,l=s[0].config;try{c=t.unmarshal(l.response)}catch(n){var d=t.getBodyDetail();this.reportBinaryError({err:n,rawBuf:e.data,sid:a,cid:i,parseDetail:d,type:"decode"}),t.reset();var u=Et(Et({},r),{sid:a,cid:i,code:_l.V2NIM_ERROR_CODE_UNPACK_ERROR});return this.logger.error('imsocket::onMessage "'+u.sid+"_"+u.cid+'", ser '+u.ser+", packetLength "+u.packetLength+" unmarshal error. "+d+" \n",n),void this.emit("message",bn(u))}this.emit("message",c)}else this.core.logger.warn("imsocket::onMessage cmd not found",o);t.reset()}},t.send=function send(e,t,r,n,a){var i,o,s=new op(e,t,r),c=nu[n],l="";try{l=bn(a),o=s.marshal(JSON.parse(l),c.params)}catch(n){throw this.reportBinaryError({err:n,sid:e,cid:t,rawStr:l,type:"encode"}),s.reset(),new Sl({code:_l.V2NIM_ERROR_CODE_PACK_ERROR,detail:{reason:e+"-"+t+", ser "+r+" marshal error",rawError:n}})}null===(i=this.websocket)||void 0===i||i.send(o),s.reset()},t.reportBinaryError=function reportBinaryError(e){var t,r,n,a=e.err,i=e.rawStr,o=e.sid,s=e.cid,c=e.type,l=e.parseDetail,d=e.rawBuf;if(d){try{n=function arrayBufferToBase64(e){if("function"!=typeof btoa)return"";for(var t="",r=new Uint8Array(e),n=r.byteLength,a=0;a<n;a++)t+=String.fromCharCode(r[a]);return r=null,btoa(t)}(d)}catch(e){n="reportBinaryError::arrayBufferToBase64 parsing failed, error: "+(null==e?void 0:e.message)+", sid: "+o+", cid: "+s,this.core.logger.error(n)}d=null}this.core.reporter.reportTraceStart("exceptions",{user_id:null===(t=this.core.auth)||void 0===t?void 0:t.account,trace_id:null===(r=this.core.clientSocket.socket)||void 0===r?void 0:r.sessionId,start_time:Hi(),action:2,exception_service:9});var u=a?(a.message+";;;"||a.code+";;;")+(l?"parseDetail: "+l+";;;":"")+(i?" rawStr: "+i:"")+(n?" rawBuf: "+n:""):"";this.core.reporter.reportTraceUpdateV2("exceptions",{code:"encode"===c?_l.V2NIM_ERROR_CODE_PACK_ERROR:_l.V2NIM_ERROR_CODE_UNPACK_ERROR,description:u,operation_type:"encode"===c?3:4,target:o+"-"+s},{asyncParams:ql.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1)},BaseWebsocket}(to);function _createForOfIteratorHelperLoose$8(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$8(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$8(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$8(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$8(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(ip||(ip={}));var cp,lp=function(){function V2BinaryClientSocket(e){this.isReconnect=!1,this.packetTimeout=8e3,this.packetSer=1,this.backoff=new yu({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new ic,this.pingTimer=0,this.hasNetworkListener=!1,this.core=e,this.auth=e.auth,this.logger=e.logger,this.reporter=e.reporter,this.timerManager=e.timerManager,this.eventBus=e.eventBus,this.setListener()}var e=V2BinaryClientSocket.prototype;return e.setListener=function setListener(){var e=this;this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(function(){e.isReconnect=!0}))},e.setSessionId=function setSessionId(e){this.socket&&(this.socket.sessionId=e)},e.connect=function connect(e,t){var r,n;return void 0===t&&(t=!1),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){var a,i,o,s;return Dl.wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:if(this.isReconnect=t,1!==(a=this.core.auth.getConnectStatus())){c.next=7;break}return i="clientSocket::connect status is "+a+", and would not repeat connect",o=new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:i}}),this.logger.warn(i),c.abrupt("return",Pi.reject(o));case 7:return this.auth.lifeCycle.processEvent("connect"),c.prev=8,c.next=11,this.auth.doLoginStepsManager.add(this.doConnect(e));case 11:this.logger.log("clientSocketV2:: connect success with link url: "+e+", isReconnect: "+t),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:200,mixlink:!0,succeed:!0},{asyncParams:ql.net.getNetworkStatus()}),this.auth.lifeCycle.processEvent("connectSucc"),c.next=28;break;case 16:if(c.prev=16,c.t0=c.catch(8),s=c.t0,this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:s.code||0,description:"connectFailed:"+s.message,mixlink:!0,succeed:!1},{asyncParams:ql.net.getNetworkStatus()}),s.code!==_l.V2NIM_ERROR_CODE_CANCELLED&&s.code!==_l.V2NIM_ERROR_CODE_TIMEOUT){c.next=25;break}throw null===(r=this.socket)||void 0===r||r.close(),null===(n=this.socket)||void 0===n||n.removeAllListeners(),this.socket=void 0,c.t0;case 25:throw this.logger.warn("clientSocketV2::connect failed with link url: "+e,s),this.auth.lifeCycle.processEvent("connectFail",s),c.t0;case 28:case"end":return c.stop()}}),_callee,this,[[8,16]])})))},e.doConnect=function doConnect(e){var t=this,r=!1;return new Pi((function(n,a){var i;t.socket=new sp(t.core,e),t.socket.on("connect",(function(){t.logger.log("clientSocketV2::socket on connect",e),t.core.reporterHookLinkKeep.start(),t.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:e}),r=!0,n()})),t.socket.on("message",bind$1(i=t.onMessage).call(i,t)),t.socket.on("disconnect",(function(n){return __awaiter(t,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return r=!0,this.logger.log("clientSocketV2::socket on disconnect "+e,n),t.next=4,this.core.reporterHookLinkKeep.update({code:(null==n?void 0:n.code)||0,description:(null==n?void 0:n.reason)||"socket on disconnect",operation_type:1,target:e});case 4:this.core.reporterHookLinkKeep.end(!1),this.doDisconnect(ip.OFFLINE,"SocketOnDisconnect");case 6:case"end":return t.stop()}}),_callee2,this)})))})),t.socket.on("connectFailed",(function(n){r?t.ping():(t.logger.error("clientSocketV2::connectFailed:"+e+", reason:"+(n&&n.message)),t.cleanSocket()),r=!0,a(n)}))}))},e.cleanSocket=function cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)},e.resetSocketConfig=function resetSocketConfig(){this.backoff.reset(),this.initOnlineListener()},e.doDisconnect=function doDisconnect(e,t){if(this.logger.log("clientSocketV2::doDisconnect: type "+e+", reason ",t),0!==this.core.auth.getConnectStatus()){var r={1:"close",2:"kicked",3:"broken"}[e]||"";this.markAllCmdInvaild(new Sl({code:_l.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:r}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket(),e===ip.ACTIVE||e===ip.KICKED?this.destroyOnlineListener():e===ip.OFFLINE&&(this.auth.lifeCycle.processEvent("connectionBroken",new Sl({code:_l.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"connection broken due to internal reasons"}})),this.logger.log("clientSocketV2::doDisconnect: pending reconnect "+this.isReconnect),this.isReconnect&&this.auth.lifeCycle.processEvent("waiting"))}else this.logger.warn("clientSocketV2::doDisconnect: already disconnected")},e.sendCmd=function sendCmd(e,t,r){var n=this,a=this.core.auth.getLoginStatus(),i=["v2Login","login","chatroomLogin","v2ChatroomLogin"],o={cmd:e};if(1!==a&&!includes(i).call(i,e))return this.logger.warn("clientSocketV2::NIM login status is "+a+", so can not sendCmd "+e),Pi.reject(new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:Et({reason:"Can not sendCmd due to no logined"},o)}));var s="heartbeat"!==e,c=s?this.packetSer++:0,l=createCmd(e,c,this.logger,t);if(!l){var d=new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:Et(Et({},o),{reason:"SendCmd::createCmd error: "+c+" "+e})});return this.logger.error(d),Pi.reject(d)}var u=l.packet,p=l.hasPacketResponse,m=l.hasPacketTimer,h=bn(u);s&&(this.logger.getDebugMode()?this.logger.debug("clientSocketV2::sendCmd: "+u.SID+"_"+u.CID+","+e+",ser:"+c,h):this.logger.log("clientSocketV2::sendCmd: "+u.SID+"_"+u.CID+","+e+",ser:"+c));var g=(new Date).getTime();return new Pi((function(a,i){p&&n.sendingCmdMap.set(c,{cmd:e,params:t,callback:[a,i],timer:m?eo((function(){var t=new Sl({code:_l.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,detail:Et({ser:c,reason:"Packet Timeout: ser "+c+" cmd "+e,timetag:(new Date).getTime()},o)});n.markCmdInvalid(c,t,e)}),r&&r.timeout?r.timeout:n.packetTimeout):null});try{n.socket.send(u.SID,u.CID,c,e,u.Q),p||a(u)}catch(t){var s=new Sl({code:_l.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED,detail:Et({ser:c,reason:"Unable to send packet"+(t&&t.message?": "+t.message:""),timetag:(new Date).getTime(),rawError:t},o)});n.markCmdInvalid(c,s,e),i(s)}})).catch((function(e){return __awaiter(n,void 0,void 0,Dl.mark((function _callee3(){var t,r;return Dl.wrap((function _callee3$(n){for(;;)switch(n.prev=n.next){case 0:if(t=e,r=[_l.V2NIM_ERROR_CODE_DISCONNECT,_l.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,_l.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED],includes(r).call(r,t.code)){n.next=4;break}return n.abrupt("return",Pi.reject(t));case 4:return this.reportSendCmdFailed(t,{sid:u.SID,cid:u.CID,ser:c},g),n.abrupt("return",Pi.reject(t));case 6:case"end":return n.stop()}}),_callee3,this)})))}))},e.reportSendCmdFailed=function reportSendCmdFailed(e,t,r){var n;this.reporter.reportTraceStart("exceptions",{user_id:this.core.auth.getLoginUser(),trace_id:null===(n=this.socket)||void 0===n?void 0:n.sessionId,start_time:r,action:2,exception_service:6});var a=get(e,"detail.disconnect_reason")||"",i=e.code===_l.V2NIM_ERROR_CODE_DISCONNECT?bn({disconnect_reason:a}):e.detail.reason;this.reporter.reportTraceUpdateV2("exceptions",{code:e.code,description:i,operation_type:1,target:t.sid+"-"+t.cid,context:""+t.ser},{asyncParams:ql.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1)},e.onMessage=function onMessage(e){var t=parseCmd(e,this.logger);if(t){var r=t[0],n=r.raw.ser;"heartbeat"!==r.cmd&&(this.logger.getDebugMode()?this.logger.debug("clientSocketV2::recvCmd "+r.raw.sid+"_"+r.raw.cid+","+r.cmd+",ser:"+n,e):this.logger.log("clientSocketV2::recvCmd "+r.raw.sid+"_"+r.raw.cid+","+r.cmd+",ser:"+n+",code:"+r.raw.code));for(var a,i=_createForOfIteratorHelperLoose$8(t);!(a=i()).done;){var o=a.value;if(o.error&&this.logger.error("clientSocketV2::onMessage packet error",o.raw.sid+"_"+o.raw.cid+", ser:"+n+",",o.error),o.notFound)return void this.logger.warn("clientSocketV2::onMessage packet not found",o.raw.sid+"_"+o.raw.cid+", ser:"+n);this.packetHandler(o)}}},e.packetHandler=function packetHandler(e){var t,r,n=this;if(e){var a=e.raw.ser,i=this.sendingCmdMap.get(a);if(i&&i.cmd===e.cmd){var o=i.callback,s=i.timer,c=i.params;if(clearTimeout(s),e.params=c,this.sendingCmdMap.delete(a),"heartbeat"===e.cmd)return void o[0]();var l=null===(t=this.core[e.service])||void 0===t?void 0:t.process(e);l&&"function"==typeof l.then?l.then((function(e){o[0](e)})).catch((function(e){o[1](e)})):(this.logger.log("clientSocketV2::handlerFn without promise",e.service,e.cmd),o[0](e))}else{var d=null===(r=this.core[e.service])||void 0===r?void 0:r.process(e);d&&"function"==typeof d.then&&d.catch((function(e){n.logger.error("clientSocketV2::no obj cache, no process handler",e)}))}}},e.markCmdInvalid=function markCmdInvalid(e,t,r){var n=this.sendingCmdMap.get(e);if(n){var a=n.callback,i=n.timer;i&&clearTimeout(i),this.sendingCmdMap.delete(e),this.logger.warn("clientSocketV2::packet "+e+", "+r+" is invalid:",t),a[1](t)}},e.markAllCmdInvaild=function markAllCmdInvaild(e){var t,r=this;this.logger.log("markAllCmdInvaild",e),forEach$1(t=this.sendingCmdMap).call(t,(function(t){var n=t.callback,a=t.timer,i=t.cmd;r.logger.log("clientSocketV2::markAllCmdInvaild:cmd "+i),a&&clearTimeout(a),n[1](e)})),this.sendingCmdMap.clear()},e.ping=function ping(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t=this;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return clearTimeout(this.pingTimer),r.prev=1,r.next=4,this.sendCmd("heartbeat");case 4:r.next=20;break;case 6:if(r.prev=6,r.t0=r.catch(1),r.t0.code!==_l.V2NIM_ERROR_CODE_DISCONNECT){r.next=11;break}return r.abrupt("return");case 11:return r.next=13,this.testHeartBeat5Timeout();case 13:if(!r.sent){r.next=20;break}return r.next=17,this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(e=this.socket)||void 0===e?void 0:e.url});case 17:return this.core.reporterHookLinkKeep.end(!0),this.doDisconnect(ip.OFFLINE,"PingError"),r.abrupt("return");case 20:this.pingTimer=eo((function(){t.ping()}),3e4);case 21:case"end":return r.stop()}}),_callee4,this,[[1,6]])})))},e.testHeartBeat5Timeout=function testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var e;return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:clearTimeout(this.pingTimer),e=0;case 2:if(!(e<5)){t.next=15;break}return t.prev=3,t.next=6,this.sendCmd("heartbeat",{},{timeout:3e3});case 6:return t.abrupt("return",!1);case 9:t.prev=9,t.t0=t.catch(3),this.logger.log("clientSocketV2::test heartbeat "+e+" Timeout");case 12:e++,t.next=2;break;case 15:return t.abrupt("return",!0);case 16:case"end":return t.stop()}}),_callee5,this,[[3,9]])})))},e.initOnlineListener=function initOnlineListener(){var e=this;this.hasNetworkListener||(this.logger.log("clientSocketV2::onlineListener:init"),this.hasNetworkListener=!0,ql.net.onNetworkStatusChange((function(t){e.logger.log("clientSocketV2::onlineListener:network change",t);var r=e.auth.getConnectStatus(),n=e.auth.getLoginStatus();t.isConnected&&1===n?e.ping():t.isConnected&&3===r?(e.logger.log("clientSocketV2::onlineListener:online and connectStatus is waiting, do reLogin"),e.auth.reconnect.clearReconnectTimer(),e.auth.reconnect.doReLogin()):t.isConnected||e.doDisconnect(ip.OFFLINE,"OfflineListener")})))},e.destroyOnlineListener=function destroyOnlineListener(){this.logger.log("clientSocketV2::onlineListener:destroy"),ql.net.offNetworkStatusChange(),this.hasNetworkListener=!1},V2BinaryClientSocket}();function _createForOfIteratorHelperLoose$7(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$7(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$7(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$7(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$7(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}!function(e){e[e.ACTIVE=1]="ACTIVE",e[e.KICKED=2]="KICKED",e[e.OFFLINE=3]="OFFLINE"}(cp||(cp={}));var dp=function(){function V2ClientSocket(e){this.isReconnect=!1,this.packetTimeout=8e3,this.packetSer=1,this.backoff=new yu({max:8e3,min:1600,jitter:.01}),this.sendingCmdMap=new ic,this.pingTimer=0,this.hasNetworkListener=!1,this.core=e,this.auth=e.auth,this.logger=e.logger,this.reporter=e.reporter,this.timerManager=e.timerManager,this.eventBus=e.eventBus,this.setListener()}var e=V2ClientSocket.prototype;return e.setListener=function setListener(){var e=this;this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(function(){e.isReconnect=!0}))},e.setSessionId=function setSessionId(e){this.socket&&(this.socket.sessionId=e)},e.connect=function connect(e,t){var r,n;return void 0===t&&(t=!1),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){var a,i,o,s;return Dl.wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:if(this.isReconnect=t,1!==(a=this.core.auth.getConnectStatus())){c.next=7;break}return i="clientSocket::connect status is "+a+", and would not repeat connect",o=new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:i}}),this.logger.warn(i),c.abrupt("return",Pi.reject(o));case 7:return this.auth.lifeCycle.processEvent("connect"),c.prev=8,c.next=11,this.auth.doLoginStepsManager.add(this.doConnect(e));case 11:this.logger.log("clientSocketV2:: connect success with link url: "+e+", isReconnect: "+t),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:200,mixlink:!0,succeed:!0},{asyncParams:ql.net.getNetworkStatus()}),this.auth.lifeCycle.processEvent("connectSucc"),c.next=28;break;case 16:if(c.prev=16,c.t0=c.catch(8),s=c.t0,this.core.reporter.reportTraceUpdateV2("login",{operation_type:"TCP",target:e,code:s.code||0,description:"connectFailed:"+s.message,mixlink:!0,succeed:!1},{asyncParams:ql.net.getNetworkStatus()}),s.code!==_l.V2NIM_ERROR_CODE_CANCELLED&&s.code!==_l.V2NIM_ERROR_CODE_TIMEOUT){c.next=25;break}throw null===(r=this.socket)||void 0===r||r.close(),null===(n=this.socket)||void 0===n||n.removeAllListeners(),this.socket=void 0,c.t0;case 25:throw this.logger.warn("clientSocketV2::connect failed with link url: "+e,s),this.auth.lifeCycle.processEvent("connectFail",s),c.t0;case 28:case"end":return c.stop()}}),_callee,this,[[8,16]])})))},e.doConnect=function doConnect(e){var t=this,r=!1;return new Pi((function(n,a){var i;t.socket=new Tu(t.core,e),t.socket.on("connect",(function(){t.logger.log("clientSocketV2::socket on connect",e),t.core.reporterHookLinkKeep.start(),t.core.reporterHookLinkKeep.update({code:0,description:"connection begin",operation_type:0,target:e}),r=!0,n()})),t.socket.on("message",bind$1(i=t.onMessage).call(i,t)),t.socket.on("disconnect",(function(n){return __awaiter(t,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return r=!0,this.logger.log("clientSocketV2::socket on disconnect",n),t.next=4,this.core.reporterHookLinkKeep.update({code:(null==n?void 0:n.code)||0,description:(null==n?void 0:n.reason)||"socket on disconnect",operation_type:1,target:e});case 4:this.core.reporterHookLinkKeep.end(!1),this.doDisconnect(cp.OFFLINE,"SocketOnDisconnect");case 6:case"end":return t.stop()}}),_callee2,this)})))})),t.socket.on("handshakeFailed",(function(e){r?t.ping():(t.logger.error('clientSocketV2::handshake failed: "'+(e&&e.message)+'"'),t.cleanSocket()),r=!0,a(e)}))}))},e.cleanSocket=function cleanSocket(){this.socket&&("function"==typeof this.socket.removeAllListeners&&this.socket.removeAllListeners(),"function"==typeof this.socket.close&&this.socket.close(),this.socket=void 0)},e.resetSocketConfig=function resetSocketConfig(){this.backoff.reset(),this.initOnlineListener()},e.doDisconnect=function doDisconnect(e,t){if(this.logger.log("clientSocketV2::doDisconnect: type "+e+", reason ",t),0!==this.core.auth.getConnectStatus()){var r={1:"close",2:"kicked",3:"broken"}[e]||"";this.markAllCmdInvaild(new Sl({code:_l.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"Packet timeout due to instance disconnect",disconnect_reason:r}})),this.timerManager.destroy(),clearTimeout(this.pingTimer),this.cleanSocket(),e===cp.ACTIVE||e===cp.KICKED?this.destroyOnlineListener():e===cp.OFFLINE&&(this.auth.lifeCycle.processEvent("connectionBroken",new Sl({code:_l.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"connection broken due to internal reasons"}})),this.logger.log("clientSocketV2::doDisconnect: pending reconnect "+this.isReconnect),this.isReconnect&&this.auth.lifeCycle.processEvent("waiting"))}else this.logger.warn("clientSocketV2::doDisconnect: already disconnected")},e.sendCmd=function sendCmd(e,t,r){var n=this,a=this.core.auth.getLoginStatus(),i=["v2Login","login","chatroomLogin","v2ChatroomLogin"],o={cmd:e};if(1!==a&&!includes(i).call(i,e))return this.logger.warn("clientSocketV2::NIM login status is "+a+", so can not sendCmd "+e),Pi.reject(new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:Et({reason:"Can not sendCmd due to no logined"},o)}));var s="heartbeat"!==e,c=s?this.packetSer++:0,l=createCmd(e,c,this.logger,t);if(!l){var d=new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:Et(Et({},o),{reason:"SendCmd::createCmd error: "+c+" "+e})});return this.logger.error(d),Pi.reject(d)}var u=l.packet,p=l.hasPacketResponse,m=l.hasPacketTimer,h=bn(u);s&&(this.logger.getDebugMode()?this.logger.debug("clientSocketV2::sendCmd: "+u.SID+"_"+u.CID+","+e+",ser:"+c,h):this.logger.log("clientSocketV2::sendCmd: "+u.SID+"_"+u.CID+","+e+",ser:"+c));var g=(new Date).getTime();return new Pi((function(a,i){p&&n.sendingCmdMap.set(c,{cmd:e,params:t,callback:[a,i],timer:m?eo((function(){var t=new Sl({code:_l.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,detail:Et({ser:c,reason:"Packet Timeout: ser "+c+" cmd "+e,timetag:(new Date).getTime()},o)});n.markCmdInvalid(c,t,e)}),r&&r.timeout?r.timeout:n.packetTimeout):null});try{n.socket.send(h),p||a(u)}catch(t){var s=new Sl({code:_l.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED,detail:Et({ser:c,reason:"Unable to send packet"+(t&&t.message?": "+t.message:""),timetag:(new Date).getTime(),rawError:t},o)});n.markCmdInvalid(c,s,e),i(s)}})).catch((function(e){return __awaiter(n,void 0,void 0,Dl.mark((function _callee3(){var t,r,n,a,i;return Dl.wrap((function _callee3$(o){for(;;)switch(o.prev=o.next){case 0:if(r=e,n=[_l.V2NIM_ERROR_CODE_DISCONNECT,_l.V2NIM_ERROR_CODE_PROTOCOL_TIMEOUT,_l.V2NIM_ERROR_CODE_PROTOCOL_SEND_FAILED],includes(n).call(n,r.code)){o.next=4;break}return o.abrupt("return",Pi.reject(r));case 4:return this.reporter.reportTraceStart("exceptions",{user_id:this.core.auth.getLoginUser(),trace_id:null===(t=this.socket)||void 0===t?void 0:t.sessionId,start_time:g,action:2,exception_service:6}),a=get(r,"detail.disconnect_reason")||"",i=r.code===_l.V2NIM_ERROR_CODE_DISCONNECT?bn({disconnect_reason:a}):r.detail.reason,this.reporter.reportTraceUpdateV2("exceptions",{code:r.code,description:i,operation_type:1,target:u.SID+"-"+u.CID,context:""+u.SER},{asyncParams:ql.net.getNetworkStatus()}),this.reporter.reportTraceEnd("exceptions",1),o.abrupt("return",Pi.reject(r));case 10:case"end":return o.stop()}}),_callee3,this)})))}))},e.onMessage=function onMessage(e){var t=parseCmd(e,this.logger);if(t)for(var r,n=_createForOfIteratorHelperLoose$7(t);!(r=n()).done;){var a=r.value,i=a.raw.ser;if(a.error&&this.logger.error("clientSocketV2::onMessage packet error",a.raw.sid+"_"+a.raw.cid+", ser:"+i+",",a.error),a.notFound)return void this.logger.warn("clientSocketV2::onMessage packet not found",a.raw.sid+"_"+a.raw.cid+", ser:"+i);"heartbeat"!==a.cmd&&(this.logger.getDebugMode()?this.logger.debug("clientSocketV2::recvCmd "+a.raw.sid+"_"+a.raw.cid+","+a.cmd+",ser:"+i,a.content):this.logger.log("clientSocketV2::recvCmd "+a.raw.sid+"_"+a.raw.cid+","+a.cmd+",ser:"+i+";code:"+a.raw.code)),this.packetHandler(a)}},e.packetHandler=function packetHandler(e){var t,r,n=this;if(e){var a=e.raw.ser,i=this.sendingCmdMap.get(a);if(i&&i.cmd===e.cmd){var o=i.callback,s=i.timer,c=i.params;if(clearTimeout(s),e.params=c,this.sendingCmdMap.delete(a),"heartbeat"===e.cmd)return void o[0]();var l=null===(t=this.core[e.service])||void 0===t?void 0:t.process(e);l&&"function"==typeof l.then?l.then((function(e){o[0](e)})).catch((function(e){o[1](e)})):(this.logger.log("clientSocketV2::handlerFn without promise",e.service,e.cmd),o[0](e))}else{var d=null===(r=this.core[e.service])||void 0===r?void 0:r.process(e);d&&"function"==typeof d.then&&d.catch((function(e){n.logger.error("clientSocketV2::no obj cache, no process handler",e)}))}}},e.markCmdInvalid=function markCmdInvalid(e,t,r){var n=this.sendingCmdMap.get(e);if(n){var a=n.callback,i=n.timer;i&&clearTimeout(i),this.sendingCmdMap.delete(e),this.logger.warn("clientSocketV2::packet "+e+", "+r+" is invalid:",t),a[1](t)}},e.markAllCmdInvaild=function markAllCmdInvaild(e){var t,r=this;this.logger.log("markAllCmdInvaild",e),forEach$1(t=this.sendingCmdMap).call(t,(function(t){var n=t.callback,a=t.timer,i=t.cmd;r.logger.log("clientSocketV2::markAllCmdInvaild:cmd "+i),a&&clearTimeout(a),n[1](e)})),this.sendingCmdMap.clear()},e.ping=function ping(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t=this;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return clearTimeout(this.pingTimer),r.prev=1,r.next=4,this.sendCmd("heartbeat");case 4:r.next=20;break;case 6:if(r.prev=6,r.t0=r.catch(1),r.t0.code!==_l.V2NIM_ERROR_CODE_DISCONNECT){r.next=11;break}return r.abrupt("return");case 11:return r.next=13,this.testHeartBeat5Timeout();case 13:if(!r.sent){r.next=20;break}return r.next=17,this.core.reporterHookLinkKeep.update({code:0,description:"Heartbeat-discovered link failure",operation_type:1,target:null===(e=this.socket)||void 0===e?void 0:e.url});case 17:return this.core.reporterHookLinkKeep.end(!0),this.doDisconnect(cp.OFFLINE,"PingError"),r.abrupt("return");case 20:this.pingTimer=eo((function(){t.ping()}),3e4);case 21:case"end":return r.stop()}}),_callee4,this,[[1,6]])})))},e.testHeartBeat5Timeout=function testHeartBeat5Timeout(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var e;return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:clearTimeout(this.pingTimer),e=0;case 2:if(!(e<5)){t.next=15;break}return t.prev=3,t.next=6,this.sendCmd("heartbeat",{},{timeout:3e3});case 6:return t.abrupt("return",!1);case 9:t.prev=9,t.t0=t.catch(3),this.logger.log("clientSocketV2::test heartbeat "+e+" Timeout");case 12:e++,t.next=2;break;case 15:return t.abrupt("return",!0);case 16:case"end":return t.stop()}}),_callee5,this,[[3,9]])})))},e.initOnlineListener=function initOnlineListener(){var e=this;this.hasNetworkListener||(this.logger.log("clientSocketV2::onlineListener:init"),this.hasNetworkListener=!0,ql.net.onNetworkStatusChange((function(t){e.logger.log("clientSocketV2::onlineListener:network change",t);var r=e.auth.getConnectStatus(),n=e.auth.getLoginStatus();t.isConnected&&1===n?e.ping():t.isConnected&&3===r?(e.logger.log("clientSocketV2::onlineListener:online and connectStatus is waiting, do reLogin"),e.auth.reconnect.clearReconnectTimer(),e.auth.reconnect.doReLogin()):t.isConnected||e.doDisconnect(cp.OFFLINE,"OfflineListener")})))},e.destroyOnlineListener=function destroyOnlineListener(){this.logger.log("clientSocketV2::onlineListener:destroy"),ql.net.offNetworkStatusChange(),this.hasNetworkListener=!1},V2ClientSocket}(),up=function(){function V2NIMLoginReconnect(e){this.currenRetryCount=0,this.backoff=new yu({max:8e3,min:1600,jitter:.01}),this.reconnectTimer=0,this.core=e,this.auth=e.V2NIMLoginService}var e=V2NIMLoginReconnect.prototype;return e.reset=function reset(){this.currenRetryCount=0,this.backoff.reset(),this.reconnectTimer&&clearTimeout(this.reconnectTimer)},e.clearReconnectTimer=function clearReconnectTimer(){this.reconnectTimer&&clearTimeout(this.reconnectTimer)},e.attempToReLogin=function attempToReLogin(){var e=this,t=this.backoff.duration();if("function"==typeof this.reconnectDelayProvider)try{var r=this.reconnectDelayProvider(t);"number"==typeof r&&r>=0&&(t=r>=1e3?r:r+200+Math.ceil(300*Math.random()))}catch(e){this.core.logger.error("reconnect::connectDelayProvider excute failed,",e)}return this.currenRetryCount++,this.core.logger.log("reconnect::reconnect timer is about to be set, delay "+t+" ms, current retry count is "+this.currenRetryCount),this.core.reporter.reportTraceStart("login",{user_id:this.auth.getLoginUser(),action:"auto_login",binary_websocket:this.auth.binaryWebsocket}),this.clearReconnectTimer(),this.reconnectTimer=eo((function(){e.core.logger.log("reconnect::reconnect timer is now triggered");var t=e.auth.getConnectStatus();3===t?e.doReLogin():e.core.logger.warn("reconnect::reconnect timer is over because connect status now is "+t)}),t),!0},e.doReLogin=function doReLogin(){var e=this;this.auth.loginOption.forceMode=!1,this.auth.originLoginPromise=this.auth.doLogin(!0);var t=this.auth.previousLoginManager.add(this.auth.originLoginPromise);return t.then((function(){e.core.reporter.reportTraceEnd("login",!0)})).catch((function(t){var r=t;if(e.core.logger.warn("reconnect::try login but failed due to",r),e.core.reporter.reportTraceEnd("login",!1),e.auth.checkLoginTerminalCode(r&&r.code))return e.auth.clientSocket.doDisconnect(ip.ACTIVE,"ReloginTerminated"),void e.auth.lifeCycle.processEvent("exited",r);r&&399===r.code&&e.auth.lbs.reset(),e.auth.lifeCycle.processEvent("waiting")})),t},e._setReconnectDelayProvider=function _setReconnectDelayProvider(e){this.reconnectDelayProvider=e},V2NIMLoginReconnect}(),pp=function(){function V2NIMLoginLbs(e){this.socketLinkUrls=[],this.timer=0,this.failedCount=0,this.core=e,this.auth=e.V2NIMLoginService}var e=V2NIMLoginLbs.prototype;return e.getLbsInfos=function getLbsInfos(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e,t,r,n;return Dl.wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.socketLinkUrls.length>0)){a.next=5;break}return e=this.socketLinkUrls.shift(),this.socketLinkUrls=[],this.core.logger.log("V2NIMLoginService::getLbsInfos:use cache link",e),a.abrupt("return",Pi.resolve(e));case 5:return this.auth.lifeCycle.processEvent("addressing"),this.core.reporterHookLBS.start(this.core.account),t=uniq(this.auth.config.lbsUrls),a.prev=8,a.next=11,this.ladderLoad(t);case 11:if(200===(r=a.sent).status&&r.data){a.next=15;break}throw this.core.logger.error("V1NIMLoginService::getLbsInfos:error status",r.status,r),new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"V2NIMLoginService::getLbsInfos failed, status "+r.status}});case 15:this.success(r),a.next=26;break;case 18:if(a.prev=18,a.t0=a.catch(8),n=a.t0,this.core.logger.error("V2NIMLoginService::lbs getLbsInfos error, use default link: "+this.auth.config.linkUrl+". error:",a.t0),this.reportForFail(t[0],n.code,n.message),!this.checkTerminator(n.code)){a.next=25;break}throw a.t0;case 25:this.socketLinkUrls=[this.auth.config.linkUrl];case 26:return a.abrupt("return",this.socketLinkUrls.shift());case 27:case"end":return a.stop()}}),_callee,this,[[8,18]])})))},e.checkTerminator=function checkTerminator(e){return e===_l.V2NIM_ERROR_CODE_CANCELLED||e===_l.V2NIM_ERROR_CODE_TIMEOUT},e.generateUrl=function generateUrl(e){return e+(indexOf(e).call(e,"?")>-1?"&":"?")+"k="+this.core.options.appkey+"&id="+this.core.auth.getLoginUser()+"&sv=180&pv=1&networkType=0&lv=1"},e.requstLbs=function requstLbs(e){return this.auth.doLoginStepsManager.add(this.core.adapters.request(this.generateUrl(e),{method:"GET",dataType:"json",timeout:8e3}))},e.setLadderTimer=function setLadderTimer(e,t,r,n){var a=this;this.timer&&clearTimeout(this.timer);var i=e[t];this.timer=eo((function(){i&&(a.setLadderTimer(e,t+1,r,n),a.core.logger.log("V2NIMLoginService::getLbsInfos "+t+":",i),a.reportForLbsStart(i,t),a.requstLbs(i).then((function(e){a.reset(),r(Et(Et({},e),{url:i}))})).catch((function(r){var o;if(a.core.logger.warn("V2NIMLoginService::getLbsInfos "+t+" failed:",r),a.failedCount+=1,a.reportForFailOnce(i,r.code,(null===(o=r.detail)||void 0===o?void 0:o.reason)||r.message),a.failedCount>=e.length||a.checkTerminator(r.code))return a.reset(),void n(r)})))}),2e3)},e.ladderLoad=function ladderLoad(e){var t=this;return new Pi((function(r,n){e.length>1&&t.setLadderTimer(e,1,r,n);var a=e[0];t.core.logger.log("V2NIMLoginService::getLbsInfos 0:",a),t.reportForLbsStart(a,0),t.requstLbs(a).then((function(e){t.reset(),r(Et(Et({},e),{url:a}))})).catch((function(r){var i;t.failedCount+=1,t.core.logger.warn("V2NIMLoginService::getLbsInfos 0 failed:",r),t.reportForFailOnce(a,r.code,(null===(i=r.detail)||void 0===i?void 0:i.reason)||r.message),(t.failedCount>=e.length||t.checkTerminator(r.code))&&(t.reset(),n(r))}))}))},e.success=function success(e){var t,r,n,a,i=e.data.common,o=i["mix.link"]||[],s=i["link.default"]||[];this.socketLinkUrls=concat(t=concat(o).call(o,s)).call(t,this.auth.config.linkUrl),e.data["nos-chunk"]&&(null===(n=this.core.cloudStorage)||void 0===n?void 0:n.setOptions)&&(this.core.logger.log("getLbsInfos success. lbs.nos-chunk",e.data["nos-chunk"]),this.core.cloudStorage.setOptions({chunkUploadHost:e.data["nos-chunk"]})),En(e.data.nosup)&&e.data.nosup.length>0&&(null===(a=this.core.cloudStorage)||void 0===a?void 0:a.setOptions)&&(this.core.logger.log("getLbsInfos success. lbs.nosup",e.data.nosup),this.core.cloudStorage.setOptions({commonUploadHostBackupList:e.data.nosup,commonUploadHost:e.data.nosup[0]})),this.core.logger.log("V2NIMLoginService::getLbsInfos success, socket link:",slice(r=this.socketLinkUrls).call(r,0),"chunkUploadHost: ",e.data["nos-chunk"]),this.reportForLbsSuccess(e.url,e.data)},e.reportForLbsStart=function reportForLbsStart(e,t){this.core.reporterHookLBS.updateBegin({target:e,index:t})},e.reportForLbsSuccess=function reportForLbsSuccess(e,t){this.core.reporterHookLBS.updateComplete({target:e,code:200,body:bn(t)}),this.core.reporterHookLBS.end(!0),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,code:200,succeed:!0},{asyncParams:ql.net.getNetworkStatus()})},e.reportForFailOnce=function reportForFailOnce(e,t,r){this.core.reporterHookLBS.updateComplete({target:e,code:t,body:r})},e.reportForFail=function reportForFail(e,t,r){this.core.reporterHookLBS.end(!1),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"HTTP",target:e,description:r,code:t,succeed:!1},{asyncParams:ql.net.getNetworkStatus()})},e.reset=function reset(){this.socketLinkUrls=[],this.failedCount=0,clearTimeout(this.timer)},V2NIMLoginLbs}();var mp=function(){function V2NIMLoginAuthenticator(e){this.lastLoginClientKey="__NIM_LAST_LOGIN_CLIENT__",this.loginClients=[],this.loginClientOfThisConnection={},this.core=e,this.auth=e.V2NIMLoginService}var e=V2NIMLoginAuthenticator.prototype;return e.verifyAuthentication=function verifyAuthentication(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a,i,o,s,c,l,d,u;return Dl.wrap((function _callee$(p){for(;;)switch(p.prev=p.next){case 0:return p.next=2,this.auth.doLoginStepsManager.add(this.refreshLoginToken(this.auth.account));case 2:return r=p.sent,p.next=5,this.auth.doLoginStepsManager.add(this.refreshThirdPartyExt(this.auth.account));case 5:return n=p.sent,this.auth.token=r,a=ql.getSystemInfo(),i={appkey:this.core.options.appkey,account:this.auth.account,token:r,authType:this.auth.loginOption.authType,appLogin:e?0:1,clientType:16,clientSession:this.auth.clientSession,clientId:this.auth.deviceId,sdkVersion:100700,userAgent:this.core.options.loginSDKTypeParamCompat?"Native/10.7.0":slice(t=a.userAgent.replace("{{appkey}}",this.core.options.appkey)).call(t,0,299),libEnv:this.core.options.loginSDKTypeParamCompat?void 0:a.libEnv,hostEnv:this.core.options.loginSDKTypeParamCompat?0:a.hostEnvEnum,sdkHumanVersion:this.core.options.flutterSdkVersion||"10.7.0",os:a.os,browser:a.browser,protocolVersion:1,customClientType:this.auth.config.customClientType,customTag:this.auth.config.customTag,thirdPartyExtension:n},o=a.os.toLowerCase(),"UNIAPP"!==ql.platform||"ios"!==o&&"android"!==o?"React Native"===ql.platform&&(this.core.logger.log("V2NIMLoginService deviceInfo",this.core.V2NIMLoginService.deviceInfo,"os",o),i.isReactNative=1,i.clientType="ios"===o?2:1,i.deviceInfo=bn(Et({IS_SUPPORT_HONOR:!0},this.core.V2NIMLoginService.deviceInfo))):(i.isReactNative=1,i.clientType="ios"===o?2:1,a.pushDeviceInfo&&a.pushDeviceInfo.MANUFACTURER&&(i.deviceInfo=bn(Et({IS_SUPPORT_HONOR:!0},a.pushDeviceInfo)))),this.core.logger.log("V2NIMLoginService::do login ",i.account,i.clientSession,i.appLogin),p.prev=12,p.next=15,this.auth.doLoginStepsManager.add(this.auth.clientSocket.sendCmd("v2Login",{tag:i}));case 15:s=p.sent,p.next=26;break;case 18:if(p.prev=18,p.t0=p.catch(12),c=p.t0,this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"26-3",code:c.code||0,succeed:!1,description:c.message},{asyncParams:ql.net.getNetworkStatus()}),c.code!==_l.V2NIM_ERROR_CODE_CANCELLED&&c.code!==_l.V2NIM_ERROR_CODE_TIMEOUT){p.next=24;break}throw c;case 24:throw this.processLoginFailed(c),c;case 26:return l=s.content,d=l.data,u=l.loginClients,this.changeLoginClient(1,u),this.core.reporter.reportTraceUpdateV2("login",{operation_type:"protocol",target:"26-3",code:200,succeed:!0},{asyncParams:ql.net.getNetworkStatus()}),this.loginClientOfThisConnection=formatLoginInfo(d),this.core.clientSocket.setSessionId(d.consid),ql.localStorage.setItem(this.lastLoginClientKey,bn(Et({account:this.auth.account},this.loginClientOfThisConnection))),p.abrupt("return",this.loginClientOfThisConnection);case 33:case"end":return p.stop()}}),_callee,this,[[12,18]])})))},e.refreshLoginToken=function refreshLoginToken(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n;return Dl.wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:if(0!==this.auth.loginOption.authType){a.next=2;break}return a.abrupt("return",this.auth.token);case 2:if("function"==typeof this.auth.loginOption.tokenProvider){a.next=4;break}return a.abrupt("return",this.auth.token);case 4:return a.prev=4,a.next=7,this.auth.loginOption.tokenProvider(e);case 7:if("string"!=typeof(t=a.sent)){a.next=12;break}return a.abrupt("return",t);case 12:throw this.core.logger.error("V2NIMLoginService::excute tokenProvider complete but got Unexpected value:",t),new Sl({code:_l.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute tokenProvider complete but got Unexpected value",rawData:t}});case 14:a.next=23;break;case 16:throw a.prev=16,a.t0=a.catch(4),r=a.t0,n=r,r.code!==_l.V2NIM_ERROR_CODE_CALLBACK_FAILED&&(this.core.logger.error("V2NIMLoginService::excute tokenProvider error:",r),n=new Sl({code:_l.V2NIM_ERROR_CODE_CALLBACK_FAILED,desc:"Excute tokenProvider error",detail:{rawError:a.t0}})),this.processLoginFailed(r),n;case 23:case"end":return a.stop()}}),_callee2,this,[[4,16]])})))},e.refreshThirdPartyExt=function refreshThirdPartyExt(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:if("function"==typeof this.auth.loginOption.loginExtensionProvider){a.next=2;break}return a.abrupt("return","");case 2:return a.prev=2,a.next=5,this.auth.loginOption.loginExtensionProvider(e);case 5:if("string"!=typeof(t=a.sent)){a.next=10;break}return a.abrupt("return",t);case 10:throw this.core.logger.error("V2NIMLoginService::excute loginExtensionProvider complete but got Unexpected value:",t),new Sl({code:_l.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute loginExtensionProvider complete but got Unexpected value",rawData:t}});case 12:a.next=25;break;case 14:if(a.prev=14,a.t0=a.catch(2),r=a.t0,n=r,r.code!==_l.V2NIM_ERROR_CODE_CALLBACK_FAILED&&(this.core.logger.error("V2NIMLoginService::excute loginExtensionProvider error:",r),n=new Sl({code:_l.V2NIM_ERROR_CODE_CALLBACK_FAILED,detail:{reason:"Excute loginExtensionProvider error",rawError:a.t0}})),2!==this.auth.loginOption.authType){a.next=24;break}throw this.processLoginFailed(r),n;case 24:return a.abrupt("return","");case 25:case"end":return a.stop()}}),_callee3,this,[[2,14]])})))},e.processLoginFailed=function processLoginFailed(e){this.auth.clientSocket.doDisconnect(ip.ACTIVE,e),this.checkLoginTerminalCode(e.code)&&(this.auth.authenticator.reset(),this.auth.authenticator.clearLastLoginClient()),this.auth.lifeCycle.processEvent("loginFail",e)},e.changeLoginClient=function changeLoginClient(e,t){var r=this,n=map$6(t).call(t,(function(e){return formatLoginInfo(e)}));if(1===e)this.loginClients=n,this.auth.emit("onLoginClientChanged",e,this.loginClients);else if(2===e){var a=filter(n).call(n,(function(e){var t,n=filter(t=r.loginClients).call(t,(function(t){return t.clientId===e.clientId}));return r.loginClients.push(e),0===n.length}));a.length>0&&this.auth.emit("onLoginClientChanged",e,a)}else if(3===e){var i=filter(n).call(n,(function(e){var t;return function remove(e,t){t=t||function(){return!0};for(var r=[],n=(e=e||[]).length,a=0,i=0;i<n;i++)t(e[i-a])&&(r.push(splice(e).call(e,i-a,1)[0]),a+=1);return r}(r.loginClients,(function(t){return t.clientId===e.clientId&&t.consid===e.consid})),0===filter(t=r.loginClients).call(t,(function(t){return t.clientId===e.clientId})).length}));i.length>0&&this.auth.emit("onLoginClientChanged",e,i)}},e.checkAutoLogin=function checkAutoLogin(e){if(e)return!1;var t=ql.localStorage.getItem(this.lastLoginClientKey);if(!t)return!1;var r="",n="";try{var a=JSON.parse(t);r=get(a,"clientId"),n=get(a,"account")}catch(e){return!1}return r===this.auth.deviceId&&n===this.auth.account},e.checkLoginTerminalCode=function checkLoginTerminalCode(e){var t=[_l.V2NIM_ERROR_CODE_CANCELLED,_l.V2NIM_ERROR_CODE_TIMEOUT,_l.V2NIM_ERROR_CODE_HANDSHAKE,302,317,_l.V2NIM_ERROR_CODE_FORBIDDEN,_l.V2NIM_ERROR_CODE_NOT_FOUND,_l.V2NIM_ERROR_CODE_PARAMETER_ERROR,_l.V2NIM_ERROR_CODE_MULTI_LOGIN_FORBIDDEN,422,_l.V2NIM_ERROR_CODE_IM_DISABLED,_l.V2NIM_ERROR_CODE_APPKEY_NOT_EXIST,_l.V2NIM_ERROR_CODE_BUNDLEID_CHECK_FAILED,_l.V2NIM_ERROR_CODE_APPKEY_BLOCKED,_l.V2NIM_ERROR_CODE_INVALID_TOKEN,_l.V2NIM_ERROR_CODE_ROBOT_NOT_ALLOWED,_l.V2NIM_ERROR_CODE_ACCOUNT_NOT_EXIST,_l.V2NIM_ERROR_CODE_ACCOUNT_BANNED,_l.V2NIM_ERROR_CODE_USER_PROFILE_NOT_EXIST];return includes(t).call(t,e)},e.reset=function reset(){this.loginClients=[],this.loginClientOfThisConnection={}},e.clearLastLoginClient=function clearLastLoginClient(){ql.localStorage.removeItem(this.lastLoginClientKey)},V2NIMLoginAuthenticator}(),hp=function(){function V2NIMLoginLifeCycle(e){this.name="V2NIMLoginLifeCycle",this.loginStatus=0,this.connectStatus=0,this.core=e,this.auth=e.V2NIMLoginService,this.logger=e.logger}var e=V2NIMLoginLifeCycle.prototype;return e.processEvent=function processEvent(e,t,r){var n=this.getConnectStatus();switch(e){case"addressing":this.logger.log(this.name+"::addressing"),this.setLoginStatus(2),this.setConnectStatus(2);break;case"connect":this.logger.log(this.name+"::connecting"),this.setLoginStatus(2),this.setConnectStatus(2);break;case"connectSucc":this.logger.log(this.name+"::connect success"),this.setLoginStatus(2),this.setConnectStatus(1);break;case"connectFail":this.logger.log(this.name+"::connect fail",t),this.setLoginStatus(3),this.setConnectStatus(0,t);break;case"connectionBroken":this.logger.log(this.name+"::connectionBroken:",t),this.setLoginStatus(3),this.setConnectStatus(0,t),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleDisconnected",t);break;case"loginSucc":this.logger.log(this.name+"::login success, verify authentication success"),this.setLoginStatus(1),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleLoginSucc",r);break;case"loginFail":if(this.logger.log(this.name+"::login fail due to verify authentication failed:",t),!t)return;this.setLoginStatus(this.auth.authenticator.checkLoginTerminalCode(t.code)?0:3),this.setConnectStatus(0,t),this.auth.emit("onLoginFailed",t);break;case"logout":this.logger.log(this.name+"::logout"),this.setLoginStatus(0),this.setConnectStatus(0),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleLogout");break;case"kicked":this.logger.log(this.name+"::kicked",r),this.setLoginStatus(0),this.setConnectStatus(0,t),this.core.eventBus.emit("V2NIMLoginService/loginLifeCycleKicked");break;case"exited":this.logger.log(this.name+"::exited",t),this.setLoginStatus(0),this.setConnectStatus(0,t);break;case"waiting":this.logger.log(this.name+"::waiting to reconnect"),this.setLoginStatus(3),this.setConnectStatus(3),2!==n&&this.auth.reconnect.attempToReLogin()}},e.getConnectStatus=function getConnectStatus(){return this.connectStatus},e.getLoginStatus=function getLoginStatus(){return this.loginStatus},e.setLoginStatus=function setLoginStatus(e){e!==this.loginStatus&&(this.loginStatus=e,this.auth.emit("onLoginStatus",e))},e.setConnectStatus=function setConnectStatus(e,t){if(e!==this.connectStatus){var r=this.connectStatus;this.connectStatus=e,this.auth.emit("onConnectStatus",e),this.delegateConnectEvent(r,e,t)}},e.delegateConnectEvent=function delegateConnectEvent(e,t,r){1===e&&0===t&&r&&this.auth.emit("onDisconnected",r),2===e&&0===t&&r&&this.auth.emit("onConnectFailed",r)},V2NIMLoginLifeCycle}(),gp=function(){function V2NIMLoginDataSync(e){this.core=e,this.auth=e.V2NIMLoginService,this.datas=[],this.mainSyncFlag=!1,this.conversationSyncFlag=!1}var e=V2NIMLoginDataSync.prototype;return e.switchDataSync=function switchDataSync(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a,i,o,s;return Dl.wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:r=e.type,n=e.state,a=e.error,i=e.subType,1===r&&3===n&&("mainSync"===i?this.mainSyncFlag=!0:"conversationSync"===i&&(this.conversationSyncFlag=!0)),o=filter(t=this.datas).call(t,(function(e){return e.type===r})),(s=o.length>0?o[0]:null)?(s.state=n,s.error=a):this.datas.push({type:r,state:n,error:a}),1===r&&(2===n?this.auth.emit("onDataSync",r,n,a):3===n&&this.mainSyncFlag&&this.conversationSyncFlag&&(this.auth.emit("onDataSync",r,n,a),this.mainSyncFlag=!1,this.conversationSyncFlag=!1));case 6:case"end":return c.stop()}}),_callee,this)})))},e.reset=function reset(){this.datas=[],this.mainSyncFlag=!1,this.conversationSyncFlag=!1},V2NIMLoginDataSync}();function pick(e,t){e=e||{};var r={};return forEach$1(t=t||[]).call(t,(function(t){void 0!==e[t]&&(r[t]=e[t])})),r}var vp=["https://lbs.netease.im/lbs/webconf.jsp"],fp={retryCount:3,timeout:6e4,forceMode:!1,authType:0,syncLevel:0},yp=function(e){function V2NIMLoginServiceImpl(t,r){var n;void 0===r&&(r={}),(n=e.call(this,"V2NIMLoginService",t)||this).account="",n.previousLoginAccount="",n.token="",n.deviceId="",n.clientSession="",n.processId="",n.kickedDetail=null,n.binaryWebsocket=!0,n.core._registerDep(Ou,"misc"),registerParser({cmdMap:Vu,cmdConfig:qu}),"v2"===t.options.apiVersion&&(registerParser({cmdMap:Uu,cmdConfig:Bu}),n.core.auth=De(n)),n.previousLoginManager=new fd,n.doLoginStepsManager=new fd,n.loginTimerManager=new Pl,n.loginOption=Et({},fp),n.config={lbsUrls:vp,linkUrl:"weblink.netease.im:443"},n.setOptions(r),t.V2NIMLoginService=De(n);var a,i=n.core.options.binaryWebsocket,o="BROWSER"===ql.platform&&"function"==typeof TextDecoder&&"function"==typeof TextEncoder&&"function"==typeof Uint8Array;return"boolean"==typeof i&&(o=o&&i),o?(n.binaryWebsocket=!0,a=new lp(n.core)):(n.binaryWebsocket=!1,a=new dp(n.core)),n.clientSocket=a,"v2"===n.core.options.apiVersion&&(n.core.clientSocket=a),n.lifeCycle=new hp(t),n.reconnect=new up(t),n.lbs=new pp(t),n.authenticator=new mp(t),n.dataSync=new gp(t),n}_t(V2NIMLoginServiceImpl,e);var t=V2NIMLoginServiceImpl.prototype;return t.setOptions=function setOptions(e){validate({lbsUrls:{type:"array",itemType:"string",min:1,required:!1},linkUrl:{type:"string",allowEmpty:!1,required:!1}},e,"",!0),this.config=assignOptions(this.config,e);var t="",r="";this.config.isFixedDeviceId?(t=ql.localStorage.getItem("__NIM_DEVC_ID__")||ld(),r=ql.localStorage.getItem("__NIM_CLIENT_SESSION_ID__")||ld(),ql.localStorage.setItem("__NIM_DEVC_ID__",t),ql.localStorage.setItem("__NIM_CLIENT_SESSION_ID__",r)):(t=ld(),r=ld()),this.deviceId=t,this.clientSession=r,this.core.reporter.setConfig({common:{dev_id:t}})},t.reset=function reset(){this.account="",this.token="",this.processId="",this.lbs.reset(),this.reconnect.reset(),this.authenticator.reset(),this.authenticator.clearLastLoginClient(),this.dataSync.reset()},t.login=function login(e,t,r){return void 0===r&&(r={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){var n,a,i=this;return Dl.wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:if(this._checkApiVersion(),n=ql.getSystemInfo()||{},a=n.os?n.os.toLowerCase():"","React Native"!==ql.platform||"android"!==a||!this.hasSettingService||!this.core.V2NIMSettingService.offlinePushPlugin){o.next=13;break}return o.prev=4,o.next=7,this.core.V2NIMSettingService.getRNDeviceInfo();case 7:this.deviceInfo=o.sent,o.next=13;break;case 10:o.prev=10,o.t0=o.catch(4),this.logger.error(o.t0);case 13:if(e){o.next=15;break}throw new Cl({detail:{reason:"Empty account"}});case 15:if(validate({retryCount:{type:"number",min:0,required:!1},forceMode:{type:"boolean",required:!1},authType:{type:"enum",values:[0,1,2],required:!1},syncLevel:{type:"enum",values:[1,0],required:!1}},r,"",!0),0!==r.authType||t){o.next=18;break}throw new Cl({detail:{reason:"When authType is 0, token cannot be empty"}});case 18:if(""!==this.previousLoginAccount&&this.previousLoginAccount!==e&&this.core._clearModuleData(),0!==this.getLoginStatus()){o.next=23;break}this.logger.log("V2NIMLoginService::login:allowLogin:"+e,r),o.next=29;break;case 23:if(1!==this.getLoginStatus()){o.next=27;break}return o.abrupt("return",this.smoothForLogined(e,t,r));case 27:if(2!==this.getLoginStatus()){o.next=29;break}return o.abrupt("return",this.smoothForLogining(e,t,r));case 29:return this.account=e,this.previousLoginAccount=e,this.token=t,this.processId=ld(),this.loginOption=assignOptions(fp,r),this.kickedDetail=null,this.loginTimerManager.destroy(),this.loginTimerManager.addTimer((function(){var e=new Sl({code:_l.V2NIM_ERROR_CODE_TIMEOUT,detail:{reason:"Login API timeout"}});i.doLoginStepsManager.clear(e),i.previousLoginManager.clear(e),i.originLoginPromise=void 0,i.lifeCycle.processEvent("exited",e)}),this.loginOption.timeout>0?this.loginOption.timeout:6e4,1),o.prev=37,o.next=40,this.multiTryDoLogin();case 40:this.loginTimerManager.destroy(),o.next=47;break;case 43:throw o.prev=43,o.t1=o.catch(37),this.loginTimerManager.destroy(),o.t1;case 47:case"end":return o.stop()}}),_callee,this,[[4,10],[37,43]])})))},t.getChatroomLinkAddress=function getChatroomLinkAddress(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n;return Dl.wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return validate({roomId:{type:"string",regExp:/^\d+$/,required:!0,allowEmpty:!1},miniProgram:{type:"boolean",required:!1}},{roomId:e,miniProgram:t},"",!0),r="unknow environment"!==getMiniappEnv(),t=void 0===t?r:t,a.next=5,this.clientSocket.sendCmd("v2GetChatroomLinkAddress",{roomId:e,miniProgram:t});case 5:return n=a.sent,a.abrupt("return",n.content.linkAddress);case 7:case"end":return a.stop()}}),_callee2,this)})))},t.multiTryDoLogin=function multiTryDoLogin(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n,a;return Dl.wrap((function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:t=new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"loginFailed"}}),r=0;case 2:if(!(r<=this.loginOption.retryCount)){i.next=32;break}return n="V2NIMLoginService::times of login try: "+r,r>0?this.logger.warn(n):this.logger.log(n),i.prev=5,this.originLoginPromise=e||this.doLogin(!1),e=void 0,i.next=10,this.previousLoginManager.add(this.originLoginPromise);case 10:return a=i.sent,this.core.reporter.reportTraceEnd("login",!0),this.doLoginStepsManager.clear(),this.previousLoginManager.clear(),this.originLoginPromise=void 0,i.abrupt("return",a);case 18:if(i.prev=18,i.t0=i.catch(5),t=i.t0||t,this.logger.error("V2NIMLoginService::login failed, times of login try: "+r+", err.code: "+(null==t?void 0:t.code)+', err.message: "'+(null==t?void 0:t.message)+'"'),t.code!==_l.V2NIM_ERROR_CODE_CANCELLED&&this.core.reporter.reportTraceEnd("login",!1),this.reconnect.clearReconnectTimer(),!this.checkLoginTerminalCode(t&&t.code)){i.next=28;break}throw this.lifeCycle.processEvent("exited",t),t;case 28:t&&399===t.code&&this.lbs.reset();case 29:r++,i.next=2;break;case 32:throw this.lifeCycle.processEvent("exited",t),t;case 34:case"end":return i.stop()}}),_callee3,this,[[5,18]])})))},t.doLogin=function doLogin(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var n,a,i;return Dl.wrap((function _callee4$(o){for(;;)switch(o.prev=o.next){case 0:return n=!!e||this.authenticator.checkAutoLogin(this.loginOption.forceMode),this.core.reporter.reportTraceCancel("login"),this.core.reporter.reportTraceStart("login",n?{user_id:this.account,action:"auto_login",process_id:this.processId,binary_websocket:this.binaryWebsocket}:{user_id:this.account,action:"manual_login",process_id:this.processId,binary_websocket:this.binaryWebsocket}),this.core.reporter.reportTraceUpdateV2("login",{code:0,description:bn(this.loginOption),operation_type:"conf_init",succeed:!0,duration:0,target:""},{asyncParams:ql.net.getNetworkStatus()}),o.next=6,this.doLoginStepsManager.add(this.lbs.getLbsInfos());case 6:return a=o.sent,o.next=9,this.doLoginStepsManager.add(this.clientSocket.connect(a,e));case 9:return o.next=11,this.doLoginStepsManager.add(this.authenticator.verifyAuthentication(n));case 11:if(i=o.sent,this.lifeCycle.processEvent("loginSucc",void 0,Et(Et({},i),{isReconnect:e})),this.processId=ld(),this.clientSocket.resetSocketConfig(),this.reconnect.reset(),this.clientSocket.ping(),this.core.abtest.abtRequest(),"function"==typeof(null===(t=this.core.V2NIMClientAntispamUtil)||void 0===t?void 0:t.downloadLocalAntiSpamVocabs)&&this.core.V2NIMClientAntispamUtil.downloadLocalAntiSpamVocabs(),"function"!=typeof(null===(r=this.core.cloudStorage)||void 0===r?void 0:r.init)){o.next=28;break}return o.prev=20,o.next=23,this.core.cloudStorage.init();case 23:o.next=28;break;case 25:o.prev=25,o.t0=o.catch(20),this.logger.warn("doLogin::cloudStorage init error",o.t0);case 28:return o.abrupt("return",i);case 29:case"end":return o.stop()}}),_callee4,this,[[20,25]])})))},t.smoothForLogined=function smoothForLogined(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var n;return Dl.wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:if(n=this.checkIsSameLogin(e,t,r),this.logger.warn("V2NIMLoginService::smoothForLogined:Logined, isSameLogin "+n),!n){a.next=6;break}return a.abrupt("return");case 6:return a.next=8,this.logout();case 8:return a.abrupt("return",this.login(e,t,r));case 9:case"end":return a.stop()}}),_callee5,this)})))},t.smoothForLogining=function smoothForLogining(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var n;return Dl.wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:if(n=this.checkIsSameLogin(e,t,r),this.logger.warn("V2NIMLoginService::smoothForLogining:Logining progress exists, abort the previous login attempt and start next attempt, isSameLogin "+n),this.previousLoginManager.clear(),this.reconnect.reset(),this.account=e,this.previousLoginAccount=e,this.token=t,this.loginOption=assignOptions(this.loginOption,r),!n){a.next=18;break}if(this.originLoginPromise){a.next=11;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"NoPreviousLoginExists"}});case 11:return this.reconnect.reset(),a.next=14,Pi.resolve();case 14:return a.next=16,this.multiTryDoLogin(this.originLoginPromise);case 16:a.next=25;break;case 18:return this.doLoginStepsManager.clear(),this.clientSocket.doDisconnect(ip.ACTIVE,"Aborted"),this.reset(),this.lifeCycle.processEvent("logout"),a.next=24,Pi.resolve();case 24:return a.abrupt("return",this.login(e,t,r));case 25:case"end":return a.stop()}}),_callee6,this)})))},t.checkIsSameLogin=function checkIsSameLogin(e,t,r){return this.account===e&&this.loginOption.authType===r.authType&&(0!==r.authType||this.token===t)},t.logout=function logout(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var e,t;return Dl.wrap((function _callee7$(r){for(;;)switch(r.prev=r.next){case 0:this._checkApiVersion(),this.doLoginStepsManager.clear(),this.previousLoginManager.clear(),this.loginTimerManager.destroy(),this.originLoginPromise=void 0,e=this.getConnectStatus(),t=this.getLoginStatus(),r.t0=t,r.next=1===r.t0?10:2===r.t0?25:3===r.t0?29:0===r.t0?33:35;break;case 10:return r.prev=10,r.next=13,this.clientSocket.sendCmd("v2Logout",void 0,{timeout:1e3});case 13:this.clientSocket.doDisconnect(ip.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout"),r.next=24;break;case 18:r.prev=18,r.t1=r.catch(10),this.logger.error("Instance::disconnect sendCmd:logout error",r.t1),this.clientSocket.doDisconnect(ip.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout");case 24:return r.abrupt("break",37);case 25:case 29:return this.clientSocket.doDisconnect(ip.ACTIVE,"UserActiveDisconnect"),this.core._clearModuleData(),this.lifeCycle.processEvent("logout"),r.abrupt("break",37);case 33:throw this.core._clearModuleData(),new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:"Illegal logout. loginStatus "+t+". connectStatus "+e}});case 35:throw this.core._clearModuleData(),new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE,detail:{reason:"Illegal logout. illegal status: loginStatus "+t+". connectStatus "+e}});case 37:case"end":return r.stop()}}),_callee7,this,[[10,18]])})))},t.getConnectStatus=function getConnectStatus(){return this.lifeCycle.getConnectStatus()},t.getLoginStatus=function getLoginStatus(){return this.lifeCycle.getLoginStatus()},t.getLoginUser=function getLoginUser(){return this.account},t.getLoginClients=function getLoginClients(){var e;return map$6(e=function uniqBy(e,t){e=e||[],t=t||"";for(var r=[],n=[],a=0;a<e.length;a++){var i=e[a][t];-1===indexOf(n).call(n,i)&&(n.push(i),r.push(e[a]))}return r}(this.authenticator.loginClients,"clientId")).call(e,(function(e){return pick(e,["type","os","timestamp","customTag","customClientType","clientId","clientIP"])}))},t.getCurrentLoginClient=function getCurrentLoginClient(){var e;if(null===(e=this.authenticator.loginClientOfThisConnection)||void 0===e?void 0:e.clientId)return pick(this.authenticator.loginClientOfThisConnection,["type","os","timestamp","customTag","customClientType","clientId","clientIP"])},t.getDataSync=function getDataSync(){var e=this.dataSync.datas;return e&&e.length>0?map$6(e).call(e,(function(e){return{type:e.type,state:e.state}})):null},t.setReconnectDelayProvider=function setReconnectDelayProvider(e){this.reconnect._setReconnectDelayProvider(e)},t.kickOffline=function kickOffline(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t;return Dl.wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return this._checkApiVersion(),validate({clientId:{type:"string",allowEmpty:!1}},e,"",!0),r.next=4,this.clientSocket.sendCmd("v2KickOffline",{clientIds:[e.clientId]});case 4:if(t=r.sent,0!==get(t,"content.clientIds.length")){r.next=8;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_REQUEST_FAILED});case 8:case"end":return r.stop()}}),_callee8,this)})))},t.getKickedOfflineDetail=function getKickedOfflineDetail(){return this.kickedDetail},t.checkLoginTerminalCode=function checkLoginTerminalCode(e){return this.authenticator.checkLoginTerminalCode(e)},t.checkIllegalState=function checkIllegalState(){if(!this.getLoginUser())throw new Sl({code:_l.V2NIM_ERROR_CODE_ILLEGAL_STATE})},t._checkApiVersion=function _checkApiVersion(){if("v2"!==this.core.options.apiVersion)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:'apiVersion is not "v2"'}})},t.v2LoginHandler=function v2LoginHandler(e){if(e.error)throw this.clientSocket.doDisconnect(ip.ACTIVE,e.error),e.error;return e},t.v2LoginClientChangeHandler=function v2LoginClientChangeHandler(e){this.authenticator.changeLoginClient(bd(e.content.state),e.content.datas)},t.nimLoginClientChangeHandler=function nimLoginClientChangeHandler(e){this.authenticator.changeLoginClient(bd(e.content.state),e.content.datas)},t.qchatLoginClientChangeHandler=function qchatLoginClientChangeHandler(e){var t=bd(e.content.state);t=1===t?2:3,this.authenticator.changeLoginClient(t,[e.content.data])},t.v2BeKickedHandler=function v2BeKickedHandler(e){if(e.error)this.core.logger.error("v2BeKickedHandler error, ",e.error);else{var t=function formatBeKickedTag(e){return format({reason:{type:"number"},clientType:{type:"number"},customClientType:{type:"number"}},e)}(e.content);this.core.logger.warn("v2Bekicked::",t),this.kickedDetail=t,this.clientSocket.doDisconnect(ip.KICKED,t),this.core._clearModuleData(),this.lifeCycle.processEvent("kicked",new Sl({code:_l.V2NIM_ERROR_CODE_DISCONNECT,detail:{reason:"disconnect due to kicked"}}),t),this.emit("onKickedOffline",t)}},t.emit=function emit(t){for(var r,n,a=this.name+"::emit "+t.toString(),i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if("onLoginFailed"===t||"onDisconnected"===t||"onConnectFailed"===t){var c=o[0];this.logger.log(""+a,c.toString())}else if("onDataSync"===t){var l=o[2];this.logger.log(""+a,o[0],o[1],l&&l.toString())}else{var d,u;(d=this.logger).log.apply(d,concat(u=[""+a]).call(u,o))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,o))},Ue(V2NIMLoginServiceImpl,[{key:"hasSettingService",get:function get(){var e;return!!(null===(e=this.core.V2NIMSettingService)||void 0===e?void 0:e.name)}}]),V2NIMLoginServiceImpl}(Ru),_p=Di.entries;_export({target:"Object",stat:!0},{entries:function entries(e){return _p(e)}});var Mp=N.Object.entries,Ip=Math.floor,mergeSort=function(e,t){var r=e.length,n=Ip(r/2);return r<8?insertionSort(e,t):merge(e,mergeSort(arraySliceSimple(e,0,n),t),mergeSort(arraySliceSimple(e,n),t),t)},insertionSort=function(e,t){for(var r,n,a=e.length,i=1;i<a;){for(n=i,r=e[i];n&&t(e[n-1],r)>0;)e[n]=e[--n];n!==i++&&(e[n]=r)}return e},merge=function(e,t,r,n){for(var a=t.length,i=r.length,o=0,s=0;o<a||s<i;)e[o+s]=o<a&&s<i?n(t[o],r[s])<=0?t[o++]:r[s++]:o<a?t[o++]:r[s++];return e},Sp=mergeSort,Tp=O.match(/firefox\/(\d+)/i),Cp=!!Tp&&+Tp[1],bp=/MSIE|Trident/.test(O),Ep=O.match(/AppleWebKit\/(\d+)\./),Rp=!!Ep&&+Ep[1],kp=[],wp=g(kp.sort),Ap=g(kp.push),Np=fails((function(){kp.sort(void 0)})),xp=fails((function(){kp.sort(null)})),Op=arrayMethodIsStrict("sort"),Pp=!fails((function(){if(D)return D<70;if(!(Cp&&Cp>3)){if(bp)return!0;if(Rp)return Rp<603;var e,t,r,n,a="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:r=3;break;case 68:case 71:r=4;break;default:r=2}for(n=0;n<47;n++)kp.push({k:t+n,v:r})}for(kp.sort((function(e,t){return t.v-e.v})),n=0;n<kp.length;n++)t=kp[n].k.charAt(0),a.charAt(a.length-1)!==t&&(a+=t);return"DGBEFHACIJK"!==a}}));_export({target:"Array",proto:!0,forced:Np||!xp||!Op||!Pp},{sort:function sort(e){void 0!==e&&aCallable(e);var t=toObject(this);if(Pp)return void 0===e?wp(t):wp(t,e);var r,n,a=[],i=lengthOfArrayLike(t);for(n=0;n<i;n++)n in t&&Ap(a,t[n]);for(Sp(a,function(e){return function(t,r){return void 0===r?-1:void 0===t?1:void 0!==e?+e(t,r)||0:toString(t)>toString(r)?1:-1}}(e)),r=lengthOfArrayLike(a),n=0;n<r;)t[n]=a[n++];for(;n<i;)deletePropertyOrThrow(t,n++);return t}});var Lp=entryVirtual("Array").sort,Vp=Array.prototype,sort=function(e){var t=e.sort;return e===Vp||x(Vp,e)&&t===Vp.sort?Lp:t},Up=function(){function V2NIMConversationModelImpl(){this.map=new ic,this.readTimeMap=new ic}var e=V2NIMConversationModelImpl.prototype;return e.set=function set(e){var t=this;forEach$1(e).call(e,(function(e){e=t.processConversation(e),map$6(t).set(e.conversationId,e)}))},e.reset=function reset(){map$6(this).clear()},e.count=function count(){return map$6(this).size},e.sort=function sort$1(){var e,t=this,r=xl(values(e=map$6(this)).call(e));sort(r).call(r,(function(e,t){return t.sortOrder-e.sortOrder})),map$6(this).clear(),forEach$1(r).call(r,(function(e){map$6(t).set(e.conversationId,e)}))},e.processConversation=function processConversation(e){return"string"==typeof e.lastMessage&&delete e.lastMessage,void 0===e.localExtension&&(e.localExtension=""),e},e.getById=function getById(e){return map$6(this).get(e)},e.getAll=function getAll(){var e,t=xl(values(e=map$6(this)).call(e));return sort(t).call(t,(function(e,t){return t.sortOrder-e.sortOrder}))},e.getByOption=function getByOption(e,t,r){var n,a=r.conversationTypes,i=r.onlyUnread,o=r.conversationGroupIds,s=[];forEach$1(n=map$6(this)).call(n,(function(e){if((!(a&&a.length>0)||includes(a).call(a,e.type))&&(!i||e.unreadCount)&&(!r.ignoreMuted||!e.mute)){if(o){var t=e.groupIds,n=(null==t?void 0:t.length)||0;if(0===o.length&&n>0)return;if(o.length>0&&0===n)return;if(o.length>0&&n>0&&!some(o).call(o,(function(e){return t&&includes(t).call(t,e)})))return}s.push(e)}})),s=sort(s).call(s,(function(e,t){return t.sortOrder-e.sortOrder}));var c=0;e>0&&(c=findIndexWithinTargetValue(s,"sortOrder",e),s[c]&&s[c].sortOrder===e&&(c+=1));var l=slice(s).call(s,c).length;return(s=slice(s).call(s,c,c+t)).length>0?{offset:l>t?s[s.length-1].sortOrder:0,finished:!(l>t),conversationList:s}:{offset:0,finished:!0,conversationList:s}},e.upsert=function upsert(e){var t=e.conversationId,r=map$6(this).get(t);if(!r)return e=this.processConversation(Et({},e)),map$6(this).set(t,e),e.unreadCount>0;var n=e.unreadCount!==r.unreadCount,a=Et({},r,e);return a=this.processConversation(a),map$6(this).set(t,a),n},e.bulkUpsert=function bulkUpsert(e){var t=this,r=!1;return forEach$1(e).call(e,(function(e){t.upsert(e)&&(r=!0)})),r},e.deleteById=function deleteById(e){var t=this.getById(e);if(t)return map$6(this).delete(e),t},e.updateReadTime=function updateReadTime(e,t){this.readTimeMap.set(e,t)},e.getReadTime=function getReadTime(e){return this.readTimeMap.get(e)||0},V2NIMConversationModelImpl}(),Dp=g("".startsWith),qp=g("".slice),Bp=Math.min,Fp=correctIsRegexpLogic("startsWith");_export({target:"String",proto:!0,forced:!Fp},{startsWith:function startsWith(e){var t=toString(requireObjectCoercible(this));notARegexp(e);var r=toLength(Bp(arguments.length>1?arguments[1]:void 0,t.length)),n=toString(e);return Dp?Dp(t,n,r):qp(t,r,r+n.length)===n}});var Gp=entryVirtual("String").startsWith,Hp=String.prototype,startsWith=function(e){var t=e.startsWith;return"string"==typeof e||e===Hp||x(Hp,e)&&t===Hp.startsWith?Gp:t},jp=function(){function V2NIMConversationIdUtilImpl(e){this.name="V2NIMConversationIdUtil",this.core=e}var e=V2NIMConversationIdUtilImpl.prototype;return e.p2pConversationId=function p2pConversationId(e){return this.core.account+"|1|"+e},e.teamConversationId=function teamConversationId(e){return this.core.account+"|2|"+e},e.superTeamConversationId=function superTeamConversationId(e){return this.core.account+"|3|"+e},e.messageConversationId=function messageConversationId(e){return 1===e.conversationType?e.senderId===this.core.account?this.p2pConversationId(e.receiverId):this.p2pConversationId(e.senderId):2===e.conversationType?this.teamConversationId(e.receiverId):this.superTeamConversationId(e.receiverId)},e.parseConversationType=function parseConversationType(e){try{if(e&&startsWith(e).call(e,this.core.account+"|")){var t=e.replace(this.core.account+"|","");return Number(t[0])}return this.core.logger.warn("conversationId is not start with "+this.core.account),0}catch(e){return 0}},e.parseConversationTargetId=function parseConversationTargetId(e){try{if(e&&startsWith(e).call(e,this.core.account+"|")){var t=e.replace(this.core.account+"|","");return slice(t).call(t,2)}return this.core.logger.warn("conversationId is not start with "+this.core.account),""}catch(e){return""}},e.convertToV1ConversationId=function convertToV1ConversationId(e){var t=this.parseConversationType(e);return(1===t?"p2p":2===t?"team":"superTeam")+"|"+this.parseConversationTargetId(e)},V2NIMConversationIdUtilImpl}();function isEqual(e,t){var r=typeof e;if(r!==typeof t)return!1;if("object"===r){if(Object.prototype.toString.call(e)!==Object.prototype.toString.call(t))return!1;if(En(e)){if(e.length!==t.length)return!1;for(var n=0;n<e.length;n++)if(!isEqual(e[n],t[n]))return!1;return!0}if(e instanceof RegExp&&t instanceof RegExp)return e.toString()===t.toString();if(e instanceof Date&&t instanceof Date)return e.getTime()===t.getTime();if(null===e&&null===t)return!0;if(Nt(e).length!==Nt(t).length)return!1;for(var a in e)if(!isEqual(e[a],t[a]))return!1;return!0}return e===t}var $p={"31_1":"v2TeamCreate","32_1":"v2SuperTeamCreate","31_5":"v2TeamInviteMembers","32_5":"v2SuperTeamInviteMembers","31_6":"v2TeamKickMembers","32_6":"v2SuperTeamKickMembers","31_8":"v2TeamLeave","32_7":"v2SuperTeamLeave","31_7":"v2TeamUpdateInfo","32_8":"v2SuperTeamUpdateInfo","31_9":"v2TeamGetInfo","32_9":"v2SuperTeamGetInfo","31_12":"v2TeamDismiss","32_4":"v2SuperTeamDismiss","31_13":"v2TeamApplyToJoin","32_20":"v2SuperTeamApplyToJoin","31_14":"v2TeamAcceptJoinApplication","32_21":"v2SuperTeamAcceptJoinApplication","31_15":"v2TeamRejectJoinApplication","32_22":"v2SuperTeamRejectJoinApplication","31_16":"v2TeamAddManagers","32_26":"v2SuperTeamAddManagers","31_17":"v2TeamRemoveManagers","32_27":"v2SuperTeamRemoveManagers","31_18":"v2TeamTransferOwner","32_31":"v2SuperTeamTransferOwner","31_19":"v2TeamUpdateSelfMemberInfo","32_10":"v2SuperTeamUpdateSelfMemberInfo","31_20":"v2TeamUpdateMember","32_30":"v2SuperTeamUpdateMember","31_21":"v2TeamAcceptInvitation","32_23":"v2SuperTeamAcceptInvitation","31_22":"v2TeamRejectInvite","32_24":"v2SuperTeamRejectInvite","31_33":"v2TeamGetMemberInvitor","32_35":"v2SuperTeamGetMemberInvitor","31_25":"v2TeamMemberSetChatBannedStatus","32_29":"v2SuperTeamMemberSetChatBannedStatus","31_32":"v2TeamSetChatBannedMode","32_28":"v2SuperTeamSetChatBannedMode","31_34":"v2TeamGetByIds","32_36":"v2SuperTeamGetByIds","31_35":"v2TeamMemberGetListByIds","32_37":"v2SuperTeamMemberGetListByIds","31_36":"v2TeamMemberGetList","8_101":"v2TeamCreateMultiSync","8_109":"v2TeamSync","8_119":"v2TeamMemberUpdateMultiSync","8_126":"v2TeamMembersOfSelfInSync","21_101":"v2SuperTeamCreateMultiSync","21_109":"v2SuperTeamSync","21_110":"v2SuperTeamMemberUpdateMultiSync","21_111":"v2SuperTeamMembersOfSelfInSync"},zp={antispamBusinessId:1},Wp="V2NIMTeamService",Kp={teamId:1,name:3,teamType:{id:4,retConverter:function retConverter(e){return 0==+e?1:+e}},ownerAccountId:5,memberLimit:{id:6,retType:"number"},isValidTeam:{id:8,retConverter:function retConverter(e,t){return 1==+e&&(void 0===t[13]||1==+t[13])}},memberCount:{id:9,retType:"number"},memberUpdateTime:{id:10,retType:"number"},createTime:{id:11,retType:"number"},updateTime:{id:12,retType:"number"},intro:14,announcement:15,joinMode:{id:16,retType:"number"},serverExtension:18,customerExtension:19,avatar:20,agreeMode:{id:21,retType:"number"},inviteMode:{id:22,retType:"number"},updateInfoMode:{id:23,retType:"number"},updateExtensionMode:{id:24,retType:"number"},chatBannedMode:{id:101,retType:"number"}},Yp={teamId:1,accountId:3,memberRole:{id:4,retType:"number"},teamNick:5,bits:{id:7,retType:"number"},inTeam:{id:9,retType:"boolean"},joinTime:{id:10,retType:"number"},updateTime:{id:11,retType:"number"},serverExtension:12,chatBanned:{id:13,retType:"boolean"},invitorAccountId:14,followAccountIds:{id:16,retConverter:function retConverter(e){try{return JSON.parse(e)}catch(e){return[]}}}},Qp={teamId:1,accountId:3,memberRole:{id:4,retType:"number"},teamNick:5,bits:{id:7,retType:"number"},inTeam:{id:9,retType:"boolean"},updateTime:{id:11,retType:"number"},serverExtension:12,chatBanned:{id:13,retType:"boolean"},invitorAccountId:14,joinTime:{id:15,retType:"number"},followAccountIds:{id:17,retConverter:function retConverter(e){try{return JSON.parse(e)}catch(e){return[]}}}},Jp={accountIds:{id:1,converter:function converter(e){return bn(e)}},operation:2},Xp={v2TeamCreate:{sid:31,cid:1,service:Wp,params:[{type:"Property",name:"team",reflectMapper:Kp},{type:"StrArray",name:"inviteeAccountIds"},{type:"String",name:"postscript"},{type:"Property",name:"antispamConfig",reflectMapper:zp}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)},{type:"StrArray",name:"failedList"}]},v2SuperTeamCreate:{sid:32,cid:1,service:Wp,params:[{type:"Property",name:"team",reflectMapper:Kp},{type:"StrArray",name:"inviteeAccountIds"},{type:"String",name:"postscript"},{type:"Property",name:"antispamConfig",reflectMapper:zp}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)},{type:"StrArray",name:"failedList"}]},v2TeamInviteMembers:{sid:31,cid:5,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"Long",name:"time"},{type:"StrArray",name:"abortedAccidList"}]},v2SuperTeamInviteMembers:{sid:32,cid:5,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"StrArray",name:"abortedAccidList"},{type:"Long",name:"time"}]},v2TeamUpdateInfo:{sid:31,cid:7,service:Wp,params:[{type:"Property",name:"team",reflectMapper:Kp},{type:"Property",name:"antispamConfig",reflectMapper:zp}],response:[{type:"Long",name:"teamId"},{type:"Long",name:"timestamp"}]},v2SuperTeamUpdateInfo:{sid:32,cid:8,service:Wp,params:[{type:"Property",name:"team",reflectMapper:Kp},{type:"Property",name:"antispamConfig",reflectMapper:zp}],response:[{type:"Long",name:"timestamp"}]},v2TeamLeave:{sid:31,cid:8,service:Wp,params:[{type:"Long",name:"teamId"}]},v2SuperTeamLeave:{sid:32,cid:7,service:Wp,params:[{type:"Long",name:"teamId"}]},v2TeamGetInfo:{sid:31,cid:9,service:Wp,params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)}]},v2SuperTeamGetInfo:{sid:32,cid:9,service:Wp,params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)}]},v2TeamGetByIds:{sid:31,cid:34,service:Wp,params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:invertSerializeItem(Kp)},{type:"LongArray",name:"tids"}]},v2SuperTeamGetByIds:{sid:32,cid:36,service:Wp,params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:invertSerializeItem(Kp)},{type:"LongArray",name:"tids"}]},v2TeamDismiss:{sid:31,cid:12,service:Wp,params:[{type:"Long",name:"teamId"}]},v2SuperTeamDismiss:{sid:32,cid:4,service:Wp,params:[{type:"Long",name:"teamId"}]},v2TeamAcceptInvitation:{sid:31,cid:21,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)}]},v2SuperTeamAcceptInvitation:{sid:32,cid:23,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)}]},v2TeamRejectInvite:{sid:31,cid:22,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2SuperTeamRejectInvite:{sid:32,cid:24,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2TeamKickMembers:{sid:31,cid:6,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamKickMembers:{sid:32,cid:6,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamApplyToJoin:{sid:31,cid:13,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)},{type:"Int",name:"isInTeam"}]},v2SuperTeamApplyToJoin:{sid:32,cid:20,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:invertSerializeItem(Kp)},{type:"Int",name:"isInTeam"}]},v2TeamAcceptJoinApplication:{sid:31,cid:14,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},v2SuperTeamAcceptJoinApplication:{sid:32,cid:21,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},v2TeamRejectJoinApplication:{sid:31,cid:15,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2SuperTeamRejectJoinApplication:{sid:32,cid:22,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},v2TeamAddManagers:{sid:31,cid:16,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamAddManagers:{sid:32,cid:26,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamRemoveManagers:{sid:31,cid:17,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2SuperTeamRemoveManagers:{sid:32,cid:27,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},v2TeamTransferOwner:{sid:31,cid:18,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},v2SuperTeamTransferOwner:{sid:32,cid:31,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},v2TeamUpdateSelfMemberInfo:{sid:31,cid:19,service:Wp,params:[{type:"Property",name:"teamMember",reflectMapper:Yp},{type:"Property",name:"specialFollowUpdate",reflectMapper:Jp}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Yp)}]},v2SuperTeamUpdateSelfMemberInfo:{sid:32,cid:10,service:Wp,params:[{type:"Property",name:"teamMember",reflectMapper:Qp},{type:"Property",name:"specialFollowUpdate",reflectMapper:Jp}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Qp)}]},v2TeamUpdateMember:{sid:31,cid:20,service:Wp,params:[{type:"Property",name:"teamMember",reflectMapper:Yp}]},v2SuperTeamUpdateMember:{sid:32,cid:30,service:Wp,params:[{type:"Property",name:"teamMember",reflectMapper:Qp}]},v2TeamGetMemberInvitor:{sid:31,cid:33,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},v2SuperTeamGetMemberInvitor:{sid:32,cid:35,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},v2TeamMemberSetChatBannedStatus:{sid:31,cid:25,service:Wp,params:[{type:"Long",name:"teamId"},{type:"String",name:"accountId"},{type:"Int",name:"chatBanned"}]},v2SuperTeamMemberSetChatBannedStatus:{sid:32,cid:29,service:Wp,params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accountId"},{type:"Int",name:"chatBanned"}]},v2TeamSetChatBannedMode:{sid:31,cid:32,service:Wp,params:[{type:"Long",name:"teamId"},{type:"Int",name:"chatBannedMode"}]},v2SuperTeamSetChatBannedMode:{sid:32,cid:28,service:Wp,params:[{type:"Long",name:"teamId"},{type:"Int",name:"chatBannedMode"}]},v2TeamMemberGetListByIds:{sid:31,cid:35,service:Wp,params:[{type:"StrArray",name:"tag"}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Yp)}]},v2SuperTeamMemberGetListByIds:{sid:32,cid:37,service:Wp,params:[{type:"StrArray",name:"tag"}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Qp)}]},v2TeamMemberGetList:{sid:31,cid:36,service:Wp,params:[{type:"Property",name:"tag",reflectMapper:{teamId:1,teamType:2,roleQueryType:3,onlyChatBanned:{id:4,converter:function converter(e){return+e}},nextToken:5,limit:6,direction:7}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Yp)},{type:"Property",name:"pageInfo",reflectMapper:{1:"hasMore",2:"nextToken"}}]},v2TeamSync:{sid:8,cid:109,service:Wp,response:[{type:"Long",name:"timetag"},{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Kp)}]},v2TeamCreateMultiSync:{sid:8,cid:101,service:Wp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Kp)}]},v2TeamMemberUpdateMultiSync:{sid:8,cid:119,service:Wp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Yp)}]},v2TeamMembersOfSelfInSync:{sid:8,cid:126,service:Wp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Yp)},{type:"Long",name:"timetag"}]},v2SuperTeamSync:{sid:21,cid:109,service:Wp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Kp)},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},v2SuperTeamCreateMultiSync:{sid:21,cid:101,service:Wp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Kp)}]},v2SuperTeamMemberUpdateMultiSync:{sid:21,cid:110,service:Wp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Qp)}]},v2SuperTeamMembersOfSelfInSync:{sid:21,cid:111,service:Wp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(Qp)},{type:"Long",name:"timetag"}]}};function formatTeamNotificationAttachData(e,t){if(!e)return{};var r=e;return r.tinfo&&(r.tinfo=function formatTeamFromTinfo(e){return deserialize(e,invertSerializeItem(Kp))}(r.tinfo),r.tinfo.teamType=t),r.uinfos,void 0!==r.mute&&(r.mute=bd(r.mute)),r}function generateTeamByTeamId(e,t,r){return void 0===r&&(r={}),Et({teamId:e,teamType:t,name:"",ownerAccountId:"",memberLimit:0,memberCount:0,createTime:0,updateTime:0,intro:"",announcement:"",avatar:"",joinMode:0,agreeMode:0,inviteMode:0,updateInfoMode:0,updateExtensionMode:0,chatBannedMode:0,isValidTeam:!0},r)}function generateMemberByTeamId(e,t,r,n){return void 0===n&&(n={}),Et({teamId:e,teamType:t,accountId:r,joinTime:0,inTeam:!0,memberRole:0,chatBanned:!1},n)}function processTeamMembers(e,t){return void 0===t&&(t=1),map$6(e).call(e,(function(e){return function processTeamMember(e,t){return void 0===t&&(t=1),e.teamType=t,e.chatBanned=void 0!==e.chatBanned&&e.chatBanned,e}(e,t)}))}function completeMessage(e,t){var r,n=Et(Et({},t),{conversationId:e.V2NIMConversationIdUtil.messageConversationId(t),isSelf:t.senderId===e.account,sendingState:1,messageStatus:{errorCode:(null===(r=null==t?void 0:t.messageStatus)||void 0===r?void 0:r.errorCode)||200}});return n.threadReply&&(n.threadReply=Et(Et({},n.threadReply),{conversationType:n.conversationType,conversationId:n.conversationId})),n.threadRoot&&(n.threadRoot=Et(Et({},n.threadRoot),{conversationType:n.conversationType,conversationId:n.conversationId})),n}function completeMessageRefer(e,t){return Et(Et({},t),{conversationId:e.V2NIMConversationIdUtil.messageConversationId(t)})}function formatMessageRefer(e,t){var r=t.createTime,n=t.senderId,a=t.receiverId,i=t.conversationType;return{conversationType:i,conversationId:e.V2NIMConversationIdUtil.messageConversationId({conversationType:i,senderId:n,receiverId:a}),senderId:t.senderId,receiverId:t.receiverId,messageServerId:t.messageServerId,createTime:r,messageClientId:t.messageClientId}}function formatRevokeMessage(e,t){var r={7:1,8:2,12:3,13:1,14:2}[t.sysMsgType];return{postscript:t.postscript,revokeType:{7:1,8:2,12:3,13:4,14:5}[t.sysMsgType]||0,revokeAccountId:t.opeAccount||t.senderId,callbackExtension:t.callbackExtension,serverExtension:t.attach||"",messageRefer:{conversationType:r,conversationId:e.V2NIMConversationIdUtil.messageConversationId(Et(Et({},t),{conversationType:r,senderId:t.senderId,receiverId:t.receiverId})),senderId:t.senderId,receiverId:t.receiverId,messageServerId:t.messageServerId,createTime:t.deleteMsgCreatetime,messageClientId:t.messageClientId}}}function formatClearHistoryNotification(e,t){return{conversationId:1===t.conversationType?e.V2NIMConversationIdUtil.p2pConversationId(t.receiverId):2===t.conversationType?e.V2NIMConversationIdUtil.teamConversationId(t.teamId):e.V2NIMConversationIdUtil.superTeamConversationId(t.teamId),deleteTime:t.deleteTime,serverExtension:t.serverExtension}}function convertNotificationType(e,t){var r={0:0,401:401,1:1,402:402,2:2,403:403,3:3,404:404,4:4,405:405,5:5,410:410,6:6,406:406,7:7,407:407,8:8,408:408,9:9,411:411,10:10,409:409};return void 0===r[t]&&e.logger.warn("[V2NIMMessageService] undefined notification type: "+t),"number"==typeof r[t]?r[t]:-1}function formatMessageAttachment(e,t){return 5===e.messageType?function formatNotificationMessage(e,t){var r,n,a,i,o,s=t.attachment||{};if(t.attachment&&"type"in t.attachment)return t;var c=void 0;if(null===(r=s.data)||void 0===r?void 0:r.tinfo){var l=s.id,d=s.data,u=l>400?2:1,p=formatTeamNotificationAttachData(Et({},d),u).tinfo;c={},p.teamId,c=__rest(p,["teamId"])}var m=Et(Et(Et(Et({raw:s.raw,type:convertNotificationType(e,s.id)},c?{updatedTeamInfo:c}:{}),{targetIds:(null===(n=s.data)||void 0===n?void 0:n.ids)||((null===(a=s.data)||void 0===a?void 0:a.id)?[s.data.id]:[])}),"string"==typeof(null===(i=s.data)||void 0===i?void 0:i.attach)?{serverExtension:s.data.attach}:{}),"number"==typeof(null===(o=s.data)||void 0===o?void 0:o.mute)?{chatBanned:0!==s.data.mute}:{});return Et(Et({},t),{attachment:m})}(t,e):100===e.messageType?function formatCustomMessage(e,t){var r,n,a;if("string"==typeof(null===(r=t.attachment)||void 0===r?void 0:r.raw)&&(null===(a=null===(n=e.V2NIMMessageService)||void 0===n?void 0:n.customAttachmentParsers)||void 0===a?void 0:a.length)>0){var i=t.subType||0,o=e.V2NIMMessageService.customAttachmentParsers,s=t.attachment.raw;some(o).call(o,(function(r){try{var n=r(i,s);if(isPlainObject(n))return n.raw=s,t.attachment=n,!0}catch(t){return e.logger.warn("customAttachmentParser: subType "+i+", raw: "+s+". parse error with "+t),!1}return!1}))}return t}(t,e):e}function attachmentToRaw(e,t){if(!t)return"";switch(e){case 100:return t.raw||"";case 1:case 3:case 2:case 6:return function mediaAttachmentToRaw(e){var t=e,r=t.width,n=t.height,a=t.duration;t.path,t.file,t.raw,t.ctx,t.payload,t.bucketName,t.objectName,t.token;var i=t.ext,o=__rest(t,["width","height","duration","path","file","raw","ctx","payload","bucketName","objectName","token","ext"]),s="string"==typeof i&&"."===i[0]?slice(i).call(i,1):i;return bn(Et(Et(Et(Et(Et({},o),void 0===i?{}:{ext:s}),void 0===r?{}:{w:r}),void 0===n?{}:{h:n}),void 0===a?{}:{dur:a}))}(t);case 4:return function locationAttachmentToRaw(e){return bn({lat:e.latitude,lng:e.longitude,title:e.address})}(t);case 12:return function callAttachmentToRaw(e){e.raw;var t=__rest(e,["raw"]);try{var r;return bn(Et(Et({},t),{durations:map$6(r=e.durations).call(r,(function(e){return{accid:e.accountId,duration:e.duration}}))}))}catch(t){return bn(e)}}(t);default:return t.raw||bn(t)}}function rawToAttachment(e,t){var r;try{switch(r=JSON.parse(e),t){case 100:return{raw:e};case 4:return function locationRawToAttachment(e,t){return{latitude:t.lat,longitude:t.lng,address:t.title,raw:e}}(e,r);case 2:case 3:case 1:case 6:return function mediaRawToAttachment(e,t){var r=t.w,n=t.h,a=t.dur,i=t.ext,o=__rest(t,["w","h","dur","ext"]),s="string"==typeof i&&"."!==i[0]?"."+i:i;return Et(Et(Et(Et(Et(Et({},o),void 0===i?{}:{ext:s}),void 0===r?{}:{width:r}),void 0===n?{}:{height:n}),void 0===a?{}:{duration:a}),{raw:e})}(e,r);case 12:return function callRawToAttachment(e,t){var r;return Et(Et({},t),{durations:map$6(r=t.durations).call(r,(function(e){return{accountId:e.accid,duration:e.duration}})),raw:e})}(e,r);default:return"object"==typeof r&&r?Et(Et({},r),{raw:e}):{raw:e}}}catch(t){return"object"==typeof r&&r?Et(Et({},r),{raw:e}):{raw:e}}}var Zp="V2NIMMessageService",em={"30_1":"v2SendP2pMessage","31_2":"v2SendTeamMessage","30_31":"v2MessageP2pModify","31_37":"v2MessageTeamModify","32_38":"v2MessageSuperTeamModify","7_33":"v2MessageOnModified","4_27":"v2MessageSyncModified","4_28":"v2MessageSuperTeamSyncModified","4_5":"v2BatchMarkRead","4_12":"syncP2PMessagReceipts","30_11":"v2SendP2PMessageReceipt","31_28":"v2SendTeamMessageReceipts","32_2":"v2SendSuperTeamMessage","7_12":"onP2PMessageReceipts","8_31":"onTeamMessageReceipts","31_29":"v2GetTeamMessageReceipts","31_30":"v2GetTeamMessageReceiptDetail","7_2":"onMsg","8_3":"onMsg","7_101":"onMsg","8_102":"onMsg","21_3":"onMsg","21_102":"onMsg","4_4":"syncOfflineMsgs","4_9":"syncRoamingMsgs","4_17":"syncRoamingMsgs","30_13":"v2RevokeMessage","32_17":"v2RevokeSuperTeamMessage","7_14":"onRevokeMessage","7_15":"syncRevokeMessage","21_18":"onRevokeMessage","21_117":"onRevokeMessage","30_23":"v2DeleteMessage","30_24":"v2DeleteMessages","4_21":"syncOnDeleteMessages","7_123":"onDeleteMessage","7_124":"onDeleteMessages","29_17":"v2DownloadLocalAntiSpamVocabs"},tm={conversationType:{id:0,converter:conversationTypeV2ToV1,retConverter:conversationTypeV1ToV2},receiverId:1,senderId:2,fromClientType:4,fromDeviceId:5,fromNick:6,createTime:{id:7,retType:"number"},messageType:{id:8,retType:"number"},text:9,attachment:{id:10,converter:function converter(e,t){return attachmentToRaw(t.messageType,e)},retConverter:function retConverter(e,t){return rawToAttachment(e,Number(t[8]))}},messageClientId:11,messageServerId:12,resend:{id:13,converter:boolToInt,retType:"boolean"},userUpdateTime:{id:14,retType:"number"},serverExtension:15,pushPayload:{id:16,access:"pushConfig.pushPayload"},pushContent:{id:17,access:"pushConfig.pushContent"},forcePushAccountIds:{id:18,access:"pushConfig.forcePushAccountIds",def:function def(e){if(e["pushConfig.forcePush"])return"#%@all@%#"},converter:function converter(e,t){if(t["pushConfig.forcePush"]){if(0===e.length)return"#%@all@%#";try{return bn(e)}catch(e){return"#%@all@%#"}}},retConverter:function retConverter(e){if("#%@all@%#"===e)return e;if(e)try{return JSON.parse(e)}catch(e){return[]}}},forcePushContent:{id:19,access:"pushConfig.forcePushContent"},forcePush:{id:20,access:"pushConfig.forcePush",converter:boolToInt,retType:"boolean"},antispamCustomMessageEnabled:{id:21,def:function def(e){return get(e,"antispamConfig.antispamCustomMessage")?1:void 0},retConverter:function retConverter(){}},antispamCustomMessage:{id:22,access:"antispamConfig.antispamCustomMessage"},antispamBusinessId:{id:23,access:"antispamConfig.antispamBusinessId"},clientAntispamHit:{id:24,access:"clientAntispamHit",converter:boolToInt,retType:"boolean"},antispamEnabled:{id:25,access:"antispamConfig.antispamEnabled",converter:boolToInt,retType:"boolean"},needAck:{id:26,access:"messageConfig.readReceiptEnabled",converter:boolToInt,retType:"boolean"},lastMessageUpdateEnabled:{id:28,access:"messageConfig.lastMessageUpdateEnabled",converter:boolToInt,retType:"boolean"},threadReplySenderId:{id:29,access:"threadReply.senderId"},threadReplyReceiverId:{id:30,access:"threadReply.receiverId"},threadReplyTime:{id:31,access:"threadReply.createTime",retType:"number"},threadReplyServerId:{id:32,access:"threadReply.messageServerId"},threadReplyClientId:{id:33,access:"threadReply.messageClientId"},threadRootSenderId:{id:34,access:"threadRoot.senderId"},threadRootReceiverId:{id:35,access:"threadRoot.receiverId"},threadRootTime:{id:36,access:"threadRoot.createTime",retType:"number"},threadRootServerId:{id:37,access:"threadRoot.messageServerId"},threadRootClientId:{id:38,access:"threadRoot.messageClientId"},callbackExtension:40,subType:{id:41,retType:"number"},antispamCheating:{id:42,access:"antispamConfig.antispamCheating"},routeEnvironment:{id:43,access:"routeConfig.routeEnvironment"},antispamExtension:{id:44,access:"antispamConfig.antispamExtension"},antispamResult:45,__clientExt:{id:46,converter:objectToJSONString,retConverter:stringToJSONObject},robotFunction:{id:47,access:"robotConfig.function"},robotTopic:{id:48,access:"robotConfig.topic"},robotCustomContent:{id:49,access:"robotConfig.customContent"},robotAccount:{id:50,access:"robotConfig.accountId"},_conversationOnlineSyncNotify:{id:51},_conversationOnlineSyncData:{id:52},aiAgentMsgDirection:{id:55,access:"aiConfig.aiStatus",retAccess:"aiConfig.aiStatus",retType:"number"},aiAgentAccount:{id:56,access:"aiConfig.accountId",retAccess:"aiConfig.accountId"},aiAgentContent:{id:57,access:"aiConfig.content",converter:objectToJSONString,retConverter:emptyFunc},aiAgentMessages:{id:58,access:"aiConfig.messages",converter:objectToJSONString,retConverter:emptyFunc},aiAgentPromptVariables:{id:59,access:"aiConfig.promptVariables",retConverter:emptyFunc},aiAgentModelConfigParams:{id:60,access:"aiConfig.modelConfigParams",converter:objectToJSONString,retConverter:emptyFunc},errorCode:{id:61,access:"messageStatus.errorCode",retType:"number"},modifyTime:{id:62,retType:"number"},modifyAccountId:63,historyEnabled:{id:100,access:"messageConfig.historyEnabled",converter:boolToInt,retType:"boolean"},roamingEnabled:{id:101,access:"messageConfig.roamingEnabled",converter:boolToInt,retType:"boolean"},onlineSyncEnabled:{id:102,access:"messageConfig.onlineSyncEnabled",converter:boolToInt,retType:"boolean"},routeEnabled:{id:105,access:"routeConfig.routeEnabled",converter:boolToInt,retType:"boolean"},pushEnable:{id:107,access:"pushConfig.pushEnabled",converter:boolToInt,retType:"boolean"},offlineEnabled:{id:108,access:"messageConfig.offlineEnabled",converter:boolToInt,retType:"boolean"},unreadEnabled:{id:109,access:"messageConfig.unreadEnabled",converter:boolToInt,retType:"boolean"},pushNickEnabled:{id:110,access:"pushConfig.pushNickEnabled",converter:boolToInt,retType:"boolean"},msgAckSnapshot:{id:112,retType:"number"},receiverIds:{id:154,access:"targetConfig.receiverIds",converter:objectToJSONString,retConverter:function retConverter(){}},inclusive:{id:155,access:"targetConfig.inclusive",converter:function converter(e){return e?1:2},retConverter:function retConverter(){}},newMemberVisible:{id:156,access:"targetConfig.newMemberVisible",converter:function converter(e){return e?1:2},retConverter:function retConverter(){}}},rm=invertSerializeItem(tm),nm={conversationType:{id:1,access:"messageRefer.conversationType",retType:"number"},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},messageServerId:{id:4,access:"messageRefer.messageServerId"},messageClientId:{id:5,access:"messageRefer.messageClientId"},createTime:{id:6,access:"messageRefer.createTime",retType:"number"},deleteTime:{id:7,retType:"number"},serverExtension:8};invertSerializeItem(nm);var am={version:1,md5:2,nosurl:3,thesaurus:4},im={createTime:{id:0,retType:"number"},sysMsgType:1,receiverId:2,senderId:3,postscript:4,attach:5,pushContent:8,pushPayload:9,messageClientId:10,messageServerId:11,deleteMsgCreatetime:{id:14,retType:"number"},opeAccount:16,env:21,callbackExtension:22},om={receiverId:0,messageServerId:1,readCount:{id:100,retType:"number"},unreadCount:{id:101,retType:"number"},messageClientId:102,latestReadAccount:103},sm={v2BatchMarkRead:{sid:4,cid:5,service:Zp,hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},v2SendP2pMessage:{sid:30,cid:1,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},onMsg:{sid:7,cid:2,service:Zp,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(tm)}]},syncOfflineMsgs:{sid:4,cid:4,service:Zp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(tm)}]},syncRoamingMsgs:{sid:4,cid:9,service:Zp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(tm)}]},v2SendP2PMessageReceipt:{sid:30,cid:11,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2RevokeMessage:{sid:30,cid:13,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:im}]},v2DeleteMessage:{sid:30,cid:23,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:nm}],response:[{type:"Long",name:"timetag"}]},v2DeleteMessages:{sid:30,cid:24,service:Zp,params:[{type:"PropertyArray",name:"tag",reflectMapper:nm}],response:[{type:"Long",name:"timetag"}]},v2SendTeamMessage:{sid:31,cid:2,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2SendTeamMessageReceipts:{sid:31,cid:28,service:Zp,params:[{type:"PropertyArray",name:"tag",reflectMapper:om}],response:[{type:"PropertyArray",name:"tag",reflectMapper:invertSerializeItem(om)}]},v2SendSuperTeamMessage:{sid:32,cid:2,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2RevokeSuperTeamMessage:{sid:32,cid:17,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:im}]},syncP2PMessagReceipts:{sid:4,cid:12,service:Zp,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(tm)}]},onP2PMessageReceipts:{sid:7,cid:12,service:Zp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2GetTeamMessageReceipts:{sid:31,cid:29,service:Zp,params:[{type:"PropertyArray",name:"tag",reflectMapper:om}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(om)}]},v2GetTeamMessageReceiptDetail:{sid:31,cid:30,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:om,select:["receiverId","messageServerId"]}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(om)},{type:"StrArray",name:"readAccountList"},{type:"StrArray",name:"unreadAccountList"}]},onTeamMessageReceipts:{sid:8,cid:31,service:Zp,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(om)}]},onRevokeMessage:{sid:7,cid:14,service:Zp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(im)}]},syncRevokeMessage:{sid:7,cid:15,service:Zp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(im)}]},syncOnDeleteMessages:{sid:4,cid:21,service:Zp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(nm)}]},onDeleteMessage:{sid:7,cid:123,service:Zp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nm)}]},onDeleteMessages:{sid:7,cid:124,service:Zp,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(nm)}]},v2DownloadLocalAntiSpamVocabs:{sid:29,cid:17,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:am}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(am)}]},v2MessageP2pModify:{sid:30,cid:31,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2MessageTeamModify:{sid:31,cid:37,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2MessageSuperTeamModify:{sid:32,cid:38,service:Zp,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2MessageOnModified:{sid:7,cid:33,service:Zp,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2MessageSyncModified:{sid:4,cid:27,service:Zp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(tm)},{type:"Long",name:"time"}]},v2MessageSuperTeamSyncModified:{sid:4,cid:28,service:Zp,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(tm)},{type:"Long",name:"time"}]}};function conversationTypeV2ToV1(e){return 1===e?0:2===e?1:3===e?5:void 0}function conversationTypeV1ToV2(e){var t=bd(e);return 0===t?1:1===t?2:5===t?3:0}var cm,lm={type:{type:"number"},lastMessageState:{type:"number"},unreadCount:{type:"number"},stickTop:{type:"boolean"},sortOrder:{type:"number"},version:{type:"number"},deleteFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}};function formatConversationFields(e,t){return t&&t.length>0?map$6(t).call(t,(function(t){return formatConversationField(e,t)})):[]}function formatLastMessageFromMessage(e,t,r,n){var a,i;void 0===r&&(r=0);var o=t=formatMessageAttachment(t,e),s=o.messageType,c=o.subType,l=o.text,d=o.attachment,u=o.serverExtension,p="";if(t.senderId!==e.account){p=get(t,"fromNick");var m=null===(i=null===(a=e.V2NIMFriendService)||void 0===a?void 0:a.model)||void 0===i?void 0:i.getFriend(t.senderId);m&&m.alias&&(p=m.alias)}return JSON.parse(bn({lastMessageState:r,messageRefer:formatMessageRefer(e,t),messageType:s,subType:c,text:l,attachment:d,serverExtension:u,callbackExtension:t.callbackExtension,sendingState:n,senderName:p}))}function formatConversationField(e,t){var r=format(lm,t);if(r.groupIds?r.groupIds=JSON.parse(r.groupIds):delete r.groupIds,"string"==typeof r.lastMessage)if(""===r.lastMessage);else if(1===r.lastMessageState){var n=formatRevokeMessage(e,deserialize(JSON.parse(r.lastMessage),invertSerializeItem(im)));r.lastMessage=function formatLastMessageFromNotification(e,t){var r=t.messageRefer,n=t.revokeAccountId,a=t.revokeType,i=t.callbackExtension,o=t.serverExtension,s=t.postscript,c=function calcSenderNameFromNotification(e,t,r,n){var a,i,o,s,c,l,d,u;if(t!==e.account){var p=null===(i=null===(a=e.V2NIMFriendService)||void 0===a?void 0:a.model)||void 0===i?void 0:i.getFriend(t);if(p&&p.alias)return p.alias;if(2===r){var m=null===(s=null===(o=e.V2NIMTeamService)||void 0===o?void 0:o.memberModel)||void 0===s?void 0:s.getById(n,1,t);if(m&&m.teamNick)return m.teamNick}else if(3===r){var h=null===(l=null===(c=e.V2NIMTeamService)||void 0===c?void 0:c.memberModel)||void 0===l?void 0:l.getById(n,1,t);if(h&&h.teamNick)return h.teamNick}var g=null===(u=null===(d=e.V2NIMUserService)||void 0===d?void 0:d.model)||void 0===u?void 0:u.getUser(t);return g&&g.name?g.name:void 0}}(e,t.revokeAccountId,t.messageRefer.conversationType,t.messageRefer.receiverId)||"";return JSON.parse(bn({lastMessageState:1,messageRefer:r,revokeAccountId:n,revokeType:a,callbackExtension:i,serverExtension:o,text:s||"",senderName:c}))}(e,n)}else if(0===r.lastMessageState){var a=deserialize(JSON.parse(r.lastMessage),invertSerializeItem(tm));r.lastMessage=formatLastMessageFromMessage(e,a,r.lastMessageState,a.senderId===e.account?1:void 0)}else 2===r.lastMessageState&&delete r.lastMessage;return r}function formatConversationByField(e){var t=e.version,r=e.deleteFlag;return{conversation:__rest(e,["version","deleteFlag"]),version:t,deleteFlag:r}}!function(e){e[e.createConversation=1]="createConversation",e[e.deleteConversation=2]="deleteConversation",e[e.updateConversation=3]="updateConversation",e[e.setConversationTop=4]="setConversationTop",e[e.clearConversationUnread=5]="clearConversationUnread",e[e.addConversationToGroup=6]="addConversationToGroup",e[e.removeConversationFromGroup=7]="removeConversationFromGroup",e[e.modifyConversationOnSendMessage=8]="modifyConversationOnSendMessage",e[e.modifyConversationOnDeleteMessage=9]="modifyConversationOnDeleteMessage",e[e.modifyConversationOnRecallMessage=10]="modifyConversationOnRecallMessage",e[e.modifyConversationOnClearMessage=11]="modifyConversationOnClearMessage",e[e.oneClickClearConversationUnread=12]="oneClickClearConversationUnread",e[e.modifyConversationOnUpdateMessage=13]="modifyConversationOnUpdateMessage"}(cm||(cm={}));var dm={type:{type:"number"},oneClickClearUnreadType:{type:"number"},oneClickClearUnreadConversationType:{type:"object"},oneClickClearUnreadVersion:{type:"number"},deleteConversationClearMessage:{type:"boolean"}};function formatConversationNotify(e){return format(dm,e)}var um=function(){function V2NIMConversationVersionCacheImpl(e,t){this.fieldVersion={},this.conversationIdsForBackFill={},this.tempPacket=[],this.isSyncing=!1,this.nextCursor=0,this.core=e,this.service=t}var e=V2NIMConversationVersionCacheImpl.prototype;return e.reset=function reset(){this.tempPacket=[],this.fieldVersion={},this.conversationIdsForBackFill={},this.isSyncing=!1,this.nextCursor=0},e.doSync=function doSync(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e,t,r,n;return Dl.wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return this.isSyncing=!0,this.service.emit("onSyncStarted"),a.prev=2,a.next=5,this.core.sendCmd("v2ConversationSync",{tag:{cursor:this.nextCursor}});case 5:e=a.sent,a.next=18;break;case 8:if(a.prev=8,a.t0=a.catch(2),(t=a.t0).code!==_l.V2NIM_ERROR_CODE_CANCELLED){a.next=13;break}return a.abrupt("return");case 13:return this.isSyncing=!1,this.service.emit("onSyncFailed",t),this.core.V2NIMLoginService.dataSync.switchDataSync({type:1,state:3,error:t,subType:"conversationSync"}),this.processTempPacket(),a.abrupt("return");case 18:r=0===bd(get(e,"content.info.syncType")),n=get(e,"content.info.nextCursor"),this.doSyncAndSuccess(r,n);case 21:case"end":return a.stop()}}),_callee,this,[[2,8]])})))},e.doSyncAndSuccess=function doSyncAndSuccess(e,t){var r;e&&sort(r=this.service.model).call(r);this.isSyncing=!1,this.nextCursor=bd(t)||0,this.service.unread.resetTotalAfterSyncDone(),this.service.unread.digestUnreadCountChange(),this.service.emit("onSyncFinished"),this.core.V2NIMLoginService.dataSync.switchDataSync({type:1,state:3,subType:"conversationSync"}),this.processTempPacket()},e.setBackFillIds=function setBackFillIds(e){var t=this;return forEach$1(e).call(e,(function(e){if(2===e.lastMessageState&&t.service.hasMessageService){t.conversationIdsForBackFill[e.conversationId]=!0;var r=t.core.V2NIMMessageService.model.getLastMessageOfConversation(e.conversationId);e.lastMessage=r?formatLastMessageFromMessage(t.core,r,e.lastMessageState,r.sendingState):""}else t.conversationIdsForBackFill[e.conversationId]=!1;delete e.lastMessageState})),e},e.recvConversationFromSyncAction=function recvConversationFromSyncAction(e){var t=this,r=get(e,"content.info").syncType,n=formatConversationFields(this.core,get(e,"content.datas"));0===(r=bd(r))?(forEach$1(n).call(n,(function(e){t.initFieldVersion(e.conversationId,e.version)})),n=this.setBackFillIds(n),this.setModel(n)):(n=this.setBackFillIds(n),this.recvConversationForCreated(n)<n.length&&this.recvConversationForChanged(n))},e.recvConversation=function recvConversation(e){var t=this;if(this.isSyncing)this.tempPacket.push(e);else{var r=formatConversationFields(this.core,get(e,"content.datas")),n=filter(r).call(r,(function(e){return!!e.conversationId})),a=formatConversationNotify(get(e,"content.info")),i=map$6(n).call(n,(function(e){return"id:"+e.conversationId+", ver:"+e.version})).join(";");if(this.core.logger.getDebugMode()?this.core.logger.debug("V2NIMConversation::recvConversation: "+i+".",a,n):this.core.logger.log("V2NIMConversation::recvConversation: "+i+".",a),2===a.type){var o=map$6(n).call(n,(function(e){return delete t.fieldVersion[e.conversationId],t.service.model.deleteById(e.conversationId),e.conversationId}));return this.service.emit("onConversationDeleted",o),void this.service.unread.digestUnreadCountChange()}if(12!==a.type)a.type,n=this.setBackFillIds(n),this.recvConversationForCreated(n)<n.length&&this.recvConversationForChanged(n);else this.compareAndClearUnreadInModel(a.oneClickClearUnreadVersion,a.oneClickClearUnreadType,{conversationGroupIds:a.oneClickClearUnreadGroupId?[a.oneClickClearUnreadGroupId]:void 0,conversationTypes:a.oneClickClearUnreadConversationType})}},e.recvConversationForCreated=function recvConversationForCreated(e){var t=this,r=filter(e).call(e,(function(e){return!t.fieldVersion[e.conversationId]})),n=reduce(r).call(r,(function(e,r){if(!t.fieldVersion[r.conversationId]){t.initFieldVersion(r.conversationId,r.version),e=!!t.updateModel(r)||e;var n=t.service.model.getById(r.conversationId);return n&&t.service.triggerConversationCreated(n),e}return e}),!1);return n&&this.service.unread.digestUnreadCountChange(),r.length},e.recvConversationForChanged=function recvConversationForChanged(e){var t,r=this,n=this.bulkCompare(e);if(0!==n.length){this.bulkUpdateModel(n);var a=filter(t=map$6(n).call(n,(function(e){return r.service.model.getById(e.conversationId)}))).call(t,(function(e){return!!e}));this.service.triggerConversationChanged(a)}},e.processTempPacket=function processTempPacket(){var e,t=this;forEach$1(e=this.tempPacket).call(e,(function(e){t.recvConversation(e)})),this.tempPacket=[]},e.bulkCompare=function bulkCompare(e){var t,r=this;return filter(t=map$6(e).call(e,(function(e){return r.compare(e)}))).call(t,(function(e){return!!e}))},e.compare=function compare(e){var t=this,r=e.version,n=e.conversationId,a=e.deleteFlag,i=e.type,o=["stickTop","groupIds","serverExtension","localExtension","lastMessage","lastMessageState","unreadCount","sortOrder","createTime","updateTime"],s={},c=0;return forEach$1(o).call(o,(function(a){var i=a;if(void 0!==e[i]){var o=t.fieldVersion[n];o&&"number"==typeof o[i]&&o[i]>=r||(t.fieldVersion[n]=t.fieldVersion[n]||{},t.fieldVersion[n][i]=r,s[i]=e[i],c+=1)}})),c?Et(Et({},s),{conversationId:n,deleteFlag:a,version:r,type:i}):void 0},e.bulkUpdateModel=function bulkUpdateModel(e){var t=this,r=!1;forEach$1(e).call(e,(function(e){t.updateModel(e)&&(r=!0)})),r&&this.service.unread.digestUnreadCountChange()},e.initFieldVersion=function initFieldVersion(e,t){this.fieldVersion[e]={stickTop:t,groupIds:t,serverExtension:t,lastMessage:t,lastMessageState:t,unreadCount:t,sortOrder:t,createTime:t,updateTime:t}},e.initConversation=function initConversation(e,t){var r=Hi();return Et({conversationId:e,type:this.core.V2NIMConversationIdUtil.parseConversationType(e),stickTop:!1,localExtension:"",serverExtension:"",unreadCount:0,createTime:r,updateTime:r,sortOrder:r},t)},e.updateModel=function updateModel(e){var t=formatConversationByField(e),r=t.deleteFlag,n=t.conversation;if(r){var a=this.service.model.deleteById(n.conversationId);return!!(a&&a.unreadCount>0)}return this.service.model.upsert(n)},e.setModel=function setModel(e){var t,r=map$6(t=filter(e).call(e,(function(e){return!e.deleteFlag}))).call(t,(function(e){return formatConversationByField(e).conversation}));this.service.model.set(r)},e.updateModelWithLastMessage=function updateModelWithLastMessage(e,t,r,n){var a=this.service.model.getById(e),i=t?formatLastMessageFromMessage(this.core,t,r,n):void 0;if(!isEqual(null==a?void 0:a.lastMessage,i))if(a){var o=Et(Et({},a),{sortOrder:i?a.stickTop?i.messageRefer.createTime+1e15:i.messageRefer.createTime:a.sortOrder,lastMessage:i});this.service.model.upsert(o),this.service.triggerConversationChanged([o])}else{this.initFieldVersion(e,-1);var s=this.initConversation(e,{lastMessage:i});this.service.model.upsert(s),this.service.triggerConversationCreated(s)}},e.updateModelByRevoke=function updateModelByRevoke(e){var t=this,r=[];forEach$1(e).call(e,(function(e){var n=e.postscript,a=e.messageRefer,i=__rest(e,["postscript","messageRefer"]),o=a.conversationId,s=t.service.model.getById(o);s&&s.lastMessage&&s.lastMessage.messageRefer.messageClientId===a.messageClientId&&1!==s.lastMessage.lastMessageState&&(s.lastMessage.lastMessageState=1,n&&(s.lastMessage.text=n),Et(s.lastMessage,i),t.service.model.upsert(s),r.push(s))})),r.length>0&&this.service.triggerConversationChanged(r)},e.compareAndUpdateModel=function compareAndUpdateModel(e){var t=this;this.core.logger.log("V2NIMConversation::compareAndUpdateModel",map$6(e).call(e,(function(e){return e.conversationId})));var r=!1,n=[];forEach$1(e).call(e,(function(e){var a=t.compare(e);if(a){var i=t.service.model.getById(e.conversationId);t.updateModel(a)&&(r=!0);var o=t.service.model.getById(e.conversationId);o&&(i?n.push(o):t.service.triggerConversationCreated(o))}})),n.length>0&&this.service.triggerConversationChanged(n),r&&this.service.unread.digestUnreadCountChange()},e.compareAndDeleteModel=function compareAndDeleteModel(e){var t=this;this.core.logger.log("V2NIMConversation::compareAndDeleteModel",e);var r=reduce(e).call(e,(function(e,r){delete t.fieldVersion[r];var n=t.service.model.deleteById(r);return!!!!(n&&n.unreadCount>0)||e}),!1);this.service.emit("onConversationDeleted",e),r&&this.service.unread.digestUnreadCountChange()},e.compareAndDeleteGroupInModel=function compareAndDeleteGroupInModel(e,t){var r,n=this;this.core.logger.log("V2NIMConversation::compareAndDeleteGroupInModel",e,t);var a=[];forEach$1(r=Nt(this.fieldVersion)).call(r,(function(r){var i=n.fieldVersion[r];if(void 0===i.groupIds||e>i.groupIds){i.groupIds=e;var o=n.service.model.getById(r);if(o&&o.groupIds&&o.groupIds.length>0){var s,c=filter(s=o.groupIds).call(s,(function(e){return e!==t}));if(c.length!==o.groupIds.length){var l=Et(Et({},o),{groupIds:c});n.service.model.upsert(l),l&&a.push(l)}}}})),a.length>0&&this.service.triggerConversationChanged(a)},e.compareAndClearUnreadInModel=function compareAndClearUnreadInModel(e,t,r){var n=this;this.core.logger.log("V2NIMConversation::compareAndClearUnreadInModel",e,t,r);var a=[],i=[];if(1===t)i=this.service.model.getAll();else if(r){var o=this.service.model.count();i=this.service.model.getByOption(0,o,r).conversationList}forEach$1(i).call(i,(function(t){var r=t.conversationId,i=n.fieldVersion[r];if(void 0===i.unreadCount||e>i.unreadCount){i.unreadCount=e;var o=t.unreadCount,s=Et(Et({},t),{unreadCount:0});n.service.model.upsert(s),o>0&&a.push(s)}})),a.length>0&&this.service.triggerConversationChanged(a),this.service.unread.digestUnreadCountChange()},e.backfillLastMsg=function backfillLastMsg(e,t){var r=this,n=e=uniq(e);(t||(n=filter(e).call(e,(function(e){return r.conversationIdsForBackFill[e]})),0!==n.length))&&forEach$1(n).call(n,(function(e){var t=get(r.service.model.getById(e),"lastMessage.messageRefer.messageClientId"),n=r.service.hasMessageService?r.core.V2NIMMessageService.model.getLastMessageOfConversation(e):void 0;(n&&n.messageClientId)!==t&&(r.conversationIdsForBackFill[e]=!1,n?r.updateModelWithLastMessage(e,n,2,n.sendingState):r.updateModelWithLastMessage(e,void 0,2,0))}))},V2NIMConversationVersionCacheImpl}(),pm={"28_1":"v2ConversationCreate","28_2":"v2ConversationDelete","28_3":"v2ConversationUpdate","28_4":"v2ConversationSetTop","28_5":"v2ConversationUnreadClear","28_6":"v2ConversationGet","28_7":"v2ConversationGetByIds","28_8":"v2ConversationGetList","28_17":"v2ConversationsDelete","28_18":"v2ConversationsUnreadClear","28_19":"v2ConversationSync","28_20":"v2ConversationNotifySync","28_21":"v2ConversationNotifySyncOnline","28_23":"v2ConversationClearTotalUnread","28_24":"v2ConversationClearTypeUnread","28_25":"v2ConversationClearGroupUnread","4_14":"syncConversationReadTime","4_20":"syncSuperTeamReadTime","4_22":"v2SyncSessionsWithMoreRoaming","4_25":"v2SyncSessionReliableInfo","30_16":"v2MarkConversationReadTime","32_25":"v2MarkSuperTeamReadTime","7_116":"v2MultiDeviceConversationReadTime","21_125":"v2MultiDeviceSuperTeamReadTime"},mm="V2NIMConversationService",hm={conversationId:1,type:2,serverExtension:3,groupIds:4,lastMessage:5,lastMessageState:6,unreadCount:7,stickTop:8,sortOrder:9,version:10,deleteFlag:11,createTime:12,updateTime:13},gm={type:1,oneClickClearUnreadType:2,oneClickClearUnreadConversationType:3,oneClickClearUnreadGroupId:4,oneClickClearUnreadVersion:5,deleteConversationClearMessage:6},vm={v2ConversationCreate:{sid:28,cid:1,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:invert(hm)}]},v2ConversationDelete:{sid:28,cid:2,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,clearMessage:2}}],response:[{type:"Property",name:"data",reflectMapper:invert(hm)}]},v2ConversationUpdate:{sid:28,cid:3,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,serverExtension:2}}],response:[{type:"Property",name:"data",reflectMapper:invert(hm)}]},v2ConversationSetTop:{sid:28,cid:4,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,stickTop:2}}],response:[{type:"Property",name:"data",reflectMapper:invert(hm)}]},v2ConversationUnreadClear:{sid:28,cid:5,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:invert(hm)}]},v2ConversationGet:{sid:28,cid:6,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1}}],response:[{type:"Property",name:"data",reflectMapper:invert(hm)}]},v2ConversationGetByIds:{sid:28,cid:7,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGetList:{sid:28,cid:8,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{cursor:1,limit:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)},{type:"Property",name:"info",reflectMapper:{1:"hasMore",2:"offset"}}]},v2ConversationsDelete:{sid:28,cid:17,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1,clearMessage:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationsUnreadClear:{sid:28,cid:18,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationSync:{sid:28,cid:19,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{cursor:1}}],response:[{type:"Property",name:"info",reflectMapper:{1:"nextCursor",2:"syncType"}}]},v2ConversationNotifySync:{sid:28,cid:20,service:mm,response:[{type:"Property",name:"info",reflectMapper:{1:"nextCursor",2:"syncType"}},{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)}]},v2ConversationNotifySyncOnline:{sid:28,cid:21,service:mm,response:[{type:"Property",name:"info",reflectMapper:invert(gm)},{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)}]},v2ConversationClearTotalUnread:{sid:28,cid:23,service:mm,response:[{type:"Property",name:"info",reflectMapper:invert(gm)}]},v2ConversationClearTypeUnread:{sid:28,cid:24,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{conversationType:1}}],response:[{type:"Property",name:"info",reflectMapper:invert(gm)}]},v2ConversationClearGroupUnread:{sid:28,cid:25,service:mm,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"info",reflectMapper:invert(gm)}]},syncConversationReadTime:{sid:4,cid:14,service:mm,response:[{type:"StrLongMap",name:"p2p"},{type:"LongLongMap",name:"team"},{type:"Long",name:"timetag"}]},syncSuperTeamReadTime:{sid:4,cid:20,service:mm,response:[{type:"LongLongMap",name:"superTeam"}]},v2SyncSessionsWithMoreRoaming:{sid:4,cid:22,service:mm,response:[]},v2SyncSessionReliableInfo:{sid:4,cid:25,service:mm,response:[]},v2MarkConversationReadTime:{sid:30,cid:16,service:mm,params:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},v2MarkSuperTeamReadTime:{sid:32,cid:25,service:mm,params:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]},v2MultiDeviceConversationReadTime:{sid:30,cid:116,service:mm,response:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},v2MultiDeviceSuperTeamReadTime:{sid:21,cid:125,service:mm,response:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]}},fm=function(){function V2NIMConversationUnreadImpl(e,t){this.totalUnreadCount=void 0,this.unreadCountByFilter={},this.core=e,this.service=t}var e=V2NIMConversationUnreadImpl.prototype;return e.reset=function reset(){this.totalUnreadCount=void 0,this.unreadCountByFilter={}},e.getTotalUnreadCount=function getTotalUnreadCount(){return this.totalUnreadCount},e.resetTotalAfterSyncDone=function resetTotalAfterSyncDone(){var e,t=reduce(e=this.service.model.getAll()).call(e,(function(e,t){return e+(t.unreadCount||0)}),0),r=this.totalUnreadCount;return void 0!==r&&r===t||(this.totalUnreadCount=t,this.service.emit("onTotalUnreadCountChanged",t)),t},e.digestUnreadCountChange=function digestUnreadCountChange(){this._digest()},e._digest=function _digest(){var e,t=this,r=this.totalUnreadCount,n=reduce(e=this.service.model.getAll()).call(e,(function(e,t){return e+(t.unreadCount||0)}),0);this.core.logger.log("V2NIMConversation::digestUnreadCountChange:oldUnreadCount "+r+", newUnreadCount "+n),r!==n&&(this.totalUnreadCount=n,this.service.emit("onTotalUnreadCountChanged",n));var a=Nt(this.unreadCountByFilter);forEach$1(a).call(a,(function(e){var r=JSON.parse(e),n=t.getUnreadCountByFilter(r),a=t.unreadCountByFilter[e];t.unreadCountByFilter[e]=n,r.equals=bind$1(equals).call(equals,r),a!==n&&t.service.emit("onUnreadCountChangedByFilter",r,n)}))},e.getUnreadCountByIds=function getUnreadCountByIds(e){var t=this;return reduce(e).call(e,(function(e,r){var n=t.service.model.getById(r);return e+(n&&n.unreadCount||0)}),0)},e.getUnreadCountByFilter=function getUnreadCountByFilter(e){var t,r=this.service.model.count(),n=this.service.model.getByOption(0,r,{conversationTypes:e.conversationTypes,conversationGroupIds:e.conversationGroupId?[e.conversationGroupId]:void 0,ignoreMuted:e.ignoreMuted});return reduce(t=n.conversationList).call(t,(function(e,t){return e+(t.unreadCount||0)}),0)},e.addFilter=function addFilter(e){var t=generateFilterKey(e);if(void 0!==this.unreadCountByFilter[t])throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST});var r=JSON.parse(t),n=this.getUnreadCountByFilter(r);this.unreadCountByFilter[t]=n,this.service.emit("onUnreadCountChangedByFilter",r,n)},e.deleteFilter=function deleteFilter(e){var t=generateFilterKey(e);if(void 0===this.unreadCountByFilter[t])throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});delete this.unreadCountByFilter[t]},V2NIMConversationUnreadImpl}();function generateFilterKey(e){var t=e.conversationTypes;return t&&(t=sort(t).call(t)),bn({conversationGroupId:e.conversationGroupId,conversationTypes:t,ignoreMuted:e.ignoreMuted})}function equals(e){return bn(this)===generateFilterKey(e)}var ym={createTime:{type:"number"},updateTime:{type:"number"}};function formatConversationGroups(e){return e&&e.length>0?map$6(e).call(e,(function(e){return formatConversationGroup(e)})):[]}function formatConversationGroup(e){return format(ym,e)}function formatFailedMap(e){var t,r=JSON.parse(e);return map$6(t=Nt(r)).call(t,(function(e){return{conversationId:e,error:new Sl({code:r[e]})}}))}var _m,Mm={type:{type:"number"},deleteVersion:{type:"number"},conversationIds:{type:"object"}};function formatConversationGroupNotify(e){return format(Mm,e)}!function(e){e[e.createConversationGroup=1]="createConversationGroup",e[e.deleteConversationGroup=2]="deleteConversationGroup",e[e.updateConversationGroup=3]="updateConversationGroup",e[e.addConversationToGroup=4]="addConversationToGroup",e[e.removeConversationFromGroup=5]="removeConversationFromGroup"}(_m||(_m={}));var Im=function(e){function V2NIMConversationServiceImpl(t,r){var n;return void 0===r&&(r={}),(n=e.call(this,"V2NIMConversationService",t)||this).config={},n.model=new Up,n.versionCache=new um(n.core,De(n)),n.unread=new fm(n.core,De(n)),n.core._registerDep(jp,"V2NIMConversationIdUtil"),"v2"!==n.core.options.apiVersion?De(n):(registerParser({cmdMap:pm,cmdConfig:vm}),n.setOptions(r),n.setListener(),n)}_t(V2NIMConversationServiceImpl,e);var t=V2NIMConversationServiceImpl.prototype;return t.setOptions=function setOptions(e){this.config=Et(this.config,e)},t.setListener=function setListener(){var e=this;this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(function(){e.versionCache.doSync()})),this.core.eventBus.on("V2NIMConversationService/conversationOnlineSyncNotify",(function(t,r){var n;!1!==(null===(n=null==r?void 0:r.messageConfig)||void 0===n?void 0:n.lastMessageUpdateEnabled)&&(t.content.info=deserialize(t.content.info,invert(gm)),t.content.data=deserialize(t.content.data,invert(hm)),r&&(t.content.data.lastMessage=formatLastMessageFromMessage(e.core,r,0)),t.content.datas=[t.content.data],e.v2ConversationNotifySyncOnlineHandler.call(e,t))})),this.core.eventBus.on("V2NIMConversationService/sendMessage",(function(t,r){var n,a;1===r&&!0===(null===(n=t.messageConfig)||void 0===n?void 0:n.historyEnabled)||!1!==(null===(a=null==t?void 0:t.messageConfig)||void 0===a?void 0:a.lastMessageUpdateEnabled)&&e.versionCache.updateModelWithLastMessage(t.conversationId,t,2,r)})),this.core.eventBus.on("V2NIMConversationService/deleteMessages",(function(t){var r=map$6(t).call(t,(function(e){return e.messageRefer.conversationId}));e.versionCache.backfillLastMsg(r,!0)})),this.core.eventBus.on("V2NIMConversationService/revokeMessages",(function(t){e.versionCache.updateModelByRevoke(t)})),this.core.eventBus.on("V2NIMConversationService/checkBackFill",(function(t){e.versionCache.backfillLastMsg(t,!1)})),this.core.eventBus.on("V2NIMConversationService/setMute",(function(t,r){var n=e.model.getById(t);n&&n.mute!==r&&(n.mute=r,e.model.upsert(n),e.emit("onConversationChanged",[n]))}))},t.reset=function reset(){this.versionCache.reset(),this.model.reset(),this.unread.reset()},t.emit=function emit(t){for(var r,n,a,i,o=this.name+"::emit "+t.toString(),s=arguments.length,c=new Array(s>1?s-1:0),l=1;l<s;l++)c[l-1]=arguments[l];if("onConversationCreated"===t){var d=c[0];this.logger.log(""+o,"id:"+d.conversationId+";unread:"+d.unreadCount+";lastMsg:"+(null===(a=d.lastMessage)||void 0===a?void 0:a.messageRefer.messageClientId)+"/"+(null===(i=d.lastMessage)||void 0===i?void 0:i.messageRefer.messageServerId))}else if("onConversationChanged"===t){var u=c[0];this.logger.log(""+o,map$6(u).call(u,(function(e){var t,r;return"id:"+e.conversationId+";unread:"+e.unreadCount+";lastMsg:"+(null===(t=e.lastMessage)||void 0===t?void 0:t.messageRefer.messageClientId)+"/"+(null===(r=e.lastMessage)||void 0===r?void 0:r.messageRefer.messageServerId)})))}else{var p,m;(p=this.logger).log.apply(p,concat(m=[""+o]).call(m,c))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,c))},t.getConversationList=function getConversationList(e,t){this.checkV2(),validate({offset:{type:"number",min:0}},{offset:e},"",!0),validate({limit:{type:"number",min:1}},{limit:t},"",!0),this.core.V2NIMLoginService.checkIllegalState();var r=this.model.getByOption(e,t,{});return r.conversationList=this.computedFieldForConversations(r.conversationList),Pi.resolve(r)},t.getConversationListByOption=function getConversationListByOption(e,t,r){this.checkV2(),validate({offset:{type:"number",min:0}},{offset:e},"",!0),validate({limit:{type:"number",min:1}},{limit:t},"",!0),validate({option:{type:"object",required:!0,rules:{conversationTypes:{type:"array",itemType:"number",required:!1},onlyUnread:{type:"boolean",required:!1},conversationGroupIds:{type:"array",itemType:"string",required:!1}}}},{option:r},"",!0),this.core.V2NIMLoginService.checkIllegalState();var n=this.model.getByOption(e,t,r);return n.conversationList=this.computedFieldForConversations(n.conversationList),Pi.resolve(n)},t.getConversation=function getConversation(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t;return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:if(this.checkV2(),validateConversationId(this.core.account,e),this.core.V2NIMLoginService.checkIllegalState(),!(t=this.model.getById(e))){r.next=8;break}return r.abrupt("return",this.computedFieldForConversation(t));case 8:throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});case 9:case"end":return r.stop()}}),_callee,this)})))},t.getConversationListByIds=function getConversationListByIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n=this;return Dl.wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0),this.core.V2NIMLoginService.checkIllegalState(),r=filter(t=map$6(e).call(e,(function(e){return n.model.getById(e)}))).call(t,(function(e){return!!e})),r=this.computedFieldForConversations(r),a.abrupt("return",r);case 6:case"end":return a.stop()}}),_callee2,this)})))},t.createConversation=function createConversation(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n,a;return Dl.wrap((function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validateConversationId(this.core.account,e),i.next=4,this.core.sendCmd("v2ConversationCreate",{tag:{conversationId:e}});case 4:if(t=i.sent,r=get(t,"content.data"),n=formatConversationField(this.core,r),this.versionCache.compareAndUpdateModel([n]),!(a=this.model.getById(e))){i.next=13;break}return i.abrupt("return",this.computedFieldForConversation(a));case 13:throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});case 14:case"end":return i.stop()}}),_callee3,this)})))},t.deleteConversation=function deleteConversation(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validateConversationId(this.core.account,e),validate({clearMessage:{type:"boolean",required:!1}},{clearMessage:t},"",!0),r.prev=3,r.next=6,this.core.sendCmd("v2ConversationDelete",{tag:{conversationId:e,clearMessage:Number(t||!1)}});case 6:r.next=11;break;case 8:r.prev=8,r.t0=r.catch(3),this.logger.warn("V2NIMConversationService:deleteConversation: delete conversation failed: "+e);case 11:this.model.getById(e)&&(t&&this.core.eventBus.emit("V2NIMConversationService/deleteConversation",[e]),this.versionCache.compareAndDeleteModel([e]));case 12:case"end":return r.stop()}}),_callee4,this,[[3,8]])})))},t.deleteConversationListByIds=function deleteConversationListByIds(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var r,n,a,i=this;return Dl.wrap((function _callee5$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0),validate({clearMessage:{type:"boolean",required:!1}},{clearMessage:t},"",!0),o.next=5,this.core.sendCmd("v2ConversationsDelete",{tag:{conversationIds:bn(e),clearMessage:Number(t||!1)}});case 5:return r=o.sent,n=formatFailedMap(get(r,"content.info.failedMap")),(a=filter(n).call(n,(function(e){return e.error.code!==_l.V2NIM_ERROR_CODE_CONVERSATION_NOT_EXIST||!i.model.getById(e.conversationId)}))).length<e.length&&(t&&this.core.eventBus.emit("V2NIMConversationService/deleteConversation",e),this.versionCache.compareAndDeleteModel(e)),o.abrupt("return",a);case 10:case"end":return o.stop()}}),_callee5,this)})))},t.stickTopConversation=function stickTopConversation(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var r,n,a;return Dl.wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validateConversationId(this.core.account,e),validate({stickTop:{type:"boolean"}},{stickTop:t},"",!0),i.next=5,this.core.sendCmd("v2ConversationSetTop",{tag:{conversationId:e,stickTop:Number(t)}});case 5:r=i.sent,n=get(r,"content.data"),a=formatConversationField(this.core,n),this.versionCache.compareAndUpdateModel([a]);case 9:case"end":return i.stop()}}),_callee6,this)})))},t.updateConversation=function updateConversation(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var r,n,a;return Dl.wrap((function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validateConversationId(this.core.account,e),validate({updateInfo:{type:"object",required:!0,rules:{serverExtension:{type:"string"}}}},{updateInfo:t},"",!0),i.next=5,this.core.sendCmd("v2ConversationUpdate",{tag:Et({conversationId:e},t)});case 5:r=i.sent,n=get(r,"content.data"),a=formatConversationField(this.core,n),this.versionCache.compareAndUpdateModel([a]);case 9:case"end":return i.stop()}}),_callee7,this)})))},t.updateConversationLocalExtension=function updateConversationLocalExtension(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var r,n;return Dl.wrap((function _callee8$(a){for(;;)switch(a.prev=a.next){case 0:if(this.checkV2(),validateConversationId(this.core.account,e),validate({localExtension:{type:"string"}},{localExtension:t},"",!0),r=this.model.getById(e)){a.next=6;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST});case 6:if(r.localExtension!==t){a.next=8;break}return a.abrupt("return");case 8:n=Et(Et({},r),{localExtension:t}),this.model.upsert(n),this.triggerConversationChanged([n]);case 11:case"end":return a.stop()}}),_callee8,this)})))},t.getTotalUnreadCount=function getTotalUnreadCount(){return this.checkV2(),this.unread.getTotalUnreadCount()||0},t.getUnreadCountByIds=function getUnreadCountByIds(e){this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0);var t=this.unread.getUnreadCountByIds(e);return Pi.resolve(t)},t.getUnreadCountByFilter=function getUnreadCountByFilter(e){this.checkV2(),this.valiteFilter(e);var t=this.unread.getUnreadCountByFilter(e);return Pi.resolve(t)},t.clearTotalUnreadCount=function clearTotalUnreadCount(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var e,t;return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),r.next=3,this.core.sendCmd("v2ConversationClearTotalUnread");case 3:e=r.sent,t=formatConversationNotify(get(e,"content.info")),this.versionCache.compareAndClearUnreadInModel(t.oneClickClearUnreadVersion,t.oneClickClearUnreadType);case 6:case"end":return r.stop()}}),_callee9,this)})))},t.clearUnreadCountByIds=function clearUnreadCountByIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var t,r,n;return Dl.wrap((function _callee10$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate({conversationIds:{type:"array",itemType:"string",min:1}},{conversationIds:e},"",!0),a.next=4,this.core.sendCmd("v2ConversationsUnreadClear",{tag:{conversationIds:bn(e)}});case 4:return t=a.sent,r=formatConversationFields(this.core,get(t,"content.datas")),n=formatFailedMap(get(t,"content.info.failedMap")),this.versionCache.compareAndUpdateModel(r),a.abrupt("return",n);case 9:case"end":return a.stop()}}),_callee10,this)})))},t.clearUnreadCountByGroupId=function clearUnreadCountByGroupId(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),validate({groupId:{type:"string"}},{groupId:e},"",!0),t.next=4,this.core.sendCmd("v2ConversationClearGroupUnread",{tag:{groupId:e}});case 4:case"end":return t.stop()}}),_callee11,this)})))},t.clearUnreadCountByTypes=function clearUnreadCountByTypes(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t,r;return Dl.wrap((function _callee12$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate({types:{type:"array",itemType:"number",min:1}},{types:e},"",!0),n.next=4,this.core.sendCmd("v2ConversationClearTypeUnread",{tag:{conversationType:bn(e)}});case 4:t=n.sent,r=formatConversationNotify(get(t,"content.info")),this.versionCache.compareAndClearUnreadInModel(r.oneClickClearUnreadVersion,r.oneClickClearUnreadType,{conversationTypes:r.oneClickClearUnreadConversationType});case 7:case"end":return n.stop()}}),_callee12,this)})))},t.markConversationRead=function markConversationRead(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var n,a,i,o,s;return Dl.wrap((function _callee13$(c){for(;;)switch(c.prev=c.next){case 0:if(this.checkV2(),this.checkLogin(),validateConversationId(this.core.account,e),n=this.model.getById(e)){c.next=6;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Conversation not exist"}});case 6:if(a=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e),i=this.core.V2NIMConversationIdUtil.parseConversationType(e),o=this.model.getReadTime(e),!(null===(r=null===(t=null==n?void 0:n.lastMessage)||void 0===t?void 0:t.messageRefer)||void 0===r?void 0:r.createTime)){c.next=13;break}s=n.lastMessage.messageRefer.createTime,c.next=19;break;case 13:if(!this.core.timeOrigin.checkNodeReliable()){c.next=17;break}s=this.core.timeOrigin.getNTPTime(),c.next=19;break;case 17:return this.logger.log("markConversationRead","NTP time is not reliable",e),c.abrupt("return",o||0);case 19:if(!(o>=s)){c.next=22;break}return this.logger.log("markConversationRead","currentReadTime >= readTime",e,o,s),c.abrupt("return",o);case 22:if(3!==i){c.next=27;break}return c.next=25,this.core.sendCmd("v2MarkSuperTeamReadTime",{timetag:s,to:a});case 25:c.next=29;break;case 27:return c.next=29,this.core.sendCmd("v2MarkConversationReadTime",{scene:1===i?0:2===i?1:2,timetag:s,to:a});case 29:return this.model.updateReadTime(e,s),c.abrupt("return",s);case 31:case"end":return c.stop()}}),_callee13,this)})))},t.getConversationReadTime=function getConversationReadTime(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){return Dl.wrap((function _callee14$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),validateConversationId(this.core.account,e),t.abrupt("return",this.model.getReadTime(e));case 3:case"end":return t.stop()}}),_callee14,this)})))},t.subscribeUnreadCountByFilter=function subscribeUnreadCountByFilter(e){var t;this.checkV2(),this.checkLogin(),this.valiteFilter(e),0===(null===(t=e.conversationTypes)||void 0===t?void 0:t.length)&&delete e.conversationTypes,this.unread.addFilter(e)},t.unsubscribeUnreadCountByFilter=function unsubscribeUnreadCountByFilter(e){var t;this.checkV2(),this.checkLogin(),this.valiteFilter(e),0===(null===(t=e.conversationTypes)||void 0===t?void 0:t.length)&&delete e.conversationTypes,this.unread.deleteFilter(e)},t.v2ConversationNotifySyncHandler=function v2ConversationNotifySyncHandler(e){this.versionCache.recvConversationFromSyncAction(e)},t.v2ConversationNotifySyncOnlineHandler=function v2ConversationNotifySyncOnlineHandler(e){this.versionCache.recvConversation(e)},t.syncConversationReadTimeHandler=function syncConversationReadTimeHandler(e){var t,r,n;if(null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.p2p)for(var a=0,i=Mp(e.content.p2p);a<i.length;a++){var o=i[a],s=o[0],c=o[1];this.model.updateReadTime(this.core.V2NIMConversationIdUtil.p2pConversationId(s),c),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.p2pConversationId(s),c)}if(null===(n=null===(r=null==e?void 0:e.content)||void 0===r?void 0:r.team)||void 0===n?void 0:n.m_map)for(var l=0,d=Mp(e.content.team.m_map);l<d.length;l++){var u=d[l],p=u[0],m=u[1];this.model.updateReadTime(this.core.V2NIMConversationIdUtil.teamConversationId(p),m),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.teamConversationId(p),m)}},t.syncSuperTeamReadTimeHandler=function syncSuperTeamReadTimeHandler(e){var t,r;if(null===(r=null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.superTeam)||void 0===r?void 0:r.m_map)for(var n=0,a=Mp(e.content.superTeam.m_map);n<a.length;n++){var i=a[n],o=i[0],s=i[1];this.model.updateReadTime(this.core.V2NIMConversationIdUtil.superTeamConversationId(o),s),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.superTeamConversationId(o),s)}},t.v2MultiDeviceConversationReadTimeHandler=function v2MultiDeviceConversationReadTimeHandler(e){var t;(null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.to)&&(0===e.content.scene?(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.p2pConversationId(e.content.to),e.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.p2pConversationId(e.content.to),e.content.timetag)):(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.teamConversationId(e.content.to),e.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.teamConversationId(e.content.to),e.content.timetag)))},t.v2MultiDeviceSuperTeamReadTimeHandler=function v2MultiDeviceSuperTeamReadTimeHandler(e){var t;(null===(t=null==e?void 0:e.content)||void 0===t?void 0:t.to)&&(this.model.updateReadTime(this.core.V2NIMConversationIdUtil.superTeamConversationId(e.content.to),e.content.timetag),this.emit("onConversationReadTimeUpdated",this.core.V2NIMConversationIdUtil.superTeamConversationId(e.content.to),e.content.timetag))},t.valiteFilter=function valiteFilter(e){if(validate({filter:{type:"object",required:!0,rules:{conversationTypes:{type:"array",itemType:"number",required:!1},conversationGroupId:{type:"string",allowEmpty:!1,required:!1},ignoreMuted:{type:"boolean",required:!1}}}},{filter:e},"",!0),void 0===e.conversationTypes&&void 0===e.conversationGroupId&&!0!==e.ignoreMuted)throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Filter cannot be empty"}})},t.computedFieldForConversations=function computedFieldForConversations(e){var t=this;return map$6(e).call(e,(function(e){return t.computedFieldForConversation(e)}))},t.computedFieldForConversation=function computedFieldForConversation(e){var t,r,n,a,i;if(0===e.type)return e;var o=this.core.V2NIMConversationIdUtil.parseConversationType(e.conversationId),s=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e.conversationId),c={};if((null===(t=this.core.V2NIMSettingService)||void 0===t?void 0:t.name)&&(c.mute=this.core.V2NIMSettingService.getConversationMuteStatus(e.conversationId)),1===o&&this.hasUserService){var l,d=this.core.V2NIMUserService.model.getUser(s),u=this.hasFriendService?this.core.V2NIMFriendService.model.getFriend(s):void 0;e.conversationId!==(null===(r=e.lastMessage)||void 0===r?void 0:r.messageRefer.conversationId)||0!==(null===(n=e.lastMessage)||void 0===n?void 0:n.lastMessageState)&&2!==(null===(a=e.lastMessage)||void 0===a?void 0:a.lastMessageState)||(l=null===(i=e.lastMessage)||void 0===i?void 0:i.senderName),c.name=(null==u?void 0:u.alias)||(null==d?void 0:d.name)||l||s,c.avatar=(null==d?void 0:d.avatar)||""}else if(2===o&&this.hasTeamService){var p=this.core.V2NIMTeamService.model.getById(s,1);c.name=(null==p?void 0:p.name)||s,c.avatar=(null==p?void 0:p.avatar)||""}else if(3===o&&this.hasTeamService){var m=this.core.V2NIMTeamService.model.getById(s,2);c.name=(null==m?void 0:m.name)||s,c.avatar=(null==m?void 0:m.avatar)||""}return Et(e,c),e},t.triggerConversationChanged=function triggerConversationChanged(e){e=this.computedFieldForConversations(e),e=JSON.parse(bn(e)),forEach$1(e).call(e,(function(e){e.lastMessage||(e.lastMessage=void 0),delete e.lastMessageState})),this.emit("onConversationChanged",e)},t.triggerConversationCreated=function triggerConversationCreated(e){e=this.computedFieldForConversation(e),delete(e=JSON.parse(bn(e))).lastMessageState,this.emit("onConversationCreated",e)},Ue(V2NIMConversationServiceImpl,[{key:"hasUserService",get:function get(){var e;return!!(null===(e=this.core.V2NIMUserService)||void 0===e?void 0:e.name)}},{key:"hasFriendService",get:function get(){var e;return!!(null===(e=this.core.V2NIMFriendService)||void 0===e?void 0:e.name)}},{key:"hasTeamService",get:function get(){var e;return!!(null===(e=this.core.V2NIMTeamService)||void 0===e?void 0:e.name)}},{key:"hasMessageService",get:function get(){var e;return!!(null===(e=this.core.V2NIMMessageService)||void 0===e?void 0:e.name)}}]),V2NIMConversationServiceImpl}(Ru),Sm={"28_9":"v2ConversationGroupCreate","28_10":"v2ConversationGroupDelete","28_11":"v2ConversationGroupUpdate","28_12":"v2ConversationGroupGet","28_13":"v2ConversationGroupsGet","28_14":"v2ConversationGroupListGet","28_15":"v2ConversationGroupAddTo","28_16":"v2ConversationGroupRemoveFrom","28_22":"v2ConversationGroupNotifySyncOnline"},Tm="V2NIMConversationGroupService",Cm={groupId:1,name:2,serverExtension:3,createTime:4,updateTime:5},bm={v2ConversationGroupCreate:{sid:28,cid:9,service:Tm,params:[{type:"Property",name:"tag",reflectMapper:{conversationIds:1,name:2,serverExtension:3}}],response:[{type:"Property",name:"data",reflectMapper:invert(Cm)},{type:"PropertyArray",name:"conversations",reflectMapper:invert(hm)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupDelete:{sid:28,cid:10,service:Tm,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"info",reflectMapper:{1:"type",2:"deleteVersion",3:"groupList"}}]},v2ConversationGroupUpdate:{sid:28,cid:11,service:Tm,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,name:2,serverExtension:3}}],response:[{type:"Property",name:"data",reflectMapper:invert(Cm)}]},v2ConversationGroupGet:{sid:28,cid:12,service:Tm,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1}}],response:[{type:"Property",name:"data",reflectMapper:invert(Cm)}]},v2ConversationGroupsGet:{sid:28,cid:13,service:Tm,params:[{type:"Property",name:"tag",reflectMapper:{groupIds:1}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(Cm)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupListGet:{sid:28,cid:14,service:Tm,response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(Cm)}]},v2ConversationGroupAddTo:{sid:28,cid:15,service:Tm,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,conversationIds:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupRemoveFrom:{sid:28,cid:16,service:Tm,params:[{type:"Property",name:"tag",reflectMapper:{groupId:1,conversationIds:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invert(hm)},{type:"Property",name:"info",reflectMapper:{1:"failedMap"}}]},v2ConversationGroupNotifySyncOnline:{sid:28,cid:22,service:Tm,response:[{type:"Property",name:"info",reflectMapper:{1:"type",2:"deleteVersion",3:"conversationIds"}},{type:"Property",name:"data",reflectMapper:invert(Cm)}]}},Em=function(e){function V2NIMConversationGroupServiceImpl(t,r){var n;return void 0===r&&(r={}),(n=e.call(this,"V2NIMConversationGroupService",t)||this).config={},n.core._registerDep(Im,"V2NIMConversationService"),"v2"!==n.core.options.apiVersion?De(n):(registerParser({cmdMap:Sm,cmdConfig:bm}),n.setOptions(r),n)}_t(V2NIMConversationGroupServiceImpl,e);var t=V2NIMConversationGroupServiceImpl.prototype;return t.setOptions=function setOptions(e){this.config=Et(this.config,e)},t.emit=function emit(t){for(var r,n,a=this.name+"::emit "+t.toString(),i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if("onConversationsAddedToGroup"===t){var c=o[0],l=o[1];this.logger.log(""+a,"groupId:"+c,"conversations:"+map$6(l).call(l,(function(e){return e.conversationId})).join(","))}else{var d,u;(d=this.logger).log.apply(d,concat(u=[""+a]).call(u,o))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,o))},t.createConversationGroup=function createConversationGroup(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var n,a,i,o,s,c=this;return Dl.wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:return this.checkV2(),validate({name:{type:"string",allowEmpty:!1}},{name:e},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:t},"",!0),validate({conversationIds:{type:"array",itemType:"string",required:!1}},{conversationIds:r},"",!0),l.next=6,this.core.sendCmd("v2ConversationGroupCreate",{tag:{name:e,serverExtension:t||"",conversationIds:r&&bn(r)}});case 6:return n=l.sent,a=formatConversationGroup(get(n,"content.data")),i=formatConversationFields(this.core,get(n,"content.conversations")),o=formatFailedMap(get(n,"content.info.failedMap")),this.emit("onConversationGroupCreated",a),i.length>0&&(this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(i),this.emit("onConversationsAddedToGroup",a.groupId,filter(s=map$6(i).call(i,(function(e){return c.core.V2NIMConversationService.model.getById(e.conversationId)}))).call(s,(function(e){return!!e})))),l.abrupt("return",{group:a,failedList:o});case 13:case"end":return l.stop()}}),_callee,this)})))},t.deleteConversationGroup=function deleteConversationGroup(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r;return Dl.wrap((function _callee2$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),n.next=4,this.core.sendCmd("v2ConversationGroupDelete",{tag:{groupId:e}});case 4:t=n.sent,r=formatConversationGroupNotify(get(t,"content.info")),this.core.V2NIMConversationService.versionCache.compareAndDeleteGroupInModel(r.deleteVersion,e),this.emit("onConversationGroupDeleted",e);case 8:case"end":return n.stop()}}),_callee2,this)})))},t.updateConversationGroup=function updateConversationGroup(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var n,a;return Dl.wrap((function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:if(this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),validate({name:{type:"string",required:!1}},{name:t},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:r},"",!0),void 0!==t||void 0!==r){i.next=6;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER});case 6:return i.next=8,this.core.sendCmd("v2ConversationGroupUpdate",{tag:{groupId:e,name:t,serverExtension:r}});case 8:n=i.sent,a=formatConversationGroup(get(n,"content.data")),this.emit("onConversationGroupChanged",a);case 11:case"end":return i.stop()}}),_callee3,this)})))},t.addConversationsToGroup=function addConversationsToGroup(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var r,n,a,i,o,s,c=this;return Dl.wrap((function _callee4$(l){for(;;)switch(l.prev=l.next){case 0:return this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),validate({conversationIds:{type:"array",itemType:"string",min:1,allowEmpty:!1}},{conversationIds:t},"",!0),l.next=5,this.core.sendCmd("v2ConversationGroupAddTo",{tag:{groupId:e,conversationIds:bn(t)}});case 5:return n=l.sent,a=get(n,"content.info.failedMap")||"",i=[],a&&(i=formatFailedMap(a)),o=formatConversationFields(this.core,get(n,"content.datas")),this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(o),(s=filter(r=map$6(o).call(o,(function(e){return c.core.V2NIMConversationService.model.getById(e.conversationId)}))).call(r,(function(e){return!!e}))).length>0&&this.emit("onConversationsAddedToGroup",e,s),l.abrupt("return",i);case 14:case"end":return l.stop()}}),_callee4,this)})))},t.removeConversationsFromGroup=function removeConversationsFromGroup(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var r,n,a,i;return Dl.wrap((function _callee5$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),validate({conversationIds:{type:"array",itemType:"string",min:1,allowEmpty:!1}},{conversationIds:t},"",!0),o.next=5,this.core.sendCmd("v2ConversationGroupRemoveFrom",{tag:{groupId:e,conversationIds:bn(t)}});case 5:return r=o.sent,n=get(r,"content.info.failedMap")||"",a=[],n&&(a=formatFailedMap(n)),i=formatConversationFields(this.core,get(r,"content.datas")),this.core.V2NIMConversationService.versionCache.compareAndUpdateModel(i),this.emit("onConversationsRemovedFromGroup",e,map$6(i).call(i,(function(e){return e.conversationId}))),o.abrupt("return",a);case 13:case"end":return o.stop()}}),_callee5,this)})))},t.getConversationGroup=function getConversationGroup(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t;return Dl.wrap((function _callee6$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate({groupId:{type:"string",allowEmpty:!1}},{groupId:e},"",!0),r.next=4,this.core.sendCmd("v2ConversationGroupGet",{tag:{groupId:e}});case 4:return t=r.sent,r.abrupt("return",formatConversationGroup(get(t,"content.data")));case 6:case"end":return r.stop()}}),_callee6,this)})))},t.getConversationGroupList=function getConversationGroupList(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var e;return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),t.next=3,this.core.sendCmd("v2ConversationGroupListGet");case 3:return e=t.sent,t.abrupt("return",formatConversationGroups(get(e,"content.datas")));case 5:case"end":return t.stop()}}),_callee7,this)})))},t.getConversationGroupListByIds=function getConversationGroupListByIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t,r,n;return Dl.wrap((function _callee8$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate({groupIds:{type:"array",itemType:"string",min:1}},{groupIds:e},"",!0),a.next=4,this.core.sendCmd("v2ConversationGroupsGet",{tag:{groupIds:e&&bn(e)}});case 4:return r=a.sent,n=formatConversationGroups(get(r,"content.datas")),a.abrupt("return",filter(t=map$6(e).call(e,(function(e){return filter(n).call(n,(function(t){return t.groupId===e}))[0]}))).call(t,(function(e){return!!e})));case 7:case"end":return a.stop()}}),_callee8,this)})))},t.v2ConversationGroupNotifySyncOnlineHandler=function v2ConversationGroupNotifySyncOnlineHandler(e){var t,r=this,n=formatConversationGroupNotify(get(e,"content.info")),a=n.type,i=n.deleteVersion,o=n.conversationIds,s=formatConversationGroup(get(e,"content.data"));if(this.core.logger.log("v2ConversationGroupNotifySyncOnlineHandler",n,s),1===a)this.emit("onConversationGroupCreated",s),o&&o.length>0&&this.emit("onConversationsAddedToGroup",s.groupId,filter(t=map$6(o).call(o,(function(e){return r.core.V2NIMConversationService.model.getById(e)}))).call(t,(function(e){return!!e})));else if(2===a)this.emit("onConversationGroupDeleted",s.groupId),this.core.V2NIMConversationService.versionCache.compareAndDeleteGroupInModel(i,s.groupId);else if(3===a)this.emit("onConversationGroupChanged",s);else if(4===a){var c,l=filter(c=map$6(o).call(o,(function(e){return r.core.V2NIMConversationService.model.getById(e)}))).call(c,(function(e){return!!e}));this.emit("onConversationsAddedToGroup",s.groupId,l)}else 5===a&&this.emit("onConversationsRemovedFromGroup",s.groupId,o)},V2NIMConversationGroupServiceImpl}(Ru),Rm=function(){function V2NIMMessageModel(){this.messages=new ic,this.maxSize=2e3}var e=V2NIMMessageModel.prototype;return e.reset=function reset(){this.messages.clear()},e.getMessageById=function getMessageById(e){if(e)return this.messages.get(e)},e.getMessagesByConversationId=function getMessagesByConversationId(e){var t,r=[];return forEach$1(t=this.messages).call(t,(function(t){t.conversationId===e&&r.push(t)})),r},e.getLastMessageOfConversation=function getLastMessageOfConversation(e){var t=this.getMessagesByConversationId(e);if(0!==t.length)return reduce(t).call(t,(function(e,t){return t.createTime>e.createTime?t:e}),t[0])},e.upsertMessages=function upsertMessages(e){var t,r,n,a=this;forEach$1(e).call(e,(function(e){a.messages.set(e.messageClientId,e)}));var i=this.messages.size;if(!(i<=this.maxSize))for(var o=sort(t=filter(r=xl(values(n=this.messages).call(n))).call(r,(function(e){return 3!==e.sendingState}))).call(t,(function(e,t){return e.createTime-t.createTime})),s=i-this.maxSize>100?i-this.maxSize:100,c=0;c<s;c++){var l=o[c];l&&this.messages.delete(l.messageClientId)}},e.deleteMessage=function deleteMessage(e){this.messages.delete(e)},e.deleteMessages=function deleteMessages(e,t){var r,n=this;forEach$1(r=this.messages).call(r,(function(r){e===r.conversationId&&(!t||t&&r.createTime<t)&&n.messages.delete(r.messageClientId)}))},V2NIMMessageModel}(),km={accountId:{type:"string",allowEmpty:!1},content:{type:"object",required:!1,rules:{msg:{type:"string",allowEmpty:!1},type:{type:"number",allowEmpty:!1}}},messages:{type:"array",required:!1,rules:{msg:{type:"string",allowEmpty:!1},type:{type:"number"},role:{type:"enum",values:["assistant","user","system"]}}},promptVariables:{type:"jsonstr",required:!1},modelConfigParams:{type:"object",required:!1,rules:{prompt:{type:"string",required:!1},maxTokens:{type:"number",required:!1},topP:{type:"number",required:!1},temperature:{type:"number",required:!1}}}},wm=Et({requestId:{type:"string",allowEmpty:!1}},km),Am=[1,3,2,0],Nm=[2,7,12,100,6,1,-1,4,5,11,0,10,3],xm={routeEnabled:{type:"boolean",required:!1},routeEnvironment:{type:"string",required:!1}},Om={pushEnabled:{type:"boolean",required:!1},pushNickEnabled:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},forcePush:{type:"boolean",required:!1},forceContent:{type:"string",required:!1},forcePushAccountIds:{type:"array",required:!1,itemType:"string"}},Pm={antispamEnabled:{type:"boolean",required:!1},antispamBusinessId:{type:"string",required:!1},antispamCustomMessage:{type:"string",required:!1},antispamCheating:{type:"string",required:!1},antispamExtension:{type:"string",required:!1}},Lm={messageConfig:{type:"object",required:!1,rules:{readReceiptEnabled:{type:"boolean",required:!1},lastMessageUpdateEnabled:{type:"boolean",required:!1},historyEnabled:{type:"boolean",required:!1},roamingEnabled:{type:"boolean",required:!1},onlineSyncEnabled:{type:"boolean",required:!1},offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1}}},routeConfig:{type:"object",required:!1,rules:xm},pushConfig:{type:"object",required:!1,rules:Om},antiSpamConfig:{type:"object",required:!1,rules:Pm},robotConfig:{type:"object",required:!1,rules:{accountId:{type:"string",required:!1},topic:{type:"string",required:!1},function:{type:"string",required:!1},customContent:{type:"string",required:!1}}},aiConfig:{type:"object",required:!1,rules:km},targetConfig:{type:"object",required:!1,rules:{receiverIds:{type:"array",itemType:"string"},inclusive:{type:"boolean"},newMemberVisible:{type:"boolean",required:!1}}},clientAntispamEnabled:{type:"boolean",required:!1},clientAntispamReplace:{type:"string",required:!1}},Vm={message:{type:"object",rules:{text:{type:"string",required:!1},messageType:{type:"enum",values:Nm},messageClientId:{type:"string",allowEmpty:!1}}},params:{type:"object",rules:Lm,required:!1},replyMessage:{type:"object",rules:{conversationType:{type:"enum",values:[1,3,2,0]},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Um={conversationId:{type:"string",allowEmpty:!1},message:{type:"object",rules:{text:{type:"string",required:!1},messageType:{type:"enum",values:Nm},messageClientId:{type:"string",allowEmpty:!1},attachment:{type:"object",required:!1,rules:{file:{type:"file",required:!1}}}}},params:{type:"object",required:!1,rules:Lm}},Dm={message:{type:"object",rules:{messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:Am},createTime:{type:"number"}}},params:{type:"object",rules:{postscript:{type:"string",required:!1},serverExtension:{type:"string",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},env:{type:"string",required:!1}},required:!1}},qm={conversationId:{type:"string",allowEmpty:!1},messageTypes:{type:"array",required:!1,itemType:"enum",values:Nm},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",values:[1,0],required:!1},anchorMessage:{type:"object",required:!1,rules:{messageServerId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Bm={conversationType:{type:"enum",values:Am},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1}},Fm={messageRefers:{type:"array",required:!0,rules:Bm}},Gm={conversationId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:Am},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},Hm={messages:{type:"array",rules:Gm}},jm={conversationId:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1},onlineSync:{type:"boolean",required:!1},deleteRoam:{type:"boolean",required:!1}},$m={serverExtension:{type:"string",required:!1}},zm={messageClientId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[1]},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},Wm={messages:{type:"array",rules:{messageClientId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[2]},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"}},min:1}},Km={voiceUrl:{type:"string",required:!1,allowEmpty:!1},file:{type:"file",required:!1},voicePath:{type:"string",required:!1,allowEmpty:!1},mimeType:{type:"string",required:!1,allowEmpty:!1},sampleRate:{type:"string",required:!1,allowEmpty:!1},duration:{type:"number",required:!0,min:0},sceneName:{type:"string",required:!1}},Ym={message:{type:"object",rules:{conversationType:{type:"enum",values:Am},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}},index:{type:"number",min:1},serverExtension:{type:"string",required:!1},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},needBadge:{type:"boolean",required:!1},title:{type:"string",required:!1,allowEmpty:!1},content:{type:"string",required:!1,allowEmpty:!1},pushPayload:{type:"string",required:!1,allowEmpty:!1}}}},Qm={messages:{type:"array",rules:{conversationType:{type:"enum",values:[1,3,2,0]},receiverId:{type:"string",allowEmpty:!1},senderId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},messageClientId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Jm={params:{type:"object",rules:{collectionType:{type:"number",min:1},collectionData:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1},uniqueId:{type:"string",required:!1}}}},Xm={collections:{type:"array",min:1,rules:{collectionId:{type:"string",allowEmpty:!1},createTime:{type:"number"}}}},Zm={serverExtension:{type:"string",required:!1},collection:{type:"object",rules:{collectionId:{type:"string",allowEmpty:!1},collectionType:{type:"number"},createTime:{type:"number"}}}},eh={beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",required:!1,values:[1,0]},collectionType:{type:"number",required:!1},anchorCollection:{type:"object",required:!1,rules:{collectionId:{type:"string",allowEmpty:!1,required:!1},createTime:{type:"number",required:!1}}}},th={keyword:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},sortOrder:{type:"enum",values:[1,0],required:!1},conversationLimit:{type:"number",min:0,required:!1},messageLimit:{type:"number",min:1,required:!1},p2pAccountIds:{type:"array",required:!1,itemType:"string"},teamIds:{type:"array",required:!1,itemType:"string"},senderAccountIds:{type:"array",required:!1,itemType:"string"},messageTypes:{type:"array",required:!1,itemType:"enum",values:Nm},messageSubtypes:{type:"array",required:!1,itemType:"number"}},rh={message:{type:"object",rules:{receiverId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[2]}}}},nh={messages:{type:"array",rules:{receiverId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1},conversationType:{type:"enum",values:[2]}},min:1}},ah={sceneName:{type:"string",required:!1},name:{type:"string",required:!1}},ih=Et(Et({},ah),{duration:{type:"number",required:!1}}),oh=Et(Et({},ih),{width:{type:"number",required:!1},height:{type:"number",required:!1}}),sh=Et(Et({},ah),{width:{type:"number",required:!1},height:{type:"number",required:!1}}),ch={messageRefer:{type:"object",required:!0,rules:Bm},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,required:!1},direction:{type:"enum",values:[1,0],required:!1},excludeMessageServerId:{type:"string",required:!1,allowEmpty:!1}},lh={senderId:{type:"string",allowEmpty:!1},receiverId:{type:"string",allowEmpty:!1},createTime:{type:"number"},messageClientId:{type:"string",allowEmpty:!1},messageServerId:{type:"string",allowEmpty:!1}},dh={subType:{type:"number",min:0,required:!1},text:{type:"string",required:!1},attachment:{type:"object",required:!1},serverExtension:{type:"string",required:!1},routeConfig:{type:"object",required:!1,rules:xm},pushConfig:{type:"object",required:!1,rules:Om},antiSpamConfig:{type:"object",required:!1,rules:Pm},clientAntispamEnabled:{type:"boolean",required:!1},clientAntispamReplace:{type:"string",required:!1}},uh=function(){function ReceiptUtil(e,t){this.p2pMessageReceipts={},this.core=e,this.service=t}var e=ReceiptUtil.prototype;return e.sendP2PMessageReceipt=function sendP2PMessageReceipt(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(validate(zm,e,"",!0),e.senderId!==this.core.account){t.next=3;break}throw new Cl({detail:{reason:"sendP2PMessageReceipt. sender: "+e.senderId+" is not allowed to send msg receipt"}});case 3:if(!(this.p2pMessageReceipts[e.conversationId]>e.createTime)){t.next=5;break}return t.abrupt("return");case 5:return t.next=7,this.core.sendCmd("v2SendP2PMessageReceipt",{tag:{receiverId:e.senderId,messageClientId:e.messageClientId,createTime:e.createTime}});case 7:this.p2pMessageReceipts[e.conversationId]=e.createTime;case 8:case"end":return t.stop()}}),_callee,this)})))},e.isPeerRead=function isPeerRead(e){if(1!==e.conversationType)return!1;if(e.senderId!==this.core.account)return!1;if(e.senderId===this.core.account&&e.receiverId===this.core.account)return!0;var t=this.core.V2NIMConversationIdUtil.messageConversationId(e),r=this.p2pMessageReceipts[t]||0;return e.createTime<=r},e.getP2PMessageReceipt=function getP2PMessageReceipt(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:if(validateConversationId(this.core.account,e),1===this.core.V2NIMConversationIdUtil.parseConversationType(e)){t.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getP2PMessageReceipt: conversationId is not p2p conversationId"}});case 4:return t.abrupt("return",{conversationId:e,timestamp:this.p2pMessageReceipts[e]||0});case 5:case"end":return t.stop()}}),_callee2,this)})))},e.getTeamMessageReceipts=function getTeamMessageReceipts(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n=this;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:if(validate(nh,{messages:e},"",!0),!some(e).call(e,(function(e){return e.senderId!==n.core.account}))){a.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages senderId is not current user"}});case 3:if(!some(e).call(e,(function(t){return t.receiverId!==e[0].receiverId}))){a.next=5;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getTeamMessageReceipts: exist messages receiverId is not same"}});case 5:return a.next=7,this.core.sendCmd("v2GetTeamMessageReceipts",{tag:e});case 7:return r=a.sent,a.abrupt("return",map$6(t=r.content.data).call(t,(function(e){return Et(Et({},e),{conversationId:n.core.V2NIMConversationIdUtil.teamConversationId(e.receiverId)})})));case 9:case"end":return a.stop()}}),_callee3,this)})))},e.getTeamMessageReceiptDetail=function getTeamMessageReceiptDetail(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:if(validate(rh,{message:e},"",!0),e.senderId===this.core.account){r.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceiptDetail::senderId "+e.senderId+" incorrect"}});case 3:return r.next=5,this.core.sendCmd("v2GetTeamMessageReceiptDetail",{tag:e});case 5:return t=r.sent,r.abrupt("return",{readReceipt:{conversationId:this.core.V2NIMConversationIdUtil.teamConversationId(e.receiverId),messageClientId:e.messageClientId,messageServerId:e.messageServerId,readCount:t.content.readAccountList.length,unreadCount:t.content.unreadAccountList.length},readAccountList:t.content.readAccountList,unreadAccountList:t.content.unreadAccountList});case 7:case"end":return r.stop()}}),_callee4,this)})))},e.sendTeamMessageReceipts=function sendTeamMessageReceipts(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t=this;return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:if(!some(e).call(e,(function(t){return t.conversationId!==e[0].conversationId}))){r.next=2;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getTeamMessageReceipts: conversationId not same"}});case 2:if(validate(Wm,{messages:e},"",!0),!some(e).call(e,(function(e){return e.senderId===t.core.account}))){r.next=5;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getTeamMessageReceipts: exist messages senderId is not current user"}});case 5:return r.next=7,this.core.sendCmd("v2SendTeamMessageReceipts",{tag:e});case 7:return r.abrupt("return");case 8:case"end":return r.stop()}}),_callee5,this)})))},e.syncP2PMessagReceiptsHandler=function syncP2PMessagReceiptsHandler(e){var t,r=this,n=map$6(t=e.content.data).call(t,(function(e){var t=r.core.V2NIMConversationIdUtil.p2pConversationId(e.senderId),n=e.createTime;return r.p2pMessageReceipts[t]=n,{conversationId:t,timestamp:n}}));this.service.emit("onReceiveP2PMessageReadReceipts",n)},e.onP2PMessageReceiptsHandler=function onP2PMessageReceiptsHandler(e){var t=this.core.V2NIMConversationIdUtil.p2pConversationId(e.content.data.senderId),r=e.content.data.createTime;this.p2pMessageReceipts[t]=r,this.service.emit("onReceiveP2PMessageReadReceipts",[{conversationId:t,timestamp:r}])},e.onTeamMessageReceiptsHandler=function onTeamMessageReceiptsHandler(e){var t,r=this,n=map$6(t=e.content.data).call(t,(function(e){return{conversationId:r.core.V2NIMConversationIdUtil.teamConversationId(e.receiverId),messageServerId:e.messageServerId,messageClientId:e.messageClientId,readCount:e.readCount,unreadCount:e.unreadCount,latestReadAccount:e.latestReadAccount}}));this.service.emit("onReceiveTeamMessageReadReceipts",n)},ReceiptUtil}(),ph=function(){function FileUtil(e){this.core=e}var e=FileUtil.prototype;return e.doSendFile=function doSendFile(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i,o,s,c,l;return Dl.wrap((function _callee$(d){for(;;)switch(d.prev=d.next){case 0:return r=e.attachment,d.prev=1,d.next=4,this.core.V2NIMStorageService._uploadFile({taskId:e.messageClientId,uploadParams:{fileObj:(null==r?void 0:r.file)||(null==r?void 0:r.path),sceneName:null==r?void 0:r.sceneName}},t,{fileType:e.messageType});case 4:for(c in(a=d.sent)[0],i=a[1],o=Et(Et({},r),{uploadState:1}),void 0!==i.w&&(o.width=o.width||i.w),void 0!==i.h&&(o.height=o.height||i.h),void 0!==i.dur&&(o.duration=o.duration||i.dur),o.ext=o.ext&&-1===indexOf(n=o.ext).call(n,".")?"."+o.ext:o.ext,s=["w","h","dur","ext","name"],i)includes(s).call(s,c)||(o[c]=i[c]);o.raw,o.file,o.path,l=__rest(o,["raw","file","path"]),e.attachment=JSON.parse(bn(l)),e.attachment&&(e.attachment.raw=attachmentToRaw(e.messageType,e.attachment)),d.next=23;break;case 19:throw d.prev=19,d.t0=d.catch(1),e.attachment&&(e.attachment.uploadState=2),d.t0;case 23:case"end":return d.stop()}}),_callee,this,[[1,19]])})))},e.cancelMessageAttachmentUpload=function cancelMessageAttachmentUpload(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t;return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:if(validate({messageClientId:{type:"string",allowEmpty:!1}},e,"",!0),includes(t=[2,6,1,3]).call(t,e.messageType)){r.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"cancelMessageAttachmentUpload: messageType "+e.messageType+" incorrect"}});case 3:if(2!==e.sendingState&&1!==e.sendingState){r.next=5;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST,detail:{reason:"cancelMessageAttachmentUpload: message is already failed or succeeded"}});case 5:return r.next=7,this.core.V2NIMStorageService._cancelUploadFile(e.messageClientId);case 7:case"end":return r.stop()}}),_callee2,this)})))},FileUtil}(),mh="V2NIMNotificationService",gh={"30_7":"v2SendCustomNotification","32_16":"v2SendCustomNotificationWithSuperTeam","7_3":"onSysNotification","21_19":"onSysNotification","4_6":"v2SyncOfflineSysNotifications","4_18":"v2SyncOfflineSysNotifications","7_14":"v2NotificationRevoke","21_18":"v2NotificationRevoke","21_117":"v2NotificationRevoke","4_19":"v2NotificationSyncRevoke","7_15":"v2NotificationSyncRevoke","4_16":"syncBroadcastMsg","7_17":"onBroadcastMsg"},vh={timestamp:{id:0,retType:"number"},type:{id:1,retType:"number"},receiverId:2,senderId:3,postscript:4,content:5,idServer:6,offlineEnabled:{id:7,converter:boolToInt,retConverter:function retConverter(e,t){return"0"!==t[6]&&!!bd(e)},access:"notificationConfig.offlineEnabled"},pushContent:{id:8,access:"pushConfig.pushContent"},pushPayload:{id:9,access:"pushConfig.pushPayload"},deletedIdClient:10,deletedIdServer:11,antispamEnabled:{id:12,converter:boolToInt,retType:"boolean",access:"antispamConfig.antispamEnabled"},antispamCustomNotification:{id:13,access:"antispamConfig.antispamCustomNotification"},deletedMsgCreateTime:14,deletedMsgFromNick:15,opeAccount:16,forcePushAccountIds:{id:18,access:"pushConfig.forcePushAccountIds",def:function def(e){if(101===e.type&&e["pushConfig.forcePush"])return"#%@all@%#"},converter:function converter(e,t){if(t["pushConfig.forcePush"])return e?bn(e):"#%@all@%#"}},forcePushContent:{id:19,access:"pushConfig.forcePushContent"},forcePush:{id:20,converter:boolToInt,retType:"boolean",access:"pushConfig.forcePush"},routeEnvironment:{id:21,access:"routeConfig.routeEnvironment"},callbackExt:22,clientNotificationId:{id:23,access:"notificationConfig.clientNotificationId"},conversationOnlineSyncNotify:24,conversationOnlineSyncData:25,routeEnabled:{id:105,converter:boolToInt,retType:"boolean",access:"routeConfig.routeEnabled"},pushEnabled:{id:107,converter:boolToInt,retType:"boolean",access:"pushConfig.pushEnabled"},unreadEnabled:{id:109,converter:boolToInt,retType:"boolean",access:"notificationConfig.unreadEnabled"},pushNickEnabled:{id:110,converter:boolToInt,retType:"boolean",access:"pushConfig.pushNickEnabled"}},fh={id:1,senderId:2,timestamp:{id:4,retType:"number"},content:5},yh={v2SendCustomNotification:{sid:30,cid:7,service:mh,params:[{type:"Property",name:"tag",reflectMapper:vh}]},v2SendCustomNotificationWithSuperTeam:{sid:32,cid:16,service:mh,params:[{type:"Property",name:"tag",reflectMapper:vh}]},onSysNotification:{sid:7,cid:3,service:mh,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(vh)}]},syncBroadcastMsg:{sid:4,cid:16,service:mh,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(fh)}]},onBroadcastMsg:{sid:7,cid:17,service:mh,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(fh)}]},v2SyncOfflineSysNotifications:{sid:4,cid:9,service:mh,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(vh)}]},v2NotificationRevoke:{sid:7,cid:14,service:mh,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(vh)}]},v2NotificationSyncRevoke:{sid:7,cid:15,service:mh,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(vh)},{type:"Long",name:"timetag"},{type:"Byte",name:"type"}]}},_h="YSFService",Mh={"4_5":"ysfBatchMarkRead","101_1":"ysfSendMessage","101_2":"ysfOnMsg","4_100":"ysfSyncOfflineMsgs","101_3":"ysfOnSysNotification","101_7":"ysfSendCustomNotification","4_101":"ysfSyncSysNotification"},Ih={ysfBatchMarkRead:{sid:4,cid:5,service:_h,hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},ysfSendMessage:{sid:101,cid:1,service:_h,params:[{type:"Property",name:"tag",reflectMapper:tm}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},ysfOnMsg:{sid:101,cid:2,service:_h,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(tm)}]},ysfSyncOfflineMsgs:{sid:4,cid:100,service:_h,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(tm)}]},ysfOnSysNotification:{sid:101,cid:3,service:_h,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(vh)}]},ysfSendCustomNotification:{sid:101,cid:7,service:_h,params:[{type:"Property",name:"tag",reflectMapper:vh}]},ysfSyncSysNotification:{sid:4,cid:101,service:_h,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(vh)}]}},Sh={content:{type:"string",allowEmpty:!1},params:{type:"object",required:!1,rules:{notificationConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushNickEnabled:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},forcePush:{type:"boolean",required:!1},forcePushContent:{type:"string",required:!1},forcePushAccounts:{type:"array",required:!1,itemType:"string"}}},antispamConfig:{type:"object",required:!1,rules:{antispamEnabled:{type:"boolean",required:!1},antispamCustomNotification:{type:"string",required:!1}}},routeConfig:{type:"object",required:!1,rules:{routeEnabled:{type:"boolean",required:!1},routeEnvironment:{type:"string",required:!1}}}}}},Th=function(){function NotificationUtil(e){this.core=e}return NotificationUtil.prototype.generateNotificationTag=function generateNotificationTag(e,t,r){var n;void 0===r&&(r={});var a=this.core.V2NIMConversationIdUtil.parseConversationType(e),i=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e),o=Hi(),s=((n={})[1]=100,n[2]=101,n[3]=103,n);return Et(Et({},r),{notificationConfig:Et({unreadEnabled:!0,offlineEnabled:!0},null==r?void 0:r.notificationConfig),pushConfig:Et({pushEnabled:!0,pushNickEnabled:!0},null==r?void 0:r.pushConfig),antispamConfig:Et({antispamEnabled:!0},null==r?void 0:r.antispamConfig),routeConfig:Et({routeEnabled:!0},null==r?void 0:r.routeConfig),timestamp:o,type:s[a],receiverId:i,content:t})},NotificationUtil}();function getFileOrPath(e){var t="object"==typeof e?e:void 0,r="string"==typeof e?e:void 0;if(!t&&!r)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getFileOrPath::incorrect file and path"}});if("string"==typeof r)if(0===indexOf(r).call(r,"nim-external")){var n=document.getElementById(r);if(!(n&&n.files&&n.files[0]))throw new Sl({code:_l.V2NIM_ERROR_CODE_FILE_NOT_FOUND,detail:{reason:"getFileOrPath::file not exist: "+r}});t=n.files[0]}else if("BROWSER"===ql.platform)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getFileOrPath::incorrect path: "+r}});if("object"==typeof t&&void 0===t.size)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"getFileOrPath::file no size"}});return{file:t,path:r}}var Ch,bh,Eh={attachment:{type:"object",rules:{url:{type:"string",allowEmpty:!1}}},thumbSize:{type:"object",rules:{width:{type:"number",required:!1,min:0},height:{type:"number",required:!1,min:0}}}},Rh=function(e){function V2NIMStorageUtil(t){var r;return(r=e.call(this,"V2NIMStorageUtil",t)||this).core=t,r}_t(V2NIMStorageUtil,e);var t=V2NIMStorageUtil.prototype;return t.imageThumbUrl=function imageThumbUrl(e,t){return e+"?imageView&thumbnail="+t+"z"+t},t.videoCoverUrl=function videoCoverUrl(e,t){return e+"?vframe&offset="+t},t.getImageThumbUrl=function getImageThumbUrl(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n;return Dl.wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate(Eh,{attachment:r=e,thumbSize:t},"",!0),t.width=t.width||0,t.height=t.height||0,0===t.width&&0===t.height&&(t.width=150),n=r.url,a.prev=7,a.next=10,this.core.V2NIMStorageService.shortUrlToLong(r.url);case 10:n=a.sent,a.next=16;break;case 13:a.prev=13,a.t0=a.catch(7),this.core.logger.warn("shortUrlToLong error:",a.t0);case 16:return a.abrupt("return",{url:this.core.cloudStorage.getThumbUrl(n,t)});case 17:case"end":return a.stop()}}),_callee,this,[[7,13]])})))},t.getVideoCoverUrl=function getVideoCoverUrl(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n;return Dl.wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate(Eh,{attachment:r=e,thumbSize:t},"",!0),t.width=t.width||0,t.height=t.height||0,0===t.width&&0===t.height&&(t.width=150),n=r.url,a.prev=7,a.next=10,this.core.V2NIMStorageService.shortUrlToLong(r.url);case 10:n=a.sent,a.next=16;break;case 13:a.prev=13,a.t0=a.catch(7),this.core.logger.warn("shortUrlToLong error:",a.t0);case 16:return a.abrupt("return",{url:this.core.cloudStorage.getVideoCoverUrl(n,t)});case 17:case"end":return a.stop()}}),_callee2,this,[[7,13]])})))},V2NIMStorageUtil}(Ru),kh={file:{md5:"$(Etag)",size:"$(ObjectSize)"},image:{md5:"$(Etag)",size:"$(ObjectSize)",w:"$(ImageInfo.Width)",h:"$(ImageInfo.Height)",orientation:"$(ImageInfo.Orientation)"},audio:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Audio.Duration)"},video:{md5:"$(Etag)",size:"$(ObjectSize)",dur:"$(AVinfo.Video.Duration)",w:"$(AVinfo.Video.Width)",h:"$(AVinfo.Video.Height)"}},wh={accessKeyId:"",secretAccessKey:"",sessionToken:"",region:"",maxRetries:0,bucket:"",objectName:"",token:"",shortUrl:""};function getUploadResponseFormat(e){return void 0===e&&(e="file"),bn(kh[e]||{}).replace(/"/gi,'\\"')}!function(e){e[e.nos=1]="nos",e[e.s3=2]="s3"}(Ch||(Ch={})),function(e){e[e.dontNeed=-1]="dontNeed",e[e.time=2]="time",e[e.urls=3]="urls"}(bh||(bh={}));var Ah={chunkUploadHost:"https://wannos-web.127.net",chunkUploadHostBackupList:["https://fileup.chatnos.com","https://oss.chatnos.com"],commonUploadHost:"https://fileup.chatnos.com",commonUploadHostBackupList:["https://oss.chatnos.com"],chunkMaxSize:4194304e4,commonMaxSize:104857600,uploadReplaceFormat:"https://{host}/{object}",cdn:{defaultCdnDomain:"nim-nosdn.netease.im",cdnDomain:"",bucket:"",objectNamePrefix:""},downloadUrl:"https://{bucket}-nosdn.netease.im/{object}",downloadHostList:["nos.netease.com"],nosCdnEnable:!0,isNeedToGetUploadPolicyFromServer:!0};function pickBy(e,t){e=e||{},t=t||function(){return!0};var r={};for(var n in e)t(e[n])&&(r[n]=e[n]);return r}var Nh=function(){function NOS(e,t){this.nosCdnHostTimer=0,this.nosErrorCount=0,this.core=e,this.cloudStorage=t}var e=NOS.prototype;return e.reset=function reset(){this.nosErrorCount=0},e.getNosAccessToken=function getNosAccessToken(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n;return Dl.wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.core.sendCmd("getNosAccessToken",{tag:e});case 2:return t=a.sent,r=get(t,"content.nosAccessTokenTag.token"),n=e.url,a.abrupt("return",{token:r,url:-1!==indexOf(n).call(n,"?")?n+"&token="+r:n+"?token="+r});case 6:case"end":return a.stop()}}),_callee,this)})))},e.deleteNosAccessToken=function deleteNosAccessToken(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.core.sendCmd("deleteNosAccessToken",{tag:e});case 2:case"end":return t.stop()}}),_callee2,this)})))},e.nosUpload=function nosUpload(e,t){var r,n,a,i,o,s,c,l;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var d,u,p,m,h,g,v,f,y,M,I,S,T,C,b,E,R,k,w;return Dl.wrap((function _callee3$(A){for(;;)switch(A.prev=A.next){case 0:if(d=get(this.core,"config.cdn.bucket"),u={tag:e.nosScenes||d||"nim"},e.nosSurvivalTime&&(u.expireSec=e.nosSurvivalTime),p=this.core.adapters.getFileUploadInformation(e),!(!t&&!p)){A.next=18;break}return A.prev=6,A.next=9,this.core.sendCmd("getNosToken",{responseBody:getUploadResponseFormat(e.type),nosToken:u});case 9:m=A.sent,A.next=18;break;case 12:if(A.prev=12,A.t0=A.catch(6),this.core.logger.error("uploadFile:: getNosToken error",A.t0),!(A.t0 instanceof Sl)){A.next=17;break}throw A.t0;case 17:throw new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"getNosToken error",rawError:A.t0,curProvider:1}});case 18:return h=this.config.uploadReplaceFormat.replace("{host}",this.config.cdn.cdnDomain||this.config.cdn.defaultCdnDomain).replace("{object}",p?null===(r=p.uploadInfo)||void 0===r?void 0:r.objectName:t?null==t?void 0:t.objectName:m.content.nosToken.objectName),g="",t&&t.shortUrl&&(g=t.shortUrl),(null===(i=null===(a=null===(n=null==p?void 0:p.uploadInfo)||void 0===n?void 0:n.payload)||void 0===a?void 0:a.mixStoreToken)||void 0===i?void 0:i.shortUrl)&&(g=p.uploadInfo.payload.mixStoreToken.shortUrl),v=g||h,A.prev=23,y=p?{token:null===(o=null==p?void 0:p.uploadInfo)||void 0===o?void 0:o.token,bucket:null===(s=null==p?void 0:p.uploadInfo)||void 0===s?void 0:s.bucketName,objectName:null===(c=null==p?void 0:p.uploadInfo)||void 0===c?void 0:c.objectName}:t||m.content.nosToken,this.core.logger.log("uploadFile:: uploadFile params",{nosToken:y,chunkUploadHost:this.config.chunkUploadHost,chunkUploadHostBackupList:this.config.chunkUploadHostBackupList,commonUploadHost:this.config.commonUploadHost,commonUploadHostBackupList:this.config.commonUploadHostBackupList,platform:ql.platform}),M="BROWSER"===ql.platform?this.config.chunkUploadHost:this.config.commonUploadHost+"/"+(y&&y.bucket),this.core.reporterHookCloudStorage.update({remote_addr:M,operation_type:t?2:0}),A.next=30,this.core.adapters.uploadFile(Et(Et(Et({},e),{nosToken:y,chunkUploadHost:this.config.chunkUploadHost,chunkUploadHostBackupList:this.config.chunkUploadHostBackupList,commonUploadHost:this.config.commonUploadHost,commonUploadHostBackupList:this.config.commonUploadHostBackupList,maxSize:e.maxSize||this.config.chunkMaxSize}),t?{payload:{mixStoreToken:t}}:{}));case 30:f=A.sent,A.next=65;break;case 33:if(A.prev=33,A.t1=A.catch(23),this.core.logger.error("uploadFile::nos uploadFile error:",A.t1),I="v2"===get(this.core,"options.apiVersion"),A.t1.code!==_l.V2NIM_ERROR_CODE_CANCELLED&&10499!==A.t1.errCode){A.next=39;break}throw new El({code:I?_l.V2NIM_ERROR_CODE_CANCELLED:400,detail:{reason:get(A.t1,"message")||"Request abort",rawError:A.t1,curProvider:1}});case 39:if(!I||A.t1.errCode!==_l.V2NIM_ERROR_CODE_FILE_OPEN_FAILED){A.next=41;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_FILE_OPEN_FAILED,detail:{reason:get(A.t1,"message")||"Read file failed",rawError:A.t1,curProvider:1}});case 41:return A.next=43,ql.net.getNetworkStatus();case 43:if(S=A.sent,!1!==S.net_connect){A.next=47;break}throw new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"No network",rawError:A.t1,curProvider:1}});case 47:if(!t){A.next=64;break}if(!(this.nosErrorCount<=0)){A.next=60;break}A.prev=49,this.cloudStorage.mixStorage._addCircuitTimer(),A.next=56;break;case 53:throw A.prev=53,A.t2=A.catch(49),new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"All upload attempts failed",rawError:A.t2,curProvider:this.cloudStorage.mixStorage.curProvider,mixStorePolicy:this.cloudStorage.mixStorage.mixStorePolicy,file:e.file||e.filePath}});case 56:return this.nosErrorCount=get(this.cloudStorage,"mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry"),A.abrupt("return",this.cloudStorage._uploadFile(e));case 60:return this.nosErrorCount--,A.abrupt("return",this.nosUpload(e,t));case 62:A.next=65;break;case 64:throw new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"NOS attempts failed",rawError:A.t1,curProvider:1}});case 65:if(T=null==f?void 0:f.type,(C=T&&indexOf(T).call(T,"/")>-1?slice(T).call(T,0,indexOf(T).call(T,"/")):"")||(C=e.type||""),(b={image:"imageInfo",video:"vinfo",audio:"vinfo"})[C]){A.next=71;break}return A.abrupt("return",Et({url:v},f));case 71:return A.prev=71,A.next=74,this.core.adapters.request(h+"?"+b[C],{method:"GET",dataType:"json",timeout:5e3},{exception_service:3});case 74:E=A.sent,A.next=81;break;case 77:return A.prev=77,A.t3=A.catch(71),this.core.logger.error("uploadFile:: fetch file info error",A.t3),A.abrupt("return",Et({url:v},f));case 81:if(!E){A.next=88;break}return R=E.data,k="imageInfo"===b[C]?R:null===(l=null==R?void 0:R.GetVideoInfo)||void 0===l?void 0:l.VideoInfo,w={url:v,name:f.name,size:f.size,ext:f.ext,w:null==k?void 0:k.Width,h:null==k?void 0:k.Height,orientation:null==k?void 0:k.Orientation,dur:null==k?void 0:k.Duration,audioCodec:null==k?void 0:k.AudioCodec,videoCodec:null==k?void 0:k.VideoCodec,container:null==k?void 0:k.Container},A.abrupt("return",pickBy(w,(function(e){return void 0!==e})));case 88:return A.abrupt("return",Et({url:v},f));case 89:case"end":return A.stop()}}),_callee3,this,[[6,12],[23,33],[49,53],[71,77]])})))},e._getNosCdnHost=function _getNosCdnHost(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t,r,n,a=this;return Dl.wrap((function _callee4$(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,this.core.sendCmd("getNosCdnHost");case 3:t=i.sent,i.next=10;break;case 6:return i.prev=6,i.t0=i.catch(0),this.core.logger.error("getNosCdnHost::error",i.t0),i.abrupt("return");case 10:if(t){i.next=12;break}return i.abrupt("return");case 12:r=null===(e=null==t?void 0:t.content)||void 0===e?void 0:e.nosConfigTag,0!==(n=bd(null==r?void 0:r.expire))&&r.cdnDomain?-1===n?(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix):(this.config.cdn.bucket=r.bucket,this.config.cdn.cdnDomain=r.cdnDomain,this.config.cdn.objectNamePrefix=r.objectNamePrefix,this.nosCdnHostTimer=this.core.timerManager.addTimer((function(){a._getNosCdnHost()}),1e3*n)):(this.config.cdn.bucket="",this.config.cdn.cdnDomain="",this.config.cdn.objectNamePrefix="");case 15:case"end":return i.stop()}}),_callee4,this,[[0,6]])})))},Ue(NOS,[{key:"config",get:function get(){return this.cloudStorage.config}}]),NOS}(),xh={"6_2":"getNosToken","6_22":"getOriginUrl","6_24":"getNosAccessToken","6_25":"deleteNosAccessToken","6_26":"getNosCdnHost","6_27":"getGrayscaleConfig","6_28":"getMixStorePolicy","6_29":"getMixStoreToken","6_30":"getFileAuthToken"},Oh={nosToken:{objectName:1,token:2,bucket:3,expireTime:4,expireSec:7,tag:8,shortUrl:9},mixStoreTokenReqTag:{provider:0,tokenCount:1,nosSurvivalTime:2,tag:3,returnBody:4,policyVersion:5},nosConfigTag:{bucket:1,cdnDomain:2,expire:3,objectNamePrefix:4},grayConfigTag:{config:0,ttl:1},mixStorePolicyTag:{providers:0,ttl:1,mixEnable:2,nosPolicy:3,s3Policy:4,policyVersion:5},mixStoreTokenResTag:{provider:0,accessKeyId:1,secretAccessKey:2,sessionToken:3,token:4,expireTime:5,bucket:6,objectName:7,fileExpireSec:8,tag:9,shortUrl:10,region:11},nosSafeUrlTag:{safeUrl:0,originUrl:1},mixStoreAuthTokenReqTag:{type:1,urls:2},mixStoreAuthTokenResTag:{type:1,tokens:2,token:3,ttl:4},nosAccessTokenTag:{token:0,url:1,userAgent:2,ext:3}},Ph={getNosToken:{sid:6,cid:2,service:"cloudStorage",params:[{type:"String",name:"responseBody"},{type:"Property",name:"nosToken",entity:"nosToken",reflectMapper:Oh.nosToken}],response:[{type:"Property",name:"nosToken",reflectMapper:invert(Oh.nosToken)}]},getOriginUrl:{sid:6,cid:22,service:"cloudStorage",params:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:Oh.nosSafeUrlTag}],response:[{type:"Property",name:"nosSafeUrlTag",reflectMapper:invert(Oh.nosSafeUrlTag)}]},getNosCdnHost:{sid:6,cid:26,service:"cloudStorage",response:[{type:"Property",name:"nosConfigTag",reflectMapper:invert(Oh.nosConfigTag)}]},getGrayscaleConfig:{sid:6,cid:27,service:"cloudStorage",params:[{type:"Property",name:"config"}],response:[{type:"Property",name:"grayConfigTag",reflectMapper:invert(Oh.grayConfigTag)}]},getMixStorePolicy:{sid:6,cid:28,service:"cloudStorage",params:[{type:"LongArray",name:"supportType"}],response:[{type:"Property",name:"mixStorePolicyTag",reflectMapper:invert(Oh.mixStorePolicyTag)}]},getMixStoreToken:{sid:6,cid:29,service:"cloudStorage",params:[{type:"Property",name:"mixStoreTokenReqTag",reflectMapper:Oh.mixStoreTokenReqTag}],response:[{type:"Property",name:"mixStoreTokenResTag",reflectMapper:invert(Oh.mixStoreTokenResTag)}]},getFileAuthToken:{sid:6,cid:30,service:"cloudStorage",params:[{type:"Property",name:"mixStoreAuthTokenReqTag",reflectMapper:Oh.mixStoreAuthTokenReqTag}],response:[{type:"Property",name:"mixStoreAuthTokenResTag",reflectMapper:invert(Oh.mixStoreAuthTokenResTag)}]},getNosAccessToken:{sid:6,cid:24,service:"cloudStorage",params:[{type:"Property",name:"tag",reflectMapper:Oh.nosAccessTokenTag}],response:[{type:"Property",name:"tag",reflectMapper:invert(Oh.nosAccessTokenTag)}]},deleteNosAccessToken:{sid:6,cid:25,service:"cloudStorage",params:[{type:"Property",name:"tag",reflectMapper:Oh.nosAccessTokenTag}]}},Lh=function(){function MixStorage(e,t){this.GRAYKEY="AllGrayscaleConfig",this.MIXSTOREKEY="AllMixStorePolicy",this.grayConfig={mixStoreEnable:!1,timeStamp:0,ttl:0},this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null,policyVersion:void 0},this.curProvider=1,this.mixStoreErrorCount=10,this.circuitTimer=0,this.core=e,this.cloudStorage=t,this.logger=e.logger}var e=MixStorage.prototype;return e.reset=function reset(){this.grayConfig=null,this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null,policyVersion:void 0},this.curProvider=1,this.mixStoreErrorCount=10},e.getGrayscaleConfig=function getGrayscaleConfig(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n;return Dl.wrap((function _callee$(a){for(;;)switch(a.prev=a.next){case 0:if(ql.localStorage)try{ql.localStorage.getItem&&ql.localStorage.getItem(this.GRAYKEY)&&(this.grayConfig=JSON.parse(ql.localStorage.getItem(this.GRAYKEY))[e])}catch(e){ql.localStorage.getItem(this.GRAYKEY)&&this.core.logger.error("uploadFile:: JSON.parse grayscaleConfig error ",e)}if(this.grayConfig&&!(this.grayConfig.timeStamp+1e3*this.grayConfig.ttl<(new Date).getTime())){a.next=17;break}return a.next=4,this.core.sendCmd("getGrayscaleConfig",{config:{}});case 4:if(!(r=a.sent).content||!r.content.grayConfigTag){a.next=16;break}this.logger.log("uploadFile::getAppGrayConfigRequest success ");try{this.grayConfig=JSON.parse(r.content.grayConfigTag.config),this.grayConfig.ttl=JSON.parse(r.content.grayConfigTag.ttl)}catch(e){this.logger.error("getGrayscaleConfig error",e)}if(this.grayConfig){a.next=10;break}return a.abrupt("return");case 10:n=ql.localStorage.getItem(this.GRAYKEY)?JSON.parse(ql.localStorage.getItem(this.GRAYKEY)):{},this.grayConfig.timeStamp=(new Date).getTime(),n[e]=this.grayConfig,ql.localStorage.setItem(this.GRAYKEY,bn(n)),a.next=17;break;case 16:this.logger.log("uploadFile:: result grayConfig:",r.content);case 17:if(!(null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable)){a.next=20;break}return a.next=20,this._getMixStorePolicy(e);case 20:case"end":return a.stop()}}),_callee,this)})))},e._getMixStorePolicy=function _getMixStorePolicy(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i,o,s;return Dl.wrap((function _callee2$(c){for(;;)switch(c.prev=c.next){case 0:if(t=(new Date).getTime(),ql.localStorage)try{this.mixStorePolicy=JSON.parse(ql.localStorage.getItem(this.MIXSTOREKEY))[e],this.curProvider=bd(this.mixStorePolicy.providers[0]),this.mixStorePolicy.timeStamp&&this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl>t&&(n=this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl-t,this.core.timerManager.addTimer(bind$1(r=this._getMixStorePolicy).call(r,this,e),n))}catch(t){ql.localStorage.getItem(this.MIXSTOREKEY)&&JSON.parse(ql.localStorage.getItem(this.MIXSTOREKEY))[e]&&this.core.logger.error("uploadFile:: JSON.parse mixStorePolicy error ",t)}if(this.mixStorePolicy&&!(this.mixStorePolicy.timeStamp+1e3*this.mixStorePolicy.ttl<=t)){c.next=31;break}return c.prev=3,c.next=6,this.core.sendCmd("getMixStorePolicy",{supportType:this.cloudStorage.aws.s3?[1,2]:[1]});case 6:i=c.sent,o=i.content.mixStorePolicyTag,this.mixStorePolicy={providers:[],timeStamp:0,ttl:0,s3Policy:null,nosPolicy:null,policyVersion:void 0},this.mixStorePolicy.policyVersion=o.policyVersion,this.mixStorePolicy.ttl=Number(o.ttl),this.mixStorePolicy.providers=o.providers.split(","),this.circuitTimer&&this.core.timerManager.deleteTimer(this.circuitTimer),this.curProvider=bd(this.mixStorePolicy.providers[0]),this.mixStorePolicy.nosPolicy=o.nosPolicy?JSON.parse(o.nosPolicy):null,this.mixStorePolicy.s3Policy=o.s3Policy?JSON.parse(o.s3Policy):null,null===this.mixStorePolicy.s3Policy?this.mixStorePolicy.providers=["1"]:null===this.mixStorePolicy.nosPolicy?this.mixStorePolicy.providers=["2"]:this.mixStorePolicy.providers=this.mixStorePolicy.s3Policy.priority<this.mixStorePolicy.nosPolicy.priority?["2","1"]:["1","2"],this.core.timerManager.addTimer(bind$1(a=this._getMixStorePolicy).call(a,this,e),1e3*this.mixStorePolicy.ttl),s=ql.localStorage.getItem(this.MIXSTOREKEY)?JSON.parse(ql.localStorage.getItem(this.MIXSTOREKEY)):{},this.mixStorePolicy.timeStamp=(new Date).getTime(),s[e]=this.mixStorePolicy,ql.localStorage.setItem(this.MIXSTOREKEY,bn(s)),c.next=31;break;case 24:if(c.prev=24,c.t0=c.catch(3),this.logger.error("getMixStorePolicy error",c.t0),0!==this.mixStoreErrorCount){c.next=29;break}throw new Error("getMixStorePolicy all count error");case 29:this._getMixStorePolicy(e),this.mixStoreErrorCount--;case 31:this.mixStorePolicy.nosPolicy&&(this.cloudStorage.nos.nosErrorCount=this.mixStorePolicy.nosPolicy.uploadConfig.retryPolicy.retry);case 32:case"end":return c.stop()}}),_callee2,this,[[3,24]])})))},e._addCircuitTimer=function _addCircuitTimer(){var e=this,t=this.mixStorePolicy.providers,r=t[(indexOf(t).call(t,String(this.curProvider))+1)%t.length];if(!r)throw new Error("uploadFile nextProvider error");if(r===t[0])throw new Error("uploadFile all policy fail");if(this.logger.log("uploadFile:: upload policy will change,now policy:"+this.curProvider+" nextProvider:"+r),this.curProvider=bd(r),this.mixStorePolicy.nosPolicy&&this.mixStorePolicy.s3Policy){var n=this.mixStorePolicy[1===this.curProvider?"nosPolicy":"s3Policy"].uploadConfig.retryPolicy.circuit;if(!n||0===n)throw new Error("uploadFile circuit error");this.circuitTimer=this.core.timerManager.addTimer((function(){e.logger.log("uploadFile:: upload policy will change,now policy:"+e.curProvider+" nextProvider:"+bd(e.mixStorePolicy.providers[0])),e.curProvider=bd(e.mixStorePolicy.providers[0]),e.core.timerManager.deleteTimer(e.circuitTimer)}),1e3*n)}throw new Error("uploadFile will not retry again")},e.getFileAuthToken=function getFileAuthToken(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.core.sendCmd("getFileAuthToken",{mixStoreAuthTokenReqTag:e});case 2:return t=r.sent,r.abrupt("return",t.content.mixStoreAuthTokenResTag);case 4:case"end":return r.stop()}}),_callee3,this)})))},MixStorage}(),Vh=-1,Uh=function(){function AWS(e,t){this.s3=null,this.core=e,this.cloudStorage=t,this.logger=e.logger}var e=AWS.prototype;return e.s3Upload=function s3Upload(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n,a,i,o,s,c,l,d,u,p,m,h,g,v=this;return Dl.wrap((function _callee2$(f){for(;;)switch(f.prev=f.next){case 0:if(Vh+=1,!e.file){f.next=5;break}r=e.file,f.next=20;break;case 5:if("string"!=typeof e.fileInput){f.next=15;break}if(this.logger.warn("fileInput will abandon,Please use file or filepath"),!((n=document.getElementById(e.fileInput))&&n.files&&n.files[0])){f.next=12;break}r=n.files[0],f.next=13;break;case 12:throw new Error("Can not get file from fileInput");case 13:f.next=20;break;case 15:if(!(e.fileInput&&e.fileInput.files&&e.fileInput.files[0])){f.next=19;break}r=e.fileInput.files[0],f.next=20;break;case 19:throw new Error("Can not get file from fileInput "+e.fileInput);case 20:if(this.mixStorePolicy.s3Policy){f.next=22;break}throw new Error("dont get s3 policy");case 22:return a={accessKeyId:t.accessKeyId,secretAccessKey:t.secretAccessKey,sessionToken:t.sessionToken,region:t.region,maxRetries:this.mixStorePolicy.s3Policy.uploadConfig.retryPolicy.retry},i=this.s3,o=decodeURIComponent(t.bucket),s=decodeURIComponent(t.objectName),c=r,l="https://"+o+".s3.amazonaws.com/"+s,d={},(u=this.mixStorePolicy.s3Policy)&&u.uploadConfig&&En(u.uploadConfig.uploadUrl)&&u.uploadConfig.uploadUrl.length>0&&(p=u.uploadConfig.uploadUrl.length,Vh%=p,d.endpoint=u.uploadConfig.uploadUrl[Vh],d.s3ForcePathStyle=!0,l=d.endpoint+"/"+o+"/"+s),this.core.reporterHookCloudStorage.update({remote_addr:l,operation_type:1}),(m=new i(d)).config.update(a),h={Bucket:o,Key:s,Body:c,Metadata:{token:t.token},ContentType:c.type||"application/octet-stream"},this.core.logger.log("uploadFile:: s3 upload params:",h),(g=m.upload(h)).on("httpUploadProgress",(function(t){var r=Qd((t.loaded/t.total).toFixed(2));e.onUploadProgress&&e.onUploadProgress({total:t.total,loaded:t.loaded,percentage:r,percentageText:Math.round(100*r)+"%"})})),f.abrupt("return",new Pi((function(r,n){var a=(new Date).getTime();g.send((function(i,l){return __awaiter(v,void 0,void 0,Dl.mark((function _callee(){var d,u,p,m,h,g,v,f;return Dl.wrap((function _callee$(y){for(;;)switch(y.prev=y.next){case 0:if(!i||"RequestAbortedError"!==i.code){y.next=5;break}this.logger.error("uploadFile:","api::s3:upload file abort.",i),n(new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_CANCELLED:400,detail:{reason:"S3RequestAbortedError",rawError:i,curProvider:2}})),y.next=41;break;case 5:if(!i){y.next=26;break}return this.logger.error("uploadFile:","api::s3:upload file failed.",i),this.core.reporter.reportTraceStart("exceptions",{user_id:this.core.options.account||(null===(u=null===(d=this.core)||void 0===d?void 0:d.auth)||void 0===u?void 0:u.account),trace_id:null===(p=this.core.clientSocket.socket)||void 0===p?void 0:p.sessionId,start_time:a,action:1,exception_service:4}),this.core.reporter.reportTraceUpdateV2("exceptions",{code:"number"==typeof i.status?i.status:"number"==typeof i.code?i.code:0,description:i.message||""+i.code,operation_type:1,target:bn({bucket:o,object:s})},{asyncParams:ql.net.getNetworkStatus()}),this.core.reporter.reportTraceEnd("exceptions",1),y.next=12,ql.net.getNetworkStatus();case 12:if(m=y.sent,!1!==m.net_connect){y.next=16;break}return y.abrupt("return",n(new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"No network",rawError:i,curProvider:this.cloudStorage.mixStorage.curProvider}})));case 16:y.prev=16,this.cloudStorage.mixStorage._addCircuitTimer(),y.next=23;break;case 20:return y.prev=20,y.t0=y.catch(16),y.abrupt("return",n(new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"All upload attempts failed",rawError:y.t0,curProvider:this.cloudStorage.mixStorage.curProvider,mixStorePolicy:this.mixStorePolicy,file:e.file||e.filePath}})));case 23:r(this.cloudStorage._uploadFile(e)),y.next=41;break;case 26:if(h=(h=(h=this.mixStorePolicy.s3Policy.cdnSchema).replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn)).replace("{objectName}",l.Key),g={size:c.size,name:c.name,url:t.shortUrl?t.shortUrl:h,ext:c.name.split(".")[1]||"unknown"},v=e.type||"",(f={image:"imageInfo"})[v]){y.next=36;break}return y.abrupt("return",r(g));case 36:return y.t1=r,y.next=39,this.getS3FileInfo({url:h,infoSuffix:f[v],s3Result:g});case 39:return y.t2=y.sent,y.abrupt("return",(0,y.t1)(y.t2));case 41:case"end":return y.stop()}}),_callee,this,[[16,20]])})))})),e.onUploadStart&&e.onUploadStart(g)})));case 39:case"end":return f.stop()}}),_callee2,this)})))},e.getS3FileInfo=function getS3FileInfo(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var r,n,a,i,o,s,c;return Dl.wrap((function _callee3$(l){for(;;)switch(l.prev=l.next){case 0:return r=e.url,n=e.infoSuffix,a=e.s3Result,l.prev=1,l.next=4,this.core.adapters.request(r+"?"+n,{method:"GET",dataType:"text",timeout:5e3},{exception_service:3});case 4:i=l.sent,l.next=11;break;case 7:return l.prev=7,l.t0=l.catch(1),this.core.logger.error("uploadFile:: fetch file info error",l.t0),l.abrupt("return",a);case 11:if(!i){l.next=18;break}return o=i.data,s="imageInfo"===n?o:null===(t=null==o?void 0:o.GetVideoInfo)||void 0===t?void 0:t.VideoInfo,c=Et(Et({},a),{w:null==s?void 0:s.Width,h:null==s?void 0:s.Height,orientation:null==s?void 0:s.Orientation,dur:null==s?void 0:s.Duration,audioCodec:null==s?void 0:s.AudioCodec,videoCodec:null==s?void 0:s.VideoCodec,container:null==s?void 0:s.Container}),l.abrupt("return",pickBy(c,(function(e){return void 0!==e})));case 18:return this.core.logger.error("uploadFile:: fetch s3 file info no result",r+"?"+n),l.abrupt("return",a);case 20:case"end":return l.stop()}}),_callee3,this,[[1,7]])})))},Ue(AWS,[{key:"mixStorePolicy",get:function get(){return this.cloudStorage.mixStorage.mixStorePolicy}}]),AWS}(),Dh=function(){function CloudStorageService(e,t){void 0===t&&(t={}),this.config={},this.uploadTaskMap={},this.name="cloudStorage",this.logger=e.logger,this.core=e,this.nos=new Nh(e,this),this.mixStorage=new Lh(e,this),this.aws=new Uh(e,this),registerParser({cmdMap:xh,cmdConfig:Ph}),this.setOptions(t),this.setListeners()}var e=CloudStorageService.prototype;return e.setOptions=function setOptions(e){void 0===e&&(e={});var t=e.storageKeyPrefix||"NIMClient";this.mixStorage.GRAYKEY=t+"-AllGrayscaleConfig",this.mixStorage.MIXSTOREKEY=t+"-AllMixStorePolicy";var r=e.s3,n=__rest(e,["s3"]),a=Et({},Ah,this.config);if(n&&Object.prototype.hasOwnProperty.call(n,"cdn")){var i=Et(Et({},a.cdn),n.cdn);this.config=Et({},a,n),this.config.cdn=i}else this.config=Et({},a,n);r&&(this.aws.s3=r)},e.setListeners=function setListeners(){var e,t,r,n;this.core.eventBus.on("kicked",bind$1(e=this._clearUnCompleteTask).call(e,this)),this.core.eventBus.on("disconnect",bind$1(t=this._clearUnCompleteTask).call(t,this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLogout",bind$1(r=this._clearUnCompleteTask).call(r,this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleKicked",bind$1(n=this._clearUnCompleteTask).call(n,this))},e._clearUnCompleteTask=function _clearUnCompleteTask(){var e,t=this;forEach$1(e=Nt(this.uploadTaskMap)).call(e,(function(e){var r=t.uploadTaskMap[e];r&&r.abort&&r.abort()})),this.uploadTaskMap={}},e.init=function init(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(e){for(;;)switch(e.prev=e.next){case 0:if(this.mixStorage.reset(),this.nos.reset(),!this.config.isNeedToGetUploadPolicyFromServer){e.next=5;break}return e.next=5,this.mixStorage.getGrayscaleConfig(this.core.options.appkey);case 5:return e.next=7,this.nos._getNosCdnHost();case 7:case"end":return e.stop()}}),_callee,this)})))},e.processCallback=function processCallback(e,t){var r=this,n=e.onUploadProgress,a=e.onUploadDone,i=e.onUploadStart;return{onUploadStart:"function"==typeof i?function(e){r.uploadTaskMap[t]=e;try{i(e)}catch(e){r.logger.error("CloudStorage::uploadFile:options.onUploadStart execute error",e)}}:function(e){r.uploadTaskMap[t]=e},onUploadProgress:"function"==typeof n?function(e){r.core.reporterHookCloudStorage.update({transferred_size:e.loaded,full_size:e.total});try{n(e)}catch(e){r.logger.error("CloudStorage::uploadFile:options.onUploadProgress execute error",e)}}:function(e){r.core.reporterHookCloudStorage.update({transferred_size:e.loaded,full_size:e.total})},onUploadDone:"function"==typeof a?function(e){r.core.reporterHookCloudStorage.end(0);try{a(e)}catch(e){r.logger.error("CloudStorage::uploadFile:options.onUploadDone execute error",e)}}:function(){r.core.reporterHookCloudStorage.end(0)},taskKey:t}},e.uploadFile=function uploadFile(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i,o,s,c;return Dl.wrap((function _callee2$(l){for(;;)switch(l.prev=l.next){case 0:if(validate({maxSize:{type:"number",required:!1},type:{type:"enum",values:["file","image","audio","video"]}},e),e.fileInput||e.file||e.filePath){l.next=3;break}throw new Error("uploadFile needs target file object or a filePath");case 3:if(!e.type||"file"===e.type){l.next=7;break}if(!(t=get(e,"file.type"))||"string"!=typeof t||-1!==indexOf(t).call(t,e.type)){l.next=7;break}throw new Error('The meta type "'+t+'" does not match "'+e.type+'"');case 7:return this.core.reporterHookCloudStorage.start(),e.file?this.core.reporterHookCloudStorage.update({full_size:e.file.size}):"string"==typeof e.fileInput?(r=document.getElementById(e.fileInput))&&r.files&&r.files[0]&&this.core.reporterHookCloudStorage.update({full_size:r.files[0].size}):e.fileInput&&e.fileInput.files&&e.fileInput.files[0]&&this.core.reporterHookCloudStorage.update({full_size:e.fileInput.files[0].size}),n=ld(),a=this.processCallback(e,n),i=a.onUploadStart,o=a.onUploadProgress,s=a.onUploadDone,e.onUploadStart=i,e.onUploadProgress=o,e.onUploadDone=s,c=null,l.prev=15,l.next=18,this._uploadFile(e);case 18:c=l.sent,e.md5&&(c.md5=e.md5),delete this.uploadTaskMap[n],l.next=28;break;case 23:throw l.prev=23,l.t0=l.catch(15),delete this.uploadTaskMap[n],this.core.reporterHookCloudStorage.end((l.t0&&l.t0.code)===_l.V2NIM_ERROR_CODE_CANCELLED?3:1),l.t0;case 28:return c&&(c.size=void 0===c.size?void 0:Number(c.size),c.w=void 0===c.w?void 0:Number(c.w),c.h=void 0===c.h?void 0:Number(c.h),c.dur=void 0===c.dur?void 0:Number(c.dur)),c.url=decodeURIComponent(c.url),e.onUploadDone({size:c.size,name:c.name,url:c.url,ext:c.name.split(".")[1]||"unknown"}),l.abrupt("return",c);case 32:case"end":return l.stop()}}),_callee2,this,[[15,23]])})))},e._uploadFile=function _uploadFile(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var n,a,i,o;return Dl.wrap((function _callee3$(s){for(;;)switch(s.prev=s.next){case 0:if(get(this.mixStorage,"grayConfig.mixStoreEnable")&&get(this.mixStorage,"mixStorePolicy.providers.length")){s.next=3;break}return this.logger.log("uploadFile:: uploadFile begin, use old nos"),s.abrupt("return",this.nos.nosUpload(e));case 3:if(this.logger.log("uploadFile::_uploadFile, grayConfig enable:"+get(this.mixStorage,"grayConfig.mixStoreEnable")+" curProvider:"+get(this.mixStorage,"curProvider")),n=this.core.adapters.getFileUploadInformation(e),a=!0,n?!1===n.complete&&2===this.mixStorage.curProvider&&(a=!1):a=!1,this.aws.s3||(this.mixStorage.curProvider=1),i=wh,a){s.next=23;break}return s.prev=10,s.next=13,this.core.sendCmd("getMixStoreToken",{mixStoreTokenReqTag:{provider:this.mixStorage.curProvider,tokenCount:1,tag:"qchat",nosSurvivalTime:e.nosSurvivalTime,returnBody:getUploadResponseFormat(e.type),policyVersion:this.mixStorage.mixStorePolicy.policyVersion}});case 13:o=s.sent,i=o.content.mixStoreTokenResTag,s.next=23;break;case 17:if(s.prev=17,s.t0=s.catch(10),this.core.logger.error("uploadFile:: getMixStoreToken error",s.t0),!(s.t0 instanceof Sl)){s.next=22;break}throw s.t0;case 22:throw new El({code:"v2"===get(this.core,"options.apiVersion")?_l.V2NIM_ERROR_CODE_FILE_UPLOAD_FAILED:400,detail:{reason:"getMixStoreToken error",rawError:s.t0,curProvider:this.mixStorage.curProvider,mixStorePolicy:this.mixStorage.mixStorePolicy}});case 23:if(a){s.next=27;break}return s.abrupt("return",2===this.mixStorage.curProvider?this.aws.s3Upload(e,i):this.nos.nosUpload(e,i));case 27:return s.abrupt("return",this.nos.nosUpload(e,null===(r=null===(t=null==n?void 0:n.uploadInfo)||void 0===t?void 0:t.payload)||void 0===r?void 0:r.mixStoreToken));case 28:case"end":return s.stop()}}),_callee3,this,[[10,17]])})))},e.getThumbUrl=function getThumbUrl(e,t){var r,n,a,i,o;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),e;var s=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);s[0],s[1],s[2],s[3],s[4];var c=s[5];if(s[6],s[7],null===(r=this.grayConfig)||void 0===r?void 0:r.mixStoreEnable){var l=this._getUrlType(e);if(2===l&&this.mixStorePolicy.s3Policy&&get(this.mixStorePolicy,"s3Policy.thumbPolicy.imagethumb"))return(null===(a=null===(n=this.mixStorePolicy.s3Policy)||void 0===n?void 0:n.thumbPolicy)||void 0===a?void 0:a.imagethumb).replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",c).replace("{x}",t.width.toString()).replace("{y}",t.height.toString());if(1===l&&this.mixStorePolicy.nosPolicy&&get(this.mixStorePolicy,"nosPolicy.thumbPolicy.imagethumb"))return(null===(o=null===(i=this.mixStorePolicy.nosPolicy)||void 0===i?void 0:i.thumbPolicy)||void 0===o?void 0:o.imagethumb).replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",c).replace("{x}",t.width.toString()).replace("{y}",t.height.toString())}return includes(e).call(e,"?")?e+"&imageView&thumbnail="+t.width+"x"+t.height:e+"?imageView&thumbnail="+t.width+"x"+t.height},e.getVideoCoverUrl=function getVideoCoverUrl(e,t){var r,n,a,i,o;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),e;var s=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);s[0],s[1],s[2],s[3],s[4];var c=s[5];if(s[6],s[7],null===(r=this.grayConfig)||void 0===r?void 0:r.mixStoreEnable){var l=this._getUrlType(e);if(2===l&&this.mixStorePolicy.s3Policy&&get(this.mixStorePolicy,"s3Policy.thumbPolicy.vframe"))return(null===(a=null===(n=this.mixStorePolicy.s3Policy)||void 0===n?void 0:n.thumbPolicy)||void 0===a?void 0:a.vframe).replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",c).replace("{x}",t.width.toString()).replace("{y}",t.height.toString()).replace("{offset}","0").replace("{type}","png");if(1===l&&this.mixStorePolicy.nosPolicy&&get(this.mixStorePolicy,"nosPolicy.thumbPolicy.vframe"))return(null===(o=null===(i=this.mixStorePolicy.nosPolicy)||void 0===i?void 0:i.thumbPolicy)||void 0===o?void 0:o.vframe).replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",c).replace("{x}",t.width.toString()).replace("{y}",t.height.toString()).replace("{offset}","0").replace("{type}","png")}return includes(e).call(e,"?")?e+"&vframe&offset=0&resize="+t.width+"x"+t.height+"&type=png":e+"?vframe&offset=0&resize="+t.width+"x"+t.height+"&type=png"},e.getPrivateUrl=function getPrivateUrl(e){var t;if(!new RegExp(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- ./?%&=]*)?/).test(e))return this.logger.error("illegal file url:"+e),"";var r=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/.exec(e);r[0];var n=r[1];r[2];var a=r[3];r[4];var i=r[5];if(r[6],r[7],null===(t=this.grayConfig)||void 0===t?void 0:t.mixStoreEnable){var o=this._getUrlType(e);return 2===o&&this.mixStorePolicy.s3Policy&&(e=this.mixStorePolicy.s3Policy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.s3Policy.dlcdn).replace("{objectName}",i)),1===o&&this.mixStorePolicy.nosPolicy&&(e=this.mixStorePolicy.nosPolicy.cdnSchema.replace("{cdnDomain}",this.mixStorePolicy.nosPolicy.dlcdn).replace("{objectName}",i)),e}var s=this.config,c=s.downloadUrl,l=s.downloadHostList,d=s.nosCdnEnable,u=this.config.cdn.cdnDomain,p=this.config.cdn.objectNamePrefix?decodeURIComponent(this.config.cdn.objectNamePrefix):"",m=decodeURIComponent(i),h=indexOf(m).call(m,p);if(u&&h>-1&&d)return""+n+u+"/"+slice(m).call(m,h);if(includes(l).call(l,a)&&includes(i).call(i,"/")){var g=indexOf(i).call(i,"/"),v=i.substring(0,g),f=i.substring(g+1);return c.replace("{bucket}",v).replace("{object}",f)}var y=filter(l).call(l,(function(e){return"string"==typeof a&&includes(a).call(a,e)}))[0],M=y?a.replace(y,"").replace(/\W/g,""):null;return M?c.replace("{bucket}",M).replace("{object}",i):e},e.getOriginUrl=function getOriginUrl(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:if("string"==typeof e&&includes(e).call(e,"_im_url=1")){r.next=2;break}return r.abrupt("return",e);case 2:return r.next=4,this.core.sendCmd("getOriginUrl",{nosSafeUrlTag:{safeUrl:e}});case 4:return t=r.sent,r.abrupt("return",t.content.nosSafeUrlTag.originUrl);case 6:case"end":return r.stop()}}),_callee4,this)})))},e.getFileToken=function getFileToken(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t,r,n,a,i,o=this;return Dl.wrap((function _callee5$(s){for(;;)switch(s.prev=s.next){case 0:if(validate({type:{type:"number",min:2,max:3},urls:{type:"array",required:!1,itemType:"string"}},e),t=this.mixStorePolicy.nosPolicy?this.mixStorePolicy.nosPolicy.authPolicy.policyType:null,r=this.mixStorePolicy.s3Policy?this.mixStorePolicy.s3Policy.authPolicy.policyType:null,t!==String(-1)||r!==String(-1)){s.next=8;break}throw this.logger.error("don't need token"),new Error("don't need token");case 8:if(2!==e.type){s.next=17;break}if(!(t&&indexOf(t).call(t,String(2))>=0||r&&indexOf(r).call(r,String(2))>0)){s.next=13;break}return s.abrupt("return",this.mixStorage.getFileAuthToken(e));case 13:throw this.logger.error("don't support time token "),new Error("don't support type time token ");case 15:s.next=33;break;case 17:if(e.urls&&e.urls.length){s.next=20;break}throw this.logger.error("urls is required when urls token"),new Error("urls is required when urls token");case 20:if(a=[],i=[],forEach$1(n=e.urls).call(n,(function(e){var t=o._getUrlType(e);1===t&&i.push(e),2===t&&a.push(e)})),(!r||0!==a.length&&indexOf(r).call(r,String(3))<0)&&(this.logger.warn("s3 url don't support url token"),a=[]),(!t||0!==i.length&&indexOf(t).call(t,String(3))<0)&&(this.logger.warn("nos url don't support url token"),i=[]),0!==a.length||0!==i.length){s.next=30;break}throw this.logger.error("not support urls"),new Error("not support urls");case 30:if(0!==a.length&&0!==i.length){s.next=33;break}return e.urls=bn(e.urls),s.abrupt("return",this.mixStorage.getFileAuthToken(e));case 33:case"end":return s.stop()}}),_callee5,this)})))},e._getUrlType=function _getUrlType(e){var t,r;return this.mixStorePolicy.nosPolicy&&some(t=this.mixStorePolicy.nosPolicy.dlcdns).call(t,(function(t){return indexOf(e).call(e,t)>=0}))?1:this.mixStorePolicy.s3Policy&&some(r=this.mixStorePolicy.s3Policy.dlcdns).call(r,(function(t){return indexOf(e).call(e,t)>=0}))?2:null},e.getNosAccessToken=function getNosAccessToken(e){return validate({url:{type:"string",allowEmpty:!1}},e),this.nos.getNosAccessToken(e)},e.deleteNosAccessToken=function deleteNosAccessToken(e){return validate({token:{type:"string",allowEmpty:!1}},e),this.nos.deleteNosAccessToken(e)},e.process=function process(e){var t=get(e,"error.detail.ignore");return e.error&&!t?Pi.reject(e.error):Pi.resolve(e)},Ue(CloudStorageService,[{key:"grayConfig",get:function get(){return this.mixStorage.grayConfig}},{key:"mixStorePolicy",get:function get(){return this.mixStorage.mixStorePolicy}}]),CloudStorageService}();var qh=function(e){function V2NIMStorageServiceImpl(t){var r;return(r=e.call(this,"V2NIMStorageService",t)||this).sceneMap={nim_default_profile_icon:{sceneName:"nim_default_profile_icon",expireTime:0},nim_default_im:{sceneName:"nim_default_im",expireTime:0},nim_system_nos_scene:{sceneName:"nim_system_nos_scene",expireTime:0},nim_security:{sceneName:"nim_security",expireTime:0}},r.uploadingMessageInfo={},r.core=t,r.core._registerDep(Dh,"cloudStorage"),r.core._registerDep(Rh,"V2NIMStorageUtil"),r}_t(V2NIMStorageServiceImpl,e);var t=V2NIMStorageServiceImpl.prototype;return t.addCustomStorageScene=function addCustomStorageScene(e,t){return this.checkV2(),validate({sceneName:{type:"string",allowEmpty:!1},expireTime:{type:"number",min:0}},{sceneName:e,expireTime:t},"",!0),this.sceneMap[e]={sceneName:e,expireTime:t},{sceneName:e,expireTime:t}},t.getStorageSceneList=function getStorageSceneList(){return this.checkV2(),Bi(this.sceneMap)},t.getStorageScene=function getStorageScene(e){return e&&this.sceneMap[e]||this.sceneMap.nim_default_im},t.hasStorageScene=function hasStorageScene(e){return void 0!==this.sceneMap[e]},t.createUploadFileTask=function createUploadFileTask(e){var t;if(this.checkV2(),"string"==typeof e.fileObj&&0===indexOf(t=e.fileObj).call(t,"nim-external")){var r=document.getElementById(e.fileObj);r&&r.files&&r.files[0]&&(e.fileObj=r.files[0])}return{taskId:ld(),uploadParams:e}},t.uploadFile=function uploadFile(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate({taskId:{type:"string",allowEmpty:!1}},e,"fileTask",!0),n.next=4,this._uploadFile(e,t);case 4:return r=n.sent,n.abrupt("return",r[0]);case 6:case"end":return n.stop()}}),_callee,this)})))},t.uploadFileWithMetaInfo=function uploadFileWithMetaInfo(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r;return Dl.wrap((function _callee2$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate({taskId:{type:"string",allowEmpty:!1}},e,"fileTask",!0),n.next=4,this._uploadFile(e,t);case 4:return r=n.sent,n.abrupt("return",(a=r[1],i=void 0,o=void 0,s=void 0,c=void 0,l=void 0,d=void 0,u=void 0,p=void 0,m=void 0,h=void 0,g=void 0,v=void 0,i=a.url,o=a.name,s=a.size,c=a.ext,l=a.md5,d=a.h,u=a.w,p=a.orientation,m=a.dur,h=a.audioCodec,g=a.videoCodec,v=a.container,JSON.parse(bn({url:i,name:o,size:s,ext:c,md5:l,height:d,width:u,orientation:p,duration:m,audioCodec:h,videoCodec:g,container:v}))));case 6:case"end":return n.stop()}var a,i,o,s,c,l,d,u,p,m,h,g,v}),_callee2,this)})))},t._uploadFile=function _uploadFile(e,t,r){var n;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var a,i,o,s,c,l,d,u,p,m,h=this;return Dl.wrap((function _callee3$(g){for(;;)switch(g.prev=g.next){case 0:if(this.core.cloudStorage&&this.core.cloudStorage.uploadFile){g.next=2;break}throw new Error('Service "cloudStorage" does not exist');case 2:if(a=e.uploadParams,i=e.taskId,o=getFileOrPath(a.fileObj),s=o.file,c=o.path,l=(r||{}).fileType,!this.uploadingMessageInfo[i]){g.next=7;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_ALREADY_EXIST,detail:{reason:"V2NIMStorageService.uploadFile: repeat upload"}});case 7:if(g.prev=7,d={},s?d.file=s:c&&(0===(null==c?void 0:indexOf(c).call(c,"nim-external"))?d.fileInput=c:d.filePath=c),u=this.getStorageScene(a.sceneName),d.nosScenes=u.sceneName,d.nosSurvivalTime=u.expireTime,d.type=1===l?"image":2===l?"audio":3===l?"video":"file",!d.file||!this.core.pluginMap["browser-md5-file"]){g.next=19;break}return g.next=17,this.getFileMd5(this.core.pluginMap["browser-md5-file"],i,d.file);case 17:p=g.sent,d.md5=p;case 19:return d.onUploadProgress=function(e){"function"==typeof t&&t(Math.round(100*e.percentage))},d.onUploadStart=function(e){var t;if(null===(t=h.uploadingMessageInfo[i])||void 0===t?void 0:t.abort)return e.abort(),void delete h.uploadingMessageInfo[i];h.uploadingMessageInfo[i]={abort:!1,task:e}},this.uploadingMessageInfo[i]={abort:!1},g.next=24,this.core.cloudStorage.uploadFile(d);case 24:if(m=g.sent,!(null===(n=this.uploadingMessageInfo[i])||void 0===n?void 0:n.abort)){g.next=27;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"upload file aborted"}});case 27:return delete this.uploadingMessageInfo[i],g.abrupt("return",[m.url,m]);case 31:throw g.prev=31,g.t0=g.catch(7),delete this.uploadingMessageInfo[i],this.core.logger.error("sendFile:: upload File error or abort.",g.t0),g.t0;case 36:case"end":return g.stop()}}),_callee3,this,[[7,31]])})))},t.cancelUploadFile=function cancelUploadFile(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),t.next=3,this._cancelUploadFile(e.taskId);case 3:case"end":return t.stop()}}),_callee4,this)})))},t._cancelUploadFile=function _cancelUploadFile(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t;return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:if(this.checkV2(),!(null==(t=this.uploadingMessageInfo[e])?void 0:t.task)){r.next=16;break}return r.prev=3,this.logger.log("V2NIMStorageService.cancelUploadFile: uploadInfo task exist"),r.next=7,t.task.abort();case 7:delete this.uploadingMessageInfo[e],r.next=14;break;case 10:r.prev=10,r.t0=r.catch(3),delete this.uploadingMessageInfo[e],this.core.logger.error("cancelMessageAttachmentUpload::abort error.",r.t0);case 14:r.next=22;break;case 16:if(!t){r.next=21;break}this.logger.log("V2NIMStorageService.cancelUploadFile: uploadInfo task not exist"),t.abort=!0,r.next=22;break;case 21:throw new Sl({code:_l.V2NIM_ERROR_CODE_RESOURCE_NOT_EXIST,detail:{reason:"V2NIMStorageService.cancelUploadFile: uploadInfo not exist"}});case 22:case"end":return r.stop()}}),_callee5,this,[[3,10]])})))},t.getFileMd5=function getFileMd5(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var n=this;return Dl.wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Pi((function(a,i){var o,s=new e;(null===(o=n.uploadingMessageInfo[t])||void 0===o?void 0:o.abort)?i(new Sl({code:_l.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:"upload file aborted"}})):n.uploadingMessageInfo[t]={abort:!1,task:s};try{s.md5(r,(function(e,t){"aborted"===e?i(new Sl({code:_l.V2NIM_ERROR_CODE_CANCELLED,detail:{reason:e}})):e?i(new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"md5 calculate error in callback",rawError:e}})):a(t)}))}catch(e){i(new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"md5 calculate error",rawError:e}}))}})));case 1:case"end":return a.stop()}}),_callee6)})))},t.shortUrlToLong=function shortUrlToLong(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),t.abrupt("return",this.core.cloudStorage.getOriginUrl(e));case 2:case"end":return t.stop()}}),_callee7,this)})))},t.getImageThumbUrl=function getImageThumbUrl(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){return Dl.wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",this.core.V2NIMStorageUtil.getImageThumbUrl(e,t));case 1:case"end":return r.stop()}}),_callee8,this)})))},t.getVideoCoverUrl=function getVideoCoverUrl(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",this.core.V2NIMStorageUtil.getVideoCoverUrl(e,t));case 1:case"end":return r.stop()}}),_callee9,this)})))},V2NIMStorageServiceImpl}(Ru),Bh=function(e){function V2NIMMessageCreatorImpl(t){var r;return(r=e.call(this,"V2NIMMessageCreator",t)||this).name="V2NIMMessageCreator",r.defaultNosSceneName="nim_default_im",r.core=t,r}_t(V2NIMMessageCreatorImpl,e);var t=V2NIMMessageCreatorImpl.prototype;return t.createMessage=function createMessage(e,t){return Et(Et(Et({messageClientId:ld(),messageType:e,createTime:Hi(),sendingState:0,messageStatus:{errorCode:200},isSelf:!0},t),t.attachment?{attachment:Et(Et({},t.attachment),{raw:attachmentToRaw(e,t.attachment)})}:{}),{senderId:"",receiverId:"",conversationType:0,conversationId:"",messageServerId:"",messageConfig:Et({unreadEnabled:!0,roamingEnabled:!0,readReceiptEnabled:!1,lastMessageUpdateEnabled:!0,historyEnabled:!0,onlineSyncEnabled:!0,offlineEnabled:!0},t.messageConfig),pushConfig:Et({pushEnabled:!0,pushNickEnabled:!0,forcePush:!1},t.pushConfig),routeConfig:Et({routeEnabled:!0},t.routeConfig),antispamConfig:Et({antispamEnabled:!0},t.antispamConfig)})},t.createTextMessage=function createTextMessage(e){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:e},"",!0),this.createMessage(0,{text:e})},t.createImageMessage=function createImageMessage(e,t,r,n,a){this.checkV2(),validate(sh,{name:t,sceneName:r,width:n,height:a},"",!0);var i=this.createGenericFileMessageAttachment(e,t,r,void 0,n,a,"jpeg");return this.createMessage(1,{attachment:i,attachmentUploadState:0})},t.createAudioMessage=function createAudioMessage(e,t,r,n){this.checkV2(),validate(ih,{name:t,sceneName:r,duration:n},"",!0);var a=this.createGenericFileMessageAttachment(e,t,r,n,void 0,void 0,"aac");return this.createMessage(2,{attachment:a,attachmentUploadState:0})},t.createVideoMessage=function createVideoMessage(e,t,r,n,a,i){this.checkV2(),validate(oh,{name:t,sceneName:r,duration:n,width:a,height:i},"",!0);var o=this.createGenericFileMessageAttachment(e,t,r,n,a,i,"mp4");return this.createMessage(3,{attachment:o,attachmentUploadState:0})},t.createFileMessage=function createFileMessage(e,t,r){this.checkV2(),validate(ah,{name:t,sceneName:r},"",!0);var n=this.createGenericFileMessageAttachment(e,t,r,void 0,void 0,void 0,"txt");return this.createMessage(6,{attachment:n,attachmentUploadState:0})},t.createGenericFileMessageAttachment=function createGenericFileMessageAttachment(e,t,r,n,a,i,o){if(r=r||this.defaultNosSceneName,!this.core.V2NIMStorageService.hasStorageScene)throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"V2NIMStorageService not exist"}});if(!this.core.V2NIMStorageService.hasStorageScene(r))throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sceneName: "+r+" has not been added"}});var s=getFileOrPath(e),c=s.file,l=s.path,d=Et(Et(Et({name:t,uploadState:0,sceneName:r||this.defaultNosSceneName},n?{duration:n}:{}),a?{width:a}:{}),i?{height:i}:{});if(c){var u,p=lastIndexOf(u=c.name).call(u,"."),m=-1===p?c.name:c.name.substring(0,p);d.name=d.name||m,d.size=c.size,d.ext="."+(getFileExtension(c.name)||getFileExtension(t||"")||o)}else if(l){var h=lastIndexOf(l).call(l,"/"),g=lastIndexOf(l).call(l,"."),v=-1===g?l.substring(h+1):l.substring(h+1,g);d.name=d.name||v,d.ext="."+(getFileExtension(l)||getFileExtension(t||"")||o)}return d=JSON.parse(bn(d)),l?d.path=l:c&&(d.file=c),d},t.createLocationMessage=function createLocationMessage(e,t,r){return this.checkV2(),validate({latitude:{type:"number",allowEmpty:!1},longitude:{type:"number",allowEmpty:!1},address:{type:"string",allowEmpty:!1}},{latitude:e,longitude:t,address:r},"",!0),this.createMessage(4,{attachment:{latitude:e,longitude:t,address:r}})},t.createCustomMessage=function createCustomMessage(e,t){return this.checkV2(),validate({text:{type:"string"}},{text:e},"",!0),validate({rawAttachment:{type:"string"}},{rawAttachment:t},"",!0),this.createMessage(100,{text:e,attachment:{raw:t}})},t.createCustomMessageWithAttachment=function createCustomMessageWithAttachment(e,t){return this.checkV2(),validate({raw:{type:"string"}},e,"attachment",!0),validate({subType:{type:"number",min:0,required:!1}},{subType:t},"",!0),this.createMessage(100,t?{attachment:e,subType:t}:{attachment:e})},t.createCallMessage=function createCallMessage(e,t,r,n,a){return this.checkV2(),validate({type:{type:"number",allowEmpty:!1}},{type:e},"",!0),validate({channelId:{type:"string",allowEmpty:!1}},{channelId:t},"",!0),validate({status:{type:"number",allowEmpty:!1}},{status:r},"",!0),validate({durations:{type:"array",allowEmpty:!1}},{durations:n},"",!0),this.createMessage(12,{text:a||"",attachment:{type:e,channelId:t,durations:n,status:r}})},t.createForwardMessage=function createForwardMessage(e){this.checkV2();var t=[11,5,7,10];if(!e||includes(t).call(t,e.messageType))return null;var r={messageClientId:ld(),messageType:e.messageType};return e.text&&(r.text=e.text),e.attachment&&(r.attachment=e.attachment),e.attachment&&"uploadState"in e.attachment&&(r.attachmentUploadState=e.attachment.uploadState),this.createMessage(e.messageType,r)},t.createTipsMessage=function createTipsMessage(e){return this.checkV2(),validate({text:{type:"string",allowEmpty:!1}},{text:e},"",!0),this.createMessage(10,{text:e})},V2NIMMessageCreatorImpl}(Ru),Fh=function(){function V2NIMMessageAttachmentCreatorImpl(){this.name="V2NIMMessageAttachmentCreator"}var e=V2NIMMessageAttachmentCreatorImpl.prototype;return e.createLocationMessageAttachment=function createLocationMessageAttachment(e,t,r){return{latitude:"number"==typeof e?e:0,longitude:"number"==typeof t?t:0,address:"string"==typeof r?r:""}},e.createCustomMessageAttachment=function createCustomMessageAttachment(e){return{raw:"string"==typeof e?e:""}},V2NIMMessageAttachmentCreatorImpl}(),Gh=entryVirtual("Array").keys,Hh=Array.prototype,jh={DOMTokenList:!0,NodeList:!0},keys=function(e){var t=e.keys;return e===Hh||x(Hh,e)&&t===Hh.keys||Z(jh,ur(e))?Gh:t},$h=function(){function V2NIMClientAntispamUtilImpl(e){this.config={enable:!0},this.name="V2NIMClientAntispamUtil",this.core=e}var e=V2NIMClientAntispamUtilImpl.prototype;return e.setOptions=function setOptions(e){this.config=Et(this.config,e)},e.reset=function reset(e){"destroy"===e&&(this.vocabInfo=void 0)},e.downloadLocalAntiSpamVocabs=function downloadLocalAntiSpamVocabs(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e;return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(this.config.enable){t.next=2;break}return t.abrupt("return");case 2:if(!this.vocabInfo){t.next=4;break}return t.abrupt("return");case 4:return t.prev=4,t.next=7,this.core.sendCmd("v2DownloadLocalAntiSpamVocabs",{tag:{version:0,md5:""}});case 7:e=t.sent,this.vocabInfo=Et(Et({},e.content.data),{thesaurus:JSON.parse(e.content.data.thesaurus).thesaurus}),t.next=14;break;case 11:t.prev=11,t.t0=t.catch(4),this.core.logger.warn("V2NIMLocalAntispamUtil::downloadLocalAntiSpamVocabs error",t.t0);case 14:case"end":return t.stop()}}),_callee,this,[[4,11]])})))},e.checkTextAntispam=function checkTextAntispam(e,t){if(void 0===t&&(t="**"),!this.config.enable)return{operateType:0,replacedText:e};if(validate({text:{type:"string",required:!0,allowEmpty:!1},replace:{type:"string"}},{text:e,replace:t},"",!0),!this.vocabInfo)return{operateType:0,replacedText:e};for(var r=e,n=0;n<this.vocabInfo.thesaurus.length;n++){var a=this.filterContent(r,this.vocabInfo.thesaurus[n],t);if(r=a.replacedText,2===a.operateType||3===a.operateType)return a}return{operateType:r===e?0:1,replacedText:r}},e.filterContent=function filterContent(e,t,r){for(var n=0;n<keys(t).length;n++){var a=keys(t)[n],i=a.match||t.match,o=a.operate||t.operate,s=void 0;try{s=this.matchContent(e,a.key,i,o,r)}catch(e){}if(s&&(e=s.replacedText,2===s.operateType||3===s.operateType))return s}return{operateType:1,replacedText:e}},e.matchContent=function matchContent(e,t,r,n,a){var i=!1,o="";if(1===r)indexOf(e).call(e,t)>=0&&(i=!0,o=t);else if(2===r){new RegExp(t,"g").test(e)&&(i=!0)}if(i&&""!==o)switch(n){case 1:return{operateType:1,replacedText:e.replace(o,a)};case 2:return{operateType:2,replacedText:e};case 3:return{operateType:3,replacedText:e}}return{operateType:0,replacedText:e}},V2NIMClientAntispamUtilImpl}(),zh=function(e){function YSFServiceImpl(t){var r;return(r=e.call(this,"YSFService",t)||this).core._registerDep(jp,"V2NIMConversationIdUtil"),r.core._registerDep(Bh,"V2NIMMessageCreator"),r.core._registerDep(Fh,"V2NIMMessageAttachmentCreator"),r.core._registerDep($h,"V2NIMClientAntispamUtil"),r.core._registerDep(qh,"V2NIMStorageService"),r.sendUtil=new Wh(r.core,De(r)),r.fileUtil=new ph(r.core),r.model=new Rm,r.notificationUtil=new Th(r.core),registerParser({cmdMap:Mh,cmdConfig:Ih}),r}_t(YSFServiceImpl,e);var t=YSFServiceImpl.prototype;return t.emit=function emit(t){for(var r,n,a,i=this.name+"::emit "+t.toString(),o=arguments.length,s=new Array(o>1?o-1:0),c=1;c<o;c++)s[c-1]=arguments[c];if("onSendMessage"===t){var l=s[0];this.logger.log(""+i,l.messageClientId+"/"+l.messageServerId+";createTime:"+l.createTime+";","sendingState:"+l.sendingState+";attachmentUploadState:"+(l.attachmentUploadState||0)+";messageStatus:"+(null===(a=l.messageStatus)||void 0===a?void 0:a.errorCode))}else if("onReceiveMessages"===t){var d=s[0];this.logger.log(""+i,map$6(d).call(d,(function(e){return e.messageClientId+"/"+e.messageServerId+";createTime:"+e.createTime})))}else if("onReceiveCustomNotifications"===t){var u=s[0];this.logger.log(""+i,map$6(u).call(u,(function(e){return"sender:"+e.senderId+";receiver:"+e.receiverId+";ctype:"+e.conversationType+";time:"+e.timestamp})))}else{var p,m;(p=this.logger).log.apply(p,concat(m=[""+i]).call(m,s))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,s))},t.sendMessage=function sendMessage(e,t,r,n){return void 0===r&&(r={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){var a,i,o,s,c,l;return Dl.wrap((function _callee$(d){for(;;)switch(d.prev=d.next){case 0:return validate({message:{type:"object"}},{message:e},"",!0),e.messageClientId=e.messageClientId||ld(),validate(Um,{conversationId:t,message:e,params:r},"",!0),validateConversationId(this.core.account,t),a=this.core.timeOrigin.getTimeNode(),i=this.sendUtil.prepareMessage(e,t,r),o=i.messageBeforeSend,s=i.clientAntispamResult,c=i.hiddenParams,d.next=8,this.sendUtil.doSendMessage({apiCallingTimeNode:a,messageBeforeSend:o,clientAntispamResult:s,hiddenParams:c,progress:n});case 8:return(l=d.sent).message.senderId===l.message.receiverId&&this.markMsgsAck([l.message]),d.abrupt("return",l);case 11:case"end":return d.stop()}}),_callee,this)})))},t.sendCustomNotification=function sendCustomNotification(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var n;return Dl.wrap((function _callee2$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validateConversationId(this.core.account,e),validate(Sh,{content:t,params:r},"",!0),(n=this.notificationUtil.generateNotificationTag(e,t,r)).type=100,a.next=7,this.core.sendCmd("ysfSendCustomNotification",{tag:n});case 7:case"end":return a.stop()}}),_callee2,this)})))},t.sendMessageHandler=function sendMessageHandler(e){},t.cancelMessageAttachmentUpload=function cancelMessageAttachmentUpload(e){return this.fileUtil.cancelMessageAttachmentUpload(e)},t.markMsgsAck=function markMsgsAck(e){var t;if(e&&e.length>0){var r=filter(t=map$6(e).call(e,(function(e){return e.messageServerId}))).call(t,(function(e){return e&&"0"!==e}));0!==r.length&&this.core.sendCmd("ysfBatchMarkRead",{sid:101,cid:2,ids:r})}},t.markNotificationAck=function markNotificationAck(e){var t;if(e&&e.length>0){var r=filter(t=map$6(e).call(e,(function(e){return e.idServer}))).call(t,(function(e){return e&&"0"!==e}));0!==r.length&&this.core.sendCmd("ysfBatchMarkRead",{sid:101,cid:3,ids:r})}},t.ysfOnMsgHandler=function ysfOnMsgHandler(e){var t=e.content.data,r=formatMessageAttachment(completeMessage(this.core,t),this.core);delete r.__clientExt,this.emit("onReceiveMessages",[r]),this.model.upsertMessages([r]),this.markMsgsAck([r])},t.ysfSyncOfflineMsgsHandler=function ysfSyncOfflineMsgsHandler(e){var t=this,r=e.content.datas;r=map$6(r).call(r,(function(e){return formatMessageAttachment(completeMessage(t.core,e),t.core)})),this.markMsgsAck(r),this.emit("onReceiveMessages",r),this.model.upsertMessages(r)},t.ysfOnSysNotificationHandler=function ysfOnSysNotificationHandler(e){this.markNotificationAck([e.content.data]);var t=this.processSystemNotification(e.content.data);t&&this.emit("onReceiveCustomNotifications",[t])},t.processSystemNotification=function processSystemNotification(e){var t=Et(Et({},e),{conversationType:1});return delete t.type,t},t.ysfSyncSysNotificationHandler=function ysfSyncSysNotificationHandler(e){var t,r,n,a=this;this.markNotificationAck(e.content.datas);var i=filter(t=map$6(r=sort(n=e.content.datas).call(n,(function(e,t){return e.timestamp-t.timestamp}))).call(r,(function(e){return a.processSystemNotification(e)}))).call(t,(function(e){return e}));i&&this.emit("onReceiveCustomNotifications",i)},YSFServiceImpl}(Ru),Wh=function(){function SendUtil(e,t){this.uploadingMessageInfo={},this.core=e,this.service=t}var e=SendUtil.prototype;return e.prepareMessage=function prepareMessage(e,t,r,n){var a=this.checkIfResend(e),i=this.generateSendMessage({message:e,params:r,resend:a,conversationId:t,replyMessage:n}),o=Et({},r.targetConfig?{targetConfig:r.targetConfig}:{}),s=this.checkIfAntispam(r,i),c=s.clientAntispamResult,l=s.text;return i.text=l,i.clientAntispamHit=!!c&&3===c.operateType,{messageBeforeSend:i,clientAntispamResult:c,hiddenParams:o}},e.checkIfAntispam=function checkIfAntispam(e,t){var r,n=t.text;if(e.clientAntispamEnabled&&(0===t.messageType||10===t.messageType))if(1===(r=this.core.V2NIMClientAntispamUtil.checkTextAntispam?this.core.V2NIMClientAntispamUtil.checkTextAntispam(t.text||"",e.clientAntispamReplace):{operateType:0,replacedText:""}).operateType)n=r.replacedText;else if(2===r.operateType)throw this.service.emit("onSendMessage",Et(Et({},t),{sendingState:2,messageStatus:{errorCode:_l.V2NIM_ERROR_CODE_CLIENT_ANTISPAM}})),new Sl({code:_l.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,detail:{reason:"sendMessage: text intercepted by client antispam"}});return{clientAntispamResult:r,text:n}},e.doMsgReceiveReport=function doMsgReceiveReport(e,t){if(e.senderId!==this.core.account){var r=get(e,"__clientExt.statistics.apiCallingTime")||0,n=get(e,"__clientExt.statistics.sendTime")||0,a=get(e,"__clientExt.statistics.attachUploadDuration")||0,i=this.core.timeOrigin.getNTPTime(),o=e.createTime,s=this.core.timeOrigin.checkNodeReliable(t.__receiveTimeNode)?this.core.timeOrigin.getNTPTime(t.__receiveTimeNode):i;this.core.reporter.report("msgReceive",{msgId:e.messageServerId,clientId:e.messageClientId,serverTime:e.createTime,receiveTime:s,fromAccid:1===e.conversationType?e.senderId:"",toAccid:e.receiverId,type:conversationTypeV2ToV1(e.conversationType),tid:1===e.conversationType?"":e.receiverId,apiCallingTime:r,sendTime:n,attachUploadDuration:a,callbackTime:i,preHandleTime:i,result:200,failReason:"",rt:i-o})}},e.checkIfResend=function checkIfResend(e){var t=this.service.model.getMessageById(e.messageClientId),r=!1;if(e.messageServerId||1===e.sendingState)throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message has already been sent"}});if(1===(null==t?void 0:t.sendingState))throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message has already been sent"}});return t&&(r=!0),r},e.doSendMessage=function doSendMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a,i,o,s,c,l,d,u,p,m;return Dl.wrap((function _callee$(h){for(;;)switch(h.prev=h.next){case 0:if(t=e.apiCallingTimeNode,r=e.messageBeforeSend,n=e.clientAntispamResult,a=e.hiddenParams,i=e.progress,o={},!(s=this.service instanceof zh)){h.next=7;break}c="ysfSendMessage",h.next=20;break;case 7:if(1!==r.conversationType){h.next=11;break}c="v2SendP2pMessage",h.next=20;break;case 11:if(2!==r.conversationType){h.next=15;break}c="v2SendTeamMessage",h.next=20;break;case 15:if(3!==r.conversationType){h.next=19;break}c="v2SendSuperTeamMessage",h.next=20;break;case 19:throw new Cl({detail:{reason:"conversationType: "+r.conversationType+" is not supported"}});case 20:if(this.service.sendMessageHandler(r),!s&&this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",r),!r.attachment||!("uploadState"in r.attachment)||r.attachment.url||0!==r.attachment.uploadState&&2!==r.attachment.uploadState){h.next=48;break}return l=Hi(),h.prev=24,r.attachmentUploadState=3,r.attachment.uploadState=3,this.service.emit("onSendMessage",r),h.next=30,this.service.fileUtil.doSendFile(r,i);case 30:r.attachmentUploadState=1,r.attachment.uploadState=1,this.service.emit("onSendMessage",r),h.next=45;break;case 35:throw h.prev=35,h.t0=h.catch(24),r.attachmentUploadState=2,r.attachment.uploadState=2,r.sendingState=2,r.messageStatus={errorCode:h.t0.code||_l.V2NIM_ERROR_CODE_UNKNOWN},this.service.emit("onSendMessage",r),o.attachUploadDuration=Hi()-l,this.doSendMessageFailed(t,o,r,h.t0),h.t0;case 45:o.attachUploadDuration=Hi()-l,h.next=49;break;case 48:this.service.emit("onSendMessage",r);case 49:return this.core.timeOrigin.checkNodeReliable(t)&&(o.apiCallingTime=this.core.timeOrigin.getNTPTime(t),o.sendTime=this.core.timeOrigin.getNTPTime(),r.__clientExt={statistics:o}),h.prev=50,h.next=53,this.core.sendCmd(c,{tag:Et({},r,a)});case 53:d=h.sent,h.next=63;break;case 56:throw h.prev=56,h.t1=h.catch(50),this.doSendMessageFailed(t,o,r,h.t1),r.sendingState=2,r.messageStatus={errorCode:h.t1.code||_l.V2NIM_ERROR_CODE_UNKNOWN},this.service.emit("onSendMessage",r),h.t1;case 63:return u=get(d,"content.data.errorCode"),p=Et(Et(Et({},r),d.content.data),{sendingState:1,messageStatus:{errorCode:u&&200!==u?u:200}}),this.service.sendMessageHandler(p),!s&&this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",p),this.doMsgSendReport(t,o,r),(m=p.antispamResult)&&(p.messageStatus.errorCode=_l.V2NIM_ERROR_CODE_SERVER_ANTISPAM),delete p.antispamResult,this.service.emit("onSendMessage",p),h.abrupt("return",Et(Et({message:p},m?{antispamResult:m}:{}),n?{clientAntispamResult:n}:{}));case 73:case"end":return h.stop()}}),_callee,this,[[24,35],[50,56]])})))},e.doSendMessageFailed=function doSendMessageFailed(e,t,r,n){var a=Et(Et({},r),{sendingState:2});this.core.eventBus.emit("forwardSend/V2NIMMessageService/sendMsg",a),this.service.sendMessageHandler(a),this.doMsgSendReport(e,t,r,n)},e.doMsgSendReport=function doMsgSendReport(e,t,r,n){t.apiCallingTime=this.core.timeOrigin.getNTPTime(e),t.sendTime=this.core.timeOrigin.getNTPTime();var a=this.core.timeOrigin.getNTPTime(),i=get(n,"detail.reason");this.core.reporter.report("msgSend",{msgId:r.messageServerId,clientId:r.messageClientId,msgTime:r.createTime,fromAccid:1===r.conversationType?r.senderId:"",toAccid:r.receiverId,type:conversationTypeV2ToV1(r.conversationType),tid:1===r.conversationType?"":r.receiverId,result:n?n.code:200,failReason:i||(null==n?void 0:n.message)||"",rt:a-t.apiCallingTime,apiCallingTime:t.apiCallingTime,sendTime:t.sendTime,attachUploadDuration:t.attachUploadDuration,apiCallbackTime:a})},e.generateSendMessage=function generateSendMessage(e){var t,r,n=e.conversationId,a=e.replyMessage,i=e.resend,o=e.message,s=e.params,c={};if(a){var l=a.threadRoot;c={threadReply:{senderId:a.senderId,receiverId:a.receiverId,messageServerId:a.messageServerId,createTime:a.createTime,messageClientId:a.messageClientId,conversationType:a.conversationType,conversationId:a.conversationId},threadRoot:{senderId:l?l.senderId:a.senderId,receiverId:l?l.receiverId:a.receiverId,messageServerId:l?l.messageServerId:a.messageServerId,createTime:l?l.createTime:a.createTime,messageClientId:l?l.messageClientId:a.messageClientId,conversationType:l?l.conversationType:a.conversationType,conversationId:l?l.conversationId:a.conversationId}}}var d=this.core.V2NIMConversationIdUtil.parseConversationType(n),u=this.core.V2NIMConversationIdUtil.parseConversationTargetId(n);s.pushConfig&&!0!==s.pushConfig.forcePush&&(delete s.pushConfig.forcePushContent,delete s.pushConfig.forcePushAccountIds);var p={},m={};if(s.aiConfig){var h=get(s,"aiConfig.content.msg"),g=get(s,"aiConfig.content.type")||0;h?m={msg:h,type:g}:void 0===h&&0===o.messageType&&(m={msg:o.text||"",type:g}),(p=Et({},s.aiConfig)).aiStatus=1,void 0!==m.msg&&(p.content=m)}var v=null===(r=null===(t=this.core.V2NIMUserService)||void 0===t?void 0:t.model)||void 0===r?void 0:r.getUser(this.core.account),f=(null==v?void 0:v.updateTime)||0;return Et(Et(Et(Et(Et(Et(Et(Et({},o),c),{messageConfig:Et(Et({},o.messageConfig),s.messageConfig),routeConfig:Et(Et({},o.routeConfig),s.routeConfig),pushConfig:Et(Et({},o.pushConfig),s.pushConfig),antispamConfig:Et(Et({},o.antispamConfig),s.antispamConfig),robotConfig:Et(Et({},o.robotConfig),s.robotConfig)}),p&&p.accountId?{aiConfig:p}:{}),o.attachment?{attachment:Et({},o.attachment)}:{}),{resend:i,senderId:this.core.account,conversationType:d,receiverId:u,conversationId:this.core.V2NIMConversationIdUtil.messageConversationId({conversationType:d,senderId:this.core.account,receiverId:u})}),f?{userUpdateTime:f}:{}),{sendingState:3})},SendUtil}(),Kh=function(){function ModifyUtil(e,t){this.core=e,this.service=t}var e=ModifyUtil.prototype;return e.checkIfModify=function checkIfModify(e,t){var r,n;if("0"===e.messageServerId)throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: messageServerId cannot be empty"}});if(1===e.conversationType&&e.senderId!==this.core.account)throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: senderId should be self"}});if(!includes(r=[0,1,2,3,4,6,10,12,100]).call(r,e.messageType))throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: messageType "+e.messageType+" not correct"}});if(includes(n=[0,1,2,3,6,10,12]).call(n,e.messageType)&&t.attachment)throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: messageType "+e.messageType+" can not modify attachment"}});var a=["subType","text","serverExtension","attachment"];if(!some(a).call(a,(function(e){return void 0!==get(t,e)})))throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: missing modified params"}});if(every(a).call(a,(function(r){return"attachment"===r?e.attachment&&t.attachment?attachmentToRaw(e.messageType,e.attachment)===attachmentToRaw(e.messageType,t.attachment):!t.attachment:get(e,r)===get(t,r)})))throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"modifyMessage: no change"}})},e.prepareMessage=function prepareMessage(e,t){var r=this.generateSendMessage(e,t),n=this.checkIfAntispam(t,r),a=n.clientAntispamResult,i=n.text;return r.text=i,r.clientAntispamHit=!!a&&3===a.operateType,{messageBeforeSend:r,clientAntispamResult:a}},e.modifyMessage=function modifyMessage(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i,o;return Dl.wrap((function _callee$(s){for(;;)switch(s.prev=s.next){case 0:if(1!==e.conversationType){s.next=4;break}r="v2MessageP2pModify",s.next=13;break;case 4:if(2!==e.conversationType){s.next=8;break}r="v2MessageTeamModify",s.next=13;break;case 8:if(3!==e.conversationType){s.next=12;break}r="v2MessageSuperTeamModify",s.next=13;break;case 12:throw new Cl({detail:{reason:"conversationType: "+e.conversationType+" is not supported"}});case 13:return s.next=15,this.core.sendCmd(r,{tag:e});case 15:if(n=s.sent,!t||3!==t.operateType){s.next=18;break}return s.abrupt("return",{errorCode:_l.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,clientAntispamResult:t});case 18:if(a=Et(Et({},e),n.content.data),!(i=a.antispamResult)){s.next=22;break}return s.abrupt("return",Et({errorCode:_l.V2NIM_ERROR_CODE_SERVER_ANTISPAM,antispamResult:i},t?{clientAntispamResult:t}:{}));case 22:return delete a.antispamResult,o=completeMessage(this.core,a),this.service.model.upsertMessages([o]),this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",o),s.abrupt("return",Et(Et({errorCode:200,message:o},i?{antispamResult:i}:{}),t?{clientAntispamResult:t}:{}));case 27:case"end":return s.stop()}}),_callee,this)})))},e.checkIfAntispam=function checkIfAntispam(e,t){var r,n=t.text;if(e.clientAntispamEnabled&&(0===t.messageType||10===t.messageType))if(1===(r=this.core.V2NIMClientAntispamUtil.checkTextAntispam?this.core.V2NIMClientAntispamUtil.checkTextAntispam(t.text||"",e.clientAntispamReplace):{operateType:0,replacedText:""}).operateType)n=r.replacedText;else if(2===r.operateType)throw new Sl({code:_l.V2NIM_ERROR_CODE_CLIENT_ANTISPAM,detail:{reason:"sendMessage: text intercepted by client antispam"}});return{clientAntispamResult:r,text:n}},e.generateSendMessage=function generateSendMessage(e,t){var r;return Et(Et({messageConfig:{lastMessageUpdateEnabled:null===(r=e.messageConfig)||void 0===r?void 0:r.lastMessageUpdateEnabled},routeConfig:Et({routeEnabled:!0},t.routeConfig),pushConfig:Et({pushEnabled:!0,pushNickEnabled:!0,forcePush:!1},t.pushConfig),antispamConfig:Et({antispamEnabled:!0},t.antispamConfig)},t.attachment?{attachment:t.attachment}:{}),{conversationType:e.conversationType,senderId:e.senderId,receiverId:e.receiverId,createTime:e.createTime,messageClientId:e.messageClientId,messageServerId:e.messageServerId,messageType:e.messageType,subType:t.subType,text:t.text,serverExtension:t.serverExtension})},ModifyUtil}(),Yh=function(e){function V2NIMMessageServiceImpl(t,r){var n;return void 0===r&&(r={}),(n=e.call(this,"V2NIMMessageService",t)||this).customAttachmentParsers=[],n.config={compatibleWithV1:!0},n.emitRevokeMessage=function(e){var t=map$6(e).call(e,(function(e){return formatRevokeMessage(n.core,e)}));forEach$1(t).call(t,(function(e){n.model.deleteMessage(e.messageRefer.messageClientId)})),n.emit("onMessageRevokeNotifications",t),n.core.eventBus.emit("V2NIMConversationService/revokeMessages",t)},n.sendMessageHandler=function(e){if(e.msgAckSnapshot){var t=e.msgAckSnapshot,r={conversationId:e.conversationId,messageServerId:e.messageServerId,messageClientId:e.messageClientId,readCount:0,unreadCount:Number(t)};delete e.msgAckSnapshot,n.emit("onReceiveTeamMessageReadReceipts",[r])}e=formatMessageAttachment(e,n.core),n.model.upsertMessages([e]),n.core.eventBus.emit("V2NIMConversationService/sendMessage",e,e.sendingState)},n.revokeMessagesHandler=function(e){forEach$1(e).call(e,(function(e){n.model.deleteMessage(e.messageRefer.messageClientId)})),n.emit("onMessageRevokeNotifications",e),n.core.eventBus.emit("V2NIMConversationService/revokeMessages",e)},n.deleteMessagesHandler=function(e){forEach$1(e).call(e,(function(e){n.model.deleteMessage(e.messageRefer.messageClientId)})),n.emit("onMessageDeletedNotifications",e),n.core.eventBus.emit("V2NIMConversationService/deleteMessages",e)},n.core._registerDep(jp,"V2NIMConversationIdUtil"),n.core._registerDep(Bh,"V2NIMMessageCreator"),n.core._registerDep(Fh,"V2NIMMessageAttachmentCreator"),n.core._registerDep($h,"V2NIMClientAntispamUtil"),n.receiptUtil=new uh(n.core,De(n)),n.fileUtil=new ph(n.core),n.sendUtil=new Wh(n.core,De(n)),n.modifyUtil=new Kh(n.core,De(n)),n.model=new Rm,"v2"!==n.core.options.apiVersion?De(n):(registerParser({cmdMap:em,cmdConfig:sm}),n.setOptions(r),n.setListener(),n)}_t(V2NIMMessageServiceImpl,e);var t=V2NIMMessageServiceImpl.prototype;return t.setOptions=function setOptions(e){var t;(null===(t=this.core.msg)||void 0===t?void 0:t.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Et(this.config,e)},t.setListener=function setListener(){var e=this;this.core.eventBus.on("forwardReceive/V2NIMMessageService/sendMsg",this.sendMessageHandler),this.core.eventBus.on("forwardReceive/V2NIMMessageService/revokeMessages",this.emitRevokeMessage),this.core.eventBus.on("forwardReceive/V2NIMMessageService/deleteMessages",this.deleteMessagesHandler),this.core.eventBus.on("V2NIMConversationService/deleteConversation",(function(t){forEach$1(t).call(t,(function(t){return e.model.deleteMessages(t)}))}))},t.reset=function reset(){this.model.reset()},t.emit=function emit(t){for(var r,n,a,i=this.name+"::emit "+t.toString(),o=arguments.length,s=new Array(o>1?o-1:0),c=1;c<o;c++)s[c-1]=arguments[c];if("onSendMessage"===t){var l=s[0];this.logger.log(""+i,l.messageClientId+"/"+l.messageServerId+"/"+l.createTime+";","sendingState:"+l.sendingState+";attachmentUploadState:"+(l.attachmentUploadState||0)+";messageStatus:"+(null===(a=l.messageStatus)||void 0===a?void 0:a.errorCode))}else if("onReceiveMessages"===t||"onReceiveMessagesModified"===t){var d=s[0];this.logger.log(""+i,map$6(d).call(d,(function(e){return e.messageClientId+"/"+e.messageServerId+"/"+e.createTime})))}else if("onMessageRevokeNotifications"===t){var u=s[0];this.logger.log(""+i,map$6(u).call(u,(function(e){return"msg:"+e.messageRefer.messageClientId+"/"+e.messageRefer.messageServerId+";revokeAccountId:"+e.revokeAccountId})))}else if("onMessageDeletedNotifications"===t){var p=s[0];this.logger.log(""+i,map$6(p).call(p,(function(e){return"msg:"+e.messageRefer.messageClientId+"/"+e.messageRefer.messageServerId})))}else{var m,h;(m=this.logger).log.apply(m,concat(h=[""+i]).call(h,s))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,s))},t.checkExtendUtil=function checkExtendUtil(){var e;if(!(null===(e=this.core.V2NIMMessageExtendUtil)||void 0===e?void 0:e.name))throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"V2NIMMessageLogUtil is not registered"}})},t.checkLogUtil=function checkLogUtil(){var e;if(!(null===(e=this.core.V2NIMMessageLogUtil)||void 0===e?void 0:e.name))throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"V2NIMMessageExtendUtil is not registered"}})},t.getMessageList=function getMessageList(e){return this.checkV2(),this.checkLogUtil(),this.core.V2NIMMessageLogUtil.getMessageList(e)},t.getMessageListByRefers=function getMessageListByRefers(e){return this.checkV2(),this.checkLogUtil(),this.core.V2NIMMessageLogUtil.getMessageListByRefers(e)},t.clearHistoryMessage=function clearHistoryMessage(e){return this.checkV2(),this.checkLogUtil(),this.core.V2NIMMessageLogUtil.clearHistoryMessage(e)},t.pinMessage=function pinMessage(e,t){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.pinMessage(e,t)},t.unpinMessage=function unpinMessage(e,t){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.unpinMessage(e,t)},t.updatePinMessage=function updatePinMessage(e,t){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.updatePinMessage(e,t)},t.voiceToText=function voiceToText(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.voiceToText(e)},t.getPinnedMessageList=function getPinnedMessageList(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.getPinnedMessageList(e)},t.addQuickComment=function addQuickComment(e,t,r,n){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.addQuickComment(e,t,r,n)},t.removeQuickComment=function removeQuickComment(e,t,r){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.removeQuickComment(e,t,r)},t.getQuickCommentList=function getQuickCommentList(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.getQuickCommentList(e)},t.addCollection=function addCollection(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.addCollection(e)},t.removeCollections=function removeCollections(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.removeCollections(e)},t.updateCollectionExtension=function updateCollectionExtension(e,t){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.updateCollectionExtension(e,t)},t.getCollectionListByOption=function getCollectionListByOption(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.getCollectionListByOption(e)},t.getCollectionListExByOption=function getCollectionListExByOption(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.getCollectionListExByOption(e)},t.searchCloudMessages=function searchCloudMessages(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.searchCloudMessages(e)},t.getThreadMessageList=function getThreadMessageList(e){return this.checkV2(),this.checkExtendUtil(),this.core.V2NIMMessageExtendUtil.getThreadMessageList(e)},t.registerCustomAttachmentParser=function registerCustomAttachmentParser(e){var t;"function"==typeof e&&-1===indexOf(t=this.customAttachmentParsers).call(t,e)&&this.customAttachmentParsers.unshift(e)},t.unregisterCustomAttachmentParser=function unregisterCustomAttachmentParser(e){var t,r,n=indexOf(t=this.customAttachmentParsers).call(t,e);n>-1&&splice(r=this.customAttachmentParsers).call(r,n,1)},t.sendP2PMessageReceipt=function sendP2PMessageReceipt(e){return this.checkV2(),this.receiptUtil.sendP2PMessageReceipt(e)},t.isPeerRead=function isPeerRead(e){return this.checkV2(),this.receiptUtil.isPeerRead(e)},t.getP2PMessageReceipt=function getP2PMessageReceipt(e){return this.checkV2(),this.receiptUtil.getP2PMessageReceipt(e)},t.getTeamMessageReceipts=function getTeamMessageReceipts(e){return this.checkV2(),this.receiptUtil.getTeamMessageReceipts(e)},t.getTeamMessageReceiptDetail=function getTeamMessageReceiptDetail(e){return this.checkV2(),this.receiptUtil.getTeamMessageReceiptDetail(e)},t.sendTeamMessageReceipts=function sendTeamMessageReceipts(e){return this.checkV2(),this.receiptUtil.sendTeamMessageReceipts(e)},t.revokeMessage=function revokeMessage(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i,o,s,c;return Dl.wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:if(this.checkV2(),validate(Dm,{message:e,params:t},"",!0),validateConversationId(this.core.account,e.conversationId),1!==e.conversationType||e.senderId===this.core.account){l.next=7;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"revokeMessage: p2p message senderId is not current user"}});case 7:if(e.messageServerId&&"0"!==e.messageServerId){l.next=9;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"revokeMessage: cannot revoke message with invalid messageServerId: "+e.messageServerId}});case 9:return a=3===e.conversationType?"v2RevokeSuperTeamMessage":"v2RevokeMessage",(r={})[1]=7,r[2]=8,r[3]=12,i=r,o=Et(Et(Et({},e),t),{attach:t&&t.serverExtension,sysMsgType:i[e.conversationType],opeAccount:this.core.account}),l.next=14,this.core.sendCmd(a,{tag:o});case 14:(n={})[1]=1,n[2]=2,n[3]=3,s=n,c=[JSON.parse(bn({postscript:t&&t.postscript,revokeType:s[e.conversationType],revokeAccountId:this.core.account,serverExtension:t&&t.serverExtension,messageRefer:formatMessageRefer(this.core,e)}))],this.revokeMessagesHandler(c),this.core.eventBus.emit("forwardSend/V2NIMMessageService/revokeMessage",o);case 18:case"end":return l.stop()}}),_callee,this)})))},t.deleteMessage=function deleteMessage(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n,a,i;return Dl.wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:if(this.checkV2(),validate(Gm,e,"",!0),3!==e.sendingState){o.next=6;break}this.fileUtil.cancelMessageAttachmentUpload(e),o.next=8;break;case 6:if(!e.sendingState||1===e.sendingState){o.next=8;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessage: cannot delete unsent message"}});case 8:if(r={messageRefer:formatMessageRefer(this.core,e),serverExtension:t},n=Hi(),!e.messageServerId||"0"===e.messageServerId){o.next=15;break}return o.next=13,this.core.sendCmd("v2DeleteMessage",{tag:r});case 13:a=o.sent,n=a.content.timetag;case 15:i=[{serverExtension:t,messageRefer:formatMessageRefer(this.core,e),deleteTime:n}],this.core.eventBus.emit("forwardSend/V2NIMMessageService/deleteSelfMsgs",[Et(Et({},r),{deleteTime:n})]),this.deleteMessagesHandler(i);case 18:case"end":return o.stop()}}),_callee2,this)})))},t.deleteMessages=function deleteMessages(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var r,n,a,i,o,s,c,l,d,u,p=this;return Dl.wrap((function _callee3$(m){for(;;)switch(m.prev=m.next){case 0:if(this.checkV2(),validate(Hm,{messages:e},"",!0),n=[],a=[],0!==e.length){m.next=8;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessages: message array length is 0"}});case 8:i=e[0].conversationId,o=0;case 10:if(!(o<e.length)){m.next=23;break}if(3!==e[o].sendingState){m.next=15;break}this.fileUtil.cancelMessageAttachmentUpload(e[o]),m.next=17;break;case 15:if(!e[o].sendingState||1===e[o].sendingState){m.next=17;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessage: sendingState should be succeeded, please check message at index: "+o}});case 17:if(!(o>=1&&e[o].conversationId!==i)){m.next=19;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"deleteMessages: only allow to delete messages from same conversation"}});case 19:e[o].messageServerId&&"0"!==e[o].messageServerId?n.push(e[o]):a.push(e[o]);case 20:o++,m.next=10;break;case 23:if(s=Hi(),c=concat(r=[]).call(r,a),m.prev=25,!(n.length>0)){m.next=32;break}return m.next=29,this.core.sendCmd("v2DeleteMessages",{tag:map$6(n).call(n,(function(e){return{messageRefer:e,serverExtension:t}}))});case 29:d=m.sent,s=d.content.timetag,c=concat(l=[]).call(l,c,n);case 32:m.next=41;break;case 34:if(m.prev=34,m.t0=m.catch(25),0!==a.length){m.next=40;break}throw m.t0;case 40:this.logger.warn("V2NIMMessageService:deleteMessages: delete messages with serverId failed");case 41:u=map$6(c).call(c,(function(e){return{serverExtension:t,messageRefer:formatMessageRefer(p.core,e),deleteTime:s}})),this.core.eventBus.emit("forwardSend/V2NIMMessageService/deleteSelfMsgs",map$6(c).call(c,(function(e){return{messageRefer:e,serverExtension:t,deleteTime:s}}))),this.deleteMessagesHandler(u);case 44:case"end":return m.stop()}}),_callee3,this,[[25,34]])})))},t.cancelMessageAttachmentUpload=function cancelMessageAttachmentUpload(e){return this.checkV2(),this.fileUtil.cancelMessageAttachmentUpload(e)},t.markMsgsAck=function markMsgsAck(e){var t=this;if(e&&e.length>0){var r=[],n=[];forEach$1(e).call(e,(function(e){e.senderId===t.core.account&&e.senderId!==e.receiverId||(1===e.conversationType?r.push(e):2===e.conversationType&&n.push(e))})),r.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:7,cid:2,ids:map$6(r).call(r,(function(e){return e.messageServerId}))}),n.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:8,cid:3,ids:map$6(n).call(n,(function(e){return e.messageServerId}))})}},t.onMsgHandler=function onMsgHandler(e){var t=e.content.msg,r=t._conversationOnlineSyncNotify,n=t._conversationOnlineSyncData,a=__rest(t,["_conversationOnlineSyncNotify","_conversationOnlineSyncData"]),i=completeMessage(this.core,a),o=formatMessageAttachment(i,this.core);this.logger.log("v2OnMsgHandler::recvMsg "+o.messageClientId+" "+o.messageServerId),5!==o.messageType&&this.core.V2NIMUserService.checkUserUpdate&&this.core.V2NIMUserService.checkUserUpdate(o,o.userUpdateTime),!this.config.compatibleWithV1&&this.sendUtil.doMsgReceiveReport(o,e),delete o.__clientExt,this.emit("onReceiveMessages",[o]),this.model.upsertMessages([o]),!this.config.compatibleWithV1&&this.markMsgsAck([o]),r&&this.core.eventBus.emit("V2NIMConversationService/conversationOnlineSyncNotify",{content:{info:JSON.parse(r),data:JSON.parse(n)}},o),5===o.messageType&&this.core.eventBus.emit("V2NIMTeamService/notification",i)},t.syncOfflineMsgsHandler=function syncOfflineMsgsHandler(e){var t=this,r=e.content.datas,n=map$6(r).call(r,(function(e){return formatMessageAttachment(completeMessage(t.core,e),t.core)}));!this.config.compatibleWithV1&&this.markMsgsAck(n),this.emit("onReceiveMessages",n),this.model.upsertMessages(n),this.core.eventBus.emit("V2NIMConversationService/checkBackFill",map$6(n).call(n,(function(e){return e.conversationId})))},t.syncRoamingMsgsHandler=function syncRoamingMsgsHandler(e){var t=this,r=e.content.datas;r=map$6(r).call(r,(function(e){return formatMessageAttachment(completeMessage(t.core,e),t.core)})),this.emit("onReceiveMessages",r),this.model.upsertMessages(r),this.core.eventBus.emit("V2NIMConversationService/checkBackFill",map$6(r).call(r,(function(e){return e.conversationId})))},t.onP2PMessageReceiptsHandler=function onP2PMessageReceiptsHandler(e){this.receiptUtil.onP2PMessageReceiptsHandler(e)},t.onTeamMessageReceiptsHandler=function onTeamMessageReceiptsHandler(e){this.receiptUtil.onTeamMessageReceiptsHandler(e)},t.syncP2PMessagReceiptsHandler=function syncP2PMessagReceiptsHandler(e){this.receiptUtil.syncP2PMessagReceiptsHandler(e)},t.syncRevokeMessageHandler=function syncRevokeMessageHandler(e){this.emitRevokeMessage(e.content.datas)},t.onRevokeMessageHandler=function onRevokeMessageHandler(e){this.emitRevokeMessage([e.content.data])},t.onDeleteMessageHandler=function onDeleteMessageHandler(e){var t=e.content.data,r={serverExtension:t.serverExtension,deleteTime:t.deleteTime,messageRefer:completeMessageRefer(this.core,t.messageRefer)};this.deleteMessagesHandler([r])},t.onDeleteMessagesHandler=function onDeleteMessagesHandler(e){var t,r=this,n=map$6(t=e.content.data).call(t,(function(e){return{serverExtension:e.serverExtension,deleteTime:e.deleteTime,messageRefer:completeMessageRefer(r.core,e.messageRefer)}}));this.deleteMessagesHandler(n)},t.syncOnDeleteMessagesHandler=function syncOnDeleteMessagesHandler(e){var t=this,r=e.content.datas,n=map$6(r).call(r,(function(e){return{serverExtension:e.serverExtension,deleteTime:e.deleteTime,messageRefer:completeMessageRefer(t.core,e.messageRefer)}}));this.emit("onMessageDeletedNotifications",n)},t.sendMessage=function sendMessage(e,t,r,n){return void 0===r&&(r={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var a,i,o,s,c,l,d,u,p=this;return Dl.wrap((function _callee4$(m){for(;;)switch(m.prev=m.next){case 0:if(this.checkV2(),validate({message:{type:"object"}},{message:e},"",!0),e.messageClientId=e.messageClientId||ld(),!e.conversationId||e.conversationId===t){m.next=5;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"sendMessage: message.conversationId is not equal to conversationId"}});case 5:if(validate(Um,{conversationId:t,message:e,params:r},"",!0),validateConversationId(this.core.account,t),2!==(a=this.core.V2NIMConversationIdUtil.parseConversationType(t))&&3!==a||!r.robotConfig||r.robotConfig.accountId){m.next=10;break}throw new Cl({detail:{reason:"When conversationType is team or superTeam, account is required in robotInfo account is required"}});case 10:if(2!==a&&3!==a||!r.targetConfig){m.next=20;break}if(i=r.targetConfig.receiverIds,3!==a||!1!==r.targetConfig.inclusive){m.next=14;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"setting inclusive to false for super teams is not allowed"}});case 14:if(i=filter(i).call(i,(function(e){return e&&e!==p.core.account})),0!==i.length){m.next=17;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"receiverIds cannot be empty or only contain yourself"}});case 17:r.targetConfig.receiverIds=i,m.next=21;break;case 20:r.targetConfig=void 0;case 21:return o=this.core.timeOrigin.getTimeNode(),s=this.sendUtil.prepareMessage(e,t,r),c=s.messageBeforeSend,l=s.clientAntispamResult,d=s.hiddenParams,this.logger.log("V2SendMessage start:"+c.messageClientId+"/"+c.createTime+";conversation:"+t+";","NTPTime:"+this.core.timeOrigin.getNTPTime(o)),m.prev=24,m.next=27,this.sendUtil.doSendMessage({apiCallingTimeNode:o,messageBeforeSend:c,clientAntispamResult:l,hiddenParams:d,progress:n});case 27:u=m.sent,m.next=34;break;case 30:throw m.prev=30,m.t0=m.catch(24),this.logger.warn("V2SendMessage end:"+c.messageClientId+".",m.t0 instanceof Sl?"failed:"+m.t0.code:"failed"),m.t0;case 34:return u.message.senderId===u.message.receiverId&&this.markMsgsAck([u.message]),this.logger.log("V2SendMessage end:"+u.message.messageClientId+"/"+u.message.messageServerId+"/"+u.message.createTime),m.abrupt("return",u);case 37:case"end":return m.stop()}}),_callee4,this,[[24,30]])})))},t.replyMessage=function replyMessage(e,t,r,n){return void 0===r&&(r={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var a,i,o,s,c,l;return Dl.wrap((function _callee5$(d){for(;;)switch(d.prev=d.next){case 0:if(this.checkV2(),validate({message:{type:"object"}},{message:e},"",!0),e.messageClientId=e.messageClientId||ld(),validate(Vm,{message:e,replyMessage:t,params:r},"",!0),validateConversationId(this.core.account,t.conversationId),2!==e.conversationType&&3!==e.conversationType||!r.robotConfig||r.robotConfig.accountId){d.next=7;break}throw new Cl({detail:{reason:"When conversationType is team or superTeam, account is required in robotInfo account is required"}});case 7:return a=this.core.timeOrigin.getTimeNode(),i=this.sendUtil.prepareMessage(e,t.conversationId,r,t),o=i.messageBeforeSend,s=i.clientAntispamResult,c=i.hiddenParams,d.next=11,this.sendUtil.doSendMessage({apiCallingTimeNode:a,messageBeforeSend:o,clientAntispamResult:s,hiddenParams:c,progress:n});case 11:return(l=d.sent).message.senderId===l.message.receiverId&&this.markMsgsAck([l.message]),d.abrupt("return",l);case 14:case"end":return d.stop()}}),_callee5,this)})))},t.modifyMessage=function modifyMessage(e,t){this.checkV2(),this.checkLogin(),validate(lh,e,"message",!0),validate(dh,t,"params",!0),this.modifyUtil.checkIfModify(e,t);var r=this.modifyUtil.prepareMessage(e,t),n=r.messageBeforeSend,a=r.clientAntispamResult;return this.modifyUtil.modifyMessage(n,a)},t.v2MessageOnModifiedHandler=function v2MessageOnModifiedHandler(e){var t=completeMessage(this.core,e.content.data);this.model.upsertMessages([t]),this.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",t),this.emit("onReceiveMessagesModified",[t])},t.v2MessageSyncModifiedHandler=function v2MessageSyncModifiedHandler(e){var t,r,n=this,a=filter(t=map$6(r=e.content.datas).call(r,(function(e){return completeMessage(n.core,e)}))).call(t,(function(e){var t,r=(null===(t=n.model.getMessageById(e.messageClientId))||void 0===t?void 0:t.modifyTime)||0;return(e.modifyTime||0)>r}));a.length>0&&(this.model.upsertMessages(a),forEach$1(a).call(a,(function(e){return n.core.eventBus.emit("forwardSend/V2NIMMessageService/modifyMsg",e)})),this.emit("onReceiveMessagesModified",a))},t.v2MessageSyncSuperTeamModifiedHandler=function v2MessageSyncSuperTeamModifiedHandler(e){this.v2MessageSyncModifiedHandler(e)},V2NIMMessageServiceImpl}(Ru),Qh=Hr.find,Jh="find",Xh=!0;Jh in[]&&Array(1).find((function(){Xh=!1})),_export({target:"Array",proto:!0,forced:Xh},{find:function find(e){return Qh(this,e,arguments.length>1?arguments[1]:void 0)}});var Zh,eg,tg,rg,ng=entryVirtual("Array").find,ag=Array.prototype,find=function(e){var t=e.find;return e===ag||x(ag,e)&&t===ag.find?ng:t},ig="V2NIMMessageLogUtil",og={"30_6":"v2GetMessageList","33_2":"v2GetMessageListByRefers","30_18":"v2ClearHistoryMessage","7_118":"onClearHistoryMessage","4_24":"syncClearHistoryMessage","31_23":"v2GetTeamMessageList","32_14":"v2GetSuperTeamMessageList"},sg={conversationType:{id:0,retType:"number"},receiverId:1,deleteRoam:{id:2,converter:boolToInt},teamId:3,onlineSync:{id:4,converter:boolToInt},deleteTime:{id:6,retType:"number"},serverExtension:7},cg=[{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"direction"},{type:"LongArray",name:"msgTypes"}],lg={v2GetMessageList:{sid:30,cid:6,service:ig,params:concat(Zh=[{type:"String",name:"to"}]).call(Zh,cg),response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(tm)}]},v2GetMessageListByRefers:{sid:33,cid:2,service:ig,params:[{type:"PropertyArray",name:"tag",reflectMapper:tm,select:["conversationType","senderId","receiverId","createTime","messageServerId"]}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(tm)}]},v2ClearHistoryMessage:{sid:30,cid:18,service:ig,params:[{type:"Property",name:"tag",reflectMapper:sg}],response:[{type:"Long",name:"timetag"}]},v2GetTeamMessageList:{sid:31,cid:23,service:ig,params:concat(eg=[{type:"Long",name:"to"}]).call(eg,cg),response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(tm)}]},v2GetSuperTeamMessageList:{sid:32,cid:14,service:ig,params:concat(tg=[{type:"Long",name:"to"}]).call(tg,cg),response:[{type:"PropertyArray",name:"msgs",reflectMapper:invertSerializeItem(tm)}]},onClearHistoryMessage:{sid:7,cid:118,service:ig,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(sg)}]},syncClearHistoryMessage:{sid:4,cid:24,service:ig,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(sg)}]}},dg=function(e){function V2NIMMessageLogUtil(t){var r;return(r=e.call(this,"V2NIMMessageLogUtil",t)||this).clearHistoryMessageHandler=function(e){var t=formatClearHistoryNotification(r.core,e);r.emitClearHistoryMessage([t])},r.core=t,r.service=r.core.V2NIMMessageService,"v2"!==r.core.options.apiVersion?De(r):(registerParser({cmdMap:og,cmdConfig:lg}),r.setListener(),r)}_t(V2NIMMessageLogUtil,e);var t=V2NIMMessageLogUtil.prototype;return t.setListener=function setListener(){this.core.eventBus.on("forwardReceive/V2NIMMessageLogService/clearHistoryMessage",this.clearHistoryMessageHandler)},t.getMessageListByRefers=function getMessageListByRefers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a,i,o,s=this;return Dl.wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:if(this.checkV2(),validate(Fm,{messageRefers:e},"",!0),0!==e.length){c.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageListByRefers: messageRefers cannot be an empty array"}});case 4:if(n=[],a=map$6(e).call(e,(function(e){var t=s.service.model.getMessageById(e.messageClientId);return!t&&e.messageServerId&&"0"!==e.messageServerId&&n.push(e),t})),i=[],!(n.length>0)){c.next=12;break}return c.next=10,this.core.sendCmd("v2GetMessageListByRefers",{tag:n});case 10:o=c.sent,i=o.content.msgs;case 12:return c.abrupt("return",map$6(t=filter(r=map$6(a).call(a,(function(t,r){if(t)return t;var n=e[r],a=find(i).call(i,(function(e){return e.messageServerId===n.messageServerId}));return a?completeMessage(s.core,a):void 0}))).call(r,(function(e){return void 0!==e}))).call(t,(function(e){return formatMessageAttachment(e,s.core)})));case 13:case"end":return c.stop()}}),_callee,this)})))},t.getMessageList=function getMessageList(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n,a,i,o,s,c,l,d,u,p,m,h,g=this;return Dl.wrap((function _callee2$(v){for(;;)switch(v.prev=v.next){case 0:if(this.checkV2(),this.core.V2NIMConversationIdUtil&&this.core.V2NIMConversationIdUtil.parseConversationType){v.next=3;break}throw new Error('Service "V2NIMConversationService" does not exist');case 3:if(validate(qm,e,"",!0),validateConversationId(this.core.account,e.conversationId),i=this.core.V2NIMConversationIdUtil.parseConversationType(e.conversationId),o=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e.conversationId),s=1===i?"v2GetMessageList":2===i?"v2GetTeamMessageList":"v2GetSuperTeamMessageList",c=e.beginTime||0,l=e.endTime||0,!(0!==c&&0!==l&&c>l)){v.next=12;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: beginTime cannot be greater than endTime"}});case 12:if(d=void 0===e.direction?0:e.direction,!e.anchorMessage){v.next=29;break}if(0!==e.direction){v.next=23;break}if(0!==l){v.next=19;break}l=e.anchorMessage.createTime,v.next=21;break;case 19:if(l===e.anchorMessage.createTime){v.next=21;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: When providing anchorMessage, when sorting in descending order, endTime does not need to be provided, or endTime should be equal to anchorMessage.createTime"}});case 21:v.next=29;break;case 23:if(0!==c){v.next=27;break}c=e.anchorMessage.createTime,v.next=29;break;case 27:if(c===e.anchorMessage.createTime){v.next=29;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getMessageList: When providing anchorMessage, when sorting in ascending order, there is no need to provide beginTime, or beginTime should be equal to anchorMessage.createTime"}});case 29:return u=null===(t=e.anchorMessage)||void 0===t?void 0:t.messageServerId,v.next=32,this.core.sendCmd(s,{beginTime:c,endTime:l,lastMsgId:u||0,limit:e.limit||50,direction:d,msgTypes:e.messageTypes?slice(r=e.messageTypes).call(r):[],to:o});case 32:return p=v.sent,m=p.content,h=[],h=map$6(n=m.msgs).call(n,(function(e){return completeMessage(g.core,e)})),u&&(h=filter(h).call(h,(function(e){return e.messageServerId!==u}))),v.abrupt("return",map$6(a=this.getMessageListMonkeyPatch(h,e)).call(a,(function(e){return formatMessageAttachment(e,g.core)})));case 38:case"end":return v.stop()}}),_callee2,this)})))},t.getMessageListMonkeyPatch=function getMessageListMonkeyPatch(e,t){var r=t.conversationId,n=e,a=reduce(n).call(n,(function(e,t){return e[t.messageClientId]=!0,e}),{}),i=this.service.model.getMessagesByConversationId(r);i=sort(i).call(i,(function(e,r){return 1===t.direction?e.createTime-r.createTime:r.createTime-e.createTime}));var o=0,s=t.beginTime||0,c=t.endTime||0;t.anchorMessage&&(0===t.direction?c=t.anchorMessage.createTime:s=t.anchorMessage.createTime,o=findIndex$1(i).call(i,(function(e){var r;return e.messageClientId===(null===(r=t.anchorMessage)||void 0===r?void 0:r.messageClientId)})),o+=1);for(var l=o;l<i.length;l++){var d,u=i[l],p=!a[u.messageClientId],m=void 0===u.sendingState||1===u.sendingState,h=u.conversationId===r,g=u.createTime>s&&(u.createTime<c||0===c),v=!t.messageTypes||includes(d=t.messageTypes).call(d,u.messageType);p&&m&&h&&g&&v&&n.push(i[l])}return n=sort(n).call(n,(function(e,r){return 1===t.direction?e.createTime-r.createTime:r.createTime-e.createTime})),slice(n).call(n,0,t.limit||50)},t.clearHistoryMessage=function clearHistoryMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n,a,i,o,s,c;return Dl.wrap((function _callee3$(l){for(;;)switch(l.prev=l.next){case 0:return this.checkV2(),validate(jm,e,"",!0),validateConversationId(this.core.account,e.conversationId),t=e.conversationId,r=e.deleteRoam,n=e.onlineSync,a=e.serverExtension,i=this.core.V2NIMConversationIdUtil.parseConversationType(t),o=this.core.V2NIMConversationIdUtil.parseConversationTargetId(t),s={deleteRoam:r,onlineSync:n,serverExtension:a,conversationType:i},1===i?s.receiverId=o:s.teamId=o,l.next=10,this.core.sendCmd("v2ClearHistoryMessage",{tag:s});case 10:c=l.sent,this.core.eventBus.emit("forwardSend/V2NIMMessageLogService/clearHistoryMessage",Et(Et({},s),{deleteTime:c.content.timetag})),this.emitClearHistoryMessage([{deleteTime:c.content.timetag,serverExtension:a,conversationId:t}]);case 13:case"end":return l.stop()}}),_callee3,this)})))},t.syncClearHistoryMessageHandler=function syncClearHistoryMessageHandler(e){var t,r=this,n=map$6(t=e.content.data).call(t,(function(e){return formatClearHistoryNotification(r.core,e)}));this.emitClearHistoryMessage(n)},t.onClearHistoryMessageHandler=function onClearHistoryMessageHandler(e){var t=formatClearHistoryNotification(this.core,e.content.data);this.emitClearHistoryMessage([t])},t.emitClearHistoryMessage=function emitClearHistoryMessage(e){var t=this;forEach$1(e).call(e,(function(e){t.service.model.deleteMessages(e.conversationId,e.deleteTime)})),this.service.emit("onClearHistoryNotifications",e)},V2NIMMessageLogUtil}(Ru),ug="V2NIMMessageExtendUtil",pg={"29_5":"v2VoiceToText","33_15":"v2PinMessage","33_16":"v2UpdatePinMessage","33_17":"v2UnpinMessage","23_18":"onPinMessage","23_19":"onUpdatePinMessage","23_20":"onUnpinMessage","23_115":"onPinMessage","23_116":"onUpdatePinMessage","23_117":"onUnpinMessage","33_21":"v2GetPinMessageList","33_3":"v2AddQuickComment","33_4":"v2RemoveQuickComment","33_7":"v2GetQuickComment","23_5":"onAddQuickComment","23_6":"onRemoveQuickComment","23_103":"onAddQuickComment","23_104":"onRemoveQuickComment","33_8":"v2AddCollection","33_9":"v2RemoveCollections","33_10":"v2UpdateCollectionExtension","33_11":"v2GetCollectionListByOption","30_26":"v2SearchCloudMessagesGroupByConversation","30_27":"v2SearchCloudMessages","33_1":"v2GetThreadMessageList"},mg={conversationType:{id:1,converter:conversationTypeV2ToV1,retConverter:conversationTypeV1ToV2,access:"messageRefer.conversationType"},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},createTime:{id:4,retType:"number",access:"messageRefer.createTime"},messageServerId:{id:5,access:"messageRefer.messageServerId"},messageClientId:{id:6,access:"messageRefer.messageClientId"},detail:7,modify:{id:8,retType:"number"}},hg={conversationType:{id:1,access:"messageRefer.conversationType",retConverter:conversationTypeV1ToV2},senderId:{id:2,access:"messageRefer.senderId"},receiverId:{id:3,access:"messageRefer.receiverId"},time:{id:4,access:"messageRefer.createTime",converter:boolToInt,retType:"number"},messageServerId:{id:5,access:"messageRefer.messageServerId"},messageClientId:{id:6,access:"messageRefer.messageClientId"},operatorId:7,serverExtension:8,createTime:{id:9,converter:boolToInt,retType:"number"},updateTime:{id:10,converter:boolToInt,retType:"number"}},vg={operatorId:1,index:{id:2,retType:"number"},createTime:{id:3,retType:"number"},serverExtension:4,pushEnabled:{id:5,access:"pushConfig.pushEnabled",converter:boolToInt},needBadge:{id:6,access:"pushConfig.needBadge",converter:boolToInt},title:{id:7,access:"pushConfig.title"},pushContent:{id:8,access:"pushConfig.pushContent"},pushPayload:{id:9,access:"pushConfig.pushPayload"}},fg={accid:1,serverExtension:2,createTime:{id:3,retType:"number"},updateTime:{id:4,retType:"number"}},yg={collectionId:1,collectionType:{id:2,retType:"number"},collectionData:3,serverExtension:4,uniqueId:5,createTime:{id:6,retType:"number"},updateTime:{id:7,retType:"number"}},_g={keyword:1,beginTime:2,endTime:3,messageLimit:5,sortOrder:{id:6,converter:function converter(e){return 0===e?2:1}},p2pAccountIds:{id:7,converter:function converter(e){return e.join(",")}},teamIds:{id:8,converter:function converter(e){return e.join(",")}},senderAccountIds:{id:9,converter:function converter(e){return e.join(",")}},messageTypes:{id:10,converter:function converter(e){return e.join(",")}},messageSubtypes:{id:11,converter:function converter(e){return e.join(",")}}},Mg=Et(Et({},_g),{conversationLimit:4}),Ig={v2PinMessage:{sid:33,cid:15,service:ug,params:[{type:"Property",name:"msg",reflectMapper:tm,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:fg}],response:[{type:"Long",name:"timetag"}]},v2UnpinMessage:{sid:33,cid:17,service:ug,params:[{type:"Property",name:"msg",reflectMapper:tm,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:fg}],response:[{type:"Long",name:"timetag"}]},v2UpdatePinMessage:{sid:33,cid:16,service:ug,params:[{type:"Property",name:"msg",reflectMapper:tm,select:["conversationType","receiverId","senderId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"msgPin",reflectMapper:fg}],response:[{type:"Long",name:"timetag"}]},v2GetPinMessageList:{sid:33,cid:21,service:ug,params:[{type:"Property",name:"tag",reflectMapper:{conversationId:1,timetag:2}}],response:[{type:"Long",name:"timetag"},{type:"Bool",name:"changed"},{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(hg)}]},v2VoiceToText:{sid:29,cid:5,service:ug,params:[{type:"Property",name:"tag",reflectMapper:{mimeType:0,sampleRate:1,voiceUrl:2,duration:3}}],response:[{type:"String",name:"data"}]},v2AddQuickComment:{sid:33,cid:3,service:ug,params:[{type:"Property",name:"message",reflectMapper:tm,select:["conversationType","senderId","receiverId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"quickComment",reflectMapper:vg}],response:[{type:"Long",name:"timetag"}]},v2RemoveQuickComment:{sid:33,cid:4,service:ug,params:[{type:"Property",name:"message",reflectMapper:tm,select:["conversationType","senderId","receiverId","createTime","messageClientId","messageServerId"]},{type:"Property",name:"quickComment",reflectMapper:vg}],response:[{type:"Long",name:"timetag"}]},onAddQuickComment:{sid:23,cid:5,service:ug,response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(tm)},{type:"Property",name:"quickComment",reflectMapper:invertSerializeItem(vg)}]},onRemoveQuickComment:{sid:23,cid:6,service:ug,response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(tm)},{type:"Property",name:"quickComment",reflectMapper:invertSerializeItem(vg)}]},v2GetQuickComment:{sid:33,cid:7,service:ug,params:[{type:"PropertyArray",name:"tag",reflectMapper:mg}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(mg)}]},onPinMessage:{sid:23,cid:18,service:ug,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(tm)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(fg)}]},onUpdatePinMessage:{sid:23,cid:19,service:ug,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(tm)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(fg)}]},onUnpinMessage:{sid:23,cid:20,service:ug,response:[{type:"Property",name:"msg",reflectMapper:invertSerializeItem(tm)},{type:"Property",name:"pinInfo",reflectMapper:invertSerializeItem(fg)}]},v2AddCollection:{sid:33,cid:8,service:ug,params:[{type:"Property",name:"tag",reflectMapper:yg}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(yg)}]},v2RemoveCollections:{sid:33,cid:9,service:ug,params:[{type:"PropertyArray",name:"tag",reflectMapper:yg,select:["collectionId","createTime"]}],response:[{type:"Int",name:"data"}]},v2UpdateCollectionExtension:{sid:33,cid:10,service:ug,params:[{type:"Property",name:"tag",reflectMapper:yg}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(yg)}]},v2GetCollectionListByOption:{sid:33,cid:11,service:ug,params:[{type:"Property",name:"tag",reflectMapper:{beginTime:1,endTime:2,excludeId:3,limit:4,direction:5,collectionType:6}}],response:[{type:"Long",name:"total"},{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(yg)}]},v2SearchCloudMessagesGroupByConversation:{sid:30,cid:26,service:ug,params:[{type:"Property",name:"tag",reflectMapper:Mg}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2SearchCloudMessages:{sid:30,cid:27,service:ug,params:[{type:"Property",name:"tag",reflectMapper:_g}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(tm)}]},v2GetThreadMessageList:{sid:33,cid:1,service:ug,params:[{type:"Property",name:"messageRefer",reflectMapper:tm},{type:"Property",name:"tag",reflectMapper:{beginTime:1,endTime:2,excludeMessageServerId:3,limit:4,reverse:5}}],response:[{type:"Property",name:"message",reflectMapper:invertSerializeItem(tm)},{type:"Property",name:"replyResult",reflectMapper:invertSerializeItem({total:{id:1,retType:"number"},timestamp:{id:2,retType:"number"}})},{type:"PropertyArray",name:"replyList",reflectMapper:invertSerializeItem(tm)}]}},Sg=function(e){function V2NIMMessageExtendUtil(t){var r;return(r=e.call(this,"V2NIMMessageExtendUtil",t)||this).core=t,"v2"!==r.core.options.apiVersion?De(r):(registerParser({cmdMap:pg,cmdConfig:Ig}),r)}_t(V2NIMMessageExtendUtil,e);var t=V2NIMMessageExtendUtil.prototype;return t.pinMessage=function pinMessage(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(Bm,e,"message",!0),validate($m,{serverExtension:t},"",!0),n.next=5,this.core.sendCmd("v2PinMessage",{msg:e,msgPin:{serverExtension:t}});case 5:r=n.sent,this.emitPinNotification({pinState:1,message:e,serverExtension:t,createTime:r.content.timetag,updateTime:r.content.timetag,operatorId:this.core.account});case 7:case"end":return n.stop()}}),_callee,this)})))},t.unpinMessage=function unpinMessage(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r;return Dl.wrap((function _callee2$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(Bm,e,"messageRefer",!0),validate($m,{serverExtension:t},"",!0),n.next=5,this.core.sendCmd("v2UnpinMessage",{msg:e,msgPin:{serverExtension:t}});case 5:r=n.sent,this.emitPinNotification({pinState:0,message:e,serverExtension:t,updateTime:r.content.timetag,operatorId:this.core.account});case 7:case"end":return n.stop()}}),_callee2,this)})))},t.updatePinMessage=function updatePinMessage(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var r;return Dl.wrap((function _callee3$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(Bm,e,"message",!0),validate($m,{serverExtension:t},"",!0),n.next=5,this.core.sendCmd("v2UpdatePinMessage",{msg:e,msgPin:{serverExtension:t}});case 5:r=n.sent,this.emitPinNotification({pinState:2,message:e,serverExtension:t,updateTime:r.content.timetag,operatorId:this.core.account});case 7:case"end":return n.stop()}}),_callee3,this)})))},t.getPinnedMessageList=function getPinnedMessageList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t,r,n,a,i=this;return Dl.wrap((function _callee4$(o){for(;;)switch(o.prev=o.next){case 0:if(this.checkV2(),this.core.V2NIMConversationIdUtil&&this.core.V2NIMConversationIdUtil.parseConversationType){o.next=3;break}throw new Error('Service "V2NIMConversationService" does not exist');case 3:return validateConversationId(this.core.account,e),n=(n=this.core.V2NIMConversationIdUtil.convertToV1ConversationId(e)).replace("superTeam","super_team"),o.next=8,this.core.sendCmd("v2GetPinMessageList",{tag:{conversationId:n,timetag:0}});case 8:return a=o.sent,o.abrupt("return",sort(t=map$6(r=a.content.data).call(r,(function(e){return Et(Et({},e),{messageRefer:Et(Et({},e.messageRefer),{conversationId:i.core.V2NIMConversationIdUtil.messageConversationId(e.messageRefer)})})}))).call(t,(function(e,t){return t.updateTime-e.updateTime})));case 10:case"end":return o.stop()}}),_callee4,this)})))},t.addQuickComment=function addQuickComment(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var a,i;return Dl.wrap((function _callee5$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validate(Ym,{message:e,index:t,serverExtension:r,pushConfig:n},"",!0),o.next=4,this.core.sendCmd("v2AddQuickComment",{message:e,quickComment:{index:t,serverExtension:r,pushConfig:n}});case 4:a=o.sent,i={operationType:1,quickComment:{messageRefer:formatMessageRefer(this.core,e),createTime:a.content.timetag,index:t,serverExtension:r||"",operatorId:this.core.account}},this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",i);case 7:case"end":return o.stop()}}),_callee5,this)})))},t.removeQuickComment=function removeQuickComment(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var n,a;return Dl.wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validate(Bm,e,"messageRefer",!0),validate({index:{type:"number",min:1}},{index:t},"",!0),validate({serverExtension:{type:"string",required:!1}},{serverExtension:r},"",!0),i.next=6,this.core.sendCmd("v2RemoveQuickComment",{message:e,quickComment:{index:t,serverExtension:r}});case 6:n=i.sent,a={operationType:2,quickComment:{messageRefer:formatMessageRefer(this.core,e),createTime:n.content.timetag,index:t,serverExtension:r||"",operatorId:this.core.account}},this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",a);case 9:case"end":return i.stop()}}),_callee6,this)})))},t.getQuickCommentList=function getQuickCommentList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var t,r,n,a=this;return Dl.wrap((function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validate(Qm,{messages:e},"",!0),r={},i.next=5,this.core.sendCmd("v2GetQuickComment",{tag:map$6(e).call(e,(function(e){return{messageRefer:e}}))});case 5:return n=i.sent,forEach$1(t=n.content.data).call(t,(function(e){var t,n;try{if(!e.detail)return void(r[t=e.messageRefer.messageClientId]||(r[t]=[]));var i=JSON.parse(e.detail);r[n=e.messageRefer.messageClientId]||(r[n]=[]),forEach$1(i).call(i,(function(t){r[e.messageRefer.messageClientId].push({messageRefer:Et(Et({},e.messageRefer),{conversationId:a.core.V2NIMConversationIdUtil.messageConversationId(e.messageRefer)}),operatorId:t[1],index:bd(t[2]),createTime:bd(t[3]),serverExtension:t[4]})}))}catch(t){a.logger.error("getQuickCommentList JSON Parse Error",e.detail,t)}})),i.abrupt("return",r);case 8:case"end":return i.stop()}}),_callee7,this)})))},t.voiceToText=function voiceToText(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t,r,n,a,i,o,s,c,l,d,u;return Dl.wrap((function _callee8$(p){for(;;)switch(p.prev=p.next){case 0:if(this.checkV2(),validate(Km,e,"",!0),e.voicePath||e.voiceUrl||e.file){p.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"voiceToText: voicePathãvoiceUrlãfile cannot be empty at the same time"}});case 4:if(t=e.voicePath,r=e.file,n=e.mimeType,a=e.sampleRate,i=e.duration,o=e.sceneName,s=o?this.core.V2NIMStorageService.getStorageScene(o):null,c=e.voiceUrl){p.next=14;break}return l={},r?l.file=r:0===(null==t?void 0:indexOf(t).call(t,"nim-external"))?l.fileInput=t:l.filePath=t,p.next=12,this.core.cloudStorage.uploadFile(Et({type:"audio",nosScenes:s?s.sceneName:void 0,nosSurvivalTime:s?s.expireTime:void 0},l));case 12:d=p.sent,c=d.url;case 14:return p.next=16,this.core.sendCmd("v2VoiceToText",{tag:{voiceUrl:c,mimeType:n,sampleRate:a,duration:i}},{timeout:3e4});case 16:return u=p.sent,p.abrupt("return",u.content.data);case 18:case"end":return p.stop()}}),_callee8,this)})))},t.onPinMessageHandler=function onPinMessageHandler(e){return this.pinMessageChangeHandler(e,1)},t.onUnpinMessageHandler=function onUnpinMessageHandler(e){return this.pinMessageChangeHandler(e,0)},t.onUpdatePinMessageHandler=function onUpdatePinMessageHandler(e){return this.pinMessageChangeHandler(e,2)},t.pinMessageChangeHandler=function pinMessageChangeHandler(e,t){var r=e.content.msg,n=e.content.pinInfo;r.conversationId=this.core.V2NIMConversationIdUtil.messageConversationId(r),this.emitPinNotification({pinState:t,message:r,serverExtension:n.serverExtension,createTime:n.createTime,updateTime:n.updateTime,operatorId:n.accid})},t.emitPinNotification=function emitPinNotification(e){var t={pinState:e.pinState,pin:Et(Et({serverExtension:e.serverExtension||"",operatorId:e.operatorId},e.createTime?{createTime:e.createTime}:{}),{updateTime:e.updateTime,messageRefer:formatMessageRefer(this.core,e.message)})};this.core.V2NIMMessageService.emit("onMessagePinNotification",t)},t.onAddQuickCommentHandler=function onAddQuickCommentHandler(e){return this.onQuickCommentNotificationHandler(e,1)},t.onRemoveQuickCommentHandler=function onRemoveQuickCommentHandler(e){return this.onQuickCommentNotificationHandler(e,2)},t.onQuickCommentNotificationHandler=function onQuickCommentNotificationHandler(e,t){var r={operationType:t,quickComment:Et({messageRefer:Et(Et({},e.content.message),{conversationId:this.core.V2NIMConversationIdUtil.messageConversationId(e.content.message)})},e.content.quickComment)};this.core.V2NIMMessageService.emit("onMessageQuickCommentNotification",r)},t.addCollection=function addCollection(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t;return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate(Jm,{params:e},"",!0),r.next=4,this.core.sendCmd("v2AddCollection",{tag:e});case 4:return t=r.sent,r.abrupt("return",t.content.data);case 6:case"end":return r.stop()}}),_callee9,this)})))},t.removeCollections=function removeCollections(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var t;return Dl.wrap((function _callee10$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate(Xm,{collections:e},"",!0),r.next=4,this.core.sendCmd("v2RemoveCollections",{tag:e});case 4:return t=r.sent,r.abrupt("return",t.content.data);case 6:case"end":return r.stop()}}),_callee10,this)})))},t.updateCollectionExtension=function updateCollectionExtension(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){var r;return Dl.wrap((function _callee11$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(Zm,{collection:e,serverExtension:t},"",!0),n.next=4,this.core.sendCmd("v2UpdateCollectionExtension",{tag:Et(Et({},e),{serverExtension:t})});case 4:return r=n.sent,n.abrupt("return",r.content.data);case 6:case"end":return n.stop()}}),_callee11,this)})))},t.getCollectionListByOption=function getCollectionListByOption(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t;return Dl.wrap((function _callee12$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate(eh,e,"",!0),r.next=4,this.getCollectionListExByOption(e);case 4:return t=r.sent,r.abrupt("return",t.collectionList);case 6:case"end":return r.stop()}}),_callee12,this)})))},t.getCollectionListExByOption=function getCollectionListExByOption(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var n,a,i,o,s;return Dl.wrap((function _callee13$(c){for(;;)switch(c.prev=c.next){case 0:if(this.checkV2(),validate(eh,e,"",!0),n=e.beginTime||0,a=e.endTime||0,i=void 0===e.direction?0:e.direction,void 0===(null===(t=e.anchorCollection)||void 0===t?void 0:t.collectionId)){c.next=21;break}if(0!==e.direction){c.next=15;break}if(0!==a){c.next=11;break}a=e.anchorCollection.createTime,c.next=13;break;case 11:if(a===e.anchorCollection.createTime){c.next=13;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListExByOption: When providing anchorCollection, when sorting in descending order, endTime does not need to be provided, or endTime should be equal to anchorCollection.createTime"}});case 13:c.next=21;break;case 15:if(0!==n){c.next=19;break}n=e.anchorCollection.createTime,c.next=21;break;case 19:if(n===e.anchorCollection.createTime){c.next=21;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListExByOption: When providing anchorCollection, when sorting in ascending order, there is no need to provide beginTime, or beginTime should be equal to anchorCollection.createTime"}});case 21:if(!(0!==n&&0!==a&&n>=a)){c.next=23;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getCollectionListExByOption: beginTime cannot be greater than endTime"}});case 23:return(o={beginTime:n,endTime:a,direction:i,limit:e.limit,collectionType:e.collectionType,excludeId:(null===(r=e.anchorCollection)||void 0===r?void 0:r.collectionId)?e.anchorCollection.collectionId:0}).collectionType||delete o.collectionType,c.next=27,this.core.sendCmd("v2GetCollectionListByOption",{tag:o});case 27:return s=c.sent,c.abrupt("return",{totalCount:s.content.total,collectionList:s.content.data});case 29:case"end":return c.stop()}}),_callee13,this)})))},t.searchCloudMessages=function searchCloudMessages(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var t,r,n,a,i,o,s,c,l=this;return Dl.wrap((function _callee14$(d){for(;;)switch(d.prev=d.next){case 0:if(this.checkV2(),validate(th,e,"",!0),r=e.beginTime||0,n=e.endTime||0,!(0!==r&&0!==n&&r>n)){d.next=6;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"searchCloudMessages: beginTime cannot be greater than endTime"}});case 6:return a=void 0===e.sortOrder?0:e.sortOrder,i=e.conversationLimit||0,o=e.messageLimit||10,s=i>0?"v2SearchCloudMessagesGroupByConversation":"v2SearchCloudMessages",d.next=12,this.core.sendCmd(s,{tag:Et(Et({},e),{beginTime:r,endTime:n,sortOrder:a,conversationLimit:i,messageLimit:o})});case 12:return c=d.sent,d.abrupt("return",map$6(t=c.content.data).call(t,(function(e){return completeMessage(l.core,e)})));case 14:case"end":return d.stop()}}),_callee14,this)})))},t.getThreadMessageList=function getThreadMessageList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){var t,r,n,a,i,o=this;return Dl.wrap((function _callee15$(s){for(;;)switch(s.prev=s.next){case 0:if(validate(ch,e,"getThreadMessageList",!0),e.beginTime=e.beginTime||0,!(e.endTime&&e.beginTime>e.endTime)){s.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"getThreadMessageList: beginTime cannot be greater than endTime"}});case 4:return s.next=6,this.core.sendCmd("v2GetThreadMessageList",{messageRefer:e.messageRefer,tag:{beginTime:e.beginTime,endTime:e.endTime,limit:e.limit,reverse:1===e.direction?1:0,excludeMessageServerId:e.excludeMessageServerId}});case 6:return t=s.sent,r=t.content,n=r.message,a=r.replyResult,i=r.replyList,s.abrupt("return",{message:completeMessage(this.core,n),timestamp:a.timestamp,replyCount:a.total,replyList:map$6(i).call(i,(function(e){return completeMessage(o.core,e)}))});case 9:case"end":return s.stop()}}),_callee15,this)})))},V2NIMMessageExtendUtil}(Ru),Tg={joinMode:{type:"enum",values:[1,0,2],required:!1},agreeMode:{type:"enum",values:[0,1],required:!1},inviteMode:{type:"enum",values:[1,0],required:!1},updateInfoMode:{type:"enum",values:[1,0],required:!1},updateExtensionMode:{type:"enum",values:[1,0],required:!1},chatBannedMode:{type:"enum",values:[0,1],required:!1}},Cg={type:"object",required:!0,rules:Et({name:{type:"string",allowEmpty:!1},teamType:{type:"enum",values:[1,2]},memberLimit:{type:"number",min:1,required:!1}},Tg)},bg={type:"array",min:1,itemType:"string"},Eg={type:"boolean"},Rg={type:"string"},kg={type:"string",allowEmpty:!1},wg={type:"object",rules:{antispamBusinessId:{type:"string",required:!1}},required:!1},Ag={teamId:{type:"string",regExp:/^[1-9]\d*$/,allowEmpty:!1}},Ng={teamIds:{type:"array",itemType:"string",regExp:/^[1-9]\d*$/,min:1,allowEmpty:!1}},xg={teamType:{type:"enum",values:[1,2]}},Og={teamTypes:{type:"array",itemType:"enum",values:[1,2],required:!1}},Pg={updateTeamInfoParams:{type:"object",required:!0,rules:Et({name:{type:"string",allowEmpty:!1,required:!1},memberLimit:{type:"number",min:1,required:!1}},Tg)}},Lg={type:"enum",values:[0,2]},Vg={memberInfoParams:{type:"object",rules:{teamNick:{type:"string",required:!1},serverExtension:{type:"string",required:!1}}}},Ug={chatBannedMode:{type:"enum",values:[0,1]}},Dg={queryOption:{type:"object",rules:{roleQueryType:{type:"enum",values:[0,2,1]},onlyChatBanned:{type:"boolean",required:!1},direction:{type:"enum",values:[1,0],required:!1},limit:{type:"number",min:1,required:!1},nextToken:{type:"string",required:!1}}}},qg={teamId:Ag.teamId,teamType:{type:"enum",values:[1,2]},operatorAccountId:{type:"string",allowEmpty:!1}},Bg={actionType:{type:"enum",values:[2,0,1,3]}},Fg={actionType:{type:"enum",values:[2]}},Gg={actionType:{type:"enum",values:[0]}},Hg={types:{type:"array",itemType:"enum",values:[0,2,1,3],required:!1},status:{type:"array",itemType:"enum",values:[1,3,0,2],required:!1},offset:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}},jg={teamId:Ag.teamId,teamType:xg.teamType,accountIds:bg},$g=function(){function V2NIMTeamModelImpl(){this.teamMap=new ic,this.superTeamMap=new ic}var e=V2NIMTeamModelImpl.prototype;return e.set=function set(e){var t=this;forEach$1(e).call(e,(function(e){t.chooseMap(e.teamType).set(e.teamId,e)}))},e.reset=function reset(){this.teamMap.clear(),this.superTeamMap.clear()},e.count=function count(e,t){void 0===t&&(t=!0);var r=this.chooseMap(e),count=0;return forEach$1(r).call(r,(function(e){t&&e.isValidTeam&&count++,t||count++})),count},e.chooseMap=function chooseMap(e){return 2===e?this.superTeamMap:1===e?this.teamMap:new ic},e.getById=function getById(e,t,r){void 0===r&&(r=!0);var n=this.chooseMap(t).get(e);if(n){if(r&&n.isValidTeam)return n;if(!r)return n}},e.getAll=function getAll(e,t){void 0===t&&(t=!0);var r=this.chooseMap(e),n=xl(values(r).call(r)),a=filter(n).call(n,(function(e){return!(!t||!e.isValidTeam)||(!t||void 0)}));return sort(a).call(a,(function(e,t){return t.updateTime-e.updateTime}))},e.upsert=function upsert(e){var t=e.teamId,r=e.teamType,n=this.chooseMap(r),a=n.get(t)||{},i=Et({},a,e);return n.set(t,i),i},e.deleteById=function deleteById(e,t){var r=this.getById(e,t);if(r)return r.isValidTeam=!1,r},e.searchTeamByKeyword=function searchTeamByKeyword(e){var t,r,n=[];return forEach$1(t=this.teamMap).call(t,(function(t){var r;includes(r=t.name).call(r,e)&&n.push(t)})),forEach$1(r=this.superTeamMap).call(r,(function(t){var r;includes(r=t.name).call(r,e)&&n.push(t)})),n},V2NIMTeamModelImpl}(),zg=function(){function V2NIMTeamMemberModelImpl(){this.teamMembers=[],this.superTeamMembers=[],this.maxSize=2e3}var e=V2NIMTeamMemberModelImpl.prototype;return e.reset=function reset(){this.teamMembers=[],this.superTeamMembers=[]},e.setData=function setData(e){var t=this;forEach$1(e).call(e,(function(e){t.chooseList(e.teamType).push(e)}))},e.chooseList=function chooseList(e){return 2===e?this.superTeamMembers:1===e?this.teamMembers:[]},e.getById=function getById(e,t,r){var n=this.chooseList(t);return find(n).call(n,(function(t){return t.teamId===e&&t.accountId===r}))},e.upsert=function upsert(e){var t=e.teamType,r=e.teamId,n=this.chooseList(t),a=findIndex$1(n).call(n,(function(t){return t.teamId===r&&t.accountId===e.accountId}));-1===a?n.push(e):n[a]=Et(Et({},n[a]),e),n.length>this.maxSize&&n.shift()},e.deleteByAccount=function deleteByAccount(e,t,r){var n=this.chooseList(t),a=findIndex$1(n).call(n,(function(t){return t.teamId===e&&t.accountId===r}));if(-1!==a){var i=n[a];return i.inTeam=!1,splice(n).call(n,a,1),i}},e.deleteByTeamId=function deleteByTeamId(e,t){var r=this.chooseList(t),n=filter(r).call(r,(function(t){return t.teamId!==e}));2===t?this.superTeamMembers=n:this.teamMembers=n},V2NIMTeamMemberModelImpl}(),Wg=function(){function V2NIMTeamNotificationImpl(e,t){this.core=e,this.service=t}var e=V2NIMTeamNotificationImpl.prototype;return e.processNotification=function processNotification(e){var t=this,r=e.attachment,n=e.senderId,a=e.receiverId,i=r.id,o=r.data,s=i>400?2:1,c=formatTeamNotificationAttachData(o,s),l=c.id,d=c.ids,u=c.tinfo,p=c.mute,m=this.service.model.getById(a,s);switch(this.core.logger.log("v2Team::processNotification, notificationType:"+i+", teamId:"+a,o),i){case rg.SUPER_TEAM_INVITATION:case rg.TEAM_INVITATION:includes(d).call(d,this.core.account)&&this.onTeamJoined(u),this.onTeamMembersJoined(u,filter(d).call(d,(function(e){return e!==t.core.account})));break;case rg.SUPER_TEAM_INVITE_ACCEPT:case rg.TEAM_INVITE_ACCEPT:n===this.core.account?this.onTeamJoined(u):this.onTeamMemberJoined(u,n);break;case rg.SUPER_TEAM_APPLY_ACCEPT:case rg.TEAM_APPLY_ACCEPT:l===this.core.account?this.onTeamJoined(u):this.onTeamMemberJoined(u,l);break;case rg.SUPER_TEAM_ADD_MANAGER:case rg.TEAM_ADD_MANAGER:this.updateTeamMemberRole(a,s,d,{memberRole:2});break;case rg.SUPER_TEAM_REMOVE_MANAGER:case rg.TEAM_REMOVE_MANAGER:this.updateTeamMemberRole(a,s,d,{memberRole:0});break;case rg.SUPER_TEAM_KICK:case rg.TEAM_KICK:this.onTeamInfoUpdated(u),forEach$1(d).call(d,(function(e){e===t.core.account?t.onTeamLeft(a,s,!0):t.onTeamMemberKicked(n,u.teamId,u.teamType,e)}));break;case rg.SUPER_TEAM_LEAVE:case rg.TEAM_LEAVE:u?this.onTeamInfoUpdated(u):m&&n===this.core.account&&(m.isValidTeam=!1,this.onTeamInfoUpdated(m)),n===this.core.account?this.onTeamLeft(a,s,!1):this.onTeamMemberLeft(a,s,n);break;case rg.SUPER_TEAM_DISMISS:case rg.TEAM_DISMISS:this.onTeamDismissed(a,s);break;case rg.SUPER_TEAM_UPDATE:case rg.TEAM_UPDATED:this.onTeamInfoUpdated(u);break;case rg.SUPER_TEAM_TRANSFER_OWNER:case rg.TEAM_TRANSFER_OWNER:this.onTeamInfoUpdated(u),this.updateTeamMemberRole(a,s,[n,u.ownerAccountId],[{memberRole:0},{memberRole:1}]);break;case rg.SUPER_TEAM_MEMBER_MUTE:case rg.TEAM_MEMBER_MUTE:this.service.model.upsert(u),this.updateTeamMemberRole(a,s,l?[l]:d,{chatBanned:0!==p})}},e.onTeamJoined=function onTeamJoined(e){var t=this;this.service.model.upsert(e),this.service.emit("onTeamJoined",e),this.service.getTeamMemberListByIds(e.teamId,e.teamType,[this.core.account]).catch((function(e){t.core.logger.error("Get Member error after onTeamJoined",e)}))},e.onTeamLeft=function onTeamLeft(e,t,r){var n=this.service.model.deleteById(e,t)||generateTeamByTeamId(e,t,{isValidTeam:!1});this.service.memberModel.deleteByAccount(e,t,this.core.account),this.service.emit("onTeamLeft",n,r)},e.onTeamDismissed=function onTeamDismissed(e,t){var r=this.service.model.deleteById(e,t);r||(r=generateTeamByTeamId(e,t,{isValidTeam:!1})),this.service.memberModel.deleteByTeamId(e,t),this.service.emit("onTeamDismissed",r)},e.onTeamInfoUpdated=function onTeamInfoUpdated(e){var t=this.service.model.upsert(e);this.service.emit("onTeamInfoUpdated",t)},e.onTeamMemberJoined=function onTeamMemberJoined(e,t){this.service.model.upsert(e),this.service.emit("onTeamInfoUpdated",e);var r=e.updateTime||e.createTime,n=generateMemberByTeamId(e.teamId,e.teamType,t,{joinTime:r,updateTime:r});this.service.emit("onTeamMemberJoined",[n])},e.onTeamMembersJoined=function onTeamMembersJoined(e,t){var r=e.updateTime||e.createTime,n=map$6(t).call(t,(function(t){return generateMemberByTeamId(e.teamId,e.teamType,t,{joinTime:r,updateTime:r})}));0!==n.length&&(this.service.model.upsert(e),this.service.emit("onTeamInfoUpdated",e),this.service.emit("onTeamMemberJoined",n))},e.onTeamMemberLeft=function onTeamMemberLeft(e,t,r){var n=this.service.memberModel.deleteByAccount(e,t,r);n||(n=generateMemberByTeamId(e,t,r,{inTeam:!1})),this.service.emit("onTeamMemberLeft",[n])},e.onTeamMemberKicked=function onTeamMemberKicked(e,t,r,n){var a=this.service.memberModel.deleteByAccount(t,r,n);a||(a=generateMemberByTeamId(t,r,n,{inTeam:!1})),this.service.emit("onTeamMemberKicked",e,[a])},e.onTeamMemberInfoUpdated=function onTeamMemberInfoUpdated(e){var t=this;forEach$1(e).call(e,(function(e){if(e.accountId===t.core.account&&t.core.V2NIMSettingService.name&&t.core.V2NIMConversationIdUtil.name){var r=1===e.teamType?t.core.V2NIMConversationIdUtil.teamConversationId(e.teamId):t.core.V2NIMConversationIdUtil.superTeamConversationId(e.teamId),n=t.core.V2NIMSettingService.getConversationMuteStatus(r);t.core.eventBus.emit("V2NIMConversationService/setMute",r,n)}})),this.service.emit("onTeamMemberInfoUpdated",e)},e.updateTeamMemberRole=function updateTeamMemberRole(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var a,i,o,s,c=this;return Dl.wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:if(!((i=filter(r).call(r,(function(r,a){var i=c.service.memberModel.getById(e,t,r);return i&&c.service.memberModel.upsert(Et(Et({},i),En(n)?n[a]:n)),!i}))).length>0)){l.next=12;break}return l.prev=2,l.next=5,this.service.getTeamMemberListByIds(e,t,i);case 5:o=l.sent,forEach$1(o).call(o,(function(e){return c.service.memberModel.upsert(e)})),l.next=12;break;case 9:l.prev=9,l.t0=l.catch(2),this.core.logger.warn("v2Team::processNotification, getTeamMemberListByIds failed",l.t0);case 12:(s=filter(a=map$6(r).call(r,(function(r){return c.service.memberModel.getById(e,t,r)}))).call(a,(function(e){return!!e}))).length>0&&this.onTeamMemberInfoUpdated(s);case 14:case"end":return l.stop()}}),_callee,this,[[2,9]])})))},e.processSysNotification=function processSysNotification(e){var t=e.receiverId,r=e.postscript,n=e.senderId,a=e.timestamp;e.idServer;var i={actionType:{0:0,1:1,2:2,3:3,15:0,16:1,17:2,18:3}[e.type],teamId:t,teamType:e.type>=15?2:1,operatorAccountId:n,postscript:r,timestamp:a,actionStatus:0};this.core.logger.log("v2Team::processSysNotification, type:",e.type,i),this.service.notificationModel.create(i),this.service.emit("onReceiveTeamJoinActionInfo",i)},e.updateTeamActionStatus=function updateTeamActionStatus(e,t){this.service.notificationModel.update({teamId:e.teamId,teamType:e.teamType,operatorAccountId:e.operatorAccountId,actionType:e.actionType,actionStatus:t})},e.checkIfExpired=function checkIfExpired(e){return!!e&&(509===e||!(e>=500&&e<=599)&&!(e>=19e4))},V2NIMTeamNotificationImpl}();!function(e){e[e.TEAM_INVITATION=0]="TEAM_INVITATION",e[e.TEAM_KICK=1]="TEAM_KICK",e[e.TEAM_LEAVE=2]="TEAM_LEAVE",e[e.TEAM_UPDATED=3]="TEAM_UPDATED",e[e.TEAM_DISMISS=4]="TEAM_DISMISS",e[e.TEAM_APPLY_ACCEPT=5]="TEAM_APPLY_ACCEPT",e[e.TEAM_TRANSFER_OWNER=6]="TEAM_TRANSFER_OWNER",e[e.TEAM_ADD_MANAGER=7]="TEAM_ADD_MANAGER",e[e.TEAM_REMOVE_MANAGER=8]="TEAM_REMOVE_MANAGER",e[e.TEAM_INVITE_ACCEPT=9]="TEAM_INVITE_ACCEPT",e[e.TEAM_MEMBER_MUTE=10]="TEAM_MEMBER_MUTE",e[e.SUPER_TEAM_INVITATION=401]="SUPER_TEAM_INVITATION",e[e.SUPER_TEAM_KICK=402]="SUPER_TEAM_KICK",e[e.SUPER_TEAM_LEAVE=403]="SUPER_TEAM_LEAVE",e[e.SUPER_TEAM_UPDATE=404]="SUPER_TEAM_UPDATE",e[e.SUPER_TEAM_DISMISS=405]="SUPER_TEAM_DISMISS",e[e.SUPER_TEAM_TRANSFER_OWNER=406]="SUPER_TEAM_TRANSFER_OWNER",e[e.SUPER_TEAM_ADD_MANAGER=407]="SUPER_TEAM_ADD_MANAGER",e[e.SUPER_TEAM_REMOVE_MANAGER=408]="SUPER_TEAM_REMOVE_MANAGER",e[e.SUPER_TEAM_MEMBER_MUTE=409]="SUPER_TEAM_MEMBER_MUTE",e[e.SUPER_TEAM_APPLY_ACCEPT=410]="SUPER_TEAM_APPLY_ACCEPT",e[e.SUPER_TEAM_INVITE_ACCEPT=411]="SUPER_TEAM_INVITE_ACCEPT"}(rg||(rg={}));var Kg=function(){function V2NIMTeamNotificationModelImpl(){this.list=[],this.maxCount=1e3}var e=V2NIMTeamNotificationModelImpl.prototype;return e.reset=function reset(){this.list=[]},e.create=function create(e){this.list.push(e),this.list.length>this.maxCount&&this.list.shift()},e.update=function update(e){var t;forEach$1(t=this.list).call(t,(function(t){t.teamId===e.teamId&&t.teamType===e.teamType&&t.actionType===e.actionType&&t.operatorAccountId===e.operatorAccountId&&0===t.actionStatus&&Et(t,e)}))},e.delete=function _delete(e){var t,r;this.list=filter(t=map$6(r=this.list).call(r,(function(t){if(t.teamId!==e.teamId||t.teamType!==e.teamType||t.operatorAccountId!==e.operatorAccountId||t.actionType!==e.actionType||t.timestamp!==e.timestamp)return t}))).call(t,(function(e){return e}))},e.getByOption=function getByOption(e){var t,r=e.types,n=e.status,a=e.offset,i=void 0===a?0:a,o=e.limit,s=void 0===o?50:o,c=[];forEach$1(t=this.list).call(t,(function(e){r&&r.length>0&&!includes(r).call(r,e.actionType)||n&&n.length>0&&!includes(n).call(n,e.actionStatus)||c.push(e)})),c=sort(c).call(c,(function(e,t){return t.timestamp-e.timestamp}));var l=0;i>0&&(l=findIndexWithinTargetValue(c,"timestamp",i),c[l]&&c[l].timestamp===i&&(l+=1));var d=slice(c).call(c,l).length;return(c=slice(c).call(c,l,l+s)).length>0?{offset:d>s?c[c.length-1].timestamp:0,finished:!(d>s),infos:c}:{offset:0,finished:!0,infos:c}},V2NIMTeamNotificationModelImpl}(),Yg=function(e){function V2NIMTeamServiceImpl(t){var r;return(r=e.call(this,"V2NIMTeamService",t)||this).core._registerDep(jp,"V2NIMConversationIdUtil"),r.notification=new Wg(t,De(r)),r.model=new $g,r.memberModel=new zg,r.notificationModel=new Kg,"v2"!==r.core.options.apiVersion?De(r):(registerParser({cmdMap:$p,cmdConfig:Xp}),r.setListener(),r)}_t(V2NIMTeamServiceImpl,e);var t=V2NIMTeamServiceImpl.prototype;return t.setListener=function setListener(){var e,t,r,n=this;this.core.eventBus.on("forwardReceive/V2NIMTeamService/created",(function(e){n.model.upsert(e);var t=generateMemberByTeamId(e.teamId,e.teamType,n.core.account,{memberRole:1});n.memberModel.upsert(t),n.emit("onTeamCreated",e)})),this.core.eventBus.on("forwardReceive/V2NIMTeamService/updateSelfTeamMemberInfo",(function(e){n.memberModel.upsert(e),n.emit("onTeamInfoUpdated",[e])})),this.core.eventBus.on("forwardReceive/V2NIMTeamService/updateTeamActionStatus",bind$1(e=this.notification.updateTeamActionStatus).call(e,this.notification)),this.core.eventBus.on("V2NIMTeamService/sysNotification",bind$1(t=this.notification.processSysNotification).call(t,this.notification)),this.core.eventBus.on("V2NIMTeamService/notification",bind$1(r=this.notification.processNotification).call(r,this.notification)),this.core.eventBus.on("V2NIMTeamService/onSyncStarted",(function(){n.emit("onSyncStarted")})),this.core.eventBus.on("V2NIMTeamService/onSyncFinished",(function(){n.emit("onSyncFinished")})),this.core.eventBus.on("V2NIMTeamService/onSyncFailed",(function(e){n.emit("onSyncFailed",e)}))},t.reset=function reset(){this.model.reset(),this.memberModel.reset(),this.notificationModel.reset()},t.emit=function emit(t){for(var r,n,a=this.name+"::emit "+t.toString(),i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if("onTeamCreated"===t||"onTeamDismissed"===t||"onTeamJoined"===t||"onTeamLeft"===t||"onTeamInfoUpdated"===t){var c=o[0];this.logger.log(""+a,"team:"+c.teamId+"_"+c.teamType+";updateTime:"+c.updateTime)}else if("onTeamMemberJoined"===t||"onTeamMemberLeft"===t||"onTeamMemberInfoUpdated"===t){var l=o[0];this.logger.log(""+a,map$6(l).call(l,(function(e){return"team:"+e.teamId+"_"+e.teamType+";account:"+e.accountId})))}else if("onTeamMemberKicked"===t){var d=o[0],u=o[1];this.logger.log(""+a,"operator"+d,map$6(u).call(u,(function(e){return"team:"+e.teamId+"_"+e.teamType+";account:"+e.accountId})))}else{var p,m;(p=this.logger).log.apply(p,concat(m=[""+a]).call(m,o))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,o))},t.createTeam=function createTeam(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var a,i,o,s=this;return Dl.wrap((function _callee$(c){for(;;)switch(c.prev=c.next){case 0:return this.checkV2(),validate({createTeamParams:Cg},{createTeamParams:e},"",!0),validate({inviteeAccountIds:Et(Et({},bg),{min:0,required:!1})},{inviteeAccountIds:t},"",!0),validate({antispamConfig:wg},{antispamConfig:n},"",!0),a=2===e.teamType?"v2SuperTeamCreate":"v2TeamCreate",c.next=7,this.core.sendCmd(a,{team:e,inviteeAccountIds:t||[],postscript:r||"",antispamConfig:n});case 7:return i=c.sent,o=i.content.team,this.model.upsert(o),this.getTeamMemberListByIds(o.teamId,o.teamType,[this.core.account]).catch((function(e){s.core.logger.error("Get Member error after createTeam",e)})),this.emit("onTeamCreated",o),c.abrupt("return",{team:o,failedList:i.content.failedList});case 13:case"end":return c.stop()}}),_callee,this)})))},t.updateTeamInfo=function updateTeamInfo(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var a,i;return Dl.wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate(Pg,{updateTeamInfoParams:r},"",!0),validate({antispamConfig:wg},{antispamConfig:n},"",!0),a=Et({teamId:e,teamType:t},r),i=2===t?"v2SuperTeamUpdateInfo":"v2TeamUpdateInfo",o.next=9,this.core.sendCmd(i,{team:a,antispamConfig:n});case 9:this.model.upsert(a);case 10:case"end":return o.stop()}}),_callee2,this)})))},t.leaveTeam=function leaveTeam(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var r;return Dl.wrap((function _callee3$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),r=2===t?"v2SuperTeamLeave":"v2TeamLeave",n.next=6,this.core.sendCmd(r,{teamId:e});case 6:this.model.deleteById(e,t);case 7:case"end":return n.stop()}}),_callee3,this)})))},t.getTeamInfo=function getTeamInfo(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var r,n,a,i;return Dl.wrap((function _callee4$(o){for(;;)switch(o.prev=o.next){case 0:if(this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),r=2===t?"v2SuperTeamGetInfo":"v2TeamGetInfo",!(n=this.model.getById(e,t,!1))){o.next=7;break}return o.abrupt("return",n);case 7:return o.next=9,this.core.sendCmd(r,{teamId:e});case 9:return a=o.sent,i=a.content.team,this.model.upsert(i),o.abrupt("return",i);case 13:case"end":return o.stop()}}),_callee4,this)})))},t.getJoinedTeamList=function getJoinedTeamList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t,r=this;return Dl.wrap((function _callee5$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(Og,{teamTypes:e},"",!0),this.core.V2NIMLoginService.checkIllegalState(),e&&0!==e.length||(e=[1,2]),t=[],forEach$1(e).call(e,(function(e){t=concat(t).call(t,r.model.getAll(e))})),n.abrupt("return",sort(t).call(t,(function(e,t){return e.createTime-t.createTime})));case 7:case"end":return n.stop()}}),_callee5,this)})))},t.getJoinedTeamCount=function getJoinedTeamCount(e){var t=this;this.checkV2(),validate(Og,{teamTypes:e},"",!0),this.core.V2NIMLoginService.checkIllegalState(),e&&0!==e.length||(e=[1,2]);var r=0;return forEach$1(e).call(e,(function(e){r+=t.model.count(e)})),r},t.getTeamInfoByIds=function getTeamInfoByIds(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var r,n,a,i,o,s,c=this;return Dl.wrap((function _callee6$(l){for(;;)switch(l.prev=l.next){case 0:if(this.checkV2(),validate(Ng,{teamIds:e},"",!0),validate(xg,{teamType:t},"",!0),n=2===t?"v2SuperTeamGetByIds":"v2TeamGetByIds",a=map$6(e).call(e,(function(e){return c.model.getById(e,t,!1)})),0!==(i=filter(e).call(e,(function(e,t){return!a[t]}))).length){l.next=8;break}return l.abrupt("return",a);case 8:return l.next=10,this.core.sendCmd(n,{teamIds:i});case 10:return o=l.sent,s=o.content.teams,l.abrupt("return",filter(r=map$6(a).call(a,(function(t,r){if(t)return t;var n=e[r],a=find(s).call(s,(function(e){return e.teamId===n}));return a&&c.model.upsert(a),a}))).call(r,(function(e){return!!e})));case 13:case"end":return l.stop()}}),_callee6,this)})))},t.dismissTeam=function dismissTeam(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var r;return Dl.wrap((function _callee7$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),r=2===t?"v2SuperTeamDismiss":"v2TeamDismiss",n.next=6,this.core.sendCmd(r,{teamId:e});case 6:case"end":return n.stop()}}),_callee7,this)})))},t.inviteMember=function inviteMember(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var a,i;return Dl.wrap((function _callee8$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({inviteeAccountIds:bg},{inviteeAccountIds:r},"",!0),validate({postscript:Et(Et({},Rg),{required:!1})},{postscript:n},"",!0),a=2===t?"v2SuperTeamInviteMembers":"v2TeamInviteMembers",o.next=8,this.core.sendCmd(a,{teamId:e,accounts:r,ps:n||""});case 8:return i=o.sent,o.abrupt("return",i.content.abortedAccidList);case 10:case"end":return o.stop()}}),_callee8,this)})))},t.acceptInvitation=function acceptInvitation(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t,r,n,a,i,o;return Dl.wrap((function _callee9$(s){for(;;)switch(s.prev=s.next){case 0:return this.checkV2(),validate(qg,e,"invitationInfo",!0),validate(Fg,e,"invitationInfo",!0),t=e.teamType,r=e.teamId,n=e.operatorAccountId,a=2===t?"v2SuperTeamAcceptInvitation":"v2TeamAcceptInvitation",s.prev=5,s.next=8,this.core.sendCmd(a,{teamId:r,from:n});case 8:return i=s.sent,this.notification.updateTeamActionStatus(e,1),s.abrupt("return",i.content.team);case 13:throw s.prev=13,s.t0=s.catch(5),o=s.t0,this.notification.checkIfExpired(o.code)&&this.notification.updateTeamActionStatus(e,3),s.t0;case 18:case"end":return s.stop()}}),_callee9,this,[[5,13]])})))},t.rejectInvitation=function rejectInvitation(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var r,n,a,i,o;return Dl.wrap((function _callee10$(s){for(;;)switch(s.prev=s.next){case 0:return this.checkV2(),validate(qg,e,"invitationInfo",!0),validate(Fg,e,"invitationInfo",!0),validate({postscript:Et(Et({},Rg),{required:!1})},{postscript:t},"",!0),r=e.teamType,n=e.teamId,a=e.operatorAccountId,i=2===r?"v2SuperTeamRejectInvite":"v2TeamRejectInvite",s.prev=6,s.next=9,this.core.sendCmd(i,{teamId:n,from:a,ps:t||""});case 9:this.notification.updateTeamActionStatus(e,2),s.next=17;break;case 12:throw s.prev=12,s.t0=s.catch(6),o=s.t0,this.notification.checkIfExpired(o.code)&&this.notification.updateTeamActionStatus(e,3),s.t0;case 17:case"end":return s.stop()}}),_callee10,this,[[6,12]])})))},t.kickMember=function kickMember(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){var n;return Dl.wrap((function _callee11$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({memberAccountIds:bg},{memberAccountIds:r},"",!0),n=2===t?"v2SuperTeamKickMembers":"v2TeamKickMembers",a.next=7,this.core.sendCmd(n,{teamId:e,accounts:r});case 7:case"end":return a.stop()}}),_callee11,this)})))},t.applyJoinTeam=function applyJoinTeam(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var n,a,i,o;return Dl.wrap((function _callee12$(s){for(;;)switch(s.prev=s.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),n=2===t?"v2SuperTeamApplyToJoin":"v2TeamApplyToJoin",s.next=6,this.core.sendCmd(n,{teamId:e,ps:r||""});case 6:return a=s.sent,i=a.content.team,o=a.content.isInTeam,i.isValidTeam=!!i.isValidTeam&&!!o,s.abrupt("return",i);case 11:case"end":return s.stop()}}),_callee12,this)})))},t.acceptJoinApplication=function acceptJoinApplication(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var t,r,n,a,i;return Dl.wrap((function _callee13$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validate(qg,e,"applicationInfo",!0),validate(Gg,e,"applicationInfo",!0),t=e.teamType,r=e.teamId,n=e.operatorAccountId,a=2===t?"v2SuperTeamAcceptJoinApplication":"v2TeamAcceptJoinApplication",o.prev=5,o.next=8,this.core.sendCmd(a,{teamId:r,from:n});case 8:this.notification.updateTeamActionStatus(e,1),o.next=16;break;case 11:throw o.prev=11,o.t0=o.catch(5),i=o.t0,this.notification.checkIfExpired(i.code)&&this.notification.updateTeamActionStatus(e,3),o.t0;case 16:case"end":return o.stop()}}),_callee13,this,[[5,11]])})))},t.rejectJoinApplication=function rejectJoinApplication(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var r,n,a,i,o;return Dl.wrap((function _callee14$(s){for(;;)switch(s.prev=s.next){case 0:return this.checkV2(),validate(qg,e,"applicationInfo",!0),validate(Gg,e,"applicationInfo",!0),validate({postscript:Et(Et({},Rg),{required:!1})},{postscript:t},"",!0),r=e.teamType,n=e.teamId,a=e.operatorAccountId,i=2===r?"v2SuperTeamRejectJoinApplication":"v2TeamRejectJoinApplication",s.prev=6,s.next=9,this.core.sendCmd(i,{teamId:n,from:a,ps:t||""});case 9:this.notification.updateTeamActionStatus(e,2),s.next=17;break;case 12:throw s.prev=12,s.t0=s.catch(6),o=s.t0,this.notification.checkIfExpired(o.code)&&this.notification.updateTeamActionStatus(e,3),s.t0;case 17:case"end":return s.stop()}}),_callee14,this,[[6,12]])})))},t.updateTeamMemberRole=function updateTeamMemberRole(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){var a;return Dl.wrap((function _callee15$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({memberAccountIds:bg},{memberAccountIds:r},"",!0),validate({memberRole:Lg},{memberRole:n},"",!0),a=2===n?"AddManagers":"RemoveManagers",a=2===t?"v2SuperTeam"+a:"v2Team"+a,i.next=9,this.core.sendCmd(a,{teamId:e,accounts:uniq(r)});case 9:case"end":return i.stop()}}),_callee15,this)})))},t.transferTeamOwner=function transferTeamOwner(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var a;return Dl.wrap((function _callee16$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({accountId:kg},{accountId:r},"",!0),validate({leave:{type:"boolean",required:!1}},{leave:n},"",!0),a=2===t?"v2SuperTeamTransferOwner":"v2TeamTransferOwner",i.next=8,this.core.sendCmd(a,{teamId:e,account:r,leave:n||!1});case 8:case"end":return i.stop()}}),_callee16,this)})))},t.updateSelfTeamMemberInfo=function updateSelfTeamMemberInfo(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee17(){var n,a,i,o,s;return Dl.wrap((function _callee17$(c){for(;;)switch(c.prev=c.next){case 0:if(this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate(Vg,{memberInfoParams:r},"",!0),void 0!==r.teamNick||void 0!==r.serverExtension){c.next=6;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER});case 6:return n=2===t?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",a=Et(Et({},r),{teamId:e,accountId:this.core.account}),c.next=10,this.core.sendCmd(n,{teamMember:a});case 10:return c.next=12,this.notification.updateTeamMemberRole(e,t,[this.core.account],a);case 12:i=this.memberModel.getById(e,t,this.core.account),this.core.V2NIMSettingService.name&&this.core.V2NIMConversationIdUtil.name&&(o=1===t?this.core.V2NIMConversationIdUtil.teamConversationId(e):this.core.V2NIMConversationIdUtil.superTeamConversationId(e),s=this.core.V2NIMSettingService.getConversationMuteStatus(o),this.core.eventBus.emit("V2NIMConversationService/setMute",o,s)),this.core.eventBus.emit("forwardSend/V2NIMTeamService/updateSelfTeamMemberInfo",i);case 15:case"end":return c.stop()}}),_callee17,this)})))},t.updateTeamMemberNick=function updateTeamMemberNick(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){var a;return Dl.wrap((function _callee18$(i){for(;;)switch(i.prev=i.next){case 0:if(this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({accountId:kg},{accountId:r},"",!0),validate({nick:Rg},{nick:n},"",!0),r!==this.core.account){i.next=7;break}return i.abrupt("return",this.updateSelfTeamMemberInfo(e,t,{teamNick:n}));case 7:return a=2===t?"v2SuperTeamUpdateMember":"v2TeamUpdateMember",i.next=10,this.core.sendCmd(a,{teamMember:{teamNick:n,teamId:e,accountId:r}});case 10:case"end":return i.stop()}}),_callee18,this)})))},t.setTeamChatBannedMode=function setTeamChatBannedMode(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){var n;return Dl.wrap((function _callee19$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate(Ug,{chatBannedMode:r},"",!0),n=2===t?"v2SuperTeamSetChatBannedMode":"v2TeamSetChatBannedMode",a.next=7,this.core.sendCmd(n,{teamId:e,chatBannedMode:r});case 7:this.model.upsert({teamId:e,teamType:t,chatBannedMode:r});case 8:case"end":return a.stop()}}),_callee19,this)})))},t.setTeamMemberChatBannedStatus=function setTeamMemberChatBannedStatus(e,t,r,n){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){var a;return Dl.wrap((function _callee20$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({accountId:kg},{accountId:r},"",!0),validate({chatBanned:Eg},{chatBanned:n},"",!0),a=2===t?"v2SuperTeamMemberSetChatBannedStatus":"v2TeamMemberSetChatBannedStatus",i.next=8,this.core.sendCmd(a,{teamId:e,accountId:2===t?[r]:r,chatBanned:n?1:0});case 8:case"end":return i.stop()}}),_callee20,this)})))},t.getTeamMemberList=function getTeamMemberList(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){var n,a,i,o;return Dl.wrap((function _callee21$(s){for(;;)switch(s.prev=s.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate(Dg,{queryOption:r},"",!0),n=0===(n=void 0===r.direction?0:r.direction)?1:0,s.next=8,this.core.sendCmd("v2TeamMemberGetList",{tag:Et(Et({teamId:e,teamType:t,onlyChatBanned:!1,nextToken:"",limit:100},r),{direction:n})});case 8:return a=s.sent,i=a.content.datas,o=get(a,"raw.r.0"),2===t&&o&&map$6(o)&&(i=map$6(o).call(o,(function(e){return deserialize(e,invertSerializeItem(Qp))}))),s.abrupt("return",{nextToken:a.content.pageInfo.nextToken||"",finished:!+a.content.pageInfo.hasMore,memberList:processTeamMembers(i,t)});case 13:case"end":return s.stop()}}),_callee21,this)})))},t.getTeamMemberListByIds=function getTeamMemberListByIds(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee22(){var n,a,i,o,s,c,l=this;return Dl.wrap((function _callee22$(d){for(;;)switch(d.prev=d.next){case 0:this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({accountIds:bg},{accountIds:r},"",!0),n=2===t?"v2SuperTeamMemberGetListByIds":"v2TeamMemberGetListByIds",a=map$6(r).call(r,(function(t){return e+"|"+t})),i=[],o=0;case 8:if(!(o<a.length)){d.next=18;break}return d.next=11,this.core.sendCmd(n,{tag:slice(a).call(a,o,o+20)});case 11:s=d.sent,c=processTeamMembers(s.content.datas,t),i=concat(i).call(i,c),forEach$1(c).call(c,(function(e){return l.memberModel.upsert(e)}));case 15:o+=20,d.next=8;break;case 18:return d.abrupt("return",i);case 19:case"end":return d.stop()}}),_callee22,this)})))},t.getTeamMemberInvitor=function getTeamMemberInvitor(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee23(){var n,a;return Dl.wrap((function _callee23$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate({accountIds:bg},{accountIds:r},"",!0),n=2===t?"v2SuperTeamGetMemberInvitor":"v2TeamGetMemberInvitor",i.next=7,this.core.sendCmd(n,{teamId:e,accounts:r});case 7:return a=i.sent,i.abrupt("return",a.content.accountsMap);case 9:case"end":return i.stop()}}),_callee23,this)})))},t.searchTeamByKeyword=function searchTeamByKeyword(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee24(){return Dl.wrap((function _callee24$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),this.checkLogin(),validate({keyword:kg},{keyword:e},"",!0),t.abrupt("return",this.model.searchTeamByKeyword(e));case 4:case"end":return t.stop()}}),_callee24,this)})))},t.addTeamMembersFollow=function addTeamMembersFollow(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee25(){var n,a,i,o,s;return Dl.wrap((function _callee25$(c){for(;;)switch(c.prev=c.next){case 0:return this.checkV2(),validate(jg,{teamId:e,teamType:t,accountIds:r},"",!0),n=2===t?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",c.next=5,this.getTeamMemberListByIds(e,t,[this.core.account]);case 5:return a=c.sent,i=a[0],c.next=9,this.core.sendCmd(n,{teamMember:{teamId:e},specialFollowUpdate:{accountIds:r,operation:1}});case 9:o=c.sent,s=o.content.data,Nt(s).length>0&&(Et(i,s),this.emit("onTeamMemberInfoUpdated",[i]),this.memberModel.upsert(i));case 12:case"end":return c.stop()}}),_callee25,this)})))},t.removeTeamMembersFollow=function removeTeamMembersFollow(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee26(){var n,a,i,o,s;return Dl.wrap((function _callee26$(c){for(;;)switch(c.prev=c.next){case 0:return this.checkV2(),validate(jg,{teamId:e,teamType:t,accountIds:r},"",!0),c.next=4,this.getTeamMemberListByIds(e,t,[this.core.account]);case 4:return n=c.sent,a=n[0],i=2===t?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",c.next=9,this.core.sendCmd(i,{teamMember:{teamId:e},specialFollowUpdate:{accountIds:r,operation:0}});case 9:o=c.sent,s=o.content.data,Nt(s).length>0&&(Et(a,s),this.emit("onTeamMemberInfoUpdated",[a]),this.memberModel.upsert(a));case 12:case"end":return c.stop()}}),_callee26,this)})))},t.getTeamJoinActionInfoList=function getTeamJoinActionInfoList(e){return this.checkV2(),validate(Hg,e,"option",!0),this.core.V2NIMLoginService.checkIllegalState(),Pi.resolve(this.notificationModel.getByOption(e))},t.clearAllTeamJoinActionInfo=function clearAllTeamJoinActionInfo(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee27(){return Dl.wrap((function _callee27$(e){for(;;)switch(e.prev=e.next){case 0:this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),this.notificationModel.reset();case 3:case"end":return e.stop()}}),_callee27,this)})))},t.deleteTeamJoinActionInfo=function deleteTeamJoinActionInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee28(){return Dl.wrap((function _callee28$(t){for(;;)switch(t.prev=t.next){case 0:this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate(qg,e,"",!0),validate(Bg,e,"",!0),validate({timestamp:{type:"number",min:1}},e,"",!0),this.notificationModel.delete(e);case 6:case"end":return t.stop()}}),_callee28,this)})))},t.v2TeamSyncHandler=function v2TeamSyncHandler(e){this.model.set(e.content.datas)},t.v2SuperTeamSyncHandler=function v2SuperTeamSyncHandler(e){this.model.set(e.content.datas)},t.v2TeamCreateMultiSyncHandler=function v2TeamCreateMultiSyncHandler(e){var t=e.content.data;this.model.upsert(t);var r=generateMemberByTeamId(t.teamId,t.teamType,this.core.account,{memberRole:1});this.memberModel.upsert(r),this.emit("onTeamCreated",t)},t.v2SuperTeamCreateMultiSyncHandler=function v2SuperTeamCreateMultiSyncHandler(e){var t=e.content.data;this.model.upsert(t);var r=generateMemberByTeamId(t.teamId,t.teamType,this.core.account,{memberRole:1});this.memberModel.upsert(r),this.emit("onTeamCreated",t)},t.v2TeamMemberUpdateMultiSyncHandler=function v2TeamMemberUpdateMultiSyncHandler(e){var t=e.content.data;t.teamType=1;var r=this.memberModel.getById(t.teamId,t.teamType,t.accountId);this.notification.updateTeamMemberRole(t.teamId,t.teamType,[t.accountId],t),t.accountId===this.core.account&&r&&r.bits!==t.bits&&this.core.eventBus.emit("V2NIMSettingService/updateBits",t.teamId,t.teamType,t.bits)},t.v2SuperTeamMemberUpdateMultiSyncHandler=function v2SuperTeamMemberUpdateMultiSyncHandler(e){var t=e.content.data;t.teamType=2;var r=this.memberModel.getById(t.teamId,t.teamType,t.accountId);this.notification.updateTeamMemberRole(t.teamId,t.teamType,[t.accountId],t),t.accountId===this.core.account&&r&&r.bits!==t.bits&&this.core.eventBus.emit("V2NIMSettingService/updateBits",t.teamId,t.teamType,t.bits)},t.v2TeamMembersOfSelfInSyncHandler=function v2TeamMembersOfSelfInSyncHandler(e){var t=e.content.datas;forEach$1(t).call(t,(function(e){e.teamType=1})),this.memberModel.setData(t)},t.v2SuperTeamMembersOfSelfInSyncHandler=function v2SuperTeamMembersOfSelfInSyncHandler(e){var t=e.content.datas;forEach$1(t).call(t,(function(e){e.teamType=2})),this.memberModel.setData(t)},V2NIMTeamServiceImpl}(Ru),Qg="V2NIMUserService",Jg={"34_3":"v2UpdateBlockList","34_7":"v2GetUserList","34_10":"v2UpdateSelfUserProfile","3_109":"v2SyncSelfUserInfo","3_110":"onUpdateUserProfile","3_103":"onUpdateBlockList","3_8":"syncBlockAndMuteList","34_5":"v2SetP2PMessageMuteMode","3_105":"v2OnUpdateMuteList"},Xg={accountId:1,name:3,avatar:4,sign:5,gender:{id:6,retType:"number"},email:7,birthday:8,mobile:9,serverExtension:10,createTime:{id:12,retType:"number"},updateTime:{id:13,retType:"number"}},Zg={v2UpdateBlockList:{sid:34,cid:3,service:Qg,params:[{type:"String",name:"accountId"},{type:"Bool",name:"addToBlockList"}]},v2GetUserList:{sid:34,cid:7,service:Qg,params:[{type:"StrArray",name:"accountIds"}],response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem(Xg)}]},v2UpdateSelfUserProfile:{sid:34,cid:10,service:Qg,params:[{type:"Property",name:"tag",reflectMapper:Xg}],response:[{type:"Long",name:"updateTime"}]},onUpdateUserProfile:{sid:3,cid:110,service:Qg,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(Xg)}]},onUpdateBlockList:{sid:3,cid:103,service:Qg,response:[{type:"String",name:"accountId"},{type:"Bool",name:"addToBlockList"}]},syncBlockAndMuteList:{sid:3,cid:8,service:Qg,response:[{type:"PropertyArray",name:"data",reflectMapper:invertSerializeItem({accountId:0,isMute:{id:1,retType:"boolean"},isBlock:{id:2,retType:"boolean"}})},{type:"Long",name:"timetag"}]},v2SyncSelfUserInfo:{sid:3,cid:109,service:Qg,response:[{type:"Property",name:"user",reflectMapper:invertSerializeItem(Xg)}]},v2SetP2PMessageMuteMode:{sid:34,cid:5,service:Qg,params:[{type:"String",name:"accountId"},{type:"Bool",name:"muteMode"}]},v2OnUpdateMuteList:{sid:3,cid:105,service:Qg,response:[{type:"String",name:"accountId"},{type:"Bool",name:"mute"}]}};collection("Set",(function(e){return function Set(){return e(this,arguments.length?arguments[0]:void 0)}}),Ws);var ev=N.Set;_export({target:"Set",stat:!0,forced:!0},{from:Qs}),_export({target:"Set",stat:!0,forced:!0},{of:Js});_export({target:"Set",proto:!0,real:!0,forced:!0},{addAll:function addAll(){for(var e=anObject(this),t=aCallable(e.add),r=0,n=arguments.length;r<n;r++)y(t,e,arguments[r]);return e}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{deleteAll:Xs});var tv=getIterator;_export({target:"Set",proto:!0,real:!0,forced:!0},{every:function every(e){var t=anObject(this),r=tv(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);return!iterate(r,(function(e,r){if(!n(e,e,t))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{difference:function difference(e){var t=anObject(this),r=new(speciesConstructor(t,getBuiltIn("Set")))(t),n=aCallable(r.delete);return iterate(e,(function(e){y(n,r,e)})),r}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{filter:function filter(e){var t=anObject(this),r=tv(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0),a=new(speciesConstructor(t,getBuiltIn("Set"))),i=aCallable(a.add);return iterate(r,(function(e){n(e,e,t)&&y(i,a,e)}),{IS_ITERATOR:!0}),a}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{find:function find(e){var t=anObject(this),r=tv(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);return iterate(r,(function(e,r){if(n(e,e,t))return r(e)}),{IS_ITERATOR:!0,INTERRUPTED:!0}).result}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{intersection:function intersection(e){var t=anObject(this),r=new(speciesConstructor(t,getBuiltIn("Set"))),n=aCallable(t.has),a=aCallable(r.add);return iterate(e,(function(e){y(n,t,e)&&y(a,r,e)})),r}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{isDisjointFrom:function isDisjointFrom(e){var t=anObject(this),r=aCallable(t.has);return!iterate(e,(function(e,n){if(!0===y(r,t,e))return n()}),{INTERRUPTED:!0}).stopped}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{isSubsetOf:function isSubsetOf(e){var t=getIterator(this),r=anObject(e),n=r.has;return isCallable(n)||(r=new(getBuiltIn("Set"))(e),n=aCallable(r.has)),!iterate(t,(function(e,t){if(!1===y(n,r,e))return t()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{isSupersetOf:function isSupersetOf(e){var t=anObject(this),r=aCallable(t.has);return!iterate(e,(function(e,n){if(!1===y(r,t,e))return n()}),{INTERRUPTED:!0}).stopped}});var rv=g([].join),nv=[].push;_export({target:"Set",proto:!0,real:!0,forced:!0},{join:function join(e){var t=anObject(this),r=tv(t),n=void 0===e?",":toString(e),a=[];return iterate(r,nv,{that:a,IS_ITERATOR:!0}),rv(a,n)}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{map:function map(e){var t=anObject(this),r=tv(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0),a=new(speciesConstructor(t,getBuiltIn("Set"))),i=aCallable(a.add);return iterate(r,(function(e){y(i,a,n(e,e,t))}),{IS_ITERATOR:!0}),a}});var av=TypeError;_export({target:"Set",proto:!0,real:!0,forced:!0},{reduce:function reduce(e){var t=anObject(this),r=tv(t),n=arguments.length<2,a=n?void 0:arguments[1];if(aCallable(e),iterate(r,(function(r){n?(n=!1,a=r):a=e(a,r,r,t)}),{IS_ITERATOR:!0}),n)throw av("Reduce of empty set with no initial value");return a}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{some:function some(e){var t=anObject(this),r=tv(t),n=functionBindContext(e,arguments.length>1?arguments[1]:void 0);return iterate(r,(function(e,r){if(n(e,e,t))return r()}),{IS_ITERATOR:!0,INTERRUPTED:!0}).stopped}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{symmetricDifference:function symmetricDifference(e){var t=anObject(this),r=new(speciesConstructor(t,getBuiltIn("Set")))(t),n=aCallable(r.delete),a=aCallable(r.add);return iterate(e,(function(e){y(n,r,e)||y(a,r,e)})),r}}),_export({target:"Set",proto:!0,real:!0,forced:!0},{union:function union(e){var t=anObject(this),r=new(speciesConstructor(t,getBuiltIn("Set")))(t);return iterate(e,aCallable(r.add),{that:r}),r}});var iv=ev,ov=function(){function V2NIMUserModelImpl(){this.muteList=new iv,this.userMap=new ic,this.blockList=[]}var e=V2NIMUserModelImpl.prototype;return e.reset=function reset(){this.muteList.clear(),this.userMap.clear(),this.blockList=[]},e.setAccountMuteMode=function setAccountMuteMode(e,t){1===t?this.muteList.add(e):this.muteList.delete(e)},e.setUser=function setUser(e){this.userMap.set(e.accountId,e)},e.getUser=function getUser(e){return this.userMap.get(e)},e.getUserListBySearchOption=function getUserListBySearchOption(e){var t,r;return filter(t=xl(values(r=this.userMap).call(r))).call(t,(function(t){var r,n,a;return!(void 0!==e.searchName&&!e.searchName||!includes(r=t.name).call(r,e.keyword))||(!(!e.searchAccountId||!includes(n=t.accountId).call(n,e.keyword))||!!(t.mobile&&e.searchMobile&&includes(a=t.mobile).call(a,e.keyword)))}))},e.addToBlockList=function addToBlockList(e){var t=this;forEach$1(e).call(e,(function(e){var r;includes(r=t.blockList).call(r,e)||t.blockList.push(e)}))},e.removeFromBlockList=function removeFromBlockList(e){var t=this;forEach$1(e).call(e,(function(e){var r,n,a=indexOf(r=t.blockList).call(r,e);-1!==a&&splice(n=t.blockList).call(n,a,1)}))},V2NIMUserModelImpl}(),sv={type:"string",required:!0,allowEmpty:!1},cv={type:"string",required:!1,allowEmpty:!0},lv={name:{type:"string",required:!1,allowEmpty:!0},avatar:cv,sign:cv,email:cv,birthday:cv,mobile:cv,gender:{type:"number",required:!1},serverExtension:cv};function _createForOfIteratorHelperLoose$6(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$6(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$6(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$6(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$6(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var dv=function(e){function V2NIMUserServiceImpl(t){var r;return r=e.call(this,"V2NIMUserService",t)||this,registerParser({cmdMap:Jg,cmdConfig:Zg}),r.model=new ov,"v2"!==r.core.options.apiVersion?De(r):(r.setListener(),r)}_t(V2NIMUserServiceImpl,e);var t=V2NIMUserServiceImpl.prototype;return t.reset=function reset(){this.model.reset()},t.setListener=function setListener(){var e,t=this;this.core.eventBus.on("V2NIMUserService/refreshUserInfo",bind$1(e=this.refreshUserInfo).call(e,this)),this.core.eventBus.on("forwardReceive/V2NIMUserService/updateBlockList",(function(e,r){r?t.model.addToBlockList([e]):t.model.removeFromBlockList([e]),r?t.emitBlockListAdded(e):t.emit("onBlockListRemoved",e)})),this.core.eventBus.on("forwardReceive/V2NIMUserService/updateUserProfile",(function(e){t.updateUserProfileInMemory(e)}))},t.emit=function emit(t){for(var r,n,a=this.name+"::emit "+t.toString(),i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if("onUserProfileChanged"===t){var c=o[0];this.logger.log(""+a,map$6(c).call(c,(function(e){return"id:"+e.accountId+";name:"+e.name+";updateTime:"+e.updateTime})))}else if("onBlockListAdded"===t){var l=o[0];this.logger.log(""+a,"id:"+l.accountId+";name:"+l.name+";updateTime:"+l.updateTime)}else{var d,u;(d=this.logger).log.apply(d,concat(u=[""+a]).call(u,o))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,o))},t.getUserList=function getUserList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),t.abrupt("return",this._getUserList(e));case 2:case"end":return t.stop()}}),_callee,this)})))},t._getUserList=function _getUserList(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n,a,i,o=this;return Dl.wrap((function _callee2$(s){for(;;)switch(s.prev=s.next){case 0:if(validate({accountIds:bg},{accountIds:e},"",!0),r=[],forEach$1(e).call(e,(function(e){o.model.getUser(e)||r.push(e)})),n=null,!(r.length>0)){s.next=8;break}return s.next=7,this.core.sendCmd("v2GetUserList",{accountIds:r});case 7:n=s.sent;case 8:return a=(null===(t=null==n?void 0:n.content)||void 0===t?void 0:t.data)||[],forEach$1(a).call(a,(function(e){o.model.setUser(e)})),i=[],forEach$1(e).call(e,(function(e){var t=o.model.getUser(e);t&&i.push(t)})),s.abrupt("return",i);case 13:case"end":return s.stop()}}),_callee2,this)})))},t.getUserListFromCloud=function getUserListFromCloud(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n,a,i=this;return Dl.wrap((function _callee3$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validate({accountIds:{type:"array",min:1,max:500,itemType:"string"}},{accountIds:e},"",!0),o.next=4,this.core.sendCmd("v2GetUserList",{accountIds:e});case 4:return t=o.sent,r=t.content.data||[],n=[],forEach$1(r).call(r,(function(e){var t=i.model.getUser(e.accountId);i.compareUserForUpdate(t,e)&&n.push(e),i.model.setUser(e)})),a=reduce(e).call(e,(function(e,t){var r=i.model.getUser(t);return r&&e.push(r),e}),[]),n.length>0&&this.emit("onUserProfileChanged",n),o.abrupt("return",a);case 11:case"end":return o.stop()}}),_callee3,this)})))},t.compareUserForUpdate=function compareUserForUpdate(e,t){return!e||!("number"==typeof e.updateTime&&"number"==typeof t.updateTime&&e.updateTime>=t.updateTime)},t.updateSelfUserProfile=function updateSelfUserProfile(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate(lv,e,"",!0),r.next=4,this.core.sendCmd("v2UpdateSelfUserProfile",{tag:Et(Et({},e),{accountId:this.core.account})});case 4:return t=r.sent,r.next=7,this.updateUserProfileInMemory(Et({updateTime:t.content.updateTime},e));case 7:case"end":return r.stop()}}),_callee4,this)})))},t.addUserToBlockList=function addUserToBlockList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:if(this.checkV2(),e!==this.core.account){t.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot block yourself"}});case 3:return validate({accountId:sv},{accountId:e},"",!0),t.next=6,this.core.sendCmd("v2UpdateBlockList",{accountId:e,addToBlockList:!0});case 6:this.model.addToBlockList([e]),this.emitBlockListAdded(e);case 8:case"end":return t.stop()}}),_callee5,this)})))},t.removeUserFromBlockList=function removeUserFromBlockList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:if(this.checkV2(),e!==this.core.account){t.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot unblock yourself"}});case 3:return validate({accountId:sv},{accountId:e},"",!0),t.next=6,this.core.sendCmd("v2UpdateBlockList",{accountId:e,addToBlockList:!1});case 6:this.model.removeFromBlockList([e]),this.emit("onBlockListRemoved",e);case 8:case"end":return t.stop()}}),_callee6,this)})))},t.searchUserByOption=function searchUserByOption(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:if(this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({keyword:{type:"string",allowEmpty:!1},searchName:{type:"boolean",required:!1},searchAccountId:{type:"boolean",required:!1},searchMobile:{type:"boolean",required:!1}},e,"",!0),!1!==(void 0===e.searchName||e.searchName)||e.searchAccountId||e.searchMobile){t.next=6;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"one of searchName, searchAccountId, searchMobile must be true"}});case 6:return t.abrupt("return",this.model.getUserListBySearchOption(e));case 7:case"end":return t.stop()}}),_callee7,this)})))},t.getBlockList=function getBlockList(){return this.checkV2(),Pi.resolve(this.model.blockList)},t.updateUserProfileInMemory=function updateUserProfileInMemory(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t,r;return Dl.wrap((function _callee8$(n){for(;;)switch(n.prev=n.next){case 0:if(!(t=this.model.getUser(this.core.account))){n.next=6;break}Et(t,e),this.model.setUser(t),n.next=10;break;case 6:return n.next=8,this._getUserList([this.core.account]);case 8:r=n.sent,t=r[0];case 10:t&&this.emit("onUserProfileChanged",[t]);case 11:case"end":return n.stop()}}),_callee8,this)})))},t.onUpdateUserProfileHandler=function onUpdateUserProfileHandler(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t;return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return t=e.content.data,r.next=3,this.updateUserProfileInMemory(t);case 3:case"end":return r.stop()}}),_callee9,this)})))},t.onUpdateBlockListHandler=function onUpdateBlockListHandler(e){var t=e.content.accountId;e.content.addToBlockList?(this.model.addToBlockList([t]),this.emitBlockListAdded(t)):(this.model.removeFromBlockList([t]),this.emit("onBlockListRemoved",t))},t.syncBlockAndMuteListHandler=function syncBlockAndMuteListHandler(e){var t=this,r=e.content.data;forEach$1(r).call(r,(function(e){e.isBlock?t.model.addToBlockList([e.accountId]):t.model.setAccountMuteMode(e.accountId,e.isMute?1:0)}))},t.v2SyncSelfUserInfoHandler=function v2SyncSelfUserInfoHandler(e){var t=e.content.user;this.model.setUser(t)},t.checkUserUpdate=function checkUserUpdate(e,t){var r=e.senderId;r!==this.core.account&&this.refreshUserInfo(r,t)},t.refreshUserInfo=function refreshUserInfo(e,t){return void 0===t&&(t=0),__awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var r,n,a,i,o,s;return Dl.wrap((function _callee10$(c){for(;;)switch(c.prev=c.next){case 0:if(e&&"string"==typeof e){c.next=2;break}return c.abrupt("return");case 2:if(r=this.model.getUser(e),n=[],!(!r||r&&"number"==typeof r.updateTime&&"number"==typeof t&&!isNaN(r.updateTime)&&!isNaN(t)&&r.updateTime<t)){c.next=15;break}return c.prev=5,c.next=8,this.core.sendCmd("v2GetUserList",{accountIds:[e]});case 8:a=c.sent,n=a.content.data,c.next=15;break;case 12:c.prev=12,c.t0=c.catch(5),this.logger.warn("V2NIMUserService:refreshUserInfo: failed for "+e);case 15:for(i=_createForOfIteratorHelperLoose$6(n);!(o=i()).done;)s=o.value,this.model.setUser(s),this.emit("onUserProfileChanged",[s]);case 16:case"end":return c.stop()}}),_callee10,this,[[5,12]])})))},t.emitBlockListAdded=function emitBlockListAdded(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){var t;return Dl.wrap((function _callee11$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this._getUserList([e]);case 2:1===(t=r.sent).length&&this.emit("onBlockListAdded",t[0]);case 4:case"end":return r.stop()}}),_callee11,this)})))},t.v2OnUpdateMuteListHandler=function v2OnUpdateMuteListHandler(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t,r,n,a;return Dl.wrap((function _callee12$(i){for(;;)switch(i.prev=i.next){case 0:t=e.content,r=t.accountId,n=t.mute,a=n?1:0,this.core.eventBus.emit("v2NIMUserService/updateMuteList",r,a);case 3:case"end":return i.stop()}}),_callee12,this)})))},V2NIMUserServiceImpl}(Ru),uv="V2NIMFriendService",pv={"35_1":"v2AddFriend","35_2":"v2DeleteFriend","35_3":"v2SetFriendInfo","35_4":"v2IncFriendInfo","12_101":"v2OnAddFriend","12_102":"v2OnDeleteFriend","12_103":"v2OnUpdateFriendInfo","12_5":"v2SyncFriendList","12_6":"v2SyncFriendUserList"},mv={accountId:4,source:{id:7,retType:"number"},alias:8,serverExtension:10,createTime:{id:11,retType:"number"},updateTime:{id:12,retType:"number"},customerExtension:13},hv={v2AddFriend:{sid:35,cid:1,service:uv,params:[{type:"String",name:"accountId"},{type:"Byte",name:"verifyType"},{type:"String",name:"postscript"}],response:[]},v2DeleteFriend:{sid:35,cid:2,service:uv,params:[{type:"String",name:"accountId"},{type:"Property",name:"params",reflectMapper:{deleteAlias:{id:1,converter:boolToInt}}}]},v2SetFriendInfo:{sid:35,cid:3,service:uv,params:[{type:"Property",name:"tag",reflectMapper:mv}]},v2OnAddFriend:{sid:12,cid:101,service:uv,response:[{type:"String",name:"accountId"},{type:"Byte",name:"verifyType"},{type:"String",name:"postscript"},{type:"Property",name:"ext",reflectMapper:invertSerializeItem({serverExt:1})}]},v2OnDeleteFriend:{sid:12,cid:102,service:uv,response:[{type:"String",name:"accountId"}]},v2OnUpdateFriendInfo:{sid:12,cid:103,service:uv,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(mv)}]},v2SyncFriendList:{sid:12,cid:5,service:uv,response:[{type:"PropertyArray",name:"friends",reflectMapper:invertSerializeItem(mv)},{type:"Long",name:"timetag"}]},v2SyncFriendUserList:{sid:12,cid:6,service:uv,response:[{type:"PropertyArray",name:"users",reflectMapper:invertSerializeItem(Xg)}]},v2IncFriendInfo:{sid:35,cid:4,service:uv,params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"friends",reflectMapper:invertSerializeItem(mv)},{type:"Long",name:"timetag"}]}},gv={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!0,rules:{addMode:{type:"enum",required:!0,values:[1,2]},postscript:{type:"string",required:!1,allowEmpty:!0}}}},vv={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!1,rules:{deleteAlias:{type:"boolean",required:!1}}}},fv={accountId:{type:"string",required:!0,allowEmpty:!1},params:{type:"object",required:!1,rules:{alias:{type:"string",required:!1,allowEmpty:!0},serverExtension:{type:"string",required:!1,allowEmpty:!0}}}},yv={applicantAccountId:{type:"string",required:!0,allowEmpty:!1},recipientAccountId:{type:"string",required:!0,allowEmpty:!1},operatorAccountId:{type:"string",required:!1,allowEmpty:!1},postscript:{type:"string",required:!1,allowEmpty:!0},status:{type:"enum",required:!0,values:[1,4,3,0,2]},timestamp:{type:"number",min:1}},_v={offset:{type:"number",required:!1},limit:{type:"number",required:!1},status:{type:"array",itemType:"enum",required:!1,values:[1,4,3,0,2]}},Mv=function(){function V2NIMFriendNotificationImpl(e,t){this.core=e,this.service=t}return V2NIMFriendNotificationImpl.prototype.processSysNotification=function processSysNotification(e){if(6===e.type){var t=e.senderId;this.core.V2NIMFriendService.handleDeleteFriend(t,2)}else if(5===e.type)try{var r=JSON.parse(e.content);if(1===(null==r?void 0:r.vt)){this.core.V2NIMFriendService.handleAddFriend(e.senderId,e.timestamp);var n={applicantAccountId:e.senderId,recipientAccountId:e.receiverId,operatorAccountId:e.senderId,postscript:e.postscript,timestamp:e.timestamp,status:4,read:!0};this.service.model.appendFriendAddApplication(n),this.service.model.updateFriendAddApplicationStatus(n.applicantAccountId,4,n.applicantAccountId)}else if(2===(null==r?void 0:r.vt)){var a={applicantAccountId:e.senderId,recipientAccountId:e.receiverId,operatorAccountId:e.senderId,postscript:e.postscript,timestamp:e.timestamp,status:0,read:!1};this.service.handleApplyFriend(a),this.service.model.appendFriendAddApplication(a)}else if(3===(null==r?void 0:r.vt)){this.core.V2NIMFriendService.handleAddFriend(e.senderId,e.timestamp);var i={applicantAccountId:e.receiverId,recipientAccountId:e.senderId,operatorAccountId:e.senderId,timestamp:e.timestamp,postscript:e.postscript,status:1,read:!0};this.service.model.appendFriendAddApplication(i)}else if(4===(null==r?void 0:r.vt)){var o={applicantAccountId:e.receiverId,recipientAccountId:e.senderId,operatorAccountId:e.senderId,timestamp:e.timestamp,postscript:e.postscript,status:2,read:!0};this.service.model.appendFriendAddApplication(o),this.service.emit("onFriendAddRejected",o)}}catch(e){this.core.logger.warn("V2NIMFriendNotificationImpl::processSysNotification, parse content error:",e)}},V2NIMFriendNotificationImpl}();function _createForOfIteratorHelperLoose$5(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$5(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$5(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$5(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$5(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var Iv=function(){function V2NIMFriendModelImpl(){this.validFriendIds=new iv,this.friendMap=new ic,this.applicationInfoList=[],this.friendTimetag=0}var e=V2NIMFriendModelImpl.prototype;return e.getAddApplicationList=function getAddApplicationList(e){var t,r,n=void 0===e.offset?0:e.offset,a=reverse$1(t=filter(r=this.applicationInfoList).call(r,(function(t){var r=e.status||[];return 0===r.length||!!includes(r).call(r,t.status)}))).call(t),i=e.limit||50,o=slice(a).call(a,n,n+i),s=n+i>=a.length;return{infos:o,finished:s,offset:s?0:n+i}},e.reset=function reset(){this.friendMap.clear(),this.validFriendIds.clear(),this.applicationInfoList=[]},e.setAddApplicationRead=function setAddApplicationRead(){for(var e,t=_createForOfIteratorHelperLoose$5(this.applicationInfoList);!(e=t()).done;){e.value.read=!0}},e.getAddApplicationUnreadCount=function getAddApplicationUnreadCount(){for(var e,t=new iv,r=_createForOfIteratorHelperLoose$5(this.applicationInfoList);!(e=r()).done;){var n=e.value;n.read||0!==n.status||t.add(n.applicantAccountId)}return t.size},e.appendFriendAddApplication=function appendFriendAddApplication(e){this.applicationInfoList.push(e)},e.clearApplicationList=function clearApplicationList(){this.applicationInfoList=[]},e.deleteApplication=function deleteApplication(e){var t,r;this.applicationInfoList=filter(t=map$6(r=this.applicationInfoList).call(r,(function(t){if(t.applicantAccountId!==e.applicantAccountId||t.recipientAccountId!==e.recipientAccountId||t.timestamp!==e.timestamp)return t}))).call(t,(function(e){return e}))},e.updateFriendAddApplicationStatus=function updateFriendAddApplicationStatus(e,t,r){if(0!==t)for(var n,a=_createForOfIteratorHelperLoose$5(this.applicationInfoList);!(n=a()).done;){var i=n.value;i.applicantAccountId===e&&0===i.status&&(i.status=t,i.operatorAccountId=r,i.read=!0)}},e.upsertFriend=function upsertFriend(e,t){var r=this.friendMap.get(e)||{},n=Et({accountId:e},r,t);return this.friendMap.set(e,n),this.validFriendIds.add(e),n},e.addFriend=function addFriend(e){this.validFriendIds.add(e)},e.deleteFriend=function deleteFriend(e){this.validFriendIds.delete(e)},e.getFriend=function getFriend(e){return this.validFriendIds.has(e)?this.friendMap.get(e):void 0},e.getFriendList=function getFriendList(){var e,t,r,n=this;return filter(e=map$6(t=xl(values(r=this.validFriendIds).call(r))).call(t,(function(e){return n.getFriend(e)}))).call(e,(function(e){return!!e}))},e.getFriendListBySearchOption=function getFriendListBySearchOption(e){var t,r,n,a=this;return filter(t=map$6(r=xl(values(n=this.validFriendIds).call(n))).call(r,(function(e){return a.getFriend(e)}))).call(t,(function(t){var r,n,a=void 0===e.searchAlias||e.searchAlias;return void 0!==t&&(!!(a&&t.alias&&includes(r=t.alias).call(r,e.keyword))||!(!e.searchAccountId||!includes(n=t.accountId).call(n,e.keyword)))}))},e.getFriendByIds=function getFriendByIds(e){var t,r=this;return filter(t=map$6(e).call(e,(function(e){return r.getFriend(e)}))).call(t,(function(e){return!!e}))},e.setFriendTimetag=function setFriendTimetag(e){this.friendTimetag=e},e.getFriendTimetag=function getFriendTimetag(){return this.friendTimetag},V2NIMFriendModelImpl}(),Sv=function(e){function V2NIMUFriendServiceImpl(t){var r;return(r=e.call(this,"V2NIMFriendService",t)||this).notification=new Mv(r.core,De(r)),r.model=new Iv,"v2"!==r.core.options.apiVersion?De(r):(registerParser({cmdMap:pv,cmdConfig:hv}),r.setListener(),r)}_t(V2NIMUFriendServiceImpl,e);var t=V2NIMUFriendServiceImpl.prototype;return t.reset=function reset(){this.model.reset()},t.setListener=function setListener(){var e,t,r,n,a,i;this.core.eventBus.on("V2NIMFriendService/sysNotification",bind$1(e=this.notification.processSysNotification).call(e,this.notification)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/addFriend",bind$1(t=this.handleAddFriend).call(t,this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/deleteFriend",bind$1(r=this.handleDeleteFriend).call(r,this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/setFriendInfo",bind$1(n=this.handleSetFriendInfo).call(n,this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/acceptAddApplication",bind$1(a=this.handlePassFriendApply).call(a,this)),this.core.eventBus.on("forwardReceive/V2NIMFriendService/rejectAddApplication",bind$1(i=this.handleRejectFriendApply).call(i,this))},t.emit=function emit(t){for(var r,n,a=this.name+"::emit "+t.toString(),i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if("onFriendAdded"===t||"onFriendInfoChanged"===t){var c=o[0];this.logger.log(""+a,c.accountId+";updateTime:"+c.updateTime)}else{var l,d;(l=this.logger).log.apply(l,concat(d=[""+a]).call(d,o))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,o))},t.addFriend=function addFriend(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:if(this.checkV2(),e!==this.core.account){r.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot add yourself"}});case 3:return validate(gv,{accountId:e,params:t},"",!0),r.next=6,this.core.sendCmd("v2AddFriend",{accountId:e,verifyType:t.addMode,postscript:t.postscript||""});case 6:if(1!==t.addMode){r.next=9;break}return r.next=9,this.handleAddFriend(e);case 9:case"end":return r.stop()}}),_callee,this)})))},t.deleteFriend=function deleteFriend(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:if(this.checkV2(),e!==this.core.account){r.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot delete yourself"}});case 3:return validate(vv,{accountId:e,params:t},"",!0),r.next=6,this.core.sendCmd("v2DeleteFriend",{accountId:e,params:t});case 6:t.deleteAlias&&this.model.upsertFriend(e,{alias:""}),this.handleDeleteFriend(e);case 8:case"end":return r.stop()}}),_callee2,this)})))},t.acceptAddApplication=function acceptAddApplication(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),validate(yv,e,"",!0),t.prev=2,t.next=5,this.core.sendCmd("v2AddFriend",{accountId:e.applicantAccountId,verifyType:3,postscript:""});case 5:this.handlePassFriendApply(e.applicantAccountId),t.next=12;break;case 8:throw t.prev=8,t.t0=t.catch(2),this.handlePassFriendApply(e.applicantAccountId,t.t0),t.t0;case 12:case"end":return t.stop()}}),_callee3,this,[[2,8]])})))},t.rejectAddApplication=function rejectAddApplication(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate(yv,e,"",!0),r.prev=2,r.next=5,this.core.sendCmd("v2AddFriend",{accountId:e.applicantAccountId,verifyType:4,postscript:t||""});case 5:this.handleRejectFriendApply({applicantAccountId:e.applicantAccountId,recipientAccountId:e.recipientAccountId,operatorAccountId:this.core.account,postscript:t||"",timestamp:this.core.timeOrigin.getNTPTime(),read:!0,status:2}),r.next=12;break;case 8:throw r.prev=8,r.t0=r.catch(2),this.handleRejectFriendApply({applicantAccountId:e.applicantAccountId,recipientAccountId:e.recipientAccountId,operatorAccountId:this.core.account,postscript:t||"",timestamp:this.core.timeOrigin.getNTPTime(),read:!0,status:3},r.t0),r.t0;case 12:case"end":return r.stop()}}),_callee4,this,[[2,8]])})))},t.setFriendInfo=function setFriendInfo(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:if(this.checkV2(),validate(fv,{accountId:e,params:t},"",!0),e!==this.core.account){r.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"Cannot set yourself"}});case 4:return r.next=6,this.core.sendCmd("v2SetFriendInfo",{tag:Et({accountId:e},t)});case 6:this.handleSetFriendInfo(e,t);case 7:case"end":return r.stop()}}),_callee5,this)})))},t.getFriendList=function getFriendList(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(e){for(;;)switch(e.prev=e.next){case 0:return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),e.abrupt("return",this.computedFields(this.model.getFriendList()));case 3:case"end":return e.stop()}}),_callee6,this)})))},t.getFriendByIds=function getFriendByIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({accountIds:{type:"array",itemType:"string",required:!0,min:1}},{accountIds:e},"",!0),t.abrupt("return",this.computedFields(this.model.getFriendByIds(e)));case 4:case"end":return t.stop()}}),_callee7,this)})))},t.checkFriend=function checkFriend(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t,r=this;return Dl.wrap((function _callee8$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({accountIds:{type:"array",itemType:"string",required:!0,min:1}},{accountIds:e},"",!0),t={},forEach$1(e).call(e,(function(e){t[e]=!!r.model.getFriend(e)})),n.abrupt("return",t);case 6:case"end":return n.stop()}}),_callee8,this)})))},t.getAddApplicationList=function getAddApplicationList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){return Dl.wrap((function _callee9$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate(_v,e,"",!0),t.abrupt("return",this.model.getAddApplicationList(e));case 4:case"end":return t.stop()}}),_callee9,this)})))},t.setAddApplicationRead=function setAddApplicationRead(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){return Dl.wrap((function _callee10$(e){for(;;)switch(e.prev=e.next){case 0:this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),this.model.setAddApplicationRead();case 3:case"end":return e.stop()}}),_callee10,this)})))},t.getAddApplicationUnreadCount=function getAddApplicationUnreadCount(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(e){for(;;)switch(e.prev=e.next){case 0:return this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),e.abrupt("return",this.model.getAddApplicationUnreadCount());case 3:case"end":return e.stop()}}),_callee11,this)})))},t.clearAllAddApplication=function clearAllAddApplication(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){return Dl.wrap((function _callee12$(e){for(;;)switch(e.prev=e.next){case 0:this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),this.model.clearApplicationList();case 3:case"end":return e.stop()}}),_callee12,this)})))},t.deleteAddApplication=function deleteAddApplication(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){return Dl.wrap((function _callee13$(t){for(;;)switch(t.prev=t.next){case 0:if(this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate(yv,e,"",!0),e.applicantAccountId===this.core.account||e.recipientAccountId===this.core.account){t.next=5;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"The applicant and recipient are not youself"}});case 5:this.model.deleteApplication(e);case 6:case"end":return t.stop()}}),_callee13,this)})))},t.searchFriendByOption=function searchFriendByOption(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){return Dl.wrap((function _callee14$(t){for(;;)switch(t.prev=t.next){case 0:if(this.checkV2(),this.core.V2NIMLoginService.checkIllegalState(),validate({keyword:{type:"string",allowEmpty:!1},searchAccountId:{type:"boolean",required:!1}},e,"",!0),void 0===e.searchAlias||e.searchAlias||e.searchAccountId){t.next=6;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"searchAlias and searchAccountId cannot be false at the same time"}});case 6:return t.abrupt("return",this.computedFields(this.model.getFriendListBySearchOption(e)));case 7:case"end":return t.stop()}}),_callee14,this)})))},t.v2OnAddFriendHandler=function v2OnAddFriendHandler(e){var t=e.content,r=t.accountId,n=t.verifyType,a=t.postscript;if(1===n)this.handleAddFriend(r);else if(2===n){var i={applicantAccountId:this.core.account,recipientAccountId:r,operatorAccountId:this.core.account,postscript:a,timestamp:this.core.timeOrigin.getNTPTime(),status:0,read:!1};this.handleApplyFriend(i)}else if(3===n)this.handlePassFriendApply(r);else if(4===n){var o={applicantAccountId:r,recipientAccountId:this.core.account,operatorAccountId:this.core.account,postscript:a,timestamp:this.core.timeOrigin.getNTPTime(),status:2,read:!0};this.handleRejectFriendApply(o)}},t.v2OnDeleteFriendHandler=function v2OnDeleteFriendHandler(e){var t=e.content.accountId;this.handleDeleteFriend(t)},t.v2OnUpdateFriendInfoHandler=function v2OnUpdateFriendInfoHandler(e){var t=e.content.data,r=this.model.upsertFriend(t.accountId,t);this.emit("onFriendInfoChanged",r)},t.v2SyncFriendListHandler=function v2SyncFriendListHandler(e){var t=this,r=e.content,n=r.friends,a=r.timetag;this.model.setFriendTimetag(a),forEach$1(n).call(n,(function(e){e.serverExtension||(e.serverExtension=""),e.customerExtension||(e.customerExtension=""),t.model.upsertFriend(e.accountId,e)}))},t.v2SyncFriendUserListHandler=function v2SyncFriendUserListHandler(e){var t=this,r=e.content.users;this.hasUserService&&forEach$1(r).call(r,(function(e){t.core.V2NIMUserService.model.setUser(e)}))},t.handleApplyFriend=function handleApplyFriend(e){this.emit("onFriendAddApplication",e)},t.handleAddFriend=function handleAddFriend(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){var t;return Dl.wrap((function _callee15$(r){for(;;)switch(r.prev=r.next){case 0:return this.model.addFriend(e),r.next=3,this.incrementSyncFriend();case 3:this.core.eventBus.emit("V2NIMUserService/refreshUserInfo",e),(t=this.model.getFriend(e))&&this.emit("onFriendAdded",this.computedField(t));case 6:case"end":return r.stop()}}),_callee15,this)})))},t.handleDeleteFriend=function handleDeleteFriend(e,t){t=void 0===t?1:t,this.emit("onFriendDeleted",e,t),this.model.deleteFriend(e)},t.handleSetFriendInfo=function handleSetFriendInfo(e,t){var r=this.model.upsertFriend(e,t);this.emit("onFriendInfoChanged",this.computedField(r))},t.handlePassFriendApply=function handlePassFriendApply(e,t){var r=t?null==t?void 0:t.code:200;if(!(r>=19e4||r===_l.V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT))if(200===r||r===_l.V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST)this.model.updateFriendAddApplicationStatus(e,1,this.core.account),this.handleAddFriend(e);else{if(r>=500&&r<=599&&509!==r)return;this.model.updateFriendAddApplicationStatus(e,3,this.core.account)}},t.handleRejectFriendApply=function handleRejectFriendApply(e,t){var r=t?null==t?void 0:t.code:200;if(!(r>=19e4||r===_l.V2NIM_ERROR_CODE_FRIEND_OPERATION_RATE_LIMIT))if(200===r)this.emit("onFriendAddRejected",e),this.model.updateFriendAddApplicationStatus(e.applicantAccountId,2,this.core.account);else if(r===_l.V2NIM_ERROR_CODE_FRIEND_ALREADY_EXIST)this.model.updateFriendAddApplicationStatus(e.applicantAccountId,1,this.core.account);else{if(r>=500&&r<=599&&509!==r)return;this.model.updateFriendAddApplicationStatus(e.applicantAccountId,3,this.core.account)}},t.incrementSyncFriend=function incrementSyncFriend(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var e,t,r,n,a=this;return Dl.wrap((function _callee16$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.core.sendCmd("v2IncFriendInfo",{timetag:this.model.getFriendTimetag()});case 2:e=i.sent,t=e.content,r=t.friends,n=t.timetag,this.model.setFriendTimetag(n),forEach$1(r).call(r,(function(e){a.model.upsertFriend(e.accountId,e)}));case 6:case"end":return i.stop()}}),_callee16,this)})))},t.computedFields=function computedFields(e){var t=this;return map$6(e).call(e,(function(e){return t.computedField(e)}))},t.computedField=function computedField(e){var t,r,n=null===(r=null===(t=this.core.V2NIMUserService)||void 0===t?void 0:t.model)||void 0===r?void 0:r.getUser(e.accountId);return n?Et({},e,{userProfile:n}):e},Ue(V2NIMUFriendServiceImpl,[{key:"hasUserService",get:function get(){var e;return!!(null===(e=this.core.V2NIMUserService)||void 0===e?void 0:e.name)}}]),V2NIMUFriendServiceImpl}(Ru),Tv={muteMode:{type:"enum",values:[2,0,1]}},Cv={accountId:{type:"string",required:!0,allowEmpty:!1},muteMode:{type:"enum",required:!0,values:[2,0,1]}},bv={type:"object",required:!1,rules:{certificateName:{type:"string",required:!0,allowEmpty:!1},appId:{type:"string",required:!1,allowEmpty:!1},appKey:{type:"string",required:!1,allowEmpty:!1},secret:{type:"string",required:!1,allowEmpty:!1}}},Ev={config:{type:"object",required:!0,rules:{apns:bv,hwPush:bv,miPush:bv,vivoPush:bv,oppoPush:bv,honorPush:bv,fcmPush:bv,mzPush:bv}}},Rv="V2NIMSettingService",kv={"34_1":"v2SetDeviceToken","34_2":"v2SetAppBackground","34_15":"v2SetPushMobileOnDesktopOnline"},wv={v2SetDeviceToken:{sid:34,cid:1,service:Rv,params:[{type:"String",name:"certificateName"},{type:"String",name:"pushDeviceToken"},{type:"Int",name:"pushkit"}]},v2SetAppBackground:{sid:34,cid:2,service:Rv,params:[{type:"Bool",name:"isBackground"},{type:"Int",name:"badge"}]},v2SetPushMobileOnDesktopOnline:{sid:34,cid:15,service:Rv,params:[{type:"Property",name:"tag",reflectMapper:{need:{id:1,converter:function converter(e){return e?2:1}}}}]}},Av=Av||function(e){var t;"undefined"!=typeof window&&window.crypto&&(t=window.crypto),"undefined"!=typeof self&&self.crypto&&(t=self.crypto),void 0!==ro&&ro.crypto&&(t=ro.crypto),!t&&"undefined"!=typeof window&&window.msCrypto&&(t=window.msCrypto),!t&&"undefined"!=typeof global&&global.crypto&&(t=global.crypto);var r=function cryptoSecureRandomInt(){if(t){if("function"==typeof t.getRandomValues)try{return t.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof t.randomBytes)try{return t.randomBytes(4).readInt32LE()}catch(e){}}throw new Error("Native crypto module could not be used to get secure random number.")},n=it||function(){function F(){}return function(e){var t;return F.prototype=e,t=new F,F.prototype=null,t}}(),a={},i=a.lib={},o=i.Base={extend:function extend(e){var t=n(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function create(){var e=this.extend();return e.init.apply(e,arguments),e},init:function init(){},mixIn:function mixIn(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function clone(){return this.init.prototype.extend(this)}},s=i.WordArray=o.extend({init:function init(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length},toString:function toString(e){return(e||l).stringify(this)},concat:function concat(e){var t=this.words,r=e.words,n=this.sigBytes,a=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<a;i++){var o=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=o<<24-(n+i)%4*8}else for(var s=0;s<a;s+=4)t[n+s>>>2]=r[s>>>2];return this.sigBytes+=a,this},clamp:function clamp(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function clone(){var e,clone=o.clone.call(this);return clone.words=slice(e=this.words).call(e,0),clone},random:function random(e){for(var t=[],n=0;n<e;n+=4)t.push(r());return new s.init(t,e)}}),c=a.enc={},l=c.Hex={stringify:function stringify(e){for(var t=e.words,r=e.sigBytes,n=[],a=0;a<r;a++){var i=t[a>>>2]>>>24-a%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function parse(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=bd(e.substr(n,2),16)<<24-n%8*4;return new s.init(r,t/2)}},d=c.Latin1={stringify:function stringify(e){for(var t=e.words,r=e.sigBytes,n=[],a=0;a<r;a++){var i=t[a>>>2]>>>24-a%4*8&255;n.push(String.fromCharCode(i))}return n.join("")},parse:function parse(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new s.init(r,t)}},u=c.Utf8={stringify:function stringify(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function parse(e){return d.parse(unescape(encodeURIComponent(e)))}},p=i.BufferedBlockAlgorithm=o.extend({reset:function reset(){this._data=new s.init,this._nDataBytes=0},_append:function _append(e){var t;"string"==typeof e&&(e=u.parse(e)),concat(t=this._data).call(t,e),this._nDataBytes+=e.sigBytes},_process:function _process(t){var r,n=this._data,a=n.words,i=n.sigBytes,o=this.blockSize,c=i/(4*o),l=(c=t?e.ceil(c):e.max((0|c)-this._minBufferSize,0))*o,d=e.min(4*l,i);if(l){for(var u=0;u<l;u+=o)this._doProcessBlock(a,u);r=splice(a).call(a,0,l),n.sigBytes-=d}return new s.init(r,d)},clone:function clone(){var clone=o.clone.call(this);return clone._data=this._data.clone(),clone},_minBufferSize:0});i.Hasher=p.extend({cfg:o.extend(),init:function init(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function reset(){p.reset.call(this),this._doReset()},update:function update(e){return this._append(e),this._process(),this},finalize:function finalize(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function _createHelper(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function _createHmacHelper(e){return function(t,r){return new m.HMAC.init(e,r).finalize(t)}}});var m=a.algo={};return a}(Math),Nv=Av.enc.Utf8,xv=Av,Ov=xv.lib,Pv=Ov.Base,Lv=Ov.WordArray,Vv=xv.algo,Uv=Vv.MD5,Dv=Vv.EvpKDF=Pv.extend({cfg:Pv.extend({keySize:4,hasher:Uv,iterations:1}),init:function init(e){this.cfg=this.cfg.extend(e)},compute:function compute(e,t){for(var r,n=this.cfg,a=n.hasher.create(),i=Lv.create(),o=i.words,s=n.keySize,c=n.iterations;o.length<s;){r&&a.update(r),r=a.update(e).finalize(t),a.reset();for(var l=1;l<c;l++)r=a.finalize(r),a.reset();concat(i).call(i,r)}return i.sigBytes=4*s,i}});xv.EvpKDF=function(e,t,r){return Dv.create(r).compute(e,t)},Av.EvpKDF;var qv=Av,Bv=qv.lib.WordArray;qv.enc.Base64={stringify:function stringify(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var a=[],i=0;i<r;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,s=0;s<4&&i+.75*s<r;s++)a.push(n.charAt(o>>>6*(3-s)&63));var c=n.charAt(64);if(c)for(;a.length%4;)a.push(c);return a.join("")},parse:function parse(e){var t=e.length,r=this._map,n=this._reverseMap;if(!n){n=this._reverseMap=[];for(var a=0;a<r.length;a++)n[r.charCodeAt(a)]=a}var i=r.charAt(64);if(i){var o=indexOf(e).call(e,i);-1!==o&&(t=o)}return function parseLoop(e,t,r){for(var n=[],a=0,i=0;i<t;i++)if(i%4){var o=r[e.charCodeAt(i-1)]<<i%4*2|r[e.charCodeAt(i)]>>>6-i%4*2;n[a>>>2]|=o<<24-a%4*8,a++}return Bv.create(n,a)}(e,t,n)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},Av.enc.Base64,function(e){e.lib.Cipher||function(){var t=e,r=t.lib,n=r.Base,a=r.WordArray,i=r.BufferedBlockAlgorithm,o=t.enc;o.Utf8;var s=o.Base64,c=t.algo.EvpKDF,l=r.Cipher=i.extend({cfg:n.extend(),createEncryptor:function createEncryptor(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function createDecryptor(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function init(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset()},reset:function reset(){i.reset.call(this),this._doReset()},process:function process(e){return this._append(e),this._process()},finalize:function finalize(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function selectCipherStrategy(e){return"string"==typeof e?y:v}return function(e){return{encrypt:function encrypt(t,r,n){return selectCipherStrategy(r).encrypt(e,t,r,n)},decrypt:function decrypt(t,r,n){return selectCipherStrategy(r).decrypt(e,t,r,n)}}}}()});r.StreamCipher=l.extend({_doFinalize:function _doFinalize(){return this._process(!0)},blockSize:1});var d=t.mode={},u=r.BlockCipherMode=n.extend({createEncryptor:function createEncryptor(e,t){return this.Encryptor.create(e,t)},createDecryptor:function createDecryptor(e,t){return this.Decryptor.create(e,t)},init:function init(e,t){this._cipher=e,this._iv=t}}),p=d.CBC=function(){var e=u.extend();function xorBlock(e,t,r){var n,a=this._iv;a?(n=a,this._iv=void 0):n=this._prevBlock;for(var i=0;i<r;i++)e[t+i]^=n[i]}return e.Encryptor=e.extend({processBlock:function processBlock(e,t){var r=this._cipher,n=r.blockSize;xorBlock.call(this,e,t,n),r.encryptBlock(e,t),this._prevBlock=slice(e).call(e,t,t+n)}}),e.Decryptor=e.extend({processBlock:function processBlock(e,t){var r=this._cipher,n=r.blockSize,a=slice(e).call(e,t,t+n);r.decryptBlock(e,t),xorBlock.call(this,e,t,n),this._prevBlock=a}}),e}(),m=(t.pad={}).Pkcs7={pad:function pad(e,t){for(var r=4*t,n=r-e.sigBytes%r,i=n<<24|n<<16|n<<8|n,o=[],s=0;s<n;s+=4)o.push(i);var c=a.create(o,n);concat(e).call(e,c)},unpad:function unpad(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t}};r.BlockCipher=l.extend({cfg:l.cfg.extend({mode:p,padding:m}),reset:function reset(){var e;l.reset.call(this);var t=this.cfg,r=t.iv,n=t.mode;this._xformMode==this._ENC_XFORM_MODE?e=n.createEncryptor:(e=n.createDecryptor,this._minBufferSize=1),this._mode&&this._mode.__creator==e?this._mode.init(this,r&&r.words):(this._mode=e.call(n,this,r&&r.words),this._mode.__creator=e)},_doProcessBlock:function _doProcessBlock(e,t){this._mode.processBlock(e,t)},_doFinalize:function _doFinalize(){var e,t=this.cfg.padding;return this._xformMode==this._ENC_XFORM_MODE?(t.pad(this._data,this.blockSize),e=this._process(!0)):(e=this._process(!0),t.unpad(e)),e},blockSize:4});var h=r.CipherParams=n.extend({init:function init(e){this.mixIn(e)},toString:function toString(e){return(e||this.formatter).stringify(this)}}),g=(t.format={}).OpenSSL={stringify:function stringify(e){var t,r,n,i=e.ciphertext,o=e.salt;o?t=concat(r=concat(n=a.create([1398893684,1701076831])).call(n,o)).call(r,i):t=i;return t.toString(s)},parse:function parse(e){var t,r=s.parse(e),n=r.words;return 1398893684==n[0]&&1701076831==n[1]&&(t=a.create(slice(n).call(n,2,4)),splice(n).call(n,0,4),r.sigBytes-=16),h.create({ciphertext:r,salt:t})}},v=r.SerializableCipher=n.extend({cfg:n.extend({format:g}),encrypt:function encrypt(e,t,r,n){n=this.cfg.extend(n);var a=e.createEncryptor(r,n),i=a.finalize(t),o=a.cfg;return h.create({ciphertext:i,key:r,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function decrypt(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function _parse(e,t){return"string"==typeof e?t.parse(e,this):e}}),f=(t.kdf={}).OpenSSL={execute:function execute(e,t,r,n){var i;n||(n=a.random(8));var o=c.create({keySize:t+r}).compute(e,n),s=a.create(slice(i=o.words).call(i,t),4*r);return o.sigBytes=4*t,h.create({key:o,iv:s,salt:n})}},y=r.PasswordBasedCipher=v.extend({cfg:v.cfg.extend({kdf:f}),encrypt:function encrypt(e,t,r,n){var a=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize);n.iv=a.iv;var i=v.encrypt.call(this,e,t,a.key,n);return i.mixIn(a),i},decrypt:function decrypt(e,t,r,n){n=this.cfg.extend(n),t=this._parse(t,n.format);var a=n.kdf.execute(r,e.keySize,e.ivSize,t.salt);return n.iv=a.iv,v.decrypt.call(this,e,t,a.key,n)}})}()}(Av);var Fv=Av,Gv=Fv.lib.StreamCipher,Hv=Fv.algo,jv=Hv.RC4=Gv.extend({_doReset:function _doReset(){for(var e=this._key,t=e.words,r=e.sigBytes,n=this._S=[],a=0;a<256;a++)n[a]=a;a=0;for(var i=0;a<256;a++){var o=a%r,s=t[o>>>2]>>>24-o%4*8&255;i=(i+n[a]+s)%256;var c=n[a];n[a]=n[i],n[i]=c}this._i=this._j=0},_doProcessBlock:function _doProcessBlock(e,t){e[t]^=generateKeystreamWord.call(this)},keySize:8,ivSize:0});function generateKeystreamWord(){for(var e=this._S,t=this._i,r=this._j,n=0,a=0;a<4;a++){r=(r+e[t=(t+1)%256])%256;var i=e[t];e[t]=e[r],e[r]=i,n|=e[(e[t]+e[r])%256]<<24-8*a}return this._i=t,this._j=r,n}Fv.RC4=Gv._createHelper(jv);var $v=Hv.RC4Drop=jv.extend({cfg:jv.cfg.extend({drop:192}),_doReset:function _doReset(){jv._doReset.call(this);for(var e=this.cfg.drop;e>0;e--)generateKeystreamWord.call(this)}});Fv.RC4Drop=Gv._createHelper($v);var zv=Av.RC4,Wv=function(e){function V2NIMSettingServiceImpl(t){var r;return(r=e.call(this,"V2NIMSettingService",t)||this).offlinePushPlugin=void 0,r.offlinePushConfig=void 0,r.authConfig=void 0,r.aosPushInfo=void 0,r.appBackgroundOptions={badge:0,isBackground:!1},r.p2pMessageMuteModeChangeHandler=function(e,t){r.emit("onP2PMessageMuteModeChanged",e,t),r.hasUserService&&r.core.V2NIMUserService.model.setAccountMuteMode(e,t);var n=r.core.V2NIMConversationIdUtil.p2pConversationId(e),a=1===t;r.core.eventBus.emit("V2NIMConversationService/setMute",n,a)},r.setTokenAndBackgroundStateAfterLogin=function(e){r.aosPushInfo=e,r.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin"),r.offlinePushPlugin&&(r.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin plugin is provided"),r.logger.log("OfflinePushService: setTokenAndBackgroundStateAfterLogin pushType is: ",e&&e.pushType),r.regToken(),r.core.sendCmd("v2SetAppBackground",{isBackground:r.appBackgroundOptions.isBackground,badge:r.appBackgroundOptions.badge||0}))},r.core._registerDep(jp,"V2NIMConversationIdUtil"),"v2"!==r.core.options.apiVersion?De(r):(r.setListener(),registerParser({cmdMap:kv,cmdConfig:wv}),r)}_t(V2NIMSettingServiceImpl,e);var t=V2NIMSettingServiceImpl.prototype;return t.setListener=function setListener(){var e=this;this.core.eventBus.on("V2NIMSettingService/updateBits",(function(t,r,n){e.emit("onTeamMessageMuteModeChanged",t,r,n)})),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",this.setTokenAndBackgroundStateAfterLogin),this.core.eventBus.on("v2NIMUserService/updateMuteList",this.p2pMessageMuteModeChangeHandler),this.core.eventBus.on("forwardReceive/v2NIMSettingService/setP2PMessageMuteMode",this.p2pMessageMuteModeChangeHandler)},t.emit=function emit(t){for(var r,n,a,i,o=this.name+"::emit "+t.toString(),s=arguments.length,c=new Array(s>1?s-1:0),l=1;l<s;l++)c[l-1]=arguments[l];return(r=this.logger).log.apply(r,concat(n=[""+o]).call(n,c)),(a=e.prototype.emit).call.apply(a,concat(i=[this,t]).call(i,c))},t.getConversationMuteStatus=function getConversationMuteStatus(e){if("string"!=typeof e)return!1;var t=this.core.V2NIMConversationIdUtil.parseConversationType(e),r=this.core.V2NIMConversationIdUtil.parseConversationTargetId(e);return 3===t?0!==this.getTeamMessageMuteMode(r,2):2===t?0!==this.getTeamMessageMuteMode(r,1):!(1!==t||!this.hasUserService)&&!!this.core.V2NIMUserService.model.muteList.has(r)},t.setTeamMessageMuteMode=function setTeamMessageMuteMode(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var n,a,i,o;return Dl.wrap((function _callee$(s){for(;;)switch(s.prev=s.next){case 0:if(this.hasTeamService){s.next=2;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_MISUSE,detail:{reason:"setTeamMessageMuteMode: no team service"}});case 2:return this.checkV2(),validate(Ag,{teamId:e},"",!0),validate(xg,{teamType:t},"",!0),validate(Tv,{muteMode:r},"",!0),n=2===t?"v2SuperTeamUpdateSelfMemberInfo":"v2TeamUpdateSelfMemberInfo",a={teamId:e,teamType:t,accountId:this.core.account,bits:r},s.next=10,this.core.sendCmd(n,{teamMember:a});case 10:this.core.V2NIMTeamService.memberModel.upsert(a),this.emit("onTeamMessageMuteModeChanged",e,t,r),i=1===t?this.core.V2NIMConversationIdUtil.teamConversationId(e):this.core.V2NIMConversationIdUtil.superTeamConversationId(e),o=this.getConversationMuteStatus(i),this.core.eventBus.emit("V2NIMConversationService/setMute",i,o);case 15:case"end":return s.stop()}}),_callee,this)})))},t.getTeamMessageMuteMode=function getTeamMessageMuteMode(e,t){var r;return"string"!=typeof e||"number"!=typeof t?0:this.hasTeamService?3&((null===(r=this.core.V2NIMTeamService.memberModel.getById(e,t,this.core.account))||void 0===r?void 0:r.bits)||0):0},t.setP2PMessageMuteMode=function setP2PMessageMuteMode(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:if(this.checkV2(),validate(Cv,{accountId:e,muteMode:t},"",!0),e!==this.core.account){r.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"can not set mute mode for self"}});case 4:return r.next=6,this.core.sendCmd("v2SetP2PMessageMuteMode",{accountId:e,muteMode:1===t});case 6:this.p2pMessageMuteModeChangeHandler(e,t);case 7:case"end":return r.stop()}}),_callee2,this)})))},t.getP2PMessageMuteMode=function getP2PMessageMuteMode(e){return validate({accountId:{type:"string",required:!0,allowEmpty:!1}},{accountId:e},"",!0),this.hasUserService&&this.core.V2NIMUserService.model.muteList.has(e)?1:0},t.getRNDeviceInfo=function getRNDeviceInfo(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t=this;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return this.logger.log("OfflinePushService:getDeviceInfo start"),null===(e=this.offlinePushPlugin)||void 0===e||e.init(bn(this.authConfig),(function(e,r,n){if(t.logger.log("OfflinePushService:: type: "+e+", tokenName: "+r+", token: "+n),n){var a="",i=ql.getSystemInfo()||{},o=i.os?i.os.toLowerCase():"";t.aosPushInfo&&t.aosPushInfo.pushType?a=t.aosPushInfo.pushType:"ios"===o?a="":"android"===o&&(a="8"),t.pushTokenToServer(a,n)}else t.logger.warn("OfflinePushService:: token is empty. Please check your parameters")})),r.abrupt("return",new Pi((function(e,r){var n;null===(n=t.offlinePushPlugin)||void 0===n||n.getDeviceInfo((function(n){try{t.logger.log("OfflinePushService:getDeviceInfo result "+(n?bn(n):"")),e(JSON.parse(n))}catch(e){r(new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"OfflinePushService:getDeviceInfo error"}}))}})),eo((function(){r(new Sl({code:_l.V2NIM_ERROR_CODE_INTERNAL,detail:{reason:"OfflinePushService:getDeviceInfo timeout"}}))}),2e3)})));case 3:case"end":return r.stop()}}),_callee3,this)})))},t.getP2PMessageMuteList=function getP2PMessageMuteList(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(e){for(;;)switch(e.prev=e.next){case 0:if(!this.hasUserService){e.next=4;break}return e.abrupt("return",Pi.resolve(xl(this.core.V2NIMUserService.model.muteList)));case 4:return e.abrupt("return",Pi.resolve([]));case 5:case"end":return e.stop()}}),_callee4,this)})))},t.setAppBackground=function setAppBackground(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate({isBackground:{type:"boolean"},badge:{type:"number",required:!1}},{isBackground:e,badge:t},"",!0),this.appBackgroundOptions={isBackground:e,badge:t||0},r.next=5,this.core.sendCmd("v2SetAppBackground",{isBackground:e,badge:t||0});case 5:case"end":return r.stop()}}),_callee5,this)})))},t.setPushMobileOnDesktopOnline=function setPushMobileOnDesktopOnline(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),validate({need:{type:"boolean",required:!1}},{need:e},"",!0),e=void 0===e||e,t.next=5,this.core.sendCmd("v2SetPushMobileOnDesktopOnline",{tag:{need:e}});case 5:case"end":return t.stop()}}),_callee6,this)})))},t.setOfflinePushConfig=function setOfflinePushConfig(e,t){var r,n,a,i,o,s,c,l,d,u,p,m,h,g,v,f,y,M,I,S,T,C,b,E,R,k,w,A,N,x,O,P,L,V,U,D;validate(Ev,{config:t},"",!0),this.logger.log("setOfflinePushConfig","plugin",e,"config",t),this.offlinePushPlugin=e,this.offlinePushConfig=t,this.authConfig={xmAppId:null===(n=null===(r=this.offlinePushConfig)||void 0===r?void 0:r.miPush)||void 0===n?void 0:n.appId,xmAppKey:null===(i=null===(a=this.offlinePushConfig)||void 0===a?void 0:a.miPush)||void 0===i?void 0:i.appKey,xmCertificateName:null===(s=null===(o=this.offlinePushConfig)||void 0===o?void 0:o.miPush)||void 0===s?void 0:s.certificateName,hwAppId:null===(l=null===(c=this.offlinePushConfig)||void 0===c?void 0:c.hwPush)||void 0===l?void 0:l.appId,hwCertificateName:null===(u=null===(d=this.offlinePushConfig)||void 0===d?void 0:d.hwPush)||void 0===u?void 0:u.certificateName,oppoAppId:null===(m=null===(p=this.offlinePushConfig)||void 0===p?void 0:p.oppoPush)||void 0===m?void 0:m.appId,oppoAppKey:null===(g=null===(h=this.offlinePushConfig)||void 0===h?void 0:h.oppoPush)||void 0===g?void 0:g.appKey,oppoAppSecret:null===(f=null===(v=this.offlinePushConfig)||void 0===v?void 0:v.oppoPush)||void 0===f?void 0:f.secret,oppoCertificateName:null===(M=null===(y=this.offlinePushConfig)||void 0===y?void 0:y.oppoPush)||void 0===M?void 0:M.certificateName,vivoAppId:null===(S=null===(I=this.offlinePushConfig)||void 0===I?void 0:I.vivoPush)||void 0===S?void 0:S.appId,vivoAppKey:null===(C=null===(T=this.offlinePushConfig)||void 0===T?void 0:T.vivoPush)||void 0===C?void 0:C.appKey,vivoCertificateName:null===(E=null===(b=this.offlinePushConfig)||void 0===b?void 0:b.vivoPush)||void 0===E?void 0:E.certificateName,fcmCertificateName:null===(k=null===(R=this.offlinePushConfig)||void 0===R?void 0:R.fcmPush)||void 0===k?void 0:k.certificateName,mzAppId:null===(A=null===(w=this.offlinePushConfig)||void 0===w?void 0:w.mzPush)||void 0===A?void 0:A.appId,mzAppKey:null===(x=null===(N=this.offlinePushConfig)||void 0===N?void 0:N.mzPush)||void 0===x?void 0:x.appKey,mzCertificateName:null===(P=null===(O=this.offlinePushConfig)||void 0===O?void 0:O.mzPush)||void 0===P?void 0:P.certificateName,apnsCertificateName:null===(V=null===(L=this.offlinePushConfig)||void 0===L?void 0:L.apns)||void 0===V?void 0:V.certificateName,honorCertificateName:null===(D=null===(U=this.offlinePushConfig)||void 0===U?void 0:U.honorPush)||void 0===D?void 0:D.certificateName}},t.regToken=function regToken(){var e=this,t=ql.getSystemInfo()||{},r=t.os?t.os.toLowerCase():"";if(this.logger.log("OfflinePushService: os",r),"ios"===r||"android"===r)if(!this.offlinePushPlugin||"UNIAPP"===ql.platform&&"function"!=typeof this.offlinePushPlugin.getDeviceToken||"React Native"===ql.platform&&"android"===r&&"function"!=typeof this.offlinePushPlugin.init||"React Native"===ql.platform&&"ios"===r&&"function"!=typeof this.offlinePushPlugin.checkPermissions)this.logger.warn("OfflinePushService: plugin is not correct, please check your plugin according to Yunxin Official Documentation");else{var n;if("React Native"===ql.platform&&ql.envPayload.AppState)ql.envPayload.AppState.addEventListener("change",bind$1(n=this.handleRNAppStateChange).call(n,this));var a="";this.aosPushInfo&&this.aosPushInfo.pushType?a=this.aosPushInfo.pushType:"ios"===r?a="":"android"===r&&(a="8"),this.logger.log("OfflinePushService:: prepare to get device token. suggestPushType: "+a),this.logger.log("OfflinePushService push config",bn(this.authConfig,null,2),"platform",ql.platform),"UNIAPP"===ql.platform?this.offlinePushPlugin.getDeviceToken({suggestPushType:a,config:this.authConfig},(function(t){t?(e.logger.log("OfflinePushService:: token is :"+t),e.pushTokenToServer(a,t)):e.logger.warn("OfflinePushService:: token is empty. Please check your parameters")})):"React Native"===ql.platform&&"android"===r?(this.logger.log("OfflinePushService:: onLogin",this.core.account,typeof a,a),this.offlinePushPlugin.onLogin(this.core.account,bd(a),!1,"")):"React Native"===ql.platform&&"ios"===r?this.offlinePushPlugin.checkPermissions((function(){e.logger.log("OfflinePushService addEventListener requestPermissions");try{e.offlinePushPlugin.requestPermissions()}catch(t){e.logger.log("OfflinePushService:: requestPermissions error",t)}e.offlinePushPlugin.addEventListener("register",(function(t){e.logger.log("OfflinePushService:: ios token: "+t),e.pushTokenToServer(a,t)})),e.offlinePushPlugin.addEventListener("registrationError",(function(t){e.logger.log("OfflinePushService:: ios registerError",t)}))})):this.logger.error("OfflinePushService:: platform is not supported. Please check your parameters. Platform: "+ql.platform+". os: "+r)}else this.logger.warn("OfflinePushService: only Android or IOS support offline push")},t.pushTokenToServer=function pushTokenToServer(e,t){var r,n,a,i,o,s,c,l,d="",u=this.offlinePushConfig;switch(e){case"5":d=null===(r=null==u?void 0:u.miPush)||void 0===r?void 0:r.certificateName;break;case"6":d=null===(n=null==u?void 0:u.hwPush)||void 0===n?void 0:n.certificateName;break;case"7":d=null===(a=null==u?void 0:u.mzPush)||void 0===a?void 0:a.certificateName;break;case"8":d=null===(i=null==u?void 0:u.fcmPush)||void 0===i?void 0:i.certificateName;break;case"9":d=null===(o=null==u?void 0:u.vivoPush)||void 0===o?void 0:o.certificateName;break;case"10":d=null===(s=null==u?void 0:u.oppoPush)||void 0===s?void 0:s.certificateName;break;case"11":d=null===(c=null==u?void 0:u.honorPush)||void 0===c?void 0:c.certificateName;break;default:d=null===(l=null==u?void 0:u.apns)||void 0===l?void 0:l.certificateName}if(""===d||void 0===d)this.logger.warn("OfflinePushService:: certificate name is empty for push type: ",e);else try{if("UNIAPP"===ql.platform){var p=Nv.parse("557d1e3cafa43e2589a588270c53d56f"),m=Nv.stringify(zv.decrypt(t,p));this.logger.log("OfflinePushService:: token",m),this.core.sendCmd("v2SetDeviceToken",{certificateName:d,pushDeviceToken:m,pushkit:0})}else this.core.sendCmd("v2SetDeviceToken",{certificateName:d,pushDeviceToken:t,pushkit:0})}catch(e){return this.logger.log("OfflinePushService:: decrypt error",e),void this.logger.warn("OfflinePushService:: token before decrypt",t)}},t.handleRNAppStateChange=function handleRNAppStateChange(e){this.logger.log("push::handleAppStateChange: pushConfig ios/aos; state: "+e),this.appBackgroundOptions={badge:this.core.V2NIMConversationService.getTotalUnreadCount(),isBackground:"background"===e||"inactive"===e},this.setAppBackground(this.appBackgroundOptions.isBackground,this.appBackgroundOptions.badge)},Ue(V2NIMSettingServiceImpl,[{key:"hasUserService",get:function get(){var e;return!!(null===(e=this.core.V2NIMUserService)||void 0===e?void 0:e.name)}},{key:"hasTeamService",get:function get(){var e;return!!(null===(e=this.core.V2NIMTeamService)||void 0===e?void 0:e.name)}}]),V2NIMSettingServiceImpl}(Ru);_export({target:"Number",stat:!0},{isNaN:function isNaN(e){return e!=e}});var Kv,Yv=N.Number.isNaN,Qv=invert({none:0,normal:1,all:3}),Jv={normal:0,advanced:1},Xv=invert(Jv),Zv=invert({normal:0,owner:1,manager:2}),ef={noVerify:0,needVerify:1,rejectAll:2},tf=invert(ef),rf={needVerify:0,noVerify:1},nf=invert(rf),af={manager:0,all:1},sf=invert(af),cf={manager:0,all:1},lf=invert(cf),df={manager:0,all:1},uf=invert(df);function formatTeam(e){var t,r=["teamId"],n=["level","memberNum","memberUpdateTime","createTime","updateTime"],a=["valid","validToCurrentUser","mute"],i={type:Xv,muteType:Qv,joinMode:tf,beInviteMode:nf,inviteMode:sf,updateTeamMode:lf,updateExtMode:uf};e.bits;var o=__rest(e,["bits"]);return forEach$1(r).call(r,(function(e){o[e]&&(o[e]=o[e].toString())})),forEach$1(n).call(n,(function(e){void 0!==o[e]&&(o[e]=bd(o[e]))})),forEach$1(a).call(a,(function(e){void 0!==o[e]&&(o[e]=1===bd(o[e]))})),forEach$1(t=Nt(i)).call(t,(function(e){void 0!==o[e]&&(o[e]=i[e][o[e]]||o[e])})),o}function formatTeams(e){return e&&e.length>0?map$6(e).call(e,(function(e){return formatTeam(e)})):[]}function generateTeam(e){var t,r=Et({},e),n=["avatar","name","intro","announcement","ext"],a={type:Jv,joinMode:ef,beInviteMode:rf,inviteMode:af,updateTeamMode:cf,updateExtMode:df};return forEach$1(n).call(n,(function(e){void 0!==r[e]&&(r[e]=r[e].toString())})),forEach$1(t=Nt(a)).call(t,(function(e){void 0!==r[e]&&(r[e]=a[e][r[e]])})),r}function generatorTeamMemberForCmd(e){var t=["teamId","ext","account","nickInTeam"],r={};return void 0!==e.bitConfigMask&&(r.bits=bd(e.bitConfigMask)),forEach$1(t).call(t,(function(t){e[t]&&(r[t]=e[t].toString())})),Object.prototype.hasOwnProperty.call(e,"nickInTeam")&&(r.nickInTeam=e.nickInTeam),r}function formatTeamMember(e){var t,r=["teamId"],n=["joinTime","updateTime","bitConfigMask"],a=["active","valid","mute"],i={type:Zv},o=e.bits,s=__rest(e,["bits"]);return void 0!==o&&(s.muteTeam=1===bd(o),s.bitConfigMask=o),s.id=s.teamId+"-"+s.account,forEach$1(r).call(r,(function(e){s[e]&&(s[e]=s[e].toString())})),forEach$1(n).call(n,(function(e){void 0!==s[e]&&(s[e]=bd(s[e]))})),forEach$1(a).call(a,(function(e){void 0!==s[e]&&(s[e]=1===bd(s[e]))})),forEach$1(t=Nt(i)).call(t,(function(e){void 0!==s[e]&&(s[e]=i[e][s[e]]||s[e])})),s}function formatTeamMembers(e){return e&&e.length>0?map$6(e).call(e,(function(e){return formatTeamMember(e)})):[]}function generatorMemberByTeam(e,t,r){return void 0===r&&(r="normal"),{id:e.teamId+"-"+t,teamId:e.teamId,account:t,type:r,nickInTeam:"",muteTeam:!1,mute:!1,joinTime:e.memberUpdateTime,updateTime:e.memberUpdateTime,active:!0,valid:!0}}function generatorMembersByTeam(e,t,r){return void 0===r&&(r="normal"),t&&t.length>0?map$6(t).call(t,(function(t){return generatorMemberByTeam(e,t,r)})):[]}function formatUser(e){var t=Et({},e);return t.createTime&&(t.createTime=+t.createTime),t.updateTime&&(t.updateTime=+t.updateTime),t.gender&&(t.gender=Kv[+t.gender]),t}!function(e){e[e.unknown=0]="unknown",e[e.male=1]="male",e[e.female=2]="female"}(Kv||(Kv={}));var pf={"8_1":"createTeam","8_5":"addTeamMembers","8_6":"removeTeamMembers","8_7":"updateTeamInfo","8_8":"leaveTeam","8_9":"getTeamInfo","8_10":"getTeams","8_11":"getTeamMembers","8_12":"dismissTeam","8_13":"applyTeam","8_14":"passTeamApply","8_15":"rejectTeamApply","8_16":"addTeamManagers","8_17":"removeTeamManagers","8_18":"transferTeam","8_19":"updateMyMemberInfo","8_20":"updateNickInTeam","8_21":"acceptTeamInvite","8_22":"rejectTeamInvite","8_25":"muteTeamMember","8_27":"getMutedTeamMembers","8_28":"sendTeamMsgReceipt","8_29":"getTeamMsgReads","8_30":"getTeamMsgReadAccounts","8_31":"notifyTeamMsgReceipts","8_32":"muteTeam","8_33":"getTeamMemberInvitorAccid","8_34":"getTeamsById","8_101":"syncCreateTeam","8_109":"syncTeams","8_119":"syncUpdateTeamMember","8_126":"syncMyTeamMembers"},mf={team:{teamId:1,name:3,type:4,owner:5,level:6,selfCustom:7,valid:8,memberNum:9,memberUpdateTime:10,createTime:11,updateTime:12,validToCurrentUser:13,intro:14,announcement:15,joinMode:16,bits:17,ext:18,serverExt:19,avatar:20,beInviteMode:21,inviteMode:22,updateTeamMode:23,updateExtMode:24,mute:100,muteType:101},teamMsgReceiptTag:{teamId:0,idServer:1,read:100,unread:101,idClient:102,account:103},teamMember:{teamId:1,account:3,type:4,nickInTeam:5,bits:7,active:8,valid:9,joinTime:10,updateTime:11,ext:12,mute:13,invitorAccid:14}},hf=invertSerializeMap(mf),gf={getTeamInfo:{sid:8,cid:9,service:"team",params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"team",reflectMapper:hf.team}]},getTeams:{sid:8,cid:10,service:"team",params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:hf.team},{type:"Long",name:"timetag"}],ignoreErrCodes:[803]},createTeam:{sid:8,cid:1,service:"team",params:[{type:"Property",name:"team",reflectMapper:mf.team},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:hf.team},{type:"StrArray",name:"abortedAccidList"}]},sendTeamMsgReceipt:{sid:8,cid:28,service:"team",params:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:mf.teamMsgReceiptTag}],response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:hf.teamMsgReceiptTag}]},getTeamMsgReads:{sid:8,cid:29,service:"team",params:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:mf.teamMsgReceiptTag}],response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:hf.teamMsgReceiptTag}]},getTeamMsgReadAccounts:{sid:8,cid:30,service:"team",params:[{type:"Property",name:"teamMsgReceiptTag",reflectMapper:mf.teamMsgReceiptTag}],response:[{type:"Property",name:"teamMsgReceipt",reflectMapper:hf.teamMsgReceiptTag},{type:"StrArray",name:"readAccounts"},{type:"StrArray",name:"unreadAccounts"}]},notifyTeamMsgReceipts:{sid:8,cid:31,service:"team",response:[{type:"PropertyArray",name:"teamMsgReceipts",reflectMapper:hf.teamMsgReceiptTag}]},dismissTeam:{sid:8,cid:12,service:"team",params:[{type:"Long",name:"teamId"}]},leaveTeam:{sid:8,cid:8,service:"team",params:[{type:"Long",name:"teamId"}]},transferTeam:{sid:8,cid:18,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},updateTeamInfo:{sid:8,cid:7,service:"team",params:[{type:"Property",name:"team",reflectMapper:mf.team}],response:[{type:"Long",name:"id"},{type:"Long",name:"time"}]},getTeamsById:{sid:8,cid:34,service:"team",params:[{type:"LongArray",name:"teamIds"}],response:[{type:"PropertyArray",name:"teams",reflectMapper:hf.team},{type:"LongArray",name:"tids"}],ignoreErrCodes:[816]},getTeamMembers:{sid:8,cid:11,service:"team",params:[{type:"Long",name:"teamId"},{type:"Long",name:"timetag"}],response:[{type:"Long",name:"teamId"},{type:"PropertyArray",name:"teamMembers",reflectMapper:hf.teamMember},{type:"Long",name:"timetag"}]},getMutedTeamMembers:{sid:8,cid:27,service:"team",params:[{type:"Long",name:"teamId"}],response:[{type:"Long",name:"teamId"},{type:"PropertyArray",name:"teamMembers",reflectMapper:hf.teamMember}]},addTeamMembers:{sid:8,cid:5,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"},{type:"String",name:"attach"}],response:[{type:"Long",name:"time"},{type:"StrArray",name:"abortedAccidList"}]},removeTeamMembers:{sid:8,cid:6,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},applyTeam:{sid:8,cid:13,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"team",reflectMapper:hf.team}]},addTeamManagers:{sid:8,cid:16,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},removeTeamManagers:{sid:8,cid:17,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},updateMyMemberInfo:{sid:8,cid:19,service:"team",params:[{type:"Property",name:"teamMember",reflectMapper:mf.teamMember}]},updateNickInTeam:{sid:8,cid:20,service:"team",params:[{type:"Property",name:"teamMember",reflectMapper:mf.teamMember}]},muteTeamMember:{sid:8,cid:25,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Int",name:"mute"}]},getTeamMemberInvitorAccid:{sid:8,cid:33,service:"team",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}],response:[{type:"StrStrMap",name:"accountsMap"}]},muteTeam:{sid:8,cid:32,service:"team",params:[{type:"Long",name:"teamId"},{type:"Int",name:"mute"}]},passTeamApply:{sid:8,cid:14,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectTeamApply:{sid:8,cid:15,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},acceptTeamInvite:{sid:8,cid:21,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectTeamInvite:{sid:8,cid:22,service:"team",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},syncTeams:{sid:8,cid:109,service:"team",response:[{type:"Long",name:"timetag"},{type:"PropertyArray",name:"teams",reflectMapper:hf.team}]},syncCreateTeam:{sid:8,cid:101,service:"team",response:[{type:"Property",name:"team",reflectMapper:hf.team}]},syncUpdateTeamMember:{sid:8,cid:119,service:"team",response:[{type:"Property",name:"teamMember",reflectMapper:hf.teamMember}]},syncMyTeamMembers:{sid:8,cid:126,ext:"sync",service:"team",response:[{type:"PropertyArray",name:"teamMembers",entity:"teamMember",reflectMapper:hf.teamMember},{type:"Long",name:"timetag"}]}},vf={"3_7":"getUsersNameCardFromServer","3_10":"updateMyNameCard","3_109":"syncMyNameCard","3_110":"onUpdateMyNameCard","3_3":"setBlack","3_103":"onUpdateBlackList","3_5":"setMute","3_105":"onUpdateMuteList","3_8":"syncRelations"},yf={user:{account:1,nick:3,avatar:4,signature:5,gender:6,email:7,birth:8,tel:9,ext:10,createTime:12,updateTime:13},relationMember:{account:0,isMuted:1,isBlack:2,createTime:3,updateTime:4}},_f=invertSerializeMap(yf),Mf={syncMyNameCard:{sid:3,cid:109,service:"user",response:[{type:"Property",name:"user",reflectMapper:_f.user},{type:"Long",name:"timetag"}]},setBlack:{service:"user",sid:3,cid:3,params:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},onUpdateBlackList:{service:"user",sid:3,cid:103,response:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},setMute:{service:"user",sid:3,cid:5,params:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},onUpdateMuteList:{service:"user",sid:3,cid:105,response:[{type:"String",name:"account"},{type:"Bool",name:"isAdd"}]},syncRelations:{service:"user",sid:3,cid:8,params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"list",reflectMapper:_f.relationMember},{type:"Long",name:"timetag"}]},getUsersNameCardFromServer:{service:"user",sid:3,cid:7,params:[{type:"StrArray",name:"accounts"}],response:[{type:"PropertyArray",name:"users",reflectMapper:_f.user}]},updateMyNameCard:{service:"user",sid:3,cid:10,params:[{type:"Property",name:"user",reflectMapper:yf.user}],response:[{type:"Long",name:"timetag"}]},onUpdateMyNameCard:{service:"user",sid:3,cid:110,response:[{type:"Property",name:"user",reflectMapper:_f.user}]}},If={needPush:{type:"boolean",required:!1},needPushBadge:{type:"boolean",required:!1},needPushNick:{type:"boolean",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},needForcePush:{type:"boolean",required:!1},forcePushIDsList:{type:"string",allowEmpty:!1,required:!1},forcePushContent:{type:"string",allowEmpty:!1,required:!1}},Sf={function:{type:"string",required:!1},topic:{type:"string",required:!1},customContent:{type:"string",required:!1},account:{type:"string",required:!1}};function _createForOfIteratorHelperLoose$4(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$4(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$4(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$4(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$4(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var Tf={subType:{type:"string"},setting:{resendFlag:{type:"boolean"},envConfig:{type:"string"},needSaveHistory:{type:"boolean"},needRoaming:{type:"boolean"},needOffline:{type:"boolean"},needSelfSync:{type:"boolean"},needRouted:{type:"boolean"},needUpdateSession:{type:"boolean"},isMuted:{type:"boolean"}},antiSpamInfo:{needAntiSpam:{type:"boolean"},antiSpamContent:{type:"string"},antiSpamBIZID:{type:"string"},clientAntispamHitting:{type:"boolean"},antiSpamUsingYidun:{type:"boolean"},yidunCallbackURL:{type:"string"},yidunAntiCheating:{type:"string"},yidunAntiSpamExtension:{type:"string"},yidunAntiSpamResult:{type:"string"}},pushInfo:If,robotInfo:Sf,teamSpecializationInfo:{needACK:{type:"boolean"},isACKSent:{type:"boolean"},ackSnapshot:{type:"number"}},threadMessageInfo:{replyMsgFromAccount:{type:"string"},replyMsgToAccount:{type:"string"},replyMsgTime:{type:"number"},replyMsgIdServer:{type:"string"},replyMsgIdClient:{type:"string"},threadMsgFromAccount:{type:"string"},threadMsgToAccount:{type:"string"},threadMsgTime:{type:"number"},threadMsgIdServer:{type:"string"},threadMsgIdClient:{type:"string"}}},Cf={0:"addTeamMembers",1:"removeTeamMembers",2:"leaveTeam",3:"updateTeam",4:"dismissTeam",5:"passTeamApply",6:"transferTeam",7:"addTeamManagers",8:"removeTeamManagers",9:"acceptTeamInvite",10:"updateTeamMemberMute",101:"netcallMiss",102:"netcallBill",103:"netcallReject",401:"addSuperTeamMembers",402:"removeSuperTeamMembers",403:"leaveSuperTeam",404:"updateSuperTeam",405:"dismissSuperTeam",406:"transferSuperTeam",407:"addSuperTeamManagers",408:"removeSuperTeamManagers",409:"updateSuperTeamMembersMute",410:"passSuperTeamApply",411:"acceptSuperTeamInvite"};function getSessionId(e,t){return ou[e.scene]+"-"+(e.to===t?e.from:e.to)}function msgFlow(e,t){return e.from===t?e.to===t?"in":"out":"in"}function formatMsg$1(e,t){var r=t.account,n=t.featureValue,a=t.statusValue,i=t.sessionAck,o=t.msgReceiptTime,s=ou[e.scene],c=e.to===r?e.from:e.to,l=lu.default,d=cu.unread;bd(e.isInBlackList)>0?(d=cu.refused,delete e.isInBlackList):d=e.from===r?o&&o>=+e.time?cu.receipt:cu.sent:i&&i>=+e.time?cu.read:cu.unread;var u=Et(Et({},format(Tf,e)),{scene:s,type:iu[e.type],fromClientType:su[e.fromClientType],flow:msgFlow(e,r),target:c,to:e.to,from:e.from,time:e.time?+e.time:void 0,userUpdateTime:e.userUpdateTime?+e.userUpdateTime:void 0,idClient:e.idClient,sessionId:s+"-"+c,status:cu[a||d],feature:lu[n||l]});if("string"==typeof u.attach)try{u.attach=JSON.parse(u.attach)}catch(e){}return"notification"===u.type&&(u.attach=u.attach?function formatNotificationAttach(e){var t,r={};if(r.type=Cf[e.id]||e.id,!e.data)return r;var n,a={ids:"accounts",id:"account",attach:"custom",channel:"channelId",calltype:"netcallType",mute:"mute",duration:"duration",time:"time",from:"from",ext:"ext"},i=e.data;return forEach$1(t=Nt(a)).call(t,(function(e){void 0!==i[e]&&(r[a[e]]=i[e])})),i.tinfo&&(r.team=formatTeam(deserialize(i.tinfo,hf.team))),i.uinfos&&(r.users=map$6(n=i.uinfos).call(n,(function(e){return formatUser(deserialize(e,_f.user))}))),void 0!==i.mute&&(r.mute=1===bd(i.mute)),r}(u.attach):{}),u}function formatMsgs$1(e,t){return e&&e.length>0?removeDupMsgsByIdClient(map$6(e).call(e,(function(e){return formatMsg$1(e,t)}))):[]}function removeDupMsgsByIdClient(e){for(var t,r,n={},a=_createForOfIteratorHelperLoose$4(e);!(r=a()).done;){var i=r.value,o=n[i.idClient];o&&o.time>i.time||(n[i.idClient]=i)}return map$6(t=Nt(n)).call(t,(function(e){return n[e]}))}function processPushInfoInMsg(e,t){void 0===t&&(t=!0);var r=Et({},e);if(r.pushInfo&&t){for(var n in r.pushInfo)"boolean"==typeof r.pushInfo[n]?r[n]=r.pushInfo[n]?1:0:r[n]=r.pushInfo[n];delete r.pushInfo}return r.scene===ou.team&&r.needForcePush&&(r.forcePushContent=r.forcePushContent||r.pushContent,r.forcePushIDsList=r.forcePushIDsList?r.forcePushIDsList:"#%@all@%#"),r}function generatorMsgForCmd$1(e,t,r,n){e.onSendBefore,e.onUploadStart,e.onUploadDone;var a=e.replyMsg,i=__rest(e,["onSendBefore","onUploadStart","onUploadDone","replyMsg"]),o=Et(Et({},formatReverse(Tf,i)),{scene:ou[e.scene],type:iu[e.type],from:t,fromClientType:16,fromDeviceId:r,fromNick:null==n?void 0:n.nick,userUpdateTime:null==n?void 0:n.updateTime,status:cu[cu.sending]});if(o.idClient=o.resendFlag?e.idClient:ld(),!o.idClient)throw new bl("idClient is required to resend a message","idClient","required");return o=processPushInfoInMsg(o,!1),a&&(o.replyMsgFromAccount=a.from,o.replyMsgToAccount=a.to,o.replyMsgTime=+a.time,o.replyMsgIdServer=a.idServer,o.replyMsgIdClient=a.idClient,o.threadMsgFromAccount=a.from,o.threadMsgToAccount=a.to,o.threadMsgTime=+a.time,o.threadMsgIdServer=a.idServer,o.threadMsgIdClient=a.idClient,a.threadMessageInfo&&a.threadMessageInfo.threadMsgIdServer&&(o.threadMsgFromAccount=a.threadMessageInfo.threadMsgFromAccount,o.threadMsgToAccount=a.threadMessageInfo.threadMsgToAccount,o.threadMsgTime=a.threadMessageInfo.threadMsgTime,o.threadMsgIdServer=a.threadMessageInfo.threadMsgIdServer,o.threadMsgIdClient=a.threadMessageInfo.threadMsgIdClient)),o}function formatDeletedMsgs(e,t){return map$6(e).call(e,(function(e){var r;return r=t||(Yv(bd(e.scene))?e.scene:1===bd(e.scene)?"p2p":"team"),{deletedTime:bd(e.time),from:e.from,idClient:e.deletedIdClient||e.idClient,idServer:e.deletedIdServer||e.idServer,scene:r,time:bd(e.deletedMsgCreateTime),to:e.to,ext:"string"==typeof e.ext?e.ext:null}}))}function reverse(e){for(var t=[],r=(e=e||[]).length-1;r>=0;r--)t.push(e[r]);return t}var bf,Ef,Rf,kf=function(){function ModuleService(e){this.core=e}return ModuleService.prototype.processBroadcastMsg=function processBroadcastMsg(e){var t=map$6(e).call(e,(function(e){return Et(Et({},e),{time:bd(e.time)})}));return this.core.sendCmd("batchMarkRead",{sid:7,cid:17,ids:map$6(t).call(t,(function(e){return e.id}))}),t},ModuleService}(),wf={needPush:{type:"boolean",required:!1},needPushBadge:{type:"boolean",required:!1},needPushNick:{type:"boolean",required:!1},pushContent:{type:"string",allowEmpty:!1,required:!1},pushPayload:{type:"string",allowEmpty:!1,required:!1}},Af={pushContent:8,pushPayload:9,needPush:107,needPushBadge:109,needPushNick:110},Nf={"4_4":"syncOfflineMsgs","4_9":"syncRoamingMsgs","4_17":"syncRoamingMsgs","4_21":"syncDeleteSelfMsgs","7_1":"sendMsg","8_23":"getHistoryTeamMsgs","21_14":"getHistorySuperTeamMsgs","8_2":"sendTeamMsg","21_2":"sendSuperTeamMsg","7_11":"sendMsgReceipt","7_13":"recallMsg","7_24":"deleteSelfMsgs","21_17":"recallSuperTeamMsg","7_2":"onMsg","8_3":"onMsg","21_3":"onMsg","7_101":"onMsg","8_102":"onMsg","21_102":"onMsg","8_4":"nimOnTeamMsgs","4_16":"syncBroadcastMsg","7_17":"onBroadcastMsg","7_123":"onDeleteSelfMsg","7_124":"onDeleteSelfMsgs"},xf=Et(Et({scene:0,to:1,from:2,fromClientType:4,fromDeviceId:5,fromNick:6,time:7,type:8,body:9,attach:10,idClient:11,idServer:12,resendFlag:13,userUpdateTime:14,ext:15,needAntiSpam:21,antiSpamContent:22,antiSpamBIZID:23,clientAntispamHitting:24,antiSpamUsingYidun:25,needACK:26,yidunCallbackURL:27,needUpdateSession:28,replyMsgFromAccount:29,replyMsgToAccount:30,replyMsgTime:31,replyMsgIdServer:32,replyMsgIdClient:33,threadMsgFromAccount:34,threadMsgToAccount:35,threadMsgTime:36,threadMsgIdServer:37,threadMsgIdClient:38,isDeleted:39,callbackExt:40,subType:41,yidunAntiCheating:42,envConfig:43,yidunAntiSpamExtension:44,yidunAntiSpamResult:45,__clientExt:{id:46,converter:objectToJSONString,retConverter:stringToJSONObject},needSaveHistory:100,needRoaming:101,needSelfSync:102,isMuted:104,needRouted:105,isInBlackList:106,needOffline:108,isReplyMsg:111,ackSnapshot:112},{pushContent:17,pushPayload:16,forcePushIDsList:18,forcePushContent:19,needForcePush:20,needPush:107,needPushBadge:109,needPushNick:110}),{function:47,topic:48,customContent:49,account:50}),Of={msg:xf,recallMsgTag:Et({time:0,type:1,to:2,from:3,ps:4,attach:5,deletedIdClient:10,deletedIdServer:11,deleteMsgCreatetime:14,opeAccount:16,env:21},Af),deleteSelfMsgTag:{scene:1,from:2,to:3,idServer:4,idClient:5,deletedMsgCreateTime:6,time:7,ext:8},msgReceiptTag:{to:1,from:2,time:7,idClient:11},broadcastMsg:{id:1,fromAccid:2,time:4,body:5}},Pf=invertSerializeMap(Of),Lf={sendMsg:{sid:7,cid:1,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:Of.msg}],response:[{type:"Property",name:"msg",reflectMapper:Pf.msg}],ignoreErrCodes:[7101]},sendTeamMsg:{sid:8,cid:2,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:Of.msg}],response:[{type:"Property",name:"msg",reflectMapper:Pf.msg}]},sendSuperTeamMsg:{sid:21,cid:2,service:"msg",params:[{type:"Property",name:"msg",reflectMapper:Of.msg}],response:[{type:"Property",name:"msg",reflectMapper:Pf.msg}]},onMsg:{sid:7,cid:2,service:"msg",response:[{type:"Property",name:"msg",reflectMapper:Pf.msg}]},nimOnTeamMsgs:{sid:8,cid:4,service:"msg",response:[{type:"PropertyArray",name:"datas",reflectMapper:Pf.msg}]},getHistoryTeamMsgs:{sid:8,cid:23,service:"msg",params:[{type:"Long",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:Pf.msg}]},getHistorySuperTeamMsgs:{sid:21,cid:14,params:[{type:"Long",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:Pf.msg}],service:"msg"},recallMsg:{sid:7,cid:13,service:"msg",params:[{type:"Property",name:"recallMsgTag",reflectMapper:Of.recallMsgTag}]},deleteSelfMsgs:{sid:7,cid:24,service:"msg",params:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:Of.deleteSelfMsgTag}],response:[{type:"Long",name:"timetag"}]},recallSuperTeamMsg:{sid:21,cid:17,service:"msg",params:[{type:"Property",name:"recallMsgTag",reflectMapper:Of.recallMsgTag}]},sendMsgReceipt:{sid:7,cid:11,service:"msg",params:[{type:"Property",name:"msgReceiptTag",reflectMapper:Of.msgReceiptTag}],response:[{type:"Property",name:"msgReceiptTag",reflectMapper:Pf.msgReceiptTag}]},batchMarkRead:{sid:4,cid:5,service:"msg",hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},syncMsgReceipts:{sid:4,cid:12,service:"msg",response:[{type:"PropertyArray",name:"msgReceipts",reflectMapper:Pf.msgReceiptTag},{type:"Long",name:"timetag"}]},syncOfflineMsgs:{sid:4,cid:4,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:Pf.msg}]},syncRoamingMsgs:{sid:4,cid:9,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:Pf.msg}]},syncBroadcastMsg:{sid:4,cid:16,service:"msg",response:[{type:"PropertyArray",name:"msgs",reflectMapper:Pf.broadcastMsg}]},onBroadcastMsg:{sid:7,cid:17,service:"msg",response:[{type:"Property",name:"msg",reflectMapper:Pf.broadcastMsg}]},onDeleteSelfMsg:{sid:7,cid:123,service:"msg",response:[{type:"Property",name:"deletedMsg",reflectMapper:Pf.deleteSelfMsgTag}]},onDeleteSelfMsgs:{sid:7,cid:124,service:"msg",response:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:Pf.deleteSelfMsgTag}]},syncDeleteSelfMsgs:{sid:4,cid:21,service:"msg",response:[{type:"PropertyArray",name:"deletedMsgs",reflectMapper:Pf.deleteSelfMsgTag}]}};!function(e){e[e.none=0]="none",e[e.pass=1]="pass",e[e.decline=2]="decline",e[e.read=3]="read",e[e.deleted=4]="deleted",e[e.invalid=5]="invalid"}(bf||(bf={})),function(e){e[e.default=0]="default",e[e.leave=1]="leave",e[e.roam=2]="roam"}(Ef||(Ef={})),function(e){e[e.applyTeam=0]="applyTeam",e[e.rejectTeamApply=1]="rejectTeamApply",e[e.teamInvite=2]="teamInvite",e[e.rejectTeamInvite=3]="rejectTeamInvite",e[e.friendRequest=5]="friendRequest",e[e.deleteFriend=6]="deleteFriend",e[e.recallMsgP2p=7]="recallMsgP2p",e[e.recallMsgTeam=8]="recallMsgTeam",e[e.recallMsgSuperTeam=12]="recallMsgSuperTeam",e[e.deleteMsgP2pOneWay=13]="deleteMsgP2pOneWay",e[e.deleteMsgTeamOneWay=14]="deleteMsgTeamOneWay",e[e.applySuperTeam=15]="applySuperTeam",e[e.rejectSuperTeamApply=16]="rejectSuperTeamApply",e[e.superTeamInvite=17]="superTeamInvite",e[e.rejectSuperTeamInvite=18]="rejectSuperTeamInvite",e[e.customP2p=100]="customP2p",e[e.customTeam=101]="customTeam",e[e.customSuperTeam=103]="customSuperTeam"}(Rf||(Rf={}));var Vf={1:"addFriend",2:"applyFriend",3:"passFriendApply",4:"rejectFriendApply"};var Uf={setting:{needSaveOffline:{type:"boolean"},isRoutable:{type:"boolean"},envConfig:{type:"string"}},antiSpamInfo:{needAntiSpam:{type:"boolean"},antiSpamContent:{type:"boolean"}},pushInfo:wf,recallMessageInfo:{idClient:{type:"string",rawKey:"deletedIdClient"},idServer:{type:"string",rawKey:"deletedIdServer"},createTime:{type:"number",rawKey:"deletedMsgCreateTime"},fromNick:{type:"string",rawKey:"deletedMsgFromNick"},opeAccount:{type:"string"}}};function formatSystemMessage(e,t,r){var n=+e.type,a=getEnumKeyByEnumValue(Rf,n);r=r||Ef.default;var i=Et(Et({},format(Uf,e)),{type:a,time:+e.time,to:e.to,from:e.from,idServer:e.idServer,state:bf[bf.none],feature:Ef[r]});if("0"===i.idServer&&i.setting&&(i.setting.needSaveOffline=!1),"string"==typeof i.attach)try{i.attach=JSON.parse(i.attach)}catch(e){t.error("formatSystemMessage: "+i.idServer+" parse attach error",e&&e.message)}return 5===n&&i.attach?(i.attach.type=Vf[+i.attach.vt],"passFriendApply"===i.attach.type?i.state=bf[bf.pass]:"rejectFriendApply"===i.attach.type&&(i.state=bf[bf.decline])):n<=3&&i.attach&&(i.attach=function formatTeamAttach(e){var t=e.attach,r=e.tinfo,n=__rest(e,["attach","tinfo"]);return n.ext=t,void 0!==r&&(n.team=formatTeam(deserialize(e.tinfo,hf.team))),n}(i.attach)),i}function generatorSysMsgForCmd$1(e){var t=Et({},e);return Et(Et({},formatReverse(Uf,t)),{type:Rf[t.type],to:t.to,attach:t.attach})}function getSceneFromRecallSysMsg(e){return e===Rf.recallMsgP2p?"p2p":e===Rf.recallMsgTeam?"team":e===Rf.recallMsgSuperTeam?"superTeam":""}var Df=function(e){function MsgService(t){var r;return(r=e.call(this,"msg",t)||this).onV2SendMessage=function(e){var t=formatMsg$1(e,{account:r.core.account,featureValue:lu.default});t.status=e.status,r.core.eventBus.emit("session/updateForNewMsg",t)},r.onV2ModifyMessage=function(e){var t,n=ou[e.scene]+"-"+(e.to===r.core.account?e.from:e.to),a=null===(t=r.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:n}),i=formatMsg$1(e,a?{account:r.core.account,sessionAck:a.ack,msgReceiptTime:a.msgReceiptTime}:{account:r.core.account});r.core.eventBus.emit("session/updateForModifyMsg",i)},r.onV2RecallMsg=function(e){var t=formatDeletedMsgs([e],getSceneFromRecallSysMsg(+e.type));r.core.eventBus.emit("session/updateForDeletedMsg",t)},r.onV2DeleteSelfMsgs=function(e){var t=formatDeletedMsgs(e);r.core.eventBus.emit("session/updateForDeletedMsg",t)},r.service=new kf(t),registerParser({cmdMap:Nf,cmdConfig:Lf}),r.registerListener(),r}_t(MsgService,e);var t=MsgService.prototype;return t.registerListener=function registerListener(){this.core.eventBus.on("forwardReceive/msg/sendMsg",this.onV2SendMessage),this.core.eventBus.on("forwardReceive/msg/modifyMsg",this.onV2ModifyMessage),this.core.eventBus.on("forwardReceive/msg/recallMsg",this.onV2RecallMsg),this.core.eventBus.on("forwardReceive/msg/deleteSelfMsgs",this.onV2DeleteSelfMsgs)},t.sendTextMsg=function sendTextMsg(e){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Et(Et({},e),{type:"text"}))},t.sendTipMsg=function sendTipMsg(e){return validate({body:{type:"string",allowEmpty:!1}},e),this.sendMsg(Et(Et({},e),{type:"tip"}))},t.sendGeoLocationMsg=function sendGeoLocationMsg(e){return validate({attach:{type:"object",rules:{title:{type:"string",allowEmpty:!1},lat:{type:"number"},lng:{type:"number"}}}},e),this.sendMsg(Et(Et({},e),{type:"geo",attach:bn(e.attach)}))},t.sendCustomMsg=function sendCustomMsg(e){return validate({attach:{type:"string",allowEmpty:!1}},e),this.sendMsg(Et(Et({},e),{type:"custom"}))},t.sendMsg=function sendMsg(e){var t,r=this;if(validate({scene:{type:"enum",values:getEnumKeys(ou)},type:{type:"enum",values:getEnumKeys(iu)},to:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1},setting:{type:"object",rules:{resendFlag:{type:"boolean",required:!1},needSaveHistory:{type:"boolean",required:!1},needRoaming:{type:"boolean",required:!1},needOffline:{type:"boolean",required:!1},needSelfSync:{type:"boolean",required:!1},needRouted:{type:"boolean",required:!1},needUpdateSession:{type:"boolean",required:!1}},required:!1},antiSpamInfo:{type:"object",required:!1,rules:{clientAntispamHitting:{type:"boolean",required:!1},antiSpamUsingYidun:{type:"boolean",required:!1}}},pushInfo:{type:"object",required:!1,rules:If},robotInfo:{type:"object",required:!1,rules:Sf},teamSpecializationInfo:{type:"object",required:!1,rules:{needACK:{type:"boolean",required:!1}}}},e),"team"===e.scene&&e.robotInfo&&!e.robotInfo.account)throw new Tl('When "scene" equals "team", account is required in robotInfo',{key:"account"},"required");var n,a="p2p"===e.scene?"sendMsg":"team"===e.scene?"sendTeamMsg":"sendSuperTeamMsg",i=generatorMsgForCmd$1(e,this.core.account,this.core.config.deviceId,null===(t=this.core.user)||void 0===t?void 0:t.myInfo),o=formatMsg$1(Et(Et({},i),{time:(new Date).getTime()}),{account:this.core.account,featureValue:lu.default,statusValue:cu.sending});try{e.onSendBefore&&e.onSendBefore(o)}catch(e){this.logger.error("sendMsg: options.onSendBefore error",e)}return this.core.eventBus.emit("session/updateForNewMsg",o),this.core.eventBus.emit("forwardSend/msg/sendMsg",i),this.core.sendCmd(a,{msg:i}).then((function(t){var a=t.content,s=t.error;if(n=a.msg,s)throw s;var c=formatMsg$1(Et(Et({},i),a.msg),{account:r.core.account,featureValue:lu.default,statusValue:cu.sent});return c.from===c.to&&r.markMsgsAck([c]),r.core.eventBus.emit("session/updateForNewMsg",c),r.core.eventBus.emit("forwardSend/msg/sendMsg",Et(Et({},generatorMsgForCmd$1(c,c.from,c.fromDeviceId)),{idClient:c.idClient,status:"sent"})),r.core.reporter.report("msgSend",{msgId:c.idServer,clientId:c.idClient,msgTime:c.time,fromAccid:"p2p"===e.scene?r.core.account:"",toAccid:c.to,type:ou[c.scene],roomId:"",tid:"p2p"===e.scene?"":c.to,result:200,failReason:"",rt:Hi()-o.time}),c})).catch((function(t){var a=formatMsg$1(Et(Et(Et({},i),{time:(new Date).getTime()}),n),{account:r.core.account,featureValue:lu.default,statusValue:7101===t.code?cu.refused:cu.sendFailed});throw t.msg=a,r.core.eventBus.emit("session/updateForNewMsg",a),r.core.eventBus.emit("forwardSend/msg/sendMsg",Et(Et({},generatorMsgForCmd$1(a,a.from,a.fromDeviceId)),{status:"sendFailed"})),r.core.reporter.report("msgSend",{msgId:a.idServer,clientId:a.idClient,msgTime:a.time,fromAccid:"p2p"===e.scene?r.core.account:"",toAccid:a.to,type:ou[a.scene],roomId:"",tid:"p2p"===e.scene?"":a.to,result:null==t?void 0:t.code,failReason:(null==t?void 0:t.message)||"",rt:Hi()-o.time}),t}))},t.resendMsg=function resendMsg(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:if(validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1}}}},e),t=e.msg,r=Et(Et({},t),{attach:t.attach?bn(t.attach):void 0,setting:{resendFlag:!0}}),t.from===this.core.account){n.next=5;break}throw new Error("You can only resend messages that you sent: "+t.idClient);case 5:return n.abrupt("return",this.sendMsg(r));case 6:case"end":return n.stop()}}),_callee,this)})))},t.forwardMsg=function forwardMsg(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r;return Dl.wrap((function _callee2$(n){for(;;)switch(n.prev=n.next){case 0:return validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1}}},scene:{type:"enum",values:getEnumKeys(ou)},to:{type:"string",allowEmpty:!1}},e),t=e.msg,r=Et(Et({},t),{scene:e.scene,to:e.to,attach:t.attach?bn(t.attach):void 0}),n.abrupt("return",this.sendMsg(r));case 4:case"end":return n.stop()}}),_callee2,this)})))},t.sendImageMsg=function sendImageMsg(e){return this.doSendFile(Et(Et({},e),{type:"image"}))},t.sendFileMsg=function sendFileMsg(e){return this.doSendFile(Et(Et({},e),{type:"file"}))},t.sendAudioMsg=function sendAudioMsg(e){return this.doSendFile(Et(Et({},e),{type:"audio"}))},t.sendVideoMsg=function sendVideoMsg(e){return this.doSendFile(Et(Et({},e),{type:"video"}))},t.doSendFile=function doSendFile(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:if(validate({scene:{type:"enum",values:getEnumKeys(ou)},to:{type:"string",allowEmpty:!1},type:{type:"string",allowEmpty:!1},attach:{type:"object",rules:{url:{type:"string",allowEmpty:!1}},required:!1},maxSize:{type:"number",min:1,required:!1}},e),t=e.attach){r.next=15;break}if(this.core.cloudStorage&&this.core.cloudStorage.uploadFile){r.next=5;break}throw new Error('Service "cloudStorage" does not exist');case 5:return r.prev=5,r.next=8,this.core.cloudStorage.uploadFile(e);case 8:t=r.sent,r.next=15;break;case 11:throw r.prev=11,r.t0=r.catch(5),this.logger.error("sendFile:: upload File error or abort.",r.t0),r.t0;case 15:return r.abrupt("return",this.sendMsg(Et(Et({},e),{attach:bn(t),type:e.type})));case 16:case"end":return r.stop()}}),_callee3,this,[[5,11]])})))},t.recallMsg=function recallMsg(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t,r,n,a,i,o;return Dl.wrap((function _callee4$(s){for(;;)switch(s.prev=s.next){case 0:return validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},scene:{type:"enum",values:getEnumKeys(ou)},time:{type:"number"}}},pushInfo:{type:"object",required:!1,rules:wf},ps:{type:"string",allowEmpty:!1,required:!1}},e),t=e.msg,r={p2p:"recallMsg",team:"recallMsg",superTeam:"recallSuperTeamMsg"},n={p2p:7,team:8,superTeam:12},a=processPushInfoInMsg({time:t.time,type:n[t.scene],to:t.to,from:t.from,ps:e.ps,attach:e.attach,deletedIdClient:t.idClient,deletedIdServer:t.idServer,opeAccount:t.from,env:e.env,pushInfo:e.pushInfo}),s.next=7,this.core.sendCmd(r[t.scene],{recallMsgTag:a});case 7:return i=Et({},t,{deletedMsgCreateTime:t.time}),o=formatDeletedMsgs([i]),this.core.eventBus.emit("session/updateForDeletedMsg",o),this.core.eventBus.emit("forwardSend/msg/recallMsg",a),s.abrupt("return",t);case 12:case"end":return s.stop()}}),_callee4,this)})))},t.deleteSelfMsgs=function deleteSelfMsgs(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t,r,n,a,i;return Dl.wrap((function _callee5$(o){for(;;)switch(o.prev=o.next){case 0:return validate({msgs:{type:"array",rules:{scene:{type:"enum",values:["p2p","team"]},from:{type:"string",allowEmpty:!1},to:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},time:{type:"number",allowEmpty:!1}}},ext:{type:"string",allowEmpty:!1,required:!1}},e),t=e.msgs,r=map$6(t).call(t,(function(t){return{scene:"p2p"===t.scene?1:2,from:t.from,to:t.to,idServer:t.idServer,idClient:t.idClient,deletedMsgCreateTime:t.time,ext:e.ext}})),o.next=5,this.core.sendCmd("deleteSelfMsgs",{deletedMsgs:r});case 5:return n=o.sent,a=map$6(r).call(r,(function(e){var t;return Et({},e,{time:null===(t=null==n?void 0:n.content)||void 0===t?void 0:t.timetag})})),i=formatDeletedMsgs(a),this.core.eventBus.emit("session/updateForDeletedMsg",i),this.core.eventBus.emit("forwardSend/msg/deleteSelfMsgs",map$6(r).call(r,(function(e){var t;return Et(Et({},e),{time:null===(t=null==n?void 0:n.content)||void 0===t?void 0:t.timetag})}))),o.abrupt("return",i);case 11:case"end":return o.stop()}}),_callee5,this)})))},t.sendMsgReceipt=function sendMsgReceipt(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var n,a,i,o;return Dl.wrap((function _callee6$(s){for(;;)switch(s.prev=s.next){case 0:if(validate({msg:{type:"object",rules:{idClient:{type:"string",allowEmpty:!1},target:{type:"string",allowEmpty:!1},time:{type:"number"}}}},e),"p2p"===(n=e.msg).scene&&"in"===n.flow){s.next=5;break}return this.logger.warn("Msg scene: "+n.scene+", flow: "+n.flow+" is not allowed to send msg receipt"),s.abrupt("return",void 0);case 5:return a={to:n.target,idClient:n.idClient,time:n.time},s.next=8,this.core.sendCmd("sendMsgReceipt",{msgReceiptTag:a});case 8:return i=s.sent,o=bd(null===(r=null===(t=i.content)||void 0===t?void 0:t.msgReceiptTag)||void 0===r?void 0:r.time),s.abrupt("return",Et(Et({},a),{time:o?Math.min(o,a.time):a.time}));case 11:case"end":return s.stop()}}),_callee6,this)})))},t.sendTeamMsgReceipt=function sendTeamMsgReceipt(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var t;return Dl.wrap((function _callee7$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamMsgReceipts:{type:"array",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}},max:50}},e),t=e.teamMsgReceipts,this.core.sendCmd("sendTeamMsgReceipt",{teamMsgReceipts:t}),r.abrupt("return",void 0);case 4:case"end":return r.stop()}}),_callee7,this)})))},t.getTeamMsgReads=function getTeamMsgReads(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var r,n,a;return Dl.wrap((function _callee8$(i){for(;;)switch(i.prev=i.next){case 0:return validate({teamMsgReceipts:{type:"array",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}}}},e),r=e.teamMsgReceipts,i.next=4,this.core.sendCmd("getTeamMsgReads",{teamMsgReceipts:r});case 4:return n=i.sent,a=(a=null===(t=n.content)||void 0===t?void 0:t.teamMsgReceipts)?map$6(a).call(a,(function(e){return Et(Et({},e),{read:bd(e.read),unread:bd(e.unread)})})):[],i.abrupt("return",a);case 8:case"end":return i.stop()}}),_callee8,this)})))},t.getTeamMsgReadAccounts=function getTeamMsgReadAccounts(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t,r;return Dl.wrap((function _callee9$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamMsgReceipt:{type:"object",rules:{teamId:{type:"string",allowEmpty:!1},idClient:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1}}}},e),t=e.teamMsgReceipt,n.next=4,this.core.sendCmd("getTeamMsgReadAccounts",{teamMsgReceiptTag:t});case 4:return r=n.sent,n.abrupt("return",r.content);case 6:case"end":return n.stop()}}),_callee9,this)})))},t.markMsgsAck=function markMsgsAck(e){if(e&&e.length>0){var t=[],r=[];forEach$1(e).call(e,(function(e){"p2p"===e.scene&&"in"===e.flow?t.push(e):"team"===e.scene&&"in"===e.flow&&r.push(e)})),t.length>0&&this.core.sendCmd("batchMarkRead",{sid:7,cid:2,ids:map$6(t).call(t,(function(e){return e.idServer}))}),r.length>0&&this.core.sendCmd("batchMarkRead",{sid:8,cid:3,ids:map$6(r).call(r,(function(e){return e.idServer}))})}},t.onMsgHandler=function onMsgHandler(e){var t;if(e.error)this.logger.error("msgHandler::recvError",e.error);else{var r="number"==typeof get(e,"raw.r[0]")?""+e.raw.r[0]:void 0,n=e.content.msg;n.idServer=n.idServer||r;var a=getSessionId(n,this.core.account),i=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:a}),o=formatMsg$1(n,i?{account:this.core.account,sessionAck:i.ack,msgReceiptTime:i.msgReceiptTime}:{account:this.core.account});this.logger.getDebugMode()?this.logger.debug("msgHandler::recvMsg",o.idClient,o.idServer,o):this.logger.log("msgHandler::recvMsg",o.idClient,o.idServer),this.markMsgsAck([o]),this.core.eventBus.emit("session/updateForNewMsg",o),"superTeam"===o.scene?this.core.eventBus.emit("sync/updateTimetag",{superTeamRoamingMsgs:o.time}):this.core.eventBus.emit("sync/updateTimetag",{roamingMsgs:o.time}),this.core.emit("msg",o),"notification"===o.type?this.core.eventBus.emit("team/onNotification",o):"out"!==o.flow&&this.doMsgReceiveReport(o,e),"notification"!==o.type&&this.core.user.checkUserUpdate(o)}},t.doMsgReceiveReport=function doMsgReceiveReport(e,t){if(e.from!==this.core.account){var r="p2p"===e.scene,n=get(e,"__clientExt.statistics.apiCallingTime")||0,a=get(e,"__clientExt.statistics.sendTime")||0,i=get(e,"__clientExt.statistics.attachUploadDuration")||0,o=this.core.timeOrigin.getNTPTime(),s=e.time,c=this.core.timeOrigin.checkNodeReliable(t.__receiveTimeNode)?this.core.timeOrigin.getNTPTime(t.__receiveTimeNode):o;this.core.reporter.report("msgReceive",{msgId:e.idServer,clientId:e.idClient,serverTime:s,receiveTime:c,fromAccid:r?e.from:"",toAccid:e.to,type:ou[e.scene],tid:r?"":e.to,apiCallingTime:n,sendTime:a,attachUploadDuration:i,callbackTime:o,preHandleTime:o,result:200,failReason:"",rt:o-s})}},t.nimOnTeamMsgsHandler=function nimOnTeamMsgsHandler(e){var t,r=this;forEach$1(t=e.content.datas).call(t,(function(t){r.onMsgHandler(Et({},e,{content:{msg:t}}))}))},t.syncRoamingMsgsHandler=function syncRoamingMsgsHandler(e){var t,r,n=e.content.msgs||[];if(0!==n.length){var a=getSessionId(n[0],this.core.account),i=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:a}),o=(n=formatMsgs$1(n,i?{account:this.core.account,featureValue:lu.roam,sessionAck:i.ack,msgReceiptTime:i.msgReceiptTime}:{account:this.core.account,featureValue:lu.roam}))[0].time,s={timetag:o,sessionId:a,msgs:reverse(n)};"function"!=typeof(null===(r=this.core.sync)||void 0===r?void 0:r.getSyncDoneFlag)||this.core.sync.getSyncDoneFlag()||this.core.eventBus.emit("session/syncMsgs",s),this.core.emit("syncRoamingMsgs",s),"superTeam"===n[0].scene?this.core.eventBus.emit("sync/updateTimetag",{superTeamRoamingMsgs:o}):this.core.eventBus.emit("sync/updateTimetag",{roamingMsgs:o})}},t.syncOfflineMsgsHandler=function syncOfflineMsgsHandler(e){var t,r=this,n=e.content.msgs||[];if(0!==n.length){var a={},i=[];forEach$1(n).call(n,(function(e){var t=getSessionId(e,r.core.account),n=r.core.session.getSessionWithUncomplete({id:t}),o=formatMsg$1(e,n?{account:r.core.account,featureValue:lu.leave,sessionAck:n.ack,msgReceiptTime:n.msgReceiptTime}:{account:r.core.account,featureValue:lu.leave});i.push(o),a[o.sessionId]?a[o.sessionId].push(o):a[o.sessionId]=[o]})),this.markMsgsAck(i);var o=0;forEach$1(t=Nt(a)).call(t,(function(e){var t,n=sort(t=a[e]).call(t,(function(e,t){return t.time-e.time}));(n=removeDupMsgsByIdClient(n))[0].time>o&&(o=n[0].time);var i={timetag:n[0].time,sessionId:e,msgs:n};r.core.eventBus.emit("session/syncMsgs",i),r.core.emit("syncOfflineMsgs",i)})),this.core.eventBus.emit("sync/updateTimetag",{offlineMsgs:o})}},t.syncDeleteSelfMsgsHandler=function syncDeleteSelfMsgsHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.deletedMsgs;r&&r.length>0||this.logger.warn("syncDeleteSelfMsgs:: no msgs");var n=r[r.length-1].time;this.core.eventBus.emit("sync/updateTimetag",{deleteSelfMsgs:n})},t.onDeleteSelfMsgHandler=function onDeleteSelfMsgHandler(e){var t=formatDeletedMsgs([e.content.deletedMsg]);this.core.eventBus.emit("session/updateForDeletedMsg",t),this.core.emit("deleteSelfMsgs",t)},t.onDeleteSelfMsgsHandler=function onDeleteSelfMsgsHandler(e){var t=formatDeletedMsgs(e.content.deletedMsgs);this.core.eventBus.emit("session/updateForDeletedMsg",t),this.core.emit("deleteSelfMsgs",t)},t.onBroadcastMsgHandler=function onBroadcastMsgHandler(e){var t=e.content.msg,r=this.service.processBroadcastMsg([t]);this.core.emit("broadcastMsgs",r)},t.syncBroadcastMsgHandler=function syncBroadcastMsgHandler(e){var t=e.content.msgs,r=this.service.processBroadcastMsg(t);this.core.emit("broadcastMsgs",r)},MsgService}(ku),qf={"5_1":"sync"},Bf={sync:{sid:5,cid:1,service:"sync",hasPacketTimer:!1,params:[{type:"Property",name:"sync",reflectMapper:{myInfo:1,offlineMsgs:2,teams:3,roamingMsgs:7,relations:9,friends:11,friendUsers:13,msgReceipts:14,myTeamMembers:15,donnop:16,recallMsg:17,sessionAck:18,broadcastMsgs:20,avSignal:21,superTeams:22,mySuperTeamMembers:23,superTeamRoamingMsgs:24,deleteSuperTeamMsg:25,superTeamSessionAck:26,deleteSelfMsgs:27,stickTopSessions:28,sessionHistoryMsgsDelete:29}}],response:[{type:"Long",name:"timetag"}]}},Ff=function(e){function SyncService(t,r){var n;return void 0===r&&(r={}),(n=e.call(this,"sync",t)||this).syncDoneFlag=!1,n.config={myInfo:!!t.user.name,offlineMsgs:!!t.msg.name,teams:!!t.team.name,myTeamMembers:!!t.team.name,roamingMsgs:!!t.msg.name,relations:!!t.user.name,friends:!!t.friend.name,friendUsers:!!t.user.name,msgReceipts:!!t.msg.name,broadcastMsgs:!!t.msg.name,recallMsg:!!t.msg.name,sessionAck:!!t.session.name,superTeamSessionAck:!!t.session.name,superTeams:!!t.superTeam.name,mySuperTeamMembers:!!t.superTeam.name,superTeamRoamingMsgs:!!t.superTeam.name,deleteSuperTeamMsg:!!t.superTeam.name,deleteSelfMsgs:!!t.msg.name,sessionHistoryMsgsDelete:!!t.msgLog.name,avSignal:!!t.signaling.name},n.setOptions(r),n.timetags={},n.initEventListeners(),registerParser({cmdMap:qf,cmdConfig:Bf}),n}_t(SyncService,e);var t=SyncService.prototype;return t.setOptions=function setOptions(e){Et(this.config,e)},t.reset=function reset(){this.timetags={},this.syncDoneFlag=!1},t.getSyncDoneFlag=function getSyncDoneFlag(){return this.syncDoneFlag},t.doSync=function doSync(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return t=this.genSyncParams(),this.logger.log("sync::doSyncV1: ",t),n.prev=2,n.next=5,this.core.clientSocket.sendCmd("sync",{sync:t});case 5:r=n.sent,this.core.logger.log("sync::doSyncV1 done in",null===(e=r.content)||void 0===e?void 0:e.timetag),this.syncDoneFlag=!0,this.core.emit("syncdone"),n.next=17;break;case 11:return n.prev=11,n.t0=n.catch(2),this.core.logger.error("sync::doSyncV1 error",n.t0),this.syncDoneFlag=!0,this.core.emit("syncdone"),n.abrupt("return");case 17:case"end":return n.stop()}}),_callee,this,[[2,11]])})))},t.initEventListeners=function initEventListeners(){var e=this;this.core.eventBus.on("logined",(function(){e.syncDoneFlag=!1,e.doSync()})),this.core.eventBus.on("sync/updateTimetag",(function(t){var r;forEach$1(r=Nt(t)).call(r,(function(r){t[r]>(e.timetags[r]||0)&&(e.timetags[r]=t[r])}))}))},t.genSyncParams=function genSyncParams(){var e,t,r=this;return reduce(e=filter(t=Nt(this.config)).call(t,(function(e){var t=e;return r.config[t]}))).call(e,(function(e,t){var n=t;return e[n]=r.timetags[n]||0,e}),{})},t.handleImmediate=function handleImmediate(e){return this.core.session&&this.core.session.onSyncDone&&this.core.session.onSyncDone(),Pi.resolve(e)},t.delaySyncDone=function delaySyncDone(e){var t=this;return"ALI"===getMiniappEnv()?(this.core.logger.log("sync: emit ALIAPP sycnHandler, handle later"),new Pi((function(r){eo((function(){t.handleImmediate(e).then((function(){r(e)}))}),100)}))):this.handleImmediate(e)},t.syncHandler=function syncHandler(e){return this.delaySyncDone(e)},SyncService}(ku);function _createForOfIteratorHelperLoose$3(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$3(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$3(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$3(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$3(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var Gf=function(e){function UserService(t){var r;return(r=e.call(this,"user",t)||this).userInfoMap=new ic,r.myInfo=formatUser({}),registerParser({cmdMap:vf,cmdConfig:Mf}),r}_t(UserService,e);var t=UserService.prototype;return t.setBlack=function setBlack(e){var t=this;return validate({account:{type:"string",allowEmpty:!1},isAdd:{type:"boolean"}},e),this.core.sendCmd("setBlack",e).then((function(){t.core.eventBus.emit("forwardSend/user/updateBlackList",e.account,e.isAdd)}))},t.setMute=function setMute(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return validate({account:{type:"string",allowEmpty:!1},isAdd:{type:"boolean"}},e),t.next=3,this.core.sendCmd("setMute",e).then((function(){}));case 3:this.core.eventBus.emit("forwardSend/user/setMute",e.account,e.isAdd);case 4:case"end":return t.stop()}}),_callee,this)})))},t.getRelations=function getRelations(){return this.core.sendCmd("syncRelations",{timetag:0})},t.getBlackList=function getBlackList(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var e;return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.core.sendCmd("syncRelations",{timetag:0});case 2:return e=t.sent,t.abrupt("return",e.blackList||[]);case 4:case"end":return t.stop()}}),_callee2,this)})))},t.getMuteList=function getMuteList(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var e;return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.core.sendCmd("syncRelations",{timetag:0});case 2:return e=t.sent,t.abrupt("return",e.muteList||[]);case 4:case"end":return t.stop()}}),_callee3,this)})))},t.updatePushToken=function updatePushToken(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(e){for(;;)switch(e.prev=e.next){case 0:this.logger.error("This function is deprecated, please use nim.offlinePush.setOfflinePushConfig instead");case 1:case"end":return e.stop()}}),_callee4,this)})))},t.updateAppBackground=function updateAppBackground(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(e){for(;;)switch(e.prev=e.next){case 0:this.logger.error("This function is deprecated, please use nim.offlinePush.setOfflinePushConfig instead");case 1:case"end":return e.stop()}}),_callee5,this)})))},t.getUsersNameCardFromServer=function getUsersNameCardFromServer(e){var t=this;return validate({accounts:{type:"array",max:150,itemType:"string"}},e),this.core.sendCmd("getUsersNameCardFromServer",pick(e,["accounts"])).then((function(r){var n,a=r.content;return t.logger.log("user:: getUsers done",e.accounts),a&&a.users?map$6(n=a.users).call(n,(function(e){return formatUser(e)})):[]}))},t.updateMyNameCard=function updateMyNameCard(e){var t=this;if(validate({nick:{type:"string",required:!1},avatar:{type:"string",required:!1},signature:{type:"string",required:!1},gender:{type:"enum",values:getEnumKeys(Kv),required:!1},email:{type:"string",required:!1},birth:{type:"string",required:!1},tel:{type:"string",required:!1},ext:{type:"string",required:!1}},e),0===Nt(e).length)return Pi.resolve(this.myInfo);var r=pick(e,["nick","avatar","signature","email","birth","tel","ext"]);return e.gender&&(r.gender=Kv[e.gender]),this.core.sendCmd("updateMyNameCard",{user:r}).then((function(n){var a=n.content;return a&&a.timetag&&t.core.eventBus.emit("sync/updateTimetag",{myInfo:+a.timetag}),e.gender&&(r.gender=e.gender),t.myInfo=Et({},t.myInfo,r),t.core.eventBus.emit("forwardSend/user/updateUserInfo",r),t.myInfo}))},t.checkUserUpdate=function checkUserUpdate(e){var t=e.from;if(t!==this.core.account){var r=this.userInfoMap.get(t);if(r){var n=r.updateTime,a=e.userUpdateTime;!isNaN(n)&&!isNaN(a)&&"number"==typeof n&&"number"==typeof a&&n<a&&this.refreshUserInfo(t)}else this.refreshUserInfo(t)}},t.refreshUserInfo=function refreshUserInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t,r,n,a;return Dl.wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.getUsersNameCardFromServer({accounts:[e]});case 2:for(t=i.sent,r=_createForOfIteratorHelperLoose$3(t);!(n=r()).done;)a=n.value,this.userInfoMap.set(a.account,a),this.core.emit("updateUserInfo",a);case 4:case"end":return i.stop()}}),_callee6,this)})))},t.onUpdateBlackListHandler=function onUpdateBlackListHandler(e){var t=e.content;t.account?this.core.emit("updateBlackList",t):this.logger.warn("onUpdateBlackListHandler: no account")},t.onUpdateMuteListHandler=function onUpdateMuteListHandler(e){var t=e.content;t.account?this.core.emit("updateMuteList",t):this.logger.warn("onUpdateBlackListHandler: no account")},t.syncRelationsHandler=function syncRelationsHandler(e){var t=e.content,r=t.list,n=t.timetag,a={blackList:[],muteList:[]};return n&&this.core.eventBus.emit("sync/updateTimetag",{relations:n}),r&&r.length&&forEach$1(r).call(r,(function(e){var t=function formatRelationMember(e){var t={account:e.account,updateTime:+e.updateTime,createTime:+e.createTime};return"1"===e.isMuted&&(t.isMuted=!0),"1"===e.isBlack&&(t.isBlack=!0),t}(e);t.isBlack&&a.blackList.push(t),t.isMuted&&a.muteList.push(t)})),this.core.emit("relations",a),Pi.resolve(a)},t.syncMyNameCardHandler=function syncMyNameCardHandler(e){e.content.user&&(this.myInfo=formatUser(e.content.user),this.core.emit("syncMyNameCard",this.myInfo),this.core.eventBus.emit("sync/updateTimetag",{myInfo:e.content.timetag}))},t.onUpdateMyNameCardHandler=function onUpdateMyNameCardHandler(e){var t=e.content.user;t?(Et(this.myInfo,formatUser(t)),this.core.emit("updateMyNameCard",this.myInfo)):this.logger.warn("onUpdateMyNameCardHandler no user info")},UserService}(ku);var Hf={"4_12":"syncMsgReceipts","4_14":"syncSessionAck","4_20":"syncSuperTeamSessionAck","4_22":"nimSyncSessionsWithMoreRoaming","4_25":"syncSessionReliableInfo","7_12":"multiSyncMsgReceipt","7_16":"markSessionAck","7_25":"markMultSessionsAck","7_116":"syncMarkSessionAck","21_25":"markSuperTeamSessionAck","21_32":"markMultSuperTeamSessionsAck","21_125":"syncMarkSuperTeamSessionAck","4_23":"nimSyncStickTopSessions","23_12":"nimAddStickTopSession","23_13":"nimDeleteStickTopSession","23_14":"nimUpdateStickTopSession","23_112":"nimMultiSyncAddStickTopSession","23_113":"nimMultiSyncDeleteStickTopSession","23_114":"nimMultiSyncUpdateStickTopSession"},jf={msgReceiptTag:{to:1,from:2,time:7,idClient:11},stickTopSessionTag:{id:1,ext:2,createTime:3,updateTime:4},sessionAckTag:{scene:1,to:2,timetag:3},sessionReliableSyncTag:{scene:1,sessionId:2,syncStatus:3,syncEndMsgId:4,syncEndMsgidClient:5,syncEndMsgTime:6,syncStartMsgid:7,syncStartMsgidClient:8,syncStartMsgTime:9,nextMsgid:10,nextMsgidClient:11,nextMsgTime:12,roamMsgSync:13,offlineMsgSync:14,netCallOfflineMsgSync:15}},$f=invertSerializeMap(jf),zf={syncMsgReceipts:{sid:4,cid:12,service:"session",response:[{type:"PropertyArray",name:"msgReceipts",reflectMapper:$f.msgReceiptTag},{type:"Long",name:"timetag"}]},syncSessionAck:{sid:4,cid:14,service:"session",response:[{type:"StrLongMap",name:"p2p"},{type:"LongLongMap",name:"team"},{type:"Long",name:"timetag"}]},syncSuperTeamSessionAck:{sid:4,cid:20,service:"session",response:[{type:"LongLongMap",name:"superTeam"},{type:"Long",name:"timetag"}]},multiSyncMsgReceipt:{sid:7,cid:12,service:"session",response:[{type:"Property",name:"msgReceiptTag",reflectMapper:$f.msgReceiptTag}]},markSessionAck:{sid:7,cid:16,service:"session",params:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},syncMarkSessionAck:{sid:7,cid:116,service:"session",response:[{type:"Byte",name:"scene"},{type:"String",name:"to"},{type:"Long",name:"timetag"}]},syncMarkSuperTeamSessionAck:{sid:21,cid:125,service:"session",response:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]},markMultSessionsAck:{sid:7,cid:25,service:"session",ignoreErrCodes:[700],params:[{type:"PropertyArray",name:"datas",reflectMapper:jf.sessionAckTag}]},markSuperTeamSessionAck:{sid:21,cid:25,service:"session",params:[{type:"Long",name:"to"},{type:"Long",name:"timetag"}]},nimAddStickTopSession:{sid:23,cid:12,service:"session",params:[{type:"Property",name:"tag",reflectMapper:jf.stickTopSessionTag}],response:[{type:"Property",name:"data",reflectMapper:$f.stickTopSessionTag}]},nimDeleteStickTopSession:{sid:23,cid:13,service:"session",params:[{type:"Property",name:"tag",reflectMapper:jf.stickTopSessionTag}],response:[{type:"Long",name:"timetag"}]},nimUpdateStickTopSession:{sid:23,cid:14,service:"session",params:[{type:"Property",name:"tag",reflectMapper:jf.stickTopSessionTag}],response:[{type:"Property",name:"data",reflectMapper:$f.stickTopSessionTag}]},nimMultiSyncAddStickTopSession:{sid:23,cid:112,service:"session",response:[{type:"Property",name:"data",reflectMapper:$f.stickTopSessionTag}]},nimMultiSyncDeleteStickTopSession:{sid:23,cid:113,service:"session",response:[{type:"Long",name:"timetag"},{type:"Property",name:"data",reflectMapper:$f.stickTopSessionTag}]},nimMultiSyncUpdateStickTopSession:{sid:23,cid:114,service:"session",response:[{type:"Property",name:"data",reflectMapper:$f.stickTopSessionTag}]},nimSyncStickTopSessions:{sid:4,cid:23,service:"session",response:[{type:"Long",name:"timetag"},{type:"Bool",name:"isThereAnyChange"},{type:"PropertyArray",name:"datas",reflectMapper:$f.stickTopSessionTag}]},markMultSuperTeamSessionsAck:{sid:21,cid:32,service:"session",ignoreErrCodes:[700],params:[{type:"PropertyArray",name:"datas",reflectMapper:jf.sessionAckTag}]},nimSyncSessionsWithMoreRoaming:{sid:4,cid:22,service:"session",response:[]},syncSessionReliableInfo:{sid:4,cid:25,service:"session",response:[]}},Wf={id:{type:"string"},ext:{type:"string"},createTime:{type:"number"},updateTime:{type:"number"}};function formatStickTop(e,t,r){void 0===r&&(r=!0);var n=format(Wf,e);n.isStickOnTop=r,n.id=t.id,r||(n.ext="");var a=Et(Et({},t),{stickTopInfo:t.stickTopInfo?Et({},t.stickTopInfo,n):n});return void 0===a.lastMsg&&(a.lastMsg=null),a}var Kf=function(){function StickTopService(e){this.core=e}var e=StickTopService.prototype;return e.getSession=function getSession(e){return this.core.session.getSessionWithUncomplete({id:e})||this.core.session.createSession(e)},e.addStickTopSession=function addStickTopSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a,i,o;return Dl.wrap((function _callee$(s){for(;;)switch(s.prev=s.next){case 0:return validate({id:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),t=getAccountFromSessionId(e.id),r=t.scene,n=t.accid,s.next=4,this.core.sendCmd("nimAddStickTopSession",{tag:{id:("superTeam"===r?"super_team":r)+"|"+n,ext:e.ext||""}});case 4:return a=s.sent,i=this.getSession(e.id),o=formatStickTop(a.content.data,i),s.abrupt("return",o);case 8:case"end":return s.stop()}}),_callee,this)})))},e.deleteStickTopSession=function deleteStickTopSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i,o;return Dl.wrap((function _callee2$(s){for(;;)switch(s.prev=s.next){case 0:return validate({id:{type:"string",allowEmpty:!1}},e),t=getAccountFromSessionId(e.id),r=t.scene,n=t.accid,s.next=4,this.core.sendCmd("nimDeleteStickTopSession",{tag:{id:("superTeam"===r?"super_team":r)+"|"+n}});case 4:return a=s.sent,i=this.getSession(e.id),o=formatStickTop({updateTime:a.content.timetag,ext:""},i,!1),s.abrupt("return",o);case 8:case"end":return s.stop()}}),_callee2,this)})))},e.updateStickTopSession=function updateStickTopSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n,a,i,o;return Dl.wrap((function _callee3$(s){for(;;)switch(s.prev=s.next){case 0:return validate({id:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),t=getAccountFromSessionId(e.id),r=t.scene,n=t.accid,s.next=4,this.core.sendCmd("nimUpdateStickTopSession",{tag:{id:("superTeam"===r?"super_team":r)+"|"+n,ext:e.ext||""}});case 4:return a=s.sent,i=this.getSession(e.id),o=formatStickTop(a.content.data,i),s.abrupt("return",o);case 8:case"end":return s.stop()}}),_callee3,this)})))},e.stickTopSessionHandler=function stickTopSessionHandler(e,t){void 0===t&&(t=!0);var r=getAccountFromSessionId(e.id,"|"),n=r.scene+"-"+r.accid;return formatStickTop(e,this.getSession(n),t)},StickTopService}(),Yf=function(){function UnreadModuleService(e){this.core=e,this.logger=e.logger}var e=UnreadModuleService.prototype;return e.canSessionResetUnreadCount=function canSessionResetUnreadCount(e){var t=e.id;if(void 0===e.lastMsg)throw new Error("Session::canSessionResetUnreadCount: session "+t+" is not completly, lastMsg undefined");return null!==e.lastMsg||e.unread>0?!(e.ack&&e.lastMsg&&e.ack>=e.lastMsg.time)||(this.logger.log("Session::canSessionResetUnreadCount: session "+t+" reset failed, ack time is greater than last message time"),!1):(this.logger.log("Session::canSessionResetUnreadCount: session "+t+" doesn't need to be updated, lastMsg null and unread 0"),!1)},e.filterSessionForResetUnreadCount=function filterSessionForResetUnreadCount(e){var t=this,r={cmd:"markMultSuperTeamSessionsAck",params:[]},n={cmd:"markMultSessionsAck",params:[]};return forEach$1(e).call(e,(function(e){var a;try{if(!t.canSessionResetUnreadCount(e))return;var i=getAccountFromSessionId(e.id),o=i.accid,s=i.scene,c={to:o,sessionId:e.id,timetag:(null===(a=null==e?void 0:e.lastMsg)||void 0===a?void 0:a.time)||e.updateTime||0},l=function generateSceneForCmd(e){return formatReverse({scene:{type:"enum",values:ou}},e)}({scene:s});"superTeam"===s?r.params.push(c):n.params.push(Et(Et({},c),l))}catch(e){t.logger.warn(e)}})),{superTeam:r,p2pOrTeam:n}},UnreadModuleService}();function chunk(e,t){e=e||[],t=t||1,t=Math.max(Math.floor(t),1);for(var r=[],n=0;n<e.length;n+=t)r.push(slice(e).call(e,n,n+t));return r}function _createForOfIteratorHelperLoose$2(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$2(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$2(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$2(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$2(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var Qf=function(e){function SessionService(t,r){var n;return(n=e.call(this,"session",t)||this).list=new ic,n.unreadCountFilterFn=function(e){return!0},n.lastMessageFilterFn=function(e){return!0},n.initEventListeners(),registerParser({cmdMap:Hf,cmdConfig:zf}),n.stickTopService=new Kf(t),n.unreadModule=new Yf(t),r&&n.setOptions(r),n}_t(SessionService,e);var t=SessionService.prototype;return t.setOptions=function setOptions(e){"function"==typeof(null==e?void 0:e.unreadCountFilterFn)&&(this.unreadCountFilterFn=e.unreadCountFilterFn),"function"==typeof(null==e?void 0:e.lastMessageFilterFn)&&(this.lastMessageFilterFn=e.lastMessageFilterFn)},t.reset=function reset(){var e;forEach$1(e=this.list).call(e,(function(e){e.unreadMsgs=[]})),this.list.clear()},t.initEventListeners=function initEventListeners(){var e,t,r,n,a=this;this.core.eventBus.on("session/syncMsgs",bind$1(e=this.onSyncMsgs).call(e,this)),this.core.eventBus.on("session/updateForNewMsg",bind$1(t=this.updateSessionWithMsg).call(t,this)),this.core.eventBus.on("session/updateForModifyMsg",bind$1(r=this.updateSessionByModifyMsg).call(r,this)),this.core.eventBus.on("session/updateForClearMsg",(function(e,t){void 0===t&&(t=!0),e&&e.length>0&&forEach$1(e).call(e,(function(e){a.updateSession({id:e.sessionId,lastMsg:null,unread:0,unreadMsgs:[]},t)}))})),this.core.eventBus.on("session/updateForDeletedMsg",bind$1(n=this.updateSessionForDeletedMsg).call(n,this))},t.createSession=function createSession(e,t){try{var r=getAccountFromSessionId(e);return{id:e,scene:r.scene,to:r.accid,lastMsg:t,updateTime:t?t.time:0,unread:0,unreadMsgs:[],ack:0}}catch(t){throw this.logger.error("Failed to create session with "+e,t),new Error("Failed to create session with "+e)}},t.getSession=function getSession(e){validate({id:{type:"string",allowEmpty:!1}},e);var t=this.list.get(e.id);if(this.isSessionComplete(t))return t},t.getSessionWithUncomplete=function getSessionWithUncomplete(e){return this.list.get(e.id)},t.getAllSessions=function getAllSessions(){for(var e,t=[],r=_createForOfIteratorHelperLoose$2(this.list);!(e=r()).done;){var n=e.value;n[0];var a=n[1];this.isSessionComplete(a)&&t.push(a)}return t},t.getSessions=function getSessions(e){validate({limit:{type:"number",required:!1},lastSessionId:{type:"string",allowEmpty:!1,required:!1},desc:{type:"boolean",required:!1}},e);var t=[],r=e.limit,n=void 0===r?100:r,a=e.desc,i=void 0===a||a,o=e.lastSessionId,s=0;if(i){for(var c,l,d=_createForOfIteratorHelperLoose$2(this.list);!(l=d()).done;){var u=l.value,p=u[0],m=u[1];if(o===p)break;this.isSessionComplete(m)&&t.push(m)}return reverse$1(c=slice(t).call(t,-n)).call(c)}for(var h,g=_createForOfIteratorHelperLoose$2(this.list);!(h=g()).done;){var v=h.value,f=v[0],y=v[1];if(o)f===o&&(o=void 0);else if(this.isSessionComplete(y)){if(++s>n)break;t.push(y)}}return t},t.resetSessionUnreadCount=function resetSessionUnreadCount(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i,o,s,c,l,d=this;return Dl.wrap((function _callee$(u){for(;;)switch(u.prev=u.next){case 0:if(validate({id:{type:"string",allowEmpty:!1}},e),validate({id:{type:"string",allowEmpty:!1}},e),r=e.id,n=this.list.get(r)){u.next=7;break}throw this.logger.warn("resetSessionUnreadCount: can not find session "+r),new Error("Session::canSessionResetUnreadCount: can not find session "+r);case 7:a=!1;try{a=this.unreadModule.canSessionResetUnreadCount(n)}catch(e){this.logger.warn(e)}if(!1!==a){u.next=11;break}return u.abrupt("return");case 11:return i=getAccountFromSessionId(r),o=i.accid,s=i.scene,c={to:o,timetag:(null===(t=null==n?void 0:n.lastMsg)||void 0===t?void 0:t.time)||n.updateTime||0},l="markSuperTeamSessionAck","superTeam"!==s&&(c.scene="p2p"===s?0:1,l="markSessionAck"),u.abrupt("return",this.core.sendCmd(l,c).then((function(){var e=d.storeUnreadByAck(r,c.timetag);e&&d.core.emit("updateSession",e)})));case 16:case"end":return u.stop()}}),_callee,this)})))},t.resetMultiSessionUnreadCount=function resetMultiSessionUnreadCount(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i,o,s,c,l,d,u,p,m,h,g=this;return Dl.wrap((function _callee2$(v){for(;;)switch(v.prev=v.next){case 0:validate({ids:{type:"array",itemType:"string",min:1}},e),n=filter(t=map$6(r=e.ids).call(r,(function(e){return g.list.get(e)}))).call(t,(function(t,r){return!!t||(g.logger.warn("Session::canSessionResetUnreadCount: can not find session "+e.ids[r]),!1)})),a=this.unreadModule.filterSessionForResetUnreadCount(n),i=a.superTeam,o=a.p2pOrTeam,s=chunk(i.params,50),c=chunk(o.params,50),l=_createForOfIteratorHelperLoose$2(s);case 6:if((d=l()).done){v.next=13;break}return u=d.value,v.next=10,this.core.sendCmd(i.cmd,{datas:u});case 10:forEach$1(u).call(u,(function(e){var t=g.storeUnreadByAck(e.sessionId,e.timetag);t&&g.core.emit("updateSession",t)}));case 11:v.next=6;break;case 13:p=_createForOfIteratorHelperLoose$2(c);case 14:if((m=p()).done){v.next=21;break}return h=m.value,v.next=18,this.core.sendCmd(o.cmd,{datas:h});case 18:forEach$1(h).call(h,(function(e){var t=g.storeUnreadByAck(e.sessionId,e.timetag);t&&g.core.emit("updateSession",t)}));case 19:v.next=14;break;case 21:case"end":return v.stop()}}),_callee2,this)})))},t.resetAllSessionsUnreadCount=function resetAllSessionsUnreadCount(){var e,t=[];return forEach$1(e=this.list).call(e,(function(e){t.push(e.id)})),0===t.length?Pi.resolve():this.resetMultiSessionUnreadCount({ids:t})},t.deleteSession=function deleteSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:if(validate({id:{type:"string",allowEmpty:!1},isSyncToServer:{type:"boolean",required:!1}},e),this.list.delete(e.id),!this.core.msgLog||!e.isSyncToServer){t.next=5;break}return t.next=5,this.core.msgLog.deleteRoamingMsgs({ids:[e.id]});case 5:case"end":return t.stop()}}),_callee3,this)})))},t.deleteAllSessionsFromLocal=function deleteAllSessionsFromLocal(){this.list.clear()},t.addStickTopSession=function addStickTopSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.stickTopService.addStickTopSession(e);case 2:return t=r.sent,this.list.set(t.id,t),r.abrupt("return",t);case 5:case"end":return r.stop()}}),_callee4,this)})))},t.deleteStickTopSession=function deleteStickTopSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t;return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.stickTopService.deleteStickTopSession(e);case 2:return t=r.sent,this.list.set(t.id,t),r.abrupt("return",t);case 5:case"end":return r.stop()}}),_callee5,this)})))},t.updateStickTopSession=function updateStickTopSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t;return Dl.wrap((function _callee6$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.stickTopService.updateStickTopSession(e);case 2:return t=r.sent,this.list.set(t.id,t),r.abrupt("return",t);case 5:case"end":return r.stop()}}),_callee6,this)})))},t.nimMultiSyncAddStickTopSessionHandler=function nimMultiSyncAddStickTopSessionHandler(e){var t=this.stickTopService.stickTopSessionHandler(e.content.data);this.list.set(t.id,t),this.core.emit("updateSession",t)},t.nimMultiSyncDeleteStickTopSessionHandler=function nimMultiSyncDeleteStickTopSessionHandler(e){var t=this.stickTopService.stickTopSessionHandler({id:e.content.data.id,updateTime:e.content.timetag,ext:""},!1);this.list.set(t.id,t),this.core.emit("updateSession",t)},t.nimMultiSyncUpdateStickTopSessionHandler=function nimMultiSyncUpdateStickTopSessionHandler(e){var t=this.stickTopService.stickTopSessionHandler(e.content.data);this.list.set(t.id,t),this.core.emit("updateSession",t)},t.nimSyncStickTopSessionsHandler=function nimSyncStickTopSessionsHandler(e){var t,r=this;if(this.core.eventBus.emit("sync/updateTimetag",{stickTopSessions:e.content.timetag}),e.content.isThereAnyChange){var n=e.content.datas,a=[];forEach$1(t=this.list).call(t,(function(e){var t;e&&(null===(t=null==e?void 0:e.stickTopInfo)||void 0===t?void 0:t.isStickOnTop)&&a.push(e)})),forEach$1(a).call(a,(function(e){var t=e.id;if(!find(n).call(n,(function(e){var r=getAccountFromSessionId(e.id,"|");return r.scene+"-"+r.accid===t}))){var r={},a=getAccountFromSessionId(t,"-"),i=a.scene,o=a.accid;r.id=i+"|"+o,r.ext="",r.isTop=!1,n.push(r)}})),forEach$1(n).call(n,(function(e){var t;!1===e.isTop?(delete e.isTop,t=r.stickTopService.stickTopSessionHandler(e,!1)):t=r.stickTopService.stickTopSessionHandler(e),r.list.set(t.id,t)}))}},t.updateSessionWithMsg=function updateSessionWithMsg(e){var t,r,n=!0,a=!0,i="boolean"!=typeof(null===(t=e.pushInfo)||void 0===t?void 0:t.needPushBadge)||(null===(r=e.pushInfo)||void 0===r?void 0:r.needPushBadge);try{n=!!this.unreadCountFilterFn(e)}catch(e){this.logger.error("session:updateSessionWithMsg, unreadCountFilterFn error",e)}try{a=!!this.lastMessageFilterFn(e)}catch(e){this.logger.error("session:updateSessionWithMsg, lastMessageFilterFn error",e)}var o=this.list.get(e.sessionId)||this.createSession(e.sessionId),s=!1;if(this.logger.log("session:updateSessionWithMsg, pending ",e.sessionId,e.idClient,e.idServer,a,n),a&&(!o.lastMsg||o.lastMsg.time<e.time||e.status===cu[cu.sending]||o.lastMsg.status===cu[cu.sending])&&(o.lastMsg=e,o.updateTime=e.time,s=!0),n&&i&&e.status===cu[cu.unread]&&e.time>(o.ack||0)){o.unread++;var c=o.unreadMsgs||[];c.unshift(e),sort(c).call(c,(function(e,t){return t.time-e.time})),o.unreadMsgs=c,s=!0}s&&(this.logger.log("session:updateSessionWithMsg updating ",o.id,o.unread,o.lastMsg&&o.lastMsg.idClient),this.list.set(o.id,o),this.core.emit("updateSession",o))},t.updateSessionByModifyMsg=function updateSessionByModifyMsg(e){var t=this.list.get(e.sessionId)||this.createSession(e.sessionId),r=t.unreadMsgs||[],n=findIndex$1(r).call(r,(function(t){return t.idClient===e.idClient}));n>-1&&(r[n]=e),t.unreadMsgs=r,this.list.set(t.id,t);var a=!0;try{a=!!this.lastMessageFilterFn(e)}catch(e){this.logger.error("session:updateSessionByModifyMsg, lastMessageFilterFn error",e)}a&&(t.lastMsg&&t.lastMsg.idClient!==e.idClient||(t.lastMsg=e,t.updateTime=e.time,this.logger.log("session:updateSessionByModifyMsg updating ",t.id,t.unread,t.lastMsg&&t.lastMsg.idClient),this.list.set(t.id,t),this.core.emit("updateSession",t)))},t.storeUnreadByAck=function storeUnreadByAck(e,t){var r=this.list.get(e)||this.createSession(e);if(!(r.ack&&t<r.ack)){var n=r.unreadMsgs||[],a=[],i=[],o=0;return r.unreadMsgs=[],n.length>0&&(forEach$1(n).call(n,(function(e){includes(i).call(i,e.idClient)||e.time>t&&(o++,i.push(e.idClient),a.push(e))})),r.unreadMsgs=sort(a).call(a,(function(e,t){return t.time-e.time}))),r.ack=t,r.unread=o,r.lastMsg&&"unread"===r.lastMsg.status&&t>=r.lastMsg.time&&(r.lastMsg.status="read"),this.list.set(e,r),r}this.logger.warn("storeUnreadByAck: not need update ack",e,t,r.ack)},t.updateSession=function updateSession(e,t){void 0===t&&(t=!0);var r=e.id,n=this.list.get(r)||this.createSession(e.id),a=Et(n,e);return this.list.set(r,a),this.logger.log("updateSession: update",t,pick(e,["id","ack","unread"]),a.lastMsg&&a.lastMsg.idClient),t&&this.core.emit("updateSession",a),a},t.isSessionComplete=function isSessionComplete(e){return!!e&&(!!(e.id&&e.scene&&e.to)&&void 0!==e.lastMsg)},t.syncSessionAckHandler=function syncSessionAckHandler(e){var t,r,n=this,a=e.content.p2p||{},i=e.content.team.m_map||{};this.logger.log("syncSessionAck::",a,i),forEach$1(t=Nt(a)).call(t,(function(e){n.updateSession({id:"p2p-"+e,ack:a[e]},!1)})),forEach$1(r=Nt(i)).call(r,(function(e){n.updateSession({id:"team-"+e,ack:i[e]},!1)}))},t.syncSuperTeamSessionAckHandler=function syncSuperTeamSessionAckHandler(e){var t,r=this,n=e.content.superTeam.m_map;this.logger.log("syncSuperTeamSessionAck::",n),forEach$1(t=Nt(n)).call(t,(function(e){r.updateSession({id:"superTeam-"+e,ack:n[e]},!1)}))},t.syncMarkSessionAckHandler=function syncMarkSessionAckHandler(e){var t=e.content,r=(0===t.scene?"p2p":1===t.scene?"team":"superTeam")+"-"+t.to,n=this.list.get(r);if(n&&n.ack&&t.timetag<n.ack)this.logger.warn("syncMarkSessionAckHandler: "+r+" do not need update ack",n.ack,t.timetag);else{var a=this.storeUnreadByAck(r,t.timetag);a&&this.core.emit("updateSession",a)}},t.syncMarkSuperTeamSessionAckHandler=function syncMarkSuperTeamSessionAckHandler(e){e.content.scene=5,this.syncMarkSessionAckHandler(e)},t.onSyncDone=function onSyncDone(){var e,t,r,n=this,a=[];forEach$1(e=this.list).call(e,(function(e,t){a.push(n.storeUnreadByAck(t,e.ack||0))})),this.list.clear(),forEach$1(t=sort(a).call(a,(function(e,t){return e.updateTime-t.updateTime}))).call(t,(function(e){n.list.set(e.id,e)})),(a=sort(r=filter(a).call(a,(function(e){return n.isSessionComplete(e)}))).call(r,(function(e,t){return t.updateTime-e.updateTime}))).length>0&&this.core.emit("sessions",a)},t.onSyncMsgs=function onSyncMsgs(e){var t,r=this,n=this.list.get(e.sessionId),a=[];try{var i;a=filter(i=e.msgs).call(i,(function(e){var t,n,a="boolean"!=typeof(null===(t=e.pushInfo)||void 0===t?void 0:t.needPushBadge)||(null===(n=e.pushInfo)||void 0===n?void 0:n.needPushBadge);return r.unreadCountFilterFn(JSON.parse(bn(e)))&&a}))}catch(e){this.logger.error("session:onSyncMsgs, unreadCountFilterFn error ",e)}var o,s=[];try{var c;s=filter(c=e.msgs).call(c,(function(e){return r.lastMessageFilterFn(JSON.parse(bn(e)))}))}catch(e){this.logger.error("session:onSyncMsgs, lastMessageFilterFn error ",e)}s&&s.length>0&&(o=s[s.length-1],o=s[0].time>o.time?s[0]:o);var l=o?o.time:0;n||(n=o?this.createSession(e.sessionId,o):this.createSession(e.sessionId)),n.unreadMsgs=n.unreadMsgs?filter(t=concat(a).call(a,n.unreadMsgs)).call(t,(function(e){return e.status===cu[cu.unread]})):filter(a).call(a,(function(e){return e.status===cu[cu.unread]})),n.updateTime&&n.updateTime>=l||(n.updateTime=l),n.lastMsg&&n.lastMsg.time>=l||(n.lastMsg=o),this.list.set(n.id,n)},t.updateSessionForDeletedMsg=function updateSessionForDeletedMsg(e){var t,r=this,n={};forEach$1(e).call(e,(function(e){var t,a=e.to===r.core.account?e.from:e.to,i=e.scene+"-"+a,o=r.list.get(i);if(o){var s=some(t=o.unreadMsgs).call(t,(function(t){return t.idClient===e.idClient})),c=!0;try{c=!!r.unreadCountFilterFn(e)}catch(e){r.logger.error("session:updateSessionForDeletedMsg, unreadCountFilterFn error",e)}var l=o.ack||0;if(c&&s&&l<e.time&&e.from!==r.core.account&&o.unread>0&&(o.unread=o.unread-1,o.unreadMsgs&&o.unreadMsgs.length>0)){var d,u=function findIndex(e,t){e=e||[],t=t||{};for(var r=0;r<e.length;r++){var n=!0;for(var a in t)if(e[r][a]!==t[a]){n=!1;break}if(n)return r}return-1}(o.unreadMsgs,{idClient:e.idClient});u>=0&&splice(d=o.unreadMsgs).call(d,u,1)}o.lastMsg&&o.lastMsg.idClient===e.idClient&&(o.lastMsg=null),n[o.id]=!0}})),forEach$1(t=Nt(n)).call(t,(function(e){var t=r.list.get(e);t&&r.core.emit("updateSession",t)}))},t.multiSyncMsgReceiptHandler=function multiSyncMsgReceiptHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.msgReceiptTag;if(r){this.updateSessionMsgReceiptTime([r],!0),r.msgReceiptTime=r.time,r.sessionId="p2p-"+r.from,r.time,r.from;var n=__rest(r,["time","from"]);this.core.emit("msgReceipts",[n])}},t.syncMsgReceiptsHandler=function syncMsgReceiptsHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.msgReceipts;r&&this.updateSessionMsgReceiptTime(r,!1)},t.updateSessionMsgReceiptTime=function updateSessionMsgReceiptTime(e,t){var r=this;void 0===t&&(t=!0),e&&e.length>0&&forEach$1(e).call(e,(function(e){var n=r.list.get("p2p-"+e.from);n||(n=r.createSession("p2p-"+e.from));var a=bd(e.time);n.msgReceiptTime&&n.msgReceiptTime>=a||(n.msgReceiptTime=a,n.lastMsg&&"sent"===n.lastMsg.status&&a>=n.lastMsg.time&&(n.lastMsg.status="receipt"),r.logger.log("session: update session "+n.id+" msgReceiptTime: "+n.msgReceiptTime),r.list.set(n.id,n),t&&r.core.emit("updateSession",n))}))},SessionService}(ku),Jf=function(){function ModuleService(e){this.core=e}var e=ModuleService.prototype;return e.notifyAddTeamMembers=function notifyAddTeamMembers(e,t){this.core.emit("addTeamMembers",{team:e,accounts:t,members:generatorMembersByTeam(e,t)})},e.notifyUpdateTeamManagers=function notifyUpdateTeamManagers(e,t,r,n){this.core.emit("updateTeamManagers",{team:{teamId:e,memberUpdateTime:n},accounts:t,isManager:r,members:map$6(t).call(t,(function(t){return{id:e+"-"+t,account:t,type:r?"manager":"normal",updateTime:n}}))})},e.notifyRemoveTeamMembers=function notifyRemoveTeamMembers(e,t){this.core.emit("removeTeamMembers",{team:e,accounts:t})},e.notifyTransferTeam=function notifyTransferTeam(e,t,r){this.core.emit("transferTeam",{team:e,from:{id:e.teamId+"-"+t,type:"normal",account:t,updateTime:e.memberUpdateTime},to:{id:e.teamId+"-"+r,type:"owner",account:r,updateTime:e.memberUpdateTime}})},e.notifyUpdateTeamMembersMute=function notifyUpdateTeamMembersMute(e,t,r){this.core.emit("updateTeamMembersMute",{team:e,accounts:t,members:map$6(t).call(t,(function(t){return{id:e.teamId+"-"+t,account:t,teamId:e.teamId,mute:r,updateTime:e.memberUpdateTime}})),mute:r})},ModuleService}();function cloneDeep(e,t){if((t=new ic).get(e))return e;if(e instanceof RegExp)return new RegExp(e);if(e instanceof Date)return new Date(e.getTime());if(En(e))return t.set(e,!0),map$6(e).call(e,(function(e){return cloneDeep(e,t)}));if("object"==typeof e&&null!==e){var r;t.set(e,!0);var n={};return forEach$1(r=Nt(e)).call(r,(function(r){n[r]=cloneDeep(e[r],t)})),n}return e}var Xf=function(e){function TeamService(t){var r;return(r=e.call(this,"team",t)||this).myTeamMembersMap=new ic,r.service=new Jf(t),r.setListeners(),registerParser({cmdMap:pf,cmdConfig:gf}),r}_t(TeamService,e);var t=TeamService.prototype;return t.setListeners=function setListeners(){var e=this;this.core.eventBus.on("forwardReceive/team/updateMyMemberInfo",(function(t){e.emitMemberUpdate(t)})),this.core.eventBus.on("team/onNotification",(function(t){return e.notificationHandler(t)}))},t.reset=function reset(){this.myTeamMembersMap.clear()},t.mergeMyTeamMembers=function mergeMyTeamMembers(e){var t=this;forEach$1(e).call(e,(function(e){var r=e.teamId,n=t.myTeamMembersMap.get(r),a=Et({},n,e);t.myTeamMembersMap.set(r,a)}))},t.getTeamInfo=function getTeamInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),n.next=3,this.core.sendCmd("getTeamInfo",{teamId:e.teamId});case 3:return t=n.sent,r=t.content.team,n.abrupt("return",formatTeam(r));case 6:case"end":return n.stop()}}),_callee,this)})))},t.getTeams=function getTeams(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var e,t;return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.core.sendCmd("getTeams",{timetag:0});case 2:return e=r.sent,t=e.content.teams,r.abrupt("return",formatTeams(t));case 5:case"end":return r.stop()}}),_callee2,this)})))},t.getTeamsById=function getTeamsById(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r;return Dl.wrap((function _callee3$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamIds:{type:"array",itemType:"string"}},e),n.next=3,this.core.sendCmd("getTeamsById",{teamIds:e.teamIds});case 3:return t=n.sent,r=formatTeams(t.content.teams),n.abrupt("return",{teams:r,tids:t.content.tids});case 6:case"end":return n.stop()}}),_callee3,this)})))},t.createTeam=function createTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t,r,n;return Dl.wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return validate({type:{type:"enum",values:["advanced","normal"]},name:{type:"string",allowEmpty:!1},level:{type:"number",required:!1},accounts:{type:"array",itemType:"string",required:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!0,required:!1},announcement:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",allowEmpty:!0,required:!1},ext:{type:"string",allowEmpty:!0,required:!1}},e),t=generateTeam(e),a.next=4,this.core.sendCmd("createTeam",{team:t,accounts:e.accounts||[],ps:e.ps||""});case 4:return r=a.sent,n=formatTeam(r.content.team),this.core.eventBus.emit("forwardSend/team/created",n),a.abrupt("return",n);case 8:case"end":return a.stop()}}),_callee4,this)})))},t.dismissTeam=function dismissTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),t.next=3,this.core.sendCmd("dismissTeam",{teamId:e.teamId});case 3:case"end":return t.stop()}}),_callee5,this)})))},t.leaveTeam=function leaveTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),t.next=3,this.core.sendCmd("leaveTeam",{teamId:e.teamId});case 3:case"end":return t.stop()}}),_callee6,this)})))},t.transferTeam=function transferTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},leave:{type:"boolean"}},e),t.next=3,this.core.sendCmd("transferTeam",e);case 3:case"end":return t.stop()}}),_callee7,this)})))},t.updateTeamInfo=function updateTeamInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t;return Dl.wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!0,required:!1},announcement:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",allowEmpty:!0,required:!1},ext:{type:"string",allowEmpty:!0,required:!1}},e),t=generateTeam(e),r.next=4,this.core.sendCmd("updateTeamInfo",{team:t});case 4:return r.abrupt("return",formatTeam(t));case 5:case"end":return r.stop()}}),_callee8,this)})))},t.getTeamMembers=function getTeamMembers(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var r,n;return Dl.wrap((function _callee9$(a){for(;;)switch(a.prev=a.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",required:!1}},e),a.next=3,this.core.sendCmd("getTeamMembers",{teamId:e.teamId,timetag:0});case 3:if(r=a.sent,n=formatTeamMembers(null===(t=r.content)||void 0===t?void 0:t.teamMembers),e.accounts&&e.accounts.length>0){a.next=7;break}return a.abrupt("return",n);case 7:return a.abrupt("return",filter(n).call(n,(function(t){var r;return null===(r=e.accounts)||void 0===r?void 0:includes(r).call(r,t.account)})));case 8:case"end":return a.stop()}}),_callee9,this)})))},t.getMutedTeamMembers=function getMutedTeamMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var t,r;return Dl.wrap((function _callee10$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),n.next=3,this.core.sendCmd("getMutedTeamMembers",{teamId:e.teamId});case 3:return t=n.sent,r=t.content,n.abrupt("return",formatTeamMembers(r.teamMembers));case 6:case"end":return n.stop()}}),_callee10,this)})))},t.addTeamMembers=function addTeamMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),t.next=3,this.core.sendCmd("addTeamMembers",{teamId:e.teamId,accounts:e.accounts,ps:e.ps||"",attach:e.ext||""});case 3:case"end":return t.stop()}}),_callee11,this)})))},t.removeTeamMembers=function removeTeamMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){return Dl.wrap((function _callee12$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1}},e),t.next=3,this.core.sendCmd("removeTeamMembers",{teamId:e.teamId,accounts:e.accounts});case 3:case"end":return t.stop()}}),_callee12,this)})))},t.applyTeam=function applyTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var t;return Dl.wrap((function _callee13$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),r.next=3,this.core.sendCmd("applyTeam",{teamId:e.teamId,ps:e.ps||""});case 3:return t=r.sent,r.abrupt("return",formatTeam(t.content.team));case 5:case"end":return r.stop()}}),_callee13,this)})))},t.addTeamManagers=function addTeamManagers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){return Dl.wrap((function _callee14$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),t.next=3,this.core.sendCmd("addTeamManagers",e);case 3:case"end":return t.stop()}}),_callee14,this)})))},t.removeTeamManagers=function removeTeamManagers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){return Dl.wrap((function _callee15$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),t.next=3,this.core.sendCmd("removeTeamManagers",e);case 3:case"end":return t.stop()}}),_callee15,this)})))},t.updateMyMemberInfo=function updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var t,r,n;return Dl.wrap((function _callee16$(a){for(;;)switch(a.prev=a.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0,required:!1},bitConfigMask:{type:"number",min:0,max:2,required:!1},ext:{type:"string",required:!1}},e),t=generatorTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,bitConfigMask:e.bitConfigMask,ext:e.ext}),a.next=4,this.core.sendCmd("updateMyMemberInfo",{teamMember:t});case 4:return r=formatTeamMember(Et({updateTime:(new Date).getTime(),account:this.core.account},t)),n=this.emitMemberUpdate(r),this.core.eventBus.emit("forwardSend/team/updateMyMemberInfo",n),a.abrupt("return",r);case 8:case"end":return a.stop()}}),_callee16,this)})))},t.emitMemberUpdate=function emitMemberUpdate(e){e=formatTeamMember(e),this.mergeMyTeamMembers([e]),this.core.emit("updateTeamMember",e);var t=cloneDeep(this.myTeamMembersMap.get(e.teamId));return this.core.emit("myTeamMembers",[t]),t},t.updateMemberNick=function updateMemberNick(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee17(){var t,r;return Dl.wrap((function _callee17$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0}},e),t=generatorTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,account:e.account}),n.next=4,this.core.sendCmd("updateNickInTeam",{teamMember:t});case 4:return r=formatTeamMember(Et({updateTime:(new Date).getTime()},t)),n.abrupt("return",r);case 6:case"end":return n.stop()}}),_callee17,this)})))},t.muteTeamMember=function muteTeamMember(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){return Dl.wrap((function _callee18$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},mute:{type:"boolean"}},e),t.next=3,this.core.sendCmd("muteTeamMember",{teamId:e.teamId,account:e.account,mute:e.mute?1:0});case 3:case"end":return t.stop()}}),_callee18,this)})))},t.getTeamMemberInvitorAccid=function getTeamMemberInvitorAccid(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){var r,n;return Dl.wrap((function _callee19$(a){for(;;)switch(a.prev=a.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",max:200}},e),r={teamId:e.teamId},e.accounts&&e.accounts.length>0&&(r.accounts=e.accounts),a.next=5,this.core.sendCmd("getTeamMemberInvitorAccid",r);case 5:return n=a.sent,a.abrupt("return",(null===(t=n.content)||void 0===t?void 0:t.accountsMap)||{});case 7:case"end":return a.stop()}}),_callee19,this)})))},t.muteTeam=function muteTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){return Dl.wrap((function _callee20$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},mute:{type:"boolean"}},e),t.next=3,this.core.sendCmd("muteTeam",{teamId:e.teamId,mute:e.mute?1:0});case 3:case"end":return t.stop()}}),_callee20,this)})))},t.passTeamApply=function passTeamApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){var t;return Dl.wrap((function _callee21$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("passTeamApply",e);case 4:this.core.eventBus.emit("forwardSend/team/passTeamApply",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/team/passTeamApply",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee21,this,[[1,7]])})))},t.rejectTeamApply=function rejectTeamApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee22(){var t;return Dl.wrap((function _callee22$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("rejectTeamApply",{teamId:e.teamId,from:e.from,ps:e.ps||""});case 4:this.core.eventBus.emit("forwardSend/team/rejectTeamApply",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/team/rejectTeamApply",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee22,this,[[1,7]])})))},t.acceptTeamInvite=function acceptTeamInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee23(){var t;return Dl.wrap((function _callee23$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("acceptTeamInvite",e);case 4:this.core.eventBus.emit("forwardSend/team/acceptTeamInvite",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/team/acceptTeamInvite",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee23,this,[[1,7]])})))},t.rejectTeamInvite=function rejectTeamInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee24(){var t;return Dl.wrap((function _callee24$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("rejectTeamInvite",{teamId:e.teamId,from:e.from,ps:e.ps||""});case 4:this.core.eventBus.emit("forwardSend/team/rejectTeamInvite",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/team/rejectTeamInvite",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee24,this,[[1,7]])})))},t.notifyTeamMsgReceiptsHandler=function notifyTeamMsgReceiptsHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.teamMsgReceipts;r&&r.length>0&&(this.core.emit("teamMsgReceipts",r),this.core.emit("msgReceipts",r))},t.syncTeamsHandler=function syncTeamsHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{teams:bd(t.timetag)});var r=null==t?void 0:t.teams;if(r&&r.length){var n=formatTeams(r);this.core.emit("teams",n)}},t.syncCreateTeamHandler=function syncCreateTeamHandler(e){var t=e.content,r=formatTeam(null==t?void 0:t.team),n=generatorMemberByTeam(r,r.owner,"owner");this.core.emit("createTeam",r,n)},t.syncUpdateTeamMemberHandler=function syncUpdateTeamMemberHandler(e){var t=e.content,r=formatTeamMember(null==t?void 0:t.teamMember);r.updateTime||(r.updateTime=(new Date).getTime()),this.mergeMyTeamMembers([r]),this.core.emit("updateTeamMember",r);var n=cloneDeep(this.myTeamMembersMap.get(r.teamId));this.core.emit("myTeamMembers",[n])},t.syncMyTeamMembersHandler=function syncMyTeamMembersHandler(e){var t,r=e.content;this.core.eventBus.emit("sync/updateTimetag",{myTeamMembers:bd(r.timetag)});var n=null==r?void 0:map$6(t=r.teamMembers).call(t,(function(e){return formatTeamMember(e)}));this.mergeMyTeamMembers(n),this.core.emit("myTeamMembers",cloneDeep(n))},t.notificationHandler=function notificationHandler(e){var t=e.attach,r=e.scene,n=e.from,a=e.to,i=e.time,o=e.idServer,s=e.idClient,c=t.team,l=t.account,d=t.accounts,u=t.type;if("team"===r)switch(this.logger.getDebugMode()?this.logger.debug("team::recvNotification",o,s,t):this.logger.log("team::recvNotification",o,s,a,u,l,d),u){case"updateTeam":c.updateTime=i,this.core.emit("updateTeam",c);break;case"addTeamMembers":this.service.notifyAddTeamMembers(c,d);break;case"acceptTeamInvite":this.service.notifyAddTeamMembers(c,[n]);break;case"passTeamApply":this.service.notifyAddTeamMembers(c,[l]);break;case"addTeamManagers":this.service.notifyUpdateTeamManagers(a,d,!0,i);break;case"removeTeamManagers":this.service.notifyUpdateTeamManagers(a,d,!1,i);break;case"removeTeamMembers":this.service.notifyRemoveTeamMembers(c,d);break;case"leaveTeam":this.service.notifyRemoveTeamMembers(c,[n]);break;case"dismissTeam":this.core.emit("dismissTeam",{teamId:a});break;case"transferTeam":this.service.notifyTransferTeam(c,n,l);break;case"updateTeamMemberMute":this.service.notifyUpdateTeamMembersMute(c,[l],t.mute)}},TeamService}(ku),Zf={"4_6":"syncOfflineSysMsgs","4_18":"syncOfflineSysMsgs","4_19":"syncRecallMsgOfflineAndRoaming","7_3":"onSysMsg","7_7":"sendCustomSysMsg","7_14":"onRecallMsg","21_18":"onRecallMsg","21_117":"onRecallMsg","7_15":"syncRecallMsgOfflineAndRoaming","21_19":"onSysMsg","21_16":"sendSuperTeamCustomSysMsg"},ey={sysMsg:Et({time:0,type:1,to:2,from:3,content:4,attach:5,idServer:6,needSaveOffline:7,deletedIdClient:10,deletedIdServer:11,needcAntiSpam:12,antiSpamContent:13,deletedMsgCreateTime:14,deletedMsgFromNick:15,opeAccount:16,envConfig:21,callbackExt:22,isRoutable:105},Af)},ty=invertSerializeMap(ey),ry={onSysMsg:{service:"systemMessage",sid:7,cid:3,response:[{type:"Property",name:"sysMsg",reflectMapper:ty.sysMsg}]},sendCustomSysMsg:{service:"systemMessage",sid:7,cid:7,params:[{type:"Property",name:"sysMsg",reflectMapper:ey.sysMsg}]},sendSuperTeamCustomSysMsg:{service:"systemMessage",sid:21,cid:16,params:[{type:"Property",name:"sysMsg",reflectMapper:ey.sysMsg}]},sendFilterCustomSysMsg:{service:"systemMessage",sid:101,cid:7,params:[{type:"Property",name:"sysMsg",reflectMapper:ey.sysMsg}]},batchMarkRead:{service:"systemMessage",sid:4,cid:5,hasPacketResponse:!1,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]},onRecallMsg:{sid:7,cid:14,service:"systemMessage",response:[{type:"Property",name:"sysMsg",reflectMapper:ty.sysMsg}]},syncRecallMsgOfflineAndRoaming:{sid:7,cid:15,service:"systemMessage",response:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:ty.sysMsg},{type:"Long",name:"timetag"},{type:"Byte",name:"type"}]},syncOfflineSysMsgs:{sid:4,cid:9,service:"systemMessage",response:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:ty.sysMsg}]}},ny=function(e){function SystemMessageService(t){var r;return(r=e.call(this,"systemMessage",t)||this).sysMsgUnread={total:0,friend:0,msg:0,team:0,superTeam:0},r.core.eventBus.on("logined",(function(){r.initEventListeners()})),registerParser({cmdMap:Zf,cmdConfig:ry}),r}_t(SystemMessageService,e);var t=SystemMessageService.prototype;return t.initEventListeners=function initEventListeners(){var e=this;this.core.eventBus.on("systemMessage/passFriendApply",(function(t){e.core.emit("updateSystemMessages",[{idServer:t.idServer,from:t.account,state:"pass",type:"friendRequest"}])})),this.core.eventBus.on("systemMessage/rejectFriendApply",(function(t){e.core.emit("updateSystemMessages",[{idServer:t.idServer,from:t.account,state:"decline",type:"friendRequest"}])}))},t.doMarkSysMsgAck=function doMarkSysMsgAck(e){var t=[],r=[],n=["customSuperTeam"];forEach$1(e).call(e,(function(e){e.idServer&&(includes(n).call(n,e.type)?r.push(e.idServer):t.push(e.idServer))})),t.length>0&&this.core.sendCmd("batchMarkRead",{sid:"7",cid:"3",ids:t}),r.length>0&&this.core.sendCmd("batchMarkRead",{sid:"21",cid:"19",ids:r})},t.sendCustomSysMsg=function sendCustomSysMsg(e){var t=this;validate({to:{type:"string",allowEmpty:!1},type:{type:"enum",values:["customP2p","customTeam","customSuperTeam"]},attach:{type:"string",allowEmpty:!1},setting:{type:"object",rules:{needSaveOffline:{type:"boolean",required:!1},env:{type:"string",allowEmpty:!1,required:!1}},required:!1},pushInfo:{type:"object",required:!1,rules:wf}},e);var r="customSuperTeam"===e.type?"sendSuperTeamCustomSysMsg":"sendCustomSysMsg";return this.core.sendCmd(r,{sysMsg:generatorSysMsgForCmd$1(e)}).then((function(){t.logger.log("sendCustomSysMsg success")})).catch((function(e){throw t.logger.error("sendCustomSysMsg failed",e.message),e}))},t.onSysMsgHandler=function onSysMsgHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.sysMsg;if(r){var n="number"==typeof get(e,"raw.r[0]")?""+e.raw.r[0]:void 0;r.idServer=r.idServer||n;var a=formatSystemMessage(r,this.logger,Ef.default);this.core.emit("sysMsg",a),this.doMarkSysMsgAck([a])}else this.logger.warn("onSysMsg no content.sysMsg")},t.syncOfflineSysMsgsHandler=function syncOfflineSysMsgsHandler(e){var t,r=this;if(e.content.sysMsgs&&e.content.sysMsgs.length>0){var n=map$6(t=e.content.sysMsgs).call(t,(function(e){return formatSystemMessage(e,r.logger,Ef.leave)}));this.core.emit("syncSysMsgs",n),this.doMarkSysMsgAck(n)}},t.onRecallMsgHandler=function onRecallMsgHandler(e){var t,r=null===(t=e.content)||void 0===t?void 0:t.sysMsg;if(r){var n="number"==typeof get(e,"raw.r[0]")?""+e.raw.r[0]:void 0;r.idServer=r.idServer||n;var a=formatDeletedMsgs([r],getSceneFromRecallSysMsg(+r.type));this.core.eventBus.emit("session/updateForDeletedMsg",a);var i=formatSystemMessage(r,this.logger,Ef.default);this.core.emit("sysMsg",i),this.doMarkSysMsgAck([i])}else this.logger.warn("onSysMsg no content.sysMsg")},t.syncRecallMsgOfflineAndRoamingHandler=function syncRecallMsgOfflineAndRoamingHandler(e){var t=this,r=e.content,n=r.timetag,a=r.type,i=r.sysMsgs,o=bd(a),s=1===o?Ef.leave:Ef.roam,c=map$6(i).call(i,(function(e){return formatSystemMessage(e,t.logger,s)}));1===o&&this.doMarkSysMsgAck(c),this.core.eventBus.emit("sync/updateTimetag",{recallMsg:n}),this.core.emit("syncSysMsgs",c)},SystemMessageService}(ku);function reverseFriend(e){var t=["bitsExtension","createTime","updateTime","passRelationShip","relationShip","source"],r=Et({},e);return forEach$1(t).call(t,(function(e){void 0!==r[e]&&(r[e]=bd(r[e]))})),void 0!==r.relationShip&&(r.valid=1===r.relationShip),r}var ay={1:"addFriend",2:"applyFriend",3:"passFriendApply",4:"rejectFriendApply"};var iy={"12_4":"getFriends","12_1":"friendReuqest","12_2":"deleteFriend","12_3":"updateFriend","12_5":"syncFriends","12_6":"syncFriendUsers","12_101":"syncFriendRequest","12_102":"syncDeleteFriend","12_103":"syncUpdateFriend"},oy={updateFriendTag:{account:4,alias:8,ext:10},delFriendParams:{delAlias:1},friendTag:{account:4,relationShip:5,passRelationShip:6,source:7,alias:8,bitsExtension:9,ext:10,createTime:11,updateTime:12,serverex:13},userTag:{account:1,nick:3,avatar:4,sign:5,gender:6,email:7,birth:8,tel:9,ext:10,createTime:12,updateTime:13}},sy=invertSerializeMap(oy),cy={getFriends:{sid:12,cid:4,service:"friend",params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"friends",reflectMapper:sy.friendTag},{type:"Long",name:"timetag"}]},friendReuqest:{sid:12,cid:1,service:"friend",params:[{type:"String",name:"account"},{type:"Byte",name:"type"},{type:"String",name:"ps"}]},deleteFriend:{sid:12,cid:2,service:"friend",params:[{type:"String",name:"account"},{type:"Property",name:"delFriendParams",reflectMapper:oy.delFriendParams}]},updateFriend:{sid:12,cid:3,service:"friend",params:[{type:"Property",name:"updateFriendTag",reflectMapper:oy.updateFriendTag}]},syncFriends:{sid:12,cid:5,service:"friend",response:[{type:"PropertyArray",name:"friends",entity:"friendTag",reflectMapper:sy.friendTag},{type:"Long",name:"timetag"}]},syncFriendUsers:{sid:12,cid:6,service:"friend",response:[{type:"PropertyArray",name:"users",entity:"userTag",reflectMapper:sy.userTag},{type:"Long",name:"timetag"}]},syncFriendRequest:{sid:12,cid:101,service:"friend",params:[{type:"String",name:"account"},{type:"Byte",name:"type"},{type:"String",name:"ps"}],response:[{type:"String",name:"account"},{type:"Byte",name:"type"},{type:"String",name:"ps"}]},syncDeleteFriend:{sid:12,cid:102,service:"friend",response:[{type:"String",name:"account"}]},syncUpdateFriend:{sid:12,cid:103,service:"friend",response:[{type:"Property",name:"friend",reflectMapper:sy.friendTag}]}},ly=function(e){function FriendService(t){var r;return r=e.call(this,"friend",t)||this,registerParser({cmdMap:iy,cmdConfig:cy}),r}_t(FriendService,e);var t=FriendService.prototype;return t.getFriends=function getFriends(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.core.sendCmd("getFriends",{timetag:0});case 2:return t=n.sent,r=(null===(e=t.content)||void 0===e?void 0:e.friends)||[],r=map$6(r).call(r,(function(e){return reverseFriend(e)})),n.abrupt("return",r);case 6:case"end":return n.stop()}}),_callee,this)})))},t.addFriend=function addFriend(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t;return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return validate({account:{type:"string",allowEmpty:!1},ps:{type:"string",allowEmpty:!1,required:!1}},e),r.next=3,this.core.sendCmd("friendReuqest",{account:e.account,type:1,ps:e.ps||""});case 3:return t=(new Date).getTime(),this.core.eventBus.emit("forwardSend/friend/addFriend",e.account),r.abrupt("return",{account:e.account,createTime:t,updateTime:t,valid:!0,source:0,passRelationShip:1,relationShip:1,bitsExtension:0});case 6:case"end":return r.stop()}}),_callee2,this)})))},t.applyFriend=function applyFriend(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return validate({account:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("friendReuqest",{account:e.account,type:2,ps:e.ps||""});case 3:case"end":return t.stop()}}),_callee3,this)})))},t.passFriendApply=function passFriendApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t=this;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return validate({account:{type:"string",allowEmpty:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("friendReuqest",{account:e.account,type:3,ps:e.ps||""}).then((function(r){return t.core.eventBus.emit("systemMessage/passFriendApply",e),r}));case 4:this.core.eventBus.emit("forwardSend/friend/passFriendApply",e.account),r.next=11;break;case 7:throw r.prev=7,r.t0=r.catch(1),this.core.eventBus.emit("forwardSend/friend/passFriendApply",e.account,r.t0),r.t0;case 11:case"end":return r.stop()}}),_callee4,this,[[1,7]])})))},t.rejectFriendApply=function rejectFriendApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t=this;return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return validate({account:{type:"string",allowEmpty:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("friendReuqest",{account:e.account,type:4,ps:e.ps||""}).then((function(r){return t.core.eventBus.emit("systemMessage/rejectFriendApply",e),r}));case 4:this.core.eventBus.emit("forwardSend/friend/rejectFriendApply",e.account,e.ps),r.next=11;break;case 7:throw r.prev=7,r.t0=r.catch(1),this.core.eventBus.emit("forwardSend/friend/rejectFriendApply",e.account,e.ps,r.t0),r.t0;case 11:case"end":return r.stop()}}),_callee5,this,[[1,7]])})))},t.deleteFriend=function deleteFriend(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return validate({account:{type:"string",allowEmpty:!1},delAlias:{type:"boolean"}},e),t.next=3,this.core.sendCmd("deleteFriend",{account:e.account,delFriendParams:{delAlias:!0===e.delAlias?1:0}});case 3:this.core.eventBus.emit("forwardSend/friend/deleteFriend",e.account);case 4:case"end":return t.stop()}}),_callee6,this)})))},t.updateFriend=function updateFriend(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return validate({account:{type:"string",allowEmpty:!1},alias:{type:"string"},ext:{type:"string",required:!1}},e),t.next=3,this.core.sendCmd("updateFriend",{updateFriendTag:e});case 3:this.core.eventBus.emit("forwardSend/friend/updateFriend",e);case 4:case"end":return t.stop()}}),_callee7,this)})))},t.syncFriendRequestHandler=function syncFriendRequestHandler(e){var t=function formatFriendRequest(e){var t=Et({},e);try{t.ps=t.ps&&JSON.parse(t.ps)}catch(e){}if(t.type=ay[t.type],"addFriend"===t.type||"passFriendApply"===t.type){var r=(new Date).getTime();t.friend={account:e.account,alias:"",createTime:r,ext:"",updateTime:r,valid:!0}}return t}(e.content);this.core.emit("syncFriend",t)},t.syncDeleteFriendHandler=function syncDeleteFriendHandler(e){var t=e.content.account;this.logger.log("friend::emit syncFriendAction: deleteFriend "+t),this.core.emit("syncFriend",{type:"deleteFriend",account:t})},t.syncUpdateFriendHandler=function syncUpdateFriendHandler(e){var t=reverseFriend(e.content.friend);this.logger.log("friend::emit syncFriendAction: updateFriend, ",null==t?void 0:t.account),this.core.emit("syncFriend",{type:"updateFriend",friend:t})},t.syncFriendsHandler=function syncFriendsHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{friends:bd(t.timetag)});var r=null==t?void 0:t.friends;if(r&&r.length){var n=map$6(r).call(r,(function(e){return reverseFriend(e)}));this.core.emit("friends",n)}},t.syncFriendUsersHandler=function syncFriendUsersHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{friendUsers:bd(t.timetag)});var r=null==t?void 0:t.users;if(r&&r.length){var n=map$6(r).call(r,(function(e){return formatUser(e)}));this.core.emit("users",n)}},FriendService}(ku);function formatSubscribes(e){return e&&e.length>0?map$6(e).call(e,(function(e){return function formatSubscribe(e){var t=Et({},e),r=["subscribeTime","time"];return forEach$1(r).call(r,(function(e){t[e]&&(t[e]=bd(t[e]))})),t}(e)})):[]}function formatEvent(e){if(!e)return e;var t=e.serverExt,r=__rest(e,["serverExt"]),n=["time","type","value"];if(forEach$1(n).call(n,(function(e){r[e]&&(r[e]=bd(r[e]))})),r.clientType&&(r.clientType=getEnumKeyByEnumValue(su,r.clientType)||""),t)try{r.ext=JSON.parse(t),"string"==typeof r.ext[0]&&(r.ext=r.ext[0])}catch(e){}return r}var dy={"14_1":"publishEvent","14_2":"pushEvent","14_3":"subscribeEvent","14_4":"unSubscribeEventsByAccounts","14_5":"unSubscribeEventsByType","14_6":"querySubscribeEventsByAccounts","14_7":"querySubscribeEventsByType","14_9":"pushEvents"},uy={msgEvent:{type:1,value:2,idClient:3,ext:4,validTime:5,broadcastType:6,sync:7,validTimeType:8,durable:9,time:10,idServer:11,clientType:12,serverConfig:13,serverExt:14,appid:101,account:103,enableMultiClient:104,consid:106},msgEventSubscribe:{type:1,subscribeTime:2,sync:3,to:102,from:104,time:105}},py=invertSerializeMap(uy),hy={publishEvent:{sid:14,cid:1,service:"event",params:[{type:"Property",name:"msgEvent",reflectMapper:uy.msgEvent}],response:[{type:"Property",name:"msgEvent",reflectMapper:py.msgEvent}]},pushEvent:{sid:14,cid:2,service:"event",response:[{type:"Property",name:"msgEvent",reflectMapper:py.msgEvent}]},subscribeEvent:{sid:14,cid:3,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:uy.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"StrArray",name:"accounts"}]},unSubscribeEventsByAccounts:{sid:14,cid:4,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:uy.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"StrArray",name:"accounts"}]},unSubscribeEventsByType:{sid:14,cid:5,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:uy.msgEventSubscribe}]},querySubscribeEventsByAccounts:{sid:14,cid:6,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:uy.msgEventSubscribe},{type:"StrArray",name:"accounts"}],response:[{type:"PropertyArray",name:"msgEventSubscribes",reflectMapper:py.msgEventSubscribe}]},querySubscribeEventsByType:{sid:14,cid:7,service:"event",params:[{type:"Property",name:"msgEventSubscribe",reflectMapper:uy.msgEventSubscribe}],response:[{type:"PropertyArray",name:"msgEventSubscribes",reflectMapper:py.msgEventSubscribe}]},pushEvents:{sid:14,cid:9,service:"event",response:[{type:"PropertyArray",name:"msgEvents",reflectMapper:py.msgEvent}]}},gy=function(e){function EventService(t){var r;return r=e.call(this,"event",t)||this,registerParser({cmdMap:dy,cmdConfig:hy}),r}_t(EventService,e);var t=EventService.prototype;return t.publishEvent=function publishEvent(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a;return Dl.wrap((function _callee$(i){for(;;)switch(i.prev=i.next){case 0:return validate({type:{type:"number"},value:{type:"number"},ext:{type:"string",required:!1},validTime:{type:"number",min:60,max:2592e3,required:!1},broadcastType:{type:"number",required:!1},sync:{type:"boolean",required:!1}},e),r=Et(Et({validTime:e.validTime||604800,broadcastType:e.broadcastType||2},e),{idClient:ld(),sync:!0===e.sync?1:0}),i.next=4,this.core.sendCmd("publishEvent",{msgEvent:r});case 4:return n=i.sent,a=(null===(t=n.content)||void 0===t?void 0:t.msgEvent)||{},i.abrupt("return",formatEvent(a));case 7:case"end":return i.stop()}}),_callee,this)})))},t.subscribeEvent=function subscribeEvent(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n,a;return Dl.wrap((function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:return validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100},subscribeTime:{type:"number",min:60,max:2592e3,required:!1}},e),r=Et(Et({subscribeTime:2592e3},e),{sync:!0===e.sync?1:0}),i.next=4,this.core.sendCmd("subscribeEvent",{msgEventSubscribe:r,accounts:e.accounts});case 4:return n=i.sent,a=(null===(t=n.content)||void 0===t?void 0:t.accounts)||[],i.abrupt("return",{failedAccounts:a});case 7:case"end":return i.stop()}}),_callee2,this)})))},t.unSubscribeEvents=function unSubscribeEvents(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var r,n,a;return Dl.wrap((function _callee3$(i){for(;;)switch(i.prev=i.next){case 0:if(validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100,required:!1}},e),r={type:e.type},!(e.accounts&&e.accounts.length>0)){i.next=9;break}return i.next=5,this.core.sendCmd("unSubscribeEventsByAccounts",{msgEventSubscribe:r,accounts:e.accounts});case 5:a=i.sent,n=(null===(t=a.content)||void 0===t?void 0:t.accounts)||[],i.next=12;break;case 9:return i.next=11,this.core.sendCmd("unSubscribeEventsByType",{msgEventSubscribe:r});case 11:n=[];case 12:return i.abrupt("return",{failedAccounts:n});case 13:case"end":return i.stop()}}),_callee3,this)})))},t.querySubscribeEvents=function querySubscribeEvents(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var r;return Dl.wrap((function _callee4$(n){for(;;)switch(n.prev=n.next){case 0:if(validate({type:{type:"number"},accounts:{type:"array",itemType:"string",max:100,required:!1}},e),!(e.accounts&&e.accounts.length>0)){n.next=7;break}return n.next=4,this.core.sendCmd("querySubscribeEventsByAccounts",{msgEventSubscribe:{type:e.type},accounts:e.accounts});case 4:r=n.sent,n.next=10;break;case 7:return n.next=9,this.core.sendCmd("querySubscribeEventsByType",{msgEventSubscribe:{type:e.type}});case 9:r=n.sent;case 10:return n.abrupt("return",formatSubscribes(null===(t=r.content)||void 0===t?void 0:t.msgEventSubscribes));case 11:case"end":return n.stop()}}),_callee4,this)})))},t.pushEventHandler=function pushEventHandler(e){var t,r=(null===(t=e.content)||void 0===t?void 0:t.msgEvent)||{};this.core.emit("pushEvents",[formatEvent(r)])},t.pushEventsHandler=function pushEventsHandler(e){var t,r=(null===(t=e.content)||void 0===t?void 0:t.msgEvents)||{};this.core.emit("pushEvents",function formatEvents(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatEvent(e)})):[]}(r))},EventService}(ku);function generateThreadMsgsParams(e){var t={scene:ou[e.scene],from:e.threadMsgFromAccount,to:e.threadMsgToAccount,time:e.threadMsgTime,idServer:e.threadMsgIdServer},r={limit:e.limit<100?e.limit:100,beginTime:"number"==typeof e.beginTime?e.beginTime:0,reverse:!0===reverse$1(e)?1:0};return e.lastMsgId&&(r.lastMsgId=e.lastMsgId),{msg:t,threadMsgReq:r}}var vy,fy={"23_1":"getThreadMsgs","23_2":"getMsgsByIdServer"},yy={msg:xf,threadMsgReq:{beginTime:1,endTime:2,lastMsgId:3,limit:4,reverse:5},threadMsgsMeta:{total:1,lastMsgTime:2}},_y=invertSerializeMap(yy),My={getThreadMsgs:{sid:23,cid:1,service:"msgExtend",params:[{type:"Property",name:"msg",reflectMapper:yy.msg},{type:"Property",name:"threadMsgReq",reflectMapper:yy.threadMsgReq}],response:[{type:"Property",name:"threadMsg",reflectMapper:_y.msg},{type:"Property",name:"threadMsgsMeta",reflectMapper:_y.threadMsgsMeta},{type:"PropertyArray",name:"msgs",reflectMapper:_y.msg}]},getMsgsByIdServer:{sid:23,cid:2,service:"msgExtend",params:[{type:"PropertyArray",name:"reqMsgs",reflectMapper:yy.msg}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:_y.msg}]}},Iy=function(e){function MsgExtendService(t){var r;return r=e.call(this,"msgExtend",t)||this,registerParser({cmdMap:fy,cmdConfig:My}),r}_t(MsgExtendService,e);var t=MsgExtendService.prototype;return t.getThreadMsgs=function getThreadMsgs(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i,o,s,c;return Dl.wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:return validate({scene:{type:"enum",values:getEnumKeys(ou)},threadMsgFromAccount:{type:"string",allowEmpty:!1},threadMsgIdServer:{type:"string",allowEmpty:!1},threadMsgTime:{type:"number"},threadMsgToAccount:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},lastMsgId:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,max:100,required:!1},reverse:{type:"boolean",required:!1}},e),l.next=3,this.core.sendCmd("getThreadMsgs",generateThreadMsgsParams(e));case 3:return r=l.sent,n=r.content,a=n.msgs,i=n.threadMsg,o=r.content.threadMsgsMeta,s=getSessionId(i,this.core.account),c=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:s}),a=formatMsgs$1(a,c?{account:this.core.account,sessionAck:c.ack,msgReceiptTime:c.msgReceiptTime}:{account:this.core.account}),i=formatMsg$1(i,c?{account:this.core.account,sessionAck:c.ack,msgReceiptTime:c.msgReceiptTime}:{account:this.core.account}),l.abrupt("return",{msgs:a,threadMsg:i,total:bd(o.total),timetag:bd(o.lastMsgTime)});case 11:case"end":return l.stop()}}),_callee,this)})))},t.getMsgsByIdServer=function getMsgsByIdServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i=this;return Dl.wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return validate({reqMsgs:{type:"array",rules:{scene:{type:"enum",values:getEnumKeys(ou)},from:{type:"string",allowEmpty:!1},to:{type:"string",allowEmpty:!1},idServer:{type:"string",allowEmpty:!1},time:{type:"number"}},min:1,max:100}},e),o.next=3,this.core.sendCmd("getMsgsByIdServer",{reqMsgs:map$6(t=e.reqMsgs).call(t,(function(e){return Et(Et({},e),{scene:getEnumKeyByEnumValue(ou,e.scene)})}))});case 3:return n=o.sent,a=map$6(r=n.content.msgs).call(r,(function(e){var t,r=getSessionId(e,i.core.account),n=null===(t=i.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:r});return formatMsg$1(e,n?{account:i.core.account,sessionAck:n.ack,msgReceiptTime:n.msgReceiptTime}:{account:i.core.account})})),o.abrupt("return",a);case 6:case"end":return o.stop()}}),_callee2,this)})))},MsgExtendService}(ku);!function(e){e[e.ASC=1]="ASC",e[e.DESC=2]="DESC"}(vy||(vy={}));var Sy,Ty={"7_6":"getHistoryMsgs","7_9":"deleteRoamingMsgs","4_24":"syncClearServerHistoryMsgs","7_18":"clearHistoryMsgsFromServer","7_118":"multiSyncClearServerHistoryMsgs","7_26":"nimFtsCloudMsgLogsAggWithSession","7_27":"nimFtsCloudMsgLogs"},Cy={msg:xf,clearHistoryMsgsFromServerReqTag:{type:0,otherAccid:1,isDeleteRoam:2,toTid:3,isSyncSelf:4,time:6,ext:7},clearMsgsParamsWithSync:{type:0,otherAccid:1,isDeleteRoam:2,toTid:3,isSyncSelf:4,fromAccid:5,time:6,ext:7},ftsReqTag:{keyword:1,fromTime:2,toTime:3,sessionLimit:4,msglogsLimit:5,orderRule:6,p2pSessionList:7,teamSessionList:8,senderList:9,msgTypeList:10,msgSubTypeList:11}},by=invertSerializeMap(Cy),Ey={deleteRoamingMsgs:{sid:7,cid:9,service:"msgLog",params:[{type:"StrArray",name:"ids"}]},getHistoryMsgs:{sid:7,cid:6,params:[{type:"String",name:"to"},{type:"Long",name:"beginTime"},{type:"Long",name:"endTime"},{type:"Long",name:"lastMsgId"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"},{type:"LongArray",name:"msgTypes"}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:by.msg}],service:"msgLog"},clearHistoryMsgsFromServer:{sid:7,cid:18,params:[{type:"Property",name:"clearHistoryMsgsFromServerReqTag",reflectMapper:Cy.clearHistoryMsgsFromServerReqTag}],response:[{type:"Long",name:"timetag"}],service:"msgLog"},multiSyncClearServerHistoryMsgs:{sid:7,cid:118,response:[{type:"Property",name:"data",reflectMapper:by.clearMsgsParamsWithSync}],service:"msgLog"},syncClearServerHistoryMsgs:{sid:4,cid:24,service:"msgLog",response:[{type:"PropertyArray",name:"datas",reflectMapper:by.clearMsgsParamsWithSync}]},nimFtsCloudMsgLogsAggWithSession:{sid:7,cid:26,service:"msgLog",params:[{type:"Property",name:"tag",reflectMapper:Cy.ftsReqTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:by.msg}]},nimFtsCloudMsgLogs:{sid:7,cid:27,service:"msgLog",params:[{type:"Property",name:"tag",reflectMapper:Cy.ftsReqTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:by.msg}]}};!function(e){e[e.p2p=1]="p2p",e[e.team=2]="team"}(Sy||(Sy={}));var Ry={type:{type:"enum",values:Sy},isDeleteRoam:{type:"boolean"},isSyncSelf:{type:"boolean"},time:{type:"number"}};function formatClearResult(e){var t=format(Ry,e);return{sessionId:"p2p"===t.type?"p2p-"+t.otherAccid:"team-"+t.toTid,time:t.time}}var ky={orderRule:{type:"enum",values:vy}};function generateFtsTagForCmd(e){var t,r=format(ky,e);En(r.msgTypeList)&&(r.msgTypeList=map$6(t=r.msgTypeList).call(t,(function(e){return iu[e]})).join(","));var n=["p2pSessionList","teamSessionList","senderList","msgSubTypeList"];return forEach$1(n).call(n,(function(e){En(r[e])&&(r[e]=r[e].join(","))})),r}var wy=function(e){function MsgLogService(t){var r;return(r=e.call(this,"msgLog",t)||this).onV2ClearHistoryMessage=function(e){var t=formatClearResult(e);r.core.eventBus.emit("session/updateForClearMsg",[t],!0)},registerParser({cmdMap:Ty,cmdConfig:Ey}),r.registerListener(),r}_t(MsgLogService,e);var t=MsgLogService.prototype;return t.registerListener=function registerListener(){this.core.eventBus.on("forwardReceive/msgLog/clearHistoryMsgsFromServer",this.onV2ClearHistoryMessage)},t.deleteRoamingMsgs=function deleteRoamingMsgs(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:validate({ids:{type:"array",itemType:"string"}},e),t=[],n.prev=2,t=map$6(r=e.ids).call(r,(function(e){var t=getAccountFromSessionId(e);return t.scene+"|"+t.accid})),n.next=10;break;case 6:throw n.prev=6,n.t0=n.catch(2),this.logger.error("Failed to delete roaming msgs with "+e.ids,n.t0),new Error("Failed to create session with "+e.ids);case 10:return n.next=12,this.core.sendCmd("deleteRoamingMsgs",{ids:t});case 12:case"end":return n.stop()}}),_callee,this,[[2,6]])})))},t.getHistoryMsgs=function getHistoryMsgs(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var n,a,i,o,s,c,l;return Dl.wrap((function _callee2$(d){for(;;)switch(d.prev=d.next){case 0:return"function"!=typeof(null===(t=this.core.sync)||void 0===t?void 0:t.getSyncDoneFlag)||this.core.sync.getSyncDoneFlag()||this.logger.warn("Please call getHistoryMsgs after syncdone event"),validate({scene:{type:"enum",values:getEnumKeys(ou)},to:{type:"string",allowEmpty:!1},beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},limit:{type:"number",min:1,max:100,required:!1},reverse:{type:"boolean",required:!1},lastMsgId:{type:"string",required:!1,allowEmpty:!1},asc:{type:"boolean",required:!1},msgTypes:{type:"array",itemType:"string",required:!1}},e),a="p2p"===e.scene?"getHistoryMsgs":"team"===e.scene?"getHistoryTeamMsgs":"getHistorySuperTeamMsgs",d.next=5,this.core.sendCmd(a,assignOptions({beginTime:0,endTime:0,lastMsgId:0,limit:100,reverse:!1},Et(Et({},e),{msgTypes:e.msgTypes?map$6(n=e.msgTypes).call(n,(function(e){return iu[e]})):[]})));case 5:if(i=d.sent,(o=i.content).msgs&&o.msgs.length>0){d.next=9;break}return d.abrupt("return",[]);case 9:if(s=getSessionId(o.msgs[0],this.core.account),c=null===(r=this.core.session)||void 0===r?void 0:r.getSessionWithUncomplete({id:s}),l=formatMsgs$1(o.msgs,c?{account:this.core.account,sessionAck:c.ack,msgReceiptTime:c.msgReceiptTime}:{account:this.core.account}),!0!==e.asc){d.next=14;break}return d.abrupt("return",sort(l).call(l,(function(e,t){return e.time-t.time})));case 14:return d.abrupt("return",l);case 15:case"end":return d.stop()}}),_callee2,this)})))},t.clearHistoryMsgsFromServer=function clearHistoryMsgsFromServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return validate({scene:{type:"enum",values:["p2p","team"]},to:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1},isSyncSelf:{type:"boolean",required:!1}},e),(t=Et(Et({isDeleteRoam:1},e),{type:"team"===e.scene?2:1,isSyncSelf:!0===e.isSyncSelf?1:0}))[2===t.type?"toTid":"otherAccid"]=e.to,a.next=5,this.core.sendCmd("clearHistoryMsgsFromServer",{clearHistoryMsgsFromServerReqTag:t});case 5:return r=a.sent,n=r.content,this.core.eventBus.emit("session/updateForClearMsg",[{sessionId:e.scene+"-"+e.to}],!0),this.core.eventBus.emit("forwardSend/msgLog/clearHistoryMsgsFromServer",Et(Et({},t),{time:n.timetag})),a.abrupt("return",n);case 10:case"end":return a.stop()}}),_callee3,this)})))},t.multiSyncClearServerHistoryMsgsHandler=function multiSyncClearServerHistoryMsgsHandler(e){var t=formatClearResult(e.content.data);this.core.eventBus.emit("session/updateForClearMsg",[t],!0),this.core.emit("clearServerHistoryMsgs",[t])},t.ftsCloudMsgLogs=function ftsCloudMsgLogs(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.baseFtsCloudMsgLogs(e,"nimFtsCloudMsgLogs"));case 1:case"end":return t.stop()}}),_callee4,this)})))},t.ftsCloudMsgLogsAggWithSession=function ftsCloudMsgLogsAggWithSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.baseFtsCloudMsgLogs(e,"nimFtsCloudMsgLogsAggWithSession"));case 1:case"end":return t.stop()}}),_callee5,this)})))},t.baseFtsCloudMsgLogs=function baseFtsCloudMsgLogs(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var r,n,a,i=this;return Dl.wrap((function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:if(validate({keyword:{type:"string",allowEmpty:!1},fromTime:{type:"number",required:!1},toTime:{type:"number",required:!1},sessionLimit:{type:"number",required:!1},msglogsLimit:{type:"number",required:!1},orderRule:{type:"enum",values:getEnumKeys(vy),required:!1},p2pSessionList:{type:"array",itemType:"string",required:!1},teamSessionList:{type:"array",itemType:"string",required:!1},senderList:{type:"array",itemType:"string",required:!1},msgTypeList:{type:"array",itemType:"enum",values:getEnumKeys(iu),required:!1},msgSubTypeList:{type:"array",itemType:"number",required:!1}},e),!(e.fromTime&&e.toTime&&e.toTime<e.fromTime)){o.next=3;break}throw new Tl("Request parameter error: toTime should be greater than fromTime",e,"");case 3:return n=generateFtsTagForCmd(e),o.next=6,this.core.sendCmd(t,{tag:n});case 6:return a=o.sent,o.abrupt("return",map$6(r=a.content.datas).call(r,(function(e){var t,r=getSessionId(e,i.core.account),n=null===(t=i.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:r});return formatMsg$1(e,n?{account:i.core.account,sessionAck:n.ack,msgReceiptTime:n.msgReceiptTime}:{account:i.core.account})})));case 8:case"end":return o.stop()}}),_callee6,this)})))},t.syncClearServerHistoryMsgsHandler=function syncClearServerHistoryMsgsHandler(e){var t=function formatClearResults(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatClearResult(e)})):[]}(e.content.datas);this.core.emit("clearServerHistoryMsgs",t)},MsgLogService}(ku),Ay={"22_1":"requestProxy","22_2":"onRequestProxy"},Ny={requestProxyTag:{zone:1,path:2,method:3,header:4,body:5},requestProxyMsgTag:{from:1,body:2,time:3}},xy=invertSerializeMap(Ny),Oy={requestProxy:{sid:22,cid:1,service:"passThrough",params:[{type:"Property",name:"requestProxyTag",reflectMapper:Ny.requestProxyTag}],response:[{type:"Property",name:"requestProxyTag",reflectMapper:xy.requestProxyTag}]},onRequestProxy:{sid:22,cid:2,service:"passThrough",response:[{type:"Property",name:"proxyMsg",reflectMapper:xy.requestProxyMsgTag}]}},Py=function(e){function PassThroughService(t){var r;return(r=e.call(this,"passThrough",t)||this).core=t,registerParser({cmdMap:Ay,cmdConfig:Oy}),r}_t(PassThroughService,e);var t=PassThroughService.prototype;return t.request=function request(e){return validate({path:{type:"string",allowEmpty:!1}},e),this.core.sendCmd("requestProxy",{requestProxyTag:e}).then((function(e){return e.content.requestProxyTag}))},t.onRequestProxyHandler=function onRequestProxyHandler(e){var t=e.content.proxyMsg;t&&t.time&&(t.time=+t.time),this.core.emit("proxyMsg",t)},PassThroughService}(ku),Ly=invert({none:0,normal:1,all:3}),Vy=invert({normal:0,advanced:1}),Uy=invert({normal:0,owner:1,manager:2}),Dy={noVerify:0,needVerify:1,rejectAll:2},qy=invert(Dy),By={needVerify:0,noVerify:1},Fy=invert(By),Gy={manager:0,all:1},Hy=invert(Gy),jy={manager:0,all:1},$y=invert(jy),zy={manager:0,all:1},Wy=invert(zy);function formatSuperTeam(e){var t,r=["teamId"],n=["level","memberNum","memberUpdateTime","createTime","updateTime"],a=["valid","validToCurrentUser","mute"],i={type:Vy,muteType:Ly,joinMode:qy,beInviteMode:Fy,inviteMode:Hy,updateTeamMode:$y,updateExtMode:Wy};e.bits;var o=__rest(e,["bits"]);return forEach$1(r).call(r,(function(e){o[e]&&(o[e]=o[e].toString())})),forEach$1(n).call(n,(function(e){void 0!==o[e]&&(o[e]=bd(o[e]))})),forEach$1(a).call(a,(function(e){void 0!==o[e]&&(o[e]=1===bd(o[e]))})),forEach$1(t=Nt(i)).call(t,(function(e){void 0!==o[e]&&(o[e]=i[e][o[e]]||o[e])})),o}function formatSuperTeams(e){return e&&e.length>0?map$6(e).call(e,(function(e){return formatSuperTeam(e)})):[]}function generateSuperTeam(e){var t,r=Et({},e),n=["avatar","name","intro","announcement","ext"],a={joinMode:Dy,beInviteMode:By,inviteMode:Gy,updateTeamMode:jy,updateExtMode:zy};return forEach$1(n).call(n,(function(e){void 0!==r[e]&&(r[e]=r[e].toString())})),forEach$1(t=Nt(a)).call(t,(function(e){void 0!==r[e]&&(r[e]=a[e][r[e]])})),r}function generatorSuperTeamMemberForCmd(e){var t=["teamId","ext","account","nickInTeam"],r={};return void 0!==e.bitConfigMask&&(r.bits=bd(e.bitConfigMask)),forEach$1(t).call(t,(function(t){e[t]&&(r[t]=e[t].toString())})),Object.prototype.hasOwnProperty.call(e,"nickInTeam")&&(r.nickInTeam=e.nickInTeam),r}function formatSuperTeamMember(e){var t,r=["teamId"],n=["joinTime","updateTime","bitConfigMask"],a=["active","valid","mute"],i={type:Uy},o=e.bits,s=__rest(e,["bits"]);return void 0!==o&&(s.muteTeam=1===bd(o),s.bitConfigMask=o),s.id=s.teamId+"-"+s.account,forEach$1(r).call(r,(function(e){s[e]&&(s[e]=s[e].toString())})),forEach$1(n).call(n,(function(e){void 0!==s[e]&&(s[e]=bd(s[e]))})),forEach$1(a).call(a,(function(e){void 0!==s[e]&&(s[e]=1===bd(s[e]))})),forEach$1(t=Nt(i)).call(t,(function(e){void 0!==s[e]&&(s[e]=i[e][s[e]]||s[e])})),s}function formatSuperTeamMembers(e){return e&&e.length>0?map$6(e).call(e,(function(e){return formatSuperTeamMember(e)})):[]}function generatorMemberBySuperTeam(e,t,r){return void 0===r&&(r="normal"),{id:e.teamId+"-"+t,teamId:e.teamId,account:t,type:r,nickInTeam:"",muteTeam:!1,mute:!1,joinTime:e.memberUpdateTime,updateTime:e.memberUpdateTime,active:!0,valid:!0}}function generatorMembersBySuperTeam(e,t,r){return void 0===r&&(r="normal"),t&&t.length>0?map$6(t).call(t,(function(t){return generatorMemberBySuperTeam(e,t,r)})):[]}var Ky=function(){function ModuleService(e){this.core=e}var e=ModuleService.prototype;return e.notifyAddSuperTeamMembers=function notifyAddSuperTeamMembers(e,t){this.core.emit("addSuperTeamMembers",{team:e,accounts:t,members:generatorMembersBySuperTeam(e,t)})},e.notifyUpdateSuperTeamManagers=function notifyUpdateSuperTeamManagers(e,t,r,n){this.core.emit("updateSuperTeamManagers",{team:{teamId:e,memberUpdateTime:n},accounts:t,isManager:r,members:map$6(t).call(t,(function(t){return{id:e+"-"+t,type:r?"manager":"normal",account:t,updateTime:n}}))})},e.notifyRemoveSuperTeamMembers=function notifyRemoveSuperTeamMembers(e,t){this.core.emit("removeSuperTeamMembers",{team:e,accounts:t})},e.notifyTransferSuperTeam=function notifyTransferSuperTeam(e,t,r){this.core.emit("transferSuperTeam",{team:e,from:{id:e.teamId+"-"+t,account:t,type:"normal",updateTime:e.memberUpdateTime},to:{id:e.teamId+"-"+r,account:r,type:"owner",updateTime:e.memberUpdateTime}})},e.notifyUpdateSuperTeamMembersMute=function notifyUpdateSuperTeamMembersMute(e,t,r){this.core.emit("updateSuperTeamMembersMute",{team:e,accounts:t,members:map$6(t).call(t,(function(t){return{id:e.teamId+"-"+t,account:t,teamId:e.teamId,mute:r,updateTime:e.memberUpdateTime}})),mute:r})},ModuleService}(),Yy={"21_5":"addSuperTeamMembers","21_6":"removeSuperTeamMembers","21_7":"leaveSuperTeam","21_8":"updateSuperTeamInfo","21_9":"getSuperTeamInfo","21_12":"getSuperTeams","21_15":"getSuperTeamMembers","21_10":"updateMySuperTeamMemberInfo","21_20":"applySuperTeam","21_21":"passSuperTeamApply","21_22":"rejectSuperTeamApply","21_23":"acceptSuperTeamInvite","21_24":"rejectSuperTeamInvite","21_26":"addSuperTeamManagers","21_27":"removeSuperTeamManagers","21_28":"muteSuperTeam","21_29":"muteSuperTeamMembers","21_30":"updateSuperTeamMemberNick","21_31":"transferSuperTeam","21_33":"getSuperTeamMembersByAccounts","21_34":"queryMuteSuperTeamMembers","21_101":"syncCreateSuperTeam","21_109":"syncSuperTeams","21_110":"syncUpdateSuperTeamMember","21_111":"syncMySuperTeamMembers"},Qy={superTeam:{teamId:1,name:3,type:4,owner:5,level:6,selfCustom:7,valid:8,memberNum:9,memberUpdateTime:10,createTime:11,updateTime:12,validToCurrentUser:13,intro:14,announcement:15,joinMode:16,bits:17,ext:18,serverExt:19,avatar:20,beInviteMode:21,inviteMode:22,updateTeamMode:23,updateExtMode:24,mute:100,muteType:101},superTeamMember:{teamId:1,account:3,type:4,nickInTeam:5,bits:7,active:8,valid:9,updateTime:11,ext:12,mute:13,invitorAccid:14,joinTime:15}},Jy=invertSerializeMap(Qy),Xy={getSuperTeamInfo:{sid:21,cid:9,service:"superTeam",params:[{type:"Long",name:"teamId"}],response:[{type:"Property",name:"superTeam",reflectMapper:Jy.superTeam}]},getSuperTeams:{sid:21,cid:12,service:"superTeam",params:[{type:"Long",name:"timetag"}],response:[{type:"PropertyArray",name:"superTeams",reflectMapper:Jy.superTeam},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},updateSuperTeamInfo:{sid:21,cid:8,service:"superTeam",params:[{type:"Property",name:"superTeam",reflectMapper:Qy.superTeam}],response:[{type:"Long",name:"time"}]},addSuperTeamMembers:{sid:21,cid:5,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"String",name:"ps"}],response:[{type:"StrArray",name:"abortedAccidList"},{type:"Long",name:"time"}]},removeSuperTeamMembers:{sid:21,cid:6,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},addSuperTeamManagers:{sid:21,cid:26,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},removeSuperTeamManagers:{sid:21,cid:27,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"}]},applySuperTeam:{sid:21,cid:20,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"ps"}],response:[{type:"Property",name:"superTeam",reflectMapper:Jy.superTeam}]},transferSuperTeam:{sid:21,cid:31,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"account"},{type:"Bool",name:"leave"}]},muteSuperTeam:{sid:21,cid:28,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Int",name:"mute"}]},muteSuperTeamMembers:{sid:21,cid:29,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"StrArray",name:"accounts"},{type:"Int",name:"mute"}]},updateSuperTeamMemberNick:{sid:21,cid:30,service:"superTeam",params:[{type:"Property",name:"teamMember",reflectMapper:Qy.superTeamMember}]},updateMySuperTeamMemberInfo:{sid:21,cid:10,service:"superTeam",params:[{type:"Property",name:"teamMember",reflectMapper:Qy.superTeamMember}]},getSuperTeamMembersByAccounts:{sid:21,cid:33,service:"superTeam",params:[{type:"StrArray",name:"memberIds"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Jy.superTeamMember}]},getSuperTeamMembers:{sid:21,cid:15,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Long",name:"joinTime"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Jy.superTeamMember}]},queryMuteSuperTeamMembers:{sid:21,cid:34,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"Long",name:"joinTime"},{type:"Int",name:"limit"},{type:"Bool",name:"reverse"}],response:[{type:"PropertyArray",name:"superTeamMembers",reflectMapper:Jy.superTeamMember}]},leaveSuperTeam:{sid:21,cid:7,service:"superTeam",params:[{type:"Long",name:"teamId"}]},passSuperTeamApply:{sid:21,cid:21,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectSuperTeamApply:{sid:21,cid:22,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},acceptSuperTeamInvite:{sid:21,cid:23,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"}]},rejectSuperTeamInvite:{sid:21,cid:24,service:"superTeam",params:[{type:"Long",name:"teamId"},{type:"String",name:"from"},{type:"String",name:"ps"}]},syncSuperTeams:{sid:21,cid:109,service:"superTeam",response:[{type:"PropertyArray",name:"teams",reflectMapper:Jy.superTeam},{type:"Bool",name:"isAll"},{type:"Long",name:"timetag"}]},syncCreateSuperTeam:{sid:21,cid:101,service:"superTeam",response:[{type:"Property",name:"superTeam",reflectMapper:Jy.superTeam}]},syncUpdateSuperTeamMember:{sid:21,cid:110,service:"superTeam",response:[{type:"Property",name:"teamMember",reflectMapper:Jy.superTeamMember}]},syncMySuperTeamMembers:{sid:21,cid:111,ext:"sync",service:"superTeam",response:[{type:"PropertyArray",name:"teamMembers",reflectMapper:Jy.superTeamMember},{type:"Long",name:"timetag"}]}},Zy=function(e){function SuperTeamService(t){var r;return(r=e.call(this,"superTeam",t)||this).mySuperTeamMembersMap=new ic,r.service=new Ky(t),registerParser({cmdMap:Yy,cmdConfig:Xy}),r.setListeners(),r}_t(SuperTeamService,e);var t=SuperTeamService.prototype;return t.setListeners=function setListeners(){var e=this;this.core.eventBus.on("forwardReceive/superTeam/updateMyMemberInfo",(function(t){e.emitMemberUpdate(t)})),this.core.eventBus.on("team/onNotification",(function(t){return e.notificationHandler(t)}))},t.reset=function reset(){this.mySuperTeamMembersMap.clear()},t.mergeMySuperTeamMembers=function mergeMySuperTeamMembers(e){var t=this;forEach$1(e).call(e,(function(e){var r=e.teamId,n=t.mySuperTeamMembersMap.get(r),a=Et({},n,e);t.mySuperTeamMembersMap.set(r,a)}))},t.getSuperTeamInfo=function getSuperTeamInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),n.next=3,this.core.sendCmd("getSuperTeamInfo",{teamId:e.teamId});case 3:return t=n.sent,r=t.content.superTeam,n.abrupt("return",formatSuperTeam(r));case 6:case"end":return n.stop()}}),_callee,this)})))},t.getSuperTeams=function getSuperTeams(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var e,t;return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.core.sendCmd("getSuperTeams",{timetag:0});case 2:return e=r.sent,t=e.content.superTeams,r.abrupt("return",formatSuperTeams(t));case 5:case"end":return r.stop()}}),_callee2,this)})))},t.updateSuperTeamInfo=function updateSuperTeamInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},name:{type:"string",allowEmpty:!1,required:!1},joinMode:{type:"enum",values:["noVerify","needVerify","rejectAll"],required:!1},beInviteMode:{type:"enum",values:["noVerify","needVerify"],required:!1},inviteMode:{type:"enum",values:["manager","all"],required:!1},updateTeamMode:{type:"enum",values:["manager","all"],required:!1},updateExtMode:{type:"enum",values:["manager","all"],required:!1},intro:{type:"string",allowEmpty:!0,required:!1},announcement:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",allowEmpty:!0,required:!1},ext:{type:"string",allowEmpty:!0,required:!1}},e),t=generateSuperTeam(e),r.next=4,this.core.sendCmd("updateSuperTeamInfo",{superTeam:t});case 4:return r.abrupt("return",formatSuperTeam(t));case 5:case"end":return r.stop()}}),_callee3,this)})))},t.addSuperTeamMembers=function addSuperTeamMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),t.next=3,this.core.sendCmd("addSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts,ps:e.ps||"",attach:e.ext||""});case 3:case"end":return t.stop()}}),_callee4,this)})))},t.removeSuperTeamMembers=function removeSuperTeamMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",min:1}},e),t.next=3,this.core.sendCmd("removeSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts});case 3:case"end":return t.stop()}}),_callee5,this)})))},t.addSuperTeamManagers=function addSuperTeamManagers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),t.next=3,this.core.sendCmd("addSuperTeamManagers",e);case 3:case"end":return t.stop()}}),_callee6,this)})))},t.removeSuperTeamManagers=function removeSuperTeamManagers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",min:1,itemType:"string"}},e),t.next=3,this.core.sendCmd("removeSuperTeamManagers",e);case 3:case"end":return t.stop()}}),_callee7,this)})))},t.applySuperTeam=function applySuperTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t;return Dl.wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},ps:{type:"string",allowEmpty:!0,max:5e3,required:!1}},e),r.next=3,this.core.sendCmd("applySuperTeam",{teamId:e.teamId,ps:e.ps||""});case 3:return t=r.sent,r.abrupt("return",formatSuperTeam(t.content.superTeam));case 5:case"end":return r.stop()}}),_callee8,this)})))},t.transferSuperTeam=function transferSuperTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){return Dl.wrap((function _callee9$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},leave:{type:"boolean"}},e),t.next=3,this.core.sendCmd("transferSuperTeam",e);case 3:case"end":return t.stop()}}),_callee9,this)})))},t.muteSuperTeam=function muteSuperTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){return Dl.wrap((function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},mute:{type:"boolean"}},e),t.next=3,this.core.sendCmd("muteSuperTeam",{teamId:e.teamId,mute:e.mute?1:0});case 3:case"end":return t.stop()}}),_callee10,this)})))},t.muteSuperTeamMembers=function muteSuperTeamMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string"},mute:{type:"boolean"}},e),t.next=3,this.core.sendCmd("muteSuperTeamMembers",{teamId:e.teamId,accounts:e.accounts,mute:e.mute?1:0});case 3:case"end":return t.stop()}}),_callee11,this)})))},t.updateMemberNick=function updateMemberNick(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t,r;return Dl.wrap((function _callee12$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},account:{type:"string",allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0}},e),t=generatorSuperTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,account:e.account}),n.next=4,this.core.sendCmd("updateSuperTeamMemberNick",{teamMember:t});case 4:return r=formatSuperTeamMember(Et({updateTime:(new Date).getTime()},t)),n.abrupt("return",r);case 6:case"end":return n.stop()}}),_callee12,this)})))},t.updateMyMemberInfo=function updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var t,r,n;return Dl.wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},nickInTeam:{type:"string",allowEmpty:!0,required:!1},bitConfigMask:{type:"number",min:0,max:2,required:!1},ext:{type:"string",required:!1}},e),t=generatorSuperTeamMemberForCmd({teamId:e.teamId,nickInTeam:e.nickInTeam,bitConfigMask:e.bitConfigMask,ext:e.ext}),a.next=4,this.core.sendCmd("updateMySuperTeamMemberInfo",{teamMember:t});case 4:return r=formatSuperTeamMember(Et({updateTime:(new Date).getTime(),account:this.core.account},t)),n=this.emitMemberUpdate(r),this.core.eventBus.emit("forwardSend/superTeam/updateMyMemberInfo",n),a.abrupt("return",r);case 8:case"end":return a.stop()}}),_callee13,this)})))},t.getSuperTeamMembersByAccounts=function getSuperTeamMembersByAccounts(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var r,n,a;return Dl.wrap((function _callee14$(i){for(;;)switch(i.prev=i.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},accounts:{type:"array",itemType:"string",max:20,min:1}},e),n=map$6(r=e.accounts).call(r,(function(t){return e.teamId+"|"+t})),i.next=4,this.core.sendCmd("getSuperTeamMembersByAccounts",{memberIds:n});case 4:return a=i.sent,i.abrupt("return",formatSuperTeamMembers(null===(t=a.content)||void 0===t?void 0:t.superTeamMembers));case 6:case"end":return i.stop()}}),_callee14,this)})))},t.getSuperTeamMembers=function getSuperTeamMembers(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){var r;return Dl.wrap((function _callee15$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,max:1e3,required:!1},reverse:{type:"boolean",required:!1}},e),n.next=3,this.core.sendCmd("getSuperTeamMembers",Et({joinTime:0,limit:100,reverse:!1},e));case 3:return r=n.sent,n.abrupt("return",formatSuperTeamMembers(null===(t=r.content)||void 0===t?void 0:t.superTeamMembers));case 5:case"end":return n.stop()}}),_callee15,this)})))},t.queryMuteMembers=function queryMuteMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var t,r;return Dl.wrap((function _callee16$(n){for(;;)switch(n.prev=n.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},joinTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1},reverse:{type:"boolean",required:!1}},e),n.next=3,this.core.sendCmd("queryMuteSuperTeamMembers",Et({limit:100,joinTime:0,reverse:!1},e));case 3:return t=n.sent,r=t.content,n.abrupt("return",formatSuperTeamMembers(r.superTeamMembers));case 6:case"end":return n.stop()}}),_callee16,this)})))},t.leaveSuperTeam=function leaveSuperTeam(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee17(){return Dl.wrap((function _callee17$(t){for(;;)switch(t.prev=t.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1}},e),t.next=3,this.core.sendCmd("leaveSuperTeam",{teamId:e.teamId});case 3:case"end":return t.stop()}}),_callee17,this)})))},t.passSuperTeamApply=function passSuperTeamApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){var t;return Dl.wrap((function _callee18$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("passSuperTeamApply",e);case 4:this.core.eventBus.emit("forwardSend/superTeam/passTeamApply",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/superTeam/passTeamApply",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee18,this,[[1,7]])})))},t.rejectSuperTeamApply=function rejectSuperTeamApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){var t;return Dl.wrap((function _callee19$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("rejectSuperTeamApply",{teamId:e.teamId,from:e.from,ps:e.ps||""});case 4:this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamApply",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamApply",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee19,this,[[1,7]])})))},t.acceptSuperTeamInvite=function acceptSuperTeamInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){var t;return Dl.wrap((function _callee20$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("acceptSuperTeamInvite",e);case 4:this.core.eventBus.emit("forwardSend/superTeam/acceptSuperTeamInvite",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/superTeam/acceptSuperTeamInvite",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee20,this,[[1,7]])})))},t.rejectSuperTeamInvite=function rejectSuperTeamInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){var t;return Dl.wrap((function _callee21$(r){for(;;)switch(r.prev=r.next){case 0:return validate({teamId:{type:"string",regExp:/\d+/,allowEmpty:!1},from:{type:"string",allowEmpty:!1},ps:{type:"string",max:5e3,required:!1}},e),r.prev=1,r.next=4,this.core.sendCmd("rejectSuperTeamInvite",{teamId:e.teamId,from:e.from,ps:e.ps||""});case 4:this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamInvite",e),r.next=12;break;case 7:throw r.prev=7,r.t0=r.catch(1),t=r.t0,this.core.eventBus.emit("forwardSend/superTeam/rejectSuperTeamInvite",e,null==t?void 0:t.code),r.t0;case 12:case"end":return r.stop()}}),_callee21,this,[[1,7]])})))},t.emitMemberUpdate=function emitMemberUpdate(e){e=formatSuperTeamMember(e),this.mergeMyTeamMembers([e]),this.core.emit("updateTeamMember",e);var t=cloneDeep(this.mySuperTeamMembersMap.get(e.teamId));return this.core.emit("myTeamMembers",[t]),t},t.mergeMyTeamMembers=function mergeMyTeamMembers(e){var t=this;forEach$1(e).call(e,(function(e){var r=e.teamId,n=t.mySuperTeamMembersMap.get(r),a=Et({},n,e);t.mySuperTeamMembersMap.set(r,a)}))},t.syncSuperTeamsHandler=function syncSuperTeamsHandler(e){var t=e.content;this.core.eventBus.emit("sync/updateTimetag",{superTeams:bd(t.timetag)});var r=null==t?void 0:t.teams;if(r&&r.length){var n=formatSuperTeams(r);this.core.emit("superTeams",n)}},t.syncCreateSuperTeamHandler=function syncCreateSuperTeamHandler(e){var t=e.content,r=formatSuperTeam(null==t?void 0:t.superTeam),n=generatorMemberBySuperTeam(r,r.owner,"owner");this.core.emit("createSuperTeam",r,n)},t.syncUpdateSuperTeamMemberHandler=function syncUpdateSuperTeamMemberHandler(e){var t=e.content,r=formatSuperTeamMember(null==t?void 0:t.teamMember);r.updateTime||(r.updateTime=(new Date).getTime()),this.mergeMySuperTeamMembers([r]),this.core.emit("updateSuperTeamMember",r);var n=cloneDeep(this.mySuperTeamMembersMap.get(r.teamId));this.core.emit("mySuperTeamMembers",[n])},t.syncMySuperTeamMembersHandler=function syncMySuperTeamMembersHandler(e){var t,r=e.content;this.core.eventBus.emit("sync/updateTimetag",{mySuperTeamMembers:bd(r.timetag)});var n=null==r?void 0:map$6(t=r.teamMembers).call(t,(function(e){return formatSuperTeamMember(e)}));this.mergeMySuperTeamMembers(n),this.core.emit("mySuperTeamMembers",cloneDeep(n))},t.notificationHandler=function notificationHandler(e){var t=e.attach,r=e.scene,n=e.from,a=e.to,i=e.time,o=e.idServer,s=e.idClient,c=t.team,l=t.account,d=t.accounts,u=t.type;if("superTeam"===r)switch(this.logger.getDebugMode()?this.logger.debug("superTeam::recvNotification",o,s,t):this.logger.log("superTeam::recvNotification",o,s,a,u,l,d),u){case"updateSuperTeam":c.updateTime=i,this.core.emit("updateSuperTeam",c);break;case"addSuperTeamMembers":this.service.notifyAddSuperTeamMembers(c,d);break;case"acceptSuperTeamInvite":this.service.notifyAddSuperTeamMembers(c,[n]);break;case"passSuperTeamApply":this.service.notifyAddSuperTeamMembers(c,[l]);break;case"addSuperTeamManagers":this.service.notifyUpdateSuperTeamManagers(a,d,!0,i);break;case"removeSuperTeamManagers":this.service.notifyUpdateSuperTeamManagers(a,d,!1,i);break;case"removeSuperTeamMembers":this.service.notifyRemoveSuperTeamMembers(c,d);break;case"leaveSuperTeam":this.service.notifyRemoveSuperTeamMembers(c,[n]);break;case"dismissSuperTeam":this.core.emit("dismissSuperTeam",{teamId:a});break;case"transferSuperTeam":this.service.notifyTransferSuperTeam(c,n,l);break;case"updateSuperTeamMembersMute":this.service.notifyUpdateSuperTeamMembersMute(c,d,t.mute)}},SuperTeamService}(ku),e_={"13_1":"getChatroomAddress","24_1":"getQChatAddress"},t_={getChatroomAddress:{sid:13,cid:1,service:"plugin",params:[{type:"Long",name:"chatroomId"},{type:"Bool",name:"isWeixinApp"},{type:"Int",name:"ipType"}],response:[{type:"StrArray",name:"address"}]},getQChatAddress:{sid:24,cid:1,service:"plugin",params:[{type:"Property",name:"getQChatAddressTag",reflectMapper:{ipType:1}}],response:[{type:"StrArray",name:"address"}]}},r_=function(e){function PluginService(t){var r;return(r=e.call(this,"plugin",t)||this).core=t,registerParser({cmdMap:e_,cmdConfig:t_}),r}_t(PluginService,e);var t=PluginService.prototype;return t.getChatroomAddress=function getChatroomAddress(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t;return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return validate({chatroomId:{type:"string",allowEmpty:!1},ipType:{type:"number",required:!1}},e),r.next=3,this.core.sendCmd("getChatroomAddress",{chatroomId:e.chatroomId,isWeixinApp:"WXAPP"===ql.platform,ipType:e.ipType||0});case 3:return t=r.sent,r.abrupt("return",t.content.address);case 5:case"end":return r.stop()}}),_callee,this)})))},t.getQChatAddress=function getQChatAddress(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t;return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return validate({ipType:{type:"number",required:!1}},e),r.next=3,this.core.sendCmd("getQChatAddress",{getQChatAddressTag:{ipType:(null==e?void 0:e.ipType)||0}});case 3:return t=r.sent,r.abrupt("return",t.content.address);case 5:case"end":return r.stop()}}),_callee2,this)})))},PluginService}(ku),n_={"7_19":"nimQueryCloudSessionList","7_20":"nimQueryCloudSession","7_21":"nimUpdateCloudSession","7_22":"nimDeleteCloudSessionList","7_121":"nimMultiSyncUpdateCloudSession"},a_={sessionReqTag:{minTimestamp:1,maxTimestamp:2,includedLastMsg:3,limit:4,hasMore:5},sessionTag:{sessionId:1,updateTime:2,ext:3,lastMsg:4,lastMsgType:5}},i_=invertSerializeMap(a_),o_={nimQueryCloudSessionList:{sid:7,cid:19,service:"cloudSession",params:[{type:"Property",name:"tag",reflectMapper:a_.sessionReqTag}],response:[{type:"Property",name:"tag",reflectMapper:i_.sessionReqTag},{type:"PropertyArray",name:"sessions",reflectMapper:i_.sessionTag}]},nimQueryCloudSession:{sid:7,cid:20,service:"cloudSession",params:[{type:"Property",name:"tag",reflectMapper:a_.sessionTag}],response:[{type:"Property",name:"session",reflectMapper:i_.sessionTag}]},nimUpdateCloudSession:{sid:7,cid:21,service:"cloudSession",params:[{type:"Property",name:"tag",reflectMapper:a_.sessionTag}]},nimDeleteCloudSessionList:{sid:7,cid:22,service:"cloudSession",params:[{type:"PropertyArray",name:"tags",reflectMapper:a_.sessionTag}]},nimMultiSyncUpdateCloudSession:{sid:7,cid:121,service:"cloudSession",response:[{type:"Property",name:"session",reflectMapper:i_.sessionTag}]}},s_={sessionId:{type:"string"},updateTime:{type:"number"},ext:{type:"string"},lastMsg:{type:"object"},lastMsgType:{type:"number"}};function formatCloudSession(e,t,r){var n=format(s_,e),a=getAccountFromSessionId(n.sessionId,"|"),i=a.accid,o=a.scene;if(n.sessionId=o+"-"+i,n.lastMsg){var s=1===n.lastMsgType;n.lastMsgInfo=s?{isLastMsgRecalled:s,revokedMsg:formatSystemMessage(deserialize(n.lastMsg,ty.sysMsg),r)}:{isLastMsgRecalled:s,lastMsg:formatMsg$1(deserialize(n.lastMsg,Pf.msg),{account:t})}}return delete n.lastMsg,delete n.lastMsgType,n}function formatCloudSessions(e,t,r){return e&&e.length>0?map$6(e).call(e,(function(e){return formatCloudSession(e,t,r)})):[]}var c_=function(e){function CloudSessionService(t){var r;return r=e.call(this,"cloudSession",t)||this,registerParser({cmdMap:n_,cmdConfig:o_}),r}_t(CloudSessionService,e);var t=CloudSessionService.prototype;return t.queryCloudSessionList=function queryCloudSessionList(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i;return Dl.wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return validate({minTimestamp:{type:"number",min:0,required:!1},maxTimestamp:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1},includedLastMsg:{type:"boolean",required:!1}},e),(r=Et({limit:100,includedLastMsg:!0},e)).includedLastMsg=vu.boolean(e,"includedLastMsg"),o.next=5,this.core.sendCmd("nimQueryCloudSessionList",{tag:r});case 5:return n=o.sent,a=(null===(t=n.content)||void 0===t?void 0:t.tag)||{},i=n.content.sessions,o.abrupt("return",{hasMore:+a.hasMore>0,sessionList:formatCloudSessions(i,this.core.account,this.logger)});case 9:case"end":return o.stop()}}),_callee,this)})))},t.queryCloudSession=function queryCloudSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a;return Dl.wrap((function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:return validate({sessionId:{type:"string",allowEmpty:!1}},e),t=getAccountFromSessionId(e.sessionId,"-"),r=t.accid,n=t.scene,i.next=4,this.core.sendCmd("nimQueryCloudSession",{tag:{sessionId:"superTeam"===n?"super_team|"+r:n+"|"+r}});case 4:return a=i.sent,i.abrupt("return",formatCloudSession(a.content.session,this.core.account,this.logger));case 6:case"end":return i.stop()}}),_callee2,this)})))},t.updateCloudSession=function updateCloudSession(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r,n;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return validate({sessionId:{type:"string",allowEmpty:!1},ext:{type:"string",allowEmpty:!1,required:!1}},e),t=getAccountFromSessionId(e.sessionId,"-"),r=t.accid,n=t.scene,a.next=4,this.core.sendCmd("nimUpdateCloudSession",{tag:{sessionId:"superTeam"===n?"super_team|"+r:n+"|"+r,ext:e.ext}});case 4:case"end":return a.stop()}}),_callee3,this)})))},t.deleteCloudSessionList=function deleteCloudSessionList(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t,r;return Dl.wrap((function _callee4$(n){for(;;)switch(n.prev=n.next){case 0:return validate({sessionIdList:{type:"array",itemType:"string"}},e),r=map$6(t=e.sessionIdList).call(t,(function(e){var t=getAccountFromSessionId(e,"-"),r=t.accid,n=t.scene;return{sessionId:"superTeam"===n?"super_team|"+r:n+"|"+r}})),n.next=4,this.core.sendCmd("nimDeleteCloudSessionList",{tags:r});case 4:case"end":return n.stop()}}),_callee4,this)})))},t.nimMultiSyncUpdateCloudSessionHandler=function nimMultiSyncUpdateCloudSessionHandler(e){var t=formatCloudSession(e.content.session,this.core.account,this.logger);this.core.emit("multiSyncUpdateCloudSession",t)},CloudSessionService}(ku),l_={needPush:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1},pushContent:{type:"string",required:!1},pushPayload:{type:"string",required:!1},needPushBadge:{type:"boolean",required:!1}},d_={"15_1":"signalingCreate","15_2":"signalingDelay","15_3":"signalingClose","15_4":"signalingJoin","15_5":"signalingLeave","15_6":"signalingInvite","15_7":"signalingCancelInvite","15_8":"signalingReject","15_9":"signalingAccept","15_10":"signalingSendCustomCommand","15_11":"signalingRecvNotification","15_12":"signalingMultiSyncNotification","15_13":"signalingSyncNotification","15_14":"singalingSyncChannels","15_15":"signalingQueryInfo","15_16":"signalingCallEx","15_17":"signalingJoinAndAccept"},u_={avSignalTag:Et({type:1,name:2,channelId:3,createTime:4,expireTime:5,creatorAccid:6,ext:7,invalid:8,fromAccid:10,toAccid:11,requestId:12,members:18,attach:19,attachExt:20,needOffline:21,msgId:22,uid:23,time:24,nertcChannelName:25,nertcTokenTtl:26,nertcToken:27,nertcJoinRoomQueryParamMap:28,nertcJoinRoomResponse:29,callStatus:30},{needPush:13,pushTitle:14,pushContent:15,pushPayload:16,needPushBadge:17})},p_=invertSerializeMap(u_),m_={signalingCreate:{sid:15,cid:1,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingDelay:{sid:15,cid:2,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingClose:{sid:15,cid:3,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingJoin:{sid:15,cid:4,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingLeave:{sid:15,cid:5,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}]},signalingInvite:{sid:15,cid:6,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}]},signalingCancelInvite:{sid:15,cid:7,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}]},signalingReject:{sid:15,cid:8,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}]},signalingAccept:{sid:15,cid:9,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}]},signalingSendCustomCommand:{sid:15,cid:10,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}]},signalingRecvNotification:{sid:15,cid:11,service:"signaling",response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingMultiSyncNotification:{sid:15,cid:12,service:"signaling",response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingSyncNotification:{sid:15,cid:13,service:"signaling",response:[{type:"PropertyArray",name:"datas",reflectMapper:p_.avSignalTag}]},singalingSyncChannels:{sid:15,cid:14,service:"signaling",response:[{type:"PropertyArray",name:"datas",reflectMapper:p_.avSignalTag}]},signalingQueryInfo:{sid:15,cid:15,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingCallEx:{sid:15,cid:16,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingJoinAndAccept:{sid:15,cid:17,service:"signaling",params:[{type:"Property",name:"tag",reflectMapper:u_.avSignalTag}],response:[{type:"Property",name:"data",reflectMapper:p_.avSignalTag}]},signalingBatchMarkRead:{sid:4,cid:5,hasPacketResponse:!1,service:"signaling",params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]}},h_={type:{type:"number"},createTime:{type:"number"},expireTime:{type:"number"},invalid:{type:"boolean"},pushInfo:l_,pluginSetting:{nertcInfo:{nertcChannelName:{type:"string"},nertcTokenTtl:{type:"number"},nertcToken:{type:"string"},nertcJoinRoomQueryParamMap:{type:"string"},callStatus:{type:"number"}}},callStatus:{type:"number"},attach:{type:"object"},members:{type:"object"},needOffline:{type:"boolean"},uid:{type:"number"},time:{type:"number"}};function formatSignalingChannelMember(e){return format(h_,deserialize(e,{1:"accid",2:"uid",3:"createTime",4:"expireTime"}))}function formatSignaling(e){var t,r=format(h_,e),n=[];r.members&&r.members.length>0&&(n=map$6(t=r.members).call(t,(function(e){return formatSignalingChannelMember(e)})),delete r.members);return n.length>0?{channelInfo:r,memberList:n}:{channelInfo:r}}function formatSignalingWithCallStatus(e){var t,r=format(h_,e),n=[];r.members&&r.members.length>0&&(n=map$6(t=r.members).call(t,(function(e){return formatSignalingChannelMember(e)})),delete r.members);var a=200;return e.callStatus&&(a=Number(e.callStatus)),n.length>0?{channelInfo:r,memberList:n,callStatus:a}:{channelInfo:r,callStatus:a}}function generateSignalingForCmd(e){return formatReverse(h_,e)}var g_,v_,f_,y_,__,M_,I_,S_=function(e){function SignalingService(t){var r;return(r=e.call(this)||this).timer=0,r.pollingInterval=12e4,r.name="signaling",r.logger=t.logger,r.core=t,r.channels={},registerParser({cmdMap:d_,cmdConfig:m_}),r}_t(SignalingService,e);var t=SignalingService.prototype;return t.callEx=function callEx(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i;return Dl.wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return validate({type:{type:"number"},toAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},needOffline:{type:"boolean",required:!1},pushInfo:{type:"object",required:!1,rules:l_},pluginSetting:{type:"object",required:!1,rules:{nertcInfo:{type:"object",required:!1}}}},e),o.next=3,this.core.sendCmd("signalingCallEx",{tag:generateSignalingForCmd(e)});case 3:return r=o.sent,n=(null===(t=r.content)||void 0===t?void 0:t.data)||{},a=formatSignalingWithCallStatus(n),this.channels[a.channelInfo.channelId]=cloneDeep(a.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(bind$1(i=this.aotoDelay).call(i,this),this.pollingInterval,-1)),o.abrupt("return",a);case 9:case"end":return o.stop()}}),_callee,this)})))},t.joinAndAccept=function joinAndAccept(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n,a,i,o,s;return Dl.wrap((function _callee2$(c){for(;;)switch(c.prev=c.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",required:!1},needOffline:{type:"boolean",required:!1},uid:{type:"number",required:!1},pluginSetting:{type:"object",required:!1,rules:{nertcInfo:{type:"object",required:!1}}}},e),r=e.fromAccid,(n=__rest(e,["fromAccid"])).toAccid=r,c.next=5,this.core.sendCmd("signalingJoinAndAccept",{tag:generateSignalingForCmd(n)});case 5:return a=c.sent,i=(null===(t=a.content)||void 0===t?void 0:t.data)||{},o=formatSignalingWithCallStatus(i),this.channels[o.channelInfo.channelId]=cloneDeep(o.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(bind$1(s=this.aotoDelay).call(s,this),this.pollingInterval,-1)),c.abrupt("return",o);case 11:case"end":return c.stop()}}),_callee2,this)})))},t.create=function create(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var r,n;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return validate({type:{type:"number"},ext:{type:"string",required:!1}},e),a.next=3,this.core.sendCmd("signalingCreate",{tag:generateSignalingForCmd(e)});case 3:return r=a.sent,n=(null===(t=r.content)||void 0===t?void 0:t.data)||{},a.abrupt("return",formatSignaling(n));case 6:case"end":return a.stop()}}),_callee3,this)})))},t.close=function close(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e),t.next=3,this.core.sendCmd("signalingClose",{tag:generateSignalingForCmd(e)});case 3:case"end":return t.stop()}}),_callee4,this)})))},t.queryInfo=function queryInfo(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var r,n;return Dl.wrap((function _callee5$(a){for(;;)switch(a.prev=a.next){case 0:return validate({name:{type:"string",allowEmpty:!1}},e),a.next=3,this.core.sendCmd("signalingQueryInfo",{tag:e});case 3:return r=a.sent,n=(null===(t=r.content)||void 0===t?void 0:t.data)||{},a.abrupt("return",formatSignaling(n));case 6:case"end":return a.stop()}}),_callee5,this)})))},t.join=function join(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var r,n,a,i;return Dl.wrap((function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},uid:{type:"number",min:0,required:!1},needOffline:{type:"boolean",required:!1}},e),o.next=3,this.core.sendCmd("signalingJoin",{tag:generateSignalingForCmd(e)});case 3:return r=o.sent,n=(null===(t=r.content)||void 0===t?void 0:t.data)||{},a=formatSignaling(n),this.channels[a.channelInfo.channelId]=cloneDeep(a.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(bind$1(i=this.aotoDelay).call(i,this),this.pollingInterval,-1)),o.abrupt("return",a);case 9:case"end":return o.stop()}}),_callee6,this)})))},t.aotoDelay=function aotoDelay(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var e,t,r,n,a;return Dl.wrap((function _callee7$(i){for(;;)switch(i.prev=i.next){case 0:if(0!==(e=Nt(this.channels)).length){i.next=5;break}return this.timer&&this.core.timerManager.deleteTimer(this.timer),this.timer=0,i.abrupt("return");case 5:this.logger.log("signling:autoDelay",e),t=0;case 7:if(!(t<e.length)){i.next=24;break}return r=e[t],i.prev=9,i.next=12,this.core.sendCmd("signalingDelay",{tag:{channelId:r}});case 12:n=i.sent,a=formatSignaling(n.content.data),this.channels[r]=a.channelInfo,i.next=21;break;case 17:i.prev=17,i.t0=i.catch(9),this.logger.warn("signling:autoDelay "+r+" failed",i.t0),delete this.channels[r];case 21:t++,i.next=7;break;case 24:case"end":return i.stop()}}),_callee7,this,[[9,17]])})))},t.leave=function leave(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){return Dl.wrap((function _callee8$(t){for(;;)switch(t.prev=t.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e),t.next=3,this.core.sendCmd("signalingLeave",{tag:generateSignalingForCmd(e)});case 3:delete this.channels[e.channelId];case 4:case"end":return t.stop()}}),_callee8,this)})))},t.invite=function invite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){return Dl.wrap((function _callee9$(t){for(;;)switch(t.prev=t.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},toAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1},pushInfo:{type:"object",required:!1,rules:l_}},e),t.next=3,this.core.sendCmd("signalingInvite",{tag:generateSignalingForCmd(e)});case 3:case"end":return t.stop()}}),_callee9,this)})))},t.cancelInvite=function cancelInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){return Dl.wrap((function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},toAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e),t.next=3,this.core.sendCmd("signalingCancelInvite",{tag:generateSignalingForCmd(e)});case 3:case"end":return t.stop()}}),_callee10,this)})))},t.reject=function reject(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){var t,r;return Dl.wrap((function _callee11$(n){for(;;)switch(n.prev=n.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1}},e),t=e.fromAccid,(r=__rest(e,["fromAccid"])).toAccid=t,n.next=5,this.core.sendCmd("signalingReject",{tag:generateSignalingForCmd(r)});case 5:case"end":return n.stop()}}),_callee11,this)})))},t.accept=function accept(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t,r,n,a,i;return Dl.wrap((function _callee12$(o){for(;;)switch(o.prev=o.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},attachExt:{type:"string",required:!1},needOffline:{type:"boolean",required:!1},autoJoin:{type:"boolean",required:!1},uid:{type:"number",min:0,required:!1},joinAttachExt:{type:"string",required:!1}},e),t=e.autoJoin,r=e.joinAttachExt,n=e.fromAccid,(a=__rest(e,["autoJoin","joinAttachExt","fromAccid"])).toAccid=n,o.next=5,this.core.sendCmd("signalingAccept",{tag:generateSignalingForCmd(a)});case 5:if(this.logger.log("Signaling:accept, accept success, autoJoin "+e.autoJoin),!t){o.next=10;break}return i={channelId:e.channelId,needOffline:e.needOffline,attachExt:r,uid:e.uid},o.next=10,this.join(i);case 10:case"end":return o.stop()}}),_callee12,this)})))},t.sendCustomCommand=function sendCustomCommand(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){return Dl.wrap((function _callee13$(t){for(;;)switch(t.prev=t.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1},fromAccid:{type:"string",allowEmpty:!1,required:!1},attachExt:{type:"string",required:!1}},e),t.next=3,this.core.sendCmd("signalingSendCustomCommand",{tag:generateSignalingForCmd(e)});case 3:case"end":return t.stop()}}),_callee13,this)})))},t.signalingRecvNotificationHandler=function signalingRecvNotificationHandler(e){var t="number"==typeof get(e,"raw.r[0]")?""+e.raw.r[0]:"0";e.content.data.msgId=e.content.data.msgId||t,this.doNotify(e.content.data),t&&bd(t)&&this.core.sendCmd("signalingBatchMarkRead",{sid:15,cid:11,ids:[t]})},t.signalingMultiSyncNotificationHandler=function signalingMultiSyncNotificationHandler(e){this.doNotify(e.content.data,3)},t.doNotify=function doNotify(e,t){void 0===t&&(t=0);var r=function formatSignalingNotification(e,t){void 0===t&&(t=0);var r=format(h_,e),n=r.attach,a=r.attachExt,i=r.time,o=r.msgId;r.fromAccid,r.toAccid,r.members,r.requestId,r.pushInfo;var s=__rest(r,["attach","attachExt","time","msgId","fromAccid","toAccid","members","requestId","pushInfo"]);if(2===n.type)try{r.member={accid:r.attach.member[1],uid:Number(r.attach.member[2]),createTime:Number(r.attach.member[3]),expireTime:Number(r.attach.member[4])}}catch(e){delete r.member}var c=n.type;return delete r.attach,{metaData:{eventType:c,channelInfo:s,feature:t,ext:a||"",time:i,msgId:o},rawData:r}}(e,t),n=r.metaData,a=r.rawData,i=a.fromAccid,o=a.toAccid,s=a.requestId,c=a.pushInfo,l=a.msgId,d=a.member;switch(n.eventType){case 1:this.emit("signalingClose",{fromAccid:i,metaData:n});break;case 2:this.emit("signalingJoin",{fromAccid:i,metaData:n,member:d});break;case 3:this.emit("signalingInvite",{fromAccid:i,toAccid:o,requestId:s,pushInfo:c,metaData:n});break;case 4:this.emit("signalingCancelInvite",{fromAccid:i,toAccid:o,requestId:s,metaData:n});break;case 5:this.emit("signalingReject",{fromAccid:i,toAccid:o,requestId:s,metaData:n});break;case 6:this.emit("signalingAccept",{fromAccid:i,toAccid:o,requestId:s,metaData:n});break;case 7:this.emit("signalingLeave",{fromAccid:i,metaData:n});break;case 8:this.emit("signalingCustomCommand",{fromAccid:i,metaData:n});break;default:this.logger.warn("signaling:notification, no such a type "+n.eventType,a)}return l},t.signalingSyncNotificationHandler=function signalingSyncNotificationHandler(e){var t,r,n=this;if(e.content.datas&&e.content.datas.length>0){var a=filter(t=map$6(r=e.content.datas).call(r,(function(e){return n.doNotify(e,1)}))).call(t,(function(e){return e}));a.length>0&&this.core.sendCmd("signalingBatchMarkRead",{sid:15,cid:11,ids:a})}},t.singalingSyncChannelsHandler=function singalingSyncChannelsHandler(e){var t,r=this;if(this.timer=0,this.channels={},e.content.datas&&e.content.datas.length>0){var n=map$6(t=e.content.datas).call(t,(function(e){return formatSignaling(e)}));forEach$1(n).call(n,(function(e){var t=e.channelInfo.channelId;r.channels[t]=cloneDeep(e.channelInfo)})),this.emit("singalingSyncChannels",n)}},t.process=function process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t)return t.call(this,e),Pi.resolve(e);var r=get(e,"error.detail.ignore");return e.error&&!r?Pi.reject(e.error):Pi.resolve(e)},SignalingService}(to.EventEmitter),T_=function(e){function Service(t,r){var n;return(n=e.call(this)||this).name=t,n.core=r,n.name=t,n.logger=r.logger,n.core=r,n}_t(Service,e);var t=Service.prototype;return t.emit=function emit(t){var r=this;try{for(var n,a,i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];var c=(n=e.prototype.emit).call.apply(n,concat(a=[this,t]).call(a,o));return c}catch(e){return eo((function(){throw r.logger.error(r.name+"::emit throw error in setTimeout. event: "+t.toString()+". Error",e),e}),0),!1}},t.process=function process(e){var t=this[e.cmd+"Handler"];if("function"==typeof t)return t.call(this,e);var r=get(e,"error.detail.ignore");return e.error&&!r?Pi.reject(e.error):Pi.resolve(e)},Service}(to),C_={"24_15":"qchatSubscribe","24_27":"qchatGetUnreadInfo","24_48":"qchatCreateChannel","24_49":"qchatDeleteChannel","24_50":"qchatUpdateChannel","24_51":"qchatGetChannels","24_52":"qchatGetChannelsByPage","24_53":"qchatGetMembersByPage","24_54":"qchatUpdateWhiteBlackRole","24_55":"qchatGetWhiteBlackRolesPage","24_56":"qchatUpdateWhiteBlackMembers","24_57":"qchatGetWhiteBlackMembersPage","24_58":"qchatGetExistingWhiteBlackRoles","24_59":"qchatGetExistingWhiteBlackMembers","24_60":"qchatUpdateCategoryInfoOfChannel","24_109":"qchatCreateChannelCategory","24_110":"qchatRemoveChannelCategory","24_111":"qchatUpdateChannelCategory","24_112":"qchatGetChannelCategoriesByID","24_113":"qchatUpdateChannelCategoryWhiteBlackRole","24_114":"qchatGetChannelCategoryWhiteBlackRolesPage","24_115":"qchatUpdateChannelCategoryWhiteBlackMembers","24_116":"qchatGetChannelCategoryWhiteBlackMembersPage","24_117":"qchatGetChannelCategoryWhiteBlackRoles","24_118":"qchatGetChannelCategoryWhiteBlackMembers","24_119":"qchatGetChannelCategoriesPage","24_120":"qchatGetChannelCategoryChannelsPage","24_93":"qchatGetChannelSearchByPage","24_95":"qchatChannelMemberSearch","25_8":"qchatGetRoleIdsByServerId","25_9":"qchatSubscribeAsVisitor","25_12":"qchatAutoSubscribe","25_13":"qchatAutoSubscribeNotification"},b_={serverId:1,channelId:2,ackTimestamp:3,unreadCount:4,mentionedCount:5,maxCount:6,lastMsgTime:7},E_={channelInfo:{channelId:1,serverId:2,name:4,topic:5,ext:6,type:7,validFlag:8,createTime:9,updateTime:10,owner:11,viewMode:12,categoryId:13,syncMode:14,reorderWeight:15,visitorMode:16},antispamTag:{antiSpamBusinessId:1},memberInfo:{serverId:1,accid:3,nick:4,avatar:5,ext:6,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},serverRole:{serverId:1,roleId:2,name:3,icon:4,ext:5,auths:6,type:7,memberCount:8,priority:9,createTime:10,updateTime:11},qchatSubReqTag:{type:1,opeType:2},qchatChannelIdInfoTag:{serverId:1,channelId:2},unreadInfo:b_,qchatGetChannelListPageTag:{serverId:1,timetag:2,limit:3},qchatGetMembersByPageTag:{serverId:1,channelId:2,timetag:3,limit:4},qchatUpdateWhiteBlackRoleTag:{serverId:1,channelId:2,type:3,opeType:4,roleId:5},qchatGetWhiteBlackRolesPageTag:{serverId:1,channelId:2,type:3,timetag:4,limit:5},qchatUpdateWhiteBlackMembersTag:{serverId:1,channelId:2,type:3,opeType:4,toAccids:5},qchatGetWhiteBlackMembersPageTag:{serverId:1,channelId:2,type:3,timetag:4,limit:5},qchatGetExistingWhiteBlackRolesTag:{serverId:1,channelId:2,type:3,roleIds:4},qchatGetExistingWhiteBlackMembersTag:{serverId:1,channelId:2,type:3,accids:4},QChatChannelCategoryInfo:{categoryId:1,serverId:2,name:4,ext:5,owner:6,viewMode:7,validFlag:8,createTime:9,updateTime:10,channelNumber:11},qchatUpdateChannelCategoryWhiteBlackRoleTag:{serverId:1,categoryId:2,type:3,opeType:4,roleId:5},qchatGetChannelCategoryWhiteBlackRolesPageTag:{serverId:1,categoryId:2,type:3,timetag:4,limit:5},qchatUpdateChannelCategoryWhiteBlackMembersTag:{serverId:1,categoryId:2,type:3,opeType:4,toAccids:5},qchatGetChannelCategoryWhiteBlackMembersPageTag:{serverId:1,categoryId:2,type:3,timetag:4,limit:5},qchatGetChannelCategoryWhiteBlackRolesTag:{serverId:1,categoryId:2,type:3,roleIds:4},qchatGetChannelCategoryWhiteBlackMembersTag:{serverId:1,categoryId:2,type:3,accids:4},qchatGetChannelCategoriesPageTag:{serverId:1,timetag:2,limit:3},qchatGetChannelCategoryChannelsPageTag:{serverId:1,categoryId:2,timetag:3,limit:4},qchatGetChannelSearchByPageTag:{keyword:1,startTime:2,endTime:3,order:4,limit:5,serverId:6,sort:7,cursor:8},qchatUpdateChannelTag:{channelId:1,name:4,topic:5,ext:6,viewMode:12,visitorMode:16},serverRoles:{serverId:1,roleIds:2,timeTag:3},qchatChannelMemberSearchTag:{serverId:1,channelId:2,keyword:3,limit:4},qchatChannelMemberInfo:{serverId:1,channelId:2,avatar:3,accid:4,nick:5,createTime:6,updateTime:7}},R_=function getDeserializeTag(){return invertSerializeMap(E_)},k_=function getCmdConfig(){var e=R_();return{qchatCreateChannel:{sid:24,cid:48,service:"qchatChannel",params:[{type:"Property",name:"channelInfo",reflectMapper:E_.channelInfo},{type:"Property",name:"antispamTag",reflectMapper:E_.antispamTag}],response:[{type:"Property",name:"channelInfo",reflectMapper:e.channelInfo}]},qchatDeleteChannel:{sid:24,cid:49,service:"qchatChannel",params:[{type:"Long",name:"channelId"}]},qchatUpdateChannel:{sid:24,cid:50,service:"qchatChannel",params:[{type:"Property",name:"channelInfo",reflectMapper:E_.qchatUpdateChannelTag},{type:"Property",name:"antispamTag",reflectMapper:E_.antispamTag}],response:[{type:"Property",name:"channelInfo",reflectMapper:e.channelInfo}]},qchatGetChannels:{sid:24,cid:51,service:"qchatChannel",params:[{type:"LongArray",name:"channelIds"}],response:[{type:"PropertyArray",name:"channelList",reflectMapper:e.channelInfo}]},qchatGetChannelsByPage:{sid:24,cid:52,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelListPageTag",reflectMapper:E_.qchatGetChannelListPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.channelInfo}]},qchatGetMembersByPage:{sid:24,cid:53,service:"qchatChannel",params:[{type:"Property",name:"qchatGetMembersByPageTag",reflectMapper:E_.qchatGetMembersByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatUpdateWhiteBlackRole:{sid:24,cid:54,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateWhiteBlackRoleTag",reflectMapper:E_.qchatUpdateWhiteBlackRoleTag}]},qchatGetWhiteBlackRolesPage:{sid:24,cid:55,service:"qchatChannel",params:[{type:"Property",name:"qchatGetWhiteBlackRolesPageTag",reflectMapper:E_.qchatGetWhiteBlackRolesPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatUpdateWhiteBlackMembers:{sid:24,cid:56,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateWhiteBlackMembersTag",reflectMapper:E_.qchatUpdateWhiteBlackMembersTag}]},qchatGetWhiteBlackMembersPage:{sid:24,cid:57,service:"qchatChannel",params:[{type:"Property",name:"qchatGetWhiteBlackMembersPageTag",reflectMapper:E_.qchatGetWhiteBlackMembersPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatGetExistingWhiteBlackRoles:{sid:24,cid:58,service:"qchatChannel",params:[{type:"Property",name:"qchatGetExistingWhiteBlackRolesTag",reflectMapper:E_.qchatGetExistingWhiteBlackRolesTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatGetExistingWhiteBlackMembers:{sid:24,cid:59,service:"qchatChannel",params:[{type:"Property",name:"qchatGetExistingWhiteBlackMembersTag",reflectMapper:E_.qchatGetExistingWhiteBlackMembersTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatUpdateCategoryInfoOfChannel:{sid:24,cid:60,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateCategoryInfoOfChannelTag",reflectMapper:E_.channelInfo}],response:[{type:"Property",name:"channelInfo",reflectMapper:e.channelInfo}]},qchatCreateChannelCategory:{sid:24,cid:109,service:"qchatChannel",params:[{type:"Property",name:"qchatCreateChannelCategoryTag",reflectMapper:E_.QChatChannelCategoryInfo}],response:[{type:"Property",name:"QChatChannelCategoryInfo",reflectMapper:e.QChatChannelCategoryInfo}]},qchatRemoveChannelCategory:{sid:24,cid:110,service:"qchatChannel",params:[{type:"Long",name:"categoryId"}]},qchatUpdateChannelCategory:{sid:24,cid:111,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateChannelCategoryTag",reflectMapper:E_.QChatChannelCategoryInfo}],response:[{type:"Property",name:"QChatChannelCategoryInfo",reflectMapper:e.QChatChannelCategoryInfo}]},qchatGetChannelCategoriesByID:{sid:24,cid:112,service:"qchatChannel",params:[{type:"LongArray",name:"categoryIds"}],response:[{type:"PropertyArray",name:"channelCategoryList",reflectMapper:e.QChatChannelCategoryInfo}]},qchatUpdateChannelCategoryWhiteBlackRole:{sid:24,cid:113,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateChannelCategoryWhiteBlackRoleTag",reflectMapper:E_.qchatUpdateChannelCategoryWhiteBlackRoleTag}]},qchatGetChannelCategoryWhiteBlackRolesPage:{sid:24,cid:114,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackRolesPageTag",reflectMapper:E_.qchatGetChannelCategoryWhiteBlackRolesPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatUpdateChannelCategoryWhiteBlackMembers:{sid:24,cid:115,service:"qchatChannel",params:[{type:"Property",name:"qchatUpdateChannelCategoryWhiteBlackMembersTag",reflectMapper:E_.qchatUpdateChannelCategoryWhiteBlackMembersTag}]},qchatGetChannelCategoryWhiteBlackMembersPage:{sid:24,cid:116,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackMembersPageTag",reflectMapper:E_.qchatGetChannelCategoryWhiteBlackMembersPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatGetChannelCategoryWhiteBlackRoles:{sid:24,cid:117,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackRolesTag",reflectMapper:E_.qchatGetChannelCategoryWhiteBlackRolesTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.serverRole}]},qchatGetChannelCategoryWhiteBlackMembers:{sid:24,cid:118,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryWhiteBlackMembersTag",reflectMapper:E_.qchatGetChannelCategoryWhiteBlackMembersTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatGetChannelCategoriesPage:{sid:24,cid:119,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoriesPageTag",reflectMapper:E_.qchatGetChannelCategoriesPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.QChatChannelCategoryInfo}]},qchatGetChannelCategoryChannelsPage:{sid:24,cid:120,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelCategoryChannelsPageTag",reflectMapper:E_.qchatGetChannelCategoryChannelsPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.channelInfo}]},qchatSubscribe:{sid:24,cid:15,service:"qchatChannel",params:[{type:"Property",name:"qchatSubReqTag",reflectMapper:E_.qchatSubReqTag},{type:"PropertyArray",name:"channels",reflectMapper:E_.qchatChannelIdInfoTag}],response:[{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo},{type:"PropertyArray",name:"failedChannels",reflectMapper:e.qchatChannelIdInfoTag}]},qchatAutoSubscribe:{sid:25,cid:12,service:"qchatChannel",hasPacketTimer:!1,params:[{type:"Property",name:"qchatAutoSubReqTag"}],response:[{type:"Property",name:"qchatAutoSubInfo",reflectMapper:{1:"time"}}]},qchatAutoSubscribeNotification:{service:"qchatChannel",sid:25,cid:13,response:[{type:"PropertyArray",name:"serverIds",reflectMapper:e.unreadInfo},{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo}]},qchatGetUnreadInfo:{sid:24,cid:27,service:"qchatChannel",params:[{type:"PropertyArray",name:"channels",reflectMapper:E_.qchatChannelIdInfoTag}],response:[{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo}]},qchatGetChannelSearchByPage:{sid:24,cid:93,service:"qchatChannel",params:[{type:"Property",name:"qchatGetChannelSearchByPageTag",reflectMapper:E_.qchatGetChannelSearchByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag",3:"cursor"}},{type:"PropertyArray",name:"datas",reflectMapper:e.channelInfo}]},qchatGetRoleIdsByServerId:{sid:25,cid:8,service:"qchatChannel",params:[{type:"Property",name:"qchatGetRoleIdsByServerIdTag",reflectMapper:{serverIdTimeTags:1}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRoles},{type:"String",name:"failServerIds"}]},qchatChannelMemberSearch:{sid:24,cid:95,service:"qchatChannel",params:[{type:"Property",name:"qchatChannelMemberSearchTag",reflectMapper:E_.qchatChannelMemberSearchTag}],response:[{type:"PropertyArray",name:"datas",reflectMapper:e.qchatChannelMemberInfo}]},qchatSubscribeAsVisitor:{sid:25,cid:9,service:"qchatChannel",params:[{type:"Property",name:"tag",reflectMapper:E_.qchatSubReqTag},{type:"PropertyArray",name:"datas",reflectMapper:E_.qchatChannelIdInfoTag}],response:[{type:"PropertyArray",name:"failedArr",reflectMapper:e.qchatChannelIdInfoTag}]}}};!function(e){e[e.reorderWeight=0]="reorderWeight",e[e.createTime=1]="createTime"}(g_||(g_={})),function(e){e[e.white=1]="white",e[e.black=2]="black"}(v_||(v_={})),function(e){e[e.add=1]="add",e[e.remove=2]="remove"}(f_||(f_={})),function(e){e[e.message=0]="message",e[e.media=1]="media",e[e.ext=100]="ext"}(y_||(y_={})),function(e){e[e.ASC=1]="ASC",e[e.DESC=2]="DESC"}(__||(__={})),function(e){e[e.reorderWeight=0]="reorderWeight",e[e.createTime=1]="createTime",e[e.totalMember=2]="totalMember"}(M_||(M_={})),function(e){e[e.square=1]="square",e[e.person=2]="person"}(I_||(I_={}));var w_={channelId:{type:"string"},serverId:{type:"string"},name:{type:"string"},topic:{type:"string"},ext:{type:"string"},type:{type:"enum",values:y_},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},viewMode:{type:"number"},categoryId:{type:"string"},syncMode:{type:"number"},visitorMode:{type:"number"},reorderWeight:{type:"string"}},A_={serverId:{type:"string"},channelId:{type:"string"},ackTimestamp:{type:"number"},unreadCount:{type:"number"},mentionedCount:{type:"number"},maxCount:{type:"number"},lastMsgTime:{type:"number"}},N_={serverId:{type:"string"},channelId:{type:"string"},type:{type:"enum",values:v_},opeType:{type:"enum",values:f_},toAccids:{type:"object"}},x_={serverId:{type:"string"},channelId:{type:"string"},type:{type:"enum",values:v_},opeType:{type:"enum",values:f_},roleId:{type:"string"}},O_={categoryId:{type:"string"},serverId:{type:"string"},name:{type:"string"},ext:{type:"string"},owner:{type:"string"},viewMode:{type:"number"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},channelNumber:{type:"number"}},P_={serverId:{type:"string"},channelId:{type:"string"},accid:{type:"string"},avatar:{type:"string"},nick:{type:"string"},createTime:{type:"number"},updateTime:{type:"number"}};function formatUpdateWhiteBlackRole(e){return format(x_,e)}function formatChannel(e){return format(w_,e)}function formatChannels(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatChannel(e)})):[]}function formatUnreadInfo(e){return format(A_,e)}function formatUnreadInfos(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatUnreadInfo(e)})):[]}function formatChannelCategory(e){return format(O_,e)}function formatChannelCategorys(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatChannelCategory(e)})):[]}function formatChannelMembers(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return function formatChannelMember(e){return format(P_,e)}(e)})):[]}function formatFailServerIds(e){try{return JSON.parse(e)}catch(e){return[]}}var L_={serverId:{type:"string"},name:{type:"string"},icon:{type:"string"},ext:{type:"string"},owner:{type:"string"},memberNumber:{type:"number"},inviteMode:{type:"number"},applyMode:{type:"number"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},channelNumber:{type:"number"},categoryNumber:{type:"number"},searchType:{type:"number"},searchEnable:{type:"boolean"},reorderWeight:{type:"string"}},V_={serverId:{type:"string"},uid:{type:"string"},accid:{type:"string"},nick:{type:"string"},avatar:{type:"string"},ext:{type:"string"},type:{type:"number"},joinTime:{type:"number"},inviter:{type:"string"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}},U_={serverId:{type:"string"},appid:{type:"string"},accid:{type:"string"},ext:{type:"string"},banTime:{type:"number"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}};function formatServer(e){return format(L_,e)}function formatServers(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatServer(e)})):[]}function formatMember$1(e){return format(V_,e)}function formatMembers$1(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatMember$1(e)})):[]}function formatServerMemberBanInfos(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return function formatServerMemberBanInfo(e){return format(U_,e)}(e)})):[]}function generateAntispamTag(e){var t,r,n;if(!e.antispamTag)return{};var a=Et({},e.antispamTag);return(null===(t=e.antispamTag)||void 0===t?void 0:t.antiSpamBusinessId)&&"string"!=typeof(null===(r=e.antispamTag)||void 0===r?void 0:r.antiSpamBusinessId)&&(a.antiSpamBusinessId=bn(null===(n=e.antispamTag)||void 0===n?void 0:n.antiSpamBusinessId)),a}var D_={accid:{type:"string"},type:{type:"number"},serverId:{type:"string"},status:{type:"number"},requestId:{type:"string"},createTime:{type:"number"},updateTime:{type:"number"},expireTime:{type:"number"},data:{type:"object"}};function formatInviteApplyRecord(e){return format(D_,e)}function formatInviteApplyRecords(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatInviteApplyRecord(e)})):[]}var q_,B_,F_,G_,H_={successServerIds:{type:"object"},failServerIds:{type:"object"},ackTimestamp:{type:"number"}};function formatClearServersUnread(e){return format(H_,e)}!function(e){e[e.everyone=1]="everyone",e[e.custom=2]="custom"}(q_||(q_={})),function(e){e[e.normal=0]="normal",e[e.owner=1]="owner"}(B_||(B_={})),function(e){e[e.ignore=0]="ignore",e[e.deny=-1]="deny",e[e.allow=1]="allow"}(F_||(F_={})),function(e){e[e.manageServer=1]="manageServer",e[e.manageChannel=2]="manageChannel",e[e.manageRole=3]="manageRole",e[e.sendMsg=4]="sendMsg",e[e.accountInfoSelf=5]="accountInfoSelf",e[e.inviteServer=6]="inviteServer",e[e.kickServer=7]="kickServer",e[e.accountInfoOther=8]="accountInfoOther",e[e.recallMsg=9]="recallMsg",e[e.deleteMsg=10]="deleteMsg",e[e.remindOther=11]="remindOther",e[e.remindEveryone=12]="remindEveryone",e[e.manageBlackWhiteList=13]="manageBlackWhiteList",e[e.banServerMember=14]="banServerMember",e[e.RTCChannelConnect=15]="RTCChannelConnect",e[e.RTCChannelDisconnectOther=16]="RTCChannelDisconnectOther",e[e.RTCChannelOpenMicrophone=17]="RTCChannelOpenMicrophone",e[e.RTCChannelOpenCamera=18]="RTCChannelOpenCamera",e[e.RTCChannelOpenCloseOtherMicrophone=19]="RTCChannelOpenCloseOtherMicrophone",e[e.RTCChannelOpenCloseOtherCamera=20]="RTCChannelOpenCloseOtherCamera",e[e.RTCChannelOpenCloseEveryoneMicrophone=21]="RTCChannelOpenCloseEveryoneMicrophone",e[e.RTCChannelOpenCloseEveryoneCamera=22]="RTCChannelOpenCloseEveryoneCamera",e[e.RTCChannelOpenShareScreen=23]="RTCChannelOpenShareScreen",e[e.RTCChannelCloseOtherShareScreen=24]="RTCChannelCloseOtherShareScreen",e[e.manageInviteApply=25]="manageInviteApply",e[e.manageInviteApplyHistory=26]="manageInviteApplyHistory",e[e.mentionedRole=27]="mentionedRole"}(G_||(G_={}));var j_,$_,z_,W_,K_,Y_,Q_,J_,X_={type:{type:"enum",values:q_},memberType:{type:"enum",values:B_},createTime:{type:"number"},updateTime:{type:"number"},priority:{type:"number"},memberCount:{type:"number"},joinTime:{type:"number"}},Z_={roleId:{type:"string"},categoryId:{type:"string"},serverId:{type:"string"},type:{type:"enum",values:q_},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},name:{type:"string"},icon:{type:"string"},ext:{type:"string"}},eM={id:{type:"string"},accid:{type:"string"},categoryId:{type:"string"},serverId:{type:"string"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"},nick:{type:"string"},avatar:{type:"string"},ext:{type:"string"},memberType:{type:"enum",values:B_},joinTime:{type:"number"},inviter:{type:"string"}};function generatorRoleForCmd(e){var t=Et({},e),r=formatReverse(X_,t);return r.auths&&(r.auths=function generateRoleAuthsForCmd(e){var t,r=reduce(t=Nt(e)).call(t,(function(t,r){var n=G_[r];return n?t[n]=F_[e[r]]:t[r]=F_[e[r]],t}),{});return bn(r)}(r.auths)),r}function formatRoleAuths(e){var t;return reduce(t=Nt(e)).call(t,(function(t,r){var n=getEnumKeyByEnumValue(G_,r);n?t[n]=F_[e[r]]:t[bd(r)]=F_[e[r]];return t}),{})}function formatRole(e){var t=format(X_,e);return e.auths&&(t.auths=formatRoleAuths(JSON.parse(t.auths))),t.isMember&&delete t.isMember,t}function formatRoles(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return formatRole(e)})):[]}function formatChannelCategoryRole(e){return e.auths&&(e.auths=formatRoleAuths(JSON.parse(e.auths))),format(Z_,e)}function formatChannelCategoryMemberRole(e){return e.auths&&(e.auths=formatRoleAuths(JSON.parse(e.auths))),format(eM,e)}function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}!function(e){e[e.default=1]="default",e[e.sync=2]="sync"}(j_||(j_={})),function(e){e[e.sendTime=1]="sendTime"}($_||($_={})),function(e){e[e.text=0]="text",e[e.image=1]="image",e[e.audio=2]="audio",e[e.video=3]="video",e[e.geo=4]="geo",e[e.notification=5]="notification",e[e.file=6]="file",e[e.tip=10]="tip",e[e.robot=11]="robot",e[e.g2=12]="g2",e[e.custom=100]="custom"}(z_||(z_={})),function(e){e[e.sending=1]="sending",e[e.success=2]="success",e[e.failed=3]="failed"}(W_||(W_={})),function(e){e[e.notifyAll=1]="notifyAll",e[e.notifySubscribe=2]="notifySubscribe"}(K_||(K_={})),function(e){e[e.unknown=0]="unknown",e[e.server=1]="server",e[e.channel=2]="channel",e[e.serverAccids=3]="serverAccids",e[e.channelAccids=4]="channelAccids",e[e.accids=5]="accids"}(Y_||(Y_={})),function(e){e[e.serverMemberInvite=1]="serverMemberInvite",e[e.serverMemberInviteReject=2]="serverMemberInviteReject",e[e.serverMemberApply=3]="serverMemberApply",e[e.serverMemberApplyReject=4]="serverMemberApplyReject",e[e.serverCreate=5]="serverCreate",e[e.serverRemove=6]="serverRemove",e[e.serverUpdate=7]="serverUpdate",e[e.serverMemberInviteDone=8]="serverMemberInviteDone",e[e.serverMemberInviteAccept=9]="serverMemberInviteAccept",e[e.serverMemberApplyDone=10]="serverMemberApplyDone",e[e.serverMemberApplyAccept=11]="serverMemberApplyAccept",e[e.serverMemberKick=12]="serverMemberKick",e[e.serverMemberLeave=13]="serverMemberLeave",e[e.serverMemberUpdate=14]="serverMemberUpdate",e[e.channelCreate=15]="channelCreate",e[e.channelRemove=16]="channelRemove",e[e.channelUpdate=17]="channelUpdate",e[e.channelUpdateWhiteBlackIdentify=18]="channelUpdateWhiteBlackIdentify",e[e.channelUpdateWhiteBlackIdentifyUser=19]="channelUpdateWhiteBlackIdentifyUser",e[e.updateQuickComment=20]="updateQuickComment",e[e.channelCategoryCreate=21]="channelCategoryCreate",e[e.channelCategoryRemove=22]="channelCategoryRemove",e[e.channelCategoryUpdate=23]="channelCategoryUpdate",e[e.channelCategoryUpdateWhiteBlackIdentify=24]="channelCategoryUpdateWhiteBlackIdentify",e[e.channelCategoryUpdateWhiteBlackIdentifyUser=25]="channelCategoryUpdateWhiteBlackIdentifyUser",e[e.serverIdentifyAdd=26]="serverIdentifyAdd",e[e.serverIdentifyRemove=27]="serverIdentifyRemove",e[e.serverIdentifyUpdate=28]="serverIdentifyUpdate",e[e.channelIdentifyUpdate=29]="channelIdentifyUpdate",e[e.userIdentifyUpdate=30]="userIdentifyUpdate",e[e.channelVisibilityUpdate=31]="channelVisibilityUpdate",e[e.serverEnterLeave=32]="serverEnterLeave",e[e.serverMemberJoinByInviteCode=33]="serverMemberJoinByInviteCode",e[e.channelVisibilityToVisitorUpdate=34]="channelVisibilityToVisitorUpdate",e[e.myMemberInfoUpdated=35]="myMemberInfoUpdated",e[e.custom=100]="custom",e[e.msgTyping=101]="msgTyping"}(Q_||(Q_={})),function(e){e[e.reply=1]="reply",e[e.thread=2]="thread",e[e.all=3]="all"}(J_||(J_={}));var tM=Math.max,rM=Math.min;function debounce(e,t,r){var n,a,i,o,s,c,l=0,d=!1,u=!1,p=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function invokeFunc(t){var r=n,i=a;return n=a=void 0,l=t,o=e.apply(i,r)}function leadingEdge(e){return l=e,s=eo(timerExpired,t),d?invokeFunc(e):o}function shouldInvoke(e){var r=e-c;return void 0===c||r>=t||r<0||u&&e-l>=i}function timerExpired(){var e=Hi();if(shouldInvoke(e))return trailingEdge(e);s=eo(timerExpired,function remainingWait(e){var r=t-(e-c);return u?rM(r,i-(e-l)):r}(e))}function trailingEdge(e){return s=void 0,p&&n?invokeFunc(e):(n=a=void 0,o)}function debounced(){var e=Hi(),r=shouldInvoke(e);if(n=arguments,a=this,c=e,r){if(void 0===s)return leadingEdge(c);if(u)return clearTimeout(s),s=eo(timerExpired,t),invokeFunc(c)}return void 0===s&&(s=eo(timerExpired,t)),o}return t=Number(t)||0,isObject(r)&&(d=!!r.leading,i=(u="maxWait"in r)?tM(Number(r.maxWait)||0,t):i,p="trailing"in r?!!r.trailing:p),debounced.cancel=function cancel(){void 0!==s&&clearTimeout(s),l=0,n=c=a=s=void 0},debounced.flush=function flush(){return void 0===s?o:trailingEdge(Hi())},debounced}var nM;function throttle(e,t,r){var n=!0,a=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return isObject(r)&&(n="leading"in r?!!r.leading:n,a="trailing"in r?!!r.trailing:a),debounce(e,t,{leading:n,maxWait:t,trailing:a})}!function(e){e[e.sub=1]="sub",e[e.unSub=2]="unSub"}(nM||(nM={}));var aM=function(){function UnreadInfoModuleService(e){var t=this;this.unreadCount={},this.manualSubscribeUnreadMap={},this.manualSubscribeServerMap={},this.manualSubscribeTypingMap={},this.unreadServerCount={},this.serverRoleIdsMap={},this.autoSubscribeUnreadMap={},this.autoSubscribeServerMap={},this._serverUnreadInfo=throttle((function(e){t.core.emit("serverUnreadInfo",t.getServerUnreadInfo(e)),get(t.core,"qchatServer.emit")&&t.core.qchatServer.emit("serverUnreadInfo",t.getServerUnreadInfo(e))}),100),this.core=e}var e=UnreadInfoModuleService.prototype;return e.changeCacheServerRoleIds=function changeCacheServerRoleIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a,i,o,s,c=this;return Dl.wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:if(r=e.attach.serverIdentifyInfo,n=r.serverId,a=r.roleId,this.serverRoleIdsMap[n]){l.next=4;break}return l.next=4,this.getRoleIdsByServerId([n]);case 4:if(i=this.serverRoleIdsMap[n],!(e.time<i.timeTag)){l.next=7;break}return l.abrupt("return");case 7:if(e.type===Q_[Q_.serverIdentifyAdd]?i.roleIds.add(a):i.roleIds.delete(a),this.core.logger.debug("QChatChannel::qchatChannel/serverIdentifyChange::now "+n+" roleIds is",concat(t=[]).call(t,i.roleIds)),o=this.unreadServerCount[n]){l.next=12;break}return l.abrupt("return");case 12:s=chunk(Nt(o),100),forEach$1(s).call(s,(function(e){c.core.qchatChannel.getChannelUnreadInfos({channels:map$6(e).call(e,(function(e){return{serverId:n,channelId:e}}))})}));case 14:case"end":return l.stop()}}),_callee,this)})))},e.getRoleIdsByServerId=function getRoleIdsByServerId(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i=this;return Dl.wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:if((r=filter(e).call(e,(function(e){return!i.serverRoleIdsMap[e]}))).length){o.next=3;break}return o.abrupt("return");case 3:return n={serverIdTimeTags:r},o.next=6,this.core.sendCmd("qchatGetRoleIdsByServerId",{qchatGetRoleIdsByServerIdTag:n});case 6:a=o.sent,this.core.logger.debug("QChatChannel:: getRoleIdsByServerId, params is ",n,"result is",a),forEach$1(t=a.content.serverRoles).call(t,(function(e){try{e.roleIds=JSON.parse(e.roleIds)}catch(e){i.core.logger.error("QChatChannel:: getRoleIdsByServerId JSON parse roleIds error",e)}i.serverRoleIdsMap[e.serverId]={roleIds:new iv(e.roleIds),timeTag:e.timeTag}}));case 9:case"end":return o.stop()}}),_callee2,this)})))},e._unSubscribeChannel=function _unSubscribeChannel(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var r,n,a,i,o;return Dl.wrap((function _callee3$(s){for(;;)switch(s.prev=s.next){case 0:if(r=e+"_"+t,n=[],this.manualSubscribeUnreadMap[r]?n.push(this.manualSubscribeUnreadMap[r]):this.autoSubscribeUnreadMap[r]&&n.push(this.autoSubscribeUnreadMap[r]),this.manualSubscribeTypingMap[r]&&n.push(this.manualSubscribeTypingMap[r]),0!==n.length){s.next=6;break}return s.abrupt("return");case 6:for(a=0,i=n;a<i.length;a++)o=i[a],this.subscribe({opeType:nM.unSub,type:o,channels:[{serverId:e,channelId:t}]});this.manualSubscribeUnreadMap[r]?this.manualSubscribeUnreadMap[r]=void 0:this.autoSubscribeUnreadMap[r]&&(this.autoSubscribeUnreadMap[r]=void 0),this.manualSubscribeTypingMap[r]&&(this.manualSubscribeTypingMap[r]=void 0);case 9:case"end":return s.stop()}}),_callee3,this)})))},e._unSubscribeServer=function _unSubscribeServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t,r;return Dl.wrap((function _callee4$(n){for(;;)switch(n.prev=n.next){case 0:if(t=e,r=this.manualSubscribeServerMap[t]||this.autoSubscribeServerMap[t]){n.next=4;break}return n.abrupt("return");case 4:this.subscribe({opeType:nM.unSub,type:r,channels:[{serverId:e,channelId:""}]}),this.manualSubscribeServerMap[t]?this.manualSubscribeServerMap[t]=void 0:this.autoSubscribeServerMap[t]&&(this.autoSubscribeServerMap[t]=void 0);case 6:case"end":return n.stop()}}),_callee4,this)})))},e.subscribe=function subscribe(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t,r,n,a,i=this;return Dl.wrap((function _callee6$(o){for(;;)switch(o.prev=o.next){case 0:return validate({type:{type:"number",min:1,max:5},opeType:{type:"number",min:1,max:2}},e),o.next=3,this.core.sendCmd("qchatSubscribe",{qchatSubReqTag:{type:e.type,opeType:e.opeType},channels:e.channels});case 3:return r=o.sent,n=new iv,forEach$1(t=e.channels).call(t,(function(e){return __awaiter(i,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:this.serverRoleIdsMap[e.serverId]||n.add(e.serverId);case 1:case"end":return t.stop()}}),_callee5,this)})))})),a=chunk(xl(n),10),forEach$1(a).call(a,(function(e){i.getRoleIdsByServerId(e)})),o.abrupt("return",r.content);case 9:case"end":return o.stop()}}),_callee6,this)})))},e.autoSubscribe=function autoSubscribe(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.core.sendCmd("qchatAutoSubscribe",{qchatAutoSubReqTag:{}});case 2:case"end":return e.stop()}}),_callee7,this)})))},e.resumeSubscribe=function resumeSubscribe(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var t,r,n,a,i,o,s,c=this;return Dl.wrap((function _callee10$(l){for(;;)switch(l.prev=l.next){case 0:if(this.serverRoleIdsMap={},i=100,e){l.next=6;break}return this.unreadServerCount={},this.unreadCount={},l.abrupt("return");case 6:return o={},forEach$1(t=Nt(this.manualSubscribeUnreadMap)).call(t,(function(e){var t=c.manualSubscribeUnreadMap[e];if(t){var r=e.split("_"),n={serverId:r[0],channelId:r[1]};o[t]=o[t]||[],o[t].push(n)}})),o[5]=[],forEach$1(r=Nt(this.manualSubscribeTypingMap)).call(r,(function(e){return __awaiter(c,void 0,void 0,Dl.mark((function _callee8(){var t,r,n,a;return Dl.wrap((function _callee8$(i){for(;;)switch(i.prev=i.next){case 0:this.manualSubscribeTypingMap[e]&&(t=e.split("_"),r=t[0],n=t[1],a={serverId:r,channelId:n},o[5].push(a));case 2:case"end":return i.stop()}}),_callee8,this)})))})),o[4]=[],forEach$1(n=Nt(this.manualSubscribeServerMap)).call(n,(function(e){return __awaiter(c,void 0,void 0,Dl.mark((function _callee9(){var t;return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:this.manualSubscribeServerMap[e]&&(t={serverId:e},o[4].push(t));case 2:case"end":return r.stop()}}),_callee9,this)})))})),s=[],forEach$1(a=Nt(o)).call(a,(function(e){var t=o[e];if(t&&0===t.length)return Pi.resolve();if(t.length>i){var r=chunk(t,100);return forEach$1(r).call(r,(function(t){s.push(c.createSubscribePromise(t,e))}))}s.push(c.createSubscribePromise(t,e))})),l.next=16,Pi.all(s);case 16:case"end":return l.stop()}}),_callee10,this)})))},e.createSubscribePromise=function createSubscribePromise(e,t){var r=this,n={type:bd(t),opeType:1,channels:e};return this.core.logger.debug("qchatChannel:: autoSubscribeUnread params",n),this.subscribe(n).then((function(e){var t=e.unreadInfos;t&&t.length>0&&(t=formatUnreadInfos(t),r.updateUnreads(t))})).catch((function(e){r.core.logger.error("qchatChannel:: autoSubscribeUnread error ",e)}))},e.cacheSubscribe=function cacheSubscribe(e){var t,r=this;forEach$1(t=e.channels).call(t,(function(t){var n=t.channelId?t.serverId+"_"+t.channelId:""+t.serverId,a=5===e.type?r.manualSubscribeTypingMap:4===e.type?r.manualSubscribeServerMap:r.manualSubscribeUnreadMap;e.opeType===nM.sub?a[n]=e.type:e.opeType===nM.unSub&&(a[n]=void 0)}))},e.cacheAutoSubscribe=function cacheAutoSubscribe(e){var t,r=this;forEach$1(t=e.channels).call(t,(function(t){var n=t.channelId?t.serverId+"_"+t.channelId:""+t.serverId,a=4===e.type?r.autoSubscribeServerMap:r.autoSubscribeUnreadMap;e.opeType===nM.sub?a[n]=e.type:e.opeType===nM.unSub&&(a[n]=void 0)}))},e.cacheUnreadCount=function cacheUnreadCount(e){var t=this;forEach$1(e).call(e,(function(e){var r=e.serverId+"_"+e.channelId;t.unreadCount[r]=Et({},e),t.unreadServerCount[e.serverId]||(t.unreadServerCount[e.serverId]={}),t.unreadServerCount[e.serverId][e.channelId]=!0}))},e.getServerUnreadInfo=function getServerUnreadInfo(e){var t,r=this,n={serverId:e,unreadCount:0,mentionedCount:0,maxCount:0},a=this.unreadServerCount[e];a&&(forEach$1(t=Nt(a)).call(t,(function(t){var a=e+"_"+t,i=r.unreadCount[a];n.unreadCount+=i.unreadCount,n.mentionedCount+=i.mentionedCount,void 0!==i.maxCount&&(n.maxCount=i.maxCount)})),n.unreadCount=n.unreadCount>n.maxCount?n.maxCount:n.unreadCount,n.mentionedCount=n.mentionedCount>n.maxCount?n.maxCount:n.mentionedCount);return n},e.getUnreadInfo=function getUnreadInfo(e){validate({serverId:{type:"string"},channelId:{type:"string"}},e);var t=e.serverId+"_"+e.channelId;return this.unreadCount[t]?this.unreadCount[t]:null},e.shouldChangeUnread=function shouldChangeUnread(e,t){if(!e.serverId||!e.channelId)return!1;if(this.core.qchatChannel.subscribeForVisitorService.isInSubscribeChannels(e.serverId,e.channelId))return!1;if(!1===e.historyEnable)return!1;if(!1===e.needBadge)return!1;if(e.fromAccount===this.core.account)return!1;if(t&&2!==(null==e?void 0:e.status))return!1;if(e.notifyReason&&e.notifyReason===getEnumKeyByEnumValue(K_,K_.notifySubscribe)){if(!e.serverId||!e.channelId)return!1;var r=this.getUnreadInfo({serverId:e.serverId,channelId:e.channelId}),n=t?"ackTimestamp":"lastMsgTime";if(!r)return!1;if(e.time&&r[n]&&r[n]>e.time)return!1}return!0},e.shouldChangeMentionedUnread=function shouldChangeMentionedUnread(e,t){return void 0===t&&(t=!1),__awaiter(this,void 0,void 0,Dl.mark((function _callee11(){var r,n;return Dl.wrap((function _callee11$(a){for(;;)switch(a.prev=a.next){case 0:if(!e.accidsOfMentionedRoles||!includes(r=e.accidsOfMentionedRoles).call(r,this.core.account)){a.next=2;break}return a.abrupt("return",!0);case 2:if(!e.mentionRoleIds||!e.serverId){a.next=16;break}if(this.serverRoleIdsMap[e.serverId]){a.next=9;break}if(t){a.next=7;break}return this.handledRoleMsg(e),a.abrupt("return",!1);case 7:return a.next=9,this.getRoleIdsByServerId([e.serverId]);case 9:n=0;case 10:if(!(n<e.mentionRoleIds.length)){a.next=16;break}if(!this.serverRoleIdsMap[e.serverId].roleIds.has(e.mentionRoleIds[n])){a.next=13;break}return a.abrupt("return",!0);case 13:n++,a.next=10;break;case 16:return a.abrupt("return",!1);case 17:case"end":return a.stop()}}),_callee11,this)})))},e.handledRoleMsg=function handledRoleMsg(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t,r,n,a,i,o=this;return Dl.wrap((function _callee12$(s){for(;;)switch(s.prev=s.next){case 0:if(e.mentionRoleIds){s.next=2;break}return s.abrupt("return");case 2:if(this.serverRoleIdsMap[e.serverId]){s.next=5;break}return s.next=5,this.getRoleIdsByServerId([e.serverId]);case 5:if(this.serverRoleIdsMap[e.serverId]){s.next=8;break}return this.core.logger.warn("QChatChannel::handledRoleMsg::can not get serverRoleIds,server id",e.serverId),s.abrupt("return");case 8:if(r=!1,forEach$1(t=e.mentionRoleIds).call(t,(function(t){o.serverRoleIdsMap[e.serverId].roleIds.has(t)&&(r=!0,o.core.logger.debug("QChatChannel::handledRoleMsg::will update message mentionedCountï¼message is ",e))})),r){s.next=12;break}return s.abrupt("return");case 12:if(n=this.unreadCount[e.serverId+"_"+e.channelId],a=2===(null==e?void 0:e.status),n.mentionedCount=a?n.mentionedCount?n.mentionedCount-1:0:n.mentionedCount?n.mentionedCount+1:1,"number"!=typeof n.maxCount){s.next=25;break}if(!((i=(i=n.mentionedCount)>n.maxCount?n.maxCount:i)>n.maxCount)){s.next=21;break}return this.core.logger.debug("QChatChannel::handledRoleMsg::tempUnreadCount more than maxCount"),s.abrupt("return");case 21:this.core.emit("unreadInfo",Et(Et({},n),{mentionedCount:i})),this.core.emit("unreadInfos",[Et(Et({},n),{mentionedCount:i})]),this.core.qchatChannel.emit("unreadInfos",[Et(Et({},n),{mentionedCount:i})]),this._serverUnreadInfo(e.serverId);case 25:case"end":return s.stop()}}),_callee12,this)})))},e.getMentionedFlag=function getMentionedFlag(e,t){return void 0===t&&(t=!1),__awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var r;return Dl.wrap((function _callee13$(n){for(;;)switch(n.prev=n.next){case 0:if(!e.mentionAll){n.next=4;break}return n.abrupt("return",!0);case 4:if(!e.mentionRoleIds&&!e.accidsOfMentionedRoles){n.next=10;break}return n.next=7,this.shouldChangeMentionedUnread(e,t);case 7:return n.abrupt("return",n.sent);case 10:if(!e.mentionAccids||!includes(r=e.mentionAccids).call(r,this.core.account)){n.next=12;break}return n.abrupt("return",!0);case 12:return n.abrupt("return",!1);case 13:case"end":return n.stop()}}),_callee13,this)})))},e.changeUnread=function changeUnread(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var r,n,a,i,o,s,c;return Dl.wrap((function _callee14$(l){for(;;)switch(l.prev=l.next){case 0:if(r=e.serverId,n=e.channelId,a=r+"_"+n,this.shouldChangeUnread(e,t)){l.next=6;break}return this.core.logger.debug("changeUnread: "+a+" does not need to update unreadInfo"),l.abrupt("return");case 6:if(this.unreadCount[a]){l.next=11;break}return l.next=9,this.core.qchatChannel.getChannelUnreadInfos({channels:[{serverId:r,channelId:n}]});case 9:return!this.serverRoleIdsMap[r]&&e.mentionRoleIds&&this.getRoleIdsByServerId([r]),l.abrupt("return");case 11:return i=this.unreadCount[a],o=2===(null==e?void 0:e.status),l.next=15,this.getMentionedFlag(e);case 15:if(s=l.sent,o?(i.unreadCount=i.unreadCount?i.unreadCount-1:0,s&&(i.mentionedCount=i.mentionedCount?i.mentionedCount-1:0),delete i.lastMsgTime,this.core.logger.debug("changeUnread: "+a+" unread reduce ",i)):(i.unreadCount=i.unreadCount?i.unreadCount+1:1,s&&(i.mentionedCount=i.mentionedCount?i.mentionedCount+1:1),e.time&&(i.lastMsgTime=e.time),this.core.logger.debug("changeUnread: "+a+" unread add ",i)),c="number"==typeof i.maxCount?i.maxCount:100,!(i.unreadCount>c)){l.next=21;break}return this.core.logger.debug("QChatChannel::subscribe::tempUnreadCount more than maxCount"),l.abrupt("return");case 21:this.core.logger.warn("unreadInfo event will abandon,please use unreadInfos"),this.core.emit("unreadInfo",Et(Et({},i),{mentionedCount:i.mentionedCount>c?c:i.mentionedCount,unreadCount:i.unreadCount>c?c:i.unreadCount})),this.core.emit("unreadInfos",[Et(Et({},i),{mentionedCount:i.mentionedCount>c?c:i.mentionedCount,unreadCount:i.unreadCount>c?c:i.unreadCount})]),this.core.qchatChannel.emit("unreadInfos",[Et(Et({},i),{mentionedCount:i.mentionedCount>c?c:i.mentionedCount,unreadCount:i.unreadCount>c?c:i.unreadCount})]),this._serverUnreadInfo(r);case 26:case"end":return l.stop()}}),_callee14,this)})))},e.updateUnreads=function updateUnreads(e){var t,r,n=this;if(e&&e.length>0){var a=[],i=[],o=map$6(t=filter(e).call(e,(function(e){var t=e.serverId+"_"+e.channelId,r=n.unreadCount[t],a=get(r,"ackTimestamp"),i=get(e,"ackTimestamp");return!(a&&i&&i<a)&&(get(r,"unreadCount")!==get(e,"unreadCount")||get(r,"mentionedCount")!==get(e,"mentionedCount"))}))).call(t,(function(e){a.push(n.getServerUnreadInfo(e.serverId)),i.push(n.unreadServerCount[e.serverId]);var t=e.serverId,r=e.channelId,o=t+"_"+r;return n.core.logger.debug("qchat channel updateUnread: ",e),n.unreadCount[o]=Et({},e),n.unreadServerCount[t]||(n.unreadServerCount[t]={}),n.unreadServerCount[t][r]=!0,e}));if(0!==o.length){this.core.emit("unreadInfos",o),this.core.qchatChannel.emit("unreadInfos",o);var s={};forEach$1(o).call(o,(function(e,t){n.core.emit("unreadInfo",e);var r=a[t],o=i[t],c=n.getServerUnreadInfo(e.serverId),l=n.unreadServerCount[e.serverId],d=r.unreadCount!==c.unreadCount,u=!o||0===Nt(o).length,p=l&&Nt(l).length>0,m=r.mentionedCount!==c.mentionedCount;(d||m||u&&p)&&(s[e.serverId]=!0)})),forEach$1(r=Nt(s)).call(r,(function(e){n.core.emit("serverUnreadInfo",n.getServerUnreadInfo(e)),get(n.core,"qchatServer.emit")&&n.core.qchatServer.emit("serverUnreadInfo",n.getServerUnreadInfo(e))}))}}},e.clearUnreadCountByServers=function clearUnreadCountByServers(e,t){var r=this,n=[];forEach$1(e).call(e,(function(e){var t;r.unreadServerCount[e]&&forEach$1(t=Nt(r.unreadServerCount[e])).call(t,(function(t){n.push(e+"_"+t)}))}));var a=[];forEach$1(n).call(n,(function(e){a.push(Et(Et({},r.unreadCount[e]),{unreadCount:0,mentionedCount:0,ackTimestamp:t}))})),this.updateUnreads(a)},UnreadInfoModuleService}(),iM=function(){function SubscribeForVisitorService(e){this.limitForBatchEnter=10,this.limitForBatchSubscribe=100,this.autoServers=new iv,this.autoVisitorSubscribeServer=new iv,this.autoVisitorSubscribeChannel=new iv,this.core=e}var e=SubscribeForVisitorService.prototype;return e.subscribeChannelAsVisitor=function subscribeChannelAsVisitor(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r,n,a,i=this;return Dl.wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.core.sendCmd("qchatSubscribeAsVisitor",{tag:{type:e.type||6,opeType:e.opeType},datas:e.channels});case 2:return r=o.sent,n=r.content.failedArr,a=filter(t=e.channels).call(t,(function(e){return!some(n).call(n,(function(t){return t.channelId===e.channelId&&t.serverId===e.serverId}))})),forEach$1(a).call(a,(function(t){1===e.opeType?i.autoVisitorSubscribeChannel.add(t.serverId+"&"+t.channelId):i.autoVisitorSubscribeChannel.delete(t.serverId+"&"+t.channelId)})),o.abrupt("return",{failedChannels:n});case 7:case"end":return o.stop()}}),_callee,this)})))},e.subscribeServerAsVisitor=function subscribeServerAsVisitor(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i,o,s=this;return Dl.wrap((function _callee2$(c){for(;;)switch(c.prev=c.next){case 0:return c.next=2,this.core.sendCmd("qchatSubscribeAsVisitor",{tag:{type:e.type||7,opeType:e.opeType},datas:map$6(t=e.serverIds).call(t,(function(e){return{serverId:e}}))});case 2:return a=c.sent,i=a.content.failedArr,o=filter(r=e.serverIds).call(r,(function(e){return!some(i).call(i,(function(t){return t.serverId===e}))})),forEach$1(o).call(o,(function(t){1===e.opeType?s.autoVisitorSubscribeServer.add(t):s.autoVisitorSubscribeServer.delete(t)})),c.abrupt("return",{failedServers:map$6(n=a.content.failedArr).call(n,(function(e){return e.serverId}))});case 7:case"end":return c.stop()}}),_callee2,this)})))},e.deleteServer=function deleteServer(e){var t;this.autoServers.delete(e),this.autoVisitorSubscribeServer.has(e)&&this.subscribeServerAsVisitor({opeType:2,serverIds:[e]});var r=[];forEach$1(t=this.autoVisitorSubscribeChannel).call(t,(function(t){if(0===indexOf(t).call(t,e)){var n=t.replace(e+"&","");r.push({serverId:e,channelId:n})}})),r.length>0&&this.subscribeChannelAsVisitor({opeType:2,channels:r})},e.deleteAutoSetInServerId=function deleteAutoSetInServerId(e){var t,r=this;this.autoServers.delete(e),this.autoVisitorSubscribeServer.delete(e),forEach$1(t=this.autoVisitorSubscribeChannel).call(t,(function(t){0===indexOf(t).call(t,e)&&r.autoVisitorSubscribeChannel.delete(t)}))},e.deleteAutoSetInChannel=function deleteAutoSetInChannel(e,t){this.autoVisitorSubscribeChannel.delete(e+"&"+t)},e.unSubscribeChannel=function unSubscribeChannel(e,t){this.subscribeChannelAsVisitor({opeType:2,channels:[{serverId:e,channelId:t}]})},e.isInSubscribeChannels=function isInSubscribeChannels(e,t){return this.autoVisitorSubscribeChannel.has(e+"&"+t)},e.isInAutoServers=function isInAutoServers(e){return this.autoServers.has(e)},e.doAutoSubscribe=function doAutoSubscribe(){var e=this,t=[],r=chunk(xl(this.autoVisitorSubscribeServer),this.limitForBatchSubscribe);forEach$1(r).call(r,(function(r){t.push(e.subscribeServerAsVisitor({opeType:1,serverIds:r}))}));var n=chunk(xl(this.autoVisitorSubscribeChannel),this.limitForBatchSubscribe);return forEach$1(n).call(n,(function(r){t.push(e.subscribeChannelAsVisitor({opeType:1,channels:map$6(r).call(r,(function(e){var t=indexOf(e).call(e,"&");return{serverId:slice(e).call(e,0,t),channelId:slice(e).call(e,t+1)}}))}))})),Pi.all(t)},e.doAutoEnterServer=function doAutoEnterServer(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var e,t,r,n=this;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return e=chunk(xl(this.autoServers),this.limitForBatchEnter),t=[],forEach$1(e).call(e,(function(e){t.push(n.core.qchatServer.enterAsVisitor({serverIds:e}))})),a.next=5,Pi.all(t);case 5:r=a.sent,forEach$1(r).call(r,(function(e){var t;forEach$1(t=e.failedServers).call(t,(function(e){n.deleteAutoSetInServerId(e)}))}));case 7:case"end":return a.stop()}}),_callee3,this)})))},e.resumeSubscribe=function resumeSubscribe(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=7;break}return t.next=3,this.doAutoEnterServer();case 3:return t.next=5,this.doAutoSubscribe();case 5:t.next=10;break;case 7:this.autoServers.clear(),this.autoVisitorSubscribeChannel.clear(),this.autoVisitorSubscribeServer.clear();case 10:case"end":return t.stop()}}),_callee4,this)})))},e.cacheServer=function cacheServer(e){var t=this;forEach$1(e).call(e,(function(e){return t.autoServers.add(e)}))},SubscribeForVisitorService}();function _createForOfIteratorHelperLoose$1(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray$1(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray$1(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray$1(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray$1(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var oM=function(e){function QChatChannelService(t,r){var n;return(n=e.call(this,"qchatChannel",t)||this).config={autoSubscribe:!1},n.core=t,registerParser({cmdMap:C_,cmdConfig:k_()}),r&&n.setOptions(r),n.subscribeModuleService=new aM(t),n.subscribeForVisitorService=new iM(t),n.setListener(),n}_t(QChatChannelService,e);var t=QChatChannelService.prototype;return t.setOptions=function setOptions(e){e&&(this.config=Et(this.config,e))},t.setListener=function setListener(){var e,t,r,n,a,i=this;this.core.eventBus.on("logined",(function(e){i.subscribeModuleService.resumeSubscribe(e.isAutoReconnect),i.subscribeForVisitorService.resumeSubscribe(e.isAutoReconnect),i.config.autoSubscribe&&(i.subscribeModuleService.autoSubscribeServerMap={},i.subscribeModuleService.autoSubscribeUnreadMap={},i.subscribeModuleService.autoSubscribe())})),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(function(e){i.subscribeModuleService.resumeSubscribe(e.isReconnect),i.subscribeForVisitorService.resumeSubscribe(e.isReconnect),i.config.autoSubscribe&&(i.subscribeModuleService.autoSubscribeServerMap={},i.subscribeModuleService.autoSubscribeUnreadMap={},i.subscribeModuleService.autoSubscribe())})),this.core.eventBus.on("qchatChannel/changeUnread",bind$1(e=this.subscribeModuleService.changeUnread).call(e,this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/updateUnreads",bind$1(t=this.subscribeModuleService.updateUnreads).call(t,this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/cacheSubscribe",bind$1(r=this.subscribeModuleService.cacheSubscribe).call(r,this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/clearUnreadCountByServers",bind$1(n=this.subscribeModuleService.clearUnreadCountByServers).call(n,this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/getRoleIdsByServerId",bind$1(a=this.subscribeModuleService.getRoleIdsByServerId).call(a,this.subscribeModuleService)),this.core.eventBus.on("qchatChannel/autoUnSubscribe",(function(e){if(i.logger.log("QChatChannel::enter autoUnSubscribe sysMsg is",e),e.type===Q_[Q_.channelVisibilityUpdate])i.logger.log("QChatChannel::begin autoUnSubscribe channel key is",e.serverId+"_"+e.channelId),i.subscribeModuleService._unSubscribeChannel(e.serverId,e.channelId),i.logger.log("QChatChannel::autoUnSubscribe channel done key is",e.serverId+"_"+e.channelId);else if(e.type===Q_[Q_.serverEnterLeave]){var t;(i.subscribeModuleService.manualSubscribeServerMap[e.serverId]||i.subscribeModuleService.autoSubscribeServerMap[e.serverId])&&(i.logger.log("QChatChannel::begin autoUnSubscribe server key is",e.serverId),i.subscribeModuleService._unSubscribeServer(e.serverId),i.logger.log("QChatChannel::autoUnSubscribe server done key is",e.serverId));var r=i.subscribeModuleService.unreadServerCount[e.serverId];if(!r)return;i.logger.log("QChatChannel::begin autoUnSubscribe channels key is",Nt(r)),forEach$1(t=Nt(r)).call(t,(function(t){i.subscribeModuleService._unSubscribeChannel(e.serverId,t)})),i.logger.log("QChatChannel::autoUnSubscribe channels done key is",Nt(r))}})),this.core.eventBus.on("qchatChannel/serverIdentifyChange",(function(e){i.subscribeModuleService.changeCacheServerRoleIds(e)}))},t.createChannel=function createChannel(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t;return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(y_)},name:{type:"string",required:!1},topic:{type:"string",required:!1},ext:{type:"string",required:!1},visitorMode:{type:"number",required:!1}},e),r.next=3,this.core.sendCmd("qchatCreateChannel",{channelInfo:Et(Et({},e),{type:y_[e.type]}),antispamTag:generateAntispamTag(e)});case 3:return t=r.sent,r.abrupt("return",formatChannel(t.content.channelInfo));case 5:case"end":return r.stop()}}),_callee,this)})))},t.deleteChannel=function deleteChannel(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return validate({channelId:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatDeleteChannel",e);case 3:case"end":return t.stop()}}),_callee2,this)})))},t.updateChannel=function updateChannel(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t,r;return Dl.wrap((function _callee3$(n){for(;;)switch(n.prev=n.next){case 0:return validate({channelId:{type:"string",min:1},serverId:{type:"string",required:!1},type:{type:"enum",values:getEnumKeys(y_),required:!1},name:{type:"string",required:!1},topic:{type:"string",required:!1},ext:{type:"string",required:!1},visitorMode:{type:"number",required:!1}},e),t=e,e.type&&(t.type=y_[e.type]),n.next=5,this.core.sendCmd("qchatUpdateChannel",{channelInfo:t,antispamTag:generateAntispamTag(e)});case 5:return r=n.sent,n.abrupt("return",formatChannel(r.content.channelInfo));case 7:case"end":return n.stop()}}),_callee3,this)})))},t.getChannels=function getChannels(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return validate({channelIds:{type:"array",itemType:"string",min:1}},e),r.next=3,this.core.sendCmd("qchatGetChannels",e);case 3:return t=r.sent,r.abrupt("return",formatChannels(t.content.channelList));case 5:case"end":return r.stop()}}),_callee4,this)})))},t.getChannelsByPage=function getChannelsByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t,r,n,a;return Dl.wrap((function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",min:1},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetChannelsByPage",{qchatGetChannelListPageTag:Et({limit:100},e)});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatChannels(n)});case 6:case"end":return i.stop()}}),_callee5,this)})))},t.getMembersByPage=function getMembersByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t,r,n,a;return Dl.wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetMembersByPage",{qchatGetMembersByPageTag:e});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatMembers$1(n)});case 6:case"end":return i.stop()}}),_callee6,this)})))},t.updateWhiteBlackRole=function updateWhiteBlackRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},roleId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(v_)},opeType:{type:"enum",values:getEnumKeys(f_)}},e),t.next=3,this.core.sendCmd("qchatUpdateWhiteBlackRole",{qchatUpdateWhiteBlackRoleTag:Et(Et({},e),{type:v_[e.type],opeType:f_[e.opeType]})});case 3:case"end":return t.stop()}}),_callee7,this)})))},t.getWhiteBlackRolesPage=function getWhiteBlackRolesPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t,r,n,a;return Dl.wrap((function _callee8$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(v_)},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetWhiteBlackRolesPage",{qchatGetWhiteBlackRolesPageTag:Et(Et({},e),{type:v_[e.type]})});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatRoles(n)});case 6:case"end":return i.stop()}}),_callee8,this)})))},t.updateWhiteBlackMembers=function updateWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){return Dl.wrap((function _callee9$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(v_)},opeType:{type:"enum",values:getEnumKeys(f_)},toAccids:{type:"array",itemType:"string",min:1}},e),t.next=3,this.core.sendCmd("qchatUpdateWhiteBlackMembers",{qchatUpdateWhiteBlackMembersTag:Et(Et({},e),{type:v_[e.type],opeType:f_[e.opeType],toAccids:bn(e.toAccids)})});case 3:case"end":return t.stop()}}),_callee9,this)})))},t.getWhiteBlackMembersPage=function getWhiteBlackMembersPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var t,r,n,a;return Dl.wrap((function _callee10$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(v_)},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetWhiteBlackMembersPage",{qchatGetWhiteBlackMembersPageTag:Et(Et({limit:100},e),{type:v_[e.type]})});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatMembers$1(n)});case 6:case"end":return i.stop()}}),_callee10,this)})))},t.getExistingWhiteBlackRoles=function getExistingWhiteBlackRoles(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){var t,r;return Dl.wrap((function _callee11$(n){for(;;)switch(n.prev=n.next){case 0:return validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(v_)},roleIds:{type:"array",itemType:"string",min:1}},e),n.next=3,this.core.sendCmd("qchatGetExistingWhiteBlackRoles",{qchatGetExistingWhiteBlackRolesTag:Et(Et({},e),{type:v_[e.type],roleIds:bn(e.roleIds)})});case 3:return t=n.sent,r=t.content.datas,n.abrupt("return",{datas:formatRoles(r)});case 6:case"end":return n.stop()}}),_callee11,this)})))},t.getExistingWhiteBlackMembers=function getExistingWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t,r;return Dl.wrap((function _callee12$(n){for(;;)switch(n.prev=n.next){case 0:return validate({serverId:{type:"string",min:1},channelId:{type:"string",min:1},type:{type:"enum",values:getEnumKeys(v_)},accids:{type:"array",itemType:"string",min:1}},e),n.next=3,this.core.sendCmd("qchatGetExistingWhiteBlackMembers",{qchatGetExistingWhiteBlackMembersTag:Et(Et({},e),{type:v_[e.type],accids:bn(e.accids)})});case 3:return t=n.sent,r=t.content.datas,n.abrupt("return",{datas:formatMembers$1(r)});case 6:case"end":return n.stop()}}),_callee12,this)})))},t.updateCategoryInfoOfChannel=function updateCategoryInfoOfChannel(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var t;return Dl.wrap((function _callee13$(r){for(;;)switch(r.prev=r.next){case 0:return validate({channelId:{type:"string",min:1},categoryId:{type:"string",allowEmpty:!1,required:!1},syncMode:{type:"number",min:0,max:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateCategoryInfoOfChannel",{qchatUpdateCategoryInfoOfChannelTag:e});case 3:return t=r.sent,r.abrupt("return",formatChannel(t.content.channelInfo));case 5:case"end":return r.stop()}}),_callee13,this)})))},t.createChannelCategory=function createChannelCategory(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var t;return Dl.wrap((function _callee14$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},name:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",required:!1},viewMode:{type:"number",min:0,max:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatCreateChannelCategory",{qchatCreateChannelCategoryTag:e});case 3:return t=r.sent,r.abrupt("return",formatChannelCategory(t.content.QChatChannelCategoryInfo));case 5:case"end":return r.stop()}}),_callee14,this)})))},t.removeChannelCategory=function removeChannelCategory(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){return Dl.wrap((function _callee15$(t){for(;;)switch(t.prev=t.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatRemoveChannelCategory",e);case 3:case"end":return t.stop()}}),_callee15,this)})))},t.updateChannelCategory=function updateChannelCategory(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var t;return Dl.wrap((function _callee16$(r){for(;;)switch(r.prev=r.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1},name:{type:"string",allowEmpty:!1,required:!1},ext:{type:"string",required:!1},viewMode:{type:"number",min:0,max:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateChannelCategory",{qchatUpdateChannelCategoryTag:e});case 3:return t=r.sent,r.abrupt("return",formatChannelCategory(t.content.QChatChannelCategoryInfo));case 5:case"end":return r.stop()}}),_callee16,this)})))},t.getChannelCategoriesByID=function getChannelCategoriesByID(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee17(){var t;return Dl.wrap((function _callee17$(r){for(;;)switch(r.prev=r.next){case 0:return validate({categoryIds:{type:"array",itemType:"string",min:1}},e),r.next=3,this.core.sendCmd("qchatGetChannelCategoriesByID",e);case 3:return t=r.sent,r.abrupt("return",formatChannelCategorys(t.content.channelCategoryList));case 5:case"end":return r.stop()}}),_callee17,this)})))},t.updateChannelCategoryWhiteBlackRole=function updateChannelCategoryWhiteBlackRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){return Dl.wrap((function _callee18$(t){for(;;)switch(t.prev=t.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(v_)},opeType:{type:"enum",values:getEnumKeys(f_)},roleId:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatUpdateChannelCategoryWhiteBlackRole",{qchatUpdateChannelCategoryWhiteBlackRoleTag:Et(Et({},e),{type:v_[e.type],opeType:f_[e.opeType]})});case 3:case"end":return t.stop()}}),_callee18,this)})))},t.getChannelCategoryWhiteBlackRolesPage=function getChannelCategoryWhiteBlackRolesPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){var t,r,n,a;return Dl.wrap((function _callee19$(i){for(;;)switch(i.prev=i.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(v_)},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetChannelCategoryWhiteBlackRolesPage",{qchatGetChannelCategoryWhiteBlackRolesPageTag:Et(Et({},e),{type:v_[e.type]})});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatRoles(n)});case 6:case"end":return i.stop()}}),_callee19,this)})))},t.updateChannelCategoryWhiteBlackMembers=function updateChannelCategoryWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){return Dl.wrap((function _callee20$(t){for(;;)switch(t.prev=t.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(v_)},opeType:{type:"enum",values:getEnumKeys(f_)},toAccids:{type:"array",itemType:"string",min:1}},e),t.next=3,this.core.sendCmd("qchatUpdateChannelCategoryWhiteBlackMembers",{qchatUpdateChannelCategoryWhiteBlackMembersTag:Et(Et({},e),{type:v_[e.type],opeType:f_[e.opeType],toAccids:bn(e.toAccids)})});case 3:case"end":return t.stop()}}),_callee20,this)})))},t.getChannelCategoryWhiteBlackMembersPage=function getChannelCategoryWhiteBlackMembersPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){var t,r,n,a;return Dl.wrap((function _callee21$(i){for(;;)switch(i.prev=i.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(v_)},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetChannelCategoryWhiteBlackMembersPage",{qchatGetChannelCategoryWhiteBlackMembersPageTag:Et(Et({},e),{type:v_[e.type]})});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatMembers$1(n)});case 6:case"end":return i.stop()}}),_callee21,this)})))},t.getChannelCategoryWhiteBlackRoles=function getChannelCategoryWhiteBlackRoles(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee22(){var t,r;return Dl.wrap((function _callee22$(n){for(;;)switch(n.prev=n.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(v_)},roleIds:{type:"array",itemType:"string",min:1}},e),n.next=3,this.core.sendCmd("qchatGetChannelCategoryWhiteBlackRoles",{qchatGetChannelCategoryWhiteBlackRolesTag:Et(Et({},e),{type:v_[e.type],roleIds:bn(e.roleIds)})});case 3:return t=n.sent,r=t.content.datas,n.abrupt("return",formatRoles(r));case 6:case"end":return n.stop()}}),_callee22,this)})))},t.getChannelCategoryWhiteBlackMembers=function getChannelCategoryWhiteBlackMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee23(){var t,r;return Dl.wrap((function _callee23$(n){for(;;)switch(n.prev=n.next){case 0:return validate({categoryId:{type:"string",allowEmpty:!1},serverId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(v_)},accids:{type:"array",itemType:"string",min:1}},e),n.next=3,this.core.sendCmd("qchatGetChannelCategoryWhiteBlackMembers",{qchatGetChannelCategoryWhiteBlackMembersTag:Et(Et({},e),{type:v_[e.type],accids:bn(e.accids)})});case 3:return t=n.sent,r=t.content.datas,n.abrupt("return",formatMembers$1(r));case 6:case"end":return n.stop()}}),_callee23,this)})))},t.getChannelCategoriesPage=function getChannelCategoriesPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee24(){var t,r,n,a;return Dl.wrap((function _callee24$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetChannelCategoriesPage",{qchatGetChannelCategoriesPageTag:e});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatChannelCategorys(n)});case 6:case"end":return i.stop()}}),_callee24,this)})))},t.getChannelCategoryChannelsPage=function getChannelCategoryChannelsPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee25(){var t,r,n,a;return Dl.wrap((function _callee25$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetChannelCategoryChannelsPage",{qchatGetChannelCategoryChannelsPageTag:e});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatChannels(n)});case 6:case"end":return i.stop()}}),_callee25,this)})))},t.subscribeChannel=function subscribeChannel(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee26(){var t,r;return Dl.wrap((function _callee26$(n){for(;;)switch(n.prev=n.next){case 0:if(validate({type:{type:"number",min:1,max:5},opeType:{type:"number",min:1,max:2}},e),!this.config.autoSubscribe||e.isInternalTrigger||5===e.type){n.next=3;break}throw new Rl("subscribe server failed, manual subscribe is not allowed in auto subscribe mode",{},403);case 3:return n.next=5,this.subscribeModuleService.subscribe(e);case 5:if((t=n.sent).unreadInfos=formatUnreadInfos(t.unreadInfos),5!==e.type){n.next=10;break}return this.subscribeModuleService.cacheSubscribe(e),n.abrupt("return");case 10:return 1===e.opeType&&(e.channels=map$6(r=t.unreadInfos).call(r,(function(e){return{serverId:e.serverId,channelId:e.channelId}}))),this.logger.debug("QChatChannel::subscribeChannel:: cacheSubscribe ",e),this.config.autoSubscribe?this.subscribeModuleService.cacheAutoSubscribe(e):this.subscribeModuleService.cacheSubscribe(e),this.subscribeModuleService.updateUnreads(t.unreadInfos),n.abrupt("return",t);case 15:case"end":return n.stop()}}),_callee26,this)})))},t.getChannelUnreadInfos=function getChannelUnreadInfos(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee27(){var t,r;return Dl.wrap((function _callee27$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.core.sendCmd("qchatGetUnreadInfo",e);case 2:return t=n.sent,r=formatUnreadInfos(t.content.unreadInfos),this.subscribeModuleService.updateUnreads(r),n.abrupt("return",r);case 6:case"end":return n.stop()}}),_callee27,this)})))},t.getChannelSearchByPage=function getChannelSearchByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee28(){var t,r,n,a;return Dl.wrap((function _callee28$(i){for(;;)switch(i.prev=i.next){case 0:if(validate({keyword:{type:"string",allowEmpty:!1},startTime:{type:"number",min:0,required:!1},endTime:{type:"number",min:1,required:!1},order:{type:"enum",values:getEnumKeys(__),required:!1},limit:{type:"number",min:1,required:!1},serverId:{type:"string",required:!1},sort:{type:"enum",values:getEnumKeys(g_),required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),!(e.startTime&&e.endTime&&e.startTime>=e.endTime)){i.next=3;break}throw new Tl("startTime more than endTime",e,"timeRule");case 3:return i.next=5,this.core.sendCmd("qchatGetChannelSearchByPage",{qchatGetChannelSearchByPageTag:Et(Et({},e),{order:e.order&&__[e.order],sort:sort(e)&&g_[sort(e)]})});case 5:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag),cursor:a.cursor},datas:formatChannels(n)});case 8:case"end":return i.stop()}}),_callee28,this)})))},t.channelMemberSearch=function channelMemberSearch(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee29(){var t;return Dl.wrap((function _callee29$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},keyword:{type:"string",allowEmpty:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatChannelMemberSearch",{qchatChannelMemberSearchTag:e});case 3:return t=r.sent,r.abrupt("return",formatChannelMembers(t.content.datas));case 5:case"end":return r.stop()}}),_callee29,this)})))},t.subscribeAsVisitor=function subscribeAsVisitor(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee30(){return Dl.wrap((function _callee30$(t){for(;;)switch(t.prev=t.next){case 0:return validate({opeType:{type:"number",min:1,max:2},type:{type:"number",required:!1},channels:{type:"array",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1}},min:1}},e),t.next=3,this.subscribeForVisitorService.subscribeChannelAsVisitor(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee30,this)})))},t.qchatAutoSubscribeNotificationHandler=function qchatAutoSubscribeNotificationHandler(e){var t=formatUnreadInfos(e.content.unreadInfos),r=e.content.serverIds;this.subscribeModuleService.updateUnreads(t);var n=[];if(r.length){var a={opeType:1};a.channels=map$6(r).call(r,(function(e){return{serverId:e.serverId,channelId:""}})),a.type=4,n.push(a)}if(t.length){var i={opeType:1};i.channels=map$6(t).call(t,(function(e){return{serverId:e.serverId,channelId:e.channelId}})),i.type=1,n.push(i)}if(n.length)for(var o,s=_createForOfIteratorHelperLoose$1(n);!(o=s()).done;){var c=o.value;this.subscribeModuleService.cacheAutoSubscribe(c)}},QChatChannelService}(T_),sM={serverId:{type:"string"},uid:{type:"string"},accid:{type:"string"},nick:{type:"string"},avatar:{type:"string"},ext:{type:"string"},type:{type:"number"},joinTime:{type:"number"},inviter:{type:"string"},validFlag:{type:"boolean"},createTime:{type:"number"},updateTime:{type:"number"}},cM={limit:{type:"number"}};function formatMembers(e){return En(e)&&e.length>0?map$6(e).call(e,(function(e){return function formatMember(e){return format(sM,e)}(e)})):[]}function formatRTCChannelConfig(e){try{e.audio&&(e.audio=JSON.parse(e.audio))}catch(e){throw new Tl('result "audio" JSON parse error',{key:"audio"},"JSON parse error")}try{e.video&&(e.video=JSON.parse(e.video))}catch(e){throw new Tl('result "video" JSON parse error',{key:"video"},"JSON parse error")}return format(cM,e)}var lM,dM={"25_1":"qchatGetNeroomToken","25_2":"qchatUpdateRTCChannelConfig","25_3":"qchatGetRTCChannelConfig","25_4":"qchatGetRTCChannelMembers"},uM={QChatRTCChannelConfigTag:{serverId:1,channelId:2,limit:3,audio:4,video:5},QChatRTCChannelConfigResultTag:{limit:1,audio:2,video:3},QChatGetRTCParams:{serverId:1,channelId:2},qchatGetRTCChannelMembersTag:{serverId:1,channelId:2},memberInfo:{serverId:1,accid:3,nick:4,avatar:5,ext:6,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},QChatGetNeroomTokenResultTag:{token:1,expire:2},QChatGetNeroomTokenParams:{neroomDeviceId:1}},pM=function getCmdConfig(){var e=function getDeserializeTag(){return invertSerializeMap(uM)}();return{qchatGetNeroomToken:{sid:25,cid:1,service:"qchatMedia",params:[{type:"Property",name:"qchatGetNeroomTokenTag",reflectMapper:uM.QChatGetNeroomTokenParams}],response:[{type:"Property",name:"neroomToken",reflectMapper:e.QChatGetNeroomTokenResultTag}]},qchatUpdateRTCChannelConfig:{sid:25,cid:2,service:"qchatMedia",params:[{type:"Property",name:"RTCChannelConfig",reflectMapper:uM.QChatRTCChannelConfigTag}]},qchatGetRTCChannelConfig:{sid:25,cid:3,service:"qchatMedia",params:[{type:"Property",name:"qchatGetRTCChannelConfigTag",reflectMapper:uM.QChatGetRTCParams}],response:[{type:"Property",name:"RTCChannelConfig",reflectMapper:e.QChatRTCChannelConfigResultTag}]},qchatGetRTCChannelMembers:{sid:25,cid:4,service:"qchatMedia",params:[{type:"Property",name:"qchatGetRTCChannelMembersTag",reflectMapper:uM.QChatGetRTCParams}],response:[{type:"PropertyArray",name:"memberList",reflectMapper:e.memberInfo}]}}},mM=function(e){function QChatMediaService(t,r){var n;return(n=e.call(this,"qchatMedia",t)||this).config={},n.tokenExpireTime=24e4,n.getTokenState=!1,n.core=t,registerParser({cmdMap:dM,cmdConfig:pM()}),r&&n.setOptions(r),n.setListener(),n.tokenExpireTime=24e4,n.channelId="",n.serverId="",n}_t(QChatMediaService,e);var t=QChatMediaService.prototype;return t.setOptions=function setOptions(e){e&&(this.config=Et(this.config,e),(null==e?void 0:e.neroom)&&this.setNeroom(e.neroom))},t.setNeroom=function setNeroom(e){this.neroom=new e},t.setListener=function setListener(){var e,t,r,n,a=this;this.core.eventBus.on("disconnect",bind$1(e=this._existRomm).call(e,this)),this.core.eventBus.on("kicked",bind$1(t=this._existRomm).call(t,this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLogout",bind$1(r=this._existRomm).call(r,this)),this.core.eventBus.on("V2NIMLoginService/loginLifeCycleKicked",bind$1(n=this._existRomm).call(n,this)),this.core.eventBus.on("qchatMedia/serverOrChannelLeave",(function(e){return __awaiter(a,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:if(!(e.type===Q_[Q_.channelVisibilityUpdate]&&e.channelId===this.channelId||e.type===Q_[Q_.serverEnterLeave]&&e.serverId===this.serverId)){t.next=4;break}if(!this.roomContext||!this.roomContext.roomUuid){t.next=4;break}return t.next=4,this.disconnectChannel();case 4:case"end":return t.stop()}}),_callee,this)})))}))},t._existRomm=function _existRomm(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(e){for(;;)switch(e.prev=e.next){case 0:if(!this.roomContext){e.next=3;break}return e.next=3,this.disconnectChannel();case 3:this.tokenTimer&&(this.core.timerManager.deleteTimer(this.tokenTimer),this.tokenTimer=void 0);case 4:case"end":return e.stop()}}),_callee2,this)})))},t._checkPermission=function _checkPermission(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.core.qchatRole.checkPermission(e);case 2:return t=r.sent,r.abrupt("return",t);case 4:case"end":return r.stop()}}),_callee3,this)})))},t._checkConnectState=function _checkConnectState(){if("connect"!==this.state)throw new Rl("QChatMedia::you should connect first")},t.kickMemberOut=function kickMemberOut(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),r.prev=2,r.next=5,null===(t=this.roomContext)||void 0===t?void 0:t.kickMemberOut(e.accid);case 5:r.next=11;break;case 7:throw r.prev=7,r.t0=r.catch(2),this.logger.error("QChatMedia::kickMemberOut error params is "+bn(e),r.t0),new Rl("QChatMedia::kickMemberOut error",r.t0);case 11:case"end":return r.stop()}}),_callee4,this,[[2,7]])})))},t.disconnectChannel=function disconnectChannel(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(t){for(;;)switch(t.prev=t.next){case 0:return this.logger.debug("QChatMedia::disconnect begin disconnect"),t.prev=1,t.next=4,null===(e=this.roomContext)||void 0===e?void 0:e.leaveRoom();case 4:t.next=9;break;case 6:t.prev=6,t.t0=t.catch(1),this.logger.error("QChatMedia::disconnect error",t.t0);case 9:if(!this.authService){t.next=12;break}return t.next=12,this.authService.logout();case 12:this._setStateInit(),this.core.emit("qchatMediaDisconnect"),this.core.qchatMedia.emit("qchatMediaDisconnect");case 15:case"end":return t.stop()}}),_callee5,this,[[1,6]])})))},t._setStateInit=function _setStateInit(){this.logger.debug("QChatMedia::disconnect end"),this.roomContext=void 0,this.rtcController=void 0,this.state="init",this.tokenTimer&&(this.core.timerManager.deleteTimer(this.tokenTimer),this.tokenTimer=void 0),this.channelId="",this.serverId=""},t.muteAudio=function muteAudio(e){var t,r,n,a,i;return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var o;return Dl.wrap((function _callee6$(s){for(;;)switch(s.prev=s.next){case 0:if(this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),(null===(t=this.roomContext)||void 0===t?void 0:t.localMember.uuid)!==e.accid){s.next=14;break}return s.prev=3,s.next=6,null===(r=this.rtcController)||void 0===r?void 0:r.muteMyAudio();case 6:s.next=12;break;case 8:throw s.prev=8,s.t0=s.catch(3),this.logger.error("QChatMedia::muteAudio error",s.t0),new Rl("QChatMedia::muteAudio error",s.t0);case 12:case 25:s.next=31;break;case 14:if(s.prev=14,!(o=null===(n=this.roomContext)||void 0===n?void 0:n.roomProperties.audioOff)||"offNotAllowSelfOn"!==(null===(a=o.value)||void 0===a?void 0:a.split("_")[0])){s.next=23;break}return s.next=19,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"});case 19:if(s.sent){s.next=23;break}return this.logger.error("QChatMedia::unMuteAudio not allow open auido"),s.abrupt("return");case 23:return s.next=25,null===(i=this.rtcController)||void 0===i?void 0:i.muteMemberAudio(e.accid);case 27:throw s.prev=27,s.t1=s.catch(14),this.logger.error("QChatMedia::muteAudio error params is "+bn(e),s.t1),new Rl("QChatMedia::muteAudio error",s.t1);case 31:case"end":return s.stop()}}),_callee6,this,[[3,8],[14,27]])})))},t.unMuteAudio=function unMuteAudio(e){var t,r,n,a,i;return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var o;return Dl.wrap((function _callee7$(s){for(;;)switch(s.prev=s.next){case 0:if(this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),!(o=null===(t=this.roomContext)||void 0===t?void 0:t.roomProperties.audioOff)||"offNotAllowSelfOn"!==(null===(r=o.value)||void 0===r?void 0:r.split("_")[0])){s.next=10;break}return s.next=6,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"});case 6:if(s.sent){s.next=10;break}return this.logger.error("QChatMedia::unMuteAudio not allow open auido"),s.abrupt("return");case 10:if((null===(n=this.roomContext)||void 0===n?void 0:n.localMember.uuid)!==e.accid){s.next=22;break}return s.prev=11,s.next=14,null===(a=this.rtcController)||void 0===a?void 0:a.unmuteMyAudio();case 14:s.next=20;break;case 16:throw s.prev=16,s.t0=s.catch(11),this.logger.error("QChatMedia::unMuteAudio error",s.t0),new Rl("QChatMedia::unMuteAudio error",s.t0);case 20:case 25:s.next=31;break;case 22:return s.prev=22,s.next=25,null===(i=this.rtcController)||void 0===i?void 0:i.unmuteMemberAudio(e.accid);case 27:throw s.prev=27,s.t1=s.catch(22),this.logger.error("QChatMedia::unMuteAudio error params is "+bn(e),s.t1),new Rl("QChatMedia::unMuteAudio error",s.t1);case 31:case"end":return s.stop()}}),_callee7,this,[[11,16],[22,27]])})))},t.muteVideo=function muteVideo(e){var t,r,n,a,i;return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var o;return Dl.wrap((function _callee8$(s){for(;;)switch(s.prev=s.next){case 0:if(this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),(null===(t=this.roomContext)||void 0===t?void 0:t.localMember.uuid)!==e.accid){s.next=14;break}return s.prev=3,s.next=6,null===(r=this.rtcController)||void 0===r?void 0:r.muteMyVideo();case 6:s.next=12;break;case 8:throw s.prev=8,s.t0=s.catch(3),this.logger.error("QChatMedia::muteVideo error",s.t0),new Rl("QChatMedia::muteVideo error",s.t0);case 12:case 25:s.next=31;break;case 14:if(s.prev=14,!(o=null===(n=this.roomContext)||void 0===n?void 0:n.roomProperties.videoOff)||"offNotAllowSelfOn"!==(null===(a=o.value)||void 0===a?void 0:a.split("_")[0])){s.next=23;break}return s.next=19,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"});case 19:if(s.sent){s.next=23;break}return this.logger.error("QChatMedia::unMuteVideo not allow open video"),s.abrupt("return");case 23:return s.next=25,null===(i=this.rtcController)||void 0===i?void 0:i.muteMemberVideo(e.accid);case 27:throw s.prev=27,s.t1=s.catch(14),this.logger.error("QChatMedia::muteVideo error params is "+bn(e),s.t1),new Rl("QChatMedia::muteVideo error",s.t1);case 31:case"end":return s.stop()}}),_callee8,this,[[3,8],[14,27]])})))},t.unMuteVideo=function unMuteVideo(e){var t,r,n,a,i;return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var o;return Dl.wrap((function _callee9$(s){for(;;)switch(s.prev=s.next){case 0:if(this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),!(o=null===(t=this.roomContext)||void 0===t?void 0:t.roomProperties.videoOff)||"offNotAllowSelfOn"!==(null===(r=o.value)||void 0===r?void 0:r.split("_")[0])){s.next=10;break}return s.next=6,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"});case 6:if(s.sent){s.next=10;break}return this.logger.error("QChatMedia::unMuteVideo not allow open video"),s.abrupt("return");case 10:if((null===(n=this.roomContext)||void 0===n?void 0:n.localMember.uuid)!==e.accid){s.next=22;break}return s.prev=11,s.next=14,null===(a=this.rtcController)||void 0===a?void 0:a.unmuteMyVideo();case 14:s.next=20;break;case 16:throw s.prev=16,s.t0=s.catch(11),this.logger.error("QChatMedia::unMuteVideo error",s.t0),new Rl("QChatMedia::unMuteVideo error",s.t0);case 20:s.next=30;break;case 22:s.prev=22,null===(i=this.rtcController)||void 0===i||i.unmuteMemberVideo(e.accid),s.next=30;break;case 26:throw s.prev=26,s.t1=s.catch(22),this.logger.error("QChatMedia::unMuteVideo error",s.t1),new Rl("QChatMedia::unMuteVideo error",s.t1);case 30:case"end":return s.stop()}}),_callee9,this,[[11,16],[22,26]])})))},t.startScreenShare=function startScreenShare(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){return Dl.wrap((function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:this._checkConnectState(),t.prev=1,null===(e=this.rtcController)||void 0===e||e.startScreenShare(),t.next=9;break;case 5:throw t.prev=5,t.t0=t.catch(1),this.logger.error("QChatMedia::startScreenShare error",t.t0),new Rl("QChatMedia::startScreenShare error",t.t0);case 9:case"end":return t.stop()}}),_callee10,this,[[1,5]])})))},t.stopScreenShare=function stopScreenShare(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:this._checkConnectState(),t.prev=1,null===(e=this.rtcController)||void 0===e||e.stopScreenShare(),t.next=9;break;case 5:throw t.prev=5,t.t0=t.catch(1),this.logger.error("QChatMedia::stopScreenShare error",t.t0),new Rl("QChatMedia::stopScreenShare error",t.t0);case 9:case"end":return t.stop()}}),_callee11,this,[[1,5]])})))},t.stopMemberScreenShare=function stopMemberScreenShare(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){return Dl.wrap((function _callee12$(r){for(;;)switch(r.prev=r.next){case 0:this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),r.prev=2,null===(t=this.rtcController)||void 0===t||t.stopMemberScreenShare(e.accid),r.next=10;break;case 6:throw r.prev=6,r.t0=r.catch(2),this.logger.error("QChatMedia::stopMemberScreenShare error",r.t0),new Rl("QChatMedia::stopMemberScreenShare error",r.t0);case 10:case"end":return r.stop()}}),_callee12,this,[[2,6]])})))},t.subscribeRemoteVideoStream=function subscribeRemoteVideoStream(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){return Dl.wrap((function _callee13$(r){for(;;)switch(r.prev=r.next){case 0:this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1},streamType:{type:"number",allowEmpty:!1,min:0,max:1}},e),r.prev=2,null===(t=this.rtcController)||void 0===t||t.subscribeRemoteVideoStream(e.accid,e.streamType),r.next=10;break;case 6:throw r.prev=6,r.t0=r.catch(2),this.logger.error("QChatMedia::subscribeRemoteVideoStream error",r.t0),new Rl("QChatMedia::subscribeRemoteVideoStream error",r.t0);case 10:case"end":return r.stop()}}),_callee13,this,[[2,6]])})))},t.unSubscribeRemoteVideoStream=function unSubscribeRemoteVideoStream(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){return Dl.wrap((function _callee14$(r){for(;;)switch(r.prev=r.next){case 0:this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1},streamType:{type:"number",allowEmpty:!1,min:0,max:1}},e),r.prev=2,null===(t=this.rtcController)||void 0===t||t.unsubscribeRemoteVideoStream(e.accid,e.streamType),r.next=10;break;case 6:throw r.prev=6,r.t0=r.catch(2),this.logger.error("QChatMedia::unSubscribeRemoteVideoStream error",r.t0),new Rl("QChatMedia::unSubscribeRemoteVideoStream error",r.t0);case 10:case"end":return r.stop()}}),_callee14,this,[[2,6]])})))},t.setupVideoCanvas=function setupVideoCanvas(e){var t;if(this._checkConnectState(),(null===(t=this.roomContext)||void 0===t?void 0:t.localMember.uuid)===e.accid)try{return this.rtcController.setupLocalVideoCanvas(e.videoView)}catch(e){throw this.logger.error("QChatMedia::setupVideoCanvas error",e),new Rl("QChatMedia::setupVideoCanvas error",e)}else try{return this.rtcController.setupRemoteVideoCanvas(e.videoView,e.accid)}catch(e){throw this.logger.error("QChatMedia::setupVideoCanvas error",e),new Rl("QChatMedia::setupVideoCanvas error",e)}},t.setupRemoteVideoSubStreamCanvas=function setupRemoteVideoSubStreamCanvas(e){this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e);try{return this.rtcController.setupRemoteVideoSubStreamCanvas(e.videoView,e.accid)}catch(e){throw this.logger.error("QChatMedia::setupRemoteVideoSubStreamCanvas error",e),new Rl("QChatMedia::setupRemoteVideoSubStreamCanvas error",e)}},t.getScreenSharingUserUuid=function getScreenSharingUserUuid(){this._checkConnectState();try{return this.rtcController.getScreenSharingUserUuid()}catch(e){throw this.logger.error("QChatMedia::getScreenSharingUserUuid error",e),new Rl("QChatMedia::getScreenSharingUserUuid error",e)}},t.initQChatMedia=function initQChatMedia(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){return Dl.wrap((function _callee15$(t){for(;;)switch(t.prev=t.next){case 0:if(this.neroom){t.next=3;break}return this.logger.warn("QChatMedia::init::you should import neroom SDK"),t.abrupt("return");case 3:if(void 0===this.state){t.next=6;break}return this.logger.error("QChatMedia::init::you already init QChatMedia"),t.abrupt("return");case 6:t.prev=6,this.neroom.initialize({appKey:this.core.options.appkey,serverConfig:e.serverConfig}),t.next=14;break;case 10:throw t.prev=10,t.t0=t.catch(6),this.logger.error("QChatMedia::initQChatMedia error",t.t0),new Rl("QChatMedia::initQChatMedia error",t.t0);case 14:this.authService=this.neroom.authService,this.roomService=this.neroom.roomService,this.messageChannelService=this.neroom.messageChannelService,this.state="init";case 18:case"end":return t.stop()}}),_callee15,this,[[6,10]])})))},t.loginByIM=function loginByIM(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var t,r;return Dl.wrap((function _callee16$(n){for(;;)switch(n.prev=n.next){case 0:if("init"===this.state){n.next=3;break}return this.logger.error("QChatMedia::connect::you should init before login"),n.abrupt("return");case 3:return n.next=5,this._getToken();case 5:return t=n.sent,r=get(this.core,"options.token")||get(this.core,"V2NIMLoginService.token"),n.prev=7,n.next=10,null===(e=this.authService)||void 0===e?void 0:e.loginByIM(this.core.account,t,r);case 10:n.next=16;break;case 12:throw n.prev=12,n.t0=n.catch(7),this.logger.error("QChatMedia::loginByIM error",n.t0),new Rl("QChatMedia::loginByIM error",n.t0);case 16:this.state="login";case 17:case"end":return n.stop()}}),_callee16,this,[[7,12]])})))},t._getToken=function _getToken(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){var t,r,n,a,i=this;return Dl.wrap((function _callee18$(o){for(;;)switch(o.prev=o.next){case 0:return this.logger.log("QChatMedia::getToken begin getToken"),o.next=3,this.core.sendCmd("qchatGetNeroomToken",{qchatGetNeroomTokenTag:{neroomDeviceId:null===(e=this.neroom)||void 0===e?void 0:e.deviceId}});case 3:return t=o.sent,r=t.content.neroomToken,n=r.token,a=r.expire,this.logger.log("QChatMedia::getToken success token is "+n+",expire is "+a+" "),this.tokenTimer||(this.logger.debug("QChatMedia::getToken set token timer,expire is "+(1e3*a-this.tokenExpireTime)+" "),this.tokenTimer=this.core.timerManager.addTimer((function(){return __awaiter(i,void 0,void 0,Dl.mark((function _callee17(){var e;return Dl.wrap((function _callee17$(t){for(;;)switch(t.prev=t.next){case 0:return this.tokenTimer&&this.core.timerManager.deleteTimer(this.tokenTimer),this.tokenTimer=void 0,t.next=4,this._getToken();case 4:e=t.sent,this.authService&&this.authService.renewToken(e);case 6:case"end":return t.stop()}}),_callee17,this)})))}),1e3*a-this.tokenExpireTime)),o.abrupt("return",n);case 8:case"end":return o.stop()}}),_callee18,this)})))},t.connectChannel=function connectChannel(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){var n;return Dl.wrap((function _callee19$(a){for(;;)switch(a.prev=a.next){case 0:if(void 0!==this.state){a.next=3;break}return this.logger.error("QChatMedia::connect::you should init before login"),a.abrupt("return");case 3:if("init"!==this.state){a.next=6;break}return a.next=6,this.loginByIM();case 6:return this.serverId=e.serverId,this.channelId=e.channelId,a.prev=8,a.next=11,null===(t=this.roomService)||void 0===t?void 0:t.joinRoom({roomUuid:e.channelId,role:"qchatAudience",userName:this.core.account,initialProperties:{}},{});case 11:a.next=17;break;case 13:throw a.prev=13,a.t0=a.catch(8),this.logger.error("QChatMedia::connectChannel error",a.t0),new Rl("QChatMedia::connectChannel error",a.t0);case 17:if(!(n=null===(r=this.roomService)||void 0===r?void 0:r.getRoomContext(e.channelId))){a.next=28;break}return this.roomContext=n,this.rtcController=this.roomContext.rtcController,this.state="connect",a.next=24,this.rtcController.joinRtcChannel();case 24:this.core.emit("connectChannel"),this.core.qchatMedia.emit("connectChannel"),a.next=29;break;case 28:this.logger.error("QChatMedia::connect room not exited");case 29:case"end":return a.stop()}}),_callee19,this,[[8,13]])})))},t.updateRTCChannelInfo=function updateRTCChannelInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){return Dl.wrap((function _callee20$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},limit:{type:"number",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatUpdateRTCChannelConfig",{RTCChannelConfig:Et(Et({},e),{audio:bn(e.audio),video:bn(e.video)})});case 3:case"end":return t.stop()}}),_callee20,this)})))},t.getRTCChannelInfo=function getRTCChannelInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){var t;return Dl.wrap((function _callee21$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1}},e),r.next=3,this.core.sendCmd("qchatGetRTCChannelConfig",{qchatGetRTCChannelConfigTag:e});case 3:return t=r.sent,r.abrupt("return",formatRTCChannelConfig(t.content.RTCChannelConfig));case 5:case"end":return r.stop()}}),_callee21,this)})))},t.getRTCChannelOnlineMembers=function getRTCChannelOnlineMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee22(){var t;return Dl.wrap((function _callee22$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1}},e),r.next=3,this.core.sendCmd("qchatGetRTCChannelMembers",{qchatGetRTCChannelMembersTag:e});case 3:return t=r.sent,r.abrupt("return",formatMembers(t.content.memberList));case 5:case"end":return r.stop()}}),_callee22,this)})))},t.addRTCChannelListener=function addRTCChannelListener(){var e,t,r=this;this._checkConnectState();try{null===(e=this.authService)||void 0===e||e.addAuthListener({onAuthEvent:function onAuthEvent(e){return __awaiter(r,void 0,void 0,Dl.mark((function _callee23(){var t;return Dl.wrap((function _callee23$(r){for(;;)switch(r.prev=r.next){case 0:if(1026!==e||this.getTokenState){r.next=10;break}return this.logger.log("QChatMedia::loginByIM token expire,begin get new token "),this.getTokenState=!0,r.next=5,this._getToken();case 5:if(t=r.sent,!this.authService){r.next=9;break}return r.next=9,this.authService.renewToken(t);case 9:this.getTokenState=!1;case 10:case"end":return r.stop()}}),_callee23,this)})))}})}catch(e){throw this.getTokenState=!1,this.logger.error("QChatMedia::loginByIM addAuthListener error",e),new Rl("QChatMedia::loginByIM addAuthListener error",e)}null===(t=this.roomContext)||void 0===t||t.addRoomListener({onRoomPropertiesChanged:function onRoomPropertiesChanged(e){var t,n,a,i,o,s;if(r.logger.log("QChatMedia::addRTCChannelListener::onRoomPropertiesChanged",e),e.audioOff){var c=null===(t=e.audioOff.value)||void 0===t?void 0:t.split("_")[0];"offNotAllowSelfOn"!==c&&"offAllowSelfOn"!==c||(null===(n=r.roomContext)||void 0===n?void 0:n.localMember.isAudioOn)&&(null===(a=r.rtcController)||void 0===a||a.muteMyAudio())}else if(e.videoOff){var l=null===(i=e.videoOff.value)||void 0===i?void 0:i.split("_")[0];"offNotAllowSelfOn"!==l&&"offAllowSelfOn"!==l||(null===(o=r.roomContext)||void 0===o?void 0:o.localMember.isVideoOn)&&(null===(s=r.rtcController)||void 0===s||s.muteMyVideo())}},onRoomPropertiesDeleted:function onRoomPropertiesDeleted(e){r.logger.log("QChatMedia::addRTCChannelListener::onRoomPropertiesDeleted",e)},onMemberJoinRtcChannel:function onMemberJoinRtcChannel(e){r.logger.log("QChatMedia::addRTCChannelListener::onMemberJoinRTCChannel",e);var t=map$6(e).call(e,(function(e){return e.uuid}));r.core.emit("memberJoinRTCChannel",t),r.core.qchatMedia.emit("memberJoinRTCChannel",t)},onMemberLeaveRoom:function onMemberLeaveRoom(e){r.logger.log("QChatMedia::addRTCChannelListener::onMemberLeaveRoom",e);var t=map$6(e).call(e,(function(e){return e.uuid}));r.core.emit("memberLeaveRTCChannel",t),r.core.qchatMedia.emit("memberLeaveRTCChannel",t)},onRoomEnded:function onRoomEnded(e){r.authService&&r.authService.logout(),r._setStateInit(),r.logger.log("QChatMedia::addRTCChannelListener::onRoomEnded",e),r.core.emit("RTCChannelEnded",e),r.core.qchatMedia.emit("RTCChannelEnded",e)},onRtcChannelError:function onRtcChannelError(e){r.logger.log("QChatMedia::addRTCChannelListener::onRtcChannelError",e),"SOCKET_ERROR"===e&&r.disconnectChannel(),r.core.emit("RTCChannelError",e),r.core.qchatMedia.emit("RTCChannelError",e)},onRtcAudioVolumeIndication:function onRtcAudioVolumeIndication(e){r.logger.log("QChatMedia::addRTCChannelListener::onRtcAudioVolumeIndication",e),r.core.emit("onRtcAudioVolumeIndication",e),r.core.qchatMedia.emit("onRtcAudioVolumeIndication",e)},onMemberAudioMuteChanged:function onMemberAudioMuteChanged(e,t,n){r.logger.log("QChatMedia::addRTCChannelListener::onMemberAudioMuteChanged",e,t),r.core.emit("memberAudioMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:n.uuid}),r.core.qchatMedia.emit("memberAudioMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:n.uuid})},onMemberScreenShareStateChanged:function onMemberScreenShareStateChanged(e,t,n){r.logger.log("QChatMedia::addRTCChannelListener::onMemberScreenShareStateChanged",e,t),r.core.emit("memberScreenShareStateChanged",{memberAccId:e.uuid,isSharing:t,operateByAccId:n.uuid}),r.core.qchatMedia.emit("memberScreenShareStateChanged",{memberAccId:e.uuid,isSharing:t,operateByAccId:n.uuid})},onMemberVideoMuteChanged:function onMemberVideoMuteChanged(e,t,n){r.logger.log("QChatMedia::addRTCChannelListener::onMemberVideoMuteChanged",e,t),r.core.emit("memberVideoMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:n.uuid}),r.core.qchatMedia.emit("memberVideoMuteChanged",{memberAccId:e.uuid,mute:t,operateByAccId:n.uuid})}})},t.enumCameraDevices=function enumCameraDevices(){var e=this;return this._checkConnectState(),this.rtcController.enumCameraDevices().then((function(e){return e.data}),(function(t){throw e.logger.error("QChatMedia::enumCameraDevices error",t),new Rl("QChatMedia::enumCameraDevices error",t)}))},t.enumPlayoutDevices=function enumPlayoutDevices(){var e=this;return this._checkConnectState(),this.rtcController.enumPlayoutDevices().then((function(e){return e.data}),(function(t){throw e.logger.error("QChatMedia::enumPlayoutDevices error",t),new Rl("QChatMedia::enumPlayoutDevices error",t)}))},t.enumRecordDevices=function enumRecordDevices(){var e=this;return this._checkConnectState(),this.rtcController.enumRecordDevices().then((function(e){return e.data}),(function(t){throw e.logger.error("QChatMedia::enumRecordDevices error",t),new Rl("QChatMedia::enumRecordDevices error",t)}))},t.removeRTCChannelListener=function removeRTCChannelListener(){var e,t;this._checkConnectState(),null===(e=this.roomContext)||void 0===e||e.removeRoomListener({}),null===(t=this.authService)||void 0===t||t.removeAuthListener({})},t.setSelectedCameraDevice=function setSelectedCameraDevice(e){var t=this;return this._checkConnectState(),validate({deviceId:{type:"string",allowEmpty:!1}},e),this.rtcController.setSelectedCameraDevice(e.deviceId).then((function(e){return e.data}),(function(e){throw t.logger.error("QChatMedia::setSelectedCameraDevice error",e),new Rl("QChatMedia::setSelectedCameraDevice error",e)}))},t.setSelectedPlayoutDevice=function setSelectedPlayoutDevice(e){var t=this;return this._checkConnectState(),validate({deviceId:{type:"string",allowEmpty:!1}},e),this.rtcController.setSelectedPlayoutDevice(e.deviceId).then((function(e){return e.data}),(function(e){throw t.logger.error("QChatMedia::setSelectedPlayoutDevice error",e),new Rl("QChatMedia::setSelectedPlayoutDevice error",e)}))},t.setSelectedRecordDevice=function setSelectedRecordDevice(e){var t=this;return this._checkConnectState(),validate({deviceId:{type:"string",allowEmpty:!1}},e),this.rtcController.setSelectedRecordDevice(e.deviceId).then((function(e){return e.data}),(function(e){throw t.logger.error("QChatMedia::setSelectedRecordDevice error",e),new Rl("QChatMedia::setSelectedRecordDevice error",e)}))},t.getRTCMembers=function getRTCMembers(){var e,t;return this._checkConnectState(),map$6(e=filter(t=this.roomContext.remoteMembers).call(t,(function(e){return e.isInRtcChannel}))).call(e,(function(e){return{accid:e.uuid,isAudioOn:!!e.isAudioOn,isVideoOn:!!e.isVideoOn,isSharingScreen:!!e.isSharingScreen,properties:e.properties}}))},t.subscribeRemoteVideoSubStream=function subscribeRemoteVideoSubStream(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee24(){return Dl.wrap((function _callee24$(r){for(;;)switch(r.prev=r.next){case 0:this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),r.prev=2,null===(t=this.rtcController)||void 0===t||t.subscribeRemoteVideoSubStream(e.accid),r.next=10;break;case 6:throw r.prev=6,r.t0=r.catch(2),this.logger.error("QChatMedia::subscribeRemoteVideoSubStream error",r.t0),new Rl("QChatMedia::subscribeRemoteVideoSubStream error",r.t0);case 10:case"end":return r.stop()}}),_callee24,this,[[2,6]])})))},t.unsubscribeRemoteVideoSubStream=function unsubscribeRemoteVideoSubStream(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee25(){return Dl.wrap((function _callee25$(r){for(;;)switch(r.prev=r.next){case 0:this._checkConnectState(),validate({accid:{type:"string",allowEmpty:!1}},e),r.prev=2,null===(t=this.rtcController)||void 0===t||t.unsubscribeRemoteVideoSubStream(e.accid),r.next=10;break;case 6:throw r.prev=6,r.t0=r.catch(2),this.logger.error("QChatMedia::unsubscribeRemoteVideoSubStream error",r.t0),new Rl("QChatMedia::unsubscribeRemoteVideoSubStream error",r.t0);case 10:case"end":return r.stop()}}),_callee25,this,[[2,6]])})))},t.muteAllAudio=function muteAllAudio(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee26(){return Dl.wrap((function _callee26$(t){for(;;)switch(t.prev=t.next){case 0:return this._checkConnectState(),t.next=3,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"});case 3:if(t.sent){t.next=7;break}return this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneMicrophone auth"),t.abrupt("return");case 7:t.prev=7,null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("audioOff",bn({value:"offNotAllowSelfOn_"+(new Date).getTime()})),t.next=15;break;case 11:throw t.prev=11,t.t0=t.catch(7),this.logger.error("QChatMedia::muteAllAudio error",t.t0),new Rl("QChatMedia::muteAllAudio error",t.t0);case 15:case"end":return t.stop()}}),_callee26,this,[[7,11]])})))},t.muteAllVideo=function muteAllVideo(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee27(){return Dl.wrap((function _callee27$(t){for(;;)switch(t.prev=t.next){case 0:return this._checkConnectState(),t.next=3,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"});case 3:if(t.sent){t.next=7;break}return this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneCamera auth"),t.abrupt("return");case 7:t.prev=7,null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("videoOff",bn({value:"offNotAllowSelfOn_"+(new Date).getTime()})),t.next=15;break;case 11:throw t.prev=11,t.t0=t.catch(7),this.logger.error("QChatMedia::muteAllVideo error",t.t0),new Rl("QChatMedia::muteAllVideo error",t.t0);case 15:case"end":return t.stop()}}),_callee27,this,[[7,11]])})))},t.unMuteAllAudio=function unMuteAllAudio(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee28(){return Dl.wrap((function _callee28$(t){for(;;)switch(t.prev=t.next){case 0:return this._checkConnectState(),t.next=3,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneMicrophone"});case 3:if(t.sent){t.next=7;break}return this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneMicrophone auth"),t.abrupt("return");case 7:t.prev=7,null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("audioOff",bn({value:"disable_"+(new Date).getTime()})),t.next=15;break;case 11:throw t.prev=11,t.t0=t.catch(7),this.logger.error("QChatMedia::unMuteAllAudio error",t.t0),new Rl("QChatMedia::unMuteAllAudio error",t.t0);case 15:case"end":return t.stop()}}),_callee28,this,[[7,11]])})))},t.unMuteAllVideo=function unMuteAllVideo(){var e;return __awaiter(this,void 0,void 0,Dl.mark((function _callee29(){return Dl.wrap((function _callee29$(t){for(;;)switch(t.prev=t.next){case 0:return this._checkConnectState(),t.next=3,this._checkPermission({serverId:this.serverId,channelId:this.channelId,auth:"RTCChannelOpenCloseEveryoneCamera"});case 3:if(t.sent){t.next=7;break}return this.logger.error("QChatMedia::connect::auth your have not RTCChannelOpenCloseEveryoneCamera auth"),t.abrupt("return");case 7:t.prev=7,null===(e=this.roomContext)||void 0===e||e.updateRoomProperty("videoOff",bn({value:"disable_"+(new Date).getTime()})),t.next=15;break;case 11:throw t.prev=11,t.t0=t.catch(7),this.logger.error("QChatMedia::unMuteAllVideo error",t.t0),new Rl("QChatMedia::unMuteAllVideo error",t.t0);case 15:case"end":return t.stop()}}),_callee29,this,[[7,11]])})))},QChatMediaService}(T_),hM={"24_10":"qchatSendMsg","24_11":"qchatOnMsg","24_12":"qchatOnRecvUnreadInfo","24_13":"qchatSendCustomSysMsg","24_14":"qchatOnSysMsg","24_16":"qchatGetHistoryMsg","24_17":"qchatMarkMessageRead","24_18":"qchatMultiSyncMessageRead","24_22":"qchatUpdateSystemNotification","24_23":"qchatMultiSyncSystemNotificationUpdate","24_24":"qchatSyncSystemNotification","24_25":"qchatUpdateMessage","24_26":"qchatRecvMessageUpdate","24_28":"qchatMarkSysMsgRead","24_94":"qchatMessageSearchByPage","24_100":"qchatGetMessageHistoryByIds","24_101":"qchatGetThreadMessages","24_102":"qchatUpdateQuickComment","24_103":"qchatGetQuickComments","24_108":"qchatGetThreadRootMessagesMeta","24_121":"qchatGetLastMessageOfChannels","24_127":"qchatGetMentionedMeMessages","25_6":"qchatMultiSyncServersMessageRead"},gM={getHistoryMsgTag:{serverId:1,channelId:2,beginTime:3,endTime:4,excludeMsgId:5,limit:6,reverse:7},getThreadHistoryMsgTag:{beginTime:1,endTime:2,excludeMsgId:3,limit:4,reverse:5},qchatMsgTag:{serverId:1,channelId:2,fromAccount:3,fromClientType:4,fromDeviceId:5,fromNick:6,time:7,updateTime:8,type:9,body:10,attach:11,ext:12,msgIdClient:13,msgIdServer:14,resendFlag:15,status:16,pushPayload:17,pushContent:18,mentionAccids:19,mentionAll:20,env:21,callbackExt:22,replyMsgFromAccount:23,replyMsgTime:24,replyMsgIdServer:25,replyMsgIdClient:26,threadMsgFromAccount:27,threadMsgTime:28,threadMsgIdServer:29,threadMsgIdClient:30,useCustomContent:31,antiSpamContent:32,antiSpamBusinessId:33,antiSpamUsingYidun:34,yidunCallback:35,yidunAntiCheating:36,yidunAntiSpamExt:37,yidunAntiSpamRes:38,mentionRoleIds:41,accidsOfMentionedRoles:42,updateContent:39,updateOperatorInfo:40,subType:61,historyEnable:100,pushEnable:101,needBadge:102,needPushNick:103,notifyReason:104,routeEnable:105,isAntispam:106},sysMsg:{toType:1,serverId:2,channelId:3,toAccids:4,fromAccount:5,fromClientType:6,fromDeviceId:7,fromNick:8,time:9,updateTime:10,type:11,msgIdClient:12,msgIdServer:13,body:14,attach:15,ext:16,resendFlag:17,status:18,pushPayload:19,pushContent:20,env:21,callbackExt:22,persistEnable:100,pushEnable:101,needBadge:102,needPushNick:103,routeEnable:104},qchatMsgUpdateTag:{operatorAccount:1,operatorClientType:2,ps:3,ext:4,pushContent:5,pushPayload:6,env:7,routeEnable:100},markMsgReadTag:{serverId:1,channelId:2,time:3},qchatQuickCommentRequestTag:{serverId:1,channelId:2,fromAccount:3,msgIdServer:4,time:5,type:6,opeType:7,opeAccid:8},qchatQuickCommentQueryTag:{serverId:1,channelId:2,msgIdServerList:3},qchatGetLastMessageOfChannelsTag:{serverId:1,channelIdList:2},qchatMultiSyncServersMessageReadTag:{successServerIds:1,failServerIds:2,ackTimestamp:3},qchatMessageSearchByPageTag:{keyword:1,serverId:2,channelId:3,fromAccid:4,fromTime:5,toTime:6,msgTypes:7,subTypes:8,includeSelf:9,order:10,limit:11,sort:12,cursor:13},qchatPageQueryTag:{hasMore:1,nextTimetag:2,cursor:3},unreadInfo:b_},vM=function getDeserializeTag(){return invertSerializeMap(gM)},fM=function getCmdConfig(){var e=vM();return{qchatSendMsg:{service:"qchatMsg",sid:24,cid:10,params:[{type:"Property",name:"qchatMsg",reflectMapper:gM.qchatMsgTag}],response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatOnMsg:{service:"qchatMsg",sid:24,cid:11,response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatOnRecvUnreadInfo:{service:"qchatMsg",sid:24,cid:12,response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatSendCustomSysMsg:{service:"qchatMsg",sid:24,cid:13,params:[{type:"Property",name:"sysMsg",reflectMapper:gM.sysMsg}],response:[{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatOnSysMsg:{service:"qchatMsg",sid:24,cid:14,response:[{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatGetHistoryMsg:{service:"qchatMsg",sid:24,cid:16,params:[{type:"Property",name:"getHistoryMsgTag",reflectMapper:gM.getHistoryMsgTag}],response:[{type:"PropertyArray",name:"qchatMsgs",reflectMapper:e.qchatMsgTag}]},qchatUpdateMessage:{service:"qchatMsg",sid:24,cid:25,params:[{type:"Property",name:"qchatMsgUpdateTag",reflectMapper:gM.qchatMsgUpdateTag},{type:"Property",name:"qchatMsg",reflectMapper:gM.qchatMsgTag}],response:[{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatRecvMessageUpdate:{service:"qchatMsg",sid:24,cid:26,response:[{type:"Property",name:"qchatMsgUpdateInfo",reflectMapper:e.qchatMsgUpdateTag},{type:"Property",name:"qchatMsg",reflectMapper:e.qchatMsgTag}]},qchatMarkMessageRead:{sid:24,cid:17,service:"qchatMsg",params:[{type:"Property",name:"markMsgReadTag",reflectMapper:gM.markMsgReadTag}],response:[{type:"Property",name:"unreadInfo",reflectMapper:e.unreadInfo}]},qchatMultiSyncMessageRead:{sid:24,cid:18,service:"qchatMsg",response:[{type:"Property",name:"unreadInfo",reflectMapper:e.unreadInfo}]},qchatUpdateSystemNotification:{service:"qchatMsg",sid:24,cid:22,params:[{type:"Property",name:"qchatMsgUpdateTag",reflectMapper:gM.qchatMsgUpdateTag},{type:"Property",name:"sysMsg",reflectMapper:gM.sysMsg}],response:[{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatMultiSyncSystemNotificationUpdate:{service:"qchatMsg",sid:24,cid:23,response:[{type:"Property",name:"qchatMsgUpdateTag",reflectMapper:e.qchatMsgUpdateTag},{type:"Property",name:"sysMsg",reflectMapper:e.sysMsg}]},qchatSyncSystemNotification:{service:"qchatMsg",sid:24,cid:24,response:[{type:"PropertyArray",name:"systemNotifications",reflectMapper:e.sysMsg}]},qchatMarkSysMsgRead:{service:"qchatMsg",sid:24,cid:28,params:[{type:"PropertyArray",name:"sysMsgs",reflectMapper:gM.sysMsg}]},qchatMessageSearchByPage:{service:"qchatMsg",sid:24,cid:94,params:[{type:"Property",name:"qchatMessageSearchByPageTag",reflectMapper:gM.qchatMessageSearchByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:e.qchatPageQueryTag},{type:"PropertyArray",name:"datas",reflectMapper:e.qchatMsgTag}]},qchatGetMessageHistoryByIds:{service:"qchatMsg",sid:24,cid:100,params:[{type:"Property",name:"channelInfo",reflectMapper:{serverId:1,channelId:2}},{type:"PropertyArray",name:"messageReferList",reflectMapper:{msgIdServer:1,time:2}}],response:[{type:"PropertyArray",name:"qchatMsgs",reflectMapper:e.qchatMsgTag}]},qchatGetThreadMessages:{service:"qchatMsg",sid:24,cid:101,params:[{type:"Property",name:"qchatMsg",reflectMapper:gM.qchatMsgTag},{type:"Property",name:"getThreadHistoryMsgTag",reflectMapper:gM.getThreadHistoryMsgTag}],response:[{type:"Property",name:"thread",reflectMapper:e.qchatMsgTag},{type:"Property",name:"threadInfo",reflectMapper:{1:"messageCount",2:"lastMessageTimestamp"}},{type:"PropertyArray",name:"qchatMsgs",reflectMapper:e.qchatMsgTag}]},qchatUpdateQuickComment:{service:"qchatMsg",sid:24,cid:102,params:[{type:"Property",name:"tag",reflectMapper:gM.qchatQuickCommentRequestTag}]},qchatGetQuickComments:{service:"qchatMsg",sid:24,cid:103,params:[{type:"Property",name:"tag",reflectMapper:gM.qchatQuickCommentQueryTag}],response:[{type:"PropertyArray",name:"quickCommentResponse",reflectMapper:{1:"serverId",2:"channelId",3:"msgIdServer",4:"totalCount",5:"lastUpdateTime",6:"details"}}]},qchatGetThreadRootMessagesMeta:{service:"qchatMsg",sid:24,cid:108,params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,channelId:2}},{type:"PropertyArray",name:"qchatMsgs",reflectMapper:{time:7,msgIdServer:14}}],response:[{type:"PropertyArray",name:"metas",reflectMapper:{1:"total",2:"timestamp",3:"msgIdServer",4:"msgTime"}}]},qchatGetLastMessageOfChannels:{service:"qchatMsg",sid:24,cid:121,params:[{type:"Property",name:"tag",reflectMapper:gM.qchatGetLastMessageOfChannelsTag}],response:[{type:"PropertyArray",name:"msgs",reflectMapper:e.qchatMsgTag}]},qchatMultiSyncServersMessageRead:{service:"qchatMsg",sid:25,cid:6,response:[{type:"Property",name:"qchatMultiSyncServersMessageReadTag",reflectMapper:e.qchatMultiSyncServersMessageReadTag}]},qchatGetMentionedMeMessages:{service:"qchatMsg",sid:24,cid:127,params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,channelId:2,timestamp:3,limit:4}}],response:[{type:"Property",name:"page",reflectMapper:e.qchatPageQueryTag},{type:"PropertyArray",name:"datas",reflectMapper:e.qchatMsgTag}]}}};!function(e){e[e.Android=1]="Android",e[e.iOS=2]="iOS",e[e.PC=4]="PC",e[e.WindowsPhone=8]="WindowsPhone",e[e.Web=16]="Web",e[e.Server=32]="Server",e[e.Mac=64]="Mac",e[e.HarmonyOS=65]="HarmonyOS"}(lM||(lM={}));var yM,_M={"24_31":"qchatCreateServer","24_32":"qchatDeleteServer","24_33":"qchatUpdateServer","24_34":"qchatGetServers","24_35":"qchatGetServersByPage","24_36":"qchatInviteServerMembers","24_37":"qchatAcceptServerInvite","24_38":"qchatRejectInviteServer","24_39":"qchatApplyServerJoin","24_40":"qchatAcceptServerApply","24_41":"qchatRejectServerApply","24_42":"qchatKickServerMembers","24_43":"qchatLeaveServer","24_44":"qchatUpdateMyMemberInfo","24_45":"qchatUpdateServerMemberInfo","24_46":"qchatGetServerMembers","24_47":"qchatGetServerMembersByPage","24_104":"qchatUpdateServerMemberBan","24_105":"qchatGetBannedMembersByPage","24_91":"qchatServerSearchByPage","24_92":"qchatServerMemberSearchByPage","24_122":"qchatGenerateInviteCode","24_123":"qchatJoinByInviteCode","24_124":"qchatGetInviteApplyRecordOfServer","24_125":"qchatGetInviteApplyRecordOfSelf","25_5":"qchatClearServersUnread","25_7":"qchatSubscribeChannelsByServers","25_10":"qchatEnterAsVisitor","25_11":"qchatLeaveAsVisitor"},MM={serverInfo:{serverId:1,name:3,icon:4,ext:5,owner:6,memberNumber:7,inviteMode:8,applyMode:9,validFlag:10,createTime:11,updateTime:12,channelNumber:13,categoryNumber:14,searchType:15,searchEnable:16,reorderWeight:17},antispamTag:{antiSpamBusinessId:1},memberInfo:{serverId:1,accid:3,nick:4,avatar:5,ext:6,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},otherMemberInfo:{serverId:1,accid:3,nick:4,avatar:5,type:7,joinTime:8,inviter:9,validFlag:10,createTime:11,updateTime:12},getServerListPageTag:{timestamp:1,limit:2},getServerMemberListPageTag:{serverId:1,timetag:2,limit:3},updateServerMemberBanTag:{serverId:1,opeType:2,accid:3,ext:4},getBannedMembersByPageTag:{serverId:1,timetag:2,limit:3},serverMemberBanInfo:{serverId:1,appid:2,accid:3,ext:4,banTime:5,validFlag:6,createTime:7,updateTime:8},serverSearchByPageTag:{keyword:1,startTime:2,endTime:3,order:4,limit:5,serverType:6,searchType:7,sort:8,cursor:9},serverMemberSearchByPageTag:{serverId:1,keyword:3,limit:4},inviteRespParamTag:{requestId:1},applyRespParamTag:{requestId:1,expireTime:2},inviteApplyRecord:{accid:1,type:2,serverId:3,status:4,requestId:5,createTime:6,updateTime:7,expireTime:8,data:9,recordId:10},clearServersUnreadTag:{successServerIds:1,failServerIds:2,ackTimestamp:3},unreadInfo:b_},IM=function getDeserializeTag(){return invertSerializeMap(MM)},SM=function getCmdConfig(){var e=IM();return{qchatCreateServer:{sid:24,cid:31,service:"qchatServer",params:[{type:"Property",name:"serverInfo",reflectMapper:MM.serverInfo},{type:"Property",name:"antispamTag",reflectMapper:MM.antispamTag}],response:[{type:"Property",name:"serverInfo",reflectMapper:e.serverInfo}]},qchatDeleteServer:{sid:24,cid:32,service:"qchatServer",params:[{type:"Long",name:"serverId"}]},qchatUpdateServer:{sid:24,cid:33,service:"qchatServer",params:[{type:"Property",name:"serverInfo",reflectMapper:MM.serverInfo},{type:"Property",name:"antispamTag",reflectMapper:MM.antispamTag}],response:[{type:"Property",name:"serverInfo",reflectMapper:e.serverInfo}]},qchatGetServers:{sid:24,cid:34,service:"qchatServer",params:[{type:"LongArray",name:"serverIds"}],response:[{type:"PropertyArray",name:"serverList",reflectMapper:e.serverInfo}]},qchatGetServersByPage:{sid:24,cid:35,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:MM.getServerListPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverInfo}]},qchatInviteServerMembers:{sid:24,cid:36,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"StrArray",name:"accids"},{type:"String",name:"ps"},{type:"Property",name:"params",reflectMapper:{ttl:1}}],response:[{type:"StrArray",name:"failByOverAccids"},{type:"StrArray",name:"failByBanAccids"},{type:"Property",name:"record",reflectMapper:e.applyRespParamTag}]},qchatAcceptServerInvite:{sid:24,cid:37,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"Property",name:"recordInfo",reflectMapper:MM.inviteRespParamTag}]},qchatRejectInviteServer:{sid:24,cid:38,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"String",name:"ps"},{type:"Property",name:"recordInfo",reflectMapper:MM.inviteRespParamTag}]},qchatApplyServerJoin:{sid:24,cid:39,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"ps"},{type:"Property",name:"params",reflectMapper:{ttl:1}}],response:[{type:"Property",name:"data",reflectMapper:e.applyRespParamTag}]},qchatAcceptServerApply:{sid:24,cid:40,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"Property",name:"recordInfo",reflectMapper:MM.applyRespParamTag}]},qchatRejectServerApply:{sid:24,cid:41,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"String",name:"accid"},{type:"String",name:"ps"},{type:"Property",name:"recordInfo",reflectMapper:MM.applyRespParamTag}]},qchatKickServerMembers:{sid:24,cid:42,service:"qchatServer",params:[{type:"Long",name:"serverId"},{type:"StrArray",name:"accids"}]},qchatLeaveServer:{sid:24,cid:43,service:"qchatServer",params:[{type:"Long",name:"serverId"}]},qchatUpdateMyMemberInfo:{sid:24,cid:44,service:"qchatServer",params:[{type:"Property",name:"memberInfo",reflectMapper:MM.memberInfo},{type:"Property",name:"antispamTag",reflectMapper:MM.antispamTag}],response:[{type:"Property",name:"memberInfo",reflectMapper:e.memberInfo}]},qchatUpdateServerMemberInfo:{sid:24,cid:45,service:"qchatServer",params:[{type:"Property",name:"memberInfo",reflectMapper:MM.otherMemberInfo},{type:"Property",name:"antispamTag",reflectMapper:MM.antispamTag}],response:[{type:"Property",name:"memberInfo",reflectMapper:e.memberInfo}]},qchatGetServerMembers:{sid:24,cid:46,service:"qchatServer",params:[{type:"StrArray",name:"accids"}],response:[{type:"PropertyArray",name:"accidList",reflectMapper:e.memberInfo}]},qchatGetServerMembersByPage:{sid:24,cid:47,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:MM.getServerMemberListPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.memberInfo}]},qchatUpdateServerMemberBan:{sid:24,cid:104,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:MM.updateServerMemberBanTag}]},qchatGetBannedMembersByPage:{sid:24,cid:105,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:MM.getBannedMembersByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverMemberBanInfo}]},qchatServerSearchByPage:{sid:24,cid:91,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:MM.serverSearchByPageTag}],response:[{type:"Property",name:"listQueryTag",reflectMapper:{1:"hasMore",2:"nextTimetag",3:"cursor"}},{type:"PropertyArray",name:"datas",reflectMapper:e.serverInfo}]},qchatServerMemberSearchByPage:{sid:24,cid:92,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:MM.serverMemberSearchByPageTag}],response:[{type:"PropertyArray",name:"members",reflectMapper:e.memberInfo}]},qchatGenerateInviteCode:{sid:24,cid:122,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,ttl:2}}],response:[{type:"Property",name:"data",reflectMapper:{1:"serverId",2:"requestId",3:"inviteCode",4:"expireTime"}}]},qchatJoinByInviteCode:{sid:24,cid:123,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,inviteCode:2,ps:3}}]},qchatGetInviteApplyRecordOfServer:{sid:24,cid:124,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverId:1,fromTime:2,toTime:3,reverse:4,limit:5,cursor:6}}],response:[{type:"PropertyArray",name:"data",reflectMapper:e.inviteApplyRecord}]},qchatGetInviteApplyRecordOfSelf:{sid:24,cid:125,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{fromTime:1,toTime:2,reverse:3,limit:4,cursor:5}}],response:[{type:"PropertyArray",name:"data",reflectMapper:e.inviteApplyRecord}]},qchatClearServersUnread:{sid:25,cid:5,service:"qchatServer",params:[{type:"LongArray",name:"serverIds"}],response:[{type:"Property",name:"clearServersUnreadTag",reflectMapper:e.clearServersUnreadTag}]},qchatSubscribeChannelsByServers:{sid:25,cid:7,service:"qchatServer",params:[{type:"Int",name:"type"},{type:"LongArray",name:"serverIds"}],response:[{type:"PropertyArray",name:"unreadInfos",reflectMapper:e.unreadInfo},{type:"String",name:"failServerIds"}]},qchatEnterAsVisitor:{sid:25,cid:10,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverIds:1}}],response:[{type:"String",name:"failServerIds"}]},qchatLeaveAsVisitor:{sid:25,cid:11,service:"qchatServer",params:[{type:"Property",name:"tag",reflectMapper:{serverIds:1}}],response:[{type:"String",name:"failServerIds"}]}}},TM={"24_61":"qchatCreateServerRole","24_62":"qchatDeleteServerRole","24_63":"qchatUpdateServerRole","24_64":"qchatGetServerRoles","24_65":"qchatAddChannelRole","24_66":"qchatRemoveChannelRole","24_67":"qchatUpdateChannelRole","24_68":"qchatGetChannelRoles","24_69":"qchatAddMemberRole","24_70":"qchatRemoveMemberRole","24_71":"qchatUpdateMemberRole","24_72":"qchatGetMemberRoles","24_73":"qchatAddMembersToServerRole","24_74":"qchatRemoveMembersFromServerRole","24_75":"qchatGetMembersFromServerRole","24_76":"qchatGetServerRolesByAccid","24_77":"qchatGetExistingServerRolesByAccids","24_78":"qchatGetExistingChannelRolesByServerRoleIds","24_79":"qchatGetExistingAccidsOfMemberRoles","24_80":"qchatUpdateServerRolePriorities","24_81":"qchatGetExistingAccidsInServerRole","24_82":"qchatCheckPermission","24_83":"qchatAddChannelCategoryRole","24_84":"qchatRemoveChannelCategoryRole","24_85":"qchatUpdateChannelCategoryRole","24_86":"qchatGetChannelCategoryRole","24_87":"qchatAddChannelCategoryMemberRole","24_88":"qchatRemoveChannelCategoryMemberRole","24_89":"qchatUpdateChannelCategoryMemberRole","24_90":"qchatGetChannelCategoryMemberRole","24_126":"qchatCheckPermissions"},CM={channelRole:{serverId:1,roleId:2,parentRoleId:3,channelId:4,name:5,icon:6,ext:7,auths:8,type:9,createTime:10,updateTime:11},memberRole:{serverId:1,id:2,accid:3,channelId:4,auths:5,createTime:6,updateTime:7,nick:8,avatar:9,ext:10,memberType:11,joinTime:12,inviter:13},antispamTag:{antiSpamBusinessId:1},serverRole:{serverId:1,roleId:2,name:3,icon:4,ext:5,auths:6,type:7,memberCount:8,priority:9,createTime:10,updateTime:11,isMember:12},getRoleByPagesTag:{serverId:1,channelId:2,time:3,limit:4},checkPermissionTag:{serverId:1,channelId:2,auth:3},member:{serverId:1,roleId:2,accid:3,createTime:4,updateTime:5,nick:6,avatar:7,ext:8,type:9,joinTime:10,inviter:11},qchatAddChannelCategoryRoleTag:{categoryId:3,serverId:4,parentRoleId:5},channelCategoryRole:{roleId:1,categoryId:3,serverId:4,parentRoleId:5,type:6,validFlag:7,createTime:8,updateTime:9,auths:10,name:11,icon:12,ext:13},qchatGetChannelCategoryRoleTag:{serverId:1,categoryId:2,timetag:3,limit:4},channelCategoryMemberRole:{id:1,accid:3,categoryId:4,serverId:5,validFlag:6,createTime:7,updateTime:8,auths:9,nick:10,avatar:11,ext:12,memberType:13,joinTime:14,inviter:15},qchatGetChannelCategoryMemberRoleTag:{serverId:1,categoryId:2,timetag:3,limit:4},checkPermissionsTag:{serverId:1,channelId:2,auths:3}},bM=function getDeserializeTag(){return invertSerializeMap(CM)},EM=function getCmdConfig(){var e=bM();return{qchatCreateServerRole:{service:"qchatRole",sid:24,cid:61,params:[{type:"Property",name:"serverRole",reflectMapper:CM.serverRole},{type:"Property",name:"antispamTag",reflectMapper:CM.antispamTag}],response:[{type:"Property",name:"serverRole",reflectMapper:e.serverRole}]},qchatDeleteServerRole:{service:"qchatRole",sid:24,cid:62,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"}]},qchatUpdateServerRole:{service:"qchatRole",sid:24,cid:63,params:[{type:"Property",name:"updateServerRoleTag",reflectMapper:{serverId:1,roleId:2,name:3,icon:4,ext:5,auths:6,priority:7}},{type:"Property",name:"antispamTag",reflectMapper:CM.antispamTag}],response:[{type:"Property",name:"serverRole",reflectMapper:e.serverRole}]},qchatGetServerRoles:{service:"qchatRole",sid:24,cid:64,params:[{type:"Property",name:"getServerRolesTag",reflectMapper:{serverId:1,timetag:2,limit:3,priority:4,channelId:5,categoryId:6}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRole}]},qchatAddChannelRole:{service:"qchatRole",sid:24,cid:65,params:[{type:"Property",name:"channelRole",reflectMapper:CM.channelRole}],response:[{type:"Property",name:"channelRole",reflectMapper:e.channelRole}]},qchatRemoveChannelRole:{service:"qchatRole",sid:24,cid:66,params:[{type:"Long",name:"serverId"},{type:"Long",name:"channelId"},{type:"Long",name:"roleId"}]},qchatUpdateChannelRole:{service:"qchatRole",sid:24,cid:67,params:[{type:"Property",name:"updateChannelRoleTag",reflectMapper:{serverId:1,roleId:2,channelId:3,auths:4}}],response:[{type:"Property",name:"channelRole",reflectMapper:e.channelRole}]},qchatGetChannelRoles:{service:"qchatRole",sid:24,cid:68,params:[{type:"Property",name:"getChannelRolesTag",reflectMapper:{serverId:1,channelId:2,timetag:3,limit:4}}],response:[{type:"PropertyArray",name:"channelRoles",reflectMapper:e.channelRole}]},qchatAddMemberRole:{service:"qchatRole",sid:24,cid:69,params:[{type:"Property",name:"memberRole",reflectMapper:CM.memberRole}],response:[{type:"Property",name:"memberRole",reflectMapper:e.memberRole}]},qchatRemoveMemberRole:{service:"qchatRole",sid:24,cid:70,params:[{type:"Property",name:"memberRole",reflectMapper:CM.memberRole}]},qchatUpdateMemberRole:{service:"qchatRole",sid:24,cid:71,params:[{type:"Property",name:"updateMemberRoleTag",reflectMapper:{serverId:1,accid:2,channelId:3,auths:4}}],response:[{type:"Property",name:"memberRole",reflectMapper:e.memberRole}]},qchatGetMemberRoles:{service:"qchatRole",sid:24,cid:72,params:[{type:"Property",name:"getMemberRolesTag",reflectMapper:{serverId:1,channelId:2,timetag:3,limit:4}}],response:[{type:"PropertyArray",name:"memberRoles",reflectMapper:e.memberRole}]},qchatAddMembersToServerRole:{service:"qchatRole",sid:24,cid:73,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"},{type:"String",name:"accids"}],response:[{type:"Property",name:"accids",reflectMapper:{1:"successAccids",2:"failedAccids"}}]},qchatRemoveMembersFromServerRole:{service:"qchatRole",sid:24,cid:74,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"},{type:"String",name:"accids"}],response:[{type:"Property",name:"accids",reflectMapper:{1:"successAccids",2:"failedAccids"}}]},qchatGetMembersFromServerRole:{service:"qchatRole",sid:24,cid:75,params:[{type:"Property",name:"getMembersFromServerRoleTag",reflectMapper:{serverId:1,roleId:2,timetag:3,accid:4,limit:5}}],response:[{type:"PropertyArray",name:"members",reflectMapper:e.member}]},qchatGetServerRolesByAccid:{service:"qchatRole",sid:24,cid:76,params:[{type:"Property",name:"getServerRolesByAccidTag",reflectMapper:{serverId:1,accid:2,timetag:3,limit:4}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRole}]},qchatGetExistingServerRolesByAccids:{service:"qchatRole",sid:24,cid:77,params:[{type:"Long",name:"serverId"},{type:"String",name:"accids"}],response:[{type:"String",name:"serverRoles"}]},qchatGetExistingChannelRolesByServerRoleIds:{service:"qchatRole",sid:24,cid:78,params:[{type:"Long",name:"serverId"},{type:"Long",name:"channelId"},{type:"String",name:"roleIds"}],response:[{type:"PropertyArray",name:"channelRoles",reflectMapper:e.channelRole}]},qchatGetExistingAccidsOfMemberRoles:{service:"qchatRole",sid:24,cid:79,params:[{type:"Long",name:"serverId"},{type:"Long",name:"channelId"},{type:"String",name:"accids"}],response:[{type:"PropertyArray",name:"memberRoles",reflectMapper:e.memberRole}]},qchatUpdateServerRolePriorities:{service:"qchatRole",sid:24,cid:80,params:[{type:"Long",name:"serverId"},{type:"PropertyArray",name:"serverRoles",reflectMapper:{serverId:1,roleId:2,priority:7}}],response:[{type:"PropertyArray",name:"serverRoles",reflectMapper:e.serverRole}]},qchatGetExistingAccidsInServerRole:{service:"qchatRole",sid:24,cid:81,params:[{type:"Long",name:"serverId"},{type:"Long",name:"roleId"},{type:"String",name:"accids"}],response:[{type:"PropertyArray",name:"members",reflectMapper:e.member}]},qchatCheckPermission:{service:"qchatRole",sid:24,cid:82,params:[{type:"Property",name:"checkPermissionTag",reflectMapper:CM.checkPermissionTag}],response:[{type:"Bool",name:"checked"}]},qchatAddChannelCategoryRole:{service:"qchatRole",sid:24,cid:83,params:[{type:"Property",name:"qchatAddChannelCategoryRoleTag",reflectMapper:CM.channelCategoryRole}],response:[{type:"Property",name:"channelCategoryRole",reflectMapper:e.channelCategoryRole}]},qchatRemoveChannelCategoryRole:{service:"qchatRole",sid:24,cid:84,params:[{type:"Long",name:"serverId"},{type:"Long",name:"categoryId"},{type:"Long",name:"roleId"}]},qchatUpdateChannelCategoryRole:{service:"qchatRole",sid:24,cid:85,params:[{type:"Property",name:"qchatUpdateChannelCategoryRoleTag",reflectMapper:CM.channelCategoryRole}],response:[{type:"Property",name:"channelCategoryRole",reflectMapper:e.channelCategoryRole}]},qchatGetChannelCategoryRole:{service:"qchatRole",sid:24,cid:86,params:[{type:"Property",name:"qchatGetChannelCategoryRoleTag",reflectMapper:CM.qchatGetChannelCategoryRoleTag}],response:[{type:"PropertyArray",name:"list",reflectMapper:e.channelCategoryRole}]},qchatAddChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:87,params:[{type:"Property",name:"qchatAddChannelCategoryMemberRoleTag",reflectMapper:CM.channelCategoryMemberRole}],response:[{type:"Property",name:"channelCategoryMemberRole",reflectMapper:e.channelCategoryMemberRole}]},qchatRemoveChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:88,params:[{type:"Long",name:"serverId"},{type:"Long",name:"categoryId"},{type:"String",name:"accid"}]},qchatUpdateChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:89,params:[{type:"Property",name:"qchatUpdateChannelCategoryMemberRoleTag",reflectMapper:CM.channelCategoryMemberRole}],response:[{type:"Property",name:"channelCategoryMemberRole",reflectMapper:e.channelCategoryMemberRole}]},qchatGetChannelCategoryMemberRole:{service:"qchatRole",sid:24,cid:90,params:[{type:"Property",name:"qchatGetChannelCategoryMemberRoleTag",reflectMapper:CM.qchatGetChannelCategoryMemberRoleTag}],response:[{type:"PropertyArray",name:"list",reflectMapper:e.channelCategoryMemberRole}]},qchatCheckPermissions:{service:"qchatRole",sid:24,cid:126,params:[{type:"Property",name:"checkPermissionsTag",reflectMapper:CM.checkPermissionsTag}],response:[{type:"PropertyArray",name:"checkPermissionsResult",reflectMapper:{1:"auth",2:"isAllow"}}]}}},RM=["image","audio","video","file"],kM={time:{type:"number"},updateTime:{type:"number"},resendFlag:{type:"boolean"},persistEnable:{type:"boolean"},routeEnable:{type:"boolean"},pushEnable:{type:"boolean"},needBadge:{type:"boolean"},needPushNick:{type:"boolean"},type:{type:"enum",values:Q_},fromClientType:{type:"enum",values:lM},status:{type:"number"},toAccids:{type:"object"},toType:{type:"number"},attach:{type:"object"},pushPayload:{type:"object"}};function generatorSysMsgForCmd(e,t){var r=Et({},e),n=Et({type:t||Q_.custom},formatReverse(kM,r));return n.serverId&&n.channelId&&n.toAccids?n.toType=4:n.serverId&&n.toAccids?n.toType=3:n.serverId&&n.channelId?n.toType=2:n.serverId?n.toType=1:n.toAccids?n.toType=5:n.toType=0,n}function generatorSysMsgMarkersForCmd(e){var t=pick(e,["msgIdServer","type"]);return formatReverse(kM,t)}var wM=((yM={})[Q_.channelUpdateWhiteBlackIdentify]=function(e){var t=R_();return e.notify=formatUpdateWhiteBlackRole(deserialize(e.notify,t.qchatUpdateWhiteBlackRoleTag)),e},yM[Q_.channelUpdateWhiteBlackIdentifyUser]=function(e){var t=R_();return e.notify=function formatUpdateWhiteBlackMembers(e){return format(N_,e)}(deserialize(e.notify,t.qchatUpdateWhiteBlackMembersTag)),e},yM[Q_.updateQuickComment]=function(e){var t=vM();return e.notify=function formatQuickCommentRequest(e){return format(xM,e)}(deserialize(e.notify,t.qchatQuickCommentRequestTag)),e},yM[Q_.channelCategoryCreate]=function(e){var t=R_();return e.categoryInfo=formatChannelCategory(deserialize(e.categoryInfo,t.QChatChannelCategoryInfo)),e},yM[Q_.channelCategoryUpdate]=function(e){var t=R_();return e.categoryInfo=formatChannelCategory(deserialize(e.categoryInfo,t.QChatChannelCategoryInfo)),e},yM[Q_.channelCategoryUpdateWhiteBlackIdentify]=function(e){var t=R_();return e.notify=formatUpdateWhiteBlackRole(deserialize(e.notify,t.qchatUpdateChannelCategoryWhiteBlackRoleTag)),e},yM[Q_.channelCategoryUpdateWhiteBlackIdentifyUser]=function(e){var t=R_();return e.notify=formatUpdateWhiteBlackRole(deserialize(e.notify,t.qchatUpdateChannelCategoryWhiteBlackMembersTag)),e},yM[Q_.serverIdentifyAdd]=function(e){var t=bM();return e.serverIdentifyInfo=formatRole(deserialize(e.serverIdentifyInfo,t.serverRole)),e},yM[Q_.serverIdentifyRemove]=function(e){var t=bM();return e.serverIdentifyInfo=formatRole(deserialize(e.serverIdentifyInfo,t.serverRole)),e},yM[Q_.serverIdentifyUpdate]=function(e){var t=bM();return e.serverIdentifyInfo=formatRole(deserialize(e.serverIdentifyInfo,t.serverRole)),e},yM[Q_.channelIdentifyUpdate]=function(e){var t=bM();return e.channelIdentifyInfo=formatRole(deserialize(e.channelIdentifyInfo,t.channelRole)),e},yM[Q_.userIdentifyUpdate]=function(e){var t=bM();return e.userIdentifyInfo=formatRole(deserialize(e.userIdentifyInfo,t.memberRole)),e},yM[Q_.myMemberInfoUpdated]=function(e){var t,r=get(e,"userInfo.name"),n=get(e,"userInfo.icon");return e.updatedInfos=map$6(t=e.reuseServers).call(t,(function(e){var t={serverId:e.serverId};return 1==(1&e.bits)&&"string"==typeof r&&Et(t,{nickChanged:!0,nick:r}),2==(2&e.bits)&&"string"==typeof n&&Et(t,{avatarChanged:!0,avatar:n}),t})),delete e.userInfo,delete e.reuseServers,e},yM);function formatSystemNotification(e,t){var r=format(kM,e);if(!r.attach)return r;var n=IM(),a=R_();if(r.attach.serverInfo&&(r.attach.serverInfo=formatServer(deserialize(r.attach.serverInfo,n.serverInfo))),r.attach.channelInfo&&(r.attach.channelInfo=formatChannel(deserialize(r.attach.channelInfo,a.channelInfo))),r.attach.serverMember&&(r.attach.serverMember=formatMember$1(deserialize(r.attach.serverMember,n.memberInfo))),wM[r.attach.type]&&(r.attach=wM[r.attach.type](r.attach)),r.attach.updateAuths)try{r.attach.updateAuths=formatRoleAuths(JSON.parse(r.attach.updateAuths))}catch(e){t.error("formatSystemNotification:JSON parse updateAuths error: ",e)}return r.attach.type&&(r.attach.rawType=r.attach.type,r.attach.type=Q_[r.attach.type]),r}var AM={type:{type:"enum",values:z_},fromClientType:{type:"enum",values:lM},status:{type:"number"},resendFlag:{type:"boolean"},mentionAll:{type:"boolean"},notifyReason:{type:"enum",values:K_},pushEnable:{type:"boolean"},historyEnable:{type:"boolean"},needBadge:{type:"boolean"},needPushNick:{type:"boolean"},routeEnable:{type:"boolean"},time:{type:"number"},updateTime:{type:"number"},mentionAccids:{type:"object"},mentionRoleIds:{type:"object"},accidsOfMentionedRoles:{type:"object"},attach:{type:"object"},pushPayload:{type:"object"},isAntispam:{type:"boolean"},antiSpamInfo:{useCustomContent:{type:"boolean"},antiSpamContent:{type:"string"},antiSpamBusinessId:{type:"string"},antiSpamUsingYidun:{type:"boolean"},yidunCallback:{type:"string"},yidunAntiCheating:{type:"object"},yidunAntiSpamExt:{type:"object"},yidunAntiSpamRes:{type:"string"}},replyRefer:{fromAccount:{type:"string",rawKey:"replyMsgFromAccount"},time:{type:"number",rawKey:"replyMsgTime"},msgIdServer:{type:"string",rawKey:"replyMsgIdServer"},msgIdClient:{type:"string",rawKey:"replyMsgIdClient"}},threadRefer:{fromAccount:{type:"string",rawKey:"threadMsgFromAccount"},time:{type:"number",rawKey:"threadMsgTime"},msgIdServer:{type:"string",rawKey:"threadMsgIdServer"},msgIdClient:{type:"string",rawKey:"threadMsgIdClient"}}};function generatorMsgForCmd(e){e.onSendBefore,e.onUploadStart,e.onUploadDone,e.onUploadProgress;var t=__rest(e,["onSendBefore","onUploadStart","onUploadDone","onUploadProgress"]),r=formatReverse(AM,t);if(r.msgIdClient=e.resendFlag?e.msgIdClient:ld(),!r.msgIdClient)throw new bl("msgIdClient is required for resend a message","msgIdClient","required");return e.replyMessage&&e.replyMessage.msgIdServer&&(r.replyMsgFromAccount=e.replyMessage.fromAccount,r.replyMsgTime=+e.replyMessage.time,r.replyMsgIdServer=e.replyMessage.msgIdServer,r.replyMsgIdClient=e.replyMessage.msgIdClient,e.replyMessage.threadRefer&&e.replyMessage.threadRefer.msgIdServer?(r.threadMsgFromAccount=e.replyMessage.threadRefer.fromAccount,r.threadMsgTime=+e.replyMessage.threadRefer.time,r.threadMsgIdServer=e.replyMessage.threadRefer.msgIdServer,r.threadMsgIdClient=e.replyMessage.threadRefer.msgIdClient):(r.threadMsgFromAccount=e.replyMessage.fromAccount,r.threadMsgTime=+e.replyMessage.time,r.threadMsgIdServer=e.replyMessage.msgIdServer,r.threadMsgIdClient=e.replyMessage.msgIdClient),delete r.replyMessage),r}function formatMsgOperatorInfo(e){return format({operatorClientType:{type:"enum",values:lM},pushPayload:{type:"object"}},e)}function formatMsg(e,t,r){var n,a;return void 0===t&&(t={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee(){var i,o,s,c;return Dl.wrap((function _callee$(l){for(;;)switch(l.prev=l.next){case 0:return(i=format(AM,e)).deliveryStatus=t.deliveryStatus?W_[t.deliveryStatus]:W_[W_.success],t.time&&(i.time=t.time),o=vM(),i.updateContent&&(s=format({status:{type:"number"}},s=deserialize(s=JSON.parse(i.updateContent),o.qchatMsgTag)),i.updateContent=s),i.updateOperatorInfo&&(c=formatMsgOperatorInfo(deserialize(c=JSON.parse(i.updateOperatorInfo),o.qchatMsgUpdateTag)),i.updateOperatorInfo=c),""===(null===(n=null==i?void 0:i.threadRefer)||void 0===n?void 0:n.fromAccount)&&delete i.threadRefer,""===(null===(a=null==i?void 0:i.replyRefer)||void 0===a?void 0:a.fromAccount)&&delete i.replyRefer,i.attach&&t.attachUrl&&(i.attach.url=t.attachUrl),l.next=11,formatMsgAttach(i,r);case 11:return l.abrupt("return",l.sent);case 12:case"end":return l.stop()}}),_callee)})))}function formatMsgAttach(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r;return Dl.wrap((function _callee2$(n){for(;;)switch(n.prev=n.next){case 0:if(includes(RM).call(RM,e.type)&&e.attach&&e.attach.url){n.next=2;break}return n.abrupt("return",e);case 2:if(t&&t.cloudStorage&&"function"==typeof t.cloudStorage.getPrivateUrl&&"function"==typeof t.cloudStorage.getOriginUrl){n.next=4;break}return n.abrupt("return",e);case 4:if(!(indexOf(r=e.attach.url).call(r,"_im_url=1")<0)){n.next=7;break}return e.attach.url=t.cloudStorage.getPrivateUrl(e.attach.url),n.abrupt("return",e);case 7:return n.prev=7,n.next=10,t.cloudStorage.getOriginUrl(e.attach.url);case 10:e.attach.url=n.sent,n.next=16;break;case 13:throw n.prev=13,n.t0=n.catch(7),new bl('url "'+e.attach.url+'" parse error',"message.attach.url","parse error");case 16:return n.abrupt("return",e);case 17:case"end":return n.stop()}}),_callee2,null,[[7,13]])})))}function formatMsgs(e,t,r){return void 0===t&&(t={}),__awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var n;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:if(En(e)&&e.length>0){a.next=2;break}return a.abrupt("return",[]);case 2:return n=map$6(e).call(e,(function(e){return formatMsg(e,t,r)})),a.next=5,Pi.all(n);case 5:return a.abrupt("return",a.sent);case 6:case"end":return a.stop()}}),_callee3)})))}var NM={totalCount:{type:"number"},lastUpdateTime:{type:"number"},details:{type:"object"}};function formatQuickComments(e){var t=map$6(e).call(e,(function(e){var t,r=format(NM,e);return r.details=map$6(t=r.details).call(t,(function(e){var t=e.createTime?bd(e.createTime):0;return t=isNaN(t)?0:t,{count:e.count,hasSelf:e.self,severalAccids:e.topN,type:e.type,createTime:t}})),r})),r={};return forEach$1(t).call(t,(function(e){return r[e.msgIdServer]=e})),r}var xM={type:{type:"number"},time:{type:"number"},opeType:{type:"number"}};var OM={includeSelf:{type:"number"},order:{type:"enum",values:__},sort:{type:"enum",values:$_},msgTypes:{type:"object"},subTypes:{type:"object"}};var PM={hasMore:{type:"boolean"},nextTimetag:{type:"number"},cursor:{type:"string"}};var LM={6:function _(e){return this.core.qchatChannel.subscribeForVisitorService.deleteAutoSetInServerId(e.serverId),!0},16:function _(e){return this.core.qchatChannel.subscribeForVisitorService.deleteAutoSetInChannel(e.serverId,e.channelId),!0},26:function _(e){var t=get(e,"attach.addAccids");return t&&includes(t).call(t,this.core.account)&&this.core.eventBus.emit("qchatChannel/serverIdentifyChange",e),!0},27:function _(e){var t=get(e,"attach.deleteAccids");return t&&includes(t).call(t,this.core.account)&&this.core.eventBus.emit("qchatChannel/serverIdentifyChange",e),!0},31:function _(e){var t,r;return 1===e.attach.event?(null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)&&this.core.qchatChannel.subscribeChannel({type:1,opeType:1,channels:[{serverId:e.serverId,channelId:e.channelId}],isInternalTrigger:!0}):2===e.attach.event&&(this.core.eventBus.emit("qchatChannel/autoUnSubscribe",e),this.core.eventBus.emit("qchatMedia/serverOrChannelLeave",e)),!0},32:function _(e){var t,r;return 2===e.attach.event?(this.core.eventBus.emit("qchatChannel/autoUnSubscribe",e),this.core.eventBus.emit("qchatMedia/serverOrChannelLeave",e)):1===e.attach.event&&(this.core.qchatChannel.subscribeForVisitorService.deleteServer(e.serverId),(null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)&&this.core.qchatServer.subscribeServer({type:4,opeType:1,servers:[{serverId:e.serverId}],isInternalTrigger:!0})),!0},34:function _(e){return 2===e.attach.event&&this.core.qchatChannel.subscribeForVisitorService.unSubscribeChannel(e.serverId,e.channelId),!0},101:function _(e){var t=pick(e,["serverId","channelId","ext","fromAccount","fromNick","time"]);return this.logger.log("qchat on recvTypingEvent: ",t),this.core.emit("recvTypingEvent",t),this.core.qchatMsg.emit("recvTypingEvent",t),!1}},VM=function(){function NotificationModuleService(e){this.core=e,this.logger=e.logger}var e=NotificationModuleService.prototype;return e.sendSystemNotification=function sendSystemNotification(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.core.sendCmd("qchatSendCustomSysMsg",{sysMsg:generatorSysMsgForCmd(e)});case 2:return t=n.sent,r=formatSystemNotification(t.content.sysMsg,this.logger),this.logger.getDebugMode()?this.logger.debug("sendCustomSysMsg success",r):this.logger.log("sendCustomSysMsg success",r.serverId,r.channelId,r.msgIdServer),n.abrupt("return",r);case 6:case"end":return n.stop()}}),_callee,this)})))},e.updateSystemNotification=function updateSystemNotification(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r,n,a,i;return Dl.wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:return t=e.systemNotification,r=__rest(e,["systemNotification"]),n=pick(t,["msgIdServer","type","body","ext","status"]),a=generatorSysMsgForCmd(n),o.next=5,this.core.sendCmd("qchatUpdateSystemNotification",{sysMsg:a,qchatMsgUpdateTag:Et(Et({},r),{operatorAccount:this.core.account,operatorClientType:lM.Web,pushPayload:bn(e.pushPayload),routeEnable:vu.boolean(e,"routeEnable")})});case 5:return i=o.sent,o.abrupt("return",formatSystemNotification(i.content.sysMsg,this.logger));case 7:case"end":return o.stop()}}),_callee2,this)})))},e.markSystemNotificationsRead=function markSystemNotificationsRead(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,this.core.sendCmd("qchatMarkSysMsgRead",{sysMsgs:map$6(t=e.systemNotifications).call(t,(function(e){return generatorSysMsgMarkersForCmd(e)}))});case 2:case"end":return r.stop()}}),_callee3,this)})))},e.onSysMsg=function onSysMsg(e){var t=e.content.sysMsg;if(t){var r=formatSystemNotification(t,this.core.logger),n=LM[Q_[r.type]];if(n)if(!1===n.call(this,r))return;var a={feature:"default",systemNotifications:[r]};this.logger.log("qchat on systemNotification: ",a),this.core.emit("systemNotification",a),this.core.qchatMsg.emit("systemNotification",a)}else this.core.logger.warn("No sysMsg in onSysMsg packet")},e.onMultiSysMsg=function onMultiSysMsg(e){var t=e.content.sysMsg;if(t){var r=formatSystemNotification(t,this.logger);this.core.emit("systemNotificationUpdate",r),this.core.qchatMsg.emit("systemNotificationUpdate",r)}},e.onSyncSysMsg=function onSyncSysMsg(e){var t=this,r=e.content.systemNotifications;if(r&&r.length>0){var n=map$6(r).call(r,(function(e){return formatSystemNotification(e,t.logger)}));this.core.emit("systemNotification",{feature:"sync",systemNotifications:n}),this.core.qchatMsg.emit("systemNotification",{feature:"sync",systemNotifications:n})}else this.logger.warn("sync system notification not exist")},NotificationModuleService}(),UM=["image","audio","video","file"],DM=function(){function MessageModuleService(e){var t=this;this.markMessageRead=throttle((function(e){return __awaiter(t,void 0,void 0,Dl.mark((function _callee(){var t,r;return Dl.wrap((function _callee$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.core.sendCmd("qchatMarkMessageRead",{markMsgReadTag:e});case 2:t=n.sent,r=formatUnreadInfo(t.content.unreadInfo),this.core.eventBus.emit("qchatChannel/updateUnreads",[r]);case 5:case"end":return n.stop()}}),_callee,this)})))}),200),this.core=e,this.logger=e.logger}var e=MessageModuleService.prototype;return e.sendMessage=function sendMessage(e){var t,r,n,a;return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var i,o,s,c,l,d;return Dl.wrap((function _callee2$(u){for(;;)switch(u.prev=u.next){case 0:if(!(indexOf(UM).call(UM,e.type)>-1)){u.next=4;break}return u.next=3,this.doSendFile(e);case 3:e.attach=u.sent;case 4:return i=generatorMsgForCmd(Et({fromAccount:this.core.account},e)),u.next=7,formatMsg(i,{time:(new Date).getTime(),deliveryStatus:W_.sending},this.core);case 7:o=u.sent;try{e.onSendBefore&&e.onSendBefore(o)}catch(e){this.logger.error("sendMsg: options.onSendBefore error",e)}return u.prev=9,u.next=12,this.core.sendCmd("qchatSendMsg",{qchatMsg:i});case 12:s=u.sent,u.next=22;break;case 15:return u.prev=15,u.t0=u.catch(9),u.next=19,formatMsg(i,{time:(new Date).getTime(),deliveryStatus:W_.failed,attachUrl:null===(t=o.attach)||void 0===t?void 0:t.url},this.core);case 19:throw c=u.sent,u.t0.msg=c,u.t0;case 22:return l=s.content,u.next=25,formatMsg(Et({},l.qchatMsg),{deliveryStatus:W_.success,attachUrl:null===(r=o.attach)||void 0===r?void 0:r.url},this.core);case 25:if(!(d=u.sent).isAntispam){u.next=29;break}throw{code:10403,msg:d,message:(null===(n=null==d?void 0:d.antiSpamInfo)||void 0===n?void 0:n.yidunAntiSpamRes)||"message has be antispam",isAntispam:!0,yidunAntiSpamRes:(null===(a=null==d?void 0:d.antiSpamInfo)||void 0===a?void 0:a.yidunAntiSpamRes)||""};case 29:return u.abrupt("return",d);case 30:case"end":return u.stop()}}),_callee2,this,[[9,15]])})))},e.doSendFile=function doSendFile(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:if(validate({type:{type:"enum",values:["image","audio","video","file"]},attach:{type:"object",rules:{url:{type:"string",allowEmpty:!1}},required:!1},maxSize:{type:"number",min:1,required:!1}},e),t=e.attach){r.next=15;break}if(this.core.cloudStorage&&this.core.cloudStorage.uploadFile){r.next=5;break}throw new Error('Service "cloudStorage" does not exist');case 5:return r.prev=5,r.next=8,this.core.cloudStorage.uploadFile(e);case 8:t=r.sent,r.next=15;break;case 11:throw r.prev=11,r.t0=r.catch(5),this.logger.error("sendFile:: upload File error or abort.",r.t0),r.t0;case 15:return r.abrupt("return",t);case 16:case"end":return r.stop()}}),_callee3,this,[[5,11]])})))},e.resendMessage=function resendMessage(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var n,a,i,o,s;return Dl.wrap((function _callee4$(c){for(;;)switch(c.prev=c.next){case 0:return(n=generatorMsgForCmd(Et(Et({},e),{resendFlag:!0}))).deliveryStatus=W_.sending,c.prev=2,c.next=5,this.core.sendCmd("qchatSendMsg",{qchatMsg:n});case 5:a=c.sent,c.next=15;break;case 8:return c.prev=8,c.t0=c.catch(2),c.next=12,formatMsg(n,{time:(new Date).getTime(),deliveryStatus:W_.failed},this.core);case 12:throw i=c.sent,c.t0.msg=i,c.t0;case 15:return o=a.content,c.next=18,formatMsg(Et({},o.qchatMsg),{deliveryStatus:W_.success},this.core);case 18:if(!(s=c.sent).isAntispam){c.next=22;break}throw{code:10403,msg:s,message:(null===(t=null==s?void 0:s.antiSpamInfo)||void 0===t?void 0:t.yidunAntiSpamRes)||"message has be antispam",isAntispam:!0,yidunAntiSpamRes:(null===(r=null==s?void 0:s.antiSpamInfo)||void 0===r?void 0:r.yidunAntiSpamRes)||""};case 22:return c.abrupt("return",s);case 23:case"end":return c.stop()}}),_callee4,this,[[2,8]])})))},e.doUpdateMessage=function doUpdateMessage(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var n,a,i,o,s;return Dl.wrap((function _callee5$(c){for(;;)switch(c.prev=c.next){case 0:return n=e.message,a=__rest(e,["message"]),(i=generatorMsgForCmd(n)).msgIdClient=void 0,i.time=n.time,c.next=6,this.core.sendCmd("qchatUpdateMessage",{qchatMsg:i,qchatMsgUpdateTag:Et(Et({},a),{operatorAccount:this.core.account,operatorClientType:lM.Web,pushPayload:bn(e.pushPayload),routeEnable:vu.boolean(e,"routeEnable")})});case 6:return o=c.sent,c.next=9,formatMsg(o.content.qchatMsg,{},this.core);case 9:if(s=c.sent,this.core.eventBus.emit("qchatChannel/changeUnread",s,!0),!o.content.qchatMsg.isAntispam){c.next=14;break}throw{code:10403,msg:i,message:(null===(t=o.content.qchatMsg)||void 0===t?void 0:t.yidunAntiSpamRes)||"message has be antispam",isAntispam:!0,yidunAntiSpamRes:(null===(r=o.content.qchatMsg)||void 0===r?void 0:r.yidunAntiSpamRes)||""};case 14:return c.abrupt("return",s);case 15:case"end":return c.stop()}}),_callee5,this)})))},e.getHistoryMessage=function getHistoryMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t,r,n,a=this;return Dl.wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,this.core.sendCmd("qchatGetHistoryMsg",{getHistoryMsgTag:Et(Et({},e),{reverse:reverse$1(e)?1:0})});case 2:return r=i.sent,n=r.content,i.next=6,Pi.all(map$6(t=n.qchatMsgs).call(t,(function(e){return formatMsg(e,{},a.core)})));case 6:return i.abrupt("return",i.sent);case 7:case"end":return i.stop()}}),_callee6,this)})))},e.getMentionedMeMessages=function getMentionedMeMessages(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var t,r,n,a,i,o=this;return Dl.wrap((function _callee7$(s){for(;;)switch(s.prev=s.next){case 0:return s.next=2,this.core.sendCmd("qchatGetMentionedMeMessages",{tag:e});case 2:return r=s.sent,n=r.content,c=n.page,a=format(PM,c),s.next=7,Pi.all(map$6(t=n.datas).call(t,(function(e){return formatMsg(e,{},o.core)})));case 7:return i=s.sent,s.abrupt("return",{pageInfo:a,messages:i});case 9:case"end":return s.stop()}var c}),_callee7,this)})))},e.areMentionedMeMessages=function areMentionedMeMessages(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t,r,n;return Dl.wrap((function _callee8$(a){for(;;)switch(a.prev=a.next){case 0:t={},r=0;case 2:if(!(r<e.length)){a.next=13;break}if((n=e[r]).fromAccount!==this.core.account){a.next=7;break}return t[n.msgIdClient]=!1,a.abrupt("continue",10);case 7:return a.next=9,this.core.qchatChannel.subscribeModuleService.getMentionedFlag(n,!0);case 9:t[n.msgIdClient]=a.sent;case 10:r++,a.next=2;break;case 13:return a.abrupt("return",t);case 14:case"end":return a.stop()}}),_callee8,this)})))},e.getLastMessageOfChannels=function getLastMessageOfChannels(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t,r,n;return Dl.wrap((function _callee9$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.core.sendCmd("qchatGetLastMessageOfChannels",{tag:e});case 2:return t=a.sent,r=t.content.msgs,a.next=6,formatMsgs(r,{},this.core);case 6:return n=a.sent,a.abrupt("return",reduce(n).call(n,(function(e,t){return e[t.channelId]=t,e}),{}));case 8:case"end":return a.stop()}}),_callee9,this)})))},e.messageSearchByPage=function messageSearchByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var t,r,n,a,i;return Dl.wrap((function _callee10$(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,this.core.sendCmd("qchatMessageSearchByPage",{qchatMessageSearchByPageTag:Et(Et({},(s=e,formatReverse(OM,s))),{includeSelf:e.includeSelf?1:""})});case 2:return t=o.sent,r=t.content,n=r.datas,a=r.listQueryTag,o.next=6,formatMsgs(n,{},this.core);case 6:return i=o.sent,o.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:a.nextTimetag?bd(a.nextTimetag):0,cursor:a.cursor},datas:i});case 8:case"end":return o.stop()}var s}),_callee10,this)})))},e.onMsg=function onMsg(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){var t,r;return Dl.wrap((function _callee11$(n){for(;;)switch(n.prev=n.next){case 0:if(t=e.content.qchatMsg){n.next=4;break}return this.logger.warn("No qchatMsg in qchatMsg packet"),n.abrupt("return");case 4:return n.next=6,formatMsg(t,{},this.core);case 6:r=n.sent,this.core.eventBus.emit("qchatChannel/changeUnread",r,!1),this.core.emit("message",r),this.core.qchatMsg.emit("message",r);case 10:case"end":return n.stop()}}),_callee11,this)})))},e.onRecvUnreadInfo=function onRecvUnreadInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t,r;return Dl.wrap((function _callee12$(n){for(;;)switch(n.prev=n.next){case 0:if(t=e.content.qchatMsg){n.next=3;break}return n.abrupt("return");case 3:return n.next=5,formatMsg(t);case 5:r=n.sent,this.core.eventBus.emit("qchatChannel/changeUnread",r,!1);case 7:case"end":return n.stop()}}),_callee12,this)})))},e.onMultiSyncRead=function onMultiSyncRead(e){var t=e.content.unreadInfo;if(t){var r=formatUnreadInfo(t);this.core.eventBus.emit("qchatChannel/updateUnreads",[r])}},e.onMultiSyncServersRead=function onMultiSyncServersRead(e){var t=e.content.qchatMultiSyncServersMessageReadTag;if(t){var r=formatClearServersUnread(t),n=r.successServerIds,a=r.ackTimestamp;this.core.eventBus.emit("qchatChannel/clearUnreadCountByServers",n,a)}},e.onRecvMsgUpdate=function onRecvMsgUpdate(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var t,r,n,a;return Dl.wrap((function _callee13$(i){for(;;)switch(i.prev=i.next){case 0:if(t=e.content.qchatMsg,r=e.content.qchatMsgUpdateInfo,t){i.next=4;break}return i.abrupt("return");case 4:return i.next=6,formatMsg(t,{},this.core);case 6:n=i.sent,a=formatMsgOperatorInfo(r),this.core.eventBus.emit("qchatChannel/changeUnread",n,!0),this.core.emit("messageUpdate",n,a),this.core.qchatMsg.emit("messageUpdate",n,a);case 11:case"end":return i.stop()}}),_callee13,this)})))},MessageModuleService}(),qM=function(){function ExtendModuleService(e){var t=this;this._sendTypingEvent=throttle((function(e){return __awaiter(t,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.core.sendCmd("qchatSendCustomSysMsg",{sysMsg:generatorSysMsgForCmd(Et(Et({},e),{resendFlag:!1,persistEnable:!1,routeEnable:!1,pushEnable:!1,needBadge:!1,needPushNick:!1}),Q_.msgTyping)});case 2:case"end":return t.stop()}}),_callee,this)})))}),3e3),this.core=e,this.logger=e.logger,this.lastChannelIdInTyping=""}var e=ExtendModuleService.prototype;return e.getMessageHistoryByIds=function getMessageHistoryByIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t,r;return Dl.wrap((function _callee2$(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.core.sendCmd("qchatGetMessageHistoryByIds",{channelInfo:{serverId:e.serverId,channelId:e.channelId},messageReferList:e.messageReferList});case 2:return r=n.sent,n.abrupt("return",Pi.all(map$6(t=r.content.qchatMsgs).call(t,(function(e){return formatMsg(e)}))));case 4:case"end":return n.stop()}}),_callee2,this)})))},e.getReferMessages=function getReferMessages(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var n;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:if((null===(t=e.message.replyRefer)||void 0===t?void 0:t.msgIdServer)&&(null===(r=e.message.threadRefer)||void 0===r?void 0:r.msgIdServer)){a.next=2;break}throw new Error("Message has no reply");case 2:return a.next=4,this.getMessageHistoryByIds({serverId:e.message.serverId,channelId:e.message.channelId,messageReferList:[e.message.replyRefer,e.message.threadRefer]});case 4:if(n=a.sent,e.referType!==J_[J_.all]){a.next=9;break}return a.abrupt("return",{replyMessage:n[0],threadMessage:n[1]});case 9:if(e.referType!==J_[J_.reply]){a.next=13;break}return a.abrupt("return",{replyMessage:n[0]});case 13:if(e.referType!==J_[J_.thread]){a.next=15;break}return a.abrupt("return",{threadMessage:n[1]});case 15:return a.abrupt("return",{replyMessage:n[0],threadMessage:n[1]});case 16:case"end":return a.stop()}}),_callee3,this)})))},e.getThreadMessages=function getThreadMessages(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var r,n,a,i,o;return Dl.wrap((function _callee4$(s){for(;;)switch(s.prev=s.next){case 0:return n=(null===(t=e.message.threadRefer)||void 0===t?void 0:t.msgIdServer)?Et({serverId:e.message.serverId,channelId:e.message.channelId},e.message.threadRefer):e.message,s.next=3,this.core.sendCmd("qchatGetThreadMessages",{qchatMsg:n,getThreadHistoryMsgTag:Et(Et({},e.messageQueryOption),{reverse:vu.boolean(e.messageQueryOption,"reverse")})});case 3:return a=s.sent,s.next=6,formatMsg(a.content.thread);case 6:return i=s.sent,s.next=9,Pi.all(map$6(r=a.content.qchatMsgs).call(r,(function(e){return formatMsg(e)})));case 9:return o=s.sent,s.abrupt("return",{thread:i,threadInfo:{messageCount:+a.content.threadInfo.messageCount,lastMessageTimestamp:+a.content.threadInfo.lastMessageTimestamp},messages:o});case 11:case"end":return s.stop()}}),_callee4,this)})))},e.getThreadRootMessagesMeta=function getThreadRootMessagesMeta(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t,r,n,a;return Dl.wrap((function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:return t=e.threadRootMessages,r=__rest(e,["threadRootMessages"]),i.next=3,this.core.sendCmd("qchatGetThreadRootMessagesMeta",{qchatMsgs:t,tag:r});case 3:if(n=i.sent,!((a=n.content.metas)&&a.length>0)){i.next=7;break}return i.abrupt("return",map$6(a).call(a,(function(e){return Et(Et({},e),{total:bd(e.total),timestamp:bd(e.timestamp),msgTime:bd(e.msgTime)})})));case 7:return i.abrupt("return",[]);case 8:case"end":return i.stop()}}),_callee5,this)})))},e.getQuickComments=function getQuickComments(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t,r,n;return Dl.wrap((function _callee6$(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.core.sendCmd("qchatGetQuickComments",{tag:{serverId:e.serverId,channelId:e.channelId,msgIdServerList:bn(map$6(t=e.msgList).call(t,(function(e){return e.msgIdServer})))}});case 2:return r=a.sent,n=r.content.quickCommentResponse,a.abrupt("return",formatQuickComments(n));case 5:case"end":return a.stop()}}),_callee6,this)})))},e.updateQuickComment=function updateQuickComment(e,t){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var r,n,a,i,o,s;return Dl.wrap((function _callee7$(c){for(;;)switch(c.prev=c.next){case 0:return validate({type:{type:"number"},commentMessage:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1}}}},e),r=e.commentMessage,n=r.serverId,a=r.channelId,i=r.fromAccount,o=r.msgIdServer,s=r.time,c.next=4,this.core.sendCmd("qchatUpdateQuickComment",{tag:{serverId:n,channelId:a,fromAccount:i,msgIdServer:o,time:s,type:e.type,opeType:t,opeAccid:this.core.account}});case 4:case"end":return c.stop()}}),_callee7,this)})))},e.sendTypingEvent=function sendTypingEvent(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){return Dl.wrap((function _callee8$(t){for(;;)switch(t.prev=t.next){case 0:if(e.channelId!==this.lastChannelIdInTyping){t.next=4;break}return this.logger.log("qchatMsg sendTypingEvent throttle"),this._sendTypingEvent(e),t.abrupt("return");case 4:this.lastChannelIdInTyping=e.channelId,this._sendTypingEvent.flush(),this._sendTypingEvent(e);case 7:case"end":return t.stop()}}),_callee8,this)})))},ExtendModuleService}(),BM=function(e){function QChatMsgService(t){var r;return(r=e.call(this,"qchatMsg",t)||this).core=t,r.lastChannelIdInMark="",registerParser({cmdMap:hM,cmdConfig:fM()}),r.notificationModuleService=new VM(t),r.messageModuleService=new DM(t),r.extendModuleService=new qM(t),r}_t(QChatMsgService,e);var t=QChatMsgService.prototype;return t.sendMessage=function sendMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(z_)},ext:{type:"string",required:!1},mentionAll:{type:"boolean",required:!1},mentionAccids:{type:"array",itemType:"string",required:!1},mentionRoleIds:{type:"array",itemType:"string",required:!1,min:1},historyEnable:{type:"boolean",required:!1},pushEnable:{type:"boolean",required:!1}},e),t.next=3,this.messageModuleService.sendMessage(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee,this)})))},t.updateMessage=function updateMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:if(validate({message:{type:"object",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number",min:0},body:{type:"string",required:!1},ext:{type:"string",required:!1}}}},e),!("number"==typeof e.message.status&&e.message.status<1e4)){t.next=3;break}throw new Rl("Status should be greater than or equal to 10000");case 3:return t.next=5,this.messageModuleService.doUpdateMessage(e);case 5:return t.abrupt("return",t.sent);case 6:case"end":return t.stop()}}),_callee2,this)})))},t.resendMessage=function resendMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdClient:{type:"string",allowEmpty:!1}},e),t.next=3,this.messageModuleService.resendMessage(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee3,this)})))},t.deleteMessage=function deleteMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return validate({message:{type:"object",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number",min:0}}}},e),(t=JSON.parse(bn(e))).message.status=2,r.next=5,this.messageModuleService.doUpdateMessage(t);case 5:return r.abrupt("return",r.sent);case 6:case"end":return r.stop()}}),_callee4,this)})))},t.revokeMessage=function revokeMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t;return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return validate({message:{type:"object",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number",min:0}}}},e),(t=JSON.parse(bn(e))).message=pick(t.message,["serverId","channelId","msgIdServer","time"]),t.message.status=1,r.next=6,this.messageModuleService.doUpdateMessage(t);case 6:return r.abrupt("return",r.sent);case 7:case"end":return r.stop()}}),_callee5,this)})))},t.markMessageRead=function markMessageRead(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:validate({serverId:{type:"string"},channelId:{type:"string"},time:{type:"number",min:0}},e),e.channelId!==this.lastChannelIdInMark&&this.messageModuleService.markMessageRead.flush(),this.lastChannelIdInMark=e.channelId,this.messageModuleService.markMessageRead(e);case 4:case"end":return t.stop()}}),_callee6,this)})))},t.replyMessage=function replyMessage(e){validate({replyMessage:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1}}}},e);var replyMessage=e.replyMessage;if(e.serverId!==replyMessage.serverId||e.channelId!==replyMessage.channelId)throw new Rl("Forbid replying to message from other server, channel");return this.sendMessage(e)},t.getMessageHistoryByIds=function getMessageHistoryByIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},messageReferList:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}}},e),t.next=3,this.extendModuleService.getMessageHistoryByIds(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee7,this)})))},t.getReferMessages=function getReferMessages(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){return Dl.wrap((function _callee8$(t){for(;;)switch(t.prev=t.next){case 0:return validate({message:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}},referType:{type:"enum",values:getEnumKeys(J_),required:!1}},e),t.next=3,this.extendModuleService.getReferMessages(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee8,this)})))},t.getThreadMessages=function getThreadMessages(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){return Dl.wrap((function _callee9$(t){for(;;)switch(t.prev=t.next){case 0:return validate({message:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}},messageQueryOption:{type:"object",rules:{beginTime:{type:"number",required:!1},endTime:{type:"number",required:!1},excludeMsgId:{type:"string",required:!1},limit:{type:"number",required:!1},reverse:{type:"boolean",required:!1}}}},e),t.next=3,this.extendModuleService.getThreadMessages(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee9,this)})))},t.getThreadRootMessagesMeta=function getThreadRootMessagesMeta(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){return Dl.wrap((function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},threadRootMessages:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1},time:{type:"number"}}}},e),t.next=3,this.extendModuleService.getThreadRootMessagesMeta(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee10,this)})))},t.sendSystemNotification=function sendSystemNotification(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},attach:{type:"object",required:!1}},e),t.next=3,this.notificationModuleService.sendSystemNotification(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee11,this)})))},t.updateSystemNotification=function updateSystemNotification(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){return Dl.wrap((function _callee12$(t){for(;;)switch(t.prev=t.next){case 0:return validate({systemNotification:{type:"object",rules:{msgIdServer:{type:"string",allowEmpty:!1},type:{type:"enum",values:getEnumKeys(Q_)},body:{type:"string",required:!1},ext:{type:"string",required:!1},status:{type:"number",required:!1}}}},e),t.next=3,this.notificationModuleService.updateSystemNotification(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee12,this)})))},t.markSystemNotificationsRead=function markSystemNotificationsRead(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){return Dl.wrap((function _callee13$(t){for(;;)switch(t.prev=t.next){case 0:return validate({systemNotifications:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1},type:{type:"string",allowEmpty:!1}},min:1}},e),t.next=3,this.notificationModuleService.markSystemNotificationsRead(e);case 3:case"end":return t.stop()}}),_callee13,this)})))},t.getHistoryMessage=function getHistoryMessage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){return Dl.wrap((function _callee14$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},beginTime:{type:"number",min:0,required:!1},endTime:{type:"number",min:0,required:!1},excludeMsgId:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,required:!1},reverse:{type:"boolean",required:!1}},e),t.next=3,this.messageModuleService.getHistoryMessage(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee14,this)})))},t.getMentionedMeMessages=function getMentionedMeMessages(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){return Dl.wrap((function _callee15$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},timestamp:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}},e),t.next=3,this.messageModuleService.getMentionedMeMessages(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee15,this)})))},t.areMentionedMeMessages=function areMentionedMeMessages(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var t;return Dl.wrap((function _callee16$(r){for(;;)switch(r.prev=r.next){case 0:if(validate({messages:{type:"array",rules:{serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgIdServer:{type:"string",allowEmpty:!1}},min:1}},e),every(t=e.messages).call(t,(function(t){return e.messages[0].serverId===t.serverId}))){r.next=4;break}throw new Rl("Different serverId",e,10414);case 4:if(!this.core.qchatChannel.subscribeForVisitorService.isInAutoServers(e.messages[0].serverId)){r.next=7;break}throw new Rl("Not allowed for visitor",e,10403);case 7:return r.next=9,this.messageModuleService.areMentionedMeMessages(e.messages);case 9:return r.abrupt("return",r.sent);case 10:case"end":return r.stop()}}),_callee16,this)})))},t.addQuickComment=function addQuickComment(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee17(){return Dl.wrap((function _callee17$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.extendModuleService.updateQuickComment(e,1);case 2:case"end":return t.stop()}}),_callee17,this)})))},t.removeQuickComment=function removeQuickComment(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){return Dl.wrap((function _callee18$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.extendModuleService.updateQuickComment(e,2);case 2:case"end":return t.stop()}}),_callee18,this)})))},t.getQuickComments=function getQuickComments(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){return Dl.wrap((function _callee19$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},msgList:{type:"array",rules:{msgIdServer:{type:"string",allowEmpty:!1}},min:1}},e),t.next=3,this.extendModuleService.getQuickComments(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee19,this)})))},t.sendTypingEvent=function sendTypingEvent(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){return Dl.wrap((function _callee20$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),t.next=3,this.extendModuleService.sendTypingEvent(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee20,this)})))},t.getLastMessageOfChannels=function getLastMessageOfChannels(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){return Dl.wrap((function _callee21$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelIdList:{type:"array",itemType:"string"}},e),t.next=3,this.messageModuleService.getLastMessageOfChannels(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee21,this)})))},t.qchatOnMsgHandler=function qchatOnMsgHandler(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee22(){return Dl.wrap((function _callee22$(t){for(;;)switch(t.prev=t.next){case 0:this.messageModuleService.onMsg(e);case 1:case"end":return t.stop()}}),_callee22,this)})))},t.qchatOnRecvUnreadInfoHandler=function qchatOnRecvUnreadInfoHandler(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee23(){return Dl.wrap((function _callee23$(t){for(;;)switch(t.prev=t.next){case 0:this.messageModuleService.onRecvUnreadInfo(e);case 1:case"end":return t.stop()}}),_callee23,this)})))},t.qchatOnSysMsgHandler=function qchatOnSysMsgHandler(e){this.notificationModuleService.onSysMsg(e)},t.qchatMultiSyncMessageReadHandler=function qchatMultiSyncMessageReadHandler(e){this.messageModuleService.onMultiSyncRead(e)},t.qchatMultiSyncSystemNotificationUpdateHandler=function qchatMultiSyncSystemNotificationUpdateHandler(e){this.notificationModuleService.onMultiSysMsg(e)},t.qchatSyncSystemNotificationHandler=function qchatSyncSystemNotificationHandler(e){this.notificationModuleService.onSyncSysMsg(e)},t.qchatRecvMessageUpdateHandler=function qchatRecvMessageUpdateHandler(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee24(){return Dl.wrap((function _callee24$(t){for(;;)switch(t.prev=t.next){case 0:this.messageModuleService.onRecvMsgUpdate(e);case 1:case"end":return t.stop()}}),_callee24,this)})))},t.searchMsgByPage=function searchMsgByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee25(){return Dl.wrap((function _callee25$(t){for(;;)switch(t.prev=t.next){case 0:return validate({keyword:{type:"string",allowEmpty:!1,required:!1},serverId:{type:"string",allowEmpty:!1,required:!0},channelId:{type:"string",allowEmpty:!1,required:!1},fromAccid:{type:"string",allowEmpty:!1,required:!1},fromTime:{type:"number",allowEmpty:!1,required:!1},toTime:{type:"number",allowEmpty:!1,required:!1},msgTypes:{type:"array",itemType:"string",allowEmpty:!1,required:!0},subTypes:{type:"array",itemType:"string",allowEmpty:!1,required:!1},includeSelf:{type:"boolean",allowEmpty:!1,required:!1},order:{type:"enum",values:getEnumKeys(__),required:!1},limit:{type:"number",min:0,required:!1},sort:{type:"enum",values:getEnumKeys($_),required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),t.next=3,this.messageModuleService.messageSearchByPage(e);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),_callee25,this)})))},t.qchatMultiSyncServersMessageReadHandler=function qchatMultiSyncServersMessageReadHandler(e){this.messageModuleService.onMultiSyncServersRead(e)},QChatMsgService}(T_),FM=function(){function CategoryModuleService(e){this.core=e}var e=CategoryModuleService.prototype;return e.addChannelCategoryRole=function addChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t;return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},parentRoleId:{type:"string",allowEmpty:!1}},e),r.next=3,this.core.sendCmd("qchatAddChannelCategoryRole",{qchatAddChannelCategoryRoleTag:e});case 3:return t=r.sent,r.abrupt("return",formatChannelCategoryRole(t.content.channelCategoryRole));case 5:case"end":return r.stop()}}),_callee,this)})))},e.removeChannelCategoryRole=function removeChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatRemoveChannelCategoryRole",e);case 3:case"end":return t.stop()}}),_callee2,this)})))},e.updateChannelCategoryRole=function updateChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},auths:{type:"object"}},e),r.next=3,this.core.sendCmd("qchatUpdateChannelCategoryRole",{qchatUpdateChannelCategoryRoleTag:generatorRoleForCmd(e)});case 3:if(406!==(t=r.sent).raw.code){r.next=6;break}throw new Rl("No update required",{},406);case 6:return r.abrupt("return",formatChannelCategoryRole(t.content.channelCategoryRole));case 7:case"end":return r.stop()}}),_callee3,this)})))},e.getChannelCategoryRole=function getChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetChannelCategoryRole",{qchatGetChannelCategoryRoleTag:e});case 3:return t=r.sent,r.abrupt("return",(n=t.content.list,En(n)&&n.length>0?map$6(n).call(n,(function(e){return formatChannelCategoryRole(e)})):[]));case 5:case"end":return r.stop()}var n}),_callee4,this)})))},e.addChannelCategoryMemberRole=function addChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t;return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),r.next=3,this.core.sendCmd("qchatAddChannelCategoryMemberRole",{qchatAddChannelCategoryMemberRoleTag:e});case 3:return t=r.sent,r.abrupt("return",formatChannelCategoryMemberRole(t.content.channelCategoryMemberRole));case 5:case"end":return r.stop()}}),_callee5,this)})))},e.removeChannelCategoryMemberRole=function removeChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){return Dl.wrap((function _callee6$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatRemoveChannelCategoryMemberRole",e);case 3:case"end":return t.stop()}}),_callee6,this)})))},e.updateChannelCategoryMemberRole=function updateChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){var t;return Dl.wrap((function _callee7$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},auths:{type:"object"}},e),r.next=3,this.core.sendCmd("qchatUpdateChannelCategoryMemberRole",{qchatUpdateChannelCategoryMemberRoleTag:generatorRoleForCmd(e)});case 3:if(406!==(t=r.sent).raw.code){r.next=6;break}throw new Rl("No update required",{},406);case 6:return r.abrupt("return",formatChannelCategoryMemberRole(t.content.channelCategoryMemberRole));case 7:case"end":return r.stop()}}),_callee7,this)})))},e.getChannelCategoryMemberRole=function getChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t;return Dl.wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},categoryId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetChannelCategoryMemberRole",{qchatGetChannelCategoryMemberRoleTag:e});case 3:return t=r.sent,r.abrupt("return",(n=t.content.list,En(n)&&n.length>0?map$6(n).call(n,(function(e){return formatChannelCategoryMemberRole(e)})):[]));case 5:case"end":return r.stop()}var n}),_callee8,this)})))},CategoryModuleService}(),GM=function(e){function QChatRoleService(t){var r;return(r=e.call(this,"qchatRole",t)||this).core=t,registerParser({cmdMap:TM,cmdConfig:EM()}),r.category=new FM(t),r}_t(QChatRoleService,e);var t=QChatRoleService.prototype;return t.createServerRole=function createServerRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t;return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},name:{type:"string",allowEmpty:!1},priority:{type:"number",min:1},icon:{type:"string",required:!1},ext:{type:"string",required:!1}},e),r.next=3,this.core.sendCmd("qchatCreateServerRole",{serverRole:Et(Et({},generatorRoleForCmd(e)),{type:q_.custom}),antispamTag:generateAntispamTag(e)});case 3:return t=r.sent,r.abrupt("return",formatRole(t.content.serverRole));case 5:case"end":return r.stop()}}),_callee,this)})))},t.updateServerRole=function updateServerRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var t;return Dl.wrap((function _callee2$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},name:{type:"string",required:!1},icon:{type:"string",required:!1},ext:{type:"string",required:!1},priority:{type:"number",required:!1},auths:{type:"object",required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateServerRole",{updateServerRoleTag:generatorRoleForCmd(e),antispamTag:generateAntispamTag(e)});case 3:return t=r.sent,r.abrupt("return",formatRole(t.content.serverRole));case 5:case"end":return r.stop()}}),_callee2,this)})))},t.deleteServerRole=function deleteServerRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatDeleteServerRole",e);case 3:case"end":return t.stop()}}),_callee3,this)})))},t.getServerRoles=function getServerRoles(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t,r,n;return Dl.wrap((function _callee4$(a){for(;;)switch(a.prev=a.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},categoryId:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,required:!1},priority:{type:"number",required:!1}},e),a.next=3,this.core.sendCmd("qchatGetServerRoles",{getServerRolesTag:generatorRoleForCmd(e)});case 3:return r=a.sent,n=filter(t=r.content.serverRoles).call(t,(function(e){return 1===bd(e.isMember)})),n=map$6(n).call(n,(function(e){return e.roleId})),a.abrupt("return",{roles:formatRoles(r.content.serverRoles),isMemberRoles:n});case 7:case"end":return a.stop()}}),_callee4,this)})))},t.addChannelRole=function addChannelRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t;return Dl.wrap((function _callee5$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},parentRoleId:{type:"string",allowEmpty:!1}},e),r.next=3,this.core.sendCmd("qchatAddChannelRole",{channelRole:generatorRoleForCmd(e)});case 3:return t=r.sent,r.abrupt("return",formatRole(t.content.channelRole));case 5:case"end":return r.stop()}}),_callee5,this)})))},t.getChannelRoles=function getChannelRoles(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t;return Dl.wrap((function _callee6$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetChannelRoles",{getChannelRolesTag:e});case 3:return t=r.sent,r.abrupt("return",formatRoles(t.content.channelRoles));case 5:case"end":return r.stop()}}),_callee6,this)})))},t.removeChannelRole=function removeChannelRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatRemoveChannelRole",e);case 3:case"end":return t.stop()}}),_callee7,this)})))},t.updateChannelRole=function updateChannelRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var t;return Dl.wrap((function _callee8$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},auths:{type:"object",required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateChannelRole",{updateChannelRoleTag:generatorRoleForCmd(e)});case 3:if(406!==(t=r.sent).raw.code){r.next=6;break}throw new Rl("No update required",{},406);case 6:return r.abrupt("return",formatRole(t.content.channelRole));case 7:case"end":return r.stop()}}),_callee8,this)})))},t.addMemberRole=function addMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t;return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),r.next=3,this.core.sendCmd("qchatAddMemberRole",{memberRole:e});case 3:return t=r.sent,r.abrupt("return",formatRole(t.content.memberRole));case 5:case"end":return r.stop()}}),_callee9,this)})))},t.getMemberRoles=function getMemberRoles(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){var t;return Dl.wrap((function _callee10$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetMemberRoles",{getMemberRolesTag:e});case 3:return t=r.sent,r.abrupt("return",formatRoles(t.content.memberRoles));case 5:case"end":return r.stop()}}),_callee10,this)})))},t.removeMemberRole=function removeMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1}},e),t.next=3,this.core.sendCmd("qchatRemoveMemberRole",{memberRole:e});case 3:case"end":return t.stop()}}),_callee11,this)})))},t.updateMemberRole=function updateMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){var t;return Dl.wrap((function _callee12$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},auths:{type:"object",required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateMemberRole",{updateMemberRoleTag:generatorRoleForCmd(e)});case 3:if(406!==(t=r.sent).raw.code){r.next=6;break}throw new Rl("No update required",{},406);case 6:return r.abrupt("return",formatRole(t.content.memberRole));case 7:case"end":return r.stop()}}),_callee12,this)})))},t.addMembersToServerRole=function addMembersToServerRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var t,r,n;return Dl.wrap((function _callee13$(a){for(;;)switch(a.prev=a.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string",min:1}},e),a.next=3,this.core.sendCmd("qchatAddMembersToServerRole",Et(Et({},e),{accids:bn(e.accids)}));case 3:return t=a.sent,r=get(t,"content.accids.successAccids"),n=get(t,"content.accids.failedAccids"),a.abrupt("return",{successAccids:r?JSON.parse(r):[],failedAccids:n?JSON.parse(n):[]});case 7:case"end":return a.stop()}}),_callee13,this)})))},t.removeMembersFromServerRole=function removeMembersFromServerRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var t,r,n;return Dl.wrap((function _callee14$(a){for(;;)switch(a.prev=a.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string",min:1}},e),a.next=3,this.core.sendCmd("qchatRemoveMembersFromServerRole",Et(Et({},e),{accids:bn(e.accids)}));case 3:return t=a.sent,r=get(t,"content.accids.successAccids"),n=get(t,"content.accids.failedAccids"),a.abrupt("return",{successAccids:r?JSON.parse(r):[],failedAccids:n?JSON.parse(n):[]});case 7:case"end":return a.stop()}}),_callee14,this)})))},t.getMembersFromServerRole=function getMembersFromServerRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){var t;return Dl.wrap((function _callee15$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},accid:{type:"string",allowEmpty:!1,required:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetMembersFromServerRole",{getMembersFromServerRoleTag:e});case 3:return t=r.sent,r.abrupt("return",formatRoles(t.content.members));case 5:case"end":return r.stop()}}),_callee15,this)})))},t.getServerRolesByAccid=function getServerRolesByAccid(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var t;return Dl.wrap((function _callee16$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},timetag:{type:"number",required:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetServerRolesByAccid",{getServerRolesByAccidTag:e});case 3:return t=r.sent,r.abrupt("return",formatRoles(t.content.serverRoles));case 5:case"end":return r.stop()}}),_callee16,this)})))},t.getExistingServerRolesByAccids=function getExistingServerRolesByAccids(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee17(){var t,r,n;return Dl.wrap((function _callee17$(a){for(;;)switch(a.prev=a.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string"}},e),a.next=3,this.core.sendCmd("qchatGetExistingServerRolesByAccids",{serverId:e.serverId,accids:bn(e.accids)});case 3:return t=a.sent,a.prev=4,n=JSON.parse(t.content.serverRoles),forEach$1(r=Nt(n)).call(r,(function(e){var t;forEach$1(t=n[e]).call(t,(function(t,r){n[e][r]=deserialize(t,bM().serverRole)})),n[e]=formatRoles(n[e])})),a.abrupt("return",n);case 10:throw a.prev=10,a.t0=a.catch(4),this.logger.error("can not parse serverRolesGroupByAccid from "+e.serverId+" and "+e.accids,t.content.serverRoles),a.t0;case 14:case"end":return a.stop()}}),_callee17,this,[[4,10]])})))},t.getExistingChannelRolesByServerRoleIds=function getExistingChannelRolesByServerRoleIds(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){var t;return Dl.wrap((function _callee18$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},roleIds:{type:"array",itemType:"string"}},e),r.next=3,this.core.sendCmd("qchatGetExistingChannelRolesByServerRoleIds",{serverId:e.serverId,channelId:e.channelId,roleIds:bn(e.roleIds)});case 3:return t=r.sent,r.abrupt("return",formatRoles(t.content.channelRoles));case 5:case"end":return r.stop()}}),_callee18,this)})))},t.getExistingAccidsOfMemberRoles=function getExistingAccidsOfMemberRoles(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){var t,r;return Dl.wrap((function _callee19$(n){for(;;)switch(n.prev=n.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string"}},e),n.next=3,this.core.sendCmd("qchatGetExistingAccidsOfMemberRoles",{serverId:e.serverId,channelId:e.channelId,accids:bn(e.accids)});case 3:return t=n.sent,r=t.content.memberRoles,n.abrupt("return",r&&r.length>0?map$6(r).call(r,(function(e){return e.accid})):[]);case 6:case"end":return n.stop()}}),_callee19,this)})))},t.getExistingAccidsInServerRole=function getExistingAccidsInServerRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){var t,r;return Dl.wrap((function _callee20$(n){for(;;)switch(n.prev=n.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},roleId:{type:"string",allowEmpty:!1},accids:{type:"array",itemType:"string"}},e),n.next=3,this.core.sendCmd("qchatGetExistingAccidsInServerRole",{serverId:e.serverId,roleId:e.roleId,accids:bn(e.accids)});case 3:return t=n.sent,r=t.content.members,n.abrupt("return",r&&r.length>0?map$6(r).call(r,(function(e){return e.accid})):[]);case 6:case"end":return n.stop()}}),_callee20,this)})))},t.updateServerRolePriorities=function updateServerRolePriorities(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){var t,r;return Dl.wrap((function _callee21$(n){for(;;)switch(n.prev=n.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},serverRoles:{type:"array"}},e),n.next=3,this.core.sendCmd("qchatUpdateServerRolePriorities",{serverId:e.serverId,serverRoles:map$6(t=e.serverRoles).call(t,(function(e){return{serverId:e.serverId,roleId:e.roleId,priority:e.priority}}))});case 3:return r=n.sent,n.abrupt("return",formatRoles(r.content.serverRoles));case 5:case"end":return n.stop()}}),_callee21,this)})))},t.checkPermission=function checkPermission(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee22(){var t;return Dl.wrap((function _callee22$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},auth:{type:"string"}},e),r.next=3,this.core.sendCmd("qchatCheckPermission",{checkPermissionTag:Et(Et({},e),{auth:G_[e.auth]||e.auth})});case 3:return t=r.sent,r.abrupt("return",t.content.checked);case 5:case"end":return r.stop()}}),_callee22,this)})))},t.addChannelCategoryRole=function addChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee23(){return Dl.wrap((function _callee23$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.addChannelCategoryRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee23,this)})))},t.removeChannelCategoryRole=function removeChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee24(){return Dl.wrap((function _callee24$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.removeChannelCategoryRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee24,this)})))},t.updateChannelCategoryRole=function updateChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee25(){return Dl.wrap((function _callee25$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.updateChannelCategoryRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee25,this)})))},t.getChannelCategoryRole=function getChannelCategoryRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee26(){return Dl.wrap((function _callee26$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.getChannelCategoryRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee26,this)})))},t.addChannelCategoryMemberRole=function addChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee27(){return Dl.wrap((function _callee27$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.addChannelCategoryMemberRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee27,this)})))},t.removeChannelCategoryMemberRole=function removeChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee28(){return Dl.wrap((function _callee28$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.removeChannelCategoryMemberRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee28,this)})))},t.updateChannelCategoryMemberRole=function updateChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee29(){return Dl.wrap((function _callee29$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.updateChannelCategoryMemberRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee29,this)})))},t.getChannelCategoryMemberRole=function getChannelCategoryMemberRole(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee30(){return Dl.wrap((function _callee30$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.category.getChannelCategoryMemberRole(e);case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),_callee30,this)})))},t.checkPermissions=function checkPermissions(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee31(){var t,r,n,a;return Dl.wrap((function _callee31$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},channelId:{type:"string",allowEmpty:!1,required:!1},auths:{type:"array",itemType:"string"}},e),this.core.logger.log("qchatRole::checkPermission options is",e),i.next=4,this.core.sendCmd("qchatCheckPermissions",{checkPermissionsTag:Et(Et({},e),{auths:bn(map$6(t=e.auths).call(t,(function(e){return G_[e]||e})))})});case 4:return n=i.sent,this.core.logger.log("qchatRole::checkPermission result is",n.content),a={},forEach$1(r=n.content.checkPermissionsResult).call(r,(function(e){a[e.auth]=e.isAllow})),this.core.logger.log("qchatRole::checkPermission auths is",a),i.abrupt("return",formatRoleAuths(a));case 10:case"end":return i.stop()}}),_callee31,this)})))},QChatRoleService}(T_);function _createForOfIteratorHelperLoose(e,t){var r,n=void 0!==Go&&Ol(e)||e["@@iterator"];if(n)return bind$1(r=(n=n.call(e)).next).call(r,n);if(En(e)||(n=function _unsupportedIterableToArray(e,t){if(e){var r;if("string"==typeof e)return _arrayLikeToArray(e,t);var n=slice(r={}.toString.call(e)).call(r,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?xl(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0;return function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}var HM=function(e){function QChatServerService(t){var r;return(r=e.call(this,"qchatServer",t)||this).core=t,registerParser({cmdMap:_M,cmdConfig:SM()}),r}_t(QChatServerService,e);var t=QChatServerService.prototype;return t.createServer=function createServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t;return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:return validate({icon:{type:"string",required:!1},name:{type:"string",required:!1},ext:{type:"string",required:!1},searchType:{type:"number",required:!1,min:0},searchEnable:{type:"boolean",required:!1},inviteMode:{type:"number",min:0,max:1,required:!1},applyMode:{type:"number",min:0,max:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatCreateServer",{serverInfo:Et(Et({},e),{searchEnable:!1===e.searchEnable?0:1}),antispamTag:generateAntispamTag(e)});case 3:return t=r.sent,r.abrupt("return",formatServer(t.content.serverInfo));case 5:case"end":return r.stop()}}),_callee,this)})))},t.deleteServer=function deleteServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1}},e),t.next=3,this.core.sendCmd("qchatDeleteServer",e);case 3:case"end":return t.stop()}}),_callee2,this)})))},t.updateServer=function updateServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var t;return Dl.wrap((function _callee3$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",min:1},icon:{type:"string",required:!1},name:{type:"string",required:!1},ext:{type:"string",required:!1},searchType:{type:"number",required:!1,min:0},searchEnable:{type:"boolean",required:!1},inviteMode:{type:"number",min:0,max:1,required:!1},applyMode:{type:"number",min:0,max:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateServer",{serverInfo:Et(Et({},e),{searchEnable:!1===e.searchEnable?0:1}),antispamTag:generateAntispamTag(e)});case 3:return t=r.sent,r.abrupt("return",formatServer(t.content.serverInfo));case 5:case"end":return r.stop()}}),_callee3,this)})))},t.getServers=function getServers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverIds:{type:"array",itemType:"string",min:1}},e),r.next=3,this.core.sendCmd("qchatGetServers",e);case 3:return t=r.sent,r.abrupt("return",formatServers(t.content.serverList));case 5:case"end":return r.stop()}}),_callee4,this)})))},t.getServersByPage=function getServersByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){var t,r,n,a;return Dl.wrap((function _callee5$(i){for(;;)switch(i.prev=i.next){case 0:return validate({timestamp:{type:"number"},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetServersByPage",{tag:e});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatServers(n)});case 6:case"end":return i.stop()}}),_callee5,this)})))},t.inviteServerMembers=function inviteServerMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var t,r;return Dl.wrap((function _callee6$(n){for(;;)switch(n.prev=n.next){case 0:return validate({serverId:{type:"string",min:1},accids:{type:"array",itemType:"string",min:1},ps:{type:"string"},params:{type:"object",rules:{ttl:{type:"number"}},required:!1}},e),n.next=3,this.core.sendCmd("qchatInviteServerMembers",e);case 3:return t=n.sent,r=t.content.record||{},n.abrupt("return",{failByOverAccids:t.content.failByOverAccids,failByBanAccids:t.content.failByBanAccids,recordInfo:formatInviteApplyRecord(r)});case 6:case"end":return n.stop()}}),_callee6,this)})))},t.acceptServerInvite=function acceptServerInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),t.next=3,this.core.sendCmd("qchatAcceptServerInvite",e);case 3:case"end":return t.stop()}}),_callee7,this)})))},t.rejectInviteServer=function rejectInviteServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){return Dl.wrap((function _callee8$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},ps:{type:"string"},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),t.next=3,this.core.sendCmd("qchatRejectInviteServer",e);case 3:case"end":return t.stop()}}),_callee8,this)})))},t.applyServerJoin=function applyServerJoin(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t;return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",min:1},ps:{type:"string"},params:{type:"object",rules:{ttl:{type:"number"}},required:!1}},e),r.next=3,this.core.sendCmd("qchatApplyServerJoin",e);case 3:return t=r.sent,r.abrupt("return",formatInviteApplyRecord(t.content.data));case 5:case"end":return r.stop()}}),_callee9,this)})))},t.acceptServerApply=function acceptServerApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){return Dl.wrap((function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),t.next=3,this.core.sendCmd("qchatAcceptServerApply",e);case 3:case"end":return t.stop()}}),_callee10,this)})))},t.rejectServerApply=function rejectServerApply(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},ps:{type:"string"},recordInfo:{type:"object",rules:{requestId:{type:"string",allowEmpty:!1}}}},e),t.next=3,this.core.sendCmd("qchatRejectServerApply",e);case 3:case"end":return t.stop()}}),_callee11,this)})))},t.kickServerMembers=function kickServerMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){return Dl.wrap((function _callee12$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1},accids:{type:"array",itemType:"string",min:1}},e),t.next=3,this.core.sendCmd("qchatKickServerMembers",e);case 3:case"end":return t.stop()}}),_callee12,this)})))},t.leaveServer=function leaveServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){return Dl.wrap((function _callee13$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",min:1}},e),t.next=3,this.core.sendCmd("qchatLeaveServer",e);case 3:case"end":return t.stop()}}),_callee13,this)})))},t.updateMyMemberInfo=function updateMyMemberInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var t;return Dl.wrap((function _callee14$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",min:1},accid:{type:"string",required:!1},nick:{type:"string",allowEmpty:!0,required:!1},avatar:{type:"string",required:!1},ext:{type:"string",required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateMyMemberInfo",{memberInfo:e,antispamTag:generateAntispamTag(e)});case 3:return t=r.sent,r.abrupt("return",formatMember$1(t.content.memberInfo));case 5:case"end":return r.stop()}}),_callee14,this)})))},t.updateServerMemberInfo=function updateServerMemberInfo(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee15(){var t;return Dl.wrap((function _callee15$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",min:1},accid:{type:"string",min:1},nick:{type:"string",required:!1},avatar:{type:"string",required:!1}},e),r.next=3,this.core.sendCmd("qchatUpdateServerMemberInfo",{memberInfo:e,antispamTag:generateAntispamTag(e)});case 3:return t=r.sent,r.abrupt("return",formatMember$1(t.content.memberInfo));case 5:case"end":return r.stop()}}),_callee15,this)})))},t.getServerMembers=function getServerMembers(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee16(){var t,r,n,a,i;return Dl.wrap((function _callee16$(o){for(;;)switch(o.prev=o.next){case 0:if(validate({accids:{type:"array"}},e),t=[],e.accids.length)for(r=_createForOfIteratorHelperLoose(e.accids);!(n=r()).done;)a=n.value,t.push(a.serverId+"|"+a.accid);return o.next=5,this.core.sendCmd("qchatGetServerMembers",{accids:t});case 5:return i=o.sent,o.abrupt("return",formatMembers$1(i.content.accidList));case 7:case"end":return o.stop()}}),_callee16,this)})))},t.getServerMembersByPage=function getServerMembersByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee17(){var t,r,n,a;return Dl.wrap((function _callee17$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",min:1},timetag:{type:"number"},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetServerMembersByPage",{tag:e});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatMembers$1(n)});case 6:case"end":return i.stop()}}),_callee17,this)})))},t.subscribeServer=function subscribeServer(e){var t,r,n,a;return __awaiter(this,void 0,void 0,Dl.mark((function _callee18(){var i,o,s,c;return Dl.wrap((function _callee18$(l){for(;;)switch(l.prev=l.next){case 0:if(validate({type:{type:"number",min:4,max:4,required:!1},opeType:{type:"number",min:1,max:2}},e),!(null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)||e.isInternalTrigger){l.next=3;break}throw new Rl("subscribe server failed, manual subscribe is not allowed in auto subscribe mode",{},403);case 3:if(e.type||(e.type=4),!e.servers.length){l.next=12;break}return o=Et(Et({},e),{channels:map$6(i=e.servers).call(i,(function(e){return{serverId:e.serverId,channelId:""}}))}),l.next=8,this.core.qchatChannel.subscribeModuleService.subscribe(o);case 8:return s=l.sent,c=s.failedChannels,(null===(a=null===(n=this.core.qchatChannel)||void 0===n?void 0:n.config)||void 0===a?void 0:a.autoSubscribe)?this.core.qchatChannel.subscribeModuleService.cacheAutoSubscribe(o):this.core.qchatChannel.subscribeModuleService.cacheSubscribe(o),l.abrupt("return",{failedServers:c});case 12:case"end":return l.stop()}}),_callee18,this)})))},t.banServerMember=function banServerMember(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee19(){return Dl.wrap((function _callee19$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),t.next=3,this.core.sendCmd("qchatUpdateServerMemberBan",{tag:Et(Et({},e),{opeType:1})});case 3:case"end":return t.stop()}}),_callee19,this)})))},t.unbanServerMember=function unbanServerMember(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee20(){return Dl.wrap((function _callee20$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},accid:{type:"string",allowEmpty:!1},ext:{type:"string",required:!1}},e),t.next=3,this.core.sendCmd("qchatUpdateServerMemberBan",{tag:Et(Et({},e),{opeType:2})});case 3:case"end":return t.stop()}}),_callee20,this)})))},t.getBannedMembersByPage=function getBannedMembersByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee21(){var t,r,n,a;return Dl.wrap((function _callee21$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},timetag:{type:"number",min:0},limit:{type:"number",min:1,required:!1}},e),i.next=3,this.core.sendCmd("qchatGetBannedMembersByPage",{tag:e});case 3:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag)},datas:formatServerMemberBanInfos(n)});case 6:case"end":return i.stop()}}),_callee21,this)})))},t.serverSearchByPage=function serverSearchByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee22(){var t,r,n,a;return Dl.wrap((function _callee22$(i){for(;;)switch(i.prev=i.next){case 0:if(validate({keyword:{type:"string",allowEmpty:!1},startTime:{type:"number",min:0,required:!1},endTime:{type:"number",min:0,required:!1},limit:{type:"number",min:1,required:!1},serverType:{type:"array",itemType:"number",min:0,required:!1},order:{type:"enum",values:getEnumKeys(__),required:!1},searchType:{type:"enum",values:getEnumKeys(I_)},sort:{type:"enum",values:getEnumKeys(M_),required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),!(e.startTime&&e.endTime&&e.startTime>=e.endTime)){i.next=3;break}throw new Tl("startTime more than endTime",e,"timeRule");case 3:return i.next=5,this.core.sendCmd("qchatServerSearchByPage",{tag:Et(Et({},e),{order:e.order&&__[e.order],searchType:I_[e.searchType],sort:sort(e)&&M_[sort(e)],serverType:bn(e.serverType)})});case 5:return t=i.sent,r=t.content,n=r.datas,a=r.listQueryTag,i.abrupt("return",{listQueryTag:{hasMore:1==+a.hasMore,nextTimetag:bd(a.nextTimetag),cursor:a.cursor},datas:formatServers(n)});case 8:case"end":return i.stop()}}),_callee22,this)})))},t.serverMemberSearchByPage=function serverMemberSearchByPage(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee23(){var t;return Dl.wrap((function _callee23$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},keyword:{type:"string",allowEmpty:!1},limit:{type:"number",min:1,required:!1}},e),r.next=3,this.core.sendCmd("qchatServerMemberSearchByPage",{tag:e});case 3:return t=r.sent,r.abrupt("return",formatMembers$1(t.content.members));case 5:case"end":return r.stop()}}),_callee23,this)})))},t.generateInviteCode=function generateInviteCode(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee24(){var t;return Dl.wrap((function _callee24$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},ttl:{type:"number",min:0,required:!1}},e),r.next=3,this.core.sendCmd("qchatGenerateInviteCode",{tag:e});case 3:return t=r.sent,r.abrupt("return",format({expireTime:{type:"number"}},t.content.data));case 5:case"end":return r.stop()}}),_callee24,this)})))},t.joinByInviteCode=function joinByInviteCode(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee25(){return Dl.wrap((function _callee25$(t){for(;;)switch(t.prev=t.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},inviteCode:{type:"string",allowEmpty:!1},ps:{type:"string",required:!1}},e),t.next=3,this.core.sendCmd("qchatJoinByInviteCode",{tag:e});case 3:case"end":return t.stop()}}),_callee25,this)})))},t.getInviteApplyRecordOfServer=function getInviteApplyRecordOfServer(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee26(){var t;return Dl.wrap((function _callee26$(r){for(;;)switch(r.prev=r.next){case 0:return validate({serverId:{type:"string",allowEmpty:!1},fromTime:{type:"number",min:0},toTime:{type:"number",min:0},reverse:{type:"boolean",required:!1},limit:{type:"number",min:1,required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetInviteApplyRecordOfServer",{tag:Et(Et({},e),{reverse:reverse$1(e)?1:0})});case 3:return t=r.sent,r.abrupt("return",formatInviteApplyRecords(t.content.data));case 5:case"end":return r.stop()}}),_callee26,this)})))},t.getInviteApplyRecordOfSelf=function getInviteApplyRecordOfSelf(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee27(){var t;return Dl.wrap((function _callee27$(r){for(;;)switch(r.prev=r.next){case 0:return validate({fromTime:{type:"number",min:0},toTime:{type:"number",min:0},reverse:{type:"boolean",required:!1},limit:{type:"number",min:1,required:!1},cursor:{type:"string",allowEmpty:!1,required:!1}},e),r.next=3,this.core.sendCmd("qchatGetInviteApplyRecordOfSelf",{tag:Et(Et({},e),{reverse:reverse$1(e)?1:0})});case 3:return t=r.sent,r.abrupt("return",formatInviteApplyRecords(t.content.data));case 5:case"end":return r.stop()}}),_callee27,this)})))},t.markRead=function markRead(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee28(){var t,r,n,a;return Dl.wrap((function _callee28$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverIds:{type:"array",itemType:"string",required:!0}},e),i.next=3,this.core.sendCmd("qchatClearServersUnread",e);case 3:return t=i.sent,r=formatClearServersUnread(t.content.clearServersUnreadTag),n=r.successServerIds,a=r.ackTimestamp,this.logger.log("qchatServer::clearServersUnread:: begin auto clear servers unreadInfo"),this.core.eventBus.emit("qchatChannel/clearUnreadCountByServers",n,a),i.abrupt("return",r);case 9:case"end":return i.stop()}}),_callee28,this)})))},t.subscribeAllChannel=function subscribeAllChannel(e){var t,r;return __awaiter(this,void 0,void 0,Dl.mark((function _callee29(){var n,a,i;return Dl.wrap((function _callee29$(o){for(;;)switch(o.prev=o.next){case 0:if(validate({type:{type:"number",required:!0},serverIds:{type:"array",itemType:"string",required:!0,max:10}},e),!(null===(r=null===(t=this.core.qchatChannel)||void 0===t?void 0:t.config)||void 0===r?void 0:r.autoSubscribe)){o.next=3;break}throw new Rl("subscribe channel failed, manual subscribe is not allowed in auto subscribe mode.",{},403);case 3:return o.next=5,this.core.sendCmd("qchatSubscribeChannelsByServers",e,{timeout:3e4});case 5:return(a=o.sent).content.unreadInfos=formatUnreadInfos(a.content.unreadInfos),a.content.failServerIds=formatFailServerIds(a.content.failServerIds),i={type:e.type,opeType:1,channels:map$6(n=a.content.unreadInfos).call(n,(function(e){return{serverId:e.serverId,channelId:e.channelId}}))},this.core.eventBus.emit("qchatChannel/cacheSubscribe",i),this.core.eventBus.emit("qchatChannel/getRoleIdsByServerId",e.serverIds),this.core.eventBus.emit("qchatChannel/updateUnreads",a.content.unreadInfos),o.abrupt("return",a.content);case 13:case"end":return o.stop()}}),_callee29,this)})))},t.enterAsVisitor=function enterAsVisitor(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee30(){var t,r,n;return Dl.wrap((function _callee30$(a){for(;;)switch(a.prev=a.next){case 0:return validate({serverIds:{type:"array",itemType:"string",min:1}},e),a.next=3,this.core.sendCmd("qchatEnterAsVisitor",{tag:{serverIds:bn(e.serverIds)}});case 3:return t=a.sent,r=formatFailServerIds(t.content.failServerIds),n=difference(e.serverIds,r),this.core.qchatChannel.subscribeForVisitorService.cacheServer(n),a.abrupt("return",{failedServers:r});case 8:case"end":return a.stop()}}),_callee30,this)})))},t.leaveAsVisitor=function leaveAsVisitor(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee31(){var t,r,n,a=this;return Dl.wrap((function _callee31$(i){for(;;)switch(i.prev=i.next){case 0:return validate({serverIds:{type:"array",itemType:"string",min:1}},e),i.next=3,this.core.sendCmd("qchatLeaveAsVisitor",{tag:{serverIds:bn(e.serverIds)}});case 3:return t=i.sent,r=formatFailServerIds(t.content.failServerIds),n=difference(e.serverIds,r),forEach$1(n).call(n,(function(e){a.core.qchatChannel.subscribeForVisitorService.deleteServer(e)})),i.abrupt("return",{failedServers:r});case 8:case"end":return i.stop()}}),_callee31,this)})))},t.subscribeAsVisitor=function subscribeAsVisitor(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee32(){return Dl.wrap((function _callee32$(t){for(;;)switch(t.prev=t.next){case 0:if(validate({opeType:{type:"number",min:1,max:2},type:{type:"number",required:!1},serverIds:{type:"array",itemType:"string",min:1}},e),!e.serverIds.length){t.next=5;break}return t.next=4,this.core.qchatChannel.subscribeForVisitorService.subscribeServerAsVisitor(e);case 4:return t.abrupt("return",t.sent);case 5:return t.abrupt("return",{failedServers:[]});case 6:case"end":return t.stop()}}),_callee32,this)})))},QChatServerService}(T_),jM=function(e){function V2NIMNotificationServiceImpl(t,r){var n;return(n=e.call(this,"V2NIMNotificationService",t)||this).config={compatibleWithV1:!0},n.notificationUtil=new Th(n.core),n.core._registerDep(jp,"V2NIMConversationIdUtil"),"v2"!==n.core.options.apiVersion?De(n):(registerParser({cmdMap:gh,cmdConfig:yh}),n.setOptions(r),n)}_t(V2NIMNotificationServiceImpl,e);var t=V2NIMNotificationServiceImpl.prototype;return t.setOptions=function setOptions(e){var t;(null===(t=this.core.systemMessage)||void 0===t?void 0:t.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Et(this.config,e)},t.emit=function emit(t){for(var r,n,a=this.name+"::emit "+t.toString(),i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if("onReceiveCustomNotifications"===t){var c=o[0];this.logger.log(""+a,map$6(c).call(c,(function(e){return"sender:"+e.senderId+";receiver:"+e.receiverId+";ctype:"+e.conversationType+";time:"+e.timestamp})))}else if("onReceiveBroadcastNotifications"===t){var l=o[0];this.logger.log(""+a,map$6(l).call(l,(function(e){return"id:"+e.id+";sender:"+e.senderId+";time:"+e.time})))}else{var d,u;(d=this.logger).log.apply(d,concat(u=[""+a]).call(u,o))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,o))},t.sendCustomNotification=function sendCustomNotification(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var n,a,i;return Dl.wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return this.checkV2(),validateConversationId(this.core.account,e),validate(Sh,{content:t,params:r},"",!0),n=this.core.V2NIMConversationIdUtil.parseConversationType(e),a=3===n?"v2SendCustomNotificationWithSuperTeam":"v2SendCustomNotification",i=this.notificationUtil.generateNotificationTag(e,t,r),o.next=8,this.core.sendCmd(a,{tag:i});case 8:case"end":return o.stop()}}),_callee,this)})))},t.processSystemNotification=function processSystemNotification(e){var t=[0,1,2,3,4,15,16,17,18],r=[5,6],n=e.type;if(includes(t).call(t,n))this.core.eventBus.emit("V2NIMTeamService/sysNotification",e);else{if(!includes(r).call(r,n)){var a=Et(Et({},e),{conversationType:{100:1,101:2,102:1,103:3}[n]});return delete a.type,a}this.core.eventBus.emit("V2NIMFriendService/sysNotification",e)}},t.markBroadcastMsgAck=function markBroadcastMsgAck(e){this.config.compatibleWithV1||this.core.sendCmd("v2BatchMarkRead",{sid:7,cid:17,ids:map$6(e).call(e,(function(e){return e.id}))})},t.syncBroadcastMsgHandler=function syncBroadcastMsgHandler(e){var t=e.content.datas;this.markBroadcastMsgAck(t),this.emit("onReceiveBroadcastNotifications",t)},t.onBroadcastMsgHandler=function onBroadcastMsgHandler(e){var t=e.content.data;this.markBroadcastMsgAck([t]),this.emit("onReceiveBroadcastNotifications",[t])},t.onSysNotificationHandler=function onSysNotificationHandler(e){this.markSysNotificationAck([e.content.data]);var t=this.processSystemNotification(e.content.data);t&&this.emit("onReceiveCustomNotifications",[t])},t.v2SyncOfflineSysNotificationsHandler=function v2SyncOfflineSysNotificationsHandler(e){var t,r,n,a=this;this.markSysNotificationAck(e.content.datas);var i=filter(t=map$6(r=sort(n=e.content.datas).call(n,(function(e,t){return e.timestamp-t.timestamp}))).call(r,(function(e){return a.processSystemNotification(e)}))).call(t,(function(e){return e}));i&&this.emit("onReceiveCustomNotifications",i)},t.v2NotificationRevokeHandler=function v2NotificationRevokeHandler(e){this.markSysNotificationAck([e.content.data])},t.v2NotificationSyncRevokeHandler=function v2NotificationSyncRevokeHandler(e){var t=e.content.type;1===bd(t)&&this.markSysNotificationAck(e.content.datas)},t.markSysNotificationAck=function markSysNotificationAck(e){if(!this.config.compatibleWithV1){var t=[],r=[],n=[15,16,17,18,103];forEach$1(e).call(e,(function(e){e.idServer&&(includes(n).call(n,e.type)?r.push(e.idServer):t.push(e.idServer))})),t.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:"7",cid:"3",ids:t}),r.length>0&&this.core.sendCmd("v2BatchMarkRead",{sid:"21",cid:"19",ids:r})}},V2NIMNotificationServiceImpl}(Ru),$M={"27_1":"v2NIMSync","27_10":"v2QChatSync"},zM={v2NIMSync:{sid:27,cid:1,service:"V2NIMSyncService",hasPacketTimer:!1,params:[{type:"Property",name:"tag",reflectMapper:{myInfo:1,offlineMsgs:2,teams:3,roamingMsgs:7,relations:9,friends:11,friendUsers:13,msgReceipts:14,myTeamMembers:15,donnop:16,recallMsg:17,sessionAck:18,broadcastMsgs:20,avSignal:21,superTeams:22,mySuperTeamMembers:23,superTeamRoamingMsgs:24,deleteSuperTeamMsg:25,superTeamSessionAck:26,deleteSelfMsgs:27,stickTopSessions:28,sessionHistoryMsgsDelete:29,p2pTeamModifyMessage:30,superTeamModifyMessage:31,filterMsgs:100}}],response:[{type:"Long",name:"timetag"}]},v2QChatSync:{sid:27,cid:10,service:"V2NIMSyncService",hasPacketTimer:!1,params:[{type:"Property",name:"tag",reflectMapper:{systemNotification:1,pushConfig:2}}],response:[{type:"Long",name:"timetag"}]}},WM=function(e){function V2NIMSyncServiceImpl(t){var r;return(r=e.call(this,"V2NIMSyncService",t)||this).teamKey=["teams","superTeams","myTeamMembers","mySuperTeamMembers"],r.config={},r.timetags={},"v2"!==r.core.options.apiVersion?De(r):(r.initEventListeners(),registerParser({cmdMap:$M,cmdConfig:zM}),r)}_t(V2NIMSyncServiceImpl,e);var t=V2NIMSyncServiceImpl.prototype;return t.reset=function reset(){this.timetags={}},t.setOptions=function setOptions(e){var t=this.core;return this.config=Et({myInfo:!!t.user.name,offlineMsgs:!!t.V2NIMMessageService.name,roamingMsgs:!!t.V2NIMMessageService.name,relations:!!t.user.name,friends:!!t.friend.name,friendUsers:!!t.user.name,msgReceipts:!!t.V2NIMMessageService.name,broadcastMsgs:!!t.V2NIMNotificationService.name,recallMsg:!!t.V2NIMMessageService.name,sessionAck:!!t.V2NIMConversationService.name,superTeamSessionAck:!!t.V2NIMConversationService.name,superTeamRoamingMsgs:!!t.V2NIMTeamService.name,deleteSuperTeamMsg:!!t.V2NIMTeamService.name,deleteSelfMsgs:!!t.V2NIMMessageService.name,sessionHistoryMsgsDelete:!!t.V2NIMMessageService.name,avSignal:!!t.signaling.name,teams:!!t.V2NIMTeamService.name,superTeams:!!t.V2NIMTeamService.name,myTeamMembers:!!t.V2NIMTeamService.name,mySuperTeamMembers:!!t.V2NIMTeamService.name,p2pTeamModifyMessage:!!t.V2NIMMessageService.name,superTeamModifyMessage:!!t.V2NIMMessageService.name},e),this.config},t.doBasicSync=function doBasicSync(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e,t,r,n,a,i=this;return Dl.wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:return e=Nt(this.config),t=filter(e).call(e,(function(e){var t;return!includes(t=i.teamKey).call(t,e)&&i.config[e]})),r=this.genSyncParams(t),this.logger.log("V2Sync:basic",r),o.next=6,this.core.clientSocket.sendCmd("v2NIMSync",{tag:r});case 6:return n=o.sent,a=n.content.timetag,this.setTimetags(a,t),o.next=11,this.delaySyncDone();case 11:return o.next=13,this.handleImmediate();case 13:this.core.logger.log("sync::basic sync complete in",a);case 14:case"end":return o.stop()}}),_callee,this)})))},t.doTeamSync=function doTeamSync(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var e,t,r,n,a,i=this;return Dl.wrap((function _callee2$(o){for(;;)switch(o.prev=o.next){case 0:if(0!==(t=filter(e=this.teamKey).call(e,(function(e){return i.config[e]}))).length){o.next=3;break}return o.abrupt("return");case 3:return r=this.genSyncParams(t),this.core.eventBus.emit("V2NIMTeamService/onSyncStarted"),this.logger.log("V2Sync:team",r),n=null,o.prev=7,o.next=10,this.core.clientSocket.sendCmd("v2NIMSync",{tag:r});case 10:n=o.sent,o.next=17;break;case 13:throw o.prev=13,o.t0=o.catch(7),this.core.eventBus.emit("V2NIMTeamService/onSyncFailed",o.t0),o.t0;case 17:this.core.eventBus.emit("V2NIMTeamService/onSyncFinished"),a=n.content.timetag,this.setTimetags(a,this.teamKey),this.core.logger.log("sync::team sync complete in",a);case 21:case"end":return o.stop()}}),_callee2,this,[[7,13]])})))},t.doQchatSync=function doQchatSync(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var e;return Dl.wrap((function _callee3$(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.core.clientSocket.sendCmd("v2QChatSync",{tag:{systemNotification:0}});case 2:e=t.sent,this.core.logger.log("sync::qchat sync complete in",e.content.timetag);case 4:case"end":return t.stop()}}),_callee3,this)})))},t.doSync=function doSync(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var e;return Dl.wrap((function _callee4$(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!==(e=get(this.core,"V2NIMLoginService.authenticator.loginClientOfThisConnection.loginType"))){t.next=4;break}return this.logger.warn("sync::doSync: no loginType, stop sync"),t.abrupt("return");case 4:if(this.logger.log("sync::doSync:type "+e),this.core.V2NIMLoginService.dataSync.switchDataSync({type:1,state:2}),1!==e){t.next=20;break}return t.prev=7,t.next=10,this.doBasicSync();case 10:return t.next=12,this.doTeamSync();case 12:t.next=18;break;case 14:return t.prev=14,t.t0=t.catch(7),this.doSyncComplete(t.t0),t.abrupt("return");case 18:t.next=49;break;case 20:if(2!==e){t.next=32;break}return t.prev=21,t.next=24,this.doQchatSync();case 24:t.next=30;break;case 26:return t.prev=26,t.t1=t.catch(21),this.doSyncComplete(t.t1),t.abrupt("return");case 30:t.next=49;break;case 32:if(3!==e){t.next=48;break}return t.prev=33,t.next=36,this.doBasicSync();case 36:return t.next=38,this.doTeamSync();case 38:return t.next=40,this.doQchatSync();case 40:t.next=46;break;case 42:return t.prev=42,t.t2=t.catch(33),this.doSyncComplete(t.t2),t.abrupt("return");case 46:t.next=49;break;case 48:return t.abrupt("return");case 49:this.doSyncComplete();case 50:case"end":return t.stop()}}),_callee4,this,[[7,14],[21,26],[33,42]])})))},t.doSyncComplete=function doSyncComplete(e){e&&this.core.logger.log("sync::doSync complete but got error",e),this.core.V2NIMLoginService.dataSync.switchDataSync({type:1,state:3,error:e,subType:"mainSync"})},t.initEventListeners=function initEventListeners(){var e=this;this.core.eventBus.on("V2NIMLoginService/loginLifeCycleLoginSucc",(function(){e.doSync()}))},t.genSyncParams=function genSyncParams(e){var t=this;return reduce(e).call(e,(function(e,r){var n=r;return e[n]=t.timetags[n]||0,e}),{})},t.setTimetags=function setTimetags(e,t){var r=this;forEach$1(t).call(t,(function(t){r.timetags[t]=e}))},t.handleImmediate=function handleImmediate(){return this.core.session&&this.core.session.onSyncDone&&this.core.session.onSyncDone(),Pi.resolve()},t.delaySyncDone=function delaySyncDone(){return"ALI"===getMiniappEnv()?(this.core.logger.log("sync: emit ALIAPP sycnHandler, handle later"),new Pi((function(e){eo((function(){e()}),100)}))):Pi.resolve()},V2NIMSyncServiceImpl}(Ru);var KM="V2NIMAIService",YM={"4_26":"v2AIChatNotify","29_35":"v2AIProxyModelCall","29_36":"v2AIGetUserList"},QM={accountId:1,messages:{id:2,converter:objectToJSONString,retConverter:stringToJSONObject},requestId:3,content:{id:4,converter:objectToJSONString,retConverter:stringToJSONObject},promptVariables:5,modelConfigParams:{id:6,converter:objectToJSONString,retConverter:stringToJSONObject},antispamBusinessId:7,antispamEnabled:{id:8,converter:boolToInt}},JM={accountId:1,name:3,avatar:4,sign:5,gender:{id:6,retType:"number"},email:7,birthday:8,mobile:9,serverExtension:10,modelType:{id:11,retType:"number"},modelConfig:{id:12,retConverter:function retConverter(e){if(e=stringToJSONObject(e)){var t=Nt(e),r=reduce(t).call(t,(function(t,r){var n=function camelCase(e){var t;return map$6(t=(e=e||"").split("_")).call(t,(function(e,t){return 0===t?e:e[0].toUpperCase()+slice(e).call(e,1)})).join("")}(r);return t[n]=e[r],t}),{});if("string"==typeof r.promptKeys)try{r.promptKeys=JSON.parse(r.promptKeys)}catch(e){}return r}}},yunxinConfig:{id:13,retConverter:function retConverter(e){if(e=stringToJSONObject(e))return e}},valid:{id:14,retType:"boolean"},createTime:{id:15,retType:"number"},updateTime:{id:16,retType:"number"}},XM={v2AIChatNotify:{sid:4,cid:26,service:KM,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem({code:{id:1,retType:"number"},accountId:2,requestId:3,content:{id:4,retConverter:stringToJSONObject}})}]},v2AIProxyModelCall:{sid:29,cid:35,service:KM,params:[{type:"Property",name:"tag",reflectMapper:QM}]},v2AIGetUserList:{sid:29,cid:36,service:KM,params:[{type:"Property",name:"tag",reflectMapper:{pageToken:1,limit:2}}],response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(JM)},{type:"Property",name:"queryTag",reflectMapper:invertSerializeItem({hasMore:{id:16,retType:"boolean"},nextToken:2})}]}},ZM=function(e){function V2NIMAIServiceImpl(t){var r;return r=e.call(this,"V2NIMAIService",t)||this,registerParser({cmdMap:YM,cmdConfig:XM}),r}_t(V2NIMAIServiceImpl,e);var t=V2NIMAIServiceImpl.prototype;return t.emit=function emit(t){for(var r,n,a=this.name+"::emit "+t.toString(),i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if("onProxyAIModelCall"===t){var c=o[0];this.logger.log(""+a,"code:"+c.code+";accountId:"+c.accountId+";requestId:"+c.requestId)}else{var l,d;(l=this.logger).log.apply(l,concat(d=[""+a]).call(d,o))}return(r=e.prototype.emit).call.apply(r,concat(n=[this,t]).call(n,o))},t.getAIUserList=function getAIUserList(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var e;return Dl.wrap((function _callee$(t){for(;;)switch(t.prev=t.next){case 0:return this.checkV2(),t.next=3,this.core.sendCmd("v2AIGetUserList",{tag:{}});case 3:return e=t.sent,t.abrupt("return",e.content.datas);case 5:case"end":return t.stop()}}),_callee,this)})))},t.proxyAIModelCall=function proxyAIModelCall(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){return Dl.wrap((function _callee2$(t){for(;;)switch(t.prev=t.next){case 0:return validate(wm,e,"",!0),t.next=3,this.core.sendCmd("v2AIProxyModelCall",{tag:e});case 3:case"end":return t.stop()}}),_callee2,this)})))},t.v2AIChatNotifyHandler=function v2AIChatNotifyHandler(e){var t=e.content.data;t&&t.requestId?this.emit("onProxyAIModelCall",{code:t.code||200,accountId:t.accountId,requestId:t.requestId,content:t.content}):this.logger.warn("v2AIChatNotifyHandler: invalid data",t)},V2NIMAIServiceImpl}(Ru),eI={"18_1":"v2SignallingCreateRoom","18_2":"v2SignallingDelayRoom","18_3":"v2SignallingCloseRoom","18_4":"v2SignallingJoinRoom","18_5":"v2SignallingLeaveRoom","18_6":"v2SignallingInvite","18_7":"v2SignallingCancelInvite","18_16":"v2SignallingCall","18_17":"v2SignallingCallSetup","18_8":"v2SignallingRejectInvite","18_9":"v2SignallingAcceptInvite","18_10":"v2SignallingSendControl","15_11":"v2SignallingOnlineEvent","15_12":"v2SignallingMultiClientEvent","15_13":"v2SignallingOfflineEvent","15_14":"v2SignallingSyncChannels","18_15":"v2SignallingGetRoomInfo"},tI="V2NIMSignallingService",rI={accountId:1,uid:{id:2,retType:"number"},joinTime:{id:3,retType:"number"},expireTime:{id:4,retType:"number"},deviceId:5},nI={channelType:{id:1,retType:"number",retAccess:"channelInfo.channelType"},channelName:{id:2,retAccess:"channelInfo.channelName"},channelId:{id:3,retAccess:"channelInfo.channelId"},createTime:{id:4,retType:"number",retAccess:"channelInfo.createTime"},expireTime:{id:5,retType:"number",retAccess:"channelInfo.expireTime"},creatorAccountId:{id:6,retAccess:"channelInfo.creatorAccountId"},channelExtension:{id:7,retAccess:"channelInfo.channelExtension"},invalid:8,fromAccid:10,toAccid:11,requestId:12,pushEnabled:{id:13,access:"pushConfig.pushEnabled",converter:boolToInt,retType:"boolean"},pushTitle:{id:14,access:"pushConfig.pushTitle"},pushContent:{id:15,access:"pushConfig.pushContent"},pushPayload:{id:16,access:"pushConfig.pushPayload"},unreadEnabled:{id:17,access:"signallingConfig.unreadEnabled",converter:boolToInt,retType:"boolean",def:1},members:{id:18,retAccess:"members",retConverter:function retConverter(e){try{var t=JSON.parse(e);return map$6(t).call(t,(function(e){return deserialize(e,invertSerializeItem(rI))}))}catch(e){return}}},attach:{id:19,retConverter:stringToJSONObject},serverExtension:{id:20,retDef:""},offlineEnabled:{id:21,converter:boolToInt,retType:"boolean",def:1},msgId:22,selfUid:{id:23,retType:"number",access:"signallingConfig.selfUid"},time:{id:24,retType:"number"},rtcChannelName:{id:25,access:"rtcConfig.rtcChannelName"},rtcTokenTtl:{id:26,retType:"number",access:"rtcConfig.rtcTokenTtl",retAccess:"rtcInfo.rtcTokenTtl"},rtcToken:{id:27,retAccess:"rtcInfo.rtcToken"},rtcParams:{id:28,access:"rtcConfig.rtcParams",retAccess:"rtcInfo.rtcParams"},callStatus:{id:30,retType:"number"}},aI={v2SignallingCall:{sid:18,cid:16,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingCallSetup:{sid:18,cid:17,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingCreateRoom:{sid:18,cid:1,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingDelayRoom:{sid:18,cid:2,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingCloseRoom:{sid:18,cid:3,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingJoinRoom:{sid:18,cid:4,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingLeaveRoom:{sid:18,cid:5,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingInvite:{sid:18,cid:6,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingCancelInvite:{sid:18,cid:7,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingRejectInvite:{sid:18,cid:8,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}]},v2SignallingAcceptInvite:{sid:18,cid:9,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}]},v2SignallingSendControl:{sid:18,cid:10,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}]},v2SignallingOnlineEvent:{sid:15,cid:11,service:tI,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingMultiClientEvent:{sid:15,cid:12,service:tI,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingOfflineEvent:{sid:15,cid:13,service:tI,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(nI)}]},v2SignallingSyncChannels:{sid:15,cid:14,service:tI,response:[{type:"PropertyArray",name:"datas",reflectMapper:invertSerializeItem(nI)}]},v2SignallingGetRoomInfo:{sid:18,cid:15,service:tI,params:[{type:"Property",name:"tag",reflectMapper:nI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(nI)}]},v2SignallingBatchMarkRead:{sid:4,cid:5,hasPacketResponse:!1,service:tI,params:[{type:"Byte",name:"sid"},{type:"Byte",name:"cid"},{type:"LongArray",name:"ids"}]}},iI={calleeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},channelType:{type:"enum",values:[1,3,2]},channelName:{type:"string",required:!1,allowEmpty:!0},channelExtension:{type:"string",required:!1,allowEmpty:!0},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1,allowEmpty:!0},pushContent:{type:"string",required:!1,allowEmpty:!0},pushPayload:{type:"string",required:!1,allowEmpty:!0}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},oI={channelId:{type:"string",required:!0,allowEmpty:!1},callerAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},sI={channelType:{type:"enum",values:[1,3,2]},channelName:{type:"string",required:!1,allowEmpty:!0},channelExtension:{type:"string",required:!1,allowEmpty:!0}},cI={channelId:{type:"string",required:!0,allowEmpty:!1},offlineEnabled:{type:"boolean",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},lI={channelId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},rtcConfig:{type:"object",required:!1,rules:{rtcChannelName:{type:"string",required:!1,allowEmpty:!0},rtcTokenTtl:{type:"number",required:!1},rtcParams:{type:"string",required:!1,allowEmpty:!0}}}},dI={channelId:{type:"string",required:!0,allowEmpty:!1},offlineEnabled:{type:"boolean",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},uI={channelId:{type:"string",required:!0,allowEmpty:!1},inviteeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},signallingConfig:{type:"object",required:!1,rules:{offlineEnabled:{type:"boolean",required:!1},unreadEnabled:{type:"boolean",required:!1},selfUid:{type:"number",required:!1}}},pushConfig:{type:"object",required:!1,rules:{pushEnabled:{type:"boolean",required:!1},pushTitle:{type:"string",required:!1,allowEmpty:!0},pushContent:{type:"string",required:!1,allowEmpty:!0},pushPayload:{type:"string",required:!1,allowEmpty:!0}}}},pI={channelId:{type:"string",required:!0,allowEmpty:!1},inviteeAccountId:{type:"string",required:!0,allowEmpty:!1},requestId:{type:"string",required:!0,allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},offlineEnabled:{type:"boolean",required:!1}},mI={channelId:{type:"string",allowEmpty:!1},receiverAccountId:{type:"string",required:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0}},hI={channelId:{type:"string",allowEmpty:!1},inviterAccountId:{type:"string",allowEmpty:!1},requestId:{type:"string",allowEmpty:!1},serverExtension:{type:"string",required:!1,allowEmpty:!0},offlineEnabled:{type:"boolean",required:!1}},gI=hI;function formatSignalingEvent(e){var t,r=e.attach,n={eventType:r.type,channelInfo:e.channelInfo,operatorAccountId:e.fromAccid,time:e.time,serverExtension:e.serverExtension,requestId:e.requestId,pushConfig:e.pushConfig,unreadEnabled:null===(t=e.signallingConfig)||void 0===t?void 0:t.unreadEnabled},a=e.fromAccid,i=e.toAccid;switch(n.eventType){case 1:break;case 2:n.member={accountId:r.member[1],uid:Number(r.member[2]),joinTime:Number(r.member[3]),expireTime:Number(r.member[4]),deviceId:r.member[5]};break;case 3:case 4:n.operatorAccountId=a,n.inviteeAccountId=i,n.inviterAccountId=a;break;case 5:case 6:n.operatorAccountId=a,n.inviterAccountId=i,n.inviteeAccountId=a}return JSON.parse(bn(n))}var vI=function(e){function V2NIMSignallingServiceImpl(t,r){var n;return void 0===r&&(r={}),(n=e.call(this,"V2NIMSignallingService",t)||this).config={compatibleWithV1:!0},n.channels={},n.timer=0,n.pollingInterval=12e4,"v2"!==n.core.options.apiVersion?De(n):(registerParser({cmdMap:eI,cmdConfig:aI}),n.setOptions(r),n)}_t(V2NIMSignallingServiceImpl,e);var t=V2NIMSignallingServiceImpl.prototype;return t.reset=function reset(){this.timer=0,this.channels={}},t.setOptions=function setOptions(e){var t;(null===(t=this.core.signaling)||void 0===t?void 0:t.name)?this.config.compatibleWithV1=!0:this.config.compatibleWithV1=!1,this.config=Et(this.config,e)},t.emit=function emit(t){for(var r,n,a,i,o=this.name+"::emit "+t.toString(),s=arguments.length,c=new Array(s>1?s-1:0),l=1;l<s;l++)c[l-1]=arguments[l];return(r=this.logger).log.apply(r,concat(n=[""+o]).call(n,c)),(a=e.prototype.emit).call.apply(a,concat(i=[this,t]).call(i,c))},t.call=function call(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var r,n,a,i;return Dl.wrap((function _callee$(o){for(;;)switch(o.prev=o.next){case 0:if(this.checkV2(),validate(iI,e,"",!0),e.calleeAccountId!==this.core.account){o.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"You cannot call yourself"}});case 4:return r=void 0!==e.pushConfig&&(void 0!==e.pushConfig.pushEnabled&&e.pushConfig.pushEnabled),o.next=7,this.core.sendCmd("v2SignallingCall",{tag:Et(Et({},e),{toAccid:e.calleeAccountId,offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled,pushConfig:Et(Et({},e.pushConfig||{}),{pushEnabled:r})})});case 7:return n=o.sent,a=n.content.data,this.channels[a.channelInfo.channelId]=cloneDeep(a.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(bind$1(i=this.aotoDelay).call(i,this),this.pollingInterval,-1)),o.abrupt("return",{callStatus:a.callStatus,rtcInfo:a.rtcInfo,roomInfo:{channelInfo:a.channelInfo,members:a.members}});case 12:case"end":return o.stop()}}),_callee,this)})))},t.callSetup=function callSetup(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee2(){var r,n,a;return Dl.wrap((function _callee2$(i){for(;;)switch(i.prev=i.next){case 0:if(this.checkV2(),validate(oI,e,"",!0),e.callerAccountId!==this.core.account){i.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"callSetup: cannot be yourself"}});case 4:return i.next=6,this.core.sendCmd("v2SignallingCallSetup",{tag:Et(Et({},e),{toAccid:e.callerAccountId,offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled})});case 6:return r=i.sent,n=r.content.data,this.channels[n.channelInfo.channelId]=cloneDeep(n.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(bind$1(a=this.aotoDelay).call(a,this),this.pollingInterval,-1)),i.abrupt("return",{callStatus:n.callStatus,rtcInfo:n.rtcInfo,roomInfo:{channelInfo:n.channelInfo,members:n.members}});case 11:case"end":return i.stop()}}),_callee2,this)})))},t.createRoom=function createRoom(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee3(){var n;return Dl.wrap((function _callee3$(a){for(;;)switch(a.prev=a.next){case 0:return this.checkV2(),validate(sI,{channelType:e,channelName:t,channelExtension:r},"",!0),a.next=4,this.core.sendCmd("v2SignallingCreateRoom",{tag:{channelType:e,channelName:t,channelExtension:r}});case 4:return n=a.sent,a.abrupt("return",n.content.data.channelInfo);case 6:case"end":return a.stop()}}),_callee3,this)})))},t.delayRoom=function delayRoom(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee4(){var t;return Dl.wrap((function _callee4$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),r.next=3,this.core.sendCmd("v2SignallingDelayRoom",{tag:{channelId:e}});case 3:return t=r.sent,r.abrupt("return",{channelInfo:t.content.data.channelInfo,members:t.content.data.members});case 5:case"end":return r.stop()}}),_callee4,this)})))},t.closeRoom=function closeRoom(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee5(){return Dl.wrap((function _callee5$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(cI,{channelId:e,offlineEnabled:t,serverExtension:r},"",!0),n.next=4,this.core.sendCmd("v2SignallingCloseRoom",{tag:{channelId:e,offlineEnabled:void 0!==t&&t,serverExtension:r}});case 4:case"end":return n.stop()}}),_callee5,this)})))},t.joinRoom=function joinRoom(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee6(){var r,n,a;return Dl.wrap((function _callee6$(i){for(;;)switch(i.prev=i.next){case 0:return this.checkV2(),validate(lI,e,"",!0),i.next=4,this.core.sendCmd("v2SignallingJoinRoom",{tag:Et(Et({},e),{offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled})});case 4:return r=i.sent,n=r.content.data,this.channels[n.channelInfo.channelId]=cloneDeep(n.channelInfo),this.timer||(this.timer=this.core.timerManager.addTimer(bind$1(a=this.aotoDelay).call(a,this),this.pollingInterval,-1)),i.abrupt("return",{channelInfo:r.content.data.channelInfo,members:r.content.data.members});case 9:case"end":return i.stop()}}),_callee6,this)})))},t.leaveRoom=function leaveRoom(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee7(){return Dl.wrap((function _callee7$(n){for(;;)switch(n.prev=n.next){case 0:return this.checkV2(),validate(dI,{channelId:e,offlineEnabled:t,serverExtension:r},"",!0),n.next=4,this.core.sendCmd("v2SignallingLeaveRoom",{tag:{channelId:e,offlineEnabled:void 0!==t&&t,serverExtension:r}});case 4:delete this.channels[e];case 5:case"end":return n.stop()}}),_callee7,this)})))},t.invite=function invite(e){var t;return __awaiter(this,void 0,void 0,Dl.mark((function _callee8(){var r,n;return Dl.wrap((function _callee8$(a){for(;;)switch(a.prev=a.next){case 0:if(this.checkV2(),validate(uI,e,"",!0),e.inviteeAccountId!==this.core.account){a.next=4;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"invite: cannot be yourself"}});case 4:return r=void 0!==e.pushConfig&&(void 0!==e.pushConfig.pushEnabled&&e.pushConfig.pushEnabled),a.next=7,this.core.sendCmd("v2SignallingInvite",{tag:Et(Et({},e),{toAccid:e.inviteeAccountId,offlineEnabled:void 0===(null===(t=e.signallingConfig)||void 0===t?void 0:t.offlineEnabled)||e.signallingConfig.offlineEnabled,pushConfig:Et(Et({},e.pushConfig||{}),{pushEnabled:r})})});case 7:return n=a.sent,a.abrupt("return",n.content.data);case 9:case"end":return a.stop()}}),_callee8,this)})))},t.cancelInvite=function cancelInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee9(){var t;return Dl.wrap((function _callee9$(r){for(;;)switch(r.prev=r.next){case 0:return this.checkV2(),validate(pI,e,"",!0),r.next=4,this.core.sendCmd("v2SignallingCancelInvite",{tag:Et(Et({},e),{toAccid:e.inviteeAccountId})});case 4:return t=r.sent,r.abrupt("return",t.content.data);case 6:case"end":return r.stop()}}),_callee9,this)})))},t.rejectInvite=function rejectInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee10(){return Dl.wrap((function _callee10$(t){for(;;)switch(t.prev=t.next){case 0:if(validate(hI,e,"",!0),e.inviterAccountId!==this.core.account){t.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"rejectInvite: cannot be yourself"}});case 3:return t.next=5,this.core.sendCmd("v2SignallingRejectInvite",{tag:Et(Et({},e),{toAccid:e.inviterAccountId})});case 5:case"end":return t.stop()}}),_callee10,this)})))},t.acceptInvite=function acceptInvite(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee11(){return Dl.wrap((function _callee11$(t){for(;;)switch(t.prev=t.next){case 0:if(validate(gI,e,"",!0),e.inviterAccountId!==this.core.account){t.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"acceptInvite: cannot be yourself"}});case 3:return t.next=5,this.core.sendCmd("v2SignallingAcceptInvite",{tag:Et(Et({},e),{toAccid:e.inviterAccountId})});case 5:case"end":return t.stop()}}),_callee11,this)})))},t.sendControl=function sendControl(e,t,r){return __awaiter(this,void 0,void 0,Dl.mark((function _callee12(){return Dl.wrap((function _callee12$(n){for(;;)switch(n.prev=n.next){case 0:return validate(mI,{channelId:e,receiverAccountId:t,serverExtension:r},"",!0),n.next=3,this.core.sendCmd("v2SignallingSendControl",{tag:{channelId:e,toAccid:t,serverExtension:r}});case 3:case"end":return n.stop()}}),_callee12,this)})))},t.getRoomInfoByChannelName=function getRoomInfoByChannelName(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee13(){var t,r,n,a;return Dl.wrap((function _callee13$(i){for(;;)switch(i.prev=i.next){case 0:return validate({channelName:{type:"string",allowEmpty:!1}},{channelName:e},"",!0),i.next=3,this.core.sendCmd("v2SignallingGetRoomInfo",{tag:{channelName:e}});case 3:return t=i.sent,r=t.content.data,n=r.members,a=r.channelInfo,i.abrupt("return",{channelInfo:a,members:n||[]});case 6:case"end":return i.stop()}}),_callee13,this)})))},t.aotoDelay=function aotoDelay(){return __awaiter(this,void 0,void 0,Dl.mark((function _callee14(){var e,t,r,n;return Dl.wrap((function _callee14$(a){for(;;)switch(a.prev=a.next){case 0:if(0!==(e=Nt(this.channels)).length){a.next=5;break}return this.timer&&this.core.timerManager.deleteTimer(this.timer),this.timer=0,a.abrupt("return");case 5:this.logger.log("v2Signlling:autoDelay",e),t=0;case 7:if(!(t<e.length)){a.next=23;break}return r=e[t],a.prev=9,a.next=12,this.core.sendCmd("v2SignallingDelayRoom",{tag:{channelId:r}});case 12:n=a.sent,this.channels[r]=n.content.data.channelInfo,a.next=20;break;case 16:a.prev=16,a.t0=a.catch(9),this.logger.warn("signling:autoDelay "+r+" failed",a.t0),delete this.channels[r];case 20:t++,a.next=7;break;case 23:case"end":return a.stop()}}),_callee14,this,[[9,16]])})))},t.v2SignallingOnlineEventHandler=function v2SignallingOnlineEventHandler(e){var t=e.content.data,r="number"==typeof get(e,"raw.r[0]")?""+e.raw.r[0]:"0";!this.config.compatibleWithV1&&r&&bd(r)&&this.core.sendCmd("v2SignallingBatchMarkRead",{sid:15,cid:11,ids:[r]}),this.emit("onOnlineEvent",formatSignalingEvent(t))},t.v2SignallingMultiClientEventHandler=function v2SignallingMultiClientEventHandler(e){this.emit("onMultiClientEvent",formatSignalingEvent(e.content.data))},t.v2SignallingOfflineEventHandler=function v2SignallingOfflineEventHandler(e){var t;if(e.content.datas&&e.content.datas.length>0){if(!this.config.compatibleWithV1){var r,n=map$6(r=e.content.datas).call(r,(function(e){return e.msgId}));n.length>0&&this.core.sendCmd("v2SignallingBatchMarkRead",{sid:15,cid:11,ids:n})}var a=map$6(t=e.content.datas).call(t,(function(e){return formatSignalingEvent(e)}));this.emit("onOfflineEvent",a)}},t.v2SignallingSyncChannelsHandler=function v2SignallingSyncChannelsHandler(e){var t=this;if(this.timer=0,this.channels={},e.content.datas&&e.content.datas.length>0){var r,n=e.content.datas;if(forEach$1(n).call(n,(function(e){var r=e.channelInfo.channelId;t.channels[r]=cloneDeep(e.channelInfo)})),!this.timer)this.timer=this.core.timerManager.addTimer(bind$1(r=this.aotoDelay).call(r,this),this.pollingInterval,-1);this.emit("onSyncRoomInfoList",n)}},V2NIMSignallingServiceImpl}(Ru),fI=createCommonjsModule((function(e,t){e.exports=function(e){var add32=function(e,t){return e+t&4294967295},t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function cmn(e,t,r,n,a,i){return t=add32(add32(t,e),add32(n,i)),add32(t<<a|t>>>32-a,r)}function ff(e,t,r,n,a,i,o){return cmn(t&r|~t&n,e,t,a,i,o)}function gg(e,t,r,n,a,i,o){return cmn(t&n|r&~n,e,t,a,i,o)}function hh(e,t,r,n,a,i,o){return cmn(t^r^n,e,t,a,i,o)}function ii(e,t,r,n,a,i,o){return cmn(r^(t|~n),e,t,a,i,o)}function md5cycle(e,t){var r=e[0],n=e[1],a=e[2],i=e[3];r=ff(r,n,a,i,t[0],7,-680876936),i=ff(i,r,n,a,t[1],12,-389564586),a=ff(a,i,r,n,t[2],17,606105819),n=ff(n,a,i,r,t[3],22,-1044525330),r=ff(r,n,a,i,t[4],7,-176418897),i=ff(i,r,n,a,t[5],12,1200080426),a=ff(a,i,r,n,t[6],17,-1473231341),n=ff(n,a,i,r,t[7],22,-45705983),r=ff(r,n,a,i,t[8],7,1770035416),i=ff(i,r,n,a,t[9],12,-1958414417),a=ff(a,i,r,n,t[10],17,-42063),n=ff(n,a,i,r,t[11],22,-1990404162),r=ff(r,n,a,i,t[12],7,1804603682),i=ff(i,r,n,a,t[13],12,-40341101),a=ff(a,i,r,n,t[14],17,-1502002290),r=gg(r,n=ff(n,a,i,r,t[15],22,1236535329),a,i,t[1],5,-165796510),i=gg(i,r,n,a,t[6],9,-1069501632),a=gg(a,i,r,n,t[11],14,643717713),n=gg(n,a,i,r,t[0],20,-373897302),r=gg(r,n,a,i,t[5],5,-701558691),i=gg(i,r,n,a,t[10],9,38016083),a=gg(a,i,r,n,t[15],14,-660478335),n=gg(n,a,i,r,t[4],20,-405537848),r=gg(r,n,a,i,t[9],5,568446438),i=gg(i,r,n,a,t[14],9,-1019803690),a=gg(a,i,r,n,t[3],14,-187363961),n=gg(n,a,i,r,t[8],20,1163531501),r=gg(r,n,a,i,t[13],5,-1444681467),i=gg(i,r,n,a,t[2],9,-51403784),a=gg(a,i,r,n,t[7],14,1735328473),r=hh(r,n=gg(n,a,i,r,t[12],20,-1926607734),a,i,t[5],4,-378558),i=hh(i,r,n,a,t[8],11,-2022574463),a=hh(a,i,r,n,t[11],16,1839030562),n=hh(n,a,i,r,t[14],23,-35309556),r=hh(r,n,a,i,t[1],4,-1530992060),i=hh(i,r,n,a,t[4],11,1272893353),a=hh(a,i,r,n,t[7],16,-155497632),n=hh(n,a,i,r,t[10],23,-1094730640),r=hh(r,n,a,i,t[13],4,681279174),i=hh(i,r,n,a,t[0],11,-358537222),a=hh(a,i,r,n,t[3],16,-722521979),n=hh(n,a,i,r,t[6],23,76029189),r=hh(r,n,a,i,t[9],4,-640364487),i=hh(i,r,n,a,t[12],11,-421815835),a=hh(a,i,r,n,t[15],16,530742520),r=ii(r,n=hh(n,a,i,r,t[2],23,-995338651),a,i,t[0],6,-198630844),i=ii(i,r,n,a,t[7],10,1126891415),a=ii(a,i,r,n,t[14],15,-1416354905),n=ii(n,a,i,r,t[5],21,-57434055),r=ii(r,n,a,i,t[12],6,1700485571),i=ii(i,r,n,a,t[3],10,-1894986606),a=ii(a,i,r,n,t[10],15,-1051523),n=ii(n,a,i,r,t[1],21,-2054922799),r=ii(r,n,a,i,t[8],6,1873313359),i=ii(i,r,n,a,t[15],10,-30611744),a=ii(a,i,r,n,t[6],15,-1560198380),n=ii(n,a,i,r,t[13],21,1309151649),r=ii(r,n,a,i,t[4],6,-145523070),i=ii(i,r,n,a,t[11],10,-1120210379),a=ii(a,i,r,n,t[2],15,718787259),n=ii(n,a,i,r,t[9],21,-343485551),e[0]=add32(r,e[0]),e[1]=add32(n,e[1]),e[2]=add32(a,e[2]),e[3]=add32(i,e[3])}function md5blk(e){var t,r=[];for(t=0;t<64;t+=4)r[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return r}function md5blk_array(e){var t,r=[];for(t=0;t<64;t+=4)r[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return r}function md51(e){var t,r,n,a,i,o,s=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=s;t+=64)md5cycle(c,md5blk(e.substring(t-64,t)));for(r=(e=e.substring(t-64)).length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<r;t+=1)n[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),t>55)for(md5cycle(c,n),t=0;t<16;t+=1)n[t]=0;return a=(a=8*s).toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(a[2],16),o=parseInt(a[1],16)||0,n[14]=i,n[15]=o,md5cycle(c,n),c}function md51_array(e){var t,r,n,a,i,o,s=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=s;t+=64)md5cycle(c,md5blk_array(e.subarray(t-64,t)));for(r=(e=t-64<s?e.subarray(t-64):new Uint8Array(0)).length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<r;t+=1)n[t>>2]|=e[t]<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),t>55)for(md5cycle(c,n),t=0;t<16;t+=1)n[t]=0;return a=(a=8*s).toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(a[2],16),o=parseInt(a[1],16)||0,n[14]=i,n[15]=o,md5cycle(c,n),c}function rhex(e){var r,n="";for(r=0;r<4;r+=1)n+=t[e>>8*r+4&15]+t[e>>8*r&15];return n}function hex(e){var t;for(t=0;t<e.length;t+=1)e[t]=rhex(e[t]);return e.join("")}function toUtf8(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function utf8Str2ArrayBuffer(e,t){var r,n=e.length,a=new ArrayBuffer(n),i=new Uint8Array(a);for(r=0;r<n;r+=1)i[r]=e.charCodeAt(r);return t?i:a}function arrayBuffer2Utf8Str(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function concatenateArrayBuffers(e,t,r){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e)),n.set(new Uint8Array(t),e.byteLength),r?n:n.buffer}function hexToBinaryString(e){var t,r=[],n=e.length;for(t=0;t<n-1;t+=2)r.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,r)}function SparkMD5(){this.reset()}return"5d41402abc4b2a76b9719d911017c592"!==hex(md51("hello"))&&(add32=function(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function clamp(e,t){return(e=0|e||0)<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(t,r){var n,a,i,o,s=this.byteLength,c=clamp(t,s),l=s;return r!==e&&(l=clamp(r,s)),c>l?new ArrayBuffer(0):(n=l-c,a=new ArrayBuffer(n),i=new Uint8Array(a),o=new Uint8Array(this,c,n),i.set(o),a)}}(),SparkMD5.prototype.append=function(e){return this.appendBinary(toUtf8(e)),this},SparkMD5.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,r=this._buff.length;for(t=64;t<=r;t+=64)md5cycle(this._hash,md5blk(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},SparkMD5.prototype.end=function(e){var t,r,n=this._buff,a=n.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<a;t+=1)i[t>>2]|=n.charCodeAt(t)<<(t%4<<3);return this._finish(i,a),r=hex(this._hash),e&&(r=hexToBinaryString(r)),this.reset(),r},SparkMD5.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},SparkMD5.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},SparkMD5.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},SparkMD5.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},SparkMD5.prototype._finish=function(e,t){var r,n,a,i=t;if(e[i>>2]|=128<<(i%4<<3),i>55)for(md5cycle(this._hash,e),i=0;i<16;i+=1)e[i]=0;r=(r=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(r[2],16),a=parseInt(r[1],16)||0,e[14]=n,e[15]=a,md5cycle(this._hash,e)},SparkMD5.hash=function(e,t){return SparkMD5.hashBinary(toUtf8(e),t)},SparkMD5.hashBinary=function(e,t){var r=hex(md51(e));return t?hexToBinaryString(r):r},SparkMD5.ArrayBuffer=function(){this.reset()},SparkMD5.ArrayBuffer.prototype.append=function(e){var t,r=concatenateArrayBuffers(this._buff.buffer,e,!0),n=r.length;for(this._length+=e.byteLength,t=64;t<=n;t+=64)md5cycle(this._hash,md5blk_array(r.subarray(t-64,t)));return this._buff=t-64<n?new Uint8Array(r.buffer.slice(t-64)):new Uint8Array(0),this},SparkMD5.ArrayBuffer.prototype.end=function(e){var t,r,n=this._buff,a=n.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<a;t+=1)i[t>>2]|=n[t]<<(t%4<<3);return this._finish(i,a),r=hex(this._hash),e&&(r=hexToBinaryString(r)),this.reset(),r},SparkMD5.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},SparkMD5.ArrayBuffer.prototype.getState=function(){var e=SparkMD5.prototype.getState.call(this);return e.buff=arrayBuffer2Utf8Str(e.buff),e},SparkMD5.ArrayBuffer.prototype.setState=function(e){return e.buff=utf8Str2ArrayBuffer(e.buff,!0),SparkMD5.prototype.setState.call(this,e)},SparkMD5.ArrayBuffer.prototype.destroy=SparkMD5.prototype.destroy,SparkMD5.ArrayBuffer.prototype._finish=SparkMD5.prototype._finish,SparkMD5.ArrayBuffer.hash=function(e,t){var r=hex(md51_array(new Uint8Array(e)));return t?hexToBinaryString(r):r},SparkMD5}()}));var yI=function _interopDefault$1(e){return e&&"object"==typeof e&&"default"in e?e.default:e}(fI);var _I,MI=class BMF{md5(e,t,r){this.aborted=!1,this.progress=0;let n=0;const a=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,i=2097152,o=Math.ceil(e.size/i),s=new yI.ArrayBuffer,c=new FileReader;function loadNext(){const t=n*i,r=t+i>=e.size?e.size:t+i;c.readAsArrayBuffer(a.call(e,t,r))}loadNext(),c.onloadend=e=>{s.append(e.target.result),n++,this.progress=n/o,r&&"function"==typeof r&&r(this.progress),this.aborted?t("aborted"):n<o?loadNext():t(null,s.end())}}abort(){this.aborted=!0}},II=function(){function DataStructureConverterImpl(e){this.name="DataStructureConverter",this.core=e}var e=DataStructureConverterImpl.prototype;return e.messageConvertToV1=function messageConvertToV1(e){var t,r=deserialize(serialize(e,tm),invert(xf)),n=getSessionId(r,this.core.account),a=null===(t=this.core.session)||void 0===t?void 0:t.getSessionWithUncomplete({id:n});return formatMsg$1(r,a?{account:this.core.account,sessionAck:a.ack,msgReceiptTime:a.msgReceiptTime}:{account:this.core.account})},e.messageConvertToV2=function messageConvertToV2(e){var t=deserialize(serialize(generatorMsgForCmd$1(e,e.from,e.fromDeviceId),xf),rm);return(t=completeMessage(this.core,t)).sendingState="sending"===e.status?3:"sendFailed"===e.status?2:1,t},DataStructureConverterImpl}(),SI=function(){function V2NIMMessageConverterImpl(e){this.name="V2NIMMessageConverter",this.core=e}var e=V2NIMMessageConverterImpl.prototype;return e.messageSerialization=function messageSerialization(e){if(!e)return null;var t=serialize(e,tm);return bn(t)},e.messageDeserialization=function messageDeserialization(e){var t,r,n,a,i,o,s,c,l,d,u,p,m,h,g,v,f,y,M,I,S,T,C;if(!e)return null;try{var b,E,R,k,w=deserialize(JSON.parse(e),rm);return w.sendingState=0,1!==w.conversationType||w.senderId!==this.core.account&&w.receiverId!==this.core.account?2===w.conversationType?w.conversationId=this.core.V2NIMConversationIdUtil.teamConversationId(w.receiverId):3===w.conversationType&&(w.conversationId=this.core.V2NIMConversationIdUtil.superTeamConversationId(w.receiverId)):w.conversationId=this.core.V2NIMConversationIdUtil.p2pConversationId(w.senderId===this.core.account?w.receiverId:w.senderId),w.threadReply&&(w.threadReply.conversationType=w.conversationType,w.threadReply=completeMessageRefer(this.core,w.threadReply)),w.threadRoot&&(w.threadRoot.conversationType=w.conversationType,w.threadRoot=completeMessageRefer(this.core,w.threadRoot)),includes(b=[1,3,2,0]).call(b,w.conversationType)||this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): "+w.conversationType),w.senderId&&"string"!=typeof w.senderId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): "+w.senderId),w.receiverId&&"string"!=typeof w.receiverId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): "+w.receiverId),"createTime"in w&&isNaN(w.createTime)&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): "+w.createTime),includes(E=[2,7,12,100,6,1,-1,4,5,11,0,10,3]).call(E,w.messageType)||this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid messageType(enum): "+w.messageType),"subType"in w&&isNaN(w.subType)&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid subType(number): "+w.subType),w.messageClientId&&"string"!=typeof w.messageClientId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): "+w.messageClientId),w.messageServerId&&"string"!=typeof w.messageServerId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): "+w.messageServerId),w.attachment&&"object"!=typeof w.attachment&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid attachment(object): "+w.attachment),w.text&&"string"!=typeof w.text&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid text(string): "+w.text),w.serverExtension&&"string"!=typeof w.serverExtension&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid serverExtension(string): "+w.serverExtension),w.callbackExtension&&"string"!=typeof w.callbackExtension&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid callbackExtension(string): "+w.callbackExtension),(null===(t=w.pushConfig)||void 0===t?void 0:t.pushContent)&&"string"!=typeof w.pushConfig.pushContent&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid pushContent(string): "+w.pushConfig.pushContent),(null===(r=w.pushConfig)||void 0===r?void 0:r.pushPayload)&&"string"!=typeof w.pushConfig.pushPayload&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid pushPayload(string): "+w.pushConfig.pushPayload),(null===(n=w.pushConfig)||void 0===n?void 0:n.forcePushContent)&&"string"!=typeof w.pushConfig.forcePushContent&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid forcePushContent(string): "+w.pushConfig.forcePushContent),(null===(a=w.pushConfig)||void 0===a?void 0:a.forcePushAccountIds)&&!En(w.pushConfig.forcePushAccountIds)&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid forcePushAccountIds(array): "+w.pushConfig.forcePushAccountIds),(null===(i=w.routeConfig)||void 0===i?void 0:i.routeEnvironment)&&"string"!=typeof w.routeConfig.routeEnvironment&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid routeEnvironment(string): "+w.routeConfig.routeEnvironment),(null===(o=w.antispamConfig)||void 0===o?void 0:o.antispamBusinessId)&&"string"!=typeof w.antispamConfig.antispamBusinessId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid antispamBusinessId(string): "+w.antispamConfig.antispamBusinessId),(null===(s=w.antispamConfig)||void 0===s?void 0:s.antispamCustomMessage)&&"string"!=typeof w.antispamConfig.antispamCustomMessage&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid antispamCustomMessage(string): "+w.antispamConfig.antispamCustomMessage),(null===(c=w.antispamConfig)||void 0===c?void 0:c.antispamCheating)&&"string"!=typeof w.antispamConfig.antispamCheating&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid antispamCheating(string): "+w.antispamConfig.antispamCheating),(null===(l=w.antispamConfig)||void 0===l?void 0:l.antispamExtension)&&"string"!=typeof w.antispamConfig.antispamExtension&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid antispamExtension(string): "+w.antispamConfig.antispamExtension),(null===(d=w.robotConfig)||void 0===d?void 0:d.accountId)&&"string"!=typeof w.robotConfig.accountId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid accountId(string): "+w.robotConfig.accountId),(null===(u=w.robotConfig)||void 0===u?void 0:u.topic)&&"string"!=typeof w.robotConfig.topic&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid topic(string): "+w.robotConfig.topic),(null===(p=w.robotConfig)||void 0===p?void 0:p.function)&&"string"!=typeof w.robotConfig.function&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid function(string): "+w.robotConfig.function),(null===(m=w.robotConfig)||void 0===m?void 0:m.customContent)&&"string"!=typeof w.robotConfig.customContent&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid customContent(string): "+w.robotConfig.customContent),(null===(h=w.threadRoot)||void 0===h?void 0:h.senderId)&&"string"!=typeof w.threadRoot.senderId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): "+w.threadRoot.senderId),(null===(g=w.threadRoot)||void 0===g?void 0:g.receiverId)&&"string"!=typeof w.threadRoot.receiverId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): "+w.threadRoot.receiverId),(null===(v=w.threadRoot)||void 0===v?void 0:v.messageClientId)&&"string"!=typeof w.threadRoot.messageClientId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): "+w.threadRoot.messageClientId),(null===(f=w.threadRoot)||void 0===f?void 0:f.messageServerId)&&"string"!=typeof w.threadRoot.messageServerId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): "+w.threadRoot.messageServerId),w.threadRoot&&"createTime"in w.threadRoot&&isNaN(w.threadRoot.createTime)&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): "+w.threadRoot.createTime),w.threadRoot&&!includes(R=[1,3,2,0]).call(R,w.threadRoot.conversationType)&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): "+w.threadRoot.conversationType),(null===(y=w.threadRoot)||void 0===y?void 0:y.conversationId)&&"string"!=typeof w.threadRoot.conversationId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid conversationId(string): "+w.threadRoot.conversationId),(null===(M=w.threadReply)||void 0===M?void 0:M.senderId)&&"string"!=typeof w.threadReply.senderId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid senderId(string): "+w.threadReply.senderId),(null===(I=w.threadReply)||void 0===I?void 0:I.receiverId)&&"string"!=typeof w.threadReply.receiverId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid receiverId(string): "+w.threadReply.receiverId),(null===(S=w.threadReply)||void 0===S?void 0:S.messageClientId)&&"string"!=typeof w.threadReply.messageClientId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid messageClientId(string): "+w.threadReply.messageClientId),(null===(T=w.threadReply)||void 0===T?void 0:T.messageServerId)&&"string"!=typeof w.threadReply.messageServerId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid messageServerId(string): "+w.threadReply.messageServerId),w.threadReply&&"createTime"in w.threadReply&&isNaN(w.threadReply.createTime)&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid createTime(number): "+w.threadReply.createTime),w.threadReply&&!includes(k=[1,3,2,0]).call(k,w.threadReply.conversationType)&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid conversationType(enum): "+w.threadReply.conversationType),(null===(C=w.threadReply)||void 0===C?void 0:C.conversationId)&&"string"!=typeof w.threadReply.conversationId&&this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid conversationId(string): "+w.threadReply.conversationId),delete w.__clientExt,delete w.userUpdateTime,w}catch(t){return this.core.logger.error("V2NIMMessageConverterImpl.messageDeserialization: invalid message string: "+e),null}},V2NIMMessageConverterImpl}();!function(e){e[e.V2NIM_PROXY_REQUEST_METHOD_GET=1]="V2NIM_PROXY_REQUEST_METHOD_GET",e[e.V2NIM_PROXY_REQUEST_METHOD_POST=2]="V2NIM_PROXY_REQUEST_METHOD_POST",e[e.V2NIM_PROXY_REQUEST_METHOD_PUT=3]="V2NIM_PROXY_REQUEST_METHOD_PUT",e[e.V2NIM_PROXY_REQUEST_METHOD_DELETE=4]="V2NIM_PROXY_REQUEST_METHOD_DELETE"}(_I||(_I={}));var TI="V2NIMPassthroughService",CI={"22_1":"v2ProxyRequest","22_2":"v2ProxyOnRequest"},bI={zone:1,path:2,method:3,header:4,body:5},EI={v2ProxyRequest:{sid:22,cid:1,service:TI,params:[{type:"Property",name:"tag",reflectMapper:bI}],response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem(bI)}]},v2ProxyOnRequest:{sid:22,cid:2,service:TI,response:[{type:"Property",name:"data",reflectMapper:invertSerializeItem({fromAccountId:1,body:2,time:{id:3,retType:"number"}})}]}},RI={path:{type:"string",allowEmpty:!1},zone:{type:"string",required:!1},method:{type:"enum",values:[_I.V2NIM_PROXY_REQUEST_METHOD_DELETE,_I.V2NIM_PROXY_REQUEST_METHOD_GET,_I.V2NIM_PROXY_REQUEST_METHOD_POST,_I.V2NIM_PROXY_REQUEST_METHOD_PUT],required:!1},header:{type:"jsonstr",required:!1},body:{type:"string",required:!1}},kI=function(e){function V2NIMPassthroughServiceImpl(t){var r;return r=e.call(this,"V2NIMPassthroughService",t)||this,registerParser({cmdMap:CI,cmdConfig:EI}),r}_t(V2NIMPassthroughServiceImpl,e);var t=V2NIMPassthroughServiceImpl.prototype;return t.emit=function emit(t){for(var r,n,a,i,o=this.name+"::emit "+t.toString(),s=arguments.length,c=new Array(s>1?s-1:0),l=1;l<s;l++)c[l-1]=arguments[l];return(r=this.logger).log.apply(r,concat(n=[""+o]).call(n,c)),(a=e.prototype.emit).call.apply(a,concat(i=[this,t]).call(i,c))},t.httpProxy=function httpProxy(e){return __awaiter(this,void 0,void 0,Dl.mark((function _callee(){var t;return Dl.wrap((function _callee$(r){for(;;)switch(r.prev=r.next){case 0:if(validate(RI,e,"",!0),!(e.method===_I.V2NIM_PROXY_REQUEST_METHOD_GET&&e.body||e.method===_I.V2NIM_PROXY_REQUEST_METHOD_POST&&!e.body||e.method===_I.V2NIM_PROXY_REQUEST_METHOD_PUT&&!e.body)){r.next=3;break}throw new Sl({code:_l.V2NIM_ERROR_CODE_INVALID_PARAMETER,detail:{reason:"method "+e.method+", incorrect body"}});case 3:return r.next=5,this.core.sendCmd("v2ProxyRequest",{tag:e});case 5:return t=r.sent,r.abrupt("return",t.content.data);case 7:case"end":return r.stop()}}),_callee,this)})))},t.v2ProxyOnRequestHandler=function v2ProxyOnRequestHandler(e){var t=e.content.data;this.emit("onProxyNotify",t)},V2NIMPassthroughServiceImpl}(Ru);!function setAdapters(e){merge$1(ql,e())}((function getAdapter(){return{setLogger:setLogger,platform:"React Native",localStorage:Hd,envPayload:{AppState:t.AppState},request:Fd,WebSocket:window.WebSocket,uploadFile:uploadFileFn,getFileUploadInformation:getFileUploadInformationFn,getSystemInfo:getSystemInfoFn,net:ru}})),Bd.registerService(Lu,"V1NIMLoginService"),Bd.registerService(Df,"msg"),Bd.registerService(Gf,"user"),Bd.registerService(Qf,"session"),Bd.registerService(Xf,"team"),Bd.registerService(ny,"systemMessage"),Bd.registerService(ly,"friend"),Bd.registerService(gy,"event"),Bd.registerService(Iy,"msgExtend"),Bd.registerService(wy,"msgLog"),Bd.registerService(Py,"passThrough"),Bd.registerService(Dh,"cloudStorage"),Bd.registerService(Zy,"superTeam"),Bd.registerService(Ff,"sync"),Bd.registerService(r_,"plugin"),Bd.registerService(c_,"cloudSession"),Bd.registerService(S_,"signaling"),Bd.registerService(yp,"V2NIMLoginService"),Bd.registerService(Im,"V2NIMConversationService"),Bd.registerService(Yh,"V2NIMMessageService"),Bd.registerService(jM,"V2NIMNotificationService"),Bd.registerService(qh,"V2NIMStorageService"),Bd.registerService(Rh,"V2NIMStorageUtil"),Bd.registerService(Em,"V2NIMConversationGroupService"),Bd.registerService(Yg,"V2NIMTeamService"),Bd.registerService(dv,"V2NIMUserService"),Bd.registerService(Sv,"V2NIMFriendService"),Bd.registerService(Wv,"V2NIMSettingService"),Bd.registerService(WM,"V2NIMSyncService"),Bd.registerService(ZM,"V2NIMAIService"),Bd.registerService(II,"DataStructureConverter"),Bd.registerService(SI,"V2NIMMessageConverter"),Bd.registerService(dg,"V2NIMMessageLogUtil"),Bd.registerService(Sg,"V2NIMMessageExtendUtil"),Bd.registerService(vI,"V2NIMSignallingService"),Bd.registerService(kI,"V2NIMPassthroughService"),Bd.registerService(zh,"YSFService"),Bd.registerService(oM,"qchatChannel"),Bd.registerService(mM,"qchatMedia"),Bd.registerService(BM,"qchatMsg"),Bd.registerService(GM,"qchatRole"),Bd.registerService(HM,"qchatServer"),Bd.registerPlugin(MI,"browser-md5-file"),Bd.registerPrivateService((function EventForwardCenter(e){var t=this;this.bindEvents=function(){t.core.eventBus.on("forwardSend/msg/sendMsg",t.onV1SendMsg),t.core.eventBus.on("forwardSend/msg/recallMsg",t.onV1RecallMsg),t.core.eventBus.on("forwardSend/msg/deleteSelfMsgs",t.onV1DeleteSelfMsgs),t.core.eventBus.on("forwardSend/msgLog/clearHistoryMsgsFromServer",t.onV1ClearHistoryMessage),t.core.eventBus.on("forwardSend/V2NIMMessageService/sendMsg",t.onV2SendMsg),t.core.eventBus.on("forwardSend/V2NIMMessageService/modifyMsg",t.onV2ModifyMsg),t.core.eventBus.on("forwardSend/V2NIMMessageService/revokeMessage",t.onV2RevokeMessage),t.core.eventBus.on("forwardSend/V2NIMMessageService/deleteSelfMsgs",t.onV2DeleteSelfMsgs),t.core.eventBus.on("forwardSend/V2NIMMessageLogService/clearHistoryMessage",t.onV2ClearHistoryMessage),t.core.eventBus.on("forwardSend/team/created",t.onV1TeamCreated),t.core.eventBus.on("forwardSend/team/updateMyMemberInfo",t.onV1TeamMemberUpdate),t.core.eventBus.on("forwardSend/superTeam/updateMyMemberInfo",t.onV1SuperTeamMemberUpdate),t.core.eventBus.on("forwardSend/V2NIMTeamService/updateSelfTeamMemberInfo",t.onV2TeamMemberUpdate),t.core.eventBus.on("forwardSend/team/passTeamApply",(function(e,r){return t.onV1TeamApply(e,1,1,r)})),t.core.eventBus.on("forwardSend/superTeam/passSuperTeamApply",(function(e,r){t.onV1TeamApply(e,2,1,r)})),t.core.eventBus.on("forwardSend/team/rejectTeamApply",(function(e,r){t.onV1TeamApply(e,1,2,r)})),t.core.eventBus.on("forwardSend/superTeam/rejectSuperTeamApply",(function(e,r){t.onV1TeamApply(e,2,2,r)})),t.core.eventBus.on("forwardSend/team/acceptTeamInvite",(function(e,r){t.onV1TeamInvite(e,1,1,r)})),t.core.eventBus.on("forwardSend/superTeam/acceptSuperTeamInvite",(function(e,r){t.onV1TeamInvite(e,2,1,r)})),t.core.eventBus.on("forwardSend/team/rejectTeamInvite",(function(e,r){t.onV1TeamInvite(e,1,2,r)})),t.core.eventBus.on("forwardSend/superTeam/rejectSuperTeamInvite",(function(e,r){t.onV1TeamInvite(e,2,2,r)})),t.core.eventBus.on("forwardSend/user/updateBlackList",t.onV1UpdateBlackList),t.core.eventBus.on("forwardSend/user/updateUserInfo",t.onV1UpdateUserInfo),t.core.eventBus.on("forwardSend/user/setMute",t.onV1SetMute),t.core.eventBus.on("forwardSend/friend/addFriend",t.onV1AddFriend),t.core.eventBus.on("forwardSend/friend/deleteFriend",t.onV1DeleteFriend),t.core.eventBus.on("forwardSend/friend/updateFriend",t.onV1UpdateFriend),t.core.eventBus.on("forwardSend/friend/passFriendApply",t.onV1PassFriendApply),t.core.eventBus.on("forwardSend/friend/rejectFriendApply",t.onV1RejectFriendApply)},this.onV1TeamApply=function(e,r,n,a){if(a){if(!t.core.V2NIMTeamService.notification.checkIfExpired(a))return;n=3}t.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateTeamActionStatus",{teamId:e.teamId,teamType:r,operatorAccountId:e.from,actionType:0},n)},this.onV1TeamInvite=function(e,r,n,a){if(a){if(!t.core.V2NIMTeamService.notification.checkIfExpired(a.code))return;n=3}t.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateTeamActionStatus",{teamId:e.teamId,teamType:r,operatorAccountId:e.from,actionType:2},n)},this.onV1PassFriendApply=function(e,r){t.core.eventBus.emit("forwardReceive/V2NIMFriendService/acceptAddApplication",e,r)},this.onV1RejectFriendApply=function(e,r,n){t.core.eventBus.emit("forwardReceive/V2NIMFriendService/rejectAddApplication",{applicantAccountId:e,recipientAccountId:t.core.account,operatorAccountId:t.core.account,postscript:r||"",timestamp:t.core.timeOrigin.getNTPTime(),read:!0,status:3},n)},this.onV1SetMute=function(e,r){t.core.eventBus.emit("forwardReceive/v2NIMSettingService/setP2PMessageMuteMode",e,r?1:0)},this.onV1UpdateFriend=function(e){t.core.eventBus.emit("forwardReceive/V2NIMFriendService/setFriendInfo",e.account,Et(Et({},"alias"in e?{alias:e.alias}:{}),"ext"in e?{serverExtension:e.ext}:{}))},this.onV1AddFriend=function(e){t.core.eventBus.emit("forwardReceive/V2NIMFriendService/addFriend",e)},this.onV1DeleteFriend=function(e){t.core.eventBus.emit("forwardReceive/V2NIMFriendService/deleteFriend",e)},this.onV1UpdateUserInfo=function(e){var r=deserialize(serialize(e,yf.user),invertSerializeItem(Xg));t.core.eventBus.emit("forwardReceive/V2NIMUserService/updateUserProfile",r)},this.onV1UpdateBlackList=function(e,r){t.core.eventBus.emit("forwardReceive/V2NIMUserService/updateBlockList",e,r)},this.onV1TeamCreated=function(e){var r=deserialize(serialize(generateTeam(e),mf.team),invertSerializeItem(Kp));t.core.eventBus.emit("forwardReceive/V2NIMTeamService/created",r)},this.onV1TeamMemberUpdate=function(e){(e=Et({},e)).type&&(e.type={normal:0,owner:1,manager:2}[e.type]);var r=deserialize(serialize(e,mf.teamMember),invertSerializeItem(Yp));r.teamType=1,t.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateSelfTeamMemberInfo",r)},this.onV1SuperTeamMemberUpdate=function(e){(e=Et({},e)).type&&(e.type={normal:0,owner:1,manager:2}[e.type]);var r=deserialize(serialize(e,Qy.superTeamMember),invertSerializeItem(Qp));r.teamType=2,t.core.eventBus.emit("forwardReceive/V2NIMTeamService/updateSelfTeamMemberInfo",r)},this.onV2TeamMemberUpdate=function(e){var r=e.teamType,n=serialize(e,Yp);if(2===r){var a=deserialize(n,invertSerializeItem(Qy.superTeamMember));t.core.eventBus.emit("forwardReceive/superTeam/updateMyMemberInfo",a)}else{var i=deserialize(n,invertSerializeItem(mf.teamMember));t.core.eventBus.emit("forwardReceive/team/updateMyMemberInfo",i)}},this.onV1SendMsg=function(e){var r=deserialize(serialize(e,xf),rm);(r=completeMessage(t.core,r)).sendingState="sending"===e.status?3:"sent"===e.status?1:2,t.core.eventBus.emit("forwardReceive/V2NIMMessageService/sendMsg",r)},this.onV2SendMsg=function(e){var r=deserialize(serialize(e,tm),invert(xf));r.status=3===e.sendingState?"sending":1===e.sendingState?"sent":"sendFailed",t.core.eventBus.emit("forwardReceive/msg/sendMsg",r)},this.onV2ModifyMsg=function(e){var r=deserialize(serialize(e,tm),invert(xf));t.core.eventBus.emit("forwardReceive/msg/modifyMsg",r)},this.onV1RecallMsg=function(e){e.deleteMsgCreatetime=e.time;var r=deserialize(serialize(e,Of.recallMsgTag),invertSerializeItem(im));t.core.eventBus.emit("forwardReceive/V2NIMMessageService/revokeMessages",[r])},this.onV2RevokeMessage=function(e){var r=deserialize(serialize(e,im),Pf.recallMsgTag);t.core.eventBus.emit("forwardReceive/msg/recallMsg",r)},this.onV1DeleteSelfMsgs=function(e){var r=map$6(e).call(e,(function(e){return deserialize(serialize(e,Of.deleteSelfMsgTag),invertSerializeItem(nm))}));forEach$1(r).call(r,(function(e){e.messageRefer=formatMessageRefer(t.core,e.messageRefer)})),t.core.eventBus.emit("forwardReceive/V2NIMMessageService/deleteMessages",r)},this.onV2DeleteSelfMsgs=function(e){var r=map$6(e).call(e,(function(e){return deserialize(serialize(e,nm),Pf.deleteSelfMsgTag)}));t.core.eventBus.emit("forwardReceive/msg/deleteSelfMsgs",r)},this.onV1ClearHistoryMessage=function(e){var r=deserialize(serialize(e,Cy.clearHistoryMsgsFromServerReqTag),invertSerializeItem(sg));t.core.eventBus.emit("forwardReceive/V2NIMMessageLogService/clearHistoryMessage",r)},this.onV2ClearHistoryMessage=function(e){var r=deserialize(serialize(e,sg),by.clearHistoryMsgsFromServerReqTag);t.core.eventBus.emit("forwardReceive/msgLog/clearHistoryMsgsFromServer",r)},this.core=e,this.bindEvents()}),"eventForwardCenter"),e.V2NIMConst=Il,e.default=Bd,Object.defineProperty(e,"__esModule",{value:!0})}));
